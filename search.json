[{"url":"/2021/markdown/markdown%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/","content":""},{"title":"Hello World","url":"/2020/hello-world/","content":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<a id=\"more\"></a>\n\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n","categories":["测试"],"tags":["测试"]},{"title":"ELK","url":"/2020/Elasticsearch/ELK/","content":"<h2 id=\"ELK\"><a href=\"#ELK\" class=\"headerlink\" title=\"ELK\"></a>ELK</h2><p>为了方便分布式部署方便地查询应用日志，需要构建一个统一的日志管理系统。通常一个日志管理系统包括日志采集、日志传输、日志存储、日志搜索、日志分析和日志监控报警等模块。</p>\n<a id=\"more\"></a>\n\n<p>ELK就是一款用于搭建实施日志分析平台的组件。ELK是指Elasticsearch、Logstash、Kiabana这三款框架首字母的缩写。</p>\n<p><strong>Elasticsearch</strong>是一个实时的分布式搜索和分析引擎，建立在全文搜索引擎Apache Luccne基础之上，具有分布式、高可用性、易扩展、具有副本和索引自动分片功能，提供基于HTTP协议以及JSON为数据交换格式的REST风格API、多数据源、实时分析存储等特点。</p>\n<p><strong>Logstash</strong>类似于flume，用于对日志进行收集、过滤，对数据进行格式化处理，并将所收集的日志传输到相关系统进行存储，如HDFS/kafka等。由数据输入端、过滤器和数据输出端3部分组成。数据输入端可以从数据源采集数据，常见的数据源包括文件、syslog、kafka等；过滤器是数据处理层，包括对数据进行格式化处理、数据类型转换、数据过滤等，支持正则；数据输出端是将Logstash收集到的数据经由过滤器处理后输出到其他系统，如kafka、HDFS、Elasticsearch等。</p>\n<p><strong>Kibana</strong>是针对Elasticsearch开源分析及可视化平台，可用来搜索，展示存储在Elasticsearch中的数据。</p>\n<h3 id=\"ELK配置\"><a href=\"#ELK配置\" class=\"headerlink\" title=\"ELK配置\"></a>ELK配置</h3><h4 id=\"Elasticsearch配置\"><a href=\"#Elasticsearch配置\" class=\"headerlink\" title=\"Elasticsearch配置\"></a>Elasticsearch配置</h4><p>Elasticsearch.yml配置</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 集群名称</span></span><br><span class=\"line\"><span class=\"attr\">cluster.name:</span> <span class=\"string\">elasticsearch_test</span></span><br><span class=\"line\"><span class=\"comment\"># 集群中该节点名称</span></span><br><span class=\"line\"><span class=\"attr\">node.name:</span> <span class=\"string\">node-1</span></span><br><span class=\"line\"><span class=\"comment\"># 日志文件存储路径</span></span><br><span class=\"line\"><span class=\"attr\">path.data:</span> <span class=\"string\">/usr/local/var/lib/elasticsearch/</span></span><br><span class=\"line\"><span class=\"comment\"># 索引数据存储路径，可以设置多个路径，逗号分隔</span></span><br><span class=\"line\"><span class=\"attr\">path.logs:</span> <span class=\"string\">/usr/local/var/log/elasticsearch/</span></span><br><span class=\"line\"><span class=\"attr\">network.host:</span> <span class=\"string\">localhost</span></span><br><span class=\"line\"><span class=\"attr\">http.port:</span> <span class=\"number\">9200</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 启动elasticsearch</span></span><br><span class=\"line\">elasticsearch</span><br></pre></td></tr></table></figure>\n\n<p>访问localhost:9200</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;name&quot;</span> : <span class=\"string\">&quot;node-1&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;cluster_name&quot;</span> : <span class=\"string\">&quot;elasticsearch_test&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;cluster_uuid&quot;</span> : <span class=\"string\">&quot;y88KhTnmQu-AAbxKii379w&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;version&quot;</span> : &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;number&quot;</span> : <span class=\"string\">&quot;7.9.2-SNAPSHOT&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;build_flavor&quot;</span> : <span class=\"string\">&quot;oss&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;build_type&quot;</span> : <span class=\"string\">&quot;tar&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;build_hash&quot;</span> : <span class=\"string\">&quot;unknown&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;build_date&quot;</span> : <span class=\"string\">&quot;2020-10-03T08:22:40.976826Z&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;build_snapshot&quot;</span> : <span class=\"literal\">true</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;lucene_version&quot;</span> : <span class=\"string\">&quot;8.6.2&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;minimum_wire_compatibility_version&quot;</span> : <span class=\"string\">&quot;6.8.0&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;minimum_index_compatibility_version&quot;</span> : <span class=\"string\">&quot;6.0.0-beta1&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">&quot;tagline&quot;</span> : <span class=\"string\">&quot;You Know, for Search&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Logstash配置\"><a href=\"#Logstash配置\" class=\"headerlink\" title=\"Logstash配置\"></a>Logstash配置</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 启动 从控制台输入，控制台输出  codec指定了数据输出格式  输出的@timestamp是UTC时间</span></span><br><span class=\"line\">logstash -e &#x27;input&#123;stdin&#123;&#125;&#125;output&#123;stdout&#123;codec=&gt;json&#125;&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&quot;@version&quot;:&quot;1&quot;,&quot;host&quot;:&quot;zhanghedeMacBook-Pro.local&quot;,&quot;@timestamp&quot;:&quot;2020-10-26T10:02:02.357Z&quot;,&quot;message&quot;:&quot;hell&quot;&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Kibana配置\"><a href=\"#Kibana配置\" class=\"headerlink\" title=\"Kibana配置\"></a>Kibana配置</h4><figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server.port:</span> <span class=\"number\">5601</span></span><br><span class=\"line\"><span class=\"attr\">server.host:</span> <span class=\"string\">&quot;localhost&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># kibana服务器名称</span></span><br><span class=\"line\"><span class=\"attr\">server.name:</span> <span class=\"string\">&quot;test&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># elasticsearch的访问地址</span></span><br><span class=\"line\"><span class=\"attr\">elasticsearch.hosts:</span> [<span class=\"string\">&quot;http://localhost:9200&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n<p>启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kibana</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Kafka与Logstash\"><a href=\"#Kafka与Logstash\" class=\"headerlink\" title=\"Kafka与Logstash\"></a>Kafka与Logstash</h3><h4 id=\"Logstash收集日志到kafka\"><a href=\"#Logstash收集日志到kafka\" class=\"headerlink\" title=\"Logstash收集日志到kafka\"></a>Logstash收集日志到kafka</h4><p>编写配置</p>\n<figure class=\"highlight ruby\"><table><tr><td class=\"code\"><pre><span class=\"line\">input&#123;</span><br><span class=\"line\">    stdin&#123;&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">output&#123;</span><br><span class=\"line\">    kafka&#123;</span><br><span class=\"line\">        <span class=\"comment\"># 主题</span></span><br><span class=\"line\">        topic_id =&gt; <span class=\"string\">&quot;logstash-input-kafka&quot;</span></span><br><span class=\"line\">        bootstrap_servers =&gt; <span class=\"string\">&quot;localhost:9092&quot;</span></span><br><span class=\"line\">        <span class=\"comment\"># 数据编码方式</span></span><br><span class=\"line\">        codec =&gt; <span class=\"string\">&quot;plain&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stdout&#123;</span><br><span class=\"line\">        <span class=\"comment\"># 设置打印出来的打印数据表现形式</span></span><br><span class=\"line\">        codec =&gt; rubydebug</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>启动logstash</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> -f后边是之前写的输入输出配置的文件位置</span></span><br><span class=\"line\">logstash -f ./etc/logstash_input_kafka</span><br></pre></td></tr></table></figure>\n\n<p>上面的配置是输入到控制台以及kafka中</p>\n<p>看一下kafka中是否有数据</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-run-class kafka.tools.DumpLogSegments --files /usr/local/var/lib/kafka-logs/logstash-input-kafka-0/00000000000000000000.log --print-data-log</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"logstash从kafka消费日志\"><a href=\"#logstash从kafka消费日志\" class=\"headerlink\" title=\"logstash从kafka消费日志\"></a>logstash从kafka消费日志</h4><p>编写配置</p>\n<figure class=\"highlight ruby\"><table><tr><td class=\"code\"><pre><span class=\"line\">input&#123;</span><br><span class=\"line\">    kafka&#123;</span><br><span class=\"line\">        <span class=\"comment\"># 导出数据解码</span></span><br><span class=\"line\">        codec =&gt; <span class=\"string\">&quot;plain&quot;</span></span><br><span class=\"line\">        <span class=\"comment\"># 消费组</span></span><br><span class=\"line\">        group_id =&gt; <span class=\"string\">&quot;kafka_elk_group&quot;</span></span><br><span class=\"line\">        client_id =&gt; logstash</span><br><span class=\"line\">        topics =&gt; <span class=\"string\">&quot;kafka_elk_log&quot;</span></span><br><span class=\"line\">        bootstrap_servers =&gt; <span class=\"string\">&quot;localhost:9092&quot;</span></span><br><span class=\"line\">        auto_offset_reset =&gt; <span class=\"string\">&quot;earliest&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">output&#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"comment\"># elasticsearch地址</span></span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">&quot;localhost:9200&quot;</span>]</span><br><span class=\"line\">        <span class=\"comment\"># 导入到elasticsearch格式</span></span><br><span class=\"line\">        codec =&gt; <span class=\"string\">&quot;plain&quot;</span></span><br><span class=\"line\">        <span class=\"comment\"># 创建索引</span></span><br><span class=\"line\">        index =&gt; <span class=\"string\">&quot;kafka_elk_log-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>启动logstash</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">logstash -f ./etc/logstash_output_es</span><br></pre></td></tr></table></figure>\n\n<p>kafka发消息</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-console-producer --bootstrap-server localhost:9092 --topic kafka_elk_log</span><br></pre></td></tr></table></figure>\n\n<p>查看elasticsearch该索引内容</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">localhost:9200/kafka_elk_log-2020.10.27/_search</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;took&quot;</span>: <span class=\"number\">6</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;timed_out&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;_shards&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;total&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;successful&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;skipped&quot;</span>: <span class=\"number\">0</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;failed&quot;</span>: <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">&quot;hits&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;total&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;value&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;relation&quot;</span>: <span class=\"string\">&quot;eq&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"attr\">&quot;max_score&quot;</span>: <span class=\"number\">1.0</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;hits&quot;</span>: [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"attr\">&quot;_index&quot;</span>: <span class=\"string\">&quot;kafka_elk_log-2020.10.27&quot;</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;_type&quot;</span>: <span class=\"string\">&quot;_doc&quot;</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;_id&quot;</span>: <span class=\"string\">&quot;tdsTaHUBepBPXnsJEzMU&quot;</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;_score&quot;</span>: <span class=\"number\">1.0</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;_source&quot;</span>: &#123;</span><br><span class=\"line\">                    <span class=\"attr\">&quot;@timestamp&quot;</span>: <span class=\"string\">&quot;2020-10-27T03:21:20.939Z&quot;</span>,</span><br><span class=\"line\">                    <span class=\"attr\">&quot;message&quot;</span>: <span class=\"string\">&quot;kafka来的消息&quot;</span>,</span><br><span class=\"line\">                    <span class=\"attr\">&quot;@version&quot;</span>: <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        ]</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Logstash\"><a href=\"#Logstash\" class=\"headerlink\" title=\"Logstash\"></a>Logstash</h3><p>Logstash包含三部分，分别为输入(input)、输出(output)、数据清洗(filter)</p>\n<p>上述使用了input和output，在这演示一下filter</p>\n<p>192.168.1.1 [2020-10-27 15:10:20.909 +0800] “POST /account/home {“token”:”dla02okvbk9791bdj”}HTTP/1.1” 200 - “-“ “Apache-HttpClient/4.1.1 (Java 1.8)” 32 “C32A5405VNWVWVNK67”</p>\n<figure class=\"highlight ruby\"><table><tr><td class=\"code\"><pre><span class=\"line\">input&#123;</span><br><span class=\"line\">      kafka&#123;</span><br><span class=\"line\">          <span class=\"comment\"># 定义类型，进行区分</span></span><br><span class=\"line\">          Type =&gt; <span class=\"string\">&quot;access&quot;</span></span><br><span class=\"line\">        <span class=\"comment\"># 导出数据解码</span></span><br><span class=\"line\">        codec =&gt; <span class=\"string\">&quot;plain&quot;</span></span><br><span class=\"line\">        <span class=\"comment\"># 消费组</span></span><br><span class=\"line\">        group_id =&gt; <span class=\"string\">&quot;kafka_access_group&quot;</span></span><br><span class=\"line\">        client_id =&gt; logstash</span><br><span class=\"line\">        topics =&gt; <span class=\"string\">&quot;kafka_access_log&quot;</span></span><br><span class=\"line\">        bootstrap_servers =&gt; <span class=\"string\">&quot;localhost:9092&quot;</span></span><br><span class=\"line\">        auto_offset_reset =&gt; <span class=\"string\">&quot;earliest&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">filter&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> [type] == <span class=\"string\">&quot;access&quot;</span>&#123;</span><br><span class=\"line\">        grok &#123;</span><br><span class=\"line\">            match =&gt; [<span class=\"string\">&quot;message&quot;</span>, <span class=\"string\">&quot;%&#123;IP:client&#125;\\s+\\[%&#123;NOTSPACE:access_date&#125;\\s+%&#123;NOTSPACE:access_time&#125;\\s+(\\+0800\\)]\\s&quot;</span><span class=\"string\">%&#123;WORD:method&#125;</span> <span class=\"string\">%&#123;URIPATHPARAM:request&#125;</span>[\\s\\S]* (HTTP/<span class=\"number\">1.1</span>\\<span class=\"string\">&quot;) %&#123;NUMBER:response&#125;[\\s\\S]* %&#123;NUMBER:cost&#125;&quot;</span>]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">output&#123;</span><br><span class=\"line\">    elasticsearch &#123;</span><br><span class=\"line\">        <span class=\"comment\"># elasticsearch地址</span></span><br><span class=\"line\">        hosts =&gt; [<span class=\"string\">&quot;localhost:9200&quot;</span>]</span><br><span class=\"line\">        <span class=\"comment\"># 导入到elasticsearch格式</span></span><br><span class=\"line\">        codec =&gt; <span class=\"string\">&quot;plain&quot;</span></span><br><span class=\"line\">        <span class=\"comment\"># 创建索引</span></span><br><span class=\"line\">        index =&gt; <span class=\"string\">&quot;kafka_access_log-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["Elasticsearch"],"tags":["Elasticsearch"]},{"title":"Git中文路径转义问题","url":"/2021/Git/Git%E4%B8%AD%E6%96%87%E8%B7%AF%E5%BE%84%E8%BD%AC%E4%B9%89%E9%97%AE%E9%A2%98/","content":"<h2 id=\"Git中文路径转义问题\"><a href=\"#Git中文路径转义问题\" class=\"headerlink\" title=\"Git中文路径转义问题\"></a>Git中文路径转义问题</h2><p>之前在提交博客的时候是直接在终端上使用git进行提交的，没有使用可视化工具，因为可能会同时改了好几个博客，而我在提交的时候通常都是分类提交，在使用git status时看一下有哪些改动，发现中文路径自动转义，导致我在分别add和commit的时候不方便</p>\n<p><img src=\"/images/Git/Git%E4%B8%AD%E6%96%87%E8%B7%AF%E5%BE%84%E9%97%AE%E9%A2%98.png\" alt=\"Git中文路径问题\"></p>\n<p>可以使用来进行配置，默认为true</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">git config core.quotepath false</span><br></pre></td></tr></table></figure>\n\n","categories":["Git"],"tags":["Git"]},{"title":"Git基本命令","url":"/2021/Git/Git%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"Git基本命令\"><a href=\"#Git基本命令\" class=\"headerlink\" title=\"Git基本命令\"></a>Git基本命令</h2><h3 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h3><p>找到一个文件目录进行git初始化操作</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">初始化</span></span><br><span class=\"line\">git init</span><br><span class=\"line\"></span><br><span class=\"line\">--------------------------------</span><br><span class=\"line\">Initialized empty Git repository in /Users/zhanghe/Desktop/user/myself/GitProject/studygit/.git/</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>可以看到会生成一个.git目录，目录结构如下</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">-rw-r--r--   1 zhanghe  staff   23  2 13 12:06 HEAD</span><br><span class=\"line\">-rw-r--r--   1 zhanghe  staff  137  2 13 12:06 config</span><br><span class=\"line\">-rw-r--r--   1 zhanghe  staff   73  2 13 12:06 description</span><br><span class=\"line\">drwxr-xr-x  14 zhanghe  staff  448  2 13 12:06 hooks/</span><br><span class=\"line\">drwxr-xr-x   3 zhanghe  staff   96  2 13 12:06 info/</span><br><span class=\"line\">drwxr-xr-x   4 zhanghe  staff  128  2 13 12:06 objects/</span><br><span class=\"line\">drwxr-xr-x   4 zhanghe  staff  128  2 13 12:06 refs/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p>为了区分不同用户所提交的代码，需要设置签名</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">显示当前git配置</span></span><br><span class=\"line\">git config --list</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">编辑配置文件</span></span><br><span class=\"line\">git config -e</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">编辑全局配置文件</span></span><br><span class=\"line\">git config -e --global</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置仓库级别</span></span><br><span class=\"line\">git config user.name 123</span><br><span class=\"line\">git config user.email 123@163.com</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置用户级别(登录当前操作系统的用户)</span></span><br><span class=\"line\">git config --global user.name 123</span><br><span class=\"line\">git config --global user.email 123@163.com</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果同时设置了仓库级别和用户级别，用户级别的优先级要高</p>\n<p>仓库级别的配置之后会存储在仓库中.git目录下的config文件中</p>\n<p>用户级别的配置之后会存储在用户根目录下.gitconfig文件中</p>\n</blockquote>\n<h3 id=\"提交以及状态转换\"><a href=\"#提交以及状态转换\" class=\"headerlink\" title=\"提交以及状态转换\"></a>提交以及状态转换</h3><h4 id=\"查看状态\"><a href=\"#查看状态\" class=\"headerlink\" title=\"查看状态\"></a>查看状态</h4><p>可以查看文件此时在git的状态</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">git status</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"添加到暂存区\"><a href=\"#添加到暂存区\" class=\"headerlink\" title=\"添加到暂存区\"></a>添加到暂存区</h4><p>将文件从工作区添加大暂存区，此时git就可以追踪到该文件了</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git add &lt;file&gt;</span></span><br><span class=\"line\">git add test1.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">添加所有修改的文件，不包括新增加的</span></span><br><span class=\"line\">git add -u</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">添加所有文件</span></span><br><span class=\"line\">git add -A</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"从暂存区移除\"><a href=\"#从暂存区移除\" class=\"headerlink\" title=\"从暂存区移除\"></a>从暂存区移除</h4><p>从暂存区移除放回到工作区</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git rm --cached &lt;file&gt;</span></span><br><span class=\"line\">git rm --cached test1.txt</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"提交到本地库\"><a href=\"#提交到本地库\" class=\"headerlink\" title=\"提交到本地库\"></a>提交到本地库</h4><p>从暂存区提交到本地库</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">使用此命令会跳转至vim编辑器来编辑本次提交的消息</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git commit &lt;file&gt;</span></span><br><span class=\"line\">git commit test1.txt</span><br><span class=\"line\"></span><br><span class=\"line\">---------------------------</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git commit -m <span class=\"string\">&quot;message&quot;</span> &lt;file&gt;</span></span><br><span class=\"line\">git commit -m &quot;测试&quot; test1.txt</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> -m后为本地提交的消息 不需要进入vim进行编辑</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">-a表示添加到暂存区且提交到本地库(只适用于修改的文件)</span></span><br><span class=\"line\">git commit -am &quot;测试&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">提交时显示所有的diff信息</span></span><br><span class=\"line\">git commit -v</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查看历史记录\"><a href=\"#查看历史记录\" class=\"headerlink\" title=\"查看历史记录\"></a>查看历史记录</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">git log</span><br><span class=\"line\"></span><br><span class=\"line\">------------------------</span><br><span class=\"line\">commit 634938cf9e6328f62541d7aa837338053765a601 (HEAD -&gt; master)</span><br><span class=\"line\">Author: zhanghe &lt;1107373642@qq.com&gt;</span><br><span class=\"line\">Date:   Sat Feb 13 12:54:40 2021 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    第二次</span><br><span class=\"line\"></span><br><span class=\"line\">commit e0c2ce0d9e8b94abd85a6074a491c067860321db</span><br><span class=\"line\">Author: zhanghe &lt;1107373642@qq.com&gt;</span><br><span class=\"line\">Date:   Sat Feb 13 12:45:03 2021 +0800</span><br><span class=\"line\"></span><br><span class=\"line\">    测试</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>commit后边的一串字符串即为此次提交的hash值，此次提交的唯一标识，HEAD即为指针，表示当前所在的版本</p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git <span class=\"built_in\">log</span>可以根据不同的参数来进行显示</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">一条提交记录显示一行</span></span><br><span class=\"line\">git log --pretty=oneline</span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------</span><br><span class=\"line\">634938cf9e6328f62541d7aa837338053765a601 (HEAD -&gt; master) 第二次</span><br><span class=\"line\">e0c2ce0d9e8b94abd85a6074a491c067860321db 测试</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">一条提交记录显示一行且显示部分<span class=\"built_in\">hash</span>值</span></span><br><span class=\"line\">git log --oneline</span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------</span><br><span class=\"line\">634938c (HEAD -&gt; master) 第二次</span><br><span class=\"line\">e0c2ce0 测试</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">显示历史记录，包含每次commit发生变更的文件</span></span><br><span class=\"line\">git log --stat</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">根据指针来展示不同的记录 HEAD@&#123;1&#125; 这个数字表示的是从此版本到当前版本移动的步数</span></span><br><span class=\"line\">git reflog</span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------</span><br><span class=\"line\">634938c (HEAD -&gt; master) HEAD@&#123;0&#125;: commit: 第二次</span><br><span class=\"line\">e0c2ce0 HEAD@&#123;1&#125;: commit (initial): 测试</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">查看某个文件的提交记录</span></span><br><span class=\"line\">git log --follow test2.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">显示某个文件相关的每一次diff</span></span><br><span class=\"line\">git log -p test2.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">显示某个文件被修改的记录(包含作者以及时间)</span></span><br><span class=\"line\">git blame test1.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">显示某个提交的变化</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git show [commit_id]</span></span><br><span class=\"line\">git show 2a2cf44</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">显示某个提交改变的文件</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git show --name-only [commit_id]</span></span><br><span class=\"line\">git show --name-only 2a2cf44</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">显示某个提交某个文件的内容</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git show [commit_id]:[filename]</span></span><br><span class=\"line\">git show ff711e8:123</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"版本前进或后退\"><a href=\"#版本前进或后退\" class=\"headerlink\" title=\"版本前进或后退\"></a>版本前进或后退</h4><p>版本前进后退的本质是移动指针，即修改HEAD所指向的commit提交</p>\n<h5 id=\"基于索引值操作-推荐\"><a href=\"#基于索引值操作-推荐\" class=\"headerlink\" title=\"基于索引值操作[推荐]\"></a>基于索引值操作[推荐]</h5><p>前进后退都可以，只需要根据索引值即可</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> e0c2ce0为所要移至的commit的<span class=\"built_in\">hash</span>值</span></span><br><span class=\"line\">git reset --hard e0c2ce0</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"reset的三个参数\"><a href=\"#reset的三个参数\" class=\"headerlink\" title=\"reset的三个参数\"></a>reset的三个参数</h6><ul>\n<li>soft   仅仅在本地库移动指针，不会更改暂存区和工作区</li>\n<li>hard  在本地库移动指针，重置暂存区和工作区</li>\n<li>mixed 在本地库移动指针，并进行重置暂存区，不会更改工作区</li>\n</ul>\n<h5 id=\"使用-符号-了解\"><a href=\"#使用-符号-了解\" class=\"headerlink\" title=\"使用^符号[了解]\"></a>使用^符号[了解]</h5><p>只可以后退</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">每个^后退一步    </span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 后退一步</span></span><br><span class=\"line\">git reset --hard HEAD^</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 后退两步</span></span><br><span class=\"line\">git reset --hard HEAD^^</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"使用-符号-了解-1\"><a href=\"#使用-符号-了解-1\" class=\"headerlink\" title=\"使用~符号[了解]\"></a>使用~符号[了解]</h5><p><del>是^的升级版，也是只能后退，但是由于如果后退版本多的话使用^比较麻烦，使用</del>之后跟后退的步数比较简洁一点</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">~后为后退的步数</span></span><br><span class=\"line\">git reset --hard HEAD~3</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>注意：git reset是移动指针指向某个版本，此时的commit_id也会变为所要到达的版本的commit_id，而且所有的状态都变成了该版本的状态</p>\n<p>git revert表示的是回滚某个提交，只针对于该提交进行操作，不影响该提交的前后版本，且会生成新的commit_id</p>\n</blockquote>\n<h3 id=\"文件差异比较\"><a href=\"#文件差异比较\" class=\"headerlink\" title=\"文件差异比较\"></a>文件差异比较</h3><p>可以使用diff来比较工作区和暂存区的文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git diff [file]</span></span><br><span class=\"line\">git diff test1.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">显示暂存区与上一个commit的差异</span></span><br><span class=\"line\">git diff --cache test1.txt</span><br></pre></td></tr></table></figure>\n\n<p>也可以来比较不通过版本之间的差异</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git diff [<span class=\"built_in\">hash</span>值] [file]</span></span><br><span class=\"line\">git diff e0c2ce0 test1.txt</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"分支操作\"><a href=\"#分支操作\" class=\"headerlink\" title=\"分支操作\"></a>分支操作</h3><p>分支并不是将所有文件复制多份，只是根据指针来指向不同的版本，每一个分支代表一个指针</p>\n<h4 id=\"查看分支\"><a href=\"#查看分支\" class=\"headerlink\" title=\"查看分支\"></a>查看分支</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 会展示分支名 以及最新的提交版本</span></span><br><span class=\"line\">git branch -v</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">或者</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 只会展示分支名</span></span><br><span class=\"line\">git branch</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">查看远程分支(红色表示远程分支)</span></span><br><span class=\"line\">git branch -a</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">查看远程分支</span></span><br><span class=\"line\">git branch -r</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"创建分支\"><a href=\"#创建分支\" class=\"headerlink\" title=\"创建分支\"></a>创建分支</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git branch [分支名]</span></span><br><span class=\"line\">git branch test</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 新建一个分支，指向指定的提交</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git branch [分支名] [commit_id]</span></span><br><span class=\"line\">git branch test d6bca18</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 新建一个分支，指向指定的标签</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> git checkout -b [分支名] [tag]</span></span><br><span class=\"line\">git checkout -b test v1.0</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"切换分支\"><a href=\"#切换分支\" class=\"headerlink\" title=\"切换分支\"></a>切换分支</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git checkout [分支名]</span></span><br><span class=\"line\">git checkout test</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">创建并切换分支</span></span><br><span class=\"line\">git checkout -b feature</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"合并分支\"><a href=\"#合并分支\" class=\"headerlink\" title=\"合并分支\"></a>合并分支</h4><p>合并分支之前需要将分支切换到所要合并到的分支</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">git checkout master</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">合并指定的分支到当前分支</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git merge [所要合并的分支名]</span></span><br><span class=\"line\">git merge test</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">衍合指定的分支到当前分支(将多次提交合并为一个提交)</span></span><br><span class=\"line\">git rebase test</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">选择一个commit，合并至当前分支</span></span><br><span class=\"line\">git cherry-pick d6bca18</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"删除分支\"><a href=\"#删除分支\" class=\"headerlink\" title=\"删除分支\"></a>删除分支</h4><p>不可以删除当前checkout的分支</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">使用此删除命令时，要保证要删除的分支没有可以merge到当前分支的，否则不可以删除</span></span><br><span class=\"line\">git branch -d feature</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">强制删除</span></span><br><span class=\"line\">git branch -D feature</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">删除远端分支</span></span><br><span class=\"line\">git push origin --delete test</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"重命名本地分支\"><a href=\"#重命名本地分支\" class=\"headerlink\" title=\"重命名本地分支\"></a>重命名本地分支</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git branch -m [原名] [要改成的名字]</span></span><br><span class=\"line\">git branch -m bb feature</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"标签管理\"><a href=\"#标签管理\" class=\"headerlink\" title=\"标签管理\"></a>标签管理</h3><h4 id=\"新标签\"><a href=\"#新标签\" class=\"headerlink\" title=\"新标签\"></a>新标签</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git tag [标签名]</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">标签默认是打在最新提交的commit上</span></span><br><span class=\"line\">git tag new</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git tag [标签名] [commit_id]</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">新建标签打在指定的commit上</span></span><br><span class=\"line\">git tag test1 2c4ebc9</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git tag -a [标签名] -m [标签说明] [commit_id]</span></span><br><span class=\"line\">git tag -a featurev1.0 -m &quot;测试打标签&quot; 2c4ebc9</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查看标签\"><a href=\"#查看标签\" class=\"headerlink\" title=\"查看标签\"></a>查看标签</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">查看所有标签</span></span><br><span class=\"line\">git tag</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git show [标签名]</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">查看每个标签的详细信息</span></span><br><span class=\"line\">git show new</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"推送到远程\"><a href=\"#推送到远程\" class=\"headerlink\" title=\"推送到远程\"></a>推送到远程</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git push [remote] [标签名]</span></span><br><span class=\"line\">git push origin featurev1.0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">推送所有的标签</span></span><br><span class=\"line\">git push origin --tags</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"删除标签\"><a href=\"#删除标签\" class=\"headerlink\" title=\"删除标签\"></a>删除标签</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git tag -d [标签名]</span></span><br><span class=\"line\">git tag -d new</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">先删除本地分支之后，推送到远端，即可删除远端分支</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git push origin :refs/tags/[分支名]</span></span><br><span class=\"line\">git push origin :refs/tags/new</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"远端操作\"><a href=\"#远端操作\" class=\"headerlink\" title=\"远端操作\"></a>远端操作</h3><h4 id=\"为远端地址起别名\"><a href=\"#为远端地址起别名\" class=\"headerlink\" title=\"为远端地址起别名\"></a>为远端地址起别名</h4><p>因为每次提交都需要用到远端地址，而地址又很长，所以可以给远端地址起别名</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git remote add [别名] [url]</span></span><br><span class=\"line\">git remote add origin https://gitee.com/SiXiangPiaoFuZhe/studygit.git</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查看远端地址\"><a href=\"#查看远端地址\" class=\"headerlink\" title=\"查看远端地址\"></a>查看远端地址</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">可以看到别名以及地址</span></span><br><span class=\"line\">git remote -v </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">或者</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">只可以看到别名</span></span><br><span class=\"line\">git remote</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">查看某个远程仓库的详细信息</span></span><br><span class=\"line\">git remote show origin</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"推送至远端\"><a href=\"#推送至远端\" class=\"headerlink\" title=\"推送至远端\"></a>推送至远端</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git push [远端地址别名] [分支]</span></span><br><span class=\"line\">git push origin master</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">强制推送</span></span><br><span class=\"line\">git push origin --force</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"克隆远端仓库\"><a href=\"#克隆远端仓库\" class=\"headerlink\" title=\"克隆远端仓库\"></a>克隆远端仓库</h4><p>克隆操作会完成三个操作</p>\n<ul>\n<li>将项目克隆下来</li>\n<li>创建origin远程地址别名</li>\n<li>初始化本地仓库</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git <span class=\"built_in\">clone</span> [url]</span></span><br><span class=\"line\">git clone https://gitee.com/SiXiangPiaoFuZhe/studygit.git</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"拉取远端仓库\"><a href=\"#拉取远端仓库\" class=\"headerlink\" title=\"拉取远端仓库\"></a>拉取远端仓库</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git pull [别名] [分支]</span></span><br><span class=\"line\">git pull origin master</span><br></pre></td></tr></table></figure>\n\n<p>pull操作相当于fetch+merge</p>\n<p>所以也可以使用两步操作来完成拉取</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git fetch [别名] [分支]</span></span><br><span class=\"line\">git fetch origin master</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">git meger [别名/分支]</span></span><br><span class=\"line\">git merge origin/master</span><br></pre></td></tr></table></figure>\n\n","categories":["Git"],"tags":["Git"]},{"title":"Git底层剖析","url":"/2021/Git/Git%E5%BA%95%E5%B1%82%E5%89%96%E6%9E%90/","content":"<h2 id=\"Git底层剖析\"><a href=\"#Git底层剖析\" class=\"headerlink\" title=\"Git底层剖析\"></a>Git底层剖析</h2><p>之前的文章中有说过本地库是存在.git目录下的objects文件夹中，而且文件夹名为commit_id的前两位，文件名为commit_id的另外38位，那这里边记录的是什么呢，记录的是commit对象</p>\n<p>Git底层有三种类型的对象</p>\n<ul>\n<li>commit  记录版本提交时间、版本作者、版本序列等</li>\n<li>tree  记录文件名，目录结构</li>\n<li>blob  记录文件内容</li>\n</ul>\n<a id=\"more\"></a>\n\n<p>底层命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">查看数据类型</span></span><br><span class=\"line\">git cat-file -t commit_id</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">展示数据内容</span></span><br><span class=\"line\">git cat-file -p commit_id</span><br></pre></td></tr></table></figure>\n\n","categories":["Git"],"tags":["Git"]},{"title":"Git结构","url":"/2020/Git/Git%E7%BB%93%E6%9E%84/","content":"<h2 id=\"Git结构\"><a href=\"#Git结构\" class=\"headerlink\" title=\"Git结构\"></a>Git结构</h2><p>Git分为工作区、暂存区、本地库和远程仓库</p>\n<p>写代码时是在工作区进行操作的，使用git add 命令可以将文件加入到暂存区，使用git commit命令可以将暂存区的文件提交到本地库，使用git push命令可以将本地库的文件推送到远程仓库</p>\n<pre class=\"mermaid\">graph LR\nworkSpace[工作区]\nIndex[暂存区]\nrepository[本地库]\nremote[远程仓库]\nworkSpace--git add-->Index--git commit-->repository--git push-->remote\nremote--git pull-->workSpace\nremote--git fetch-->repository</pre>\n\n<p>这里需要根据.git目录来看</p>\n<figure class=\"highlight x86asm\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">.git</span>目录中有inde文件是暂存区(git <span class=\"keyword\">add</span>之后存在index中)</span><br><span class=\"line\"><span class=\"meta\">.git</span>目录中有objects目录，其中存储的是本地库(git commit之后存在objects中 文件夹名为commit_id的前两位，文件名为commit_id的另外<span class=\"number\">38</span>位)</span><br><span class=\"line\"><span class=\"meta\">.git</span>目录中的logs目录，存储的是所有的日志，只会增加不会删除</span><br><span class=\"line\"><span class=\"meta\">.git</span>目录中的refs目录，存储的是分支、标签、储存、远程分支分别所对应的commit_id</span><br></pre></td></tr></table></figure>\n\n\n\n<p>git checkout  </p>\n<p>git reset  从暂存区撤销回来</p>\n<a id=\"more\"></a>\n\n<p>从一个分支切到另一个分支，为了不把该分支修改的东西带到新的分支中，可以使用</p>\n<p>git stash  先暂存一下</p>\n<p>git stash pop  暂存的东西取出来</p>\n","categories":["Git"],"tags":["Git"]},{"title":"内存分配","url":"/2020/JVM/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/","content":"<h2 id=\"内存分配\"><a href=\"#内存分配\" class=\"headerlink\" title=\"内存分配\"></a>内存分配</h2><p>JVM中堆和栈属于不同的内存区域，使用目的也不同。栈常用于保存方法帧和局部变量，而对象总是在堆上分配。栈通常比堆小，也不会在多个线程之间共享，而堆被整个JVM的所有线程共享</p>\n<a id=\"more\"></a>\n\n<ul>\n<li>基本数据类型的变量和对象的引用在栈中分配</li>\n<li>堆内存用来存放由new创建的对象和数组</li>\n<li>类变量，程序在一加载的时候就在堆中为类变量分配内存，堆中的内存地址存放在栈中</li>\n<li>实例变量  使用new创建对象时，系统在堆中开辟并不一定是连续的空间分配给变量，是根据零散的堆内存地址，通过哈希算法换算出一长串数字以表示这个变量在堆中的物理位置，当实例引用丢失后，将被GC列入可回收名单中，但不会马上释放堆中的内存</li>\n<li>局部变量  声明在某方法或某段代码里，执行它的时候在栈中开辟内存，当局部变量一旦脱离作用域，内存立即释放</li>\n</ul>\n","categories":["JVM"],"tags":["JVM"]},{"title":"垃圾回收","url":"/2020/JVM/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/","content":"<h2 id=\"垃圾回收机制\"><a href=\"#垃圾回收机制\" class=\"headerlink\" title=\"垃圾回收机制\"></a>垃圾回收机制</h2><h3 id=\"垃圾回收算法\"><a href=\"#垃圾回收算法\" class=\"headerlink\" title=\"垃圾回收算法\"></a>垃圾回收算法</h3><ul>\n<li><p>标记-清除</p>\n</li>\n<li><p>标记-复制</p>\n</li>\n<li><p>标记-整理</p>\n</li>\n<li><p>分代回收</p>\n</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"如何判断一个对象是否应该被回收\"><a href=\"#如何判断一个对象是否应该被回收\" class=\"headerlink\" title=\"如何判断一个对象是否应该被回收\"></a>如何判断一个对象是否应该被回收</h3><ul>\n<li>引用计数法</li>\n<li>可达性分析</li>\n</ul>\n<h3 id=\"垃圾回收\"><a href=\"#垃圾回收\" class=\"headerlink\" title=\"垃圾回收\"></a>垃圾回收</h3><p>Java垃圾回收机制最基本的做法是分代回收。内存中的区域被分为不同的年代，对象根据其存活的时间被保存在对应年代的区域内。</p>\n<p>分为3个年代：年轻代、老年代和永久代。</p>\n<p>内存的分配发生在年轻代中。</p>\n<p>当对象存活时间足够长时，会被复制到老年代。</p>\n","categories":["JVM"],"tags":["JVM"]},{"title":"对象的引用","url":"/2020/JVM/%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BC%95%E7%94%A8/","content":"<h2 id=\"对象的引用\"><a href=\"#对象的引用\" class=\"headerlink\" title=\"对象的引用\"></a>对象的引用</h2><p>对象的引用分为了四个级别，从高到低为强引用、软引用、弱引用和虚引用</p>\n<p>引用类型都是java.lang.ref.Reference类的子类</p>\n<a id=\"more\"></a>\n\n<h3 id=\"强引用\"><a href=\"#强引用\" class=\"headerlink\" title=\"强引用\"></a>强引用</h3><p>最普遍的引用，如果一个对象具有强引用，就类似于生活必需品，垃圾回收器绝对不会回收它，当内存空间不足，java虚拟机宁愿抛出OutOfMemeryError错误，使程序异常终止，也不会随意回收具有强引用的对象来解决内存不足的问题</p>\n<p>当使用new来实例化一个对象并将其赋给一个变量的时候，这个变量就成为了指向这个对象的引用</p>\n<h3 id=\"软引用-SoftReference\"><a href=\"#软引用-SoftReference\" class=\"headerlink\" title=\"软引用(SoftReference)\"></a>软引用(SoftReference)</h3><p>一个对象具有软引用，类似于可有可无的生活用品。如果内存空间足够，垃圾回收器就不会回收它，如果空间内存不足，就会回收这些对象，可以用软引用来实现内存敏感的高速缓存。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">TestRef obj = <span class=\"keyword\">new</span> TestRef();</span><br><span class=\"line\">obj.setName(<span class=\"string\">&quot;张三&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 创建软引用，此时ref是通过软引用指向的obj对象</span></span><br><span class=\"line\">SoftReference&lt;TestRef&gt; ref = <span class=\"keyword\">new</span> SoftReference&lt;&gt;(obj);</span><br><span class=\"line\">System.out.println(obj);</span><br><span class=\"line\"><span class=\"comment\">// 清除强引用，如果不清除强引用的话，添加其他引用类型是没有作用的</span></span><br><span class=\"line\">obj = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"><span class=\"comment\">// ref的get()方法可以获取到所引用的实际对象</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(ref.get() != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">    System.out.println(ref.get());</span><br><span class=\"line\">    System.out.println(Objects.requireNonNull(ref.get()).getName());</span><br><span class=\"line\">    <span class=\"comment\">// 清除引用</span></span><br><span class=\"line\">    ref.clear();</span><br><span class=\"line\">      <span class=\"comment\">// 此时为null</span></span><br><span class=\"line\">    System.out.println(ref.get());</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以和引用队列联合使用，如果软引用所引用的对象被垃圾回收，java虚拟机会将这个软引用加入到与之关联的引用队列中</p>\n<h3 id=\"弱引用-WeakReference\"><a href=\"#弱引用-WeakReference\" class=\"headerlink\" title=\"弱引用(WeakReference)\"></a>弱引用(WeakReference)</h3><p>一个对象具有弱引用，也类似于可有可无的生活用品。弱引用和软引用的区别在于：只具有弱引用的对象拥有更短暂的生命周期。在垃圾回收器线程扫描内存区域时，一旦发现了只具有弱引用的对象，不管当前内存是否足够，都会进行回收。</p>\n<p>可以和引用队列联合使用，如果弱引用所引用的对象被垃圾回收，java虚拟机会将这个弱引用加入到与之关联的引用队列中</p>\n<h3 id=\"虚引用-PhantomReference\"><a href=\"#虚引用-PhantomReference\" class=\"headerlink\" title=\"虚引用(PhantomReference)\"></a>虚引用(PhantomReference)</h3><p>虚引用，顾名思义，就是形同虚设，与前面的几个都不相同，虚引用不会决定对象的生命周期，如果一个对象仅持有虚引用，就和没有任何引用一样，任何时候都可以被垃圾回收器回收。</p>\n<p>虚引用主要用于跟踪对象被垃圾回收的活动。虚引用与弱引用的区别在于，虚引用必须和引用队列(ReferenceQueue)联合使用。当垃圾回收器回收一个对象时，如果发现它有虚引用，在回收对象之前，把这个虚引用加入到与之关联的引用队列中。程序可以通过引用队列中是否加入了虚引用，来了解被引用的对象是否将要被垃圾回收。</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"类加载器","url":"/2020/JVM/%E7%B1%BB%E5%8A%A0%E8%BD%BD/","content":"<h2 id=\"类加载器\"><a href=\"#类加载器\" class=\"headerlink\" title=\"类加载器\"></a>类加载器</h2><p>类加载器最根本的一个作用是从包含字节代码的字节流中定义出虚拟机中的Class类的对象，得到Class类的对象之后，一个Java类就可以在虚拟机中自由使用，包括创建新的对象或调用类中的静态方法。</p>\n<p>Java虚拟机中的类加载器负责加载来自文件系统、网络或其他来源的类文件。Java虚拟机中的类加载器默认使用的是双亲委派模式。</p>\n<a id=\"more\"></a>\n\n<p>其中三种默认使用的类加载器，分别是Bootstrap ClassLoader、Extension ClassLoader和System ClassLoader(也称为Application ClassLoader)，每种类加载器已经确定从哪个位置加载类文件。</p>\n<p>Bootstrap ClassLoader负责加载JDK自带的rt.jar包中的类文件，是所有的类加载器的父加载器</p>\n<p>Extension ClassLoader负责加载Java扩展类库，从jre/lib/ext目录下或者java.ext.dirs系统属性指定的目录下加载类。</p>\n<p>Application ClassLoader负责从classpath环境变量中加载类文件，classpath环境变量通常由”-classpath”或”-cp”命令行选项来定义，或是由JAR中Mainifest文件的classpath属性指定。</p>\n<h3 id=\"双亲委派机制\"><a href=\"#双亲委派机制\" class=\"headerlink\" title=\"双亲委派机制\"></a>双亲委派机制</h3><img src=\"https://img-blog.csdnimg.cn/20200820101256124.jpg\" alt=\"类加载双亲委派\" style=\"zoom:33%;\">\n\n<p>根据双亲委派机制，在加载类文件时，子加载器首先会将加载请求委托给它的父加载器，父加载器会检测自己是否已经加载过该类，如果已经加载则加载过程结束；如果未加载则请求继续向上传递，直到Bootstrap ClassLoader。如果在请求向上委托的过程中，始终未检测到该类已加载，则从Bootstrap ClassLoader开始尝试从其对应路径中加载该类文件，如果加载失败，则向下传递，直到发起请求的子加载器位置为止。</p>\n<h4 id=\"双亲委派的作用\"><a href=\"#双亲委派的作用\" class=\"headerlink\" title=\"双亲委派的作用\"></a>双亲委派的作用</h4><ul>\n<li>子加载器可以使用父加载器已加载的类，而父加载器无法使用子加载器已加载的类</li>\n<li>父加载器已加载过的类无法被子加载器再次加载，保证JVM的安全性和稳定性</li>\n</ul>\n<blockquote>\n<p>注意：在Servlet规范中对于Web应用的类加载器的实现方式的推荐做法是使用当前类加载器优先的策略来代替默认的双亲委派，目的是为了解决web应用中的第三方库和容器本身使用的第三方库冲突的问题。如果采用双亲优先的话，那么容器中提供的第三方库会被优先加载，web应用中使用了同样的库，但是版本不同，会导致web应用出现错误</p>\n</blockquote>\n","categories":["JVM"],"tags":["JVM"]},{"title":"强制停止应用","url":"/2020/Mac/%E5%BC%BA%E5%88%B6%E7%BB%88%E6%AD%A2%E5%BA%94%E7%94%A8/","content":"<p>有时候使用Mac的时候，某个应用卡住了，但是肯定不能因为一个应用卡住了，</p>\n<a id=\"more\"></a>\n\n<p>就将电脑重启吧，所以只需要单独停止该应用即可，使用快捷键option+command+esc就会出现强制停止的界面，选择所要停止的应用，强制停止即可。</p>\n<img src=\"/images/Mac/强制停止应用.png\" style=\"zoom:33%;\">\n\n\n\n","categories":["Mac"],"tags":["Mac"]},{"title":"隐藏和显示文件","url":"/2020/Mac/%E9%9A%90%E8%97%8F%E5%92%8C%E6%98%BE%E7%A4%BA%E6%96%87%E4%BB%B6/","content":"<p>由于之前没有使用过Mac本，所以很多地方都不太清楚，在下载git项目的时候，发现没有.git文件，</p>\n<a id=\"more\"></a>\n\n<p>一开始还以为下载错了，但是git命令是可以看到远端分支以及当前分支的，之后在一次解压文件的时候发现，Mac默认是隐藏以.开头的文件的，使用快捷键**command+shift+.**可以显示/隐藏文件夹</p>\n","categories":["Mac"],"tags":["Mac"]},{"title":"idea多模块启动","url":"/2020/idea/idea%E4%B9%8B%E5%A4%9A%E6%A8%A1%E5%9D%97%E5%90%AF%E5%8A%A8/","content":"<h4 id=\"2018版本的idea\"><a href=\"#2018版本的idea\" class=\"headerlink\" title=\"2018版本的idea\"></a>2018版本的idea</h4><a id=\"more\"></a>\n\n<p>1.首先看一下view=&gt; Tool Windows下有没有Run Dashboard</p>\n<img src=\"/images/idea多模块启动/idea之多模块启动Run Dashboard.png\" alt=\"Run Dashboard\" style=\"zoom:50%;\">\n\n<p>如果有，点击一下底部的窗口就会出现</p>\n<img src=\"/images/idea多模块启动/idea之多模块启动Run Dashboard模块.png\" alt=\"Run Dashboard模块\" style=\"zoom:50%;\">\n\n<p>如果不存在，执行下一步<br>2.查看自己项目的工作空间位置    点击  File=&gt;Project Structure</p>\n<img src=\"/images/idea多模块启动/idea之多模块启动Project Structure.png\" alt=\"Project Structure\" style=\"zoom:50%;\">\n\n\n<p>该目录的上级目录，找到.idea文件夹，打开workspace.xml<br>搜索RunDashboard看看有没有该节点，如果存在该节点，该组件下添加</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">option</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;configurationTypes&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">set</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">option</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;MavenRunConfiguration&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">set</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">option</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>重启idea</p>\n<hr>\n<hr>\n<h4 id=\"2019版本的idea\"><a href=\"#2019版本的idea\" class=\"headerlink\" title=\"2019版本的idea\"></a>2019版本的idea</h4><p>2019的比较简单</p>\n<img src=\"/images/idea多模块启动/idea之多模块启动Run Configurations.png\" style=\"zoom:50%;\" alt=\"Run Configurations\">\n\n<img src=\"/images/idea多模块启动/idea之多模块启动Edit Configurations.png\" style=\"zoom:50%;\" alt=\"Edit Configurations\">\n\n<p>添加Spring Boot</p>\n<img src=\"/images/idea多模块启动/idea之多模块启动Spring Boot.png\" alt=\"Spring Boot\" style=\"zoom:50%;\">\n\n\n\n<p>之后重启idea   重启之后idea底部出现Services</p>\n<img src=\"/images/idea多模块启动/idea之多模块启动Services.png\" alt=\"Services\" style=\"zoom:75%;\">\n\n\n\n<hr>\n","categories":["idea"],"tags":["技巧","idea","开发工具"]},{"title":"idea启动build过慢","url":"/2020/idea/idea%E4%B9%8B%E7%BC%96%E8%AF%91%E9%97%AE%E9%A2%98/","content":"<p>之前使用idea的时候每次启动项目都会build很长时间，如果启动的项目过大，在build时还会出现GC的情况，查了很多资料都是说修改idea.exe.vmoptions中的内存分配</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight diff\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"deletion\">-Xms512m</span></span><br><span class=\"line\"><span class=\"deletion\">-Xmx2048m</span></span><br><span class=\"line\"><span class=\"deletion\">-XX:ReservedCodeCacheSize=480m</span></span><br></pre></td></tr></table></figure>\n<p>但是我修改了内存分配之后，build速度并没有改善，且大项目build依然会出现GC，而在eclipse中配置2048是可以起来的，所以我认为在编译的时候idea还有其他的配置，故而去settings中找编译的配置，果然找到了编译时的heap大小  默认为700，修改该值为2048<br>settings -&gt;Build,Execution,Deployment -&gt;Compiler</p>\n<p><img src=\"/images/idea%E5%A4%9A%E6%A8%A1%E5%9D%97%E5%90%AF%E5%8A%A8/idea%E4%B9%8B%E7%BC%96%E8%AF%91%E9%97%AE%E9%A2%98%E8%AE%BE%E7%BD%AE%E7%BC%96%E8%AF%91%E5%A0%86%E5%86%85%E5%AD%98.jpg\" alt=\"设置编译堆内存\"></p>\n<p>大项目可以编译过去了，不会出现GC情况，build虽然快了一些，但是build依然还是慢，继续看编译里还有没有其他配置，看到了自动编译，这是个好东西，选中，重启idea，发现果然改善了很多</p>\n<p><img src=\"/images/idea%E5%A4%9A%E6%A8%A1%E5%9D%97%E5%90%AF%E5%8A%A8/idea%E4%B9%8B%E7%BC%96%E8%AF%91%E9%97%AE%E9%A2%98%E8%87%AA%E5%8A%A8%E7%BC%96%E8%AF%91.jpg\" alt=\"自动编译\"></p>\n","categories":["idea"],"tags":["技巧","idea","开发工具"]},{"title":"Servlet详解","url":"/2021/javaweb/Servlet%E8%AF%A6%E8%A7%A3/","content":"<h2 id=\"Servlet详解\"><a href=\"#Servlet详解\" class=\"headerlink\" title=\"Servlet详解\"></a>Servlet详解</h2><p>在java web中不管是使用J2EE原生的servlet/jsp还是使用springmvc/springboot，在web服务器看来只是对外暴露出来的Servlet，而这个Servlet是javax.servlet.Servlet接口，该接口定义了Servlet引擎与Servlet程序之间通信的协议约定。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Servlet</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(ServletConfig config)</span> <span class=\"keyword\">throws</span> ServletException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">ServletConfig <span class=\"title\">getServletConfig</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">service</span><span class=\"params\">(ServletRequest req, ServletResponse res)</span></span></span><br><span class=\"line\"><span class=\"function\">    <span class=\"keyword\">throws</span> ServletException, IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">getServletInfo</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">destroy</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>而为了简化开发，jdk中提供了一个实现Servlet接口的简单的Servlet类，javax.servlet.GenericServlet，该类实现了Servlet的基本功能</p>\n<p>jdk针对HTTP协议专门提供了一个Servlet类，javax.servlet.http.HttpServlet，该类继承于GenericServlet类，在其基础上针对HTTP的特点进行扩充，一般编写程序时继承HttpServlet即可</p>\n<h3 id=\"Servlet注册与运行\"><a href=\"#Servlet注册与运行\" class=\"headerlink\" title=\"Servlet注册与运行\"></a>Servlet注册与运行</h3><p>Servlet编写好之后需要在web.xml中进行注册和映射才能被Servlet容器加载从而被外界访问</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 注册Servlet --&gt;</span>    </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>HW<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>com.zhanghe.study.servlet.HelloWorldServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">             <span class=\"comment\">&lt;!-- 配置servlet初始化init时中ServletConfig参数--&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>name<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>john<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">       <span class=\"comment\">&lt;!-- servlet加载时机 --&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 映射Servlet --&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>HW<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">         <span class=\"comment\">&lt;!-- 开头的/表示web用用程序的根目录 --&gt;</span></span><br><span class=\"line\">       <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/HelloWorld<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>tomcat中的web.xml包含有一个缺省的Servlet</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>default<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.apache.catalina.servlets.DefaultServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>debug<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>listings<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>default<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ServletConfig\"><a href=\"#ServletConfig\" class=\"headerlink\" title=\"ServletConfig\"></a>ServletConfig</h3><p>对于每个Servlet可能在启动时都需要一些初始化参数，而所有的Servlet是交由Servlet引擎去实例化的，那么也就是需要将每个Servlet的初始化参数也都配置到web.xml中，Servlet引擎将Servlet容器对象和Servlet的配置信息封装到ServletConfig中，并在Servlet初始化时将ServletConfig传递给该Servlet。javax.servlet.ServletConfig接口的作用就是用来定义ServletConfig对象所需要对外提供的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ServletConfig</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">getServletName</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">ServletContext <span class=\"title\">getServletContext</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">getInitParameter</span><span class=\"params\">(String var1)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">Enumeration&lt;String&gt; <span class=\"title\">getInitParameterNames</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Servlet引擎装载并创建一个Servlet对象后，会调用该对象的init(ServletConfig config)方法，Servlet中的ServletConfig getServletConfig()方法会返回init传入的ServletConfig对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取指定的属性</span></span><br><span class=\"line\">config.getInitParameter(<span class=\"string\">&quot;name&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">// 获取所有的属性</span></span><br><span class=\"line\">config.getInitParameters()</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"servlet生命周期\"><a href=\"#servlet生命周期\" class=\"headerlink\" title=\"servlet生命周期\"></a>servlet生命周期</h3><p>生命周期相关方法，servlet生命周期中的方法全是由servlet容器来调用的</p>\n<ul>\n<li>构造器</li>\n<li>init方法</li>\n<li>service方法</li>\n<li>destory方法</li>\n</ul>\n<h4 id=\"init方法\"><a href=\"#init方法\" class=\"headerlink\" title=\"init方法\"></a>init方法</h4><p>init方法在第一次创建servlet时被调用，在后续每次请求时都不会被调用。</p>\n<p>当用户调用servlet的时候，该servlet的一个实例就会被创建，并且为每一个用户产生一个新的线程，init()用于进行一些初始化数据的加载和处理，这些数据会被用于servlet的整个生命周期</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(ServletConfig config)</span> <span class=\"keyword\">throws</span> ServletException</span>;</span><br></pre></td></tr></table></figure>\n\n<p><strong>该方法是由servlet容器调用的</strong></p>\n<h5 id=\"重写init方法\"><a href=\"#重写init方法\" class=\"headerlink\" title=\"重写init方法\"></a>重写init方法</h5><p>GenericServlet实现了Servlet和ServletConfig，是一个抽象类，并对init(ServletConfig var1)方法进行了一层封装，有一个ServletConfig成员变量，在init()方法中进行了初始化，使得可以直接在GenericServlet中直接使用ServletConfig方法</p>\n<p>而我们平时写Servlet大多是继承于HttpServlet类的，在对init方法进行重写时，<strong>重写不带参的init()方法即可</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//GenericServlet类</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(ServletConfig config)</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.config = config;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.init();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ServletException </span>&#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>该方法由GenericServlet的调用，如果需要使用到ServletConfig则调用getServletConfig()方法来获取</p>\n<h4 id=\"service方法\"><a href=\"#service方法\" class=\"headerlink\" title=\"service方法\"></a>service方法</h4><p>service方法是实际处理请求的方法，servlet容器调用service方法来处理请求，并将响应写会到客户端，每次服务器接收到一个新的servlet请求时，服务器会产生一个新的线程来调用服务</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">service</span><span class=\"params\">(ServletRequest req, ServletResponse re)</span> <span class=\"keyword\">throws</span> ServletException, IOException</span>;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"处理请求逻辑\"><a href=\"#处理请求逻辑\" class=\"headerlink\" title=\"处理请求逻辑\"></a>处理请求逻辑</h5><p>HttpServlet继承了GenericServlet，重写了service方法，将ServletRequest和ServletResponse转换为HttpServletRequest和HttpServletResponse，并根据不同的请求方式进行分发，doGet/doPost/doHead等</p>\n<p>servlet可以在任何协议下访问 ,写的Servlet必须实现Servlet接口,在http协议下可以使用HttpServlet ，用来给Web访问的</p>\n<p>在HttpServlet类中对于service()方法进行了处理，根据请求方式的不同，将请求分发到了不同的方法，而我们一般情况下写Servlet也是继承自HttpServlet的，所以在写请求处理逻辑时，只需要重写doGet()和doPost()方法即可</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// HttpServlet类</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doGet</span><span class=\"params\">(HttpServletRequest req, HttpServletResponse resp)</span> <span class=\"keyword\">throws</span> ServletException, IOException </span>&#123;</span><br><span class=\"line\">    String msg = lStrings.getString(<span class=\"string\">&quot;http.method_get_not_supported&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.sendMethodNotAllowed(req, resp, msg);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doPost</span><span class=\"params\">(HttpServletRequest req, HttpServletResponse resp)</span> <span class=\"keyword\">throws</span> ServletException, IOException </span>&#123;</span><br><span class=\"line\">        String msg = lStrings.getString(<span class=\"string\">&quot;http.method_post_not_supported&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.sendMethodNotAllowed(req, resp, msg);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"GET方法\"><a href=\"#GET方法\" class=\"headerlink\" title=\"GET方法\"></a>GET方法</h6><p>GET方法时浏览器向web服务器传递信息的默认方法，会在地址栏上产生很长的字符串，且GET方法有大小限制，请求字符串中最多只能有1024个字符</p>\n<h6 id=\"POST方法\"><a href=\"#POST方法\" class=\"headerlink\" title=\"POST方法\"></a>POST方法</h6><p>POST方法不将请求信息放到地址中</p>\n<h4 id=\"destroy方法\"><a href=\"#destroy方法\" class=\"headerlink\" title=\"destroy方法\"></a>destroy方法</h4><p>destory()方法只在servlet生命周期结束时被调用一次。可以在destory()方法中进行一些资源的清理，如关闭数据库连接、停止后台线程等</p>\n<h3 id=\"ServletContext\"><a href=\"#ServletContext\" class=\"headerlink\" title=\"ServletContext\"></a>ServletContext</h3><p>每个Web应用程序都是一个独立的Servlet容器，每个Web应用程序分别用一个ServletContext对象表示，javax.servlet.ServletContext接口定义了ServletContext需要对外提供的方法，Servlet通过这些方法来和ServletContext容器进行通信</p>\n<ul>\n<li>该对象代表当前WEB应用，可以获取到web应用的信息，一个Web应用只有一个ServletContext对象</li>\n<li>可以使用ServletConfig的getServletContext()获取到ServletContext      </li>\n<li>可以获取web应用的初始化参数，这是全局的方法，在web.xml中配置<context-param></context-param></li>\n<li>获取web应用某个文件的绝对路径(在服务器上的路径，不是部署前的方法)  getRealPath</li>\n<li>获取当前应用的名称  getContextPath</li>\n<li>获取当前web应用的某一个文件对应的输入流  getResourceAsStream()  path是相对于当前web应用的根目录</li>\n</ul>\n","categories":["javaweb"],"tags":["javaweb"]},{"title":"idea生成UML","url":"/2020/idea/%E7%94%9F%E6%88%90UML/","content":"<p>使用idea直接生成UML类图</p>\n<a id=\"more\"></a>\n\n<img src=\"/images/idea/idea生成UML配置.png\" alt=\"idea生成UML配置\" style=\"zoom:33%;\">\n\n<p>然后点击所要生成的类即可生成</p>\n<img src=\"/images/idea/生成UML.png\" alt=\"生成UML\" style=\"zoom:33%;\">\n\n","categories":["idea"],"tags":["技巧","idea","开发工具"]},{"title":"最全的javaweb知识全集","url":"/2021/javaweb/servlet/","content":"<h2 id=\"最全的javaweb知识全集\"><a href=\"#最全的javaweb知识全集\" class=\"headerlink\" title=\"最全的javaweb知识全集\"></a>最全的javaweb知识全集</h2><h3 id=\"servlet容器\"><a href=\"#servlet容器\" class=\"headerlink\" title=\"servlet容器\"></a>servlet容器</h3><p>在上面介绍servlet生命周期时，多次提到了servlet容器，其实在设计Servlet时，J2EE  jdk只是提供了一个标准，在javax.servlet包以及子包下，而真正的实现是由servlet容器来进行实现的，如tomcat是在servlet-api.jar中实现的</p>\n<p>servlet容器<br>1、可以创建servlet，并调用servlet的相关生命周期方法<br>2、JSP、Filter、Listener</p>\n<p>下面将以tomcat作为servlet容器为例介绍web应用</p>\n<h3 id=\"web应用\"><a href=\"#web应用\" class=\"headerlink\" title=\"web应用\"></a>web应用</h3><h4 id=\"WEB-INF\"><a href=\"#WEB-INF\" class=\"headerlink\" title=\"WEB-INF\"></a>WEB-INF</h4><p>静态页面不要放在WEB-INF下，WEB-INF是给tomcat用的</p>\n<p>WEB-INF  对于web应用的描述</p>\n<blockquote>\n<ul>\n<li>web.xml 必须符合J2EE标准</li>\n<li>lib  放jar包</li>\n</ul>\n</blockquote>\n<h4 id=\"tomcat配置项目位置\"><a href=\"#tomcat配置项目位置\" class=\"headerlink\" title=\"tomcat配置项目位置\"></a>tomcat配置项目位置</h4><p>tomcat映射配置任意目录的项目<br>在conf下新建catalina文件夹，新建localhost文件夹，<br>在其中新建一个xml文件，文件名是url根路径<br>path当前没用  docBase为项目路径（编译之后的项目）</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Context</span> <span class=\"attr\">path</span>=<span class=\"string\">&quot;&quot;</span> <span class=\"attr\">docBase</span>=<span class=\"string\">&quot;&quot;</span> <span class=\"attr\">reloadable</span>=<span class=\"string\">&quot;true&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"web-xml配置servlet\"><a href=\"#web-xml配置servlet\" class=\"headerlink\" title=\"web.xml配置servlet\"></a>web.xml配置servlet</h4><p>load-on-startup参数指定servlet创建的时机   若为负数，则在第一次请求时被创建，若为0或者正数，在web应用被Servlet容器加载时创建实例，值越小越早被启动 </p>\n<p>init方法有入参  ServletConfig<br>配置ServletConfig</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 注意servlet和servlet-mapping都是成对出现的 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>HW<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>com.zhanghe.study.servlet.HelloWorldServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">     <span class=\"comment\">&lt;!-- 配置servlet初始化init时中ServletConfig参数--&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>name<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>john<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- servlet加载时机 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 对应servlet标签中的servlet-name值 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>HW<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>​    获取ServletConfig值</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取指定的属性</span></span><br><span class=\"line\">config.getInitParameter(<span class=\"string\">&quot;name&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">// 获取所有的属性</span></span><br><span class=\"line\">config.getInitParameters()</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"异常处理\"><a href=\"#异常处理\" class=\"headerlink\" title=\"异常处理\"></a>异常处理</h3><p>当servlet出现异常时，servlet容器使用exception-type元素来找到与抛出的异常类型相匹配的配置</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExceptionHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">HttpServlet</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">doGet</span><span class=\"params\">(HttpServletRequest req, HttpServletResponse resp)</span> <span class=\"keyword\">throws</span> ServletException, IOException </span>&#123;</span><br><span class=\"line\">        Throwable throwable = (Throwable) req.getAttribute(<span class=\"string\">&quot;javax.servlet.error.exception&quot;</span>);</span><br><span class=\"line\">        Integer code = (Integer) req.getAttribute(<span class=\"string\">&quot;javax.servlet.error.status_code&quot;</span>);</span><br><span class=\"line\">        String message = (String) req.getAttribute(<span class=\"string\">&quot;javax.servlet.error.message&quot;</span>);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;=========&quot;</span>);</span><br><span class=\"line\">        System.out.println(throwable);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;=========&quot;</span>);</span><br><span class=\"line\">        System.out.println(code);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;=========&quot;</span>);</span><br><span class=\"line\">        System.out.println(message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 配置异常处理的servlet --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>ExceptionHandler<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>com.zhanghe.study.servlet.ExceptionHandler<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>ExceptionHandler<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/ExceptionHandler<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 配置哪些错误码会调用该异常处理类 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">error-code</span>&gt;</span>404<span class=\"tag\">&lt;/<span class=\"name\">error-code</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">location</span>&gt;</span>/ExceptionHandler<span class=\"tag\">&lt;/<span class=\"name\">location</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 配置哪些异常类型会调用该异常处理类 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">exception-type</span>&gt;</span>java.lang.ArithmeticException<span class=\"tag\">&lt;/<span class=\"name\">exception-type</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">location</span>&gt;</span>/ExceptionHandler<span class=\"tag\">&lt;/<span class=\"name\">location</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>如果出现异常，会在请求域中设置相应的属性</p>\n<p>可以使用request.getAttribute(“”)取出</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">javax.servlet.error.status_code <span class=\"comment\">//错误码，Integer类型</span></span><br><span class=\"line\">javax.servlet.error.exception_type  <span class=\"comment\">// 异常类型，Class类型</span></span><br><span class=\"line\">javax.servlet.error.message    <span class=\"comment\">//异常信息,String类型</span></span><br><span class=\"line\">javax.servlet.error.request_uri  <span class=\"comment\">//出现异常的uri地址，String类型</span></span><br><span class=\"line\">javax.servlet.error.exception  <span class=\"comment\">//异常，Throwable类型</span></span><br><span class=\"line\">javax.servlet.error.servlet_name  <span class=\"comment\">//servlet名称，String类型</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"上传文件\"><a href=\"#上传文件\" class=\"headerlink\" title=\"上传文件\"></a>上传文件</h3><figure class=\"highlight html\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 上传文件一定要使用post请求</span></span><br><span class=\"line\"><span class=\"comment\">         enctype需要设置为multipart/form-data</span></span><br><span class=\"line\"><span class=\"comment\">     input标签的type类型设为file</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;post&quot;</span> <span class=\"attr\">enctype</span>=<span class=\"string\">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;file&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;file&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>form表单的编码格式<br>    ①application/x-www-form-urlencoded  默认   在发送前编码所有字符<br>    ②multipart/form-data  不对字符编码，二进制<br>    ③text/plain  空格转换为+号，但不对特殊字符编码</p>\n<p>使用读取流的方式来读取太过于麻烦  request.getInputStream() 获取到的是整个请求体，需要解析各个字段和分隔<br>解析multipart/form-data比较复杂<br>可以使用外部依赖包<br>commons-fileupload.jar   依赖于  commons-io.jar</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 文件上传 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>commons-fileupload<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>commons-fileupload<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.4<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>commons-fileupload解析请求，解析成FileItem集合，无论是文本域还是文件域<br>使用FileItem.isFormField()来判断是不是一个表单域<br>    表单域   item.getFieldName   item.getString</p>\n<p>​    非表单域  item.getFieldName  item.getName   item.getContentType  item.isImemory  item.getSize   item.getInputStream</p>\n<h3 id=\"转发和重定向\"><a href=\"#转发和重定向\" class=\"headerlink\" title=\"转发和重定向\"></a>转发和重定向</h3><h3 id=\"国际化\"><a href=\"#国际化\" class=\"headerlink\" title=\"国际化\"></a>国际化</h3><ul>\n<li>国际化(i18n): i18n internationalization，网站能够提供翻译成访问者的语言或国籍的不同版本的内容</li>\n<li>本地化(i10n): 向网站添加资源，使其适应特定的地理或文化区域，例如将网站翻译为中文</li>\n<li>区域设置：通常为语言符号后跟一个由下划线分隔的国家符号。例如”en_US”</li>\n</ul>\n<h4 id=\"获取区域\"><a href=\"#获取区域\" class=\"headerlink\" title=\"获取区域\"></a>获取区域</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//获取当前国家和语言</span></span><br><span class=\"line\">Locale locale = request.getLocale();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取区域设置\"><a href=\"#获取区域设置\" class=\"headerlink\" title=\"获取区域设置\"></a>获取区域设置</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取该区域设置的国家</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getCountry</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> baseLocale.getRegion();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 获取该区域设置的国家名称</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> String <span class=\"title\">getDisplayCountry</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> getDisplayCountry(getDefault(Category.DISPLAY));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 获取该区域设置的语言代码</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getLanguage</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> baseLocale.getLanguage();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 获取该区域设置的语言名称</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> String <span class=\"title\">getDisplayLanguage</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> getDisplayLanguage(getDefault(Category.DISPLAY));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 返回该区域设置的国家的三个字母缩写</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getISO3Country</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> MissingResourceException </span>&#123;</span><br><span class=\"line\">  String country3 = getISO3Code(baseLocale.getRegion(), LocaleISOData.isoCountryTable);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (country3 == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MissingResourceException(<span class=\"string\">&quot;Couldn&#x27;t find 3-letter country code for &quot;</span></span><br><span class=\"line\">                                       + baseLocale.getRegion(), <span class=\"string\">&quot;FormatData_&quot;</span> + toString(), <span class=\"string\">&quot;ShortCountry&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> country3;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 返回该区域设置的语言的三个字母缩写</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getISO3Language</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> MissingResourceException </span>&#123;</span><br><span class=\"line\">  String lang = baseLocale.getLanguage();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (lang.length() == <span class=\"number\">3</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> lang;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  String language3 = getISO3Code(lang, LocaleISOData.isoLanguageTable);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (language3 == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> MissingResourceException(<span class=\"string\">&quot;Couldn&#x27;t find 3-letter language code for &quot;</span></span><br><span class=\"line\">                                       + lang, <span class=\"string\">&quot;FormatData_&quot;</span> + toString(), <span class=\"string\">&quot;ShortLanguage&quot;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> language3;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"时间国际化\"><a href=\"#时间国际化\" class=\"headerlink\" title=\"时间国际化\"></a>时间国际化</h4><p>时间格式化 DateFormat</p>\n<h4 id=\"货币国际化\"><a href=\"#货币国际化\" class=\"headerlink\" title=\"货币国际化\"></a>货币国际化</h4><p>数字、货币格式化 NumberFormat</p>\n<h4 id=\"字符串国际化\"><a href=\"#字符串国际化\" class=\"headerlink\" title=\"字符串国际化\"></a>字符串国际化</h4><p>字符串格式化 MessageFormat  </p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">String str = <span class=\"string\">&quot;Date: &#123;0&#125;,Salary: &#123;1&#125;&quot;</span>;</span><br><span class=\"line\">Locale locale = Locale.CHINA;</span><br><span class=\"line\">Date date = <span class=\"keyword\">new</span> Date();</span><br><span class=\"line\"><span class=\"keyword\">double</span> sa1 = <span class=\"number\">12345.12</span>;</span><br><span class=\"line\">MessageFormat.format(str,date,sa1);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"国际化配置\"><a href=\"#国际化配置\" class=\"headerlink\" title=\"国际化配置\"></a>国际化配置</h4><p>native2ascii命令在jdk下   可以查看ascii码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">Locale locale = Locale.CHINA;</span><br><span class=\"line\">ResourceBundle bundle = ResourceBundle.getBundle(<span class=\"string\">&quot;i18n&quot;</span>,locale);</span><br></pre></td></tr></table></figure>\n\n<p>在配置文件中i18n.properties    i18n_en_US.properties   i18n_zh_CN.properties<br>根据locale来找不同的配置文件</p>\n<p>中文乱码问题<br>    GET请求   ①tomcat的server.xml文件中，在Connector 节点中添加useBodyEncodingForURI=”true” 属性  使用请求体的编码，然后在获取请求内容之前使用request.setCharacterEncoding(“UTF-8”)<br>             ②tomcat的server.xml文件中，在Connector 节点中添加URIEncoding=”UTF-8”属性<br>             ③tomcat的get请求默认使用ISO-8859-1来编码，可以在获取的时候进行转码，new String(request.getParameter(“name”).getBytes(“ISO-8859-1”),”UTF-8”)</p>\n<p>多个请求使用同一个Servlet<br>    第一种方案：在url加上入参method<br>    根据method进行分发</p>\n<p>​    第二种方案：<br>​    web.xml使用*.do来匹配Servlet<br>​    根据 request.getServletPath()然后反射调用方法</p>\n<p>表单的重复提交<br>    重复提交的情况<br>    ①在表单提交到一个Servlet，Servlet又通过请求转发的方式响应了一个页面，此时地址栏还保留着Servlet的那个路径，在响应页面点击刷新<br>    ②在响应页面没有到达时重复点击提交按钮<br>    ③点击返回，再点击提交</p>\n<p>不是重复提交的情况<br>①点击返回之后，刷新页面，再点击提交</p>\n<p>如何避免表单的重复提交<br>使用session，生成属性，移除属性</p>\n<p>HttpServletRequestWrapper类包装原始的request对象，实现了HttpServletRequest接口的所有方法，内部调用了所包装的<br>request对象的对应方法<br>相应的也有HttpServletResponseWrapper类来包装原始的response对象<br>    继承HttpServletRequestWrapper，重写</p>\n<p>Servlet监听器<br>用于监听ServletContext、HttpSession、ServletRequest等对象的创建和销毁，以及属性修改</p>\n<p>①监听ServletContext、HttpSession、ServletRequest等对象的创建和销毁<br>    ServletContextListener     创建contextInitialized       销毁contextDestroyed<br>    HttpSessionListener        创建sessionCreated           销毁sessionDestroyed<br>    ServletRequestListener     创建requestInitialized       销毁requestDestroyed</p>\n<p>实现相应的接口，监听不同的域对象</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- web.xml --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">listener</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">listener-class</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>场景：<br>ServletContextListener最常用，在当前WEB应用加载的时候对当前WEB应用的相关资源进行初始化操作：创建数据库连接池，创建Spring的IOC容器，读取当前WEB应用的初始化参数</p>\n</blockquote>\n<p>②监听域对象 ServletContext、HttpSession、ServletRequest 属性变更的监听器<br>    ServletContextAttributeListener   attributeAdded  attributeRemoved  attributeReplaced<br>    HttpSessionAttributeListener      attributeAdded  attributeRemoved  attributeReplaced<br>    ServletRequestAttributeListener   attributeAdded  attributeRemoved  attributeReplaced<br>        ServletRequestAttributeEvent  可以getName、getValue或者值</p>\n<p>③感知session绑定的监听器<br>    保存到Session域中的对象可以有多种状态：绑定到Session中，从Session中解除绑定；随Session对象持久到到一个存储设备中；随Session对象从一个存储设备中恢复<br>    HttpSessionBindingListener和HttpSessionActivationListener接口，实现这两个接口不需要在web.xml文件中注册</p>\n<p>放到session中的对象实现HttpSessionBindingListener<br>    会触发两个方法   绑定valueBound        解除valueUnBanding</p>\n<p>实现了HttpSessionActivationListener接口的对象可以感知自己被钝化和被活化的事件<br>    sessionWillPassivate 从内存写到磁盘     sessionDisActivate 从磁盘中读取出来</p>\n<p>session会被存储在tomcat当前项目下  .cer文件</p>\n","categories":["javaweb"],"tags":["javaweb"]},{"title":"事务处理","url":"/2020/javaweb/%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86/","content":"<p>J2EE包括了两套规范用来支持分布式事务：一种是Java Transcation API(JTA)，一种是Java Transcation Service(JTS)</p>\n<p>JTA是一种高层的、与实现无关的、与协议无关的标准API。</p>\n<a id=\"more\"></a>\n\n<p>JTS规定了支持JTA的事务管理器的实现规范。</p>\n<p>两阶段提交</p>\n<p>JTA</p>\n<p>Javax.transcation中</p>\n<p>UserTranscation接口</p>\n<p>Status接口</p>\n<p>Synchronization接口</p>\n<p>Transcation接口</p>\n","categories":["javaweb"],"tags":["javaweb"]},{"title":"会话管理","url":"/2021/javaweb/%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86/","content":"<h2 id=\"会话管理\"><a href=\"#会话管理\" class=\"headerlink\" title=\"会话管理\"></a>会话管理</h2><p>HTTP是无状态的协议，每次客户端访问web页面时，都会打开一个单独的连接到web服务器，服务器不会自动保存客户端请求的任何记录，需要使用cookie和session来将一系列的请求和响应关联起来，维持客户端和服务器之间的会话</p>\n<a id=\"more\"></a>\n\n<h3 id=\"cookie\"><a href=\"#cookie\" class=\"headerlink\" title=\"cookie\"></a>cookie</h3><p>Cookie是存储在计算机上的文本文件，用于追踪各种信息，记录在客户端，浏览器可以禁用cookie，可以删除cookie，<br>在服务器产生，作为响应头的一部分返回给客户端，浏览器收到cookie后，把cookie的键值写入到文本中，发送请求时浏览器会把cookie信息与请求发送给服务器</p>\n<h4 id=\"cookie原理\"><a href=\"#cookie原理\" class=\"headerlink\" title=\"cookie原理\"></a>cookie原理</h4><p>底层原理：WEB服务器通过在HTTP响应消息中增加Set-Cookie响应头字段将Cookie信息发送给浏览器，浏览器则通过在HTTP请求信息中增加Cookie请求头字段将Cookie回传给WEB服务器</p>\n<h4 id=\"操作cookie\"><a href=\"#操作cookie\" class=\"headerlink\" title=\"操作cookie\"></a>操作cookie</h4><h5 id=\"创建cookie\"><a href=\"#创建cookie\" class=\"headerlink\" title=\"创建cookie\"></a>创建cookie</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 第一个参数是cookie的键，第二个参数是cookie的值</span></span><br><span class=\"line\">Cookie cookie = <span class=\"keyword\">new</span> Cookie(<span class=\"string\">&quot;name&quot;</span>,<span class=\"string\">&quot;value&quot;</span>)</span><br><span class=\"line\">resp.addCookie(cookie)</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"获取cookie\"><a href=\"#获取cookie\" class=\"headerlink\" title=\"获取cookie\"></a>获取cookie</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">Cookie[] cookies = req.getCookies();</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"设置cookie的一些方法\"><a href=\"#设置cookie的一些方法\" class=\"headerlink\" title=\"设置cookie的一些方法\"></a>设置cookie的一些方法</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 描述cookie的注释</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setComment</span><span class=\"params\">(String purpose)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.comment = purpose;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 设置cookie适用的域名</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setDomain</span><span class=\"params\">(String pattern)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.domain = pattern.toLowerCase(Locale.ENGLISH);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 设置过期时间(单位是秒)，如果不设置，cookie在当前session中有效</span></span><br><span class=\"line\"><span class=\"comment\">// 如果设置生命周期会写在文件里</span></span><br><span class=\"line\"><span class=\"comment\">// 如果不设置生命周期会写在浏览器内存里，窗口关闭，cookie就没了</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setMaxAge</span><span class=\"params\">(<span class=\"keyword\">int</span> expiry)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.maxAge = expiry;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 设置cookie适用的路径，如果不指定，在当前目录及其子目录的URL下会返回cookie</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setPath</span><span class=\"params\">(String uri)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.path = uri;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 是否只在加密的连接上(SSL)发送</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setSecure</span><span class=\"params\">(<span class=\"keyword\">boolean</span> flag)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.secure = flag;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 设置cookie值</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setValue</span><span class=\"params\">(String newValue)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.value = newValue;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setVersion</span><span class=\"params\">(<span class=\"keyword\">int</span> v)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.version = v;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"获取cookie属性的方法\"><a href=\"#获取cookie属性的方法\" class=\"headerlink\" title=\"获取cookie属性的方法\"></a>获取cookie属性的方法</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取cookie的注释，如果没有为null</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getComment</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.comment;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 获取cookie适用的域名</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getDomain</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.domain;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 获取cookie过期时间，如果为-1，cookie表示持续到浏览器关闭</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getMaxAge</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.maxAge;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 获取cookie适用的路径</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getPath</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.path;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 获取是否只在加密的连接上发送</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">getSecure</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.secure;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// cookie的名称，创建后不可修改</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.name;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 获取cookie值</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getValue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.value;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getVersion</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.version;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"删除cookie\"><a href=\"#删除cookie\" class=\"headerlink\" title=\"删除cookie\"></a>删除cookie</h5><p>设置生命周期  cookie.setMaxAge()方法设置，秒为单位，若为0，表示立即删除该cookie，将该cookie放到响应中返回</p>\n<blockquote>\n<p>注意：一个servlet设置的cookie可以被同一个路径下或者子路径下的servlet读到，其他访问不到</p>\n<p>​           路径是指url可以通过cookie.setPath()方法设置cookie的作用范围</p>\n</blockquote>\n<h4 id=\"cookie适用场景\"><a href=\"#cookie适用场景\" class=\"headerlink\" title=\"cookie适用场景\"></a>cookie适用场景</h4><ul>\n<li>自动登录，不需要填写用户名和密码</li>\n<li>浏览记录</li>\n</ul>\n<h3 id=\"session\"><a href=\"#session\" class=\"headerlink\" title=\"session\"></a>session</h3><p>session是记录在服务器端，获取session需要把sessionId传递给服务端，通过sessionId来取到对应的session，关闭浏览器，session不会被销毁，还可以通过sessionId找到该session，在同一个application下的servlet/jsp可以共享一个session，前提是同一个客户端窗口</p>\n<h4 id=\"操作session\"><a href=\"#操作session\" class=\"headerlink\" title=\"操作session\"></a>操作session</h4><h5 id=\"创建或获取session\"><a href=\"#创建或获取session\" class=\"headerlink\" title=\"创建或获取session\"></a>创建或获取session</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 若为false，如果当前没有关联的session，如返回null；若为true，如果没有则会创建 默认是true</span></span><br><span class=\"line\">HttpSeesion session = request.getSession(<span class=\"keyword\">true</span>); </span><br></pre></td></tr></table></figure>\n\n<h5 id=\"session的相关方法\"><a href=\"#session的相关方法\" class=\"headerlink\" title=\"session的相关方法\"></a>session的相关方法</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 返回session的创建时间(单位毫秒)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">getCreationTime</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 获取sessionId</span></span><br><span class=\"line\"><span class=\"function\">String <span class=\"title\">getId</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 返回客户端最后一次发送与该session会话相关的请求的时间(单位毫秒)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">long</span> <span class=\"title\">getLastAccessedTime</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">ServletContext <span class=\"title\">getServletContext</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// session的过期时间，单位秒</span></span><br><span class=\"line\"><span class=\"comment\">// 也可以在web.xml中设置过期时间，单位为分钟，tomcat默认是30分钟</span></span><br><span class=\"line\"><span class=\"comment\">// &lt;session-config&gt;</span></span><br><span class=\"line\"><span class=\"comment\">//    &lt;session-timeout15&gt;&lt;/session-timeout&gt;</span></span><br><span class=\"line\"><span class=\"comment\">// &lt;/session-config&gt;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setMaxInactiveInterval</span><span class=\"params\">(<span class=\"keyword\">int</span> var1)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 返回servlet容器在客户端访问时保持session会话打开的最大时间间隔，单位秒</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getMaxInactiveInterval</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 返回seesion会话中该名称的对象，没有返回null</span></span><br><span class=\"line\"><span class=\"function\">Object <span class=\"title\">getAttribute</span><span class=\"params\">(String var1)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 返回该session会话中所有的名称</span></span><br><span class=\"line\"><span class=\"function\">Enumeration&lt;String&gt; <span class=\"title\">getAttributeNames</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 将对象绑定到该session会话中</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setAttribute</span><span class=\"params\">(String var1, Object var2)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 移除指定名称的对象</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">removeAttribute</span><span class=\"params\">(String var1)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 使该session无效</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">invalidate</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 是否为新创建的session(客户端还不知道该session)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isNew</span><span class=\"params\">()</span></span>;</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 判断当前请求的session是否合法</span></span><br><span class=\"line\">req.isRequestedSessionIdValid();</span><br><span class=\"line\"><span class=\"comment\">// 判断当前请求是不是从URL发出的</span></span><br><span class=\"line\">req.isRequestedSessionIdFromURL();</span><br><span class=\"line\"><span class=\"comment\">// 判断当前请求是不是从cookie发出的</span></span><br><span class=\"line\">req.isRequestedSessionIdFromCookie();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"session的超时时间\"><a href=\"#session的超时时间\" class=\"headerlink\" title=\"session的超时时间\"></a>session的超时时间</h4><p>可以在web.xml中配置session的超时时间</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">session-config</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">session-timeout</span>&gt;</span>30<span class=\"tag\">&lt;/<span class=\"name\">session-timeout</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">session-config</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"session的实现方式\"><a href=\"#session的实现方式\" class=\"headerlink\" title=\"session的实现方式\"></a>session的实现方式</h4><p>session有两种实现方式<br><strong>①</strong>通过cookie来实现  第一次请求时，响应在响应头set-Cookie中 有sessionId，把sessionId放到cookie中，如果浏览器支持cookie，会把sessionId放到cookie中<br>默认是存储在内存中的，没有存储在磁盘上，关闭浏览器就会失效<br>可以进行持久化，使用cookie.setMaxAge</p>\n<p><strong>②</strong>通过URL重写来实现<br>    response.encodeURL两个作用</p>\n<ul>\n<li>转码</li>\n<li>URL后加上sessionID</li>\n</ul>\n<h4 id=\"session的持久化\"><a href=\"#session的持久化\" class=\"headerlink\" title=\"session的持久化\"></a>session的持久化</h4><p>由于session会占用内存资源，可以将session进行持久化放到文件或者数据库中保存，Tomcat中使用org.apache.catalina.session.PersistentManager和org.apache.catalina.session.StandardManager两个类来管理session的持久化</p>\n<h5 id=\"StandardManager\"><a href=\"#StandardManager\" class=\"headerlink\" title=\"StandardManager\"></a>StandardManager</h5><p>StandardManager是在web应用程序关闭时，堆内存中的所有HttpSession对象进行持久化，保存在文件系统中，默认位置为tomcat下的</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\">\\work\\Catalina\\<span class=\"tag\">&lt;<span class=\"name\">主机名</span>&gt;</span>\\<span class=\"tag\">&lt;<span class=\"name\">应用程序名</span>&gt;</span>\\SESSION.ser</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"PersistentManager\"><a href=\"#PersistentManager\" class=\"headerlink\" title=\"PersistentManager\"></a>PersistentManager</h5><p>PersistentManager比StandardManager更加灵活，只要某个设备提供了实现org.apache.catalina.Store接口，就可以将HttpSession对象保存到对应的设备下</p>\n<p>配置方式为</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- server.xml配置文件中Context标签下 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Manager</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.session.PersistentManager&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Store</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;...&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">Store</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Manager</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["javaweb"],"tags":["javaweb"]},{"title":"响应","url":"/2021/javaweb/%E5%93%8D%E5%BA%94/","content":"<h2 id=\"响应\"><a href=\"#响应\" class=\"headerlink\" title=\"响应\"></a>响应</h2><p>HTTP的响应消息分为三部分：状态行、响应头、响应正文。</p>\n<p>Servlet API中一般使用HttpServletResponse来表示响应。</p>\n<p>状态行对应的方法是</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setStatus</span><span class=\"params\">(<span class=\"keyword\">int</span> sc)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<p>响应头对应的方法为</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addHeader</span><span class=\"params\">(String name, String value)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">//或者</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setHeader</span><span class=\"params\">(String name, String value)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<p>响应正文对应的方法为</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> ServletOutputStream <span class=\"title\">getOutputStream</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"><span class=\"comment\">//或者</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> PrintWriter <span class=\"title\">getWriter</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["javaweb"],"tags":["javaweb"]},{"title":"请求","url":"/2021/javaweb/%E8%AF%B7%E6%B1%82/","content":"<h2 id=\"请求\"><a href=\"#请求\" class=\"headerlink\" title=\"请求\"></a>请求</h2><p>HTTP的请求消息分为三部分：请求行、请求头、请求正文。</p>\n<p>在Servlet API中一般使用HttpServletRequest来表示HTTP请求</p>\n<a id=\"more\"></a>\n\n<p>请求行对应方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取请求行中的协议名和版本</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getProtocol</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取请求方式</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getMethod</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// url中的额外路径信息</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getPathInfo</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// url中的额外路径信息多对应的资源的真是路径</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getPathTranslated</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取请求URL所属的WEB应用程序路径，以/开头，表示整个web站点的根目录</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getContextPath</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 请求行中的参数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getQueryString</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取请求行中的资源名，主机端口之后，参数之前的部分</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getRequestURI</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取Servlet所映射的路径</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServletPath</span><span class=\"params\">()</span></span>;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>网络连接信息相关方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 客户端的ip</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getRemoteAddr</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">//客户端的主机</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getRemoteHost</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">//客户端的端口</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getRemotePort</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 服务器接收当前请求的网络接口的ip对应的主机名</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getLocalName</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 服务器接收当前请求的网络接口的ip</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getLocalAddr</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 服务器接收当前请求的网络接口的端口</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getLocalPort</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 获取URL</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> StringBuffer <span class=\"title\">getRequestURL</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 当前请求所指向的主机名</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getServerName</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 当前请求所连接的服务器端口号</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getServerPort</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 协议名</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getScheme</span><span class=\"params\">()</span></span>;</span><br></pre></td></tr></table></figure>\n\n<p>请求头信息</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取请求头</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getDateHeader</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getHeader</span><span class=\"params\">(String name)</span></span>; </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Enumeration&lt;String&gt; <span class=\"title\">getHeaders</span><span class=\"params\">(String name)</span></span>; </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Enumeration&lt;String&gt; <span class=\"title\">getHeaderNames</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getIntHeader</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 获取Content-Length头字段信息</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getContentLength</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 返回Content-Type头字段信息</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getContentType</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 返回请求消息的字符集编码，Content-Type头字段信息</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getCharacterEncoding</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getAuthType</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"keyword\">public</span> Cookie[] getCookies();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getRemoteUser</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isUserInRole</span><span class=\"params\">(String role)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> java.security.<span class=\"function\">Principal <span class=\"title\">getUserPrincipal</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getRequestedSessionId</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> HttpSession <span class=\"title\">getSession</span><span class=\"params\">(<span class=\"keyword\">boolean</span> create)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> HttpSession <span class=\"title\">getSession</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">changeSessionId</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isRequestedSessionIdValid</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isRequestedSessionIdFromCookie</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isRequestedSessionIdFromURL</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isRequestedSessionIdFromUrl</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">authenticate</span><span class=\"params\">(HttpServletResponse response)</span> </span></span><br><span class=\"line\"><span class=\"function\">  <span class=\"keyword\">throws</span> IOException,ServletException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">login</span><span class=\"params\">(String username, String password)</span> </span></span><br><span class=\"line\"><span class=\"function\">  <span class=\"keyword\">throws</span> ServletException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">logout</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ServletException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Collection&lt;Part&gt; <span class=\"title\">getParts</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException, ServletException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Part <span class=\"title\">getPart</span><span class=\"params\">(String name)</span> <span class=\"keyword\">throws</span> IOException, ServletException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> &lt;T extends HttpUpgradeHandler&gt; <span class=\"function\">T  <span class=\"title\">upgrade</span><span class=\"params\">(Class&lt;T&gt; handlerClass)</span></span></span><br><span class=\"line\"><span class=\"function\">  <span class=\"keyword\">throws</span> IOException, ServletException</span>;</span><br></pre></td></tr></table></figure>\n\n<p>获取请求参数</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 读取url地址后的参数或者POST请求中application/x-www-form-urlencoded编码的实体</span></span><br><span class=\"line\"><span class=\"comment\">// 可以对编码内容自动完成参数的分解、提取以及解码</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getParameter</span><span class=\"params\">(String name)</span></span>;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Enumeration&lt;String&gt; <span class=\"title\">getParameterNames</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"keyword\">public</span> String[] getParameterValues(String name);</span><br><span class=\"line\"><span class=\"keyword\">public</span> Map&lt;String, String[]&gt; getParameterMap();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取流对象</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> ServletInputStream <span class=\"title\">getInputStream</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>; </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> BufferedReader <span class=\"title\">getReader</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>\n\n","categories":["javaweb"],"tags":["javaweb"]},{"title":"请求转发和重定向","url":"/2021/javaweb/%E8%AF%B7%E6%B1%82%E8%BD%AC%E5%8F%91%E5%92%8C%E9%87%8D%E5%AE%9A%E5%90%91/","content":"<h2 id=\"请求转发和重定向\"><a href=\"#请求转发和重定向\" class=\"headerlink\" title=\"请求转发和重定向\"></a>请求转发和重定向</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 请求转发</span></span><br><span class=\"line\">request.getRequestDispatcher(url).forward(req,resp)</span><br><span class=\"line\"><span class=\"comment\">// 请求重定向</span></span><br><span class=\"line\">response.sendRedirect(url)</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"请求转发\"><a href=\"#请求转发\" class=\"headerlink\" title=\"请求转发\"></a>请求转发</h3><p>请求转发使用的是RequestDispatcher.forward方法来实现的，先看一下RequestDispatcher这个接口是什么</p>\n<h4 id=\"RequestDispatcher接口\"><a href=\"#RequestDispatcher接口\" class=\"headerlink\" title=\"RequestDispatcher接口\"></a>RequestDispatcher接口</h4><p>RequestDispatcher的实例是由Servlet引擎创建的，用于包装一个要被其他资源调用的资源，并可以通过其中的方法将客户端的请求转发给所包装的资源</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">RequestDispatcher</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">   </span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String FORWARD_REQUEST_URI = <span class=\"string\">&quot;javax.servlet.forward.request_uri&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String FORWARD_CONTEXT_PATH = <span class=\"string\">&quot;javax.servlet.forward.context_path&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String FORWARD_PATH_INFO = <span class=\"string\">&quot;javax.servlet.forward.path_info&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String FORWARD_SERVLET_PATH = <span class=\"string\">&quot;javax.servlet.forward.servlet_path&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String FORWARD_QUERY_STRING = <span class=\"string\">&quot;javax.servlet.forward.query_string&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String INCLUDE_REQUEST_URI = <span class=\"string\">&quot;javax.servlet.include.request_uri&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String INCLUDE_CONTEXT_PATH = <span class=\"string\">&quot;javax.servlet.include.context_path&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String INCLUDE_PATH_INFO = <span class=\"string\">&quot;javax.servlet.include.path_info&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String INCLUDE_SERVLET_PATH = <span class=\"string\">&quot;javax.servlet.include.servlet_path&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String INCLUDE_QUERY_STRING = <span class=\"string\">&quot;javax.servlet.include.query_string&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String ERROR_EXCEPTION = <span class=\"string\">&quot;javax.servlet.error.exception&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String ERROR_EXCEPTION_TYPE = <span class=\"string\">&quot;javax.servlet.error.exception_type&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String ERROR_MESSAGE = <span class=\"string\">&quot;javax.servlet.error.message&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String ERROR_REQUEST_URI = <span class=\"string\">&quot;javax.servlet.error.request_uri&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String ERROR_SERVLET_NAME = <span class=\"string\">&quot;javax.servlet.error.servlet_name&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String ERROR_STATUS_CODE = <span class=\"string\">&quot;javax.servlet.error.status_code&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 用于将请求转发到RequestDispatcher对象封装的资源</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">forward</span><span class=\"params\">(ServletRequest request, ServletResponse response)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> ServletException, IOException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 将RequestDispatcher对象封装的资源作为当前响应的一部分包含进来</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">include</span><span class=\"params\">(ServletRequest request, ServletResponse response)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> ServletException, IOException</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"请求重定向\"><a href=\"#请求重定向\" class=\"headerlink\" title=\"请求重定向\"></a>请求重定向</h3><p>重定向使用的是response.sendRedirect方法，sendRedirect方法会产生一个302的响应码和Location的响应头，从而通知客户端去重新访问Location响应头中指定的URL</p>\n<h3 id=\"两者的区别\"><a href=\"#两者的区别\" class=\"headerlink\" title=\"两者的区别\"></a>两者的区别</h3><p>本质区别：请求转发只向服务器发起一次请求，重定向发起两次请求</p>\n<ol>\n<li>请求转发：地址是初次发出请求的地址<br>重定向：地址栏是最后响应的地址</li>\n<li>请求转发：在最终的Servlet中，request对象和中转的那个request是同一个对象<br>重定向：在最终的Servlet中,request对象和中转的那个request不是同一个对象</li>\n<li>请求转发：只能转发到当前web应用<br>请求重定向：可以重定向到任何资源</li>\n<li>请求转发：/代表当前web应用的根目录<br>请求重定向：/代表当前web站点的根目录，要使用request.getContextPath()再加上路径</li>\n</ol>\n","categories":["javaweb"],"tags":["javaweb"]},{"title":"过滤器","url":"/2021/javaweb/%E8%BF%87%E6%BB%A4%E5%99%A8/","content":"<h2 id=\"过滤器Filter\"><a href=\"#过滤器Filter\" class=\"headerlink\" title=\"过滤器Filter\"></a>过滤器Filter</h2><p>依赖于servlet容器，基于函数回调，可以对请求和响应进行拦截，在访问后端资源之前，拦截这些来自客户端的请求，在发送回客户端之前，处理这些响应</p>\n<h3 id=\"过滤器的类型\"><a href=\"#过滤器的类型\" class=\"headerlink\" title=\"过滤器的类型\"></a>过滤器的类型</h3><ul>\n<li>身份验证过滤器</li>\n<li>数据压缩过滤器</li>\n<li>加密过滤器</li>\n<li>触发访问事件资源的过滤器</li>\n<li>图像转换过滤器</li>\n<li>日志记录和审核过滤器</li>\n<li>MIME-类型链过滤器</li>\n<li>Tokenizing过滤器</li>\n<li>转换XML内容的XSL/T过滤器</li>\n</ul>\n<h3 id=\"过滤器的使用\"><a href=\"#过滤器的使用\" class=\"headerlink\" title=\"过滤器的使用\"></a>过滤器的使用</h3><p>需要实现Filter接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Filter</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 由servlet容器调用，指示一个过滤器被放入服务</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(FilterConfig var1)</span> <span class=\"keyword\">throws</span> ServletException</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 在每次一个请求或响应在所对应的资源下时通过链传递，由容器调用</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">doFilter</span><span class=\"params\">(ServletRequest var1, ServletResponse var2, FilterChain var3)</span> <span class=\"keyword\">throws</span> IOException, ServletException</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 由servlet容器调用，指示一个过滤器从服务去除</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">destroy</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>​    在web.xml中配置写好的Filter</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>security<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">filter-class</span>&gt;</span>com.zhanghe.study.webstudy.filter.SecurityFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-class</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!--用户名--&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>userName<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>john<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 拦截的顺序与在web.xml中 filter-mapping的配置顺序有关，靠前的先被调用 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter-mapping</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>security<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/*<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 在filter-mapping中有一个dispatcher标签，指定过滤器所拦截的资源被Servlet容器的调用方式</span></span><br><span class=\"line\"><span class=\"comment\">                可以是REQUEST,INCLUDE,FORWARD和ERROR,默认是REQUEST</span></span><br><span class=\"line\"><span class=\"comment\">                可以指定多个dispatcher来指定Filter对资源的多种调用方式进行拦截 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">dispatcher</span>&gt;</span>REQUEST<span class=\"tag\">&lt;/<span class=\"name\">dispatcher</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n","categories":["javaweb"],"tags":["javaweb"]},{"title":"原码、反码、补码","url":"/2020/java%E5%9F%BA%E7%A1%80/java%E5%8E%9F%E7%A0%81/","content":"<h2 id=\"原码、反码、补码\"><a href=\"#原码、反码、补码\" class=\"headerlink\" title=\"原码、反码、补码\"></a>原码、反码、补码</h2><p>正数的原码、反码、补码三者一样</p>\n<a id=\"more\"></a>\n\n<p>负数的原码—》 正数的符号位变为1</p>\n<p>​           反码—》 原码除了符号位之外取反</p>\n<p>​           补码—》 反码+1</p>\n<p>在计算机底层都是以补码的形式存储的</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"写java程序应该注意的一些小细节","url":"/2021/java%E5%9F%BA%E7%A1%80/%E6%B3%A8%E6%84%8F%E7%82%B9/","content":"<h2 id=\"写java程序应该注意的一些小细节\"><a href=\"#写java程序应该注意的一些小细节\" class=\"headerlink\" title=\"写java程序应该注意的一些小细节\"></a>写java程序应该注意的一些小细节</h2><h3 id=\"重写equals方法时需要注意的细节\"><a href=\"#重写equals方法时需要注意的细节\" class=\"headerlink\" title=\"重写equals方法时需要注意的细节\"></a>重写equals方法时需要注意的细节</h3><p>注意equals方法的入参是Object，不要随意的改成其他类型，否则就变成了重载而不是重写，在重写方法时一定要加上@Override注解，它可以帮助你提前发现你的错误写法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object obj)</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>重写equals时一定要重写hashCode方法，Object方法中的equals方法上的注释标注了这一点</p>\n<figure class=\"highlight oxygene\"><table><tr><td class=\"code\"><pre><span class=\"line\">Note that it <span class=\"keyword\">is</span> generally necessary <span class=\"keyword\">to</span> <span class=\"keyword\">override</span> the <span class=\"comment\">&#123;@code hashCode&#125;</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">method</span> <span class=\"title\">whenever</span> <span class=\"title\">this</span> <span class=\"title\">method</span> <span class=\"title\">is</span> <span class=\"title\">overridden</span>, <span class=\"title\">so</span> <span class=\"title\">as</span> <span class=\"title\">to</span> <span class=\"title\">maintain</span> <span class=\"title\">the</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">general</span> <span class=\"title\">contract</span> <span class=\"title\">for</span> <span class=\"title\">the</span> <span class=\"comment\">&#123;@code hashCode&#125;</span> <span class=\"title\">method</span>, <span class=\"title\">which</span> <span class=\"title\">states</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">that</span> <span class=\"title\">equal</span> <span class=\"title\">objects</span> <span class=\"title\">must</span> <span class=\"title\">have</span> <span class=\"title\">equal</span> <span class=\"title\">hash</span> <span class=\"title\">codes</span>.</span></span><br></pre></td></tr></table></figure>\n\n<p>如果这个方法被重写则必须重写hashCode方法，为了保证hashCode的规范，两个对象equals相等则其hashCode必须相等</p>\n","categories":["java基础"],"tags":["java基础"]},{"url":"/2020/maven/maven/","content":"<p>maven<br>构建<br>    清理：将之前编译的class字节码文件删除<br>    编译：将java源程序编译成为class字节码文件<br>    测试：自动测试，自动调用junit程序<br>    报告：测试程序执行的结果<br>    打包：动态web工程打war包，java工程打jar包<br>    安装：将打包得到的文件复制到仓库中指定的位置<br>    部署：将动态web工程生成的</p>\n<p>TODO 待整理</p>\n<a id=\"more\"></a>\n\n\n<p>mvn -v 查看maven版本<br>mvn clean  清理<br>mvn compile  编译<br>mvn test-compile  编译测试程序<br>mvn test  执行测试<br>mvn package  打包<br>mvn install 安装到本地仓库</p>\n<p>目录结构<br>    src  源码 主程序<br>        main<br>            - java  源文件<br>            - resources  框架配置文件<br>        test<br>            - java<br>            - resources<br>    pom.xml</p>\n<p>POM<br>    Project Object Model 项目对象模型<br>    pom.xml  maven的核心配置文件</p>\n<p>坐标<br>    groupid: 公司域名倒叙+项目名<br>    artifactid: 模块名<br>    version: 版本</p>\n<p>依赖<br>    依赖的范围<br>        ①compile<br>            - 对主程序是否有效(main)：有效<br>            - 对测试程序是否有效（test）：有效<br>            - 是否参与打包：参与<br>        ②test<br>            - 对主程序是否有效：无效<br>            - 对测试程序是否有效：有效<br>            - 是否参与打包：不参与<br>        ③provided<br>            只参与开发环节，部署运行时不需要，在服务器上存在，如servlet-api.jar<br>            - 对主程序是否有效：有效<br>            - 对测试程序是否有效：有效<br>            - 是否参与打包：不参与<br>        ④runtime<br>            运行时有效，编译时无效，如JDBC</p>\n<pre><code>依赖的传递性\n    非compile范围的无法传递\n\n依赖的排除\n    &lt;exclusions&gt;\n\n依赖的原则\n    作用：解决各模块之间jar包冲突问题\n\n    路径最短原则\n    路径距离相同的情况下，先声明者优先，dependency的声明顺序\n\n\n版本的统一管理\n    使用&lt;properties&gt;使用自定义标签号\n        &lt;properties&gt;\n            &lt;spring.version&gt;4.1.2&lt;/spring.version&gt;  \n        &lt;/properties&gt;\n\n        依赖中使用版本\n        $&#123;spring.version&#125;</code></pre>\n<p>仓库<br>    本地仓库：<br>    私服：局域网内的<br>    中央仓库：<br>    中央仓库镜像：为了分担中央仓库的流量</p>\n<pre><code>仓库中包含\n①maven工程所需要的插件\n②第三方框架或工具的jar包\n③自己开发的Maven工程</code></pre>\n<p>生命周期</p>\n<pre><code>无论是执行哪个阶段，都会从最初的位置开始执行\nmaven有三套生命周期\n一、clean生命周期  在构建之前进行一些清理工作\n    pre-clean clean之前完成的工作\n    clean 移除上一次构建生成的文件\n    post-clean 执行一些需要在clean之后立刻完成的工作\n\n二、Default 生命周期  构建的核心，编译、测试、打包、安装、部署    每个都是一个目标goal 在插件中指定目标\n    validate:\n\n    generate-sources\n    process-sources  \n\n    generate-resources\n    process-resources  复制并处理资源文件，至目标目录，准备打包\n\n    complie\n\n    process-classes\n\n    generate-test-sources\n    process-test-sources\n\n    generate-test-resources\n    process-test-resources  复制并处理资源文件，至目标测试目录\n\n    test-complie  编译测试代码\n\n    process-test-classes\n\n    test 测试\n\n    prepare-package\n    package  打包\n\n    pre-integration-test\n    integration-test\n    post-integration-test\n\n    verify\n\n    install 安装至本地仓库\n\n    deploy 复制到远程仓库\n\n三、Site生命周期  生成项目报告、站点、发布站点\n    pre-site：执行一些需要在生成站点文档之前的工作\n    site：生成项目的站点文档\n    post-site：执行一些需要在生成站点文档之后完成的工作，并且为部署做准备\n    site-deploy：将生成的站点文档部署到服务器上\n\n\n插件中配置该插件执行的生命周期\n&lt;plugin&gt;\n    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n    &lt;artifactId&gt;maven-source-plugin&lt;/artifactId&gt;\n    &lt;version&gt;3.7.0&lt;/version&gt;\n    &lt;executions&gt;\n        &lt;execution&gt;\n            &lt;phase&gt;compile&lt;/phase&gt;  生命周期\n            &lt;goals&gt;\n                &lt;goal&gt;jar&lt;goal&gt;  目标\n            &lt;/goals&gt;\n        &lt;/execution&gt;\n    &lt;/executions&gt;\n&lt;/plugin&gt;</code></pre>\n<p>继承<br>    继承父工程的版本</p>\n<pre><code>在父工程中进行统一的依赖管理，子工程也可以不使用该依赖的version\n依赖管理\n&lt;dependencyManagement&gt;\n    &lt;dependencies&gt;\n        &lt;denpendency&gt;\n\n        &lt;/denpendency&gt;\n    &lt;/dependencies&gt;\n&lt;/dependencyManagement&gt;</code></pre>\n<p>聚合<br>    在maven工程中可以配置多个模块<br>        <modules><br>            指定相对路径<br>            <module></module><br>        </modules></p>\n<p>寻找依赖的插件或者jar包 ，先寻找本地仓库，连接中央仓库下载</p>\n<p>配置构建过程<br><build><br>    <plugins><br>        <!-- 插件 --><br>        <plugin><br>        </plugin><br>    </plugins><br></build></p>\n<p>maven 有一个超级pom  在lib下的maven-model-builder.jar中</p>\n<p>可以使用mvn help:effective-pom命令来查看完整的pom文件(包含有超级pom内容的pom文件</p>\n<p>命令<br>mvn cobertura:cobertura  测试代码的覆盖率统计信息</p>\n<p>mvn archetype:create -DgroupId= -DartifactId= -DpackageName= 创建maven工程<br>mvn install:install-file -Dfile=  -DgroupId= -DartifactId= -Dversion= -Dpackaging=jar  上传jar包到本地仓库<br>mvn help:describe -Dplugin=插件名称   查看插件的目标<br>mvn help:describe -Dplugin=插件名称 -Dfull<br>mvn help:active-profiles  查看所有的激活的profiles   会按照从上到下的顺序覆盖，会取用最后一个profile的属性值<br>mvn help:all-profiles   查看所有的profiles</p>\n<p>profiles  可以写在pom.xml  也可以抽离出来，写在settings.xml<br>使用<activation>标签匹配激活<br><activation><br>    <activeByDefault>false&lt;/&gt;  是否默认激活<br>    <jdk>1.8&lt;/&gt;  jdk版本1.8<br>    <os>  操作系统</os></jdk></activeByDefault></activation></activation></p>\n<pre><code>&lt;/os&gt;\n&lt;file&gt;\n&lt;/file&gt;\n&lt;property&gt; 匹配某个属性值\n    &lt;name&gt;&lt;/&gt;\n    &lt;value&gt;&lt;/&gt;\n&lt;/property&gt;</code></pre>\n\n\n\n<p>在settings.xml中激活profile,不能激活pom.xml中的profile<br><settings><br>    <activeProfiles><br>        <activeProfile>profile-id</activeProfile><br>    </activeProfiles><br></settings></p>\n<p>在maven中profiles只有repositories/pluginRepositories/properties可以再settings.xml中定义，其他属性必须在pom.xml中使用</p>\n<p>maven的六类属性<br>    一、内置属性<br>        ${basedir}表示根目录(含有pom.xml的文件目录)  ${version} 项目版本<br>    二、POM属性<br>        ${project.build.sourceDirectory}:项目的主源码目录，默认为src/main/java<br>        ${project.build.testSourceDirectory}:项目的测试源码目录，默认为src/test/java<br>        ${project.build.directory}:项目构建输出目录，默认为target/<br>        ${project.outputDirectory}:项目主代码编译输出目录,默认为target/classes/<br>        ${project.testOutputDirectory}:项目测试代码编译输出目录,默认为target/test-classes/<br>        ${project.groupId}:项目的groupid<br>        ${project.artifactId}:项目的artifactid<br>        ${project.version}:项目的version,等价于${version}<br>        ${project.build.fianlName} 项目打包的名称,默认为${project.artifactId}-${project.version}<br>    三、自定义属性<br>        可以在POM的<properties>中自定义属性<br>    四、Settings属性<br>        用户使用settings.开头的属性引用settings.xml文件中XML元素的值<br>    五、Java系统属性<br>        所有java系统属性都可以使用Maven属性引用<br>    六、环境变量属性<br>        所有环境变量都可以使用env.开头的maven属性引用</properties></p>\n<p>maven的属性过滤<br>在build中添加resources进行属性文件过滤，替换属性值<br>resources中定义那些目录下的文件会被配置文件中定义的变量替换<br>表示src/main/resources下的所有properties文件中的变量都会替换<br><resources><br>    <resource><br>        <targetPath></targetPath>编译之后文件移动到的位置<br>        <directory><br>            src/main/resources<br>        </directory><br>        <filtering>true</filtering>   如果filtering是false表示不会进行替换<br>        <includes><br>            <include>*<em>/</em>.properties</include><br>        </includes><br>    </resource><br><resources></resources></resources></p>\n<p>maven配置web资源过滤<br><plugin><br>    <groupId>org.apache.maven.plugins</groupId><br>    <artifactId>maven-war-plugin</artifactId><br>    <version>2.6</version></plugin></p>\n<pre><code>&lt;configuration&gt;\n    &lt;webResources&gt;\n        &lt;resource&gt;\n            &lt;filtering&gt;true&lt;/filtering&gt;\n            &lt;directory&gt;$&#123;project.basedir&#125;/src/main/WebContent/WEB-INF\n            &lt;/directory&gt;\n            &lt;includes&gt;\n                &lt;include&gt;**/*.xml&lt;/include&gt;\n                &lt;include&gt;**/*.properties&lt;/include&gt;\n            &lt;/includes&gt;\n            &lt;targetPath&gt;WEB-INF&lt;/targetPath&gt;\n        &lt;/resource&gt;\n        &lt;resource&gt;\n            &lt;filtering&gt;true&lt;/filtering&gt;\n            &lt;directory&gt;$&#123;project.basedir&#125;/src/main/WebContent/WEB-INF/jsp\n            &lt;/directory&gt;\n            &lt;targetPath&gt;WEB-INF/jsp&lt;/targetPath&gt;\n        &lt;/resource&gt;\n\n        &lt;resource&gt;\n            &lt;filtering&gt;true&lt;/filtering&gt;\n            &lt;directory&gt;$&#123;project.basedir&#125;/src/main/WebContent/WEB-INF/css\n            &lt;/directory&gt;\n            &lt;targetPath&gt;WEB-INF/css&lt;/targetPath&gt;\n        &lt;/resource&gt;\n\n\n        &lt;resource&gt;\n            &lt;filtering&gt;true&lt;/filtering&gt;\n            &lt;directory&gt;$&#123;project.basedir&#125;/src/main/WebContent/WEB-INF/js\n            &lt;/directory&gt;\n            &lt;targetPath&gt;WEB-INF/js&lt;/targetPath&gt;\n        &lt;/resource&gt;\n        &lt;resource&gt;\n            &lt;filtering&gt;true&lt;/filtering&gt;\n            &lt;directory&gt;$&#123;project.basedir&#125;/src/main/WebContent/WEB-INF/images\n            &lt;/directory&gt;\n            &lt;targetPath&gt;WEB-INF/images&lt;/targetPath&gt;\n        &lt;/resource&gt;\n        &lt;resource&gt;\n            &lt;filtering&gt;true&lt;/filtering&gt;\n            &lt;directory&gt;$&#123;project.basedir&#125;/src/main/WebContent/WEB-INF\n            &lt;/directory&gt;\n            &lt;includes&gt;\n                &lt;include&gt;**/*.xml&lt;/include&gt;\n                &lt;include&gt;**/*.properties&lt;/include&gt;\n            &lt;/includes&gt;\n            &lt;targetPath&gt;WEB-INF&lt;/targetPath&gt;\n        &lt;/resource&gt;\n    &lt;/webResources&gt;\n&lt;/configuration&gt;</code></pre>\n\n\n\n\n\n\n<p>Nexus仓库管理器<br>默认admin/admin123</p>\n<p>可以搭建私服</p>\n<p>仓库分类</p>\n<p>download remote indexes 改为true</p>\n<p>group组仓库  仓库的合集  按照配置的顺序找jar包<br>    - proxy代理仓库1 ——url1   type为proxy<br>    - proxy代理仓库2 ——url2<br>    - hosted宿主仓库       mvn deploy会提交到hosted仓库中<br>        - snapshot部署仓库<br>        - release部署仓库<br>        - 第三方jar包仓库  third party/3rd party</p>\n<p>Virtual虚拟仓库，用于适配其他类型的仓库，比如maven要兼容maven1、maven2等<br>想要使用私服时，需要在pom文件中配置<br><repositroies><br>    <repository><br>        <id></id><br>        <name></name><br>        <url></url><br>        <releases><br>            <enabled>true</enabled><br>        </releases><br>        <!-- snapshots默认关闭的，需要手动开启 --><br>        <snapshots><br>            <enabled>true</enabled><br>        </snapshots><br>    </repository><br><br>或者在settings中配置<br><profile><br>    <id></id><br>    <repositroies><br>        <repository><br>            <id></id><br>            <name></name><br>            <url></url><br>            <releases><br>                <enabled>true</enabled><br>            </releases><br>            <!-- snapshots默认关闭的，需要手动开启 --><br>            <snapshots><br>                <enabled>true</enabled><br>            </snapshots><br>        </repository><br>    <br></repositroies></profile></repositroies></p>\n<p>或者设置镜像</p>\n<p>在settings.xml进行配置私服<br><mirriors><br>    <mirror><br>        <id>nexus</id>  对应激活的profile<br>        <mirrorOf>*</mirrorOf><br>        <name></name><br>        <url></url>  这个对应的是group组仓库的地址<br>    </mirror><br></mirriors></p>\n<p>在pom文件中配置<br>发布工程时会用到，会发布到仓库<br><distributionManagement><br>    <repository><br>        <id>releases</id>  要对应在nexus中的id<br>        <name>&lt;/&gt;<br>        <url>&lt;/&gt;<br>    </url></name></repository><br>    <repository><br>        <id>snapshots</id>  要对应在nexus中的id<br>        <name>&lt;/&gt;<br>        <url>&lt;/&gt;<br>    </url></name></repository><br></distributionManagement></p>\n<p>在发布时会使用到用户名，密码<br>此时应该在settings.xml中配置server<br><servers><br>    <server><br>        <id>releases</id><br>        <username>admin</username><br>        <password>admin123<password><br>    </password></password></server><br></servers></p>\n<p>权限管理<br>先设置权限 privileges<br>再设置角色 roles<br>再设置用户 users</p>\n<p>项目发布  Assembly插件<br>1、Assembly:一定要单独运行，不要绑定生命周期<br>2、Single mojo 这个和某个生命周期相关联</p>\n<p>Assembly常用的套件描述符<br>1、bin - 将jar包打zip包<br>2、jar-with-denpendencies - 带有依赖的jar包<br>3、project - 将工程源代码打包<br>4、src - 将工程src目录下的源代码打包</p>\n<p>默认在超级pom中带有插件的<br><plugin><br>  <artifactId>maven-assembly-plugin</artifactId><br>  <version>2.2-beta-5</version><br></plugin><br>可以使用打包<br>mvn assembly:single -DdescriptorId=描述符</p>\n<p>可以在pom文件中直接配置自定义该插件</p>\n<plugin>\n    <groupId>org.apache.maven.plugins</groupId>\n    <artifactId>maven-assembly-plugin</artifactId>\n    <version>2.6</version>\n    <executions>\n        <execution>\n\n<pre><code>        &lt;id&gt;create-jar&lt;/id&gt;\n        &lt;phase&gt;package&lt;/phase&gt;\n        &lt;goals&gt;\n            &lt;goal&gt;single&lt;/goal&gt;\n        &lt;/goals&gt;\n        &lt;configuration&gt;\n            &lt;descriptorRefs&gt;\n                &lt;descriptorRef&gt;\n                    jar-with-dependencies\n                &lt;/descriptorRef&gt;\n            &lt;/descriptorRefs&gt;\n            &lt;archive&gt;\n                &lt;manifest&gt;\n                    &lt;mainClass&gt;GetSiteMapUrl&lt;/mainClass&gt;\n                &lt;/manifest&gt;\n            &lt;/archive&gt;\n        &lt;/configuration&gt;\n    &lt;/execution&gt;\n&lt;/executions&gt;</code></pre>\n</execution></executions></plugin>"},{"title":"maven-构建项目","url":"/2020/maven/maven%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE/","content":"<p>使用maven命令构建一个maven项目</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">mvn archetype:generate -DgroupId=com.zhanghe -DartifactId=test -DarchetypeArtifactId=maven-archetype-quickstart -Dversion=<span class=\"number\">1</span>.<span class=\"number\">0</span>-SNAPSHOT</span><br></pre></td></tr></table></figure>\n\n<p>DarchetypeArtifactId:  表示项目骨架，常用的有两种</p>\n<ul>\n<li><strong>maven-archetype-quickstart</strong>  普通的java项目</li>\n<li><strong>maven-archetype-webapp</strong>  java web项目</li>\n</ul>\n","categories":["maven"],"tags":["maven"]},{"title":"IE浏览器F12无法使用","url":"/2020/windows/IE%E6%B5%8F%E8%A7%88%E5%99%A8F12%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8/","content":"<p>错误的文字内容：Diagnostic:Exception in windowonload: Error An error has occurrediSPlugin.3005StackTrace:Error An error has occurredJSPlugin.3005 at getString<a id=\"more\"></a> (res//C:\\Program Files\\Internet Explorer\\F12Resources.dll/23/pluginhost/plugin.f12.js:5021:17) at ToolWindowHelpers.LoadString (res:f/C:\\Program Files\\Internet Explorer\\F12Resources.dll/23/Common/CommonMergedjs:5803:13) at TabPanes (res://C:\\Program Files\\Internet Explorer\\F12Resources.dll/23/dom/DomExplorerMerged.js:16247:17) at DomExplorerWindow (res://C:\\Program Files\\Internet ExpIorer\\F12Resources.dll/23/dom/DomExpIorerMerged.js:1837:17) at Anonymous function (res://C:\\Program Files\\Internet Explorer F12Resources.dll/23/dom/DomExplorerMerged.js:18306:25) at EventManager.prototype.dispatchEvent (res://C:\\Program Files\\Internet Explorer\\F12Resources.dll/23/pluginhost/plugin.f12.js:3945:29) at checkAndFirePluginReady (resWC:\\Program FilesVntemet Explorer\\F12Resources.dll/23/pluginhostlplugin.f12.js:4406:17) at Anonymous function (res://C:\\Program Files\\Internet Explorer\\F12 Resources.dll/23/pluginhost/plugin.f12.js:4412:13)<br>2</p>\n<p>解决方案</p>\n<p>下载以下补丁即可解决</p>\n<p>32位系统下载补丁：<a href=\"http://www.microsoft.com/zh-CN/download/details.aspx?id=45134\">http://www.microsoft.com/zh-CN/download/details.aspx?id=45134</a></p>\n<p>64位系统下载下面这个补丁：<a href=\"http://www.microsoft.com/en-us/download/details.aspx?id=45154\">http://www.microsoft.com/en-us/download/details.aspx?id=45154</a></p>\n","categories":["IE浏览器"],"tags":["技巧","浏览器"]},{"title":"win10开机自启动","url":"/2020/windows/windows%E4%B9%8B%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF%E5%8A%A8/","content":"<p>最近由于项目启动依赖于consul，写完代码之后想启动服务，还要去启动consul，有的时候会忘记所以将consul启动设置为了开机自启   <a id=\"more\"></a><br>        首先将consul的可执行文件放到C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp文件夹下<br>        然后编写启动脚本</p>\n<figure class=\"highlight bat\"><table><tr><td class=\"code\"><pre><span class=\"line\">@<span class=\"built_in\">echo</span> off</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /d %~d0</span><br><span class=\"line\"><span class=\"built_in\">echo</span> %~d0</span><br><span class=\"line\"><span class=\"built_in\">cd</span> %~dp0 </span><br><span class=\"line\"><span class=\"built_in\">echo</span> %~dp0</span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"keyword\">exist</span> consul.exe <span class=\"keyword\">goto</span> <span class=\"number\">11</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"keyword\">exist</span> consul.exe.bak (</span><br><span class=\"line\">    <span class=\"built_in\">ren</span> consul.exe.bak consul.exe</span><br><span class=\"line\">) </span><br><span class=\"line\">:<span class=\"number\">11</span> </span><br><span class=\"line\">.\\consul.exe agent -dev</span><br><span class=\"line\"><span class=\"built_in\">pause</span></span><br><span class=\"line\"><span class=\"keyword\">exit</span></span><br></pre></td></tr></table></figure>\n<p>写好之后同样放在该目录下  之后开机之后就会自动启动consul了，再也不用担心注册中心没起导致项目启动不起来了。</p>\n","categories":["windows"],"tags":["小技巧","windows"]},{"title":"windows端口占用","url":"/2020/windows/windows%E4%B9%8B%E7%AB%AF%E5%8F%A3%E5%8D%A0%E7%94%A8/","content":"<p>1.查看当前端口被哪个进程占用了（进入到CMD中）</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">netstat -ano|<span class=\"built_in\">findstr</span> &quot;<span class=\"number\">8990</span>&quot;</span><br></pre></td></tr></table></figure>\n<p>输出结果为：<br>TCP    127.0.0.1:8990         0.0.0.0:0              LISTENING       2700<br>我们发现8990端口被2700进程占用了<br>        2.基于进程号找进程名称</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">tasklist|<span class=\"built_in\">findstr</span> &quot;<span class=\"number\">2700</span>&quot;</span><br></pre></td></tr></table></figure>\n<p>输出结果为：<br>kxescore.exe                  2700 Services                   0     29,284 K</p>\n<p>可以去任务管理器停止kxescore.exe应用</p>\n","categories":["windows"],"tags":["技巧","windows"]},{"url":"/2021/markdown/markdown%E7%94%BB%E6%B5%81%E7%A8%8B%E5%9B%BE/","content":"<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">startID&#x3D;&gt;start: 开始</span><br><span class=\"line\">startID-&gt;</span><br></pre></td></tr></table></figure>\n\n"},{"url":"/2021/markdown/markdown%E7%94%BB%E7%BB%93%E6%9E%84%E5%9B%BE/","content":"<pre class=\"mermaid\">graph TD\n0((0)) --- 1((1)) --- 3((3))\n1((1)) --- 4((4))\n0((0)) --- 2((2))</pre>\n\n\n\n"},{"title":"xml中的转义字符","url":"/2020/xml/xml%E4%B8%AD%E7%9A%84%E8%BD%AC%E4%B9%89%E5%AD%97%E7%AC%A6/","content":"<h2 id=\"xml中的转义字符\"><a href=\"#xml中的转义字符\" class=\"headerlink\" title=\"xml中的转义字符\"></a>xml中的转义字符</h2><figure class=\"highlight 1c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&amp;amp;对应的字符是&amp;</span></span><br><span class=\"line\"><span class=\"meta\">&amp;lt;对应的字符是&lt;</span></span><br><span class=\"line\"><span class=\"meta\">&amp;gt;对应的字符是&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&amp;quot;对应的字符是&quot;</span></span><br><span class=\"line\"><span class=\"meta\">&amp;apos;对应的字符是&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>xml中还提供了CDATA标记来标识文件数据，当XML解析器处理到CDATA标记时，它不会解析该段数据中的任何符号或标记，只是将原数据原封不动地传递给应用程序。</p>\n<p>使用方式为</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">book</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>&lt;![CDATA[&lt;&gt;&#x27;&#x27;&quot;&quot;输入什么显示什么&amp;]]&gt;<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">book</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["xml"],"tags":["xml"]},{"title":"xml名称空间","url":"/2020/xml/xml%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4/","content":"<h2 id=\"xml名称空间\"><a href=\"#xml名称空间\" class=\"headerlink\" title=\"xml名称空间\"></a>xml名称空间</h2><p>一个xml文档中可以包含多个元素和属性，在文档中使用多个DTD文件时，可能会碰到相同的元素，而这些名称相同的元素可能代表了完全不同的含义，为了防止命名冲突，W3C提供了一个推荐标准-XML名称空间</p>\n<p>名称空间有两种声明形式</p>\n<h4 id=\"第一种形式\"><a href=\"#第一种形式\" class=\"headerlink\" title=\"第一种形式\"></a>第一种形式</h4><p>&lt;元素名 xmls:prefixname=”URI”&gt;</p>\n<a id=\"more\"></a>\n\n<p>元素名是指在哪个元素上声明名称空间，prefixname表示名称空间前缀的名字</p>\n<p>例：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:context</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:mvc</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:tx</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/tx&quot;</span> <span class=\"attr\">xmlns:aop</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">   http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">   http://www.springframework.org/schema/context</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">   http://www.springframework.org/schema/context/spring-context-3.0.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">   http://www.springframework.org/schema/mvc</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">   http://www.springframework.org/schema/mvc/spring-mvc-3.2.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">   http://www.springframework.org/schema/tx</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">   http://www.springframework.org/schema/tx/spring-tx-3.2.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">   http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"第二种形式\"><a href=\"#第二种形式\" class=\"headerlink\" title=\"第二种形式\"></a>第二种形式</h4><p>&lt;元素名 xmlns=”URI”&gt;</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 在该ml中表示所有没有前缀的元素都属于http://www.springframework.org/schema/beans所标识的名称空间 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["xml"],"tags":["xml"]},{"title":"验证xml格式","url":"/2020/xml/xml%E7%9A%84%E6%A0%BC%E5%BC%8F/","content":"<h2 id=\"验证xml格式\"><a href=\"#验证xml格式\" class=\"headerlink\" title=\"验证xml格式\"></a>验证xml格式</h2><h3 id=\"DTD验证\"><a href=\"#DTD验证\" class=\"headerlink\" title=\"DTD验证\"></a>DTD验证</h3><p>可以使用DTD来定义XML文档的合法构建模块。DTD可以写在文档内部，也可以另外写一个文件</p>\n<h4 id=\"文档内部\"><a href=\"#文档内部\" class=\"headerlink\" title=\"文档内部\"></a>文档内部</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">note</span> [</span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">note</span> (<span class=\"meta-keyword\">to</span>,<span class=\"meta-keyword\">from</span>,<span class=\"meta-keyword\">body</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">to</span> (<span class=\"meta-keyword\">#PCDATA</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">from</span> (<span class=\"meta-keyword\">#PCDATA</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">body</span> (<span class=\"meta-keyword\">#PCDATA</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">]&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">note</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">to</span>&gt;</span>ll<span class=\"tag\">&lt;/<span class=\"name\">to</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">from</span>&gt;</span>zh<span class=\"tag\">&lt;/<span class=\"name\">from</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span>hello<span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">note</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>DTD包含在以上格式的声明中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE 根元素 [元素声明]&gt;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"外部文档\"><a href=\"#外部文档\" class=\"headerlink\" title=\"外部文档\"></a>外部文档</h4><p>如果DTD位于XML源文件外部，应该封装在一个DTD文档中，并在XML中声明</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE  根元素 SYSTEM &quot;文件名&quot;&gt;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"DTD结构\"><a href=\"#DTD结构\" class=\"headerlink\" title=\"DTD结构\"></a>DTD结构</h4><p>元素声明的语法格式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;!ELEMENT 元素名称 元素内容说明&gt;</span><br></pre></td></tr></table></figure>\n\n<p>元素内容说明的格式</p>\n<h5 id=\"PCDATA\"><a href=\"#PCDATA\" class=\"headerlink\" title=\"#PCDATA\"></a>#PCDATA</h5><p>关键字#PCDATA说明元素包含字符数据，内容只能是字符数据</p>\n<p>例：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">name</span> [</span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">name</span> (<span class=\"meta-keyword\">#PCDATA</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">]&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>张三<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"子元素\"><a href=\"#子元素\" class=\"headerlink\" title=\"子元素\"></a>子元素</h5><p>说明元素包含的是子元素。当一个元素只包含子元素时而没有字符数据时，表示此元素类型具有元素型类型。在该类型的元素声明时，通过内容模型来指定在其内容上的约束(内容模型是决定子元素类型和子元素出现顺序的一种简单语法)</p>\n<p>例：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">note</span> [</span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">note</span> (<span class=\"meta-keyword\">to</span>,<span class=\"meta-keyword\">from</span>,<span class=\"meta-keyword\">body</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">to</span> (<span class=\"meta-keyword\">#PCDATA</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">from</span> (<span class=\"meta-keyword\">#PCDATA</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">body</span> (<span class=\"meta-keyword\">#PCDATA</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">]&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">note</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">to</span>&gt;</span>ll<span class=\"tag\">&lt;/<span class=\"name\">to</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">from</span>&gt;</span>zh<span class=\"tag\">&lt;/<span class=\"name\">from</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span>hello<span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">note</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>复杂一些的内容模型为</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;!-- </span><br><span class=\"line\">竖线| 表示这些至少存在一个</span><br><span class=\"line\">? 表示可以有一个也可以没有</span><br><span class=\"line\">* 表示零个或者多个</span><br><span class=\"line\">+ 表示一个或者多个，至少有一个</span><br><span class=\"line\">--&gt;</span><br><span class=\"line\">&lt;!-- 该内容模型表示 简历中要有名字，性别，年龄，电话和手机任选一个,填写一个家庭住址或者不填，零个或者多个兴趣爱好，至少一个教育经历，工作经验可有可无 --&gt;</span><br><span class=\"line\">&lt;!ELEMENT 简历 (名字，性别，年龄，(电话 | 手机), 家庭住址?, 兴趣爱好*, 教育经历+, 工作经验*)&gt;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"混合内容\"><a href=\"#混合内容\" class=\"headerlink\" title=\"混合内容\"></a>混合内容</h5><p>既可以包含子元素，也可以包含字符数据(使用混合内容模型时，#PCDATA关键字必须是模型中的第一个选项，不能再模型中使用逗号、问号或加号。只能用竖线来分隔#PCDATA和元素)</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">email</span> [</span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">email</span> (<span class=\"meta-keyword\">#PCDATA</span> | <span class=\"meta-keyword\">body</span>)*&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">    <span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">body</span> (<span class=\"meta-keyword\">#PCDATA</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">]&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">email</span>&gt;</span></span><br><span class=\"line\">    邮件</span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span>hello<span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">email</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"EMPTY\"><a href=\"#EMPTY\" class=\"headerlink\" title=\"EMPTY\"></a>EMPTY</h5><p>关键字EMPTY表明该元素既不包含字符数据，也不包含子元素，是一个空元素</p>\n<p>例：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!ELEMENT <span class=\"meta-keyword\">br</span> <span class=\"meta-keyword\">EMPTY</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"ANY\"><a href=\"#ANY\" class=\"headerlink\" title=\"ANY\"></a>ANY</h5><p>关键字ANY表明该元素可以包含任何字符数据和子元素</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;!ELEMENT note ANY&gt;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"XML-Schema-Definition\"><a href=\"#XML-Schema-Definition\" class=\"headerlink\" title=\"XML Schema Definition\"></a>XML Schema Definition</h3><p>在DTD之后，W3C推出了新的规范来验证xml格式：XML Schema Definition</p>\n<h4 id=\"Schema语法格式\"><a href=\"#Schema语法格式\" class=\"headerlink\" title=\"Schema语法格式\"></a>Schema语法格式</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xs:schema</span>            <span class=\"attr\">xmlns:xs</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class=\"attr\">targetNamespace</span>=<span class=\"string\">&quot;http:///j2j.idril.cn&quot;</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://j2j.idril.cn&quot;</span> <span class=\"attr\">elementFormDefault</span>=<span class=\"string\">&quot;qualified&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xs:element</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;note&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">xs:complexType</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">xs:sequence</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">xs:element</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;to&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;xs:string&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">xs:element</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;from&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;xs:string&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">xs:element</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;body&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;xs:string&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">xs:sequence</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">xs:complexType</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">xs:element</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xs:schema</span>   </span></span><br><span class=\"line\"><span class=\"tag\">// 指定了<span class=\"attr\">schema</span>中用到的元素和数据类型来自的命名空间  还规定了来自此命名空间的元素和数据类型应该使用前缀<span class=\"attr\">xs:</span>           <span class=\"attr\">xmlns:xs</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> </span></span><br><span class=\"line\"><span class=\"tag\">// 说明此<span class=\"attr\">schema</span>定义的元素来自的命名空间           </span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">targetNamespace</span>=<span class=\"string\">&quot;http:///j2j.idril.cn&quot;</span> </span></span><br><span class=\"line\"><span class=\"tag\">// 指定了默认的命名空间           </span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://j2j.idril.cn&quot;</span> </span></span><br><span class=\"line\"><span class=\"tag\">// 指出任何<span class=\"attr\">XML</span>实例文档所使用的且在此<span class=\"attr\">schema</span>中声明过的元素必须被命名空间限定           </span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">elementFormDefault</span>=<span class=\"string\">&quot;qualified&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\">// 简易元素(仅包含文本的元素，不会包含子元素或属性)</span><br><span class=\"line\">// 常用的type有xs:strig、xs:decimal、xs:integer、xs:Boolean、xs:date、xs:time</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xs:element</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;to&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;xs:string&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\">// 属性 </span><br><span class=\"line\">// 常用的type有xs:strig、xs:decimal、xs:integer、xs:Boolean、xs:date、xs:time</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xs:attribute</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;lang&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;xs:string&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\">// 限定   用于XML元素或者属性定义可接受的值</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xs:restriction</span> <span class=\"attr\">base</span>=<span class=\"string\">&quot;xs:integer&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">xs:minInclusive</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;0&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">xs:maxInclusive</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;120&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">xs:restriction</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\">// 复合元素</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">xs:element</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;note&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">xs:complexType</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">xs:sequence</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">xs:element</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;to&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;xs:string&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">xs:element</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;from&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;xs:string&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">xs:element</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;body&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;xs:string&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">xs:sequence</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">xs:complexType</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">xs:element</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>&lt;xs:element name=”to” type=”xs:string”/&gt;</p>\n<h4 id=\"Schema的使用\"><a href=\"#Schema的使用\" class=\"headerlink\" title=\"Schema的使用\"></a>Schema的使用</h4><p>同样的，在xml中需要声明Schema</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">note</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://j2j.idril.cn&quot;</span> <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://j2j.idril.cn node.xsd&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">to</span>&gt;</span>ll<span class=\"tag\">&lt;/<span class=\"name\">to</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">from</span>&gt;</span>zh<span class=\"tag\">&lt;/<span class=\"name\">from</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span>hello<span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">note</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\">// 规定了默认的命名空间的声明</span><br><span class=\"line\">xmlns=&quot;http://j2j.idril.cn&quot;</span><br><span class=\"line\">// 定义了XML Schema实例命名空间</span><br><span class=\"line\">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; </span><br><span class=\"line\">// 包含两个值   第一个值是需要使用的命名空间  第二个值是供命名空间使用的XML Schema的位置</span><br><span class=\"line\">xsi:schemaLocation=&quot;http://j2j.idril.cn node.xsd&quot;</span><br></pre></td></tr></table></figure>\n\n","categories":["xml"],"tags":["xml"]},{"title":"加密算法简介","url":"/2020/%E5%8A%A0%E5%AF%86/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E7%AE%80%E4%BB%8B/","content":"<h2 id=\"加密算法简介\"><a href=\"#加密算法简介\" class=\"headerlink\" title=\"加密算法简介\"></a>加密算法简介</h2><h3 id=\"AES\"><a href=\"#AES\" class=\"headerlink\" title=\"AES\"></a>AES</h3><p>对称秘钥加密</p>\n<a id=\"more\"></a>\n\n<h4 id=\"DES\"><a href=\"#DES\" class=\"headerlink\" title=\"DES\"></a>DES</h4><p>对称加密算法</p>\n<h4 id=\"RSA\"><a href=\"#RSA\" class=\"headerlink\" title=\"RSA\"></a>RSA</h4><p>非对称算法</p>\n<h4 id=\"DSA\"><a href=\"#DSA\" class=\"headerlink\" title=\"DSA\"></a>DSA</h4>","categories":["加密算法"],"tags":["加密算法"]},{"title":"Callable接口","url":"/2021/%E5%A4%9A%E7%BA%BF%E7%A8%8B/Callable%E6%8E%A5%E5%8F%A3/","content":"<h2 id=\"Callable接口\"><a href=\"#Callable接口\" class=\"headerlink\" title=\"Callable接口\"></a>Callable接口</h2><p>在创建线程的时候不管是继承Thread类(Thread本身也是实现的Runnable接口)还是实现Runnable接口，所实现的run()方法都没有返回值，使得需要将返回值写到map中，等到线程结束再去从map中取数据，特别的不方便</p>\n<p>而且Runnable还有另一个问题是不能抛出任何异常，必须在run()方法中自己处理异常。</p>\n<p>由于Runnable存在的两个问题，所以Callable接口和Future接口应运而生，这里来介绍一下Callable接口和Future接口</p>\n<a id=\"more\"></a>\n\n<p>Callable与Runnable不同，提供的方法为call()方法，大家看到，该方法是有返回值的，且可以抛出异常</p>\n<p>获取Callable的返回值需要FutureTask的支持</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Callable</span>&lt;<span class=\"title\">V</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * Computes a result, or throws an exception if unable to do so.</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span> computed result</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception if unable to compute a result</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\">V <span class=\"title\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>使用ExecutorService来执行Callable对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">&lt;T&gt; <span class=\"function\">Future&lt;T&gt; <span class=\"title\">submit</span><span class=\"params\">(Callable&lt;T&gt; task)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<p>看到该方法返回的是一个Future对象，Future对象是什么呢？</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Future</span>&lt;<span class=\"title\">V</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 在任务正常结束之前可以尝试取消任务</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">cancel</span><span class=\"params\">(<span class=\"keyword\">boolean</span> mayInterruptIfRunning)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 如果任务正常结束之前被取消，isCancelled会返回true</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isCancelled</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 检测任务是否结束</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isDone</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// get方法会将结果返回给调用方</span></span><br><span class=\"line\">    <span class=\"function\">V <span class=\"title\">get</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException, ExecutionException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// get方法会将结果返回给调用方，可以限制限制超时时间</span></span><br><span class=\"line\">    <span class=\"function\">V <span class=\"title\">get</span><span class=\"params\">(<span class=\"keyword\">long</span> timeout, TimeUnit unit)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> InterruptedException, ExecutionException, TimeoutException</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"FutureTask\"><a href=\"#FutureTask\" class=\"headerlink\" title=\"FutureTask\"></a>FutureTask</h3><p>FutureTask类同时实现了Runnable接口和Future接口，同时拥有异步能力以及取消任务的能力，可以创建出可取消的任务</p>\n<p>示例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestCallable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        CallDemo call = <span class=\"keyword\">new</span> CallDemo();</span><br><span class=\"line\">        FutureTask&lt;Integer&gt; futureTask = <span class=\"keyword\">new</span> FutureTask&lt;&gt;(call);</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Thread(futureTask).start();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// get方法是一个阻塞方法  在没有执行结束之前一直阻塞，直到执行完毕</span></span><br><span class=\"line\">            <span class=\"keyword\">int</span> sum = futureTask.get();</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;---------&quot;</span>);</span><br><span class=\"line\">            System.out.println(sum);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Callable相较于Runnable有返回值和异常</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CallDemo</span> <span class=\"keyword\">implements</span> <span class=\"title\">Callable</span>&lt;<span class=\"title\">Integer</span>&gt;</span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Integer <span class=\"title\">call</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> sum = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i&lt;<span class=\"number\">1000</span>;i++)&#123;</span><br><span class=\"line\">            sum +=i;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> sum;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":["多线程"],"tags":["多线程"]},{"title":"ConcurrentLinkedQueue","url":"/2021/%E5%A4%9A%E7%BA%BF%E7%A8%8B/ConcurrentLinkedQueue/","content":"<h2 id=\"ConcurrentLinkedQueue\"><a href=\"#ConcurrentLinkedQueue\" class=\"headerlink\" title=\"ConcurrentLinkedQueue\"></a>ConcurrentLinkedQueue</h2><p>ConcurrentLinkedQueue是一种适用于高并发场景下的队列，通过无锁的方式，实现了高并发状态下的高性能，通常ConcurrentLinkedQueue性能好于BlockingQueue。是一种基于链表节点的无界线程安全队列。该队列的元素遵循先进先出的原则，该队列不允许为null</p>\n<a id=\"more\"></a>\n\n<p>重要方法</p>\n<p>add()和offer()都是加入元素的方法</p>\n<p>poll()和peek()都是取头元素节点，前者会删除元素，后者不会删除元素</p>\n","categories":["队列"],"tags":["队列"]},{"title":"CopyOnWrite容器","url":"/2021/%E5%A4%9A%E7%BA%BF%E7%A8%8B/CopyOnWrite%E5%AE%B9%E5%99%A8/","content":"<h2 id=\"CopyOnWrite容器\"><a href=\"#CopyOnWrite容器\" class=\"headerlink\" title=\"CopyOnWrite容器\"></a>CopyOnWrite容器</h2><p>什么是CopyOnWrite容器呢？CopyOnWrite容器是一个写时复制的容器。就是在向容器中添加元素时，不会直接向当前容器中添加，而是将当前容器进行copy，复制出一个新的容器，然后往新的容器中添加元素，添加完元素之后，再将容器的引用指向新的容器。使得我么可以对CopyOnWrite容器进行并发的读而不需要加锁，采用了读写分离的思想。</p>\n<p>使用的场景是读多写少的时候使用</p>\n<a id=\"more\"></a>","categories":["并发容器"],"tags":["并发容器"]},{"title":"CyclicyBarrier和CountDownLatch","url":"/2020/%E5%A4%9A%E7%BA%BF%E7%A8%8B/CyclicBarrier%E5%92%8CCountDownLatch/","content":"<h2 id=\"CyclicyBarrier和CountDownLatch\"><a href=\"#CyclicyBarrier和CountDownLatch\" class=\"headerlink\" title=\"CyclicyBarrier和CountDownLatch\"></a>CyclicyBarrier和CountDownLatch</h2><p>这两个类都在jdk的并发包中，都可以用来表示代码运行到某个点上</p>\n<a id=\"more\"></a>\n\n<p>两者的区别</p>\n<ul>\n<li>CyclicyBarrier表示达到一定数量的线程才会运行，CountDownLatch每来一个线程进行减一操作，直到0为止</li>\n<li>CyclicyBarrier只能唤起一个任务，CountDownLatch可以唤起多个任务</li>\n<li>CyclicyBarrier可重用，CountDownLatch不可重用，值为0后就不可再用了</li>\n</ul>\n","categories":["多线程"],"tags":["多线程"]},{"title":"Lock","url":"/2021/%E5%A4%9A%E7%BA%BF%E7%A8%8B/Lock/","content":"<h2 id=\"Lock\"><a href=\"#Lock\" class=\"headerlink\" title=\"Lock\"></a>Lock</h2><p>ReentrantLock  —&gt;  有公平锁和非公平锁</p>\n<p>非公平是指每个线程在进来时就尝试一次</p>\n<p>内部使用LockSupport的park和unpark方法来进行线程的通信</p>\n<p>state状态  0.未占用  1.已占用  大于1 重入  使用CAS来修改state状态</p>\n","categories":["多线程"],"tags":["多线程"]},{"title":"synchronized关键字","url":"/2020/%E5%A4%9A%E7%BA%BF%E7%A8%8B/synchronized/","content":"<h2 id=\"synchronized的作用\"><a href=\"#synchronized的作用\" class=\"headerlink\" title=\"synchronized的作用\"></a>synchronized的作用</h2><p>synchronized作为java的一个关键字，用来保证同一时刻最多只有一个线程执行synchronized修饰的方法/代码块，保证线程安全，解决多线程并发问题。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"synchronized原理\"><a href=\"#synchronized原理\" class=\"headerlink\" title=\"synchronized原理\"></a>synchronized原理</h2><ul>\n<li><p>依赖于JVM</p>\n</li>\n<li><p>底层通过一个监视器对象(monitor)完成，wait()、notify()等方法也依赖于monitor对象，monitor(监视器锁)本质依赖于底层操作系统的互斥锁(Mutex Lock)实现</p>\n</li>\n</ul>\n<blockquote>\n<p>早期的JDK中,synchronized是重量级的，需要去操作系统申请，完全依赖于操作系统内部的互斥锁，需要进行用户态到内核态的切换</p>\n<p>在JDK1.6进行了锁升级,分别为偏向锁、自旋锁(轻量级锁)、重量级锁</p>\n</blockquote>\n<h3 id=\"锁升级\"><a href=\"#锁升级\" class=\"headerlink\" title=\"锁升级\"></a>锁升级</h3><p>在synchronized中，锁存在四种状态，分别为无锁、偏向锁、轻量级锁、重量级锁</p>\n<h4 id=\"偏向锁\"><a href=\"#偏向锁\" class=\"headerlink\" title=\"偏向锁\"></a>偏向锁</h4><h5 id=\"偏向锁原理\"><a href=\"#偏向锁原理\" class=\"headerlink\" title=\"偏向锁原理\"></a>偏向锁原理</h5><p>对于同一个线程多次获得锁，使用偏向锁。一个线程在访问加了synchronized修饰的代码块时，会在对象头中存储当前线程的id，之后该线程进入和退出时，不需要再次加锁和释放锁，而是直接比较对象头里是否存储了指向当前线程的偏向锁</p>\n<h5 id=\"使用偏向锁逻辑\"><a href=\"#使用偏向锁逻辑\" class=\"headerlink\" title=\"使用偏向锁逻辑\"></a>使用偏向锁逻辑</h5><p><strong>获取偏向锁</strong></p>\n<ul>\n<li><p>首先获取锁对象的Markword，判断是否处于可偏向状态（biased_lock=1、且ThreadId为空）</p>\n</li>\n<li><p>如果是可偏向状态，则通过CAS操作，把当前线程的ID写入到Markword，如果成功，获得偏向锁，CAS失败，表示当前锁存在竞争，需要撤销已获得偏向锁的线程，升级为轻量级锁</p>\n</li>\n<li><p>如果是已偏向状态，检查markword中存储的ThreadId是否为当前线程ThreadId，如果不是，说明当前锁已经偏向于其他线程，需要撤销，并升级为轻量级锁</p>\n</li>\n</ul>\n<p><strong>撤销偏向锁</strong></p>\n<ul>\n<li><p>原获得偏向锁的线程如果已经退出了临界区，也就是同步代码块执行完了，这时会把对象头设置成无锁状态并且争抢锁的线程可以基于CAS重新偏向</p>\n</li>\n<li><p>如果原获得偏向锁的线程的同步代码块还没执行完，处于临界区之内，把原获得偏向锁的线程升级为轻量级锁，继续执行代码块</p>\n</li>\n</ul>\n<blockquote>\n<p>可以使用jvm参数   <strong>UseBiasedLocking</strong>来设置是否使用偏向锁</p>\n</blockquote>\n<h4 id=\"轻量级锁\"><a href=\"#轻量级锁\" class=\"headerlink\" title=\"轻量级锁\"></a>轻量级锁</h4><h5 id=\"轻量级锁加锁逻辑\"><a href=\"#轻量级锁加锁逻辑\" class=\"headerlink\" title=\"轻量级锁加锁逻辑\"></a>轻量级锁加锁逻辑</h5><ul>\n<li><p>线程在栈帧中创建锁记录LockRecord</p>\n</li>\n<li><p>将锁对象的对象头中markword复制到线程创建的锁记录中</p>\n</li>\n<li><p>将锁记录中Owner指针指向锁对象</p>\n</li>\n<li><p>将锁对象的对象头的markword替换为指向锁记录的指针</p>\n</li>\n</ul>\n<blockquote>\n<p>轻量级锁在加锁过程中，用到了自旋锁</p>\n<p>锁在自旋的时候会消耗cpu，一直在for循环，默认情况下是自旋10次，可以使用jvm参数<strong>preBlockSpin</strong>来修改</p>\n</blockquote>\n<h5 id=\"轻量级锁解锁\"><a href=\"#轻量级锁解锁\" class=\"headerlink\" title=\"轻量级锁解锁\"></a>轻量级锁解锁</h5><p>解锁是获得锁的逆向逻辑，通过CAS操作把线程栈帧中的LockRecord替换到对象的Markword中，如果成功表示没有竞争，如果失败，表示当前锁存在竞争，轻量级锁会成为重量级锁。</p>\n<h4 id=\"重量级锁\"><a href=\"#重量级锁\" class=\"headerlink\" title=\"重量级锁\"></a>重量级锁</h4><h5 id=\"重量级基本原路\"><a href=\"#重量级基本原路\" class=\"headerlink\" title=\"重量级基本原路\"></a>重量级基本原路</h5><p>使用monitorenter/monitorexit获取和释放monitor监视器，使得其它被阻塞的线程可以尝试去获得这个监视器monitor，依赖于操作系统的MutexLock(互斥锁)来实现的，线程被阻塞后进入内核(Linux)调度状态，会导致系统在用户态和内核态之间来回切换，验证影响锁的性能。</p>\n<h2 id=\"synchronized的使用\"><a href=\"#synchronized的使用\" class=\"headerlink\" title=\"synchronized的使用\"></a>synchronized的使用</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">锁当前对象  <span class=\"keyword\">synchronized</span>(<span class=\"keyword\">this</span>)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">等价于 锁整个方法</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">synchronized</span> <span class=\"title\">method</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">锁当前类 <span class=\"keyword\">synchronized</span>(T.class)&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">等价于  锁静态方法</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">synchronized</span> <span class=\"keyword\">static</span> <span class=\"title\">method</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["多线程"],"tags":["多线程"]},{"title":"volatile关键字","url":"/2020/%E5%A4%9A%E7%BA%BF%E7%A8%8B/volatile/","content":"<h2 id=\"volatile关键字\"><a href=\"#volatile关键字\" class=\"headerlink\" title=\"volatile关键字\"></a>volatile关键字</h2><p>先举一个例子，来看一下不使用volatile的时候</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestVolatile</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        ThreadDemo runnable = <span class=\"keyword\">new</span> ThreadDemo();</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Thread(runnable).start();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>)&#123;</span><br><span class=\"line\">            <span class=\"comment\">// 不会停止  一直在while循环</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(runnable.isFlag())&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;----------&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ThreadDemo</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> flag;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Thread.sleep(<span class=\"number\">2000</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        flag = <span class=\"keyword\">true</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(Thread.currentThread().getName()+<span class=\"string\">&quot;---flag:&quot;</span>+flag);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isFlag</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> flag;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setFlag</span><span class=\"params\">(<span class=\"keyword\">boolean</span> flag)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.flag = flag;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>结果</p>\n<figure class=\"highlight console\"><table><tr><td class=\"code\"><pre><span class=\"line\">Thread-0---flag:true</span><br></pre></td></tr></table></figure>\n\n<p>在这里主线程一直获取不到子线程中flag的状态修改为true了，一直在while循环中不出来，这是为什么呢</p>\n<p>为了提高性能，对于共享数据，在每个线程中都会缓存一份数据，</p>\n<p>对于上面的例子来说就是  main线程在线程内部缓存了一份flag=false   Thread-0线程也在线程内部缓存了一份flag=false，然后Thread-0线程将flag改为true之后同步到主存中，但是main线程的while循环使用的底层的循环机制，效率特别高，根本就没有从主存中重新去获取一下新的数据，线程内的缓存数据没有更新，导致一直在while循环中。</p>\n<p>而这种问题就是内存不可见导致的，可以使用synchronized来解决，</p>\n<blockquote>\n<p>synchronized在获取锁前后也要保证数据的一致性，获取锁 读内存屏障  释放锁  写内存屏障</p>\n<p>所以可以在while循环中加上synchronized关键字来解决</p>\n</blockquote>\n<p>但是加锁效率太低，所以一般情况下使用volatile关键字解决该问题，对于flag关键字加上volatile来修饰</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">boolean</span> flag;</span><br></pre></td></tr></table></figure>\n\n<p>所以volatile具有内存可见性的作用</p>\n<h3 id=\"volatile的作用\"><a href=\"#volatile的作用\" class=\"headerlink\" title=\"volatile的作用\"></a>volatile的作用</h3><ul>\n<li><p>内存可见性</p>\n</li>\n<li><p>禁止指令重排序(CPU的缓存一致性协议)</p>\n</li>\n</ul>\n<blockquote>\n<p>在单例懒汉式中双重检测时就使用了volatile禁止指令重排序</p>\n<p>在实例化对象时，JVM分为三步</p>\n<p>1、申请内存</p>\n<p>2、成员变量初始化</p>\n<p>3、赋值给对象</p>\n</blockquote>\n<h2 id=\"volatile的执行过程\"><a href=\"#volatile的执行过程\" class=\"headerlink\" title=\"volatile的执行过程\"></a>volatile的执行过程</h2><p>在写一个volatile变量时，JMM会把线程对应的本地内存中的共享变量值刷新到主内存。</p>\n<p>当读一个volatile变量时，JMM会把线程对应的本地内存置为无效，线程接下来将从主内存中读取共享变量</p>\n<h2 id=\"内存屏障\"><a href=\"#内存屏障\" class=\"headerlink\" title=\"内存屏障\"></a>内存屏障</h2><p>内存屏障(Memory Barrier)是一种CPU指令，用于控制特定条件下的重排序和内存可见性问题。java编译器也会根据内存屏障的规则禁止重排序</p>\n<p>分为几个类型</p>\n<ul>\n<li><p>LoadLoad屏障：对于Load1；LoadLoad；Load2，在Load2及后续读取操作要读取的数据被访问前，保证Load1要读取的数据被读取完毕</p>\n</li>\n<li><p>StoreStore屏障：对于Store1；StoreStore；Store2，在Store2及后续写入操作执行前，保证Store1的写入操作对其他处理器可见</p>\n</li>\n<li><p>LoadStore屏障：对于Load1；LoadStore；Store2，在Store2及后续写入操作被刷出前，保证Load1要读取的数据被读取完毕</p>\n</li>\n<li><p>StoreLoad屏障：对于Store1；StoreLoad；Load2，在Load2及后续所有读取操作执行前，保证Store1的写入对所有处理器可见。开销最大</p>\n</li>\n</ul>\n","categories":["多线程"],"tags":["多线程"]},{"title":"同步器","url":"/2021/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%90%8C%E6%AD%A5%E5%99%A8/","content":"<h2 id=\"同步器\"><a href=\"#同步器\" class=\"headerlink\" title=\"同步器\"></a>同步器</h2><p>除了使用wait()/nitify()来实现同步之外，在java.util.concurrent包中海油几种进行同步的方式，如信号量、屏障、闭锁和交换器。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"信号量\"><a href=\"#信号量\" class=\"headerlink\" title=\"信号量\"></a>信号量</h3><p>Semaphore类实现了信号量，提供了允许的最大数量，以及公平策略，默认是非公平的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Semaphore</span><span class=\"params\">(<span class=\"keyword\">int</span> permits)</span> </span>&#123;</span><br><span class=\"line\">    sync = <span class=\"keyword\">new</span> NonfairSync(permits);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Semaphore</span><span class=\"params\">(<span class=\"keyword\">int</span> permits, <span class=\"keyword\">boolean</span> fair)</span> </span>&#123;</span><br><span class=\"line\">  sync = fair ? <span class=\"keyword\">new</span> FairSync(permits) : <span class=\"keyword\">new</span> NonfairSync(permits);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以使用信号量来进行限流，使用acquire()来获得许可，获得到许可之后，信号量的允许数量就减少一个，当全部被占用之后，就会阻塞，使用release()方法来释放</p>\n<p>如果不想在获取的时候进行阻塞，可以使用tryAcquire()方法来尝试获取许可</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">tryAcquire</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> sync.nonfairTryAcquireShared(<span class=\"number\">1</span>) &gt;= <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">tryAcquire</span><span class=\"params\">(<span class=\"keyword\">long</span> timeout, TimeUnit unit)</span></span></span><br><span class=\"line\"><span class=\"function\">  <span class=\"keyword\">throws</span> InterruptedException </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> sync.tryAcquireSharedNanos(<span class=\"number\">1</span>, unit.toNanos(timeout));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"屏障\"><a href=\"#屏障\" class=\"headerlink\" title=\"屏障\"></a>屏障</h3><p>CyclicBarrier类提供了屏障的实现。屏障可以看做是一个篱栅，必须等待达到一定数量的人来推开这个篱栅</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 需要达到的数量</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CyclicBarrier</span><span class=\"params\">(<span class=\"keyword\">int</span> parties)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>(parties, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 达到该数量时，执行该Runnable</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CyclicBarrier</span><span class=\"params\">(<span class=\"keyword\">int</span> parties, Runnable barrierAction)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (parties &lt;= <span class=\"number\">0</span>) <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException();</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.parties = parties;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.count = parties;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.barrierCommand = barrierAction;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"闭锁\"><a href=\"#闭锁\" class=\"headerlink\" title=\"闭锁\"></a>闭锁</h3><p>CountDownLatch类</p>\n<p>在完成某些运算时，只有其他所有线程全部完成运算时，当前运算才会继续</p>\n<p>示例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestCountDownLatch</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 声明数量5</span></span><br><span class=\"line\">        CountDownLatch latch = <span class=\"keyword\">new</span> CountDownLatch(<span class=\"number\">5</span>);</span><br><span class=\"line\">        LatchDemo latchDemo = <span class=\"keyword\">new</span> LatchDemo(latch);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">long</span> start = System.currentTimeMillis();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i&lt;<span class=\"number\">5</span>;i++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">new</span> Thread(latchDemo).start();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 阻塞一直到减至0时</span></span><br><span class=\"line\">            latch.await();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;累计耗时&quot;</span>+(System.currentTimeMillis() - start));</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LatchDemo</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> CountDownLatch latch;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LatchDemo</span><span class=\"params\">(CountDownLatch latch)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.latch = latch;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i&lt;<span class=\"number\">10</span>;i++)&#123;</span><br><span class=\"line\">                System.out.println(i);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 减一表示完成</span></span><br><span class=\"line\">            latch.countDown();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"移相器\"><a href=\"#移相器\" class=\"headerlink\" title=\"移相器\"></a>移相器</h3><p>Phaser类</p>\n<h3 id=\"交换器\"><a href=\"#交换器\" class=\"headerlink\" title=\"交换器\"></a>交换器</h3><p>Exchanger类用于两个线程交换数据</p>\n","categories":["多线程"],"tags":["多线程"]},{"title":"同步锁","url":"/2021/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%90%8C%E6%AD%A5%E9%94%81/","content":"<h2 id=\"同步锁\"><a href=\"#同步锁\" class=\"headerlink\" title=\"同步锁\"></a>同步锁</h2><p>除了使用synchronized来对代码块和方法进行同步外，jdk1.5之后还有一种Lock同步锁的方式进行同步</p>\n<p>使用lock.lock()来进行加锁，使用lock.unlock()方法来释放锁</p>\n<p>既然可以使用lock来代替synchronized，那么如何进行处理synchronized与wait()、notify()、notifyAll()的线程通信机制呢</p>\n<p>在使用lock时使用Condition来进行线程通信</p>\n<a id=\"more\"></a>\n\n<p>下面来使用两种方式来分别展示一下线程间通信</p>\n<p>示例</p>\n<h4 id=\"使用Object的wait-、notify进行线程通信\"><a href=\"#使用Object的wait-、notify进行线程通信\" class=\"headerlink\" title=\"使用Object的wait()、notify进行线程通信\"></a>使用Object的wait()、notify进行线程通信</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * wait()/notify()/notifyAll()是Object的方法</span></span><br><span class=\"line\"><span class=\"comment\"> * 只能在synchronized方法或者代码块中使用，否则会报IllegalMonitorStateException异常</span></span><br><span class=\"line\"><span class=\"comment\"> * 交替打印1-100</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestThreadSignal</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        PrintRunnable runnable = <span class=\"keyword\">new</span> PrintRunnable();</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Thread(runnable,<span class=\"string\">&quot;线程一&quot;</span>).start();</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Thread(runnable,<span class=\"string\">&quot;线程二&quot;</span>).start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PrintRunnable</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> num = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">synchronized</span> (<span class=\"keyword\">this</span>)&#123;</span><br><span class=\"line\">                notify();<span class=\"comment\">// 唤醒wait的线程</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span>(num &lt;= <span class=\"number\">100</span>)&#123;</span><br><span class=\"line\">                    System.out.println(Thread.currentThread().getName() + <span class=\"string\">&quot;打印&quot;</span> + num++);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    wait(); <span class=\"comment\">// 释放当前的锁</span></span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"使用condition的await-、signal-进行线程通信\"><a href=\"#使用condition的await-、signal-进行线程通信\" class=\"headerlink\" title=\"使用condition的await()、signal()进行线程通信\"></a>使用condition的await()、signal()进行线程通信</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 使用lock和condition来进行线程通信</span></span><br><span class=\"line\"><span class=\"comment\"> * condition中的await()、signal()、signalAll()方法分别对应于Object中的wait()、notify()、notifyAll()方法</span></span><br><span class=\"line\"><span class=\"comment\"> * 两个线程交替打印1-100</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestThreadSignalForLock</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        PrintRunnableForLock runnable = <span class=\"keyword\">new</span> PrintRunnableForLock();</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Thread(runnable,<span class=\"string\">&quot;线程一&quot;</span>).start();</span><br><span class=\"line\">        <span class=\"keyword\">new</span> Thread(runnable,<span class=\"string\">&quot;线程二&quot;</span>).start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PrintRunnableForLock</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> num = <span class=\"number\">1</span>;</span><br><span class=\"line\">    Lock lock = <span class=\"keyword\">new</span> ReentrantLock();</span><br><span class=\"line\">    Condition condition = lock.newCondition();</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>)&#123;</span><br><span class=\"line\">           <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">               lock.lock();</span><br><span class=\"line\">               condition.signal();<span class=\"comment\">// 唤醒线程</span></span><br><span class=\"line\">               <span class=\"keyword\">if</span>(num &lt;= <span class=\"number\">100</span>)&#123;</span><br><span class=\"line\">                   System.out.println(Thread.currentThread().getName() + <span class=\"string\">&quot;打印&quot;</span> + num++);</span><br><span class=\"line\">               &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                   <span class=\"keyword\">break</span>;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">               <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                   condition.await(); <span class=\"comment\">// 释放当前的锁</span></span><br><span class=\"line\">               &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                   e.printStackTrace();</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">               lock.unlock();</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":["多线程"],"tags":["多线程"]},{"title":"ThreadLocal线程本地存储","url":"/2020/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BThreadLocal/","content":"<h2 id=\"ThreadLocal是什么\"><a href=\"#ThreadLocal是什么\" class=\"headerlink\" title=\"ThreadLocal是什么\"></a>ThreadLocal是什么</h2><p>该类提供了线程局部变量，为每一个线程创建一个单独的变量副本，使得每个线程都可以独立的改变自己所拥有的变量副本，而不会影响其他线程所对应的副本，消除了竞争条件。</p>\n<a id=\"more\"></a>\n\n<p>采用的以空间换时间的做法，在每个Thread里维护一个以开地址法实现的ThreadLocal.ThreadLocalMap，把数据隔离<br>线程本地存储根除了对变量的共享。</p>\n<p>提供了四个方法：</p>\n<ul>\n<li>get()  返回此线程局部变量的当前线程副本中的值</li>\n<li>initialValue()  返回此线程局部变量当前线程的初始值，当线程第一次调用get()或set()方法时调用，并且只调用一次</li>\n<li>remove()  移除此线程局部变量当前线程的值</li>\n<li>set(T value)  将此线程局部变量的当前线程副本中的值设置为指定值</li>\n<li>还有一个静态内部类 ThreadLocalMap 提供了一种用键值对方式存储每一个线程的变量副本的方法，key为当前的ThreadLocal对象，value为对象线程的变量副本</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyThread</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">3</span>; i++) &#123;</span><br><span class=\"line\">            ThreadLocalVariableHolder.increment();</span><br><span class=\"line\">            System.out.println(Thread.currentThread().getName() + <span class=\"string\">&quot;:&quot;</span> + ThreadLocalVariableHolder.get());</span><br><span class=\"line\">            Thread.yield();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ThreadLocalVariableHolder</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> ThreadLocal&lt;Integer&gt; myThreadLocal = <span class=\"keyword\">new</span> ThreadLocal&lt;Integer&gt;() &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 初始值默认为null 设置初始值为0</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> Integer <span class=\"title\">initialValue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">increment</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        myThreadLocal.set(myThreadLocal.get() + <span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">get</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> myThreadLocal.get();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        ExecutorService executorService = Executors.newCachedThreadPool();</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>;i&lt;<span class=\"number\">5</span>;i++)&#123;</span><br><span class=\"line\">            executorService.execute(<span class=\"keyword\">new</span> MyThread());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        executorService.shutdown();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>执行结果<br>pool-1-thread-1:1<br>pool-1-thread-2:1<br>pool-1-thread-3:1<br>pool-1-thread-3:2<br>pool-1-thread-2:2<br>pool-1-thread-1:2<br>pool-1-thread-2:3<br>pool-1-thread-3:3<br>pool-1-thread-4:1<br>pool-1-thread-1:3<br>pool-1-thread-4:2<br>pool-1-thread-4:3<br>pool-1-thread-5:1<br>pool-1-thread-5:2<br>pool-1-thread-5:3</p>\n","categories":["多线程"],"tags":["多线程"]},{"title":"线程池","url":"/2020/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E7%BA%BF%E7%A8%8B%E6%B1%A0/","content":"<h2 id=\"线程池\"><a href=\"#线程池\" class=\"headerlink\" title=\"线程池\"></a>线程池</h2><p>之前在使用线程的时候，不管是继承Thread类还是实现Runnable或者Callable接口，都需要使用new Thread来创建线程，用完之后直接销毁，频繁的创建销毁线程比较浪费资源，于是出现了线程池的概念。</p>\n<p>线程池中提供了一个线程队列，队列中保存着所有等待状态的线程，避免了创建和销毁的额外开销，提高了响应速度</p>\n<a id=\"more\"></a>\n\n<img src=\"/images/多线程/线程池.png\" alt=\"线程池\" style=\"zoom:50%;\">\n\n<h3 id=\"Executors\"><a href=\"#Executors\" class=\"headerlink\" title=\"Executors\"></a>Executors</h3><p>在一般情况下使用线程池都是直接使用Executors类中提供的静态方法来直接创建线程池，这是jdk提供创建线程池的工具类，但是要用好这个工具类，一定要清楚每个方法所生成的线程池的特性以及线程池中每个参数的含义。</p>\n<p>几种常用的创建线程池的方法</p>\n<h4 id=\"newFixedThreadPool\"><a href=\"#newFixedThreadPool\" class=\"headerlink\" title=\"newFixedThreadPool\"></a>newFixedThreadPool</h4><p>创建固定大小的线程池</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ExecutorService <span class=\"title\">newFixedThreadPool</span><span class=\"params\">(<span class=\"keyword\">int</span> nThreads)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class=\"line\">                                  <span class=\"number\">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class=\"line\">                                  <span class=\"keyword\">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"newSingleThreadExecutor\"><a href=\"#newSingleThreadExecutor\" class=\"headerlink\" title=\"newSingleThreadExecutor\"></a>newSingleThreadExecutor</h4><p>创建单个线程的线程池</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ExecutorService <span class=\"title\">newSingleThreadExecutor</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> FinalizableDelegatedExecutorService</span><br><span class=\"line\">        (<span class=\"keyword\">new</span> ThreadPoolExecutor(<span class=\"number\">1</span>, <span class=\"number\">1</span>,</span><br><span class=\"line\">                                <span class=\"number\">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class=\"line\">                                <span class=\"keyword\">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"newCachedThreadPool\"><a href=\"#newCachedThreadPool\" class=\"headerlink\" title=\"newCachedThreadPool\"></a>newCachedThreadPool</h4><p>缓存线程池，可以根须需求自动的更改数量</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ExecutorService <span class=\"title\">newCachedThreadPool</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ThreadPoolExecutor(<span class=\"number\">0</span>, Integer.MAX_VALUE,</span><br><span class=\"line\">                                  <span class=\"number\">60L</span>, TimeUnit.SECONDS,</span><br><span class=\"line\">                                  <span class=\"keyword\">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"newSingleThreadScheduledExecutor\"><a href=\"#newSingleThreadScheduledExecutor\" class=\"headerlink\" title=\"newSingleThreadScheduledExecutor\"></a>newSingleThreadScheduledExecutor</h4><p>创建固定大小的线程池，可以延迟或定时的执行任务</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ScheduledExecutorService <span class=\"title\">newScheduledThreadPool</span><span class=\"params\">(<span class=\"keyword\">int</span> corePoolSize)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ScheduledThreadPoolExecutor(corePoolSize);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"newWorkStealingPool-工作窃取线程池\"><a href=\"#newWorkStealingPool-工作窃取线程池\" class=\"headerlink\" title=\"newWorkStealingPool (工作窃取线程池)\"></a>newWorkStealingPool (工作窃取线程池)</h4><p>大型的任务被分解成若干块放入到队列中，在队列中还可以继续细分，线程从队列中获取任务并进行执行，当所有的线程计算结束之后，再将各部分的结果进行合并来得到最终结果。</p>\n<p>在处理器之间分配工作项，从而最大限度的利用所有可用的处理器来完成计算密集型任务，这项算法也用于 Java 的fork/join 框架</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">ExecutorService executorService = Executors.newWorkStealingPool();</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"线程池的提交和关闭\"><a href=\"#线程池的提交和关闭\" class=\"headerlink\" title=\"线程池的提交和关闭\"></a>线程池的提交和关闭</h3><p>ExecutorService接口中提供了提交任务和关闭线程池的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//提交  为线程池中的线程分配任务</span></span><br><span class=\"line\">&lt;T&gt; <span class=\"function\">Future&lt;T&gt; <span class=\"title\">submit</span><span class=\"params\">(Callable&lt;T&gt; task)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;T&gt; <span class=\"function\">Future&lt;T&gt; <span class=\"title\">submit</span><span class=\"params\">(Runnable task, T result)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">Future&lt;?&gt; submit(Runnable task);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(Runnable command)</span></span>;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 优雅的停止，等线程池任务执行完毕停止</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">shutdown</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"><span class=\"comment\">// 立即停止</span></span><br><span class=\"line\"><span class=\"function\">List&lt;Runnable&gt; <span class=\"title\">shutdownNow</span><span class=\"params\">()</span></span>;</span><br></pre></td></tr></table></figure>\n\n<p>submit()方法和execute()方法都可以提交任务执行，这两者有什么不同呢</p>\n<ul>\n<li>submit()方法有返回值Future，而execute()方法是没有返回值的</li>\n</ul>\n<p>但是对于ScheduledExecutorService延时调度，使用以下方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> ScheduledFuture&lt;?&gt; schedule(Runnable command,</span><br><span class=\"line\">                                   <span class=\"keyword\">long</span> delay, TimeUnit unit);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> &lt;V&gt; <span class=\"function\">ScheduledFuture&lt;V&gt; <span class=\"title\">schedule</span><span class=\"params\">(Callable&lt;V&gt; callable,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                           <span class=\"keyword\">long</span> delay, TimeUnit unit)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command,</span><br><span class=\"line\">                                                  <span class=\"keyword\">long</span> initialDelay,</span><br><span class=\"line\">                                                  <span class=\"keyword\">long</span> period,</span><br><span class=\"line\">                                                  TimeUnit unit);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command,</span><br><span class=\"line\">                                                     <span class=\"keyword\">long</span> initialDelay,</span><br><span class=\"line\">                                                     <span class=\"keyword\">long</span> delay,</span><br><span class=\"line\">                                                     TimeUnit unit);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ForkJoinPool-分支合并\"><a href=\"#ForkJoinPool-分支合并\" class=\"headerlink\" title=\"ForkJoinPool(分支合并)\"></a>ForkJoinPool(分支合并)</h3><p>存在一个大任务，将大任务进行拆分(fork)成若干个小任务，再将一个个的小任务运算进行join操作</p>\n<p>底层采用了工作窃取模式</p>\n","categories":["多线程"],"tags":["多线程"]},{"title":"线程","url":"/2020/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E7%BA%BF%E7%A8%8B%E7%AE%80%E4%BB%8B/","content":"<p>创建一个线程Thread时，JVM将分配一大块内存到专为线程保留的特殊区域上，用于提供运行任务时所需的一切，包括：</p>\n<a id=\"more\"></a>\n\n<ul>\n<li><p>程序计数器，指明要执行的下一个JVM字节码指令</p>\n</li>\n<li><p>用于支持Java代码执行的栈，包含有关线程已到达当时执行位置所调用方法的信息。它也包含每个正在执行的方法的所有局部变量</p>\n</li>\n<li><p>第二个则用于native code执行的栈</p>\n</li>\n<li><p>线程本地变量的存储区域</p>\n</li>\n<li><p>用于控制线程的状态管理变量</p>\n</li>\n</ul>\n<p>每当调用一个方法时，当前程序计数器被推到该线程的栈上，然后栈指针向下移动以足够来创建一个栈帧，其栈帧里存储该方法的所有局部变量，参数和返回值。所有基本类型变量都直接在栈上，虽然方法中创建对象的任何引用都位于栈帧中，但对象本身存于堆中。</p>\n<h3 id=\"实现Runnable接口比继承Thread的优势\"><a href=\"#实现Runnable接口比继承Thread的优势\" class=\"headerlink\" title=\"实现Runnable接口比继承Thread的优势\"></a>实现Runnable接口比继承Thread的优势</h3><ul>\n<li><p>适合多个相同的代码去处理同一个资源</p>\n</li>\n<li><p>可以避免java单继承的限制</p>\n</li>\n<li><p>增加程序的健壮性，代码可被多个线程共享，代码和数据独立</p>\n</li>\n</ul>\n<h3 id=\"方法介绍\"><a href=\"#方法介绍\" class=\"headerlink\" title=\"方法介绍\"></a>方法介绍</h3><ul>\n<li>join()  线程加入进来，要等待该线程执行完在继续执行join之后的代码</li>\n<li>yield()  暂停当前正在执行的线程，并执行其他线程，大多数情况下yield()方法会进入就绪状态，重新争抢cpu</li>\n<li>sleep()   在指定的时间内让当前正在执行的线程休眠</li>\n<li>getState()  获取线程状态</li>\n<li>wait()  Object的wait()方法、notify()、notifyAll()方法必须要与synchronized(obj)一起使用，只能针对已经获取到obj锁的情况，否则会抛出”java.lang.IllegalMonitorStateException“异常</li>\n</ul>\n<h3 id=\"sleep和wait的区别\"><a href=\"#sleep和wait的区别\" class=\"headerlink\" title=\"sleep和wait的区别\"></a>sleep和wait的区别</h3><ul>\n<li><p>sleep()是Thread的方法，wait()是Object的方法</p>\n</li>\n<li><p>sleep()和wait()虽然都释放CPU，但是如果线程持有对象锁资源的话，sleep()不释放锁资源，wait()释放锁资源，</p>\n</li>\n<li><p>sleep()需要捕获异常，wait()不需要</p>\n</li>\n<li><p>sleep()可以在任意位置使用，wait()必须要在synchronized同步块内使用</p>\n</li>\n</ul>\n<h3 id=\"Runnable和Callable接口的区别\"><a href=\"#Runnable和Callable接口的区别\" class=\"headerlink\" title=\"Runnable和Callable接口的区别\"></a>Runnable和Callable接口的区别</h3><p>Runnable中的run()方法返回值为void，Callable中的call方法有返回值且可以抛出异常，可以和Future、FutureTask配合获取异步执行的结果。  </p>\n<p><strong>自旋锁执行时间短、线程数少的时候使用（由于占用CPU）</strong>  —–&gt; Atomic和lock都是使用的自旋锁</p>\n","categories":["多线程"],"tags":["多线程"]},{"title":"多线程的异常处理","url":"/2020/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/","content":"<h2 id=\"多线程的异常处理\"><a href=\"#多线程的异常处理\" class=\"headerlink\" title=\"多线程的异常处理\"></a>多线程的异常处理</h2><p>在线程中如果出现异常想要额外进行一些操作的话，可以使用线程的异常处理机制，UncaughtExceptionHandler，这是线程的一个子接口，当一个未捕获的异常导致线程中断的时候JVM会使用thread.getUncaughtExceptionHandler()来查询线程的uncaughtExceptionHandler并将线程和异常作为参数传递给uncaughtException方法</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@FunctionalInterface</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">UncaughtExceptionHandler</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">         * Method invoked when the given thread terminates due to the</span></span><br><span class=\"line\"><span class=\"comment\">         * given uncaught exception.</span></span><br><span class=\"line\"><span class=\"comment\">         * &lt;p&gt;Any exception thrown by this method will be ignored by the</span></span><br><span class=\"line\"><span class=\"comment\">         * Java Virtual Machine.</span></span><br><span class=\"line\"><span class=\"comment\">         * <span class=\"doctag\">@param</span> t the thread</span></span><br><span class=\"line\"><span class=\"comment\">         * <span class=\"doctag\">@param</span> e the exception</span></span><br><span class=\"line\"><span class=\"comment\">         */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">uncaughtException</span><span class=\"params\">(Thread t, Throwable e)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果当前线程没有显示的调用thread.setUncaughtExceptionHandler()方法设置处理器时，会默认使用该线程的线程组的uncaughtException()方法，线程组是实现了UncaughtExceptionHandler接口的，线程组是在线程实例化时就进行指定的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ThreadGroup</span> <span class=\"keyword\">implements</span> <span class=\"title\">Thread</span>.<span class=\"title\">UncaughtExceptionHandler</span></span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"自定义Handler\"><a href=\"#自定义Handler\" class=\"headerlink\" title=\"自定义Handler\"></a>自定义Handler</h3><p>如何自定义handler并进行使用呢，那当然是要实现UncaughtExceptionHandler接口了，重写uncaughtException()方法即可</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyExceptionHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">Thread</span>.<span class=\"title\">UncaughtExceptionHandler</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">uncaughtException</span><span class=\"params\">(Thread t, Throwable e)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(t.getName()+<span class=\"string\">&quot;抛出异常&quot;</span>+e.getMessage());</span><br><span class=\"line\">        e.printStackTrace();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在实例化线程的时候进行指定handler即可</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">thread.setUncaughtExceptionHandler(<span class=\"keyword\">new</span> MyExceptionHandler());</span><br></pre></td></tr></table></figure>\n\n\n\n<p>代码示例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestExceptionHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        TestExceptionHandler test = <span class=\"keyword\">new</span> TestExceptionHandler();</span><br><span class=\"line\">        Thread thread = <span class=\"keyword\">new</span> Thread(test.<span class=\"function\">new <span class=\"title\">MyThread</span><span class=\"params\">()</span>)</span>;</span><br><span class=\"line\">        thread.setUncaughtExceptionHandler(<span class=\"keyword\">new</span> MyExceptionHandler());</span><br><span class=\"line\">        thread.start();</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyThread</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                Thread.sleep(<span class=\"number\">2000</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">                e.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> i = <span class=\"number\">1</span>/<span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyExceptionHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">Thread</span>.<span class=\"title\">UncaughtExceptionHandler</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">uncaughtException</span><span class=\"params\">(Thread t, Throwable e)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(t.getName()+<span class=\"string\">&quot;抛出异常&quot;</span>+e.getMessage());</span><br><span class=\"line\">        e.printStackTrace();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>例子不是一个好例子，但是主要就是展示一下如何使用，场景自己把握</p>\n","categories":["多线程"],"tags":["多线程"]},{"title":"多线程问题集锦","url":"/2020/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6/","content":"<h3 id=\"有T1、T2、T3三个线程，怎样保证T2在T1执行完后执行，T3在T2执行完后执行\"><a href=\"#有T1、T2、T3三个线程，怎样保证T2在T1执行完后执行，T3在T2执行完后执行\" class=\"headerlink\" title=\"有T1、T2、T3三个线程，怎样保证T2在T1执行完后执行，T3在T2执行完后执行\"></a>有T1、T2、T3三个线程，怎样保证T2在T1执行完后执行，T3在T2执行完后执行</h3><p>使用join</p>\n<a id=\"more\"></a>\n\n<h3 id=\"Lock接口比synchronized块的优势是什么\"><a href=\"#Lock接口比synchronized块的优势是什么\" class=\"headerlink\" title=\"Lock接口比synchronized块的优势是什么\"></a>Lock接口比synchronized块的优势是什么</h3><p>lock接口最大的优势是它们为读和写分别提供了锁，可以满足像ConcurrentHashMap这样的高性能数据结构和有条件的阻塞</p>\n","categories":["多线程"],"tags":["多线程"]},{"title":"阻塞队列","url":"/2021/%E5%A4%9A%E7%BA%BF%E7%A8%8B/%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97/","content":"<h2 id=\"阻塞队列\"><a href=\"#阻塞队列\" class=\"headerlink\" title=\"阻塞队列\"></a>阻塞队列</h2><p>BlockingQueue接口是在jdk5版本提供的，在线程池中用到了阻塞队列来实现，阻塞队列是深入学习线程池的基础，该队列通常是有限的容量，如果队列已满添加操作就会阻塞，如果队列为空，移除操作就会阻塞。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">BlockingQueue</span>&lt;<span class=\"title\">E</span>&gt; <span class=\"keyword\">extends</span> <span class=\"title\">Queue</span>&lt;<span class=\"title\">E</span>&gt; </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">add</span><span class=\"params\">(E e)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">offer</span><span class=\"params\">(E e)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">put</span><span class=\"params\">(E e)</span> <span class=\"keyword\">throws</span> InterruptedException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">offer</span><span class=\"params\">(E e, <span class=\"keyword\">long</span> timeout, TimeUnit unit)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> InterruptedException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\">E <span class=\"title\">take</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> InterruptedException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\">E <span class=\"title\">poll</span><span class=\"params\">(<span class=\"keyword\">long</span> timeout, TimeUnit unit)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> InterruptedException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">remainingCapacity</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">remove</span><span class=\"params\">(Object o)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">contains</span><span class=\"params\">(Object o)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">drainTo</span><span class=\"params\">(Collection&lt;? <span class=\"keyword\">super</span> E&gt; c)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">   </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">drainTo</span><span class=\"params\">(Collection&lt;? <span class=\"keyword\">super</span> E&gt; c, <span class=\"keyword\">int</span> maxElements)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"BlockingQueue实现类\"><a href=\"#BlockingQueue实现类\" class=\"headerlink\" title=\"BlockingQueue实现类\"></a>BlockingQueue实现类</h3><img src=\"/../lubao_blog/source/images/多线程/阻塞队列.png\" alt=\"阻塞队列\" style=\"zoom:50%;\">\n\n<h4 id=\"ArrayBlockingQueue\"><a href=\"#ArrayBlockingQueue\" class=\"headerlink\" title=\"ArrayBlockingQueue\"></a>ArrayBlockingQueue</h4><p>ArrayBlockingQueue类底层是由数组支持的有界阻塞队列，实现了FIFO(先进先出)排序机制。新添加的元素都在队列的尾部，获取操作是从队列头部进行，可以设置公平策略，默认是非公平的</p>\n<p>内部没有实现读写分离，生产和消费不能完全并行，长度需要定义</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArrayBlockingQueue</span><span class=\"params\">(<span class=\"keyword\">int</span> capacity)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>(capacity, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArrayBlockingQueue</span><span class=\"params\">(<span class=\"keyword\">int</span> capacity, <span class=\"keyword\">boolean</span> fair)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (capacity &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException();</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.items = <span class=\"keyword\">new</span> Object[capacity];</span><br><span class=\"line\">  lock = <span class=\"keyword\">new</span> ReentrantLock(fair);</span><br><span class=\"line\">  notEmpty = lock.newCondition();</span><br><span class=\"line\">  notFull =  lock.newCondition();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"LinkedBlockingQueue\"><a href=\"#LinkedBlockingQueue\" class=\"headerlink\" title=\"LinkedBlockingQueue\"></a>LinkedBlockingQueue</h4><p>LinkedBlockingQueue类底层为链表，无界队列被设计为没有容量限制，最大值为Integer.MAX_VALUE，当然也提供了设置容量的构造器</p>\n<p>可以很好的处理并发数据，其内部实现采用分离锁(读写分离两个锁)，可以实现生产和消费操作的完全并行运行。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LinkedBlockingQueue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>(Integer.MAX_VALUE);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LinkedBlockingQueue</span><span class=\"params\">(<span class=\"keyword\">int</span> capacity)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (capacity &lt;= <span class=\"number\">0</span>) <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException();</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.capacity = capacity;</span><br><span class=\"line\">  last = head = <span class=\"keyword\">new</span> Node&lt;E&gt;(<span class=\"keyword\">null</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"PriorityBlockingQueue\"><a href=\"#PriorityBlockingQueue\" class=\"headerlink\" title=\"PriorityBlockingQueue\"></a>PriorityBlockingQueue</h4><p>PriorityBlockingQueue类是一个无界队列，基于优先级的阻塞队列，可以决定元素的优先顺序(使用自然排序或者比较器来进行排序，传入的对象必须实现Comparable接口)，会自动进行扩容，内部控制线程同步的锁是公平锁</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PriorityBlockingQueue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>(DEFAULT_INITIAL_CAPACITY, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PriorityBlockingQueue</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                 Comparator&lt;? <span class=\"keyword\">super</span> E&gt; comparator)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (initialCapacity &lt; <span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException();</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.lock = <span class=\"keyword\">new</span> ReentrantLock();</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.notEmpty = lock.newCondition();</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.comparator = comparator;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.queue = <span class=\"keyword\">new</span> Object[initialCapacity];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"DelayQueue\"><a href=\"#DelayQueue\" class=\"headerlink\" title=\"DelayQueue\"></a>DelayQueue</h4><p>DelayQueue类是一种延迟队列，带有延迟时间，只有当延迟时间到了，才能从队列中获取到该元素。DelayQueue中的元素必须实现Delayed接口，该队列也是一个没有大小限制的队列，可以用做对缓存超时的数据移除、任务超时处理和空闲连接关闭等。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DelayQueue</span><span class=\"params\">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"SynchronousQueue\"><a href=\"#SynchronousQueue\" class=\"headerlink\" title=\"SynchronousQueue\"></a>SynchronousQueue</h4><p>SynchronousQueue类是一个没有缓冲的队列，生产者生产的数据直接会被消费者获取并消费。</p>\n<h4 id=\"TransferQueue\"><a href=\"#TransferQueue\" class=\"headerlink\" title=\"TransferQueue\"></a>TransferQueue</h4><p>TransferQueue类</p>\n","categories":["队列"],"tags":["队列"]},{"title":"基本算法","url":"/2020/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E5%9F%BA%E6%9C%AC%E7%AE%97%E6%B3%95/","content":"<h2 id=\"算法基本使用\"><a href=\"#算法基本使用\" class=\"headerlink\" title=\"算法基本使用\"></a>算法基本使用</h2><h3 id=\"最大公约数\"><a href=\"#最大公约数\" class=\"headerlink\" title=\"最大公约数\"></a>最大公约数</h3><p>最大公约数求取，使用欧几里得算法</p>\n<a id=\"more\"></a>\n\n<p>若 mod(m,n)!=0  则 g(m,n) = g(n,mod(m,n))</p>\n<p>若mod(m,n)=0 则g(m,n) = n</p>\n<p>mod(m,n)表示m除n之后的余数</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">maxCommonDisvisor</span><span class=\"params\">(<span class=\"keyword\">int</span> m, <span class=\"keyword\">int</span> n)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> temp = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (m &lt; n) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (n % m == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> m;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                temp = n % m;</span><br><span class=\"line\">                n = m;</span><br><span class=\"line\">                m = temp;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (m % n == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> n;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                temp = m % n;</span><br><span class=\"line\">                m = n;</span><br><span class=\"line\">                n = temp;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"递推\"><a href=\"#递推\" class=\"headerlink\" title=\"递推\"></a>递推</h2><p>递推算法是一种简单的算法，即通过已知条件，利用特定关系得出中间推论，直至得到结果的算法。<br>递推算法分为顺推和逆推两种</p>\n<p>如  斐波那契数列</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">fs</span><span class=\"params\">(<span class=\"keyword\">int</span> num)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span>[] fs = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[num];</span><br><span class=\"line\">        fs[<span class=\"number\">0</span>] = <span class=\"number\">1</span>;</span><br><span class=\"line\">        fs[<span class=\"number\">1</span>] = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">2</span>; i &lt; num; i++) &#123;</span><br><span class=\"line\">            fs[i] = fs[i - <span class=\"number\">1</span>] + fs[i - <span class=\"number\">2</span>];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        Arrays.stream(fs).forEach(System.out :: println);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"递归\"><a href=\"#递归\" class=\"headerlink\" title=\"递归\"></a>递归</h2><p>进行进制转换</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(Integer.toBinaryString(<span class=\"number\">10</span>));</span><br><span class=\"line\">        StringBuilder stringBuilder = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">        tenToTwo(<span class=\"number\">10</span>, stringBuilder);</span><br><span class=\"line\">        System.out.println(stringBuilder.reverse().toString());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">tenToTwo</span><span class=\"params\">(<span class=\"keyword\">int</span> ten, StringBuilder sb)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ten == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        sb.append(ten % <span class=\"number\">2</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> tenToTwo(ten / <span class=\"number\">2</span>, sb);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"分治\"><a href=\"#分治\" class=\"headerlink\" title=\"分治\"></a>分治</h2><p>分而治之，把一个复杂的问题分解成很多规模较小的子问题，然后解决这些子问题，把解决的子问题合并起来，大问题就解决了</p>\n<h2 id=\"穷举\"><a href=\"#穷举\" class=\"headerlink\" title=\"穷举\"></a>穷举</h2><p>把所有情况都列举出来</p>\n<h2 id=\"贪婪算法\"><a href=\"#贪婪算法\" class=\"headerlink\" title=\"贪婪算法\"></a>贪婪算法</h2><p>贪婪算法不追求最优解，只希望得到较为满意解的方法，一般可以快速得到满意的解，省去了为找最优解要穷尽所有可能而必须耗费的大量时间。通过局部最优选择来达到全局最优解。</p>\n<p>找零钱示例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Main4</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span>[] value = &#123;<span class=\"number\">10000</span>, <span class=\"number\">5000</span>, <span class=\"number\">2000</span>, <span class=\"number\">1000</span>, <span class=\"number\">500</span>, <span class=\"number\">200</span>, <span class=\"number\">100</span>, <span class=\"number\">50</span>, <span class=\"number\">20</span>, <span class=\"number\">10</span>, <span class=\"number\">5</span>, <span class=\"number\">2</span>, <span class=\"number\">1</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 面值单位为分  100元、50元、20元、10元、5元、2元、1元、5角、2角、1角、5分、2分、1分</span></span><br><span class=\"line\">        Main4 m = <span class=\"keyword\">new</span> Main4();</span><br><span class=\"line\"></span><br><span class=\"line\">        m.exchange(<span class=\"number\">1748</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 单位为分</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> n</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">exchange</span><span class=\"params\">(<span class=\"keyword\">int</span> n)</span> </span>&#123;</span><br><span class=\"line\">        StringBuilder sb = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> m = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; value.length; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (n &lt; value[i]) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            m = n / value[i];</span><br><span class=\"line\">            n = n - m * value[i];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (value[i] &gt; <span class=\"number\">100</span>) &#123;</span><br><span class=\"line\">                sb.append(m).append(<span class=\"string\">&quot;张&quot;</span>).append(value[i] / <span class=\"number\">100</span>).append(<span class=\"string\">&quot;元,&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (value[i] &gt; <span class=\"number\">10</span>) &#123;</span><br><span class=\"line\">                sb.append(m).append(<span class=\"string\">&quot;张&quot;</span>).append(value[i] / <span class=\"number\">10</span>).append(<span class=\"string\">&quot;角,&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                sb.append(m).append(<span class=\"string\">&quot;张&quot;</span>).append(value[i]).append(<span class=\"string\">&quot;分,&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sb.indexOf(<span class=\"string\">&quot;,&quot;</span>) &gt; <span class=\"number\">0</span> &amp;&amp; sb.lastIndexOf(<span class=\"string\">&quot;,&quot;</span>) == sb.length() - <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">            sb.deleteCharAt(sb.length() - <span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        System.out.println(sb.toString());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"回溯算法\"><a href=\"#回溯算法\" class=\"headerlink\" title=\"回溯算法\"></a>回溯算法</h2><p>为了得到问题的解，先选择某一种可能情况进行试探，在试探过程中，一旦发现原本选择的假设情况是错误的，就退回一步选择，继续向另一个方向试探，如此反复，得到结果</p>\n<p>八皇后示例</p>\n","categories":["数据结构与算法"],"tags":["数据结构与算法"]},{"title":"排序算法","url":"/2021/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/","content":"<h2 id=\"排序算法\"><a href=\"#排序算法\" class=\"headerlink\" title=\"排序算法\"></a>排序算法</h2><p>按照策略分类主要的排序算法有：插入排序、选择排序、交换排序、归并排序、分配排序</p>\n<a id=\"more\"></a>\n\n<h3 id=\"插入排序\"><a href=\"#插入排序\" class=\"headerlink\" title=\"插入排序\"></a>插入排序</h3><p>插入排序的基本思想：每次讲一个待排序的记录，按其关键字大小插入到前面已经排好序的记录集中，直到所有排序记录全部插入成功。</p>\n<h4 id=\"直接插入排序\"><a href=\"#直接插入排序\" class=\"headerlink\" title=\"直接插入排序\"></a>直接插入排序</h4><h5 id=\"直接插入排序的思想\"><a href=\"#直接插入排序的思想\" class=\"headerlink\" title=\"直接插入排序的思想\"></a>直接插入排序的思想</h5><p>假设排序数据存放在数组A[1…n]中，则A[1]则可以看做是一个有序序列，让i从2开始，依次将A[i]插入到有序序列A[1…i-1]中，A[n]插入完毕结束</p>\n<h5 id=\"过程举例\"><a href=\"#过程举例\" class=\"headerlink\" title=\"过程举例\"></a>过程举例</h5><p>【】中的数据为有序的</p>\n<table>\n<thead>\n<tr>\n<th>待排序的数据：</th>\n<th>【 23】 56 2 9 17</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>i =2</td>\n<td>【 23 56】 2 9 17</td>\n</tr>\n<tr>\n<td>i=3</td>\n<td>【 2 23 56】 9 17</td>\n</tr>\n<tr>\n<td>i=4</td>\n<td>【 2 9 23 56】17</td>\n</tr>\n<tr>\n<td>i=5</td>\n<td>【 2 9 17 23 56】</td>\n</tr>\n</tbody></table>\n<h5 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span>[] arrays = &#123;<span class=\"number\">23</span>,<span class=\"number\">56</span>,<span class=\"number\">2</span>,<span class=\"number\">9</span>,<span class=\"number\">17</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">int</span> i,j;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(i = <span class=\"number\">1</span>;i&lt;arrays.length;i++)&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 当前值比前一个值小  需要移位</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(arrays[i] &lt; arrays[i-<span class=\"number\">1</span>])&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> temp = arrays[i]; <span class=\"comment\">// 暂存</span></span><br><span class=\"line\">        <span class=\"comment\">// 依次与前面的元素进行比较</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(j = i-<span class=\"number\">1</span>;j &gt;=<span class=\"number\">0</span> &amp;&amp; arrays[j] &gt; temp;j--)&#123;</span><br><span class=\"line\">            arrays[j+<span class=\"number\">1</span>] = arrays[j];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 找到所在位置</span></span><br><span class=\"line\">        arrays[j+<span class=\"number\">1</span>] = temp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">System.out.println(Arrays.toString(arrays));</span><br></pre></td></tr></table></figure>\n\n<p>​                  </p>\n<p>时间复杂度O(n^2)</p>\n<h4 id=\"希尔排序\"><a href=\"#希尔排序\" class=\"headerlink\" title=\"希尔排序\"></a>希尔排序</h4><h5 id=\"希尔排序的思想\"><a href=\"#希尔排序的思想\" class=\"headerlink\" title=\"希尔排序的思想\"></a>希尔排序的思想</h5><p>任取一个小于n的正数S1作为增量，将所有的元素分为S1个组，先在各组进行直接插入排序，然后取第二个增量重复上述的分组和排序，直到所取的增量等于1，即所有记录放在同一个分组中为止</p>\n<p>由于是每个组进行直接插入排序，所以是在直接插入排序上进行补偿的设置</p>\n<h5 id=\"代码实现-1\"><a href=\"#代码实现-1\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h5><p>步长的设置需要考量，慢慢尝试</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span>[] arrays = &#123;<span class=\"number\">130</span>,<span class=\"number\">100</span>,<span class=\"number\">56</span>,<span class=\"number\">30</span>,<span class=\"number\">23</span>,<span class=\"number\">17</span>,<span class=\"number\">9</span>,<span class=\"number\">2</span>&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">int</span> i,j;</span><br><span class=\"line\"><span class=\"keyword\">int</span> gap = arrays.length /<span class=\"number\">2</span>;</span><br><span class=\"line\"><span class=\"keyword\">int</span> count = <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"keyword\">while</span> (gap &gt;= <span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(i = gap;i&lt;arrays.length;i++)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 当前值比前一个值小  需要移位</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(arrays[i] &lt; arrays[i-<span class=\"number\">1</span>])&#123;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> temp = arrays[i]; <span class=\"comment\">// 暂存</span></span><br><span class=\"line\">            <span class=\"comment\">// 依次与前面的元素进行比较</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span>(j = i-gap;j &gt;=<span class=\"number\">0</span> &amp;&amp; arrays[j] &gt; temp;j=j-gap)&#123;</span><br><span class=\"line\">                arrays[j+gap] = arrays[j];</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 找到所在位置</span></span><br><span class=\"line\">            arrays[j+gap] = temp;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    gap = gap / <span class=\"number\">2</span>;</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;=======================第&quot;</span>+count+<span class=\"string\">&quot;次&quot;</span>);</span><br><span class=\"line\">    System.out.println(Arrays.toString(arrays));</span><br><span class=\"line\">    count++;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">System.out.println(Arrays.toString(arrays));</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"交换排序\"><a href=\"#交换排序\" class=\"headerlink\" title=\"交换排序\"></a>交换排序</h3><p>交换排序的基本思想是：两两比较待排序的数据，发现两个数据的次序相反则进行交换，直到没有反序为止</p>\n<h4 id=\"冒泡排序\"><a href=\"#冒泡排序\" class=\"headerlink\" title=\"冒泡排序\"></a>冒泡排序</h4><p>最多进行n-1趟排序，每趟排序自底向上扫描，一旦发现相邻的元素不符合规则，则交换，第一趟排序后，最小值在A[1]，第二次排序后，最小值在A[2]，依次类推，第n-1趟排序之后，所有元素按照顺序排列</p>\n<h5 id=\"过程举例-1\"><a href=\"#过程举例-1\" class=\"headerlink\" title=\"过程举例\"></a>过程举例</h5><p>待排序的数字   10  5  2  4  3  8  6</p>\n<p>第1次排序后<br>2    10    5    3    4    6    8<br>第2次排序后<br>2    3    10    5    4    6    8<br>第3次排序后<br>2    3    4    10    5    6    8<br>第4次排序后<br>2    3    4    5    10    6    8<br>第5次排序后<br>2    3    4    5    6    10    8<br>第6次排序后<br>2    3    4    5    6    8    10</p>\n<h5 id=\"代码实现-2\"><a href=\"#代码实现-2\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span>[] arr = &#123;<span class=\"number\">10</span>,<span class=\"number\">5</span>,<span class=\"number\">2</span>,<span class=\"number\">4</span>,<span class=\"number\">3</span>,<span class=\"number\">8</span>,<span class=\"number\">6</span>&#125;;</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i&lt; arr.length-<span class=\"number\">1</span>;i++)&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> j = arr.length-<span class=\"number\">1</span>;j&gt; i;j--)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(arr[j-<span class=\"number\">1</span>] &gt; arr[j])&#123;</span><br><span class=\"line\">      <span class=\"keyword\">int</span> temp = arr[j];</span><br><span class=\"line\">      arr[j] = arr[j-<span class=\"number\">1</span>];</span><br><span class=\"line\">      arr[j-<span class=\"number\">1</span>] = temp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>时间复杂度为O(n^2)</p>\n<h4 id=\"快速排序\"><a href=\"#快速排序\" class=\"headerlink\" title=\"快速排序\"></a>快速排序</h4><p>从集合中任取一个元素作为比较的基准X，将数据划分为左右两部分，A[1…i-1] &lt;=X&lt;=A[i+1…n]，然后在分别对它们进行划分，直到全部有序为止</p>\n<h5 id=\"代码实例\"><a href=\"#代码实例\" class=\"headerlink\" title=\"代码实例\"></a>代码实例</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">QuickSort</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">int</span>[] data = &#123;<span class=\"number\">67</span>,<span class=\"number\">67</span>,<span class=\"number\">14</span>,<span class=\"number\">52</span>,<span class=\"number\">29</span>,<span class=\"number\">9</span>,<span class=\"number\">90</span>,<span class=\"number\">54</span>,<span class=\"number\">87</span>,<span class=\"number\">71</span>&#125;;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        quickSort(<span class=\"number\">0</span>,data.length-<span class=\"number\">1</span>);</span><br><span class=\"line\">        System.out.println(Arrays.toString(data));</span><br><span class=\"line\">        System.out.println(count);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">quickSort</span><span class=\"params\">(<span class=\"keyword\">int</span> begin,<span class=\"keyword\">int</span> end)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(begin == end || begin == (end - <span class=\"number\">1</span>))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 取第一个数作为基准</span></span><br><span class=\"line\">        <span class=\"keyword\">int</span> p = data[begin];</span><br><span class=\"line\">        <span class=\"keyword\">int</span> low = begin+<span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> hign = end;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (low &lt; hign)&#123;</span><br><span class=\"line\">            count++;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(data[low] &gt; p)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(data[hign] &lt; p)&#123;</span><br><span class=\"line\">                    <span class=\"keyword\">int</span> temp = data[low];</span><br><span class=\"line\">                    data[low] = data[hign];</span><br><span class=\"line\">                    data[hign] = temp;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                hign--;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                low++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// low和hign位置碰撞时，可能数据还没有和基数比较</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(data[low] &gt; p)&#123;</span><br><span class=\"line\">            data[begin] = data[low-<span class=\"number\">1</span>];</span><br><span class=\"line\">            data[low-<span class=\"number\">1</span>] = p;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            data[begin] = data[low];</span><br><span class=\"line\">            data[low] = p;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(Arrays.toString(data));</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(low-<span class=\"number\">1</span> &gt; begin)&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;=====低位排序======&quot;</span>);</span><br><span class=\"line\">            quickSort(begin,low-<span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(end &gt; hign+<span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;=====高位排序======&quot;</span>);</span><br><span class=\"line\">            quickSort(hign+<span class=\"number\">1</span>,end);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"选择排序\"><a href=\"#选择排序\" class=\"headerlink\" title=\"选择排序\"></a>选择排序</h3><p>选择排序的基本思想是：每一趟从待排序的数据中选出最小元素，顺序放在已排好序的数据最后，直到全部数据排序完毕</p>\n<h4 id=\"直接选择排序\"><a href=\"#直接选择排序\" class=\"headerlink\" title=\"直接选择排序\"></a>直接选择排序</h4><h5 id=\"过程举例-2\"><a href=\"#过程举例-2\" class=\"headerlink\" title=\"过程举例\"></a>过程举例</h5><p>待排序数据<br>[67, 67, 14, 52, 29, 9, 90, 54, 87, 71]<br>第1次排序<br>[9, 67, 14, 52, 29, 67, 90, 54, 87, 71]<br>第2次排序<br>[9, 14, 67, 52, 29, 67, 90, 54, 87, 71]<br>第3次排序<br>[9, 14, 29, 52, 67, 67, 90, 54, 87, 71]<br>第4次排序<br>[9, 14, 29, 52, 67, 67, 90, 54, 87, 71]<br>第5次排序<br>[9, 14, 29, 52, 54, 67, 90, 67, 87, 71]<br>第6次排序<br>[9, 14, 29, 52, 54, 67, 90, 67, 87, 71]<br>第7次排序<br>[9, 14, 29, 52, 54, 67, 67, 90, 87, 71]<br>第8次排序<br>[9, 14, 29, 52, 54, 67, 67, 71, 87, 90]<br>第9次排序<br>[9, 14, 29, 52, 54, 67, 67, 71, 87, 90]</p>\n<h5 id=\"代码实现-3\"><a href=\"#代码实现-3\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i&lt;data.length-<span class=\"number\">1</span>;i++)&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 记录最小值得索引位置</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> min = i;</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> j = i+<span class=\"number\">1</span>;j&lt;data.length;j++)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(data[min] &gt; data[j])&#123;</span><br><span class=\"line\">      min = j;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// 找到最小位置后，进行交换</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span>(min != i)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> temp = data[i];</span><br><span class=\"line\">    data[i] = data[min];</span><br><span class=\"line\">    data[min] = temp;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>时间复杂度为O(n^2)</p>\n<h4 id=\"堆排序\"><a href=\"#堆排序\" class=\"headerlink\" title=\"堆排序\"></a>堆排序</h4><p>堆排序是一种树形选择排序，分为大顶堆和小顶堆</p>\n<ul>\n<li>大顶堆：每个节点的值都大于等于其孩子节点的值</li>\n<li>小顶堆：每个节点的值都小于等于其孩子的值</li>\n</ul>\n<h5 id=\"小顶堆\"><a href=\"#小顶堆\" class=\"headerlink\" title=\"小顶堆\"></a>小顶堆</h5><p>根节点的元素最小是小顶堆(小于左右子节点的值)</p>\n<pre class=\"mermaid\">graph TD\n0((0)) --- 1((1)) --- 3((3))\n1((1)) --- 4((4))\n0((0)) --- 2((2))</pre>\n\n<h5 id=\"大顶堆\"><a href=\"#大顶堆\" class=\"headerlink\" title=\"大顶堆\"></a>大顶堆</h5><p>根节点的元素最大是大顶堆(大于左右子节点的值)</p>\n<pre class=\"mermaid\">graph TD\n0((4)) --- 1((3)) --- 3((1))\n1((3)) --- 4((0))\n0((4)) --- 2((2))</pre>\n\n<p>以小顶堆为例，由于每个节点的值都小于等于其子节点的值，而且其是一个完全二叉树，也就意味着父节点和其左右子节点的索引关系为2n+1和2n+2</p>\n<p>值得关系为arr[n] &lt;= arr[2n+1]   arr[n]&lt;=arr[2n+2]</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 先找到最后一个元素的父节点索引</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> index = data.length/<span class=\"number\">2</span>-<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> length = data.length;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = index;i&gt;=<span class=\"number\">0</span>;i--)&#123;</span><br><span class=\"line\">        adjust(data,i,length);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 将根节点与尾结点交换 得到新的无序数组 再次构建堆</span></span><br><span class=\"line\">    <span class=\"comment\">// 依次将根节点与无序数组中的最后一个元素替换 重复操作</span></span><br><span class=\"line\">      <span class=\"comment\">// 一直将堆顶元素放到堆的最后</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = length-<span class=\"number\">1</span>; i &gt;<span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> temp = data[<span class=\"number\">0</span>];</span><br><span class=\"line\">        data[<span class=\"number\">0</span>] = data[i];</span><br><span class=\"line\">        data[i] = temp;</span><br><span class=\"line\">        adjust(data, <span class=\"number\">0</span>, i);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    System.out.println(Arrays.toString(data));</span><br><span class=\"line\">    System.out.println(count);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">adjust</span><span class=\"params\">(<span class=\"keyword\">int</span>[] data,<span class=\"keyword\">int</span> index,<span class=\"keyword\">int</span> length)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> childLeftIndex = <span class=\"number\">2</span>*index+<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> childRightIndex = <span class=\"number\">2</span>*index+<span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> lowIndex = index;</span><br><span class=\"line\">    count++;</span><br><span class=\"line\">    <span class=\"comment\">// 左孩子节点大于最小索引的值</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(childLeftIndex &lt; length &amp;&amp; data[childLeftIndex] &gt; data[lowIndex])&#123;</span><br><span class=\"line\">        lowIndex = childLeftIndex;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 右孩子节点大于最小索引的值</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(childRightIndex &lt; length &amp;&amp; data[childRightIndex] &gt; data[lowIndex])&#123;</span><br><span class=\"line\">        lowIndex = childRightIndex;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 与两个子节点都比较完在进行交换，否则会导致两个子节点的值被交换</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(lowIndex != index)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> temp = data[lowIndex];</span><br><span class=\"line\">        data[lowIndex] = data[index];</span><br><span class=\"line\">        data[index] = temp;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 数据交换之后可能会导致该值与其左右孩子节点的值大小不符合小顶堆，需要再次比较与其子树节点的大小关系</span></span><br><span class=\"line\">        adjust(data,lowIndex,length);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"归并排序\"><a href=\"#归并排序\" class=\"headerlink\" title=\"归并排序\"></a>归并排序</h3><p>归并排序是将若干个已排序的数组合并成一个有序的数组</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span>[] data = &#123;<span class=\"number\">67</span>,<span class=\"number\">67</span>,<span class=\"number\">14</span>,<span class=\"number\">52</span>,<span class=\"number\">29</span>,<span class=\"number\">9</span>,<span class=\"number\">90</span>,<span class=\"number\">54</span>,<span class=\"number\">87</span>,<span class=\"number\">71</span>&#125;;</span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">int</span>[] temp = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[data.length];</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    sort(data,<span class=\"number\">0</span>,data.length-<span class=\"number\">1</span>);</span><br><span class=\"line\">    System.out.println(Arrays.toString(data));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 排序</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">sort</span><span class=\"params\">(<span class=\"keyword\">int</span>[] arr,<span class=\"keyword\">int</span> start,<span class=\"keyword\">int</span> end)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> middle = (start + end) / <span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(start &lt; end)&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 分别排序</span></span><br><span class=\"line\">        sort(arr,start,middle);</span><br><span class=\"line\">        sort(arr,middle+<span class=\"number\">1</span>,end);</span><br><span class=\"line\">        merge(arr,start,middle,end);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 归并</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">merge</span><span class=\"params\">(<span class=\"keyword\">int</span>[] arr,<span class=\"keyword\">int</span> start,<span class=\"keyword\">int</span> middle,<span class=\"keyword\">int</span> end)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> i = start;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> j = middle+<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> k = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (i &lt;= middle &amp;&amp; j &lt;= end)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(arr[i] &lt; arr[j])&#123;</span><br><span class=\"line\">            temp[k++] = arr[i++];</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            temp[k++] = arr[j++];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 此时至少有一个序列是已经全部比较完的</span></span><br><span class=\"line\">    <span class=\"comment\">// 将没有比较完的一部分数据放到temp数组中</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(i &lt;= middle)&#123;</span><br><span class=\"line\">        System.arraycopy(arr,i,temp,k,middle-i+<span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(j&lt;= end)&#123;</span><br><span class=\"line\">        System.arraycopy(arr,j,temp,k,end - j+<span class=\"number\">1</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    System.arraycopy(temp,<span class=\"number\">0</span>,arr,start,end - start+<span class=\"number\">1</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":["数据结构与算法"],"tags":["数据结构与算法"]},{"title":"数据结构","url":"/2020/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/","content":"<p>数据之间有3种基本结构</p>\n<ul>\n<li><p><strong>线性结构</strong>   数据元素之间为一对一关系</p>\n</li>\n<li><p><strong>树形结构</strong>   数据元素之间为一对多关系</p>\n</li>\n<li><p><strong>网状结构</strong>   数据元素之间为多对多关系</p>\n<a id=\"more\"></a>\n\n</li>\n</ul>\n<h1 id=\"线性结构\"><a href=\"#线性结构\" class=\"headerlink\" title=\"线性结构\"></a>线性结构</h1><h2 id=\"线性表\"><a href=\"#线性表\" class=\"headerlink\" title=\"线性表\"></a>线性表</h2><p>线性表分为顺序线性表和链式线性表，顺序存储结构和链式存储结构，顺序存储结构的线性表称为顺序表，链式存储的线性表称为链表</p>\n<p>线性表数据结构具有以下特征：</p>\n<ul>\n<li><p>存在唯一的”首元素”</p>\n</li>\n<li><p>存在唯一的”尾元素”</p>\n</li>\n<li><p>除尾元素外，其余元素均有唯一的后继元素</p>\n</li>\n<li><p>除首元素外，其余元素均有唯一的前驱元素</p>\n</li>\n</ul>\n<h3 id=\"顺序表\"><a href=\"#顺序表\" class=\"headerlink\" title=\"顺序表\"></a>顺序表</h3><p>  在内存中用一组地址连续的存储空间顺序存放线性表的各个元素，保证线性表元素逻辑上的有序性。</p>\n<p>  顺序表是将数据按顺序保存到内存中的，因此在顺序表中存取数据很方便，但是插入数据时，需要移动大量的数据，java中的ArrayList实现原理就是数组</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 简单的线性表实现</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ShunXuBiao</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 默认容量</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> DEFAULT_CAPACITY = <span class=\"number\">10</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 顺序表主体</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Object[] array;</span><br><span class=\"line\">    <span class=\"comment\">// 顺序表长度，表示顺序表中当前元素个数</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> size;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//数组长度</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> length;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        ShunXuBiao&lt;Integer&gt; shunXuBiao = <span class=\"keyword\">new</span> ShunXuBiao&lt;&gt;(<span class=\"number\">2</span>);</span><br><span class=\"line\">        System.out.println(shunXuBiao.isEmpty());</span><br><span class=\"line\">        shunXuBiao.add(<span class=\"number\">100</span>);</span><br><span class=\"line\">        System.out.println(shunXuBiao.size());</span><br><span class=\"line\">        shunXuBiao.add(<span class=\"number\">10</span>);</span><br><span class=\"line\">        shunXuBiao.print();</span><br><span class=\"line\">        shunXuBiao.add(<span class=\"number\">0</span>, <span class=\"number\">20</span>);</span><br><span class=\"line\">        shunXuBiao.print();</span><br><span class=\"line\">        shunXuBiao.remove(<span class=\"number\">1</span>);</span><br><span class=\"line\">        shunXuBiao.print();</span><br><span class=\"line\">        shunXuBiao.clearAll();</span><br><span class=\"line\">        shunXuBiao.add(<span class=\"number\">30</span>);</span><br><span class=\"line\">        shunXuBiao.print();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">print</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-------------------&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; size; i++) &#123;</span><br><span class=\"line\">            System.out.printf(<span class=\"string\">&quot;%s\\t&quot;</span>, array[i]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        System.out.println();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-------------------&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 定义容量</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> capacity</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ShunXuBiao</span><span class=\"params\">(<span class=\"keyword\">int</span> capacity)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.array = <span class=\"keyword\">new</span> Object[capacity];</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.size = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.length = capacity;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ShunXuBiao</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>(DEFAULT_CAPACITY);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 清空顺序表</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clearAll</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.size = <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 顺序表元素个数</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">size</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 添加元素</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> element</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">add</span><span class=\"params\">(T element)</span> </span>&#123;</span><br><span class=\"line\">        ensureCapacity();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (size &lt; array.length) &#123;</span><br><span class=\"line\">            array[size] = element;</span><br><span class=\"line\">            size++;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;已超过数组容量&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 指定位置添加元素</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> index</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> element</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">add</span><span class=\"params\">(<span class=\"keyword\">int</span> index, T element)</span> </span>&#123;</span><br><span class=\"line\">        ensureCapacity();</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (index &lt; size &amp;&amp; size &lt; array.length) &#123;</span><br><span class=\"line\"><span class=\"comment\">//            Object[] oldArray = Arrays.copyOf(array, array.length);</span></span><br><span class=\"line\"><span class=\"comment\">//            array[index] = element;</span></span><br><span class=\"line\"><span class=\"comment\">//            for (int i = index; i &lt; size; i++) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//                array[i + 1] = oldArray[i];</span></span><br><span class=\"line\"><span class=\"comment\">//            &#125;</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = size - <span class=\"number\">1</span>; i &gt;= index; i--) &#123;</span><br><span class=\"line\">                array[i + <span class=\"number\">1</span>] = array[i]; <span class=\"comment\">// 节点后移</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            array[index] = element;</span><br><span class=\"line\">            size++;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;数组下标越界&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 自动扩容</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ensureCapacity</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (size &gt;= length) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 容量增加一倍</span></span><br><span class=\"line\">            length = length &lt;&lt; <span class=\"number\">1</span>;</span><br><span class=\"line\">            array = Arrays.copyOf(array, length);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 删除指定元素</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> index</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">remove</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (index &lt; size) &#123;</span><br><span class=\"line\"><span class=\"comment\">//            Object[] oldArray = Arrays.copyOf(array, array.length);</span></span><br><span class=\"line\"><span class=\"comment\">//            for (int i = index; i &lt; size; i++) &#123;</span></span><br><span class=\"line\"><span class=\"comment\">//                array[i] = oldArray[i + 1];</span></span><br><span class=\"line\"><span class=\"comment\">//            &#125;</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = index; i &lt; size-<span class=\"number\">1</span>; i++) &#123;</span><br><span class=\"line\">                array[i] = array[i + <span class=\"number\">1</span>];  <span class=\"comment\">// 节点前移</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            array[size - <span class=\"number\">1</span>] = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            size--;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取数据</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> index</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> T <span class=\"title\">get</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (index &lt; size) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> (T) array[index];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;数组越界&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 判断是否为空</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isEmpty</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> size == <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"链表\"><a href=\"#链表\" class=\"headerlink\" title=\"链表\"></a>链表</h3><p>  链表是采用动态存储分配的一种结构，可以根据需要申请内存单元。链表中每个节点都包含两部分，一部分是实际数据，一部分是下一节点的地址，操作链表时，需定义一个头指针变量，该变量指向链表的第一个节点，第一个节点又指向第二个节点，直到最后一个节点。最后一个节点不在指向其他节点，称为表尾，在表尾的地址部分放一个NULL，表示空指针，链表到此结束。</p>\n<p>  单向链表每个节点中只包含一个指针，双向链表每个节点包含两个指针，一个指向上一节点，一个指向下一节点</p>\n<p>  根据链接方式不同，链表分为单链表、循环链表、循环链表、双向链表。</p>\n<p>  JAVA的LinkedList实现原理就是链表，单向链表实际上是由节点(Node)组成的，一个链表拥有不定数量的节点，数据在内存中存储时不连续，存储的数据分散在内存中，每个节点只能也只有它能知道下一节点的存储位置。由N个Node组成单向链表，每个Node记录本Node的数据和下一个Node。向外暴露的只有一个头节点(Head)</p>\n  <figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LianBiao</span>&lt;<span class=\"title\">E</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        LianBiao&lt;Integer&gt; lianBiao = <span class=\"keyword\">new</span> LianBiao&lt;&gt;();</span><br><span class=\"line\">        lianBiao.addElement(<span class=\"number\">10</span>);</span><br><span class=\"line\">        lianBiao.addElement(<span class=\"number\">20</span>);</span><br><span class=\"line\">        lianBiao.print();</span><br><span class=\"line\">        lianBiao.deleteElement(<span class=\"number\">0</span>);</span><br><span class=\"line\">        lianBiao.print();</span><br><span class=\"line\">        lianBiao.addElement(<span class=\"number\">30</span>);</span><br><span class=\"line\">        lianBiao.print();</span><br><span class=\"line\">        lianBiao.addElement(<span class=\"number\">40</span>);</span><br><span class=\"line\">        lianBiao.deleteElement(<span class=\"number\">1</span>);</span><br><span class=\"line\">        lianBiao.print();</span><br><span class=\"line\">        System.out.println(lianBiao.getElement(<span class=\"number\">0</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    Node&lt;E&gt; head = <span class=\"keyword\">null</span>;<span class=\"comment\">//头节点</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> length = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 添加元素</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> element</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addElement</span><span class=\"params\">(E element)</span> </span>&#123;</span><br><span class=\"line\">        Node&lt;E&gt; newNode = <span class=\"keyword\">new</span> Node&lt;&gt;(element);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (head == <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// 如果是空链表，添加到头节点</span></span><br><span class=\"line\">            head = newNode;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Node&lt;E&gt; temp = head;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (temp.next != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                temp = temp.next;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            temp.next = newNode;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        length++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 删除第index个节点</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> index</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">deleteElement</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (index &lt; <span class=\"number\">0</span> || index &gt;= length) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;数组越界，无法删除&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 去除原本头节点  头节点指向下一节点</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (index == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            head = head.next;</span><br><span class=\"line\">            length--;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> count = <span class=\"number\">1</span>;</span><br><span class=\"line\">            Node&lt;E&gt; preNode = head;</span><br><span class=\"line\">            Node&lt;E&gt; curNode = preNode.next;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (curNode != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (index == count) &#123;</span><br><span class=\"line\">                    curNode = curNode.next;</span><br><span class=\"line\">                    preNode.next = curNode;</span><br><span class=\"line\">                    length--;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    preNode = curNode;</span><br><span class=\"line\">                    curNode = curNode.next;</span><br><span class=\"line\">                    count++;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 获取第index个节点数据</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> index</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> E <span class=\"title\">getElement</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (index &lt; <span class=\"number\">0</span> || index &gt; length) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;数组越界，无法获取&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (index == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> head.data;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Node&lt;E&gt; curNode = head;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> count = <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (curNode != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (count == index) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> curNode.data;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                curNode = curNode.next;</span><br><span class=\"line\">                count++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">print</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;------------------------&quot;</span>);</span><br><span class=\"line\">        Node&lt;E&gt; temp = head;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (temp != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            System.out.printf(<span class=\"string\">&quot;%s\\t&quot;</span>, temp.data);</span><br><span class=\"line\">            temp = temp.next;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        System.out.println();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;------------------------&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Node</span>&lt;<span class=\"title\">E</span>&gt; </span>&#123;</span><br><span class=\"line\">        E data;</span><br><span class=\"line\">        Node&lt;E&gt; next;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Node</span><span class=\"params\">(E data)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.data = data;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"队列\"><a href=\"#队列\" class=\"headerlink\" title=\"队列\"></a>队列</h2><p>  队列是一种特殊的线性表，只允许在表的前端进行删除操作(队头)，在表的后端进行插入操作(队尾)。当队列中没有元素时，称为空队列。先进先出(First In First Out,FIFO)的结构</p>\n<h2 id=\"栈\"><a href=\"#栈\" class=\"headerlink\" title=\"栈\"></a>栈</h2><p>  栈是一种线性表的特殊表现形式，按照后进先出(Last In First Out，LIFO)原则处理数据，在栈中只能在一端进行操作，该操作端称为栈顶，另一端称为栈底。</p>\n<p>  基本操作：</p>\n<ul>\n<li>入栈(Push)  将数据保存到栈顶。进行该操作时，先修改栈顶指针，使其向上移一个元素位置，然后将数据保存到栈顶指针所指的位置</li>\n<li>出栈(Pop)  将栈顶的数据弹出，然后修改栈顶指针，使其指向栈中的下一个元素</li>\n</ul>\n<h1 id=\"非线性结构\"><a href=\"#非线性结构\" class=\"headerlink\" title=\"非线性结构\"></a>非线性结构</h1><h2 id=\"树\"><a href=\"#树\" class=\"headerlink\" title=\"树\"></a>树</h2><p>线性表、队列、栈都是线性的，这个数据结构不能反映元素之间的层次特性。使用树形结构来描述数据之间的关系。</p>\n<h3 id=\"树的定义\"><a href=\"#树的定义\" class=\"headerlink\" title=\"树的定义\"></a>树的定义</h3><p>树是n个节点的集合，集合中有一个称为根(root)的特殊节点，在根节点下分布着一些互不相交的集合，每一个集合又是一个树，这些树称为根节点的子树。</p>\n<ul>\n<li><p>在一棵树中，有且仅有一个节点没有前驱，这个节点就是树的根节点</p>\n</li>\n<li><p>除根节点外，其余每个节点有且仅有一个前驱</p>\n</li>\n<li><p>每个前驱可以有任意多个后继</p>\n</li>\n</ul>\n<h3 id=\"相关术语\"><a href=\"#相关术语\" class=\"headerlink\" title=\"相关术语\"></a>相关术语</h3><ul>\n<li><p>父节点、子节点、兄弟节点   每个节点的子树的根称为该节点的子节点，相应的，该节点被称为子节点的父节点，具有同一父节点的节点称为兄弟节点</p>\n</li>\n<li><p>节点的度  一个节点的子树的数量称为该节点的度</p>\n</li>\n<li><p>树的度   一棵树的度值该树中节点的最大度数</p>\n</li>\n<li><p>叶节点和分支节点   树中度为0的节点称为叶节点或终端节点。树中度不为0的节点称为分支节点</p>\n</li>\n<li><p>节点的层数   每个节点都处在一定的层次上，从树根开始计算，根节点为第一层，依次向下</p>\n</li>\n<li><p>树的深度   一棵树中节点的最大层数称为树的深度</p>\n</li>\n<li><p>有序树和无序树   若树中各节点的子树(兄弟节点)是按照一定次序从左到右排列的，称为有序树，否则称为无序树</p>\n</li>\n<li><p>森林  多个互不相交的树的集合</p>\n</li>\n</ul>\n<h3 id=\"二叉树\"><a href=\"#二叉树\" class=\"headerlink\" title=\"二叉树\"></a>二叉树</h3><p>二叉树任意节点最多只能有两个子节点；如果只有一个子节点，可以是左子树，也可以是右子树，二叉树的度最大为2，二叉树是有序树</p>\n<ul>\n<li>满二叉树  在二叉树中，除最下一层的叶节点外，每层的节点都有两个子节点，就构成了满二叉树</li>\n<li>完全二叉树   除二叉树最后一层外，其他各层的节点数都达到最大个数，且最后一层从左到右的叶节点连续存在，只缺右侧若干节点，就是完全二叉树</li>\n<li>满二叉树肯定是完全二叉树，而完全二叉树不一定是满二叉树</li>\n</ul>\n","categories":["数据结构与算法"],"tags":["数据结构与算法"]},{"title":"算法简介","url":"/2021/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95%E7%AE%80%E4%BB%8B/","content":"<h2 id=\"算法简介\"><a href=\"#算法简介\" class=\"headerlink\" title=\"算法简介\"></a>算法简介</h2><p>算法具有五个特征</p>\n<ul>\n<li>有限性   一个算法在经过有限的步骤后必然停止</li>\n<li>确定性   一个算法的每一个步骤必须精确地定义，要执行的每一步必须都没有歧义</li>\n<li>输入      一个算法有零个或多个输入</li>\n<li>输出      一个算法有一个或多个输出</li>\n<li>可行性  所有有的运算必须是充分基本的</li>\n</ul>\n<a id=\"more\"></a>\n\n","categories":["算法"],"tags":["算法"]},{"title":"日志框架","url":"/2021/%E6%97%A5%E5%BF%97/%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6/","content":"<h2 id=\"日志框架\"><a href=\"#日志框架\" class=\"headerlink\" title=\"日志框架\"></a>日志框架</h2><p>现在市面上的日志框架有很多，许多人不知道选什么，而且有时候问起某些人用的是什么日志框架，也说不出个所以然来，现在的日志组件主要分为两类，一类为<strong>日志接口</strong>，一类为<strong>日志实现</strong>。</p>\n<h3 id=\"日志接口\"><a href=\"#日志接口\" class=\"headerlink\" title=\"日志接口\"></a>日志接口</h3><p>主要有两个，commons-logging(jcl)、slf4j</p>\n<a id=\"more\"></a>\n\n<h4 id=\"对应依赖\"><a href=\"#对应依赖\" class=\"headerlink\" title=\"对应依赖\"></a>对应依赖</h4><h5 id=\"commons-logging-jcl\"><a href=\"#commons-logging-jcl\" class=\"headerlink\" title=\"commons-logging(jcl)\"></a>commons-logging(jcl)</h5><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>commons-logging<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>commons-logging<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.2<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h5 id=\"slf4j\"><a href=\"#slf4j\" class=\"headerlink\" title=\"slf4j\"></a>slf4j</h5><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-api<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.30<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"作用\"><a href=\"#作用\" class=\"headerlink\" title=\"作用\"></a>作用</h4><p>日志接口的作用就是为了提供统一的接口，这样在进行底层日志实现的替换时不需要调整代码，只需要调整依赖以及日志实现的配置文件即可。而如果不使用日志接口，直接在代码中使用日志实现去编写的话，那么之后想要更换日志系统将十分麻烦</p>\n<h3 id=\"日志实现\"><a href=\"#日志实现\" class=\"headerlink\" title=\"日志实现\"></a>日志实现</h3><p>主要有四个，logging(juc)、log4j、log4j2、logback</p>\n<h4 id=\"对应依赖-1\"><a href=\"#对应依赖-1\" class=\"headerlink\" title=\"对应依赖\"></a>对应依赖</h4><h5 id=\"logging-juc\"><a href=\"#logging-juc\" class=\"headerlink\" title=\"logging(juc)\"></a>logging(juc)</h5><p>这是jdk自带的日志实现，在java.util.logging包下</p>\n<h5 id=\"log4j\"><a href=\"#log4j\" class=\"headerlink\" title=\"log4j\"></a>log4j</h5><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>log4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>log4j<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.2.17<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"log4j2\"><a href=\"#log4j2\" class=\"headerlink\" title=\"log4j2\"></a>log4j2</h5><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.logging.log4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>log4j-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.11.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"logback\"><a href=\"#logback\" class=\"headerlink\" title=\"logback\"></a>logback</h5><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>ch.qos.logback<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>logback-classic<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.2.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"组件集成\"><a href=\"#组件集成\" class=\"headerlink\" title=\"组件集成\"></a>组件集成</h3><p>在使用日志接口和日志实现集成时，主要麻烦的就是依赖的引入了，别的都还是挺简单的，目前来说就是日志接口使用最多的还是slf4j，下面就来展示一下slf4j和日志实现的集成</p>\n<h4 id=\"slf4j与logging的集成\"><a href=\"#slf4j与logging的集成\" class=\"headerlink\" title=\"slf4j与logging的集成\"></a>slf4j与logging的集成</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- slf4j与logging的集成 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-api<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.30<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-jdk14<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.30<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"slf4j与log4j的集成\"><a href=\"#slf4j与log4j的集成\" class=\"headerlink\" title=\"slf4j与log4j的集成\"></a>slf4j与log4j的集成</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- slf4j与log4j的集成 --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- slf4j依赖 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-api<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.30<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- slf4j和log4j的桥接 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-log4j12<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.30<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- log4j依赖 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>log4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>log4j<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.2.17<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"slf4j与log4j2的集成\"><a href=\"#slf4j与log4j2的集成\" class=\"headerlink\" title=\"slf4j与log4j2的集成\"></a>slf4j与log4j2的集成</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- slf4j与log4j2的集成 --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- slf4j依赖 可以不用该依赖，log4j-slf4j-impl中有--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-api<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.25<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- slf4j和log4j2的桥接 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.logging.log4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>log4j-slf4j-impl<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.11.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- log4j2依赖 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.logging.log4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>log4j-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.11.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"slf4j与logback的集成\"><a href=\"#slf4j与logback的集成\" class=\"headerlink\" title=\"slf4j与logback的集成\"></a>slf4j与logback的集成</h4><p>logback默认就已经与slf4j集成了，可以不用加slf4j的依赖，直接就可以使用</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- slf4j与logback的集成 --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- slf4j依赖 可以不用该依赖，logback-classic中有--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.slf4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>slf4j-api<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.7.25<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- logback依赖 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>ch.qos.logback<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>logback-classic<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.2.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>","categories":["日志"],"tags":["日志"]},{"title":"协议","url":"/2020/%E7%BD%91%E7%BB%9C/%E5%8D%8F%E8%AE%AE/","content":"<h2 id=\"协议\"><a href=\"#协议\" class=\"headerlink\" title=\"协议\"></a>协议</h2><h3 id=\"TCP\"><a href=\"#TCP\" class=\"headerlink\" title=\"TCP\"></a>TCP</h3><a id=\"more\"></a>\n\n<ul>\n<li>使用TCP协议之前，先建立TCP连接，形成传输数据通道</li>\n<li>出啊书签，采用<strong>三次握手</strong>方式，是可靠的连接</li>\n<li>TCP协议进行通信的两个应用进程：客户端、服务端</li>\n<li>在连接中可进行大数据量的传输</li>\n<li>传输完毕，需释放已建立的连接，效率低</li>\n</ul>\n<h3 id=\"UDP\"><a href=\"#UDP\" class=\"headerlink\" title=\"UDP\"></a>UDP</h3><ul>\n<li>将数据、源、目的封装成数据包，不需要建立连接</li>\n<li>每个数据报的大小限制在64K内</li>\n<li>由于无需连接，所以是不可靠的连接</li>\n<li>发送数据结束时无需释放资源，速度快</li>\n</ul>\n","categories":["网络"],"tags":["网络"]},{"title":"JWT介绍","url":"/2021/javaweb/JWT/JWT%E4%BB%8B%E7%BB%8D/","content":"<h2 id=\"JWT介绍\"><a href=\"#JWT介绍\" class=\"headerlink\" title=\"JWT介绍\"></a>JWT介绍</h2><p>JWT由三部分组成</p>\n<ul>\n<li>头部(header)</li>\n<li>载荷(payload)</li>\n<li>签证(signature)</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"头部\"><a href=\"#头部\" class=\"headerlink\" title=\"头部\"></a>头部</h3><p>头部包含两个信息</p>\n<ul>\n<li>声明类型</li>\n<li>声明加密算法</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;alg&quot;</span>: <span class=\"string\">&quot;HS256&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;typ&quot;</span>: <span class=\"string\">&quot;JWT&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"载荷\"><a href=\"#载荷\" class=\"headerlink\" title=\"载荷\"></a>载荷</h3><p>就是具体存放的消息内容</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;sub&quot;</span>: <span class=\"string\">&quot;1234567890&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;name&quot;</span>: <span class=\"string\">&quot;John Doe&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;iat&quot;</span>: <span class=\"number\">1516239022</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"签证\"><a href=\"#签证\" class=\"headerlink\" title=\"签证\"></a>签证</h3><figure class=\"highlight\"><table><tr><td class=\"code\"><pre><span class=\"line\">HMACSHA256(</span><br><span class=\"line\">  base64UrlEncode(header) + &quot;.&quot; +</span><br><span class=\"line\">  base64UrlEncode(payload),</span><br><span class=\"line\">  </span><br><span class=\"line\">your-256-bit-secret</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n<p>由三部分组成</p>\n<ul>\n<li>base64加密后的header</li>\n<li>base64加密后的payload</li>\n<li>秘钥</li>\n</ul>\n","categories":["javaweb"],"tags":["javaweb"]},{"title":"启动Tomcat时出现其他无关的项目","url":"/2020/javaweb/%E9%97%AE%E9%A2%98/web%E9%A1%B9%E7%9B%AE%E4%B9%8B%E5%90%AF%E5%8A%A8tomcat%E5%87%BA%E7%8E%B0%E6%97%A0%E5%85%B3%E9%A1%B9%E7%9B%AE/","content":"<p>解决方案：</p>\n<p>应该是tomcat以前部署的项目有残留，删除掉webapps里面的其他项目，删除掉work文件夹下Catalina下localhost文件夹里其他的项目，删除掉conf文件夹下Catalina下localhost文件夹下的其他项目配置，最后如果还是不行，查看一下conf下的server.xml里是不是有其他项目残留的配置</p>\n","categories":["javaweb"],"tags":["javaweb"]},{"title":"单元测试数据库回滚问题","url":"/2020/javaweb/%E9%97%AE%E9%A2%98/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98/","content":"<p>问题现象： 在进行单元测试时，测试执行成功，可是数据库中的数据没变</p>\n<p>问题解决：单元测试自动回滚，需要加上注解Rollback(false)</p>\n","categories":["单元测试"],"tags":["java","单元测试"]},{"title":"NIO基本操作","url":"/2020/java%E5%9F%BA%E7%A1%80/IO/NIO%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/","content":"<h2 id=\"NIO\"><a href=\"#NIO\" class=\"headerlink\" title=\"NIO\"></a>NIO</h2><p>NIO早在JDK1.4中就已经提出来了(JSR51)，在JDK1.7中对NIO进行了补充类库NIO.2(JSR 203)</p>\n<p>同步非阻塞</p>\n<p><strong>阻塞与非阻塞的区别：</strong></p>\n<ul>\n<li><strong>阻塞时，在调用结果返回时，当前线程会被挂起，并在得到结果之后返回</strong></li>\n<li><strong>非阻塞时，如不能立即得到结果，该调用不会阻塞当前线程，调用者需要定时轮询查看处理状态</strong></li>\n</ul>\n<p>Channel(通道)和Buffer(缓冲区)</p>\n<a id=\"more\"></a>\n\n<h3 id=\"与普通IO的不同和关系\"><a href=\"#与普通IO的不同和关系\" class=\"headerlink\" title=\"与普通IO的不同和关系\"></a>与普通IO的不同和关系</h3><ul>\n<li><p>NIO以块的方式处理数据，但是IO是以最基础的字节流的形式去写入和读出的</p>\n</li>\n<li><p>NIO不再是和IO一样用OutputStream和InputStream输入流的形式来进行处理数据的，但是又是基于这种流的方式，采用了通道和缓冲区的形式进行处理</p>\n</li>\n<li><p>NIO的通道是可以双向的，IO的流只能是单向的</p>\n</li>\n<li><p>NIO的缓冲区(字节数组)还可以进行分片，可以建立只读缓冲区、直接缓冲区和间接缓冲区，只读缓冲区就是只可以读，直接缓冲区是为了加快I/O速度，以一种特殊的方式分配其内存的缓冲区</p>\n</li>\n<li><p>NIO采用的是多路复用的IO模型，BIO用的是阻塞的IO模型</p>\n</li>\n</ul>\n<h3 id=\"缓冲区\"><a href=\"#缓冲区\" class=\"headerlink\" title=\"缓冲区\"></a>缓冲区</h3><ul>\n<li><p>Buffer是一个对象，它包含一些要写入或者刚读出的数据。在NIO中加入Buffer对象，在流式IO中，将数据直接写入或者读到Stream对象中</p>\n</li>\n<li><p>在NIO库中，所有数据都是用缓冲区处理的。在读取数据时，它是直接读到缓冲区中的。在写入数据时，它是写入到缓冲区的。任何时候访问NIO中的数据，都需要将它放到缓冲区中</p>\n</li>\n<li><p>缓冲区实质上是一个数组。通常它是一个字节数组，但是也可以使用其他种类的数组。但是一个缓冲区不仅仅是一个数组，缓冲区提供了对数据的结构化访问，而且还可以跟踪系统的读/写进程</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">ByteBuffer</span><br><span class=\"line\">CharBuffer</span><br><span class=\"line\">ShortBuffer</span><br><span class=\"line\">IntBuffer</span><br><span class=\"line\">LongBuffer</span><br><span class=\"line\">FloatBuffer</span><br><span class=\"line\">DoubleBuffer</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"重要变量及方法\"><a href=\"#重要变量及方法\" class=\"headerlink\" title=\"重要变量及方法\"></a>重要变量及方法</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//标记位置</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> mark = -<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"comment\">//当前进行读写操作的数据元素的位置</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> position = <span class=\"number\">0</span>;</span><br><span class=\"line\"><span class=\"comment\">//缓冲区数组中进行读写操作的最大允许位置，limit&lt;=capacity</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> limit;</span><br><span class=\"line\"><span class=\"comment\">//缓冲区数组的总长度，创建时指定的</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> capacity;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">capacity</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> capacity;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">position</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> position;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Buffer <span class=\"title\">position</span><span class=\"params\">(<span class=\"keyword\">int</span> newPosition)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((newPosition &gt; limit) || (newPosition &lt; <span class=\"number\">0</span>))</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException();</span><br><span class=\"line\">    position = newPosition;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mark &gt; position) mark = -<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">limit</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> limit;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Buffer <span class=\"title\">limit</span><span class=\"params\">(<span class=\"keyword\">int</span> newLimit)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((newLimit &gt; capacity) || (newLimit &lt; <span class=\"number\">0</span>))</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException();</span><br><span class=\"line\">    limit = newLimit;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (position &gt; newLimit) position = newLimit;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mark &gt; newLimit) mark = -<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">&#125;    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 将当前位置进行标记</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Buffer <span class=\"title\">mark</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    mark = position;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 使用reset方法可以将读写位置回到mark的位置上</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Buffer <span class=\"title\">reset</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> m = mark;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (m &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidMarkException();</span><br><span class=\"line\">    position = m;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//将读写位置置为0</span></span><br><span class=\"line\"><span class=\"comment\">// 读写限制为容量</span></span><br><span class=\"line\"><span class=\"comment\">// 标记恢复-1</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Buffer <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    position = <span class=\"number\">0</span>;</span><br><span class=\"line\">    limit = capacity;</span><br><span class=\"line\">    mark = -<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 将读写限制设为当前位置</span></span><br><span class=\"line\"><span class=\"comment\">// 读写位置设为0</span></span><br><span class=\"line\"><span class=\"comment\">// 标记恢复-1</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Buffer <span class=\"title\">flip</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    limit = position;</span><br><span class=\"line\">    position = <span class=\"number\">0</span>;</span><br><span class=\"line\">    mark = -<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 读写位置设为0</span></span><br><span class=\"line\"><span class=\"comment\">// 标记恢复-1</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> Buffer <span class=\"title\">rewind</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    position = <span class=\"number\">0</span>;</span><br><span class=\"line\">    mark = -<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"通道\"><a href=\"#通道\" class=\"headerlink\" title=\"通道\"></a>通道</h3><p>通道是对原I/O包中的流的模拟。到任何目的地的所有数据都必须通过一个Channel对象(通道)。一个Buffer实质上就是一个容器对象。发送给一个通道的所有对象都必须首先放到缓冲区中；从通道中读取的任何数据都要读到缓冲区中</p>\n<p>有两个比较重要的通道，文件通道和套接字通道</p>\n<h4 id=\"文件通道\"><a href=\"#文件通道\" class=\"headerlink\" title=\"文件通道\"></a>文件通道</h4><h5 id=\"FileChannel的创建\"><a href=\"#FileChannel的创建\" class=\"headerlink\" title=\"FileChannel的创建\"></a>FileChannel的创建</h5><p>主要有两个方式</p>\n<h6 id=\"第一种方式\"><a href=\"#第一种方式\" class=\"headerlink\" title=\"第一种方式\"></a>第一种方式</h6><p>使用FileChannel.open()方法创建</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> FileChannel <span class=\"title\">open</span><span class=\"params\">(Path path, OpenOption... options)</span></span></span><br><span class=\"line\"><span class=\"function\">    <span class=\"keyword\">throws</span> IOException</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 第一个参数为文件路径</span></span><br><span class=\"line\"><span class=\"comment\">// 余下的参数为打开文件的选项 是一个可变参数，可以传多个模式</span></span><br><span class=\"line\">FileChannel.open(Paths.get(FILE), StandardOpenOption.READ,StandardOpenOption.CREATE,StandardOpenOption.WRITE);</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"第二种方式\"><a href=\"#第二种方式\" class=\"headerlink\" title=\"第二种方式\"></a>第二种方式</h6><p>使用文件流来创建</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">FileChannel fileChannel = <span class=\"keyword\">new</span> FileOutputStream(FILE).getChannel()</span><br><span class=\"line\">  </span><br><span class=\"line\">FileChannel fileChannel = <span class=\"keyword\">new</span> RandomAccessFile(FILE,<span class=\"string\">&quot;rw&quot;</span>).getChannel()</span><br><span class=\"line\">  </span><br><span class=\"line\">FileChannel fileChannel = <span class=\"keyword\">new</span> FileInputStream(FILE).getChannel()</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"文件传输\"><a href=\"#文件传输\" class=\"headerlink\" title=\"文件传输\"></a>文件传输</h5><p>可以直接使用transferFrom、transferTo传输方法来快速的传输数据</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 从src源通道中的数据写入当前文件通道</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">long</span> <span class=\"title\">transferFrom</span><span class=\"params\">(ReadableByteChannel src,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                  <span class=\"keyword\">long</span> position, <span class=\"keyword\">long</span> count)</span></span></span><br><span class=\"line\"><span class=\"function\">    <span class=\"keyword\">throws</span> IOException</span>;</span><br><span class=\"line\"><span class=\"comment\">// 从当前文件通道中的数据写入target通道</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">long</span> <span class=\"title\">transferTo</span><span class=\"params\">(<span class=\"keyword\">long</span> position, <span class=\"keyword\">long</span> count,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                    WritableByteChannel target)</span></span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"keyword\">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"套接字通道\"><a href=\"#套接字通道\" class=\"headerlink\" title=\"套接字通道\"></a>套接字通道</h4><p>在之前使用套接字时通常使用Socket和ServerSocket来进行网络编程，ServerSocket使用accept进行端口监听，但是使用accept时会处于阻塞状态，一直等待客户端程序的连接请求，严重影响到系统的性能和吞吐量</p>\n<p>在NIO中提供了NetworkChannel接口来进行套接字通道</p>\n<p>客户端、服务端分别使用SocketChannel和ServerSocketChannel来创建通道，其提高性能和吞吐量的核心在于多路复用器，也就是Selector</p>\n<h3 id=\"选择器\"><a href=\"#选择器\" class=\"headerlink\" title=\"选择器\"></a>选择器</h3><p>Selector是多路复用器，用于同时检测多个通道的事件以实现异步I/O。</p>\n<p>通过一个选择器来同时对多个套接字通道进行监听，当套接字通道有可用的事件的时候，通道改为可用状态，选择器就可以实现可用的状态。</p>\n<h3 id=\"工作原理\"><a href=\"#工作原理\" class=\"headerlink\" title=\"工作原理\"></a>工作原理</h3><p>客户端—–》Channel—–》Selector——》keys–状态改变—》server</p>\n<p>Buffer  缓冲区<br>Channel 通道<br>Selector  选择器</p>\n<p>Server端创建ServerSocketChannel    有一个Selector多路复用器  轮询所有注册的通道，根据通道状态，执行相关操作</p>\n<ul>\n<li>Connect  连接状态</li>\n<li>Accept   阻塞状态</li>\n<li>Read     可读状态</li>\n<li>Write    可写状态</li>\n</ul>\n<p>Client端创建SocketChannel  注册到Server端的Selector </p>\n<h3 id=\"ByteBuffer\"><a href=\"#ByteBuffer\" class=\"headerlink\" title=\"ByteBuffer\"></a>ByteBuffer</h3><p>有且仅有ByteBuffer(字节缓冲区)可以直接与通道交互。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//生成FileChannel文件通道  FileChannel的操作--&gt; 操作ByteBuffer用于读写，并独占式访问和锁定文件区域</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 写入文件</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>(FileChannel fileChannel = <span class=\"keyword\">new</span> FileOutputStream(FILE).getChannel())&#123;</span><br><span class=\"line\">        fileChannel.write(ByteBuffer.wrap(<span class=\"string\">&quot;test&quot;</span>.getBytes()));</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;写入文件失败&quot;</span>,e);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 在文件结尾写入</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>(FileChannel fileChannel = <span class=\"keyword\">new</span> RandomAccessFile(FILE,<span class=\"string\">&quot;rw&quot;</span>).getChannel())&#123;</span><br><span class=\"line\">        fileChannel.position(fileChannel.size());<span class=\"comment\">//移至文件结尾</span></span><br><span class=\"line\">        fileChannel.write(ByteBuffer.wrap(<span class=\"string\">&quot;some&quot;</span>.getBytes()));</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;写入文件结尾失败&quot;</span>,e);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span>(FileChannel fileChannel = <span class=\"keyword\">new</span> FileInputStream(FILE).getChannel();</span><br><span class=\"line\">        FileChannel out = <span class=\"keyword\">new</span> FileOutputStream(<span class=\"string\">&quot;C:\\\\Users\\\\sinosoft\\\\Desktop\\\\copy.txt&quot;</span>).getChannel()</span><br><span class=\"line\">    )&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 读取操作，需要调用allocate显示分配ByteBuffer</span></span><br><span class=\"line\">        ByteBuffer byteBuffer = ByteBuffer.allocate(<span class=\"number\">1024</span>);</span><br><span class=\"line\">        <span class=\"comment\">// read之后将数据放入缓冲区</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (fileChannel.read(byteBuffer) != -<span class=\"number\">1</span>)&#123;</span><br><span class=\"line\">            byteBuffer.flip(); <span class=\"comment\">// 准备写入</span></span><br><span class=\"line\">            out.write(byteBuffer);</span><br><span class=\"line\">            byteBuffer.clear(); <span class=\"comment\">// 清空缓存区</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IOException e)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;读取文件失败&quot;</span>,e);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"内存映射文件\"><a href=\"#内存映射文件\" class=\"headerlink\" title=\"内存映射文件\"></a>内存映射文件</h3><p>内存映射文件可以创建和修改那些因为太大而无法放入内存的文件。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">RandomAccessFile tdat = <span class=\"keyword\">new</span> RandomAccessFile(<span class=\"string\">&quot;test.dat&quot;</span>, <span class=\"string\">&quot;rw&quot;</span>);</span><br><span class=\"line\">MappedByteBuffer out = tdat.getChannel().map(FileChannel.MapMode.READ_WRITE, <span class=\"number\">0</span>, length);</span><br><span class=\"line\"></span><br><span class=\"line\">或者</span><br><span class=\"line\">FileChannel fc = <span class=\"keyword\">new</span> FileInputStream(<span class=\"keyword\">new</span> File(<span class=\"string\">&quot;temp.tmp&quot;</span>)).getChannel();</span><br><span class=\"line\">IntBuffer ib = fc.map(FileChannel.MapMode.READ_ONLY,<span class=\"number\">0</span>, fc.size()).asIntBuffer();</span><br></pre></td></tr></table></figure>\n\n<p>映射文件访问比标准IO性能高很多</p>\n<h4 id=\"文件锁定\"><a href=\"#文件锁定\" class=\"headerlink\" title=\"文件锁定\"></a>文件锁定</h4><p>文件锁定可同步访问，文件锁对其他操作系统进程可见，因为java文件锁直接映射到本机操作系统锁定工具。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FileLockTest</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String FILE = <span class=\"string\">&quot;C:\\\\Users\\\\sinosoft\\\\Desktop\\\\剩余工作副本.txt&quot;</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class=\"line\">        FileChannel fileChannel = <span class=\"keyword\">new</span> FileOutputStream(FILE).getChannel();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 文件锁</span></span><br><span class=\"line\">        FileLock fileLock = fileChannel.tryLock();</span><br><span class=\"line\">        Thread thread = <span class=\"keyword\">new</span> Thread(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                FileChannel fileChannel = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    fileChannel = <span class=\"keyword\">new</span> FileOutputStream(FILE).getChannel();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (FileNotFoundException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                ByteBuffer byteBuffer = ByteBuffer.allocate(<span class=\"number\">1024</span>);</span><br><span class=\"line\">                byteBuffer.put(<span class=\"string\">&quot;aqws&quot;</span>.getBytes());</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程准备写&quot;</span>);</span><br><span class=\"line\">                    fileChannel.write(byteBuffer);</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;线程写完&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">                    e.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        thread.start();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(fileLock != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">            ByteBuffer byteBuffer = ByteBuffer.allocate(<span class=\"number\">1024</span>);</span><br><span class=\"line\">            byteBuffer.put(<span class=\"string\">&quot;aqwqdqdhwfwihfejfhi&quot;</span>.getBytes());</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;主线程睡眠&quot;</span>);</span><br><span class=\"line\">            Thread.sleep(<span class=\"number\">10000</span>);</span><br><span class=\"line\">            <span class=\"comment\">// 会报错 java.nio.channels.NonWritableChannelException</span></span><br><span class=\"line\"><span class=\"comment\">//            fileChannel.read(byteBuffer);</span></span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;主线程准备写&quot;</span>);</span><br><span class=\"line\">            fileChannel.write(byteBuffer);</span><br><span class=\"line\">            fileLock.release();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">主线程睡眠</span><br><span class=\"line\">线程准备写</span><br><span class=\"line\">java.io.IOException: 另一个程序已锁定文件的一部分，进程无法访问。</span><br><span class=\"line\">    at sun.nio.ch.FileDispatcherImpl.write0(Native Method)</span><br><span class=\"line\">    at sun.nio.ch.FileDispatcherImpl.write(FileDispatcherImpl.java:<span class=\"number\">75</span>)</span><br><span class=\"line\">    at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:<span class=\"number\">93</span>)</span><br><span class=\"line\">    at sun.nio.ch.IOUtil.write(IOUtil.java:<span class=\"number\">65</span>)</span><br><span class=\"line\">    at sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:<span class=\"number\">211</span>)</span><br><span class=\"line\">    at com.zhanghe.study.io.nio.FileLockTest$<span class=\"number\">1.</span>run(FileLockTest.java:<span class=\"number\">35</span>)</span><br><span class=\"line\">    at java.lang.Thread.run(Thread.java:<span class=\"number\">745</span>)</span><br><span class=\"line\">主线程准备写</span><br><span class=\"line\">                                                                                     </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>通过调用FileChannel上的tryLock或lock，可以获得整个文件的FileLock(SocketChannel、DatagramChannel和ServerSocketChannel不需要锁定，因为本质上就是单线程实体)</p>\n<p>tryLock()是非阻塞的，试图获取锁，若不能获取，只是从方法调用返回</p>\n<p>lock()会阻塞，直到获得锁，或者调用lock()的线程中断，或者调用lock()方法的通道关闭。</p>\n<p>使用FileLock.release()释放锁</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 锁定文件的一部分，锁住size-position区域。第三个参数指定是否共享此锁</span></span><br><span class=\"line\">tryLock(<span class=\"keyword\">long</span> position, <span class=\"keyword\">long</span> size, <span class=\"keyword\">boolean</span> shared)</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"AIO介绍","url":"/2020/java%E5%9F%BA%E7%A1%80/IO/AIO%E4%BB%8B%E7%BB%8D/","content":"<h2 id=\"AIO\"><a href=\"#AIO\" class=\"headerlink\" title=\"AIO\"></a>AIO</h2><p>异步非阻塞</p>\n<p>AIO是在NIO的基础上解决NIO的同步问题，通过调用回调函数实现对异步操作结果的获取。</p>\n<a id=\"more\"></a>","categories":["java基础"],"tags":["java基础"]},{"title":"IO操作","url":"/2020/java%E5%9F%BA%E7%A1%80/IO/java%E5%9F%BA%E7%A1%80%E4%B9%8BIO%E6%93%8D%E4%BD%9C/","content":"<p>用户进程发起请求，内核接收到请求后，从I/O设备中获取数据到buffer中，再将buffer中的数据copy到用户进程的地址空间，该用户进程获取到数据后再响应客户端。</p>\n<a id=\"more\"></a>\n\n<p>数据输入到buffer需要时间，从buffer复制数据至进程也需要时间，根据在这两段时间内等待方式不同，I/O动作可分为五种模式</p>\n<ul>\n<li>阻塞I/O（Blocking I/O）</li>\n<li>非阻塞I/O（Non-Blocking I/O）</li>\n<li>I/O复用（I/O Multiplexing）</li>\n<li>信号驱动I/O</li>\n<li>异步I/O</li>\n</ul>\n<p>java的I/O操作在类的java.io包中</p>\n<ul>\n<li><p>基于字节操作的I/O接口： InputStream和OutputStream</p>\n</li>\n<li><p>基于字符操作的I/O接口： Writer和Reader</p>\n</li>\n<li><p>基于磁盘操作的I/O接口： File</p>\n</li>\n<li><p>基于网络操作的I/O接口： Socket(网络编程，不在io包中)</p>\n</li>\n</ul>\n<h2 id=\"普通IO\"><a href=\"#普通IO\" class=\"headerlink\" title=\"普通IO\"></a>普通IO</h2><ol>\n<li><p>字节流对应原生的二进制数据</p>\n</li>\n<li><p>字符流对应字符数据，会自动处理与本地字符集之间的转换</p>\n</li>\n<li><p>缓冲流可以提高性能，通过减少底层API的调用次数来优化IO</p>\n</li>\n</ol>\n<h3 id=\"字节流\"><a href=\"#字节流\" class=\"headerlink\" title=\"字节流\"></a>字节流</h3><h4 id=\"输入流\"><a href=\"#输入流\" class=\"headerlink\" title=\"输入流\"></a>输入流</h4><img src=\"/images/java基础/IO/InputStream.png\" alt=\"InputStream\" style=\"zoom:50%;\">\n\n<h5 id=\"继承关系\"><a href=\"#继承关系\" class=\"headerlink\" title=\"继承关系\"></a>继承关系</h5><p>字节输入流都继承自InputStream，InputStream表示从不同数据源产生输入的类，这些数据源包括</p>\n<ol>\n<li>字节数组</li>\n<li>String对象</li>\n<li>文件</li>\n<li>管道，从一端输入，从另一端输出</li>\n<li>一个由其他种类的流组成的序列，然后把它们汇聚为一个流</li>\n<li>其他数据源，如Internet连接</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>类</th>\n<th>功能</th>\n<th>构造器</th>\n<th>如何使用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ByteArrayInputStream</td>\n<td>允许将内存的缓冲区当做InputStream使用</td>\n<td>缓冲区，字节将从中取出</td>\n<td>将其与FilterInputStream对象相连以提供有用接口</td>\n</tr>\n<tr>\n<td>StringBufferInputStream(已废除)</td>\n<td>将String转换为InputStream</td>\n<td>字符串。底层实现实际使用StringBuffer</td>\n<td>将其与FilterInputStream对象相连以提供有用接口</td>\n</tr>\n<tr>\n<td>FileInputStream</td>\n<td>用于从文件中读取信息</td>\n<td>字符串，表示文件名、文件或FileDescriptor对象</td>\n<td></td>\n</tr>\n<tr>\n<td>PipedInputStream</td>\n<td>产生用于写入相关PipedOutputStream的数据。实现管道化概念</td>\n<td>PipedOutputStream</td>\n<td>作为多线程中的数据源</td>\n</tr>\n<tr>\n<td>SequenceInputStream</td>\n<td>将两个或多个InputStream对象转换成一个InputStream</td>\n<td>两个InputStream对象或一个容纳InputStream对象的容器Enumeration</td>\n<td></td>\n</tr>\n<tr>\n<td>FilterInputStream</td>\n<td>抽象类，作为装饰器的接口，为其他的InputStream类提供有用的功能</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p>FilterInputStream类型子类包括以下几种</p>\n<table>\n<thead>\n<tr>\n<th>类</th>\n<th>功能</th>\n<th>构造器</th>\n<th>如何使用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>DataInputStream</td>\n<td>与DataOutputStream搭配使用，按照移植方式从流读取基本数据类型</td>\n<td>InputStream</td>\n<td>包含用于读取基本数据类型的全部接口</td>\n</tr>\n<tr>\n<td>BufferedInputStream</td>\n<td>使用它可以防止每次读取时都得进行实际写操作</td>\n<td>InputStream</td>\n<td>本质上不提供接口，只是向进程添加缓冲功能</td>\n</tr>\n<tr>\n<td>LineNumberInputStream(已废除)</td>\n<td>跟踪输入流的行号，可调用getLineNumber()和setLineNumber(int)</td>\n<td>InputStream，可以指定缓冲区大小</td>\n<td>仅增加了行号</td>\n</tr>\n<tr>\n<td>PushbackInputStream</td>\n<td>具有能弹出一个字节的缓冲区，因此可以将读到的最后一个字符回退</td>\n<td>InputStream</td>\n<td>通常作为编译器的扫描器</td>\n</tr>\n</tbody></table>\n<h5 id=\"方法介绍\"><a href=\"#方法介绍\" class=\"headerlink\" title=\"方法介绍\"></a>方法介绍</h5><h6 id=\"读取数据\"><a href=\"#读取数据\" class=\"headerlink\" title=\"读取数据\"></a>读取数据</h6><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 每次读取一个字节</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">int</span> <span class=\"title\">read</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// 使用字节数组作为缓冲区，将读到的字节填充至缓冲区中</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">read</span><span class=\"params\">(<span class=\"keyword\">byte</span> b[])</span> <span class=\"keyword\">throws</span> IOException</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// 将读到的字节填充至字节数组的指定位置上</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// off 起始位置</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// len 长度</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">read</span><span class=\"params\">(<span class=\"keyword\">byte</span> b[], <span class=\"keyword\">int</span> off, <span class=\"keyword\">int</span> len)</span> <span class=\"keyword\">throws</span> IOException</span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"关闭流\"><a href=\"#关闭流\" class=\"headerlink\" title=\"关闭流\"></a>关闭流</h6><p>使用close方法来关闭流，在1.7及之后建议使用try-with-resources语句来使用流，这样可以避免显示的调用close()方法，减少一些重复代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">close</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"跳过指定字节\"><a href=\"#跳过指定字节\" class=\"headerlink\" title=\"跳过指定字节\"></a>跳过指定字节</h6><p>可以使用skip方法来跳过指定数目的字节，相当于把流中当前读到的位置向后移动若干个字节。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">skip</span><span class=\"params\">(<span class=\"keyword\">long</span> n)</span> <span class=\"keyword\">throws</span> IOException</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意：该方法可能在向后移动的时候，没有达到指定字节就到达了流的末尾，所以并不一定会跳过指定的字节，该方法返回值为实际跳过的字节数</p>\n</blockquote>\n<h6 id=\"标记与重置\"><a href=\"#标记与重置\" class=\"headerlink\" title=\"标记与重置\"></a>标记与重置</h6><p>标记与重置方法一般联合使用，以实现流中部分内容可重复读取</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// mark方法在当前读取位置进行标记</span></span><br><span class=\"line\"><span class=\"comment\">// readlimit表示允许重复读取的字节，只能从标记的位置再次重复向后读取所指定的字节</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">mark</span><span class=\"params\">(<span class=\"keyword\">int</span> readlimit)</span></span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// reset方法将流的当前读取位置移动到上次标记的位置</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">reset</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span></span><br><span class=\"line\"><span class=\"function\">  </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// 不是所有的流都支持标记功能，需要使用该方法来判断当前流是否支持标记功能</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">markSupported</span><span class=\"params\">()</span></span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"可读字节数\"><a href=\"#可读字节数\" class=\"headerlink\" title=\"可读字节数\"></a>可读字节数</h6><p>当read方法被调用时，如果当前流中没有可用的数据，该操作就会被阻塞，available()方法就是返回当前流中还有多少字节可以读取</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">available</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"输出流\"><a href=\"#输出流\" class=\"headerlink\" title=\"输出流\"></a>输出流</h4><img src=\"/images/java基础/IO/OutputStream.png\" alt=\"OutputStream\" style=\"zoom:50%;\">\n\n<p>字节输入流都继承自OutputStream，该类决定了输出所要去的目标，字节数组、文件或管道</p>\n<table>\n<thead>\n<tr>\n<th>类</th>\n<th>功能</th>\n<th>构造器</th>\n<th>如何使用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ByteArrayOutputStream</td>\n<td>在内存中创建缓冲区。所有送往流的数据都要放置在此缓冲区</td>\n<td>缓冲区初始大小</td>\n<td>用于指定数据的目的地</td>\n</tr>\n<tr>\n<td>FileOutputStream</td>\n<td>用于将信息写入文件</td>\n<td>字符串，表示文件名、文件或FileDescriptor对象</td>\n<td></td>\n</tr>\n<tr>\n<td>PipedOutputStream</td>\n<td>任何写入其中的信息都会自动作为相关PipedInputStream的输出，实现管道化概念</td>\n<td>PipedInputStream</td>\n<td>指定用于多线程的数据的目的地</td>\n</tr>\n<tr>\n<td>FilterOutputStream</td>\n<td>抽象类，作为装饰器的接口，为其他OutputStream提供有用的功能</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p>FilterOutputStream类型子类包括</p>\n<table>\n<thead>\n<tr>\n<th>类</th>\n<th>功能</th>\n<th>构造器</th>\n<th>如何使用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>DataOutputStream</td>\n<td>与DataInputStream搭配使用，可以按照移植方式向流中写入基本数据类型</td>\n<td>OutputStream</td>\n<td>包含用于写入基本数据类型的全部接口</td>\n</tr>\n<tr>\n<td>PrintStream</td>\n<td>用于产生改格式化输出。其中DataOutputStream处理数据的存储，PrintStream处理显示</td>\n<td>OutputStream，可以用boolean值指示是否每次换行时清空缓冲区</td>\n<td>应该是对OutputStream对象的final封装</td>\n</tr>\n<tr>\n<td>BufferedOutputStream</td>\n<td>使用它以避免每次发送数据时都进行实际的写操作，可以调用flush()清空缓冲区</td>\n<td>OutputStream，可以指定缓冲区大小</td>\n<td>只是向进程添加缓冲功能</td>\n</tr>\n</tbody></table>\n<h5 id=\"方法介绍-1\"><a href=\"#方法介绍-1\" class=\"headerlink\" title=\"方法介绍\"></a>方法介绍</h5><h6 id=\"写入数据\"><a href=\"#写入数据\" class=\"headerlink\" title=\"写入数据\"></a>写入数据</h6><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 每次写入一个字节</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">write</span><span class=\"params\">(<span class=\"keyword\">int</span> b)</span> <span class=\"keyword\">throws</span> IOException</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// 使用字节数组作为缓冲区，写入整个字节数组的内容</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">write</span><span class=\"params\">(<span class=\"keyword\">byte</span> b[])</span> <span class=\"keyword\">throws</span> IOException</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// 写入字节数组的部分内容</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// off 起始位置</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// len 长度</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">write</span><span class=\"params\">(<span class=\"keyword\">byte</span> b[], <span class=\"keyword\">int</span> off, <span class=\"keyword\">int</span> len)</span> <span class=\"keyword\">throws</span> IOException</span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"关闭流-1\"><a href=\"#关闭流-1\" class=\"headerlink\" title=\"关闭流\"></a>关闭流</h6><p>使用close方法来关闭流，在1.7及之后建议使用try-with-resources语句来使用流，这样可以避免显示的调用close()方法，减少一些重复代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">close</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"刷新\"><a href=\"#刷新\" class=\"headerlink\" title=\"刷新\"></a>刷新</h6><p>flush()方法用来强制要求OutputStream对象将暂存于内部缓冲区的数据立即进行实际的写入(一般情况下不需要手动的调用该方法，在内部缓冲区填充满了之后，会自动执行实际的写入操作，在调用close()方法时也会自动调用flush()方法)</p>\n<p>有些OutputStream类中维护内部缓冲区是为了减少实际的写入操作次数，来提升性能</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">flush</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"字符流\"><a href=\"#字符流\" class=\"headerlink\" title=\"字符流\"></a>字符流</h3><img src=\"/images/java基础/IO/字符流.png\" alt=\"字符流\" style=\"zoom:50%;\">\n\n<p>InputStream和OutputStream是面向字节I/O的，而Reader和Writer则提供兼容Unicode和面向字符I/O的功能，InputStreamReader可以把InputStream转换为Reader，而OutputStreamWriter可以把OutputStream转换为Writer</p>\n<h3 id=\"RandomAccessFile类\"><a href=\"#RandomAccessFile类\" class=\"headerlink\" title=\"RandomAccessFile类\"></a>RandomAccessFile类</h3><p>适用于由大小已知的记录组成的文件，可以使用seek()将文件指针从一条记录移动到另一条记录，然后对记录进行读取和修改。文件中记录的大小不一定相同，只要我们能确定那些记录有多大以及它们在文件中的位置即可。</p>\n<p>RandomAccessFile类不是InputStream或者OutputStream的子类，只是实现了DataInput和DataOutput接口，没有使用InputStream和OutputStream的任何功能，所有方法都是独立的，大部分为native方法</p>\n<h3 id=\"常用的IO操作\"><a href=\"#常用的IO操作\" class=\"headerlink\" title=\"常用的IO操作\"></a>常用的IO操作</h3><h4 id=\"缓冲输入文件\"><a href=\"#缓冲输入文件\" class=\"headerlink\" title=\"缓冲输入文件\"></a>缓冲输入文件</h4><p>想要打开一个文件进行字符输入，可以使用FileReader对象，然后传入一个String或者File对象作为文件名。为了提高速度，对文件进行缓冲，可以将所产生的引用传递给一个BufferedReader构造器。BufferedReader提供了lines()方法，会产生一个Stream<String>对象</String></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">read</span><span class=\"params\">(String file)</span> </span>&#123;</span><br><span class=\"line\">       <span class=\"keyword\">try</span>(BufferedReader bufferedReader = <span class=\"keyword\">new</span> BufferedReader(<span class=\"keyword\">new</span> FileReader(file)))&#123;</span><br><span class=\"line\">           String line = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">           <span class=\"keyword\">while</span>((line = bufferedReader.readLine()) != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">               System.out.println(line);</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">       &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">           <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;读取失败&quot;</span>,e);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"读取字符\"><a href=\"#读取字符\" class=\"headerlink\" title=\"读取字符\"></a>读取字符</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">read</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        StringReader stringReader = <span class=\"keyword\">new</span> StringReader(<span class=\"string\">&quot;qaw试试&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">int</span> c;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> ((c = stringReader.read()) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">            System.out.println((<span class=\"keyword\">char</span>)c);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>StringReader的read方法是以int形式返回的下一个字节，所以打印的时候类型必须转为char</p>\n<h4 id=\"格式化数据\"><a href=\"#格式化数据\" class=\"headerlink\" title=\"格式化数据\"></a>格式化数据</h4><p>要读取格式化数据，可以使用DataInputStream，是面向字节的，所以要使用InputStream类</p>\n<h4 id=\"文件输出\"><a href=\"#文件输出\" class=\"headerlink\" title=\"文件输出\"></a>文件输出</h4><p>FileWrite对象用于向文件写入数据，通常使用BufferedWriter将其包装起来增加缓冲的功能，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">try</span>(BufferedReader in = <span class=\"keyword\">new</span> BufferedReader(<span class=\"keyword\">new</span> StringReader(<span class=\"string\">&quot;1111111111111111\\n2222222222222\\n3333333333&quot;</span>));</span><br><span class=\"line\">            PrintWriter printWriter = <span class=\"keyword\">new</span> PrintWriter(<span class=\"keyword\">new</span> BufferedWriter(<span class=\"keyword\">new</span> FileWriter(<span class=\"string\">&quot;test.txt&quot;</span>)))</span><br><span class=\"line\">        )&#123;</span><br><span class=\"line\">            in.lines().forEach(printWriter :: println);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"标准IO\"><a href=\"#标准IO\" class=\"headerlink\" title=\"标准IO\"></a>标准IO</h2><p>标准输入流Systom.in、标准输出流System.out、标准错误流Sytem.err。</p>\n<p>System.out和System.err是预先包装成了PrintStream对象，但是System.in没有进行包装，属于原生的InputStream，所以在读取时需要对其进行包装</p>\n<h3 id=\"标准输入\"><a href=\"#标准输入\" class=\"headerlink\" title=\"标准输入\"></a>标准输入</h3><p>通常一行一行地读取输入，将System.in包装成BufferedReader</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> (BufferedReader bufferedReader = <span class=\"keyword\">new</span> BufferedReader(<span class=\"keyword\">new</span> InputStreamReader(System.in))) &#123;</span><br><span class=\"line\">            String line;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> ((line = bufferedReader.readLine()) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (line.equals(<span class=\"string\">&quot;end&quot;</span>)) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                System.out.println(line);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IOException e) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"重定向标准I-O\"><a href=\"#重定向标准I-O\" class=\"headerlink\" title=\"重定向标准I/O\"></a>重定向标准I/O</h3><p>System类提供了简单的静态方法调用，重定向标准输入流、标准输出流和标准错误流</p>\n<ul>\n<li><p>setIn(InputStream)</p>\n</li>\n<li><p>setOut(PrintStream)</p>\n</li>\n<li><p>setErr(PrintStream)</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span>(BufferedInputStream bufferedInputStream = <span class=\"keyword\">new</span> BufferedInputStream(<span class=\"keyword\">new</span> FileInputStream(<span class=\"string\">&quot;C:\\\\Users\\\\sinosoft\\\\Desktop\\\\剩余工作.txt&quot;</span>));</span><br><span class=\"line\">            PrintStream printStream = <span class=\"keyword\">new</span> PrintStream(<span class=\"keyword\">new</span> BufferedOutputStream(<span class=\"keyword\">new</span> FileOutputStream(<span class=\"string\">&quot;C:\\\\Users\\\\sinosoft\\\\Desktop\\\\剩余工作副本.txt&quot;</span>)))</span><br><span class=\"line\">        )&#123;</span><br><span class=\"line\">            System.setIn(bufferedInputStream);</span><br><span class=\"line\">            System.setOut(printStream);</span><br><span class=\"line\">            <span class=\"keyword\">try</span> (BufferedReader bufferedReader = <span class=\"keyword\">new</span> BufferedReader(<span class=\"keyword\">new</span> InputStreamReader(System.in))) &#123;</span><br><span class=\"line\">                String line;</span><br><span class=\"line\">                <span class=\"keyword\">while</span> ((line = bufferedReader.readLine()) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (line.equals(<span class=\"string\">&quot;end&quot;</span>)) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    System.out.println(line);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IOException e1) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">catch</span> (IOException e)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"JDBC基本操作","url":"/2020/java%E5%9F%BA%E7%A1%80/JDBC/JDBC%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/","content":"<h2 id=\"JDBC基本操作\"><a href=\"#JDBC基本操作\" class=\"headerlink\" title=\"JDBC基本操作\"></a>JDBC基本操作</h2><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> <span class=\"keyword\">user</span>(</span><br><span class=\"line\">    <span class=\"keyword\">id</span> <span class=\"built_in\">int</span> primary <span class=\"keyword\">key</span> auto_increment,</span><br><span class=\"line\">    <span class=\"keyword\">name</span> <span class=\"built_in\">varchar</span>(<span class=\"number\">50</span>)</span><br><span class=\"line\">    ) <span class=\"keyword\">ENGINE</span> = <span class=\"keyword\">InnoDB</span> <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">CHARSET</span> = utf8;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"JDBC概念\"><a href=\"#JDBC概念\" class=\"headerlink\" title=\"JDBC概念\"></a>JDBC概念</h3><p>JDBC是一个独立于特定数据库管理系统、通用的SQL数据库存取和操作的公共接口，定义了用来访问数据库的标准的Java类库</p>\n<a id=\"more\"></a>\n\n<h3 id=\"连接步骤\"><a href=\"#连接步骤\" class=\"headerlink\" title=\"连接步骤\"></a>连接步骤</h3><ul>\n<li><p>加载驱动</p>\n</li>\n<li><p>进行数据库连接</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 驱动</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String DRIVER = <span class=\"string\">&quot;com.mysql.jdbc.Driver&quot;</span>;</span><br><span class=\"line\"><span class=\"comment\">// 地址</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String URL = <span class=\"string\">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;</span><br><span class=\"line\"><span class=\"comment\">//用户名</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String USER_NAME = <span class=\"string\">&quot;root&quot;</span>;</span><br><span class=\"line\"><span class=\"comment\">// 密码</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String PSW = <span class=\"string\">&quot;123456&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> *  获取连接</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Connection <span class=\"title\">getConnection</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  Connection conn = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 加载驱动</span></span><br><span class=\"line\">    Class.forName(DRIVER);</span><br><span class=\"line\">    <span class=\"comment\">// 数据库连接</span></span><br><span class=\"line\">    conn = DriverManager.getConnection(URL,USER_NAME,PSW);</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException e) &#123;</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;加载驱动失败，请检查是否引入Jar包或者驱动名称是否正确&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;加载驱动失败，请检查是否引入Jar包或者驱动名称是否正确&quot;</span>,e);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (SQLException throwables) &#123;</span><br><span class=\"line\">    System.out.println(<span class=\"string\">&quot;连接数据库失败，请检查数据库地址，用户名，密码是否正确&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;连接数据库失败，请检查数据库地址，用户名，密码是否正确&quot;</span>,throwables);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> conn;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 关闭连接</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> conn</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">close</span><span class=\"params\">(Connection conn)</span></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(conn != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      conn.close();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (SQLException throwables) &#123;</span><br><span class=\"line\">      throwables.printStackTrace();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong><em>注意：为什么需要使用Class.forName()来加载数据库驱动</em></strong></p>\n<p>是因为在每个Driver中都包含有一个静态代码块，实际调用的是DriverManager.registerDriver(new Driver());方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Driver</span> <span class=\"keyword\">extends</span> <span class=\"title\">NonRegisteringDriver</span> <span class=\"keyword\">implements</span> <span class=\"title\">java</span>.<span class=\"title\">sql</span>.<span class=\"title\">Driver</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Driver</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            DriverManager.registerDriver(<span class=\"keyword\">new</span> Driver());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SQLException var1) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;Can&#x27;t register driver!&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"DriverManager\"><a href=\"#DriverManager\" class=\"headerlink\" title=\"DriverManager\"></a>DriverManager</h3><p>该类进行数据库驱动的管理，可以注册多个数据库驱动，根据url来动态的选择不同的数据库连接。</p>\n<h3 id=\"操作数据库\"><a href=\"#操作数据库\" class=\"headerlink\" title=\"操作数据库\"></a>操作数据库</h3><h4 id=\"Statement接口\"><a href=\"#Statement接口\" class=\"headerlink\" title=\"Statement接口\"></a>Statement接口</h4><p>使用Statement接口来操作静态的SQL语句</p>\n<h5 id=\"executeUpdate方法\"><a href=\"#executeUpdate方法\" class=\"headerlink\" title=\"executeUpdate方法\"></a>executeUpdate方法</h5><h6 id=\"添加\"><a href=\"#添加\" class=\"headerlink\" title=\"添加\"></a>添加</h6><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 插入操作</span></span><br><span class=\"line\"><span class=\"comment\">* <span class=\"doctag\">@param</span> sql</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">doInsert</span><span class=\"params\">(String sql)</span></span>&#123;</span><br><span class=\"line\">  Connection conn = getConnection();</span><br><span class=\"line\">  Statement statement = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    statement = conn.createStatement();</span><br><span class=\"line\">    <span class=\"keyword\">int</span> result = statement.executeUpdate(sql);</span><br><span class=\"line\">    System.out.println(sql+<span class=\"string\">&quot;执行成功，插入&quot;</span>+result+<span class=\"string\">&quot;条数据&quot;</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;执行失败&quot;</span>,e);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(statement != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        statement.close();</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (SQLException throwables) &#123;</span><br><span class=\"line\">        throwables.printStackTrace();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    close(conn);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"修改\"><a href=\"#修改\" class=\"headerlink\" title=\"修改\"></a>修改</h6><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 修改操作</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> sql</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">doUpdate</span><span class=\"params\">(String sql)</span></span>&#123;</span><br><span class=\"line\">        Connection conn = getConnection();</span><br><span class=\"line\">        Statement statement = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            statement = conn.createStatement();</span><br><span class=\"line\">            <span class=\"keyword\">int</span> result = statement.executeUpdate(sql);</span><br><span class=\"line\">            System.out.println(sql+<span class=\"string\">&quot;执行成功，修改&quot;</span>+result+<span class=\"string\">&quot;条数据&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;执行失败&quot;</span>,e);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(statement != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    statement.close();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (SQLException throwables) &#123;</span><br><span class=\"line\">                    throwables.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          close(conn);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"删除\"><a href=\"#删除\" class=\"headerlink\" title=\"删除\"></a>删除</h6><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 删除操作</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> sql</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">doDelete</span><span class=\"params\">(String sql)</span></span>&#123;</span><br><span class=\"line\">        Connection conn = getConnection();</span><br><span class=\"line\">        Statement statement = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            statement = conn.createStatement();</span><br><span class=\"line\">            <span class=\"keyword\">int</span> result = statement.executeUpdate(sql);</span><br><span class=\"line\">            System.out.println(sql+<span class=\"string\">&quot;执行成功，删除&quot;</span>+result+<span class=\"string\">&quot;条数据&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;执行失败&quot;</span>,e);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(statement != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    statement.close();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (SQLException throwables) &#123;</span><br><span class=\"line\">                    throwables.printStackTrace();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          close(conn);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"PreparedStatement接口\"><a href=\"#PreparedStatement接口\" class=\"headerlink\" title=\"PreparedStatement接口\"></a>PreparedStatement接口</h4><p>该接口为Statement的子接口，属于预处理操作，可以传入带有占位符的SQL，然后再进行补充占位符，索引值从1开始。</p>\n<p>可以有效地禁止SQL注入</p>\n<h5 id=\"executeUpdate方法-1\"><a href=\"#executeUpdate方法-1\" class=\"headerlink\" title=\"executeUpdate方法\"></a>executeUpdate方法</h5><h6 id=\"插入\"><a href=\"#插入\" class=\"headerlink\" title=\"插入\"></a>插入</h6><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">doPreparedInsert</span><span class=\"params\">(String name)</span></span>&#123;</span><br><span class=\"line\">  Connection conn = getConnection();</span><br><span class=\"line\">  PreparedStatement statement = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    String sql = <span class=\"string\">&quot;insert into user (name) values (?)&quot;</span>;</span><br><span class=\"line\">    statement = conn.prepareStatement(sql);</span><br><span class=\"line\">    statement.setString(<span class=\"number\">1</span>,name);</span><br><span class=\"line\">    <span class=\"keyword\">int</span> result = statement.executeUpdate();</span><br><span class=\"line\">    System.out.println(sql+<span class=\"string\">&quot;执行成功，插入&quot;</span>+result+<span class=\"string\">&quot;条数据&quot;</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;执行失败&quot;</span>,e);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(statement != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        statement.close();</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (SQLException throwables) &#123;</span><br><span class=\"line\">        throwables.printStackTrace();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    close(conn);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在创建preparedStatement对象时，有一个重载方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 第二个参数表示一个是否返回自增主键的一个biaoshi</span></span><br><span class=\"line\"><span class=\"comment\">// Statement.RETURN_GENERATED_KEYS</span></span><br><span class=\"line\"><span class=\"comment\">// Statement.NO_GENERATED_KEYS</span></span><br><span class=\"line\"><span class=\"function\">PreparedStatement <span class=\"title\">prepareStatement</span><span class=\"params\">(String sql, <span class=\"keyword\">int</span> autoGeneratedKeys)</span></span></span><br></pre></td></tr></table></figure>\n\n<p>在使用该PreparedStatement执行插入操作时，可以使用statement.getGeneratedKeys()来返回一个新生成主键的ResultSet对象，结果集中只有一列GENERATED_KEY，存放的新生成的主键值</p>\n<h6 id=\"更新\"><a href=\"#更新\" class=\"headerlink\" title=\"更新\"></a>更新</h6><p>与插入类似</p>\n<h6 id=\"删除-1\"><a href=\"#删除-1\" class=\"headerlink\" title=\"删除\"></a>删除</h6><p>与插入类似</p>\n<h4 id=\"结果集\"><a href=\"#结果集\" class=\"headerlink\" title=\"结果集\"></a>结果集</h4><p>在查询数据时，返回的是一个二维的结果集，使用ResultSet来遍历结果集</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">doQuery</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  String sql = <span class=\"string\">&quot;select * from user&quot;</span>;</span><br><span class=\"line\">  Connection conn = getConnection();</span><br><span class=\"line\">  PreparedStatement statement = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  ResultSet resultSet = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    statement = conn.prepareStatement(sql);</span><br><span class=\"line\">    resultSet = statement.executeQuery();</span><br><span class=\"line\">    <span class=\"comment\">// resultSet.next 方法  将光标向前移动一行，最初为第一行之前，第一次调用使得第一行为当前行</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> (resultSet.next())&#123;</span><br><span class=\"line\">      <span class=\"keyword\">int</span> id = resultSet.getInt(<span class=\"string\">&quot;id&quot;</span>);</span><br><span class=\"line\">      String name = resultSet.getString(<span class=\"string\">&quot;name&quot;</span>);</span><br><span class=\"line\">      System.out.println(<span class=\"string\">&quot;查询到id为&quot;</span>+id+<span class=\"string\">&quot;,name为&quot;</span>+name+<span class=\"string\">&quot;的记录&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (SQLException throwables) &#123;</span><br><span class=\"line\">    throwables.printStackTrace();</span><br><span class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(resultSet != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        resultSet.close();</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> (SQLException throwables) &#123;</span><br><span class=\"line\">        throwables.printStackTrace();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    close(conn,statement);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"批量操作\"><a href=\"#批量操作\" class=\"headerlink\" title=\"批量操作\"></a>批量操作</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">doBatchInsert</span><span class=\"params\">(String sql)</span></span>&#123;</span><br><span class=\"line\">  Connection conn = getConnection();</span><br><span class=\"line\">  PreparedStatement statement = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    statement = conn.prepareStatement(sql);</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i&lt;<span class=\"number\">1000</span>;i++)&#123;</span><br><span class=\"line\">      statement.setString(<span class=\"number\">1</span>,<span class=\"string\">&quot;张三&quot;</span>+i);</span><br><span class=\"line\">      <span class=\"comment\">// 积攒sql</span></span><br><span class=\"line\">      statement.addBatch();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 执行sql</span></span><br><span class=\"line\">    statement.executeBatch();</span><br><span class=\"line\">    <span class=\"comment\">// 清除积攒的sql</span></span><br><span class=\"line\">    statement.clearBatch();</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (SQLException throwables) &#123;</span><br><span class=\"line\">    throwables.printStackTrace();</span><br><span class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">    close(conn,statement);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n","categories":["JDBC"],"tags":["JDBC"]},{"title":"JDBC操作事务","url":"/2020/java%E5%9F%BA%E7%A1%80/JDBC/JDBC%E6%93%8D%E4%BD%9C%E4%BA%8B%E5%8A%A1/","content":"<h2 id=\"JDBC操作事务\"><a href=\"#JDBC操作事务\" class=\"headerlink\" title=\"JDBC操作事务\"></a>JDBC操作事务</h2><h3 id=\"事务\"><a href=\"#事务\" class=\"headerlink\" title=\"事务\"></a>事务</h3><p>事务的ACID</p>\n<ul>\n<li>原子性  指事务是一个不可分割的单位，事务中的操作要么都发生，要么都不发生</li>\n<li>一致性  事务必须使数据库从一个一致性状态变换成另一个一致性状态</li>\n<li>隔离性  一个事务的执行不能被其他事务干扰，各事务之间是隔离的</li>\n<li>持久性  一个事务一旦被提交，对数据库中的数据的改变就是永久的</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"JDBC操作事务-1\"><a href=\"#JDBC操作事务-1\" class=\"headerlink\" title=\"JDBC操作事务\"></a>JDBC操作事务</h3><p>可以使用JDBC来操作事务</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">conn.setAutoCommit(<span class=\"keyword\">false</span>); <span class=\"comment\">// 取消自动提交</span></span><br><span class=\"line\">conn.rollback();  <span class=\"comment\">//事务回滚</span></span><br><span class=\"line\">conn.commit(); <span class=\"comment\">//事务提交</span></span><br><span class=\"line\"></span><br><span class=\"line\">SavePoint point = conn.setSavePoint(); <span class=\"comment\">// 设置事务保存点</span></span><br><span class=\"line\">conn.rollback(point); <span class=\"comment\">// 回滚到该保存点</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"数据库隔离级别\"><a href=\"#数据库隔离级别\" class=\"headerlink\" title=\"数据库隔离级别\"></a>数据库隔离级别</h3><p>如果没有采取隔离机制的话，就会导致各种并发的数据问题</p>\n<h4 id=\"数据问题\"><a href=\"#数据问题\" class=\"headerlink\" title=\"数据问题\"></a>数据问题</h4><ul>\n<li>脏读  对于两个事务T1,T2，T1读取了已经被T2更新但还没有被提交的字段之后，若T2回滚，T1读取到的内容就是临时无效的</li>\n<li>不可重复读  对于两个事务T1,T2，T1读取了一个字段，T2更新了该字段，之后T1再次读取同一个字段，值就不同了</li>\n<li>幻读  对于两个事务T1,T2，T1从一个表中读取了一个字段，然后T2在该表中插入了一些新的行，T1再次读取同一个表，就会多出几行</li>\n</ul>\n<p>隔离级别越高，数据一致性越好，但是并发性越弱</p>\n<h4 id=\"数据库的隔离级别\"><a href=\"#数据库的隔离级别\" class=\"headerlink\" title=\"数据库的隔离级别\"></a>数据库的隔离级别</h4><ul>\n<li>READ UNCOMMITED(读未提交的数据)  允许事务读取未被其他事务提交的变更，脏读、不可重复读、幻读问题都存在</li>\n<li>READ COMMITED(读已提交的数据)  只允许事务读取已被其他事务提交的数据，可以避免脏读，但是不可重复读和幻读仍存在</li>\n<li>REPEATABLE READ(可重复读)  确保事务可以多次从一个字段中读取相同的值，在这个事务持续期间，禁止其他事务对这个字段进行更新，可以避免脏读和不可重复读，但幻读仍存在(Mysql默认的事务隔离级别)</li>\n<li>SERIALIZABLE(串行化) 确保事务可以从一个表中读取相同的行，在这个事务持续期间，禁止其他事务对该表执行插入、更新和删除操作，所有并发问题都可以避免，但是性能低下</li>\n</ul>\n<h4 id=\"JDBC设置隔离级别\"><a href=\"#JDBC设置隔离级别\" class=\"headerlink\" title=\"JDBC设置隔离级别\"></a>JDBC设置隔离级别</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// &lt;code&gt;Connection.TRANSACTION_READ_UNCOMMITTED&lt;/code&gt;,</span></span><br><span class=\"line\"><span class=\"comment\">// &lt;code&gt;Connection.TRANSACTION_READ_COMMITTED&lt;/code&gt;,</span></span><br><span class=\"line\"><span class=\"comment\">// &lt;code&gt;Connection.TRANSACTION_REPEATABLE_READ&lt;/code&gt;</span></span><br><span class=\"line\"><span class=\"comment\">// &lt;code&gt;Connection.TRANSACTION_SERIALIZABLE&lt;/code&gt;.</span></span><br><span class=\"line\">conn.setTransactionIsolation(<span class=\"keyword\">int</span>)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Mysql设置隔离级别\"><a href=\"#Mysql设置隔离级别\" class=\"headerlink\" title=\"Mysql设置隔离级别\"></a>Mysql设置隔离级别</h4><p>每个数据库连接都有一个全局变量@@tx_isolation，表示当前的事务隔离级别</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 查看当前会话的隔离级别  Mysql5.7.20之后为transaction_isolation</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> @@tx_isolation;</span><br><span class=\"line\"><span class=\"comment\">-- 查看系统的隔离级别   MySql5.7.20之后transaction_isolation</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> @@global.tx_isolation;</span><br><span class=\"line\"><span class=\"comment\">-- 设置当前连接的隔离级别</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">session</span> <span class=\"keyword\">transaction</span> <span class=\"keyword\">isolation</span> <span class=\"keyword\">level</span> <span class=\"keyword\">read</span> committed;</span><br><span class=\"line\"><span class=\"comment\">-- 设置数据库系统的全局隔离级别</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">global</span> <span class=\"keyword\">transaction</span> <span class=\"keyword\">isolation</span> <span class=\"keyword\">level</span> <span class=\"keyword\">read</span> committed;</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["JDBC"],"tags":["JDBC"]},{"title":"JDBC获取元数据","url":"/2020/java%E5%9F%BA%E7%A1%80/JDBC/JDBC%E8%8E%B7%E5%8F%96%E5%85%83%E6%95%B0%E6%8D%AE/","content":"<h2 id=\"JDBC获取元数据\"><a href=\"#JDBC获取元数据\" class=\"headerlink\" title=\"JDBC获取元数据\"></a>JDBC获取元数据</h2><p>DatabaseMetaData描述数据库的元数据，可以得到数据库本身的一些信息</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">DatabaseMetaData metaData = connection.getMetaData();</span><br><span class=\"line\"><span class=\"comment\">// 获取数据库产品的名称</span></span><br><span class=\"line\">String name = metaData.getDatabaseProductName();</span><br><span class=\"line\"><span class=\"comment\">// jdbc驱动的主版本号</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> majorVersion = metaData.getDriverMajorVersion();</span><br><span class=\"line\"><span class=\"comment\">// jdbc驱动的次版本号</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> minorVersion =  metaData.getDriverMinorVersion();</span><br><span class=\"line\"><span class=\"comment\">// 连接数据库的用户名</span></span><br><span class=\"line\">String userName = metaData.getUserName();</span><br><span class=\"line\"><span class=\"comment\">// 获取Mysql中有哪些数据库</span></span><br><span class=\"line\">ResultSet resultSet = metaData.getCatalogs();</span><br><span class=\"line\"><span class=\"comment\">// 数据库的版本号</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> databaseVersion = metaData.getDatabaseMajorVersion();</span><br></pre></td></tr></table></figure>\n\n<p>描述结果集的元数据，可以得到结果集的基本信息，可以得到结果集中有哪些列，列名，列的别名</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">ResultSetMetaData metaData = statement.getMetaData();</span><br><span class=\"line\"><span class=\"comment\">// 有多少列</span></span><br><span class=\"line\"><span class=\"keyword\">int</span> num = metaData.getColumnCount();</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">1</span>;i&lt;=num;i++)&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 获取列名称</span></span><br><span class=\"line\">  metaData.getColumnName(i);</span><br><span class=\"line\">  <span class=\"comment\">// 获取列的类型</span></span><br><span class=\"line\">  metaData.getColumnTypeName(i);</span><br><span class=\"line\">  <span class=\"comment\">// 获取列的别名(如果没有起别名，则获取到列的列名)，通常使用该方法来获取列名，而不使用getColumnName</span></span><br><span class=\"line\">  metaData.getColumnLabel(i);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["JDBC"],"tags":["JDBC"]},{"title":"数据库连接池","url":"/2020/java%E5%9F%BA%E7%A1%80/JDBC/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%B1%A0/","content":"<h2 id=\"数据库连接池\"><a href=\"#数据库连接池\" class=\"headerlink\" title=\"数据库连接池\"></a>数据库连接池</h2><p>数据库连接池的基本思想是为数据库建立一个”缓冲池”。预先在缓冲池中放入一定数量的连接，当需要建立数据库连接时，只需从”缓冲池”中取出一个，使用完毕再放入缓冲池。</p>\n<p>JDBC的数据库连接池使用javax.sql.DataSource来表示，是一个接口，该接口通常由服务器提供实现，当然也有一些优秀的开源连接池</p>\n<a id=\"more\"></a>\n\n<h3 id=\"DataSource\"><a href=\"#DataSource\" class=\"headerlink\" title=\"DataSource\"></a>DataSource</h3><p>DataSource通常被称为数据源，包含连接池和连接池管理两部分</p>\n","categories":["JDBC"],"tags":["JDBC"]},{"title":"函数式编程","url":"/2020/java%E5%9F%BA%E7%A1%80/java8/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/","content":"<h2 id=\"函数式编程\"><a href=\"#函数式编程\" class=\"headerlink\" title=\"函数式编程\"></a>函数式编程</h2><p>函数式编程强加了额外的约束，即所有数据必须是不可变的：设置一次，永不改变。将值传递给函数，该函数然后生成新值但从不修改自身外部的任何东西，不可变对象和无副作用范式解决了并发编程中最基本和最棘手的问题之一。</p>\n<a id=\"more\"></a>\n\n<p><strong>Lambda表达式只支持函数式接口，也就是只有一个抽象方法的接口</strong></p>\n<p>普通用法和函数式编程对比</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@FunctionalInterface</span> <span class=\"comment\">//用于判断是否符合函数式接口</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Interf</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">f</span><span class=\"params\">(String msg)</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">InterfImpl</span> <span class=\"keyword\">implements</span> <span class=\"title\">Interf</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">f</span><span class=\"params\">(String msg)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> msg + <span class=\"string\">&quot; 普通实现&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">static</span> String <span class=\"title\">func</span><span class=\"params\">(String msg)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> msg + <span class=\"string\">&quot; 方法引用&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Interf[] interfs = <span class=\"keyword\">new</span> Interf[]&#123;</span><br><span class=\"line\">                <span class=\"keyword\">new</span> InterfImpl(),<span class=\"comment\">//普通实现</span></span><br><span class=\"line\">                <span class=\"keyword\">new</span> Interf() &#123;</span><br><span class=\"line\">                    <span class=\"meta\">@Override</span></span><br><span class=\"line\">                    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">f</span><span class=\"params\">(String msg)</span> </span>&#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> msg + <span class=\"string\">&quot; 匿名内部类&quot;</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;,<span class=\"comment\">//匿名内部类</span></span><br><span class=\"line\">                msg -&gt; msg + <span class=\"string\">&quot; lambda&quot;</span>, <span class=\"comment\">//lambda表达式</span></span><br><span class=\"line\">                InterfImpl::func <span class=\"comment\">//方法引用</span></span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(Interf interf : interfs)&#123;</span><br><span class=\"line\">            System.out.println(interf.f(<span class=\"string\">&quot;测试lambda&quot;</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"lambda表达式\"><a href=\"#lambda表达式\" class=\"headerlink\" title=\"lambda表达式\"></a>lambda表达式</h3><p>lambda表达式，由箭头-&gt;分隔开参数和函数体，箭头左边是参数，右边是lambda返回的表达式，即函数体</p>\n<p>lambda表达式就是函数式接口的实例</p>\n<ul>\n<li>当只有一个参数，可以不用括号()</li>\n<li>如果没有参数，必须使用()表示空参数列表</li>\n<li>对于多个参数，将参数列表放在括号()中</li>\n<li>如果有多行，需要将这些行放在花括号，在这种情况下，需要使用return</li>\n</ul>\n<h3 id=\"四个内置函数式接口\"><a href=\"#四个内置函数式接口\" class=\"headerlink\" title=\"四个内置函数式接口\"></a>四个内置函数式接口</h3><h4 id=\"Consumer-消费型接口\"><a href=\"#Consumer-消费型接口\" class=\"headerlink\" title=\"Consumer 消费型接口\"></a>Consumer 消费型接口</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@FunctionalInterface</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Consumer</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">accept</span><span class=\"params\">(T t)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">default</span> Consumer&lt;T&gt; <span class=\"title\">andThen</span><span class=\"params\">(Consumer&lt;? <span class=\"keyword\">super</span> T&gt; after)</span> </span>&#123;</span><br><span class=\"line\">        Objects.requireNonNull(after);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (T t) -&gt; &#123; accept(t); after.accept(t); &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testConsumer</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  Consumer&lt;Double&gt; consumer = d -&gt; System.out.println(<span class=\"string\">&quot;花费&quot;</span>+d+<span class=\"string\">&quot;元&quot;</span>);</span><br><span class=\"line\">  consumer.accept(<span class=\"number\">1000d</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Supplier-供给型接口\"><a href=\"#Supplier-供给型接口\" class=\"headerlink\" title=\"Supplier 供给型接口\"></a>Supplier 供给型接口</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@FunctionalInterface</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Supplier</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"function\">T <span class=\"title\">get</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testSupplier</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  Supplier&lt;Integer&gt; supplier = () -&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">100</span>;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  System.out.println(supplier.get());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Function-函数型接口\"><a href=\"#Function-函数型接口\" class=\"headerlink\" title=\"Function 函数型接口\"></a>Function 函数型接口</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@FunctionalInterface</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Function</span>&lt;<span class=\"title\">T</span>, <span class=\"title\">R</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">R <span class=\"title\">apply</span><span class=\"params\">(T t)</span></span>;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"keyword\">default</span> &lt;V&gt; <span class=\"function\">Function&lt;V, R&gt; <span class=\"title\">compose</span><span class=\"params\">(Function&lt;? <span class=\"keyword\">super</span> V, ? extends T&gt; before)</span> </span>&#123;</span><br><span class=\"line\">        Objects.requireNonNull(before);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (V v) -&gt; apply(before.apply(v));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">default</span> &lt;V&gt; <span class=\"function\">Function&lt;T, V&gt; <span class=\"title\">andThen</span><span class=\"params\">(Function&lt;? <span class=\"keyword\">super</span> R, ? extends V&gt; after)</span> </span>&#123;</span><br><span class=\"line\">        Objects.requireNonNull(after);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (T t) -&gt; after.apply(apply(t));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &lt;T&gt; <span class=\"function\">Function&lt;T, T&gt; <span class=\"title\">identity</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> t -&gt; t;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testFunction</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  Function&lt;Integer,Integer&gt; function = x -&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> x*<span class=\"number\">100</span>;</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  System.out.println(function.apply(<span class=\"number\">10</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Predicate-断言型接口\"><a href=\"#Predicate-断言型接口\" class=\"headerlink\" title=\"Predicate 断言型接口\"></a>Predicate 断言型接口</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@FunctionalInterface</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Predicate</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">test</span><span class=\"params\">(T t)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">default</span> Predicate&lt;T&gt; <span class=\"title\">and</span><span class=\"params\">(Predicate&lt;? <span class=\"keyword\">super</span> T&gt; other)</span> </span>&#123;</span><br><span class=\"line\">        Objects.requireNonNull(other);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (t) -&gt; test(t) &amp;&amp; other.test(t);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">default</span> Predicate&lt;T&gt; <span class=\"title\">negate</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (t) -&gt; !test(t);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">default</span> Predicate&lt;T&gt; <span class=\"title\">or</span><span class=\"params\">(Predicate&lt;? <span class=\"keyword\">super</span> T&gt; other)</span> </span>&#123;</span><br><span class=\"line\">        Objects.requireNonNull(other);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (t) -&gt; test(t) || other.test(t);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">static</span> &lt;T&gt; <span class=\"function\">Predicate&lt;T&gt; <span class=\"title\">isEqual</span><span class=\"params\">(Object targetRef)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (<span class=\"keyword\">null</span> == targetRef)</span><br><span class=\"line\">                ? Objects::isNull</span><br><span class=\"line\">                : object -&gt; targetRef.equals(object);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testPredicate</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  Predicate&lt;String&gt; predicate = x -&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;yes&quot;</span>.equals(x);</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  System.out.println(predicate.test(<span class=\"string\">&quot;no&quot;</span>));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"递归\"><a href=\"#递归\" class=\"headerlink\" title=\"递归\"></a>递归</h3><p>递归的Lambda表达式，递归方法必须是<strong>实例变量或静态变量</strong>。</p>\n<p>计算阶乘</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@FunctionalInterface</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">IntCall</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">call</span><span class=\"params\">(<span class=\"keyword\">int</span> i)</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Recursion</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> IntCall intCall;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Recursion recursion = <span class=\"keyword\">new</span> Recursion();</span><br><span class=\"line\">        recursion.intCall = n -&gt; n == <span class=\"number\">0</span> ? <span class=\"number\">1</span> : n * recursion.intCall.call(n - <span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++)</span><br><span class=\"line\">            System.out.println(i+<span class=\"string\">&quot;! = &quot;</span>+recursion.intCall.call(i));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"方法引用\"><a href=\"#方法引用\" class=\"headerlink\" title=\"方法引用\"></a>方法引用</h3><p>java8的方法引用，由::区分，在::左边是类或对象的名称，在::的右边是方法的名称，但是没有参数列表</p>\n<p>如果lambda体的内容有方法已经实现了，可以使用方法引用</p>\n<p>方法引用其实也是lambda表达式，要求接口中的抽象方法的形参列表和返回值类型与方法引用的方法的形参列表和返回值类型相同</p>\n<p>三种语法格式<br>1、对象::实例方法<br>2、类::静态方法<br>3、类::实例方法  当lambda表达式第一个参数是实例方法的调用者，第二个参数是实例方法的参数时，可以使用</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestMethodRef</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 对象::实例方法</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">test1</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        Consumer&lt;String&gt; con =  System.out::println;</span><br><span class=\"line\">        con.accept(<span class=\"string\">&quot;aaaa&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 类::静态方法</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">test2</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        Consumer&lt;String&gt; con =  TestMethodRef::testStatic;</span><br><span class=\"line\">        con.accept(<span class=\"string\">&quot;xxxx&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 类::实例方法</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">test3</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        MyTest myTest = String::equals;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 测试无参构造器</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> TestMethodRef <span class=\"title\">test4</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        Supplier&lt;TestMethodRef&gt; supplier = TestMethodRef::<span class=\"keyword\">new</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> supplier.get();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 测试有参构造器</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> TestMethodRef <span class=\"title\">test5</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        Function&lt;Integer,TestMethodRef&gt; function = TestMethodRef::<span class=\"keyword\">new</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> function.apply(<span class=\"number\">10</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TestMethodRef</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;无参构造器调用&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> x;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TestMethodRef</span><span class=\"params\">(<span class=\"keyword\">int</span> x)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.x = x;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        test1();</span><br><span class=\"line\">        test2();</span><br><span class=\"line\">        test3();</span><br><span class=\"line\">        test4();</span><br><span class=\"line\">        TestMethodRef t = test5();</span><br><span class=\"line\">        System.out.println(t.x);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testStatic</span><span class=\"params\">(String x)</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;我输出入了&quot;</span>+x);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@FunctionalInterface</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">MyTest</span></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">test</span><span class=\"params\">(String x,String y)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"java stream操作","url":"/2020/java%E5%9F%BA%E7%A1%80/java8/java%20Stream%E6%93%8D%E4%BD%9C/","content":"<h2 id=\"java-stream操作\"><a href=\"#java-stream操作\" class=\"headerlink\" title=\"java stream操作\"></a>java stream操作</h2><h3 id=\"Stream是什么\"><a href=\"#Stream是什么\" class=\"headerlink\" title=\"Stream是什么\"></a>Stream是什么</h3><p>Stream又称为流，可以将集合转换为一种流，对集合中的每个元素进行一系列的流式操作。</p>\n<a id=\"more\"></a>\n\n<p>数据源 ——转换为–》流—-》进行中间操作—-》终止操作</p>\n<blockquote>\n<p>多个中间操作可以连接起来形成一个流水线，除非流水线触发终止操作，否则中间操作不会执行任何处理，在终止操作时一次性全部处理</p>\n</blockquote>\n<h3 id=\"转化为流\"><a href=\"#转化为流\" class=\"headerlink\" title=\"转化为流\"></a>转化为流</h3><p>使用stream()或者parallelStream()方法将集合转为流</p>\n<h3 id=\"中间操作\"><a href=\"#中间操作\" class=\"headerlink\" title=\"中间操作\"></a>中间操作</h3><h4 id=\"筛选\"><a href=\"#筛选\" class=\"headerlink\" title=\"筛选\"></a>筛选</h4><h5 id=\"filter\"><a href=\"#filter\" class=\"headerlink\" title=\"filter\"></a>filter</h5><p>过滤操作，只返回为true的数据</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// filter方法接收的是Predicate</span></span><br><span class=\"line\"><span class=\"function\">Stream&lt;T&gt; <span class=\"title\">filter</span><span class=\"params\">(Predicate&lt;? <span class=\"keyword\">super</span> T&gt; predicate)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* filter  接收lambda，从流中排除某些元素</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testFilter</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 中间操作</span></span><br><span class=\"line\">  <span class=\"comment\">// 使用的Predicate   boolean test(T t);</span></span><br><span class=\"line\">  Stream&lt;String&gt; stream = list.stream()</span><br><span class=\"line\">    .filter(e -&gt;</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">              System.out.println(<span class=\"string\">&quot;filter中间操作&quot;</span>);</span><br><span class=\"line\">              <span class=\"keyword\">return</span> e.equals(<span class=\"string\">&quot;张三&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">           );</span><br><span class=\"line\">  <span class=\"comment\">// 这时中间操作还没有执行执行</span></span><br><span class=\"line\">  System.out.println(<span class=\"string\">&quot;----中间操作结束----&quot;</span>);</span><br><span class=\"line\">  <span class=\"comment\">//终止操作：一次执行全部操作</span></span><br><span class=\"line\">  stream.forEach(</span><br><span class=\"line\">    System.out::println</span><br><span class=\"line\">  );</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"distinct\"><a href=\"#distinct\" class=\"headerlink\" title=\"distinct\"></a>distinct</h5><p>去重</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* distinct 筛选，通过流所生成元素的hashCode()和equals()方法去重</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testDistinct</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  list.stream().distinct().forEach(System.out::println);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"切片\"><a href=\"#切片\" class=\"headerlink\" title=\"切片\"></a>切片</h4><h5 id=\"limit\"><a href=\"#limit\" class=\"headerlink\" title=\"limit\"></a>limit</h5><p>返回前n个元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* limit 截断流，使其元素不超过给定数量</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testLimit</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  list.stream().limit(<span class=\"number\">2</span>).forEach(System.out::println);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"skip\"><a href=\"#skip\" class=\"headerlink\" title=\"skip\"></a>skip</h5><p>去除(跳过)前n个元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* skip 跳过元素，返回一个扔掉了前n个元素的流。若流中元素不足n个，则返回空流</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testSkip</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  list.stream().skip(<span class=\"number\">2</span>).forEach(System.out::println);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testLimitAndSkip</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  System.out.println(<span class=\"string\">&quot;--------先limit再skip---------&quot;</span>);</span><br><span class=\"line\">  list.stream().limit(<span class=\"number\">2</span>).skip(<span class=\"number\">1</span>).forEach(System.out::println);</span><br><span class=\"line\">  System.out.println(<span class=\"string\">&quot;--------先skip再limit---------&quot;</span>);</span><br><span class=\"line\">  list.stream().skip(<span class=\"number\">1</span>).limit(<span class=\"number\">2</span>).forEach(System.out::println);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>注意：在limit和skip搭配使用的时候，两个的顺序不同会导致结果不同</p>\n<ul>\n<li>先进行limit，再进行skip时，会选择前两个数据，然后再跳过第一个数据，只会筛选出一条数据</li>\n<li>先进行skip，再进行limit时，会先跳过一条数据，在选择剩下数据的前两条，最终会筛选出两条数据</li>\n</ul>\n<h4 id=\"排序\"><a href=\"#排序\" class=\"headerlink\" title=\"排序\"></a>排序</h4><h5 id=\"sorted\"><a href=\"#sorted\" class=\"headerlink\" title=\"sorted\"></a>sorted</h5><p>排序可以有两种排序方式，第一种是进行排序的类要实现Comparable接口，第二种是在自己实现一个Comparator接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * sorted()自然排序  Comparable 所要排序的类必须实现Comparable接口</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">test</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  list.stream().map(User::getAge).sorted().forEach(System.out::println);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* sorted(Comparator com) 定制排序(Comparator)</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">test1</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  list.stream().sorted(</span><br><span class=\"line\">    (o1, o2) -&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(o1.getAge() &gt; o2.getAge())&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ).forEach(System.out::println);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"映射\"><a href=\"#映射\" class=\"headerlink\" title=\"映射\"></a>映射</h4><h5 id=\"map\"><a href=\"#map\" class=\"headerlink\" title=\"map\"></a>map</h5><p>转换功能</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// map方法接收的参数为Function接口</span></span><br><span class=\"line\">&lt;R&gt; <span class=\"function\">Stream&lt;R&gt; <span class=\"title\">map</span><span class=\"params\">(Function&lt;? <span class=\"keyword\">super</span> T, ? extends R&gt; mapper)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* map 接收lambda，将元素转换为其他形式或提取信息。接收一个函数作为函数，</span></span><br><span class=\"line\"><span class=\"comment\">* 该函数会被应用到每个元素上，并将其映射成一个新的元素</span></span><br><span class=\"line\"><span class=\"comment\">*</span></span><br><span class=\"line\"><span class=\"comment\">* 如果函数返回的是一个流的话，使用map会使得流里存储着多个流</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testMap</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 使用Function  R apply(T t);</span></span><br><span class=\"line\">  list.stream().map(User::getAge).forEach(System.out::println);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h5 id=\"flatmap\"><a href=\"#flatmap\" class=\"headerlink\" title=\"flatmap\"></a>flatmap</h5><p>将多个Stream合并成一个Stream</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// flatMap方法接收的参数为Function接口</span></span><br><span class=\"line\">&lt;R&gt; <span class=\"function\">Stream&lt;R&gt; <span class=\"title\">flatMap</span><span class=\"params\">(Function&lt;? <span class=\"keyword\">super</span> T, ? extends Stream&lt;? extends R&gt;&gt; mapper)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* flatMap  接收一个函数作为参数，将流中的每个值都换成另一个流，然后把所有流连接成一个流</span></span><br><span class=\"line\"><span class=\"comment\">*</span></span><br><span class=\"line\"><span class=\"comment\">* 如果函数返回的是一个流，使用flatMap会使得函数返回的流中的元素放到一个流中</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testFlatMap</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 要求Function  R apply(T t);中返回值是一个Stream流</span></span><br><span class=\"line\">  List&lt;String&gt; add = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">  add.add(<span class=\"string\">&quot;添加元素&quot;</span>);</span><br><span class=\"line\">  List&lt;String&gt; strings = list.stream().map(User::getName).collect(Collectors.toList());</span><br><span class=\"line\">  strings.stream().flatMap(</span><br><span class=\"line\">    TestStreamApi1::joinStream</span><br><span class=\"line\">  ).forEach(System.out::println);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"终止操作\"><a href=\"#终止操作\" class=\"headerlink\" title=\"终止操作\"></a>终止操作</h3><h4 id=\"allMatch\"><a href=\"#allMatch\" class=\"headerlink\" title=\"allMatch\"></a>allMatch</h4><p>流中所有元素都要匹配给定的条件为true，否则为false    相当于且</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* allMatch测试</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testAllMatch</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">boolean</span> isSex = list.stream().allMatch(</span><br><span class=\"line\">    l -&gt; l.getSex() == <span class=\"number\">0</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  System.out.println(isSex);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"anyMatch\"><a href=\"#anyMatch\" class=\"headerlink\" title=\"anyMatch\"></a>anyMatch</h4><p>流中有任意一条数据匹配给定的条件为true，否则为false    相当于并</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* anyMatch测试</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testAnyMatch</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">boolean</span> isSex = list.stream().anyMatch(</span><br><span class=\"line\">    l -&gt; l.getSex() == <span class=\"number\">0</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  System.out.println(isSex);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"noneMatch\"><a href=\"#noneMatch\" class=\"headerlink\" title=\"noneMatch\"></a>noneMatch</h4><p>流中所有的数据都不匹配给定条件时为true，否则为false    相当于非</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* noneMatch测试</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testNoneMatch</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">boolean</span> isSex = list.stream().noneMatch(</span><br><span class=\"line\">    l -&gt; l.getSex() == <span class=\"number\">0</span></span><br><span class=\"line\">  );</span><br><span class=\"line\">  System.out.println(isSex);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"findFirst\"><a href=\"#findFirst\" class=\"headerlink\" title=\"findFirst\"></a>findFirst</h4><p>找到第一个元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* findFirst测试</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testFindFirst</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  User user = list.stream().sorted(</span><br><span class=\"line\">    ((o1, o2) -&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(o1.getAge() &gt; o2.getAge())&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(o1.getAge() &lt; o2.getAge())&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  ).findFirst().get();</span><br><span class=\"line\">  System.out.println(user);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"findAny\"><a href=\"#findAny\" class=\"headerlink\" title=\"findAny\"></a>findAny</h4><p>找到其中任意一个元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* findAny测试</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testFindAny</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  User user = list.stream().filter(</span><br><span class=\"line\">    l -&gt; l.getSex() == <span class=\"number\">0</span></span><br><span class=\"line\">  ).findAny().get();</span><br><span class=\"line\">  System.out.println(user);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"count\"><a href=\"#count\" class=\"headerlink\" title=\"count\"></a>count</h4><p>返回流中元素的数量</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* count测试</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testCount</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">long</span> count = list.stream().count();</span><br><span class=\"line\">  System.out.println(count);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"max\"><a href=\"#max\" class=\"headerlink\" title=\"max\"></a>max</h4><p>返回流中根据比较之后的最大值元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// max方法接收的是Comparator接口</span></span><br><span class=\"line\"><span class=\"function\">Optional&lt;T&gt; <span class=\"title\">max</span><span class=\"params\">(Comparator&lt;? <span class=\"keyword\">super</span> T&gt; comparator)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* max测试</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testMax</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  User user = list.stream().max(</span><br><span class=\"line\">    ((o1, o2) -&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(o1.getAge() &gt; o2.getAge())&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(o1.getAge() &lt; o2.getAge())&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  ).get();</span><br><span class=\"line\">  System.out.println(user);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"min\"><a href=\"#min\" class=\"headerlink\" title=\"min\"></a>min</h4><p>返回流中根据比较之后的最小值元素</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// min方法接收的是Comparator接口</span></span><br><span class=\"line\"><span class=\"function\">Optional&lt;T&gt; <span class=\"title\">min</span><span class=\"params\">(Comparator&lt;? <span class=\"keyword\">super</span> T&gt; comparator)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* min测试</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testMin</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  User user = list.stream().min(</span><br><span class=\"line\">    ((o1, o2) -&gt; &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(o1.getAge() &gt; o2.getAge())&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(o1.getAge() &lt; o2.getAge())&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  ).get();</span><br><span class=\"line\">  System.out.println(user);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"归约和收集\"><a href=\"#归约和收集\" class=\"headerlink\" title=\"归约和收集\"></a>归约和收集</h3><h4 id=\"归约reduce\"><a href=\"#归约reduce\" class=\"headerlink\" title=\"归约reduce\"></a>归约reduce</h4><p>使用reduce来进行运算，从一组值中生成一个值</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// reduce方法接收的是BinaryOperator接口(二元运算操作)  </span></span><br><span class=\"line\"><span class=\"function\">Optional&lt;T&gt; <span class=\"title\">reduce</span><span class=\"params\">(BinaryOperator&lt;T&gt; accumulator)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 归约  将流中元素反复结合起来，得到一个值</span></span><br><span class=\"line\"><span class=\"comment\">* reduce(T identity, BinaryOperator&lt;T&gt; accumulator) /BinaryOperator&lt;T&gt; accumulator/U identity,</span></span><br><span class=\"line\"><span class=\"comment\">*                  BiFunction&lt;U, ? super T, U&gt; accumulator,</span></span><br><span class=\"line\"><span class=\"comment\">*                  BinaryOperator&lt;U&gt; combiner</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testReduce</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  List&lt;Integer&gt; list = Arrays.asList(<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">5</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">8</span>,<span class=\"number\">9</span>);</span><br><span class=\"line\">  <span class=\"comment\">// BinaryOperator  二元运算   R apply(T t, U u);</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> sum = list.stream().reduce((x, y) -&gt; x+y).get();</span><br><span class=\"line\">  System.out.println(sum);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"收集collect\"><a href=\"#收集collect\" class=\"headerlink\" title=\"收集collect\"></a>收集collect</h4><p>根据不同的收集器collect(Collectors.toList())、collect(Collectors.toSet())来返回不同的集合</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 收集 collect -- 将流转换为其他形式 接收一个Collector接口的实现，用于给Stream中元素做汇总的方法</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testCollect</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// Collector是一个接口  有一个Collectors提供了各种转换方式</span></span><br><span class=\"line\">  List&lt;String&gt; strings = list.stream().map(User::getName).collect(Collectors.toList());</span><br><span class=\"line\">  System.out.println(strings);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"动态代理","url":"/2020/java%E5%9F%BA%E7%A1%80/%E5%8F%8D%E5%B0%84/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/","content":"<h2 id=\"动态代理\"><a href=\"#动态代理\" class=\"headerlink\" title=\"动态代理\"></a>动态代理</h2><p>动态代理有很多种方式，如jdk代理，cglib，ASM等</p>\n<a id=\"more\"></a>\n\n<p>在说动态代理之前先说一下静态代理</p>\n<h3 id=\"静态代理\"><a href=\"#静态代理\" class=\"headerlink\" title=\"静态代理\"></a>静态代理</h3><p>静态代理在使用时，需要定义接口或者父类，被代理对象和代理对象一起实现相同的接口或者继承相同的父类</p>\n<p>静态代理使用的是组合模式，在代理类中包含有被代理类的对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestStaticProxy</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        NikeClothFactory nikeClothFactory = <span class=\"keyword\">new</span> NikeClothFactory();</span><br><span class=\"line\">        ProxyFactory proxyFactory = <span class=\"keyword\">new</span> ProxyFactory(nikeClothFactory);</span><br><span class=\"line\">        proxyFactory.productCloth();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 接口</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ClothFactory</span></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">productCloth</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 被代理类</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">NikeClothFactory</span> <span class=\"keyword\">implements</span> <span class=\"title\">ClothFactory</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">productCloth</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Nike工厂生产了一件Nike&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 代理类</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ProxyFactory</span> <span class=\"keyword\">implements</span> <span class=\"title\">ClothFactory</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ClothFactory clothFactory;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProxyFactory</span><span class=\"params\">(ClothFactory clothFactory)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.clothFactory = clothFactory;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">productCloth</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;代理类开始执行，准备调用被代理类&quot;</span>);</span><br><span class=\"line\">        clothFactory.productCloth();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>静态代理虽然可以在不修改目标对象功能的前提下对目标功能进行扩展，但是一旦接口增加方法，目标对象和代理类都要同时修改，而且代理对象和被代理对象要实现一样的接口，导致有很多的代理类，不便于维护</p>\n<h3 id=\"jdk动态代理\"><a href=\"#jdk动态代理\" class=\"headerlink\" title=\"jdk动态代理\"></a>jdk动态代理</h3><p>jdk动态代理的底层是用的是java的反射，但是jdk代理的前提是目标类必须实现接口</p>\n<h4 id=\"Proxy\"><a href=\"#Proxy\" class=\"headerlink\" title=\"Proxy\"></a>Proxy</h4><p>Proxy类是所有代理类的父类，用来生成代理类和代理对象，包含有两个重要方法</p>\n<p>getProxyClass方法用来生成代理类的Class</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Class&lt;?&gt; getProxyClass(ClassLoader loader,</span><br><span class=\"line\">                                     Class&lt;?&gt;... interfaces)</span><br></pre></td></tr></table></figure>\n\n<p>newProxyInstance方法是用来生成代理类的对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Object <span class=\"title\">newProxyInstance</span><span class=\"params\">(ClassLoader loader,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                      Class&lt;?&gt;[] interfaces,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                      InvocationHandler h)</span></span></span><br></pre></td></tr></table></figure>\n\n<p><strong>使用步骤</strong></p>\n<ul>\n<li>首先实现一个InvocationHandler，方法调用会被转发到该类的invoke()方法</li>\n<li>调用时通过动态代理获取代理对象</li>\n</ul>\n<p>核心方法为Proxy.newProxyInstance(ClassLoader,Class[],InvocationHandler)</p>\n<p>三个参数分别表示</p>\n<ul>\n<li>ClassLoader  当前目标对象使用的类加载器</li>\n<li>Class[]  目标对象实现的接口类型</li>\n<li>InvocationHandler  事件处理，执行目标对象的方法时，会触发事件处理器的方法，会把当前执行目标对象的方法作为参数传入</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestDynamicProxy</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        RealSubject realSubject = <span class=\"keyword\">new</span> RealSubject();</span><br><span class=\"line\">        MyInvationHandler myInvationHandler = <span class=\"keyword\">new</span> MyInvationHandler();</span><br><span class=\"line\">        Object obj = myInvationHandler.blind(realSubject);</span><br><span class=\"line\">        Subject sub = (Subject) obj;</span><br><span class=\"line\">        sub.action();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 接口</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Subject</span></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">action</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 真正执行的方法，被代理类</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RealSubject</span> <span class=\"keyword\">implements</span> <span class=\"title\">Subject</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">action</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;被代理类开始执行&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyInvationHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">InvocationHandler</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 实现了接口的被代理类的对象的声明</span></span><br><span class=\"line\">    Object obj;</span><br><span class=\"line\">    <span class=\"comment\">// 被代理类的实例</span></span><br><span class=\"line\">    <span class=\"comment\">// 返回一个代理类的对象</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">blind</span><span class=\"params\">(Object obj)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.obj = obj;</span><br><span class=\"line\">        <span class=\"comment\">// ①使用被代理类的类加载器②被代理类的接口③代理类的实例</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Proxy.newProxyInstance(obj.getClass().getClassLoader(),obj.getClass().getInterfaces(),<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 当通过代理类的对象被重写的方法调用时，都会转换为对invoke方法的调用</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> proxy 正在返回的代理对象，一般情况下，在invoke方法中不使用该对象</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> method 正在被调用的方法 </span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> args 调用方法时，传入的参数</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Throwable</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> method.invoke(obj,args);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以在单测方法或者main方法中添加System.getProperties().put(“sun.misc.ProxyGenerator.saveGeneratedFiles”,”true”);来看到代理类的class文件，文件会被生成到com/sun/proxy目录下</p>\n</blockquote>\n<h3 id=\"cglib代理\"><a href=\"#cglib代理\" class=\"headerlink\" title=\"cglib代理\"></a>cglib代理</h3><p>静态代理和jdk动态代理都妖求目标对象一定要实现接口，但是有时候目标对象只是一个单独的对象，并没有实现任何接口，这个时候采用以目标对象子类的方式实现代理，该方法称为cglib代理</p>\n<p>Cglib包的底层是通过使用一个字节码处理框架ASM来转换字节码并生成新的类，由于要生成子类，所以要被代理的类不可以被final修饰</p>\n<p>需要引入cglib的包</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>cglib<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>cglib<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.3.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>使用步骤</strong></p>\n<ul>\n<li>首先实现MethodIntercepor，方法调用会被转发到intercept()方法</li>\n<li>使用CGLIB来获取代理对象</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CglibProxy</span> <span class=\"keyword\">implements</span> <span class=\"title\">MethodInterceptor</span> </span>&#123; </span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getProxy</span><span class=\"params\">(Class clazz)</span></span>&#123;</span><br><span class=\"line\">      Enhancer enhancer = <span class=\"keyword\">new</span> Enhancer();</span><br><span class=\"line\">        <span class=\"comment\">// 指定代理类的父类，其实CGLIB是为该实际类生成一个子类</span></span><br><span class=\"line\">        enhancer.setSuperclass(clazz);</span><br><span class=\"line\">        <span class=\"comment\">// 设置Callback对象</span></span><br><span class=\"line\">        enhancer.setCallback(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 通过字节码技术动态创建子类实例</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> enhancer.create();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">intercept</span><span class=\"params\">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;前置处理&quot;</span>);</span><br><span class=\"line\">          <span class=\"comment\">// 调用MethodProxy.invokeSuper方法将调用转发给原始对象</span></span><br><span class=\"line\">        Object result = methodProxy.invokeSuper(o,objects);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;后置处理&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">print</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;方法执行&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        CglibProxy proxy = <span class=\"keyword\">new</span> CglibProxy();</span><br><span class=\"line\">        Test proxyImp = (Test) proxy.getProxy(Test.class);</span><br><span class=\"line\">        proxyImp.print();</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["反射 - java基础"]},{"title":"反射","url":"/2020/java%E5%9F%BA%E7%A1%80/%E5%8F%8D%E5%B0%84/%E5%8F%8D%E5%B0%84/","content":"<h2 id=\"反射\"><a href=\"#反射\" class=\"headerlink\" title=\"反射\"></a>反射</h2><p>Java提供反射来在运行时状态下动态的获取类的属性、方法等信息，在框架中很多地方都应用到了反射</p>\n<a id=\"more\"></a>\n\n<h3 id=\"反射的操作\"><a href=\"#反射的操作\" class=\"headerlink\" title=\"反射的操作\"></a>反射的操作</h3><h4 id=\"获取Class对象\"><a href=\"#获取Class对象\" class=\"headerlink\" title=\"获取Class对象\"></a>获取Class对象</h4><p>获取Class对象的四种方式</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 第一种</span></span><br><span class=\"line\">Class&lt;Person&gt; clazz = Person.class;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 第二种</span></span><br><span class=\"line\">Person person = <span class=\"keyword\">new</span> Person();</span><br><span class=\"line\">Class clazz1 =  person.getClass();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 第三种</span></span><br><span class=\"line\">String className = <span class=\"string\">&quot;com.zhanghe.study.reflect.Person&quot;</span>;</span><br><span class=\"line\">Class clazz2 = Class.forName(className);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 第四种 使用类加载器</span></span><br><span class=\"line\">ClassLoader classLoader = TestClass.class.getClassLoader();</span><br><span class=\"line\">Class clazz3 = classLoader.loadClass(className);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取构造器\"><a href=\"#获取构造器\" class=\"headerlink\" title=\"获取构造器\"></a>获取构造器</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">Class clazz = TestConstructor.class;</span><br><span class=\"line\">Constructor[] constructors = clazz.getConstructors();</span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;=========clazz.getConstructors()====只能获取到公有的构造器&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">for</span>(Constructor constructor : constructors)&#123;</span><br><span class=\"line\">  System.out.println(constructor);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;*****************&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;=========clazz.getConstructor()=====获取公有无参构造器&quot;</span>);</span><br><span class=\"line\">Constructor constructor = clazz.getConstructor();</span><br><span class=\"line\">System.out.println(constructor);</span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;*****************&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;=========clazz.getDeclaredConstructors()=====获取所有构造器(包括私有、受保护、默认、公有)&quot;</span>);</span><br><span class=\"line\">Constructor[] declaredConstructors = clazz.getDeclaredConstructors();</span><br><span class=\"line\"><span class=\"keyword\">for</span>(Constructor declaredConstructor : declaredConstructors)&#123;</span><br><span class=\"line\">  System.out.println(declaredConstructor);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;*****************&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;=========clazz.getDeclaredConstructor()====获取指定参数类型的构造器&quot;</span>);</span><br><span class=\"line\">Constructor declaredConstructor = clazz.getDeclaredConstructor(String.class);</span><br><span class=\"line\">System.out.println(declaredConstructor);</span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;*****************&quot;</span>);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取属性\"><a href=\"#获取属性\" class=\"headerlink\" title=\"获取属性\"></a>获取属性</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">System.out.println(<span class=\"string\">&quot;======getFields===========&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 获取所有的属性  只能获取到该类和父类中public的</span></span><br><span class=\"line\">Field[] fields = clazz.getFields();</span><br><span class=\"line\"><span class=\"keyword\">for</span> (Field f : fields)&#123;</span><br><span class=\"line\">  System.out.println(f.getName());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;======getDeclaredFields===========&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 获取所有的属性  本类中声明的所有的属性都可以获取到，不可以获取到父类的</span></span><br><span class=\"line\">Field[] declaredFields = clazz.getDeclaredFields();</span><br><span class=\"line\"><span class=\"keyword\">for</span> (Field f : declaredFields)&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 获取权限修饰符</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> i = f.getModifiers();</span><br><span class=\"line\">  String m = Modifier.toString(i);</span><br><span class=\"line\">  System.out.println(<span class=\"string\">&quot;Modifier:&quot;</span>+m);</span><br><span class=\"line\">  <span class=\"comment\">// 获取属性类型</span></span><br><span class=\"line\">  Class type = f.getType();</span><br><span class=\"line\">  System.out.println(<span class=\"string\">&quot;type：&quot;</span>+type.getTypeName());</span><br><span class=\"line\">  <span class=\"comment\">// 获取属性名</span></span><br><span class=\"line\">  System.out.println(<span class=\"string\">&quot;name:&quot;</span>+f.getName());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取方法\"><a href=\"#获取方法\" class=\"headerlink\" title=\"获取方法\"></a>获取方法</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">System.out.println(<span class=\"string\">&quot;======getMethods===========&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 获取本类和父类中所有的public方法</span></span><br><span class=\"line\">Method[] methods = clazz.getMethods();</span><br><span class=\"line\"><span class=\"keyword\">for</span>(Method m : methods)&#123;</span><br><span class=\"line\">  System.out.println(m.getName());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">System.out.println(<span class=\"string\">&quot;======getDeclaredMethods===========&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 获取本类中所有的方法,包括私有方法  父类的无法获取</span></span><br><span class=\"line\">Method[] declaredMethods = clazz.getDeclaredMethods();</span><br><span class=\"line\"><span class=\"keyword\">for</span>(Method m : declaredMethods)&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 获取注解</span></span><br><span class=\"line\">  Annotation[] annotations = m.getAnnotations();</span><br><span class=\"line\">  <span class=\"comment\">// 权限修饰符</span></span><br><span class=\"line\">  System.out.println(<span class=\"string\">&quot;Modifier:&quot;</span>+Modifier.toString(m.getModifiers()));</span><br><span class=\"line\">  <span class=\"comment\">// 返回值类型</span></span><br><span class=\"line\">  Class reture = m.getReturnType();</span><br><span class=\"line\">  <span class=\"comment\">// 形参列表</span></span><br><span class=\"line\">  Class[] params = m.getParameterTypes();</span><br><span class=\"line\">  <span class=\"comment\">// 方法名</span></span><br><span class=\"line\">  System.out.println(m.getName());</span><br><span class=\"line\">  <span class=\"comment\">// 异常类型</span></span><br><span class=\"line\">  Class[] exceptions = m.getExceptionTypes();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取父类信息\"><a href=\"#获取父类信息\" class=\"headerlink\" title=\"获取父类信息\"></a>获取父类信息</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取父类</span></span><br><span class=\"line\">Class superClass = clazz.getSuperclass();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取带泛型的父类</span></span><br><span class=\"line\">Type superType = clazz.getGenericSuperclass();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取父类的泛型</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(superType <span class=\"keyword\">instanceof</span> ParameterizedType)&#123; <span class=\"comment\">// 如果存在泛型</span></span><br><span class=\"line\">  Type[] actualTypeArguments = ((ParameterizedType) superType).getActualTypeArguments();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取接口\"><a href=\"#获取接口\" class=\"headerlink\" title=\"获取接口\"></a>获取接口</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取实现的接口</span></span><br><span class=\"line\">Class[] interfaces  = clazz.getInterfaces();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取包\"><a href=\"#获取包\" class=\"headerlink\" title=\"获取包\"></a>获取包</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取所在的包</span></span><br><span class=\"line\">Package aPackage = clazz.getPackage();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取注解\"><a href=\"#获取注解\" class=\"headerlink\" title=\"获取注解\"></a>获取注解</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取注解</span></span><br><span class=\"line\">Annotation[] annotations  = clazz.getAnnotations();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"反射为属性赋值\"><a href=\"#反射为属性赋值\" class=\"headerlink\" title=\"反射为属性赋值\"></a>反射为属性赋值</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 通过反射创建person实例</span></span><br><span class=\"line\">Person person = clazz.newInstance();</span><br><span class=\"line\"><span class=\"comment\">// 通过反射获取类的age属性，并赋值</span></span><br><span class=\"line\">Field field = clazz.getDeclaredField(<span class=\"string\">&quot;age&quot;</span>);</span><br><span class=\"line\">field.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">field.set(person,<span class=\"number\">20</span>);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"反射执行方法\"><a href=\"#反射执行方法\" class=\"headerlink\" title=\"反射执行方法\"></a>反射执行方法</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 通过反射获取方法,并调用</span></span><br><span class=\"line\">Method method = clazz.getMethod(<span class=\"string\">&quot;display&quot;</span>);</span><br><span class=\"line\">method.invoke(person);</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["java基础"],"tags":["反射 - java基础"]},{"title":"反射之Type类","url":"/2020/java%E5%9F%BA%E7%A1%80/%E5%8F%8D%E5%B0%84/%E5%8F%8D%E5%B0%84%E4%B9%8BType/","content":"<h2 id=\"Type类\"><a href=\"#Type类\" class=\"headerlink\" title=\"Type类\"></a>Type类</h2><p>Type接口是所有类型的父接口，有四个子接口和一个实现类。</p>\n<a id=\"more\"></a>\n\n<img src=\"/images/java基础/反射/Type实现图.png\" style=\"zoom:50%;\">\n\n\n\n<ul>\n<li><p>Class类比较常见，表示的是原始类型。表示的Java类在JVM里表现为一个Class对象</p>\n</li>\n<li><p>ParameterizedType表示的是参数化类型，如List<String>这种带有泛型的类型。</String></p>\n<p>ParameterizedType接口中常用的方法有三个，分别为</p>\n<ul>\n<li><p>Type getRawType()  返回参数化类型中的原始类型，如List<String>的原始类型为List</String></p>\n</li>\n<li><p>Type[] getActualTypeArguments()  获取参数化类型的类型变量或是实际类型列表，如List<String>的参数化类型列表为String，对于Map&lt;String,Integer&gt;中参数化列表为String和Integer</String></p>\n</li>\n<li><p>Type getOwnerType()  返回的是类型所属的类型，这个所属类型就像是 Map.Entry&lt;K,V&gt;的所属类型是Map&lt;K,V&gt;</p>\n</li>\n</ul>\n</li>\n<li><p>TypeVariable表示的是类型变量，用来反应在JVM编译该泛型前的信息。例如List<T>中T就是类型变量，它在编译时需要被转换为一个具体的类型后才能正常使用。</T></p>\n<p>该接口有三个常用的方法，分别为：</p>\n<ul>\n<li><p>Type[] getBounds()   获取类型变量的上边界，如果没有明确声明上边界则默认为Object。class Test<K extends person>中K的上边界就是Person</K></p>\n</li>\n<li><p>D getGenericDeclaration()  获取声明该类型变量的原始类型，例如class Test<K extends person>中的原始类型就是Test</K></p>\n</li>\n<li><p>String getName()   获取在源码中定义的名字，例如class Test<K extends person>中为K</K></p>\n</li>\n</ul>\n</li>\n<li><p>GenericArrayType表示的是数组类型且组成元素是ParameterizedType或TypeVariable，例如List<String>[]或T[]</String></p>\n<ul>\n<li>该接口只有一个方法，Type getGenericComponentType()  返回数组的组成元素类型</li>\n</ul>\n</li>\n<li><p>WildcardType表示的是通配符泛型，例如 ? extends Number 和 ? super Integer</p>\n<ul>\n<li>Type[] getUpperBounds()   返回泛型变量的上边界</li>\n<li>Type[] getLowerBounds()   返回泛型变量类型的下边界</li>\n</ul>\n</li>\n</ul>\n","categories":["java基础"],"tags":["反射 - java基础"]},{"title":"字符串常量池","url":"/2020/java%E5%9F%BA%E7%A1%80/%E5%AD%97%E7%AC%A6%E4%B8%B2/%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B8%B8%E9%87%8F%E6%B1%A0/","content":"<h2 id=\"字符串常量池\"><a href=\"#字符串常量池\" class=\"headerlink\" title=\"字符串常量池\"></a>字符串常量池</h2><p>String在java中用到的地方很多，大量频繁的创建字符串，会很影响程序的性能，为此java中为String提供了字符串常量池提高它的性能</p>\n<a id=\"more\"></a>\n\n<h3 id=\"java是如何进行优化的\"><a href=\"#java是如何进行优化的\" class=\"headerlink\" title=\"java是如何进行优化的\"></a>java是如何进行优化的</h3><p>为字符串开辟了一个字符串常量池，在实例化字符串常量时，首先检查常量池中是否存在，如果存在，则直接返回引用实例，否则，实例化该字符串放入常量池中</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"字符串","url":"/2020/java%E5%9F%BA%E7%A1%80/%E5%AD%97%E7%AC%A6%E4%B8%B2/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%AD%97%E7%AC%A6%E4%B8%B2/","content":"<h2 id=\"字符串\"><a href=\"#字符串\" class=\"headerlink\" title=\"字符串\"></a>字符串</h2><h3 id=\"String\"><a href=\"#String\" class=\"headerlink\" title=\"String\"></a>String</h3><p>String是一个final修饰的不可变类，，其属性也是final的，底层使用char数组存储。</p>\n<a id=\"more\"></a>\n\n<p>字符串拥有字符串常量池，对于String s = new String(“xyz”);</p>\n<p>如果之前没有用过xyz的话，需要创建两个对象，一个是new String创建的对象，一个是常量xyz对象的内容创建的对象(常量池中一个，堆中一个)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    String s = <span class=\"keyword\">new</span> String(<span class=\"string\">&quot;zxc&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(java.lang.String[])</span></span>;</span><br><span class=\"line\">    Code:</span><br><span class=\"line\">       0: new           #2                  // class java/lang/String</span><br><span class=\"line\">       <span class=\"number\">3</span>: dup</span><br><span class=\"line\">       4: ldc           #3                  // String zxc</span><br><span class=\"line\">       6: invokespecial #4                  // Method java/lang/String.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span><br><span class=\"line\">       <span class=\"number\">9</span>: astore_1</span><br><span class=\"line\">      <span class=\"number\">10</span>: <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果之前就存在xyz的话，只需要创建一个对象new String对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    String ss = <span class=\"string\">&quot;zxc&quot;</span>;</span><br><span class=\"line\">    String s = <span class=\"keyword\">new</span> String(<span class=\"string\">&quot;zxc&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(java.lang.String[])</span></span>;</span><br><span class=\"line\">    Code:</span><br><span class=\"line\">       0: ldc           #2                  // String zxc</span><br><span class=\"line\">       <span class=\"number\">2</span>: astore_1</span><br><span class=\"line\">       3: new           #3                  // class java/lang/String</span><br><span class=\"line\">       <span class=\"number\">6</span>: dup</span><br><span class=\"line\">       7: ldc           #2                  // String zxc</span><br><span class=\"line\">       9: invokespecial #4                  // Method java/lang/String.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span><br><span class=\"line\">      <span class=\"number\">12</span>: astore_2</span><br><span class=\"line\">      <span class=\"number\">13</span>: <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Process finished with exit code <span class=\"number\">0</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"字符串拼接\"><a href=\"#字符串拼接\" class=\"headerlink\" title=\"字符串拼接\"></a>字符串拼接</h4><p>字符串拼接的字节码，在java8中进行字符串拼接时会编译为StringBuilder。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestString</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        String s = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i&lt;<span class=\"number\">10</span>;i++)&#123;</span><br><span class=\"line\">            s = s + i;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">com</span>.<span class=\"title\">zhanghe</span>.<span class=\"title\">study</span>.<span class=\"title\">stream</span>.<span class=\"title\">TestString</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> com.zhanghe.study.stream.TestString();</span><br><span class=\"line\">    Code:</span><br><span class=\"line\">       <span class=\"number\">0</span>: aload_0</span><br><span class=\"line\">       1: invokespecial #1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class=\"line\">       <span class=\"number\">4</span>: <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(java.lang.String[])</span></span>;</span><br><span class=\"line\">    Code:</span><br><span class=\"line\">       <span class=\"number\">0</span>: aconst_null</span><br><span class=\"line\">       <span class=\"number\">1</span>: astore_1</span><br><span class=\"line\">       <span class=\"number\">2</span>: iconst_0</span><br><span class=\"line\">       <span class=\"number\">3</span>: istore_2</span><br><span class=\"line\">       <span class=\"number\">4</span>: iload_2</span><br><span class=\"line\">       <span class=\"number\">5</span>: bipush        <span class=\"number\">10</span></span><br><span class=\"line\">       <span class=\"number\">7</span>: if_icmpge     <span class=\"number\">35</span></span><br><span class=\"line\">      10: new           #2                  // class java/lang/StringBuilder</span><br><span class=\"line\">      <span class=\"number\">13</span>: dup</span><br><span class=\"line\">      14: invokespecial #3                  // Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span><br><span class=\"line\">      <span class=\"number\">17</span>: aload_1</span><br><span class=\"line\">      18: invokevirtual #4                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class=\"line\">      <span class=\"number\">21</span>: iload_2</span><br><span class=\"line\">      22: invokevirtual #5                  // Method java/lang/StringBuilder.append:(I)Ljava/lang/StringBuilder;</span><br><span class=\"line\">      25: invokevirtual #6                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span><br><span class=\"line\">      <span class=\"number\">28</span>: astore_1</span><br><span class=\"line\">      <span class=\"number\">29</span>: iinc          <span class=\"number\">2</span>, <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"number\">32</span>: goto          <span class=\"number\">4</span></span><br><span class=\"line\">      <span class=\"number\">35</span>: <span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"intern方法\"><a href=\"#intern方法\" class=\"headerlink\" title=\"intern方法\"></a>intern方法</h5><p>在使用字符串拼接之后生成的字符串如果调用intern()方法，就会返回该字符串所对应的常量池中字符串的地址值</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">String s1 = <span class=\"string\">&quot;aa&quot;</span>;</span><br><span class=\"line\">String s2 = <span class=\"string\">&quot;bb&quot;</span>;</span><br><span class=\"line\">String s3 = <span class=\"string\">&quot;aabb&quot;</span>;</span><br><span class=\"line\">String s4 = s1+s2;</span><br><span class=\"line\">String s5 = <span class=\"string\">&quot;aa&quot;</span>+<span class=\"string\">&quot;bb&quot;</span>;</span><br><span class=\"line\">String s6 = s4.intern();</span><br><span class=\"line\">System.out.println(s3 == s4);<span class=\"comment\">// false</span></span><br><span class=\"line\">System.out.println(s3 == s5);<span class=\"comment\">// true</span></span><br><span class=\"line\">System.out.println(s3 == s6);<span class=\"comment\">// true</span></span><br><span class=\"line\">System.out.println(s4 == s5);<span class=\"comment\">// false</span></span><br><span class=\"line\">System.out.println(s4 == s6);<span class=\"comment\">// false</span></span><br><span class=\"line\">System.out.println(s5 == s6);<span class=\"comment\">// true</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"StringBuilder和StringBuffer\"><a href=\"#StringBuilder和StringBuffer\" class=\"headerlink\" title=\"StringBuilder和StringBuffer\"></a>StringBuilder和StringBuffer</h3><p>与StringBuffer相比，StringBuilder是线程不安全的，在单线程上操作比StringBuffer性能损耗小。</p>\n<p>默认初始值大小为16，如果进行扩容的话，会进行数据内容的赋值，增加性能损耗，如果确定数据大小，可以指定大小</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"switch支持String底层剖析","url":"/2021/java%E5%9F%BA%E7%A1%80/%E5%BA%95%E5%B1%82%E5%89%96%E6%9E%90/switch%E6%94%AF%E6%8C%81String/","content":"<h2 id=\"switch支持String底层剖析\"><a href=\"#switch支持String底层剖析\" class=\"headerlink\" title=\"switch支持String底层剖析\"></a>switch支持String底层剖析</h2><p>switch在JDK7之前只支持与整型类型兼容的类型，如char、byte、short、int以及它们的基本数据类型的封装类以及枚举类，在JDK7的时候增加了String类型，编译器是如何做到的呢？</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">testSwitch</span><span class=\"params\">(String gender)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (gender)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">&quot;男&quot;</span>:</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;男&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">&quot;女&quot;</span>:</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;女&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;未知&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>编译之后变成了</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">testSwitch</span><span class=\"params\">(String gender)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">byte</span> var3 = -<span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"comment\">//在switch中使用的是hashcode值</span></span><br><span class=\"line\">  <span class=\"keyword\">switch</span>(gender.hashCode()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">22899</span>:</span><br><span class=\"line\">            <span class=\"comment\">// 为了防止hash冲突，使用hash值匹配之后，还要使用equals比较一下</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (gender.equals(<span class=\"string\">&quot;女&quot;</span>)) &#123;</span><br><span class=\"line\">                var3 = <span class=\"number\">1</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">30007</span>:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (gender.equals(<span class=\"string\">&quot;男&quot;</span>)) &#123;</span><br><span class=\"line\">                var3 = <span class=\"number\">0</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">switch</span>(var3) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">0</span>:</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;男&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;女&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;未知&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["java底层剖析"],"tags":["java底层剖析"]},{"title":"异常","url":"/2020/java%E5%9F%BA%E7%A1%80/%E5%BC%82%E5%B8%B8/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%BC%82%E5%B8%B8/","content":"<h2 id=\"异常\"><a href=\"#异常\" class=\"headerlink\" title=\"异常\"></a>异常</h2><p>当异常发生时，该线程会暂停，逐层退出方法调用，知道遇到异常处理器，异常处理器可以catch到异常对象，进行相应的处理</p>\n<a id=\"more\"></a>\n\n<h3 id=\"异常的类型\"><a href=\"#异常的类型\" class=\"headerlink\" title=\"异常的类型\"></a>异常的类型</h3><p>分为两个类，一个是Error，一个是Exception</p>\n<ul>\n<li>Error通常表示的是java内部错误，如内存溢出等，不能在编程的层面上解决Error</li>\n<li>Exception则表示异常，分为unchecked异常和checked异常<ul>\n<li>unchecked异常是由于编程时犯错导致的，继承的是RuntimeException，如ClassCastException(类型转换异常)、NullPointerException(空指针异常)、ArithmeticException(算术异常)、IndexOutOfBoundsException(数组下标越界异常)、IllegalArgumentException(参数异常)等</li>\n<li>checked异常是由于编程与环境互动造成程序出错，如IOException、MalformedURLException等</li>\n</ul>\n</li>\n</ul>\n","categories":["java基础"],"tags":["java基础"]},{"title":"泛型","url":"/2020/java%E5%9F%BA%E7%A1%80/%E6%B3%9B%E5%9E%8B/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%B3%9B%E5%9E%8B/","content":"<h2 id=\"泛型\"><a href=\"#泛型\" class=\"headerlink\" title=\"泛型\"></a>泛型</h2><p>泛型是在JDK1.5增加的功能，在没有泛型之前，从集合中取出来的每一个对象都必须进行强制类型转换，如果有人插入了错误类型的对象，在运行时的转换就会出现问题，有了泛型之后，这些问题就会在编译期暴露出来。</p>\n<p>泛型的好处</p>\n<a id=\"more\"></a>\n\n<ul>\n<li>在编译期间检测类型，避免了运行期出现的ClassCastException</li>\n<li>使得代码整洁，不需要在转换时使用instanceOf</li>\n<li>在运行时不会产生类型检查的字节码指令</li>\n</ul>\n","categories":["java基础"],"tags":["java基础"]},{"title":"注解","url":"/2020/java%E5%9F%BA%E7%A1%80/%E6%B3%A8%E8%A7%A3/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%B3%A8%E8%A7%A3/","content":"<p>java中包含5种元注解</p>\n<a id=\"more\"></a>\n\n<ul>\n<li><p>@Target  表示注解可用于哪些地方，包含TYPE(类)、METHOD(方法)、PARAMETER(参数)、CONSTRUCTOR(构造器)、FIELD(字段)、LOCAL_VARIABLE(局部变量)、ANNOTATION_TYPE、PACKAGE(包)、TYPE_PARAMETER、TYPE_USE</p>\n</li>\n<li><p>@Retention  表示注解信息保存的生命周期   SOURCE(注解被编译器丢弃)、CLASS(注解在class文件中可用，会被VM丢弃)、RUNTIME(VM在运行期也保留注解，可通过反射机制读取注解的信息)</p>\n</li>\n<li><p>@Documented  将此注解保存在Javadoc中</p>\n</li>\n<li><p>@Inherited  允许子类继承父类的注解</p>\n</li>\n<li><p>@Repeatable  允许一个注解可以被使用一次或多次</p>\n</li>\n</ul>\n<p>注解处理器用来处理注解进行工作，对于RUNTIME的注解可以在运行期操作，可以使用反射，而SOURCE和CLASS就只能在注解处理器Processor来操作了</p>\n<p>注：注解处理器要和项目分开</p>\n<p>注解处理器项目需要添加maven插件  该项目编译时不加载注解处理器，不然会报错</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-compiler-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">compilerArgument</span>&gt;</span></span><br><span class=\"line\">                        -proc:none</span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">compilerArgument</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span>1.8<span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">target</span>&gt;</span>1.8<span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>maven-compiler-plugin<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">compilerArgument</span>&gt;</span></span><br><span class=\"line\">                        -proc:none</span><br><span class=\"line\">                    <span class=\"tag\">&lt;/<span class=\"name\">compilerArgument</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span>1.8<span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">                    <span class=\"tag\">&lt;<span class=\"name\">target</span>&gt;</span>1.8<span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>注解处理器注册</p>\n<p>需要在resources下创建META-INF目录，创建services目录，创建javax.annotation.processing.Processor文件，在里面写上处理器的全路径</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"code\"><pre><span class=\"line\">com.zhanghe.MyProcessor</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@SupportedAnnotationTypes(&#123;&quot;com.zhanghe.Test&quot;&#125;)</span> <span class=\"comment\">// 支持哪些注解</span></span><br><span class=\"line\"><span class=\"meta\">@SupportedSourceVersion(SourceVersion.RELEASE_8)</span> <span class=\"comment\">// 支持哪个版本</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyProcessor</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractProcessor</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Filer filer;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Locale locale;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Elements elements;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Types types;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> StandardJavaFileManager standardJavaFileManager;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 该方法再编译期间会被注入一个ProcessingEnvironment对象，该对象包含了很多有用的工具类。</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> processingEnv</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">init</span><span class=\"params\">(ProcessingEnvironment processingEnv)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">super</span>.init(processingEnv);</span><br><span class=\"line\">        filer = processingEnv.getFiler();</span><br><span class=\"line\">        locale = processingEnv.getLocale();</span><br><span class=\"line\">        elements = processingEnv.getElementUtils();</span><br><span class=\"line\">        types = processingEnv.getTypeUtils();</span><br><span class=\"line\">        JavaCompiler javaCompiler = ToolProvider.getSystemJavaCompiler();</span><br><span class=\"line\">        DiagnosticCollector&lt;JavaFileObject&gt; collector = <span class=\"keyword\">new</span> DiagnosticCollector&lt;&gt;();</span><br><span class=\"line\">        standardJavaFileManager = javaCompiler.getStandardFileManager(collector, <span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * 相当于main方法</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">process</span><span class=\"params\">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (TypeElement annotation : annotations) &#123;</span><br><span class=\"line\">            System.out.println(annotation);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Element element : roundEnv.getElementsAnnotatedWith(Test.class)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (element.getKind() == ElementKind.CLASS) &#123;</span><br><span class=\"line\">                TypeElement typeElement = (TypeElement) element;</span><br><span class=\"line\">                PackageElement packageElement = elements.getPackageOf(element);</span><br><span class=\"line\">                String packagePath = packageElement.getQualifiedName().toString();</span><br><span class=\"line\">                String className = typeElement.getSimpleName().toString();</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;packagePath:&quot;</span> + packagePath);</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;className:&quot;</span> + className);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            System.out.println(element.getKind() +</span><br><span class=\"line\">                    <span class=\"string\">&quot; : &quot;</span> + element.getModifiers() +</span><br><span class=\"line\">                    <span class=\"string\">&quot; : &quot;</span> + element.getSimpleName() +</span><br><span class=\"line\">                    <span class=\"string\">&quot; : &quot;</span> + element.asType());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>准备使用注解处理器修改源文件，之后再研究</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"编译时处理注解","url":"/2021/java%E5%9F%BA%E7%A1%80/%E6%B3%A8%E8%A7%A3/%E7%BC%96%E8%AF%91%E6%97%B6%E5%A4%84%E7%90%86%E6%B3%A8%E8%A7%A3/","content":"<h2 id=\"编译时处理注解\"><a href=\"#编译时处理注解\" class=\"headerlink\" title=\"编译时处理注解\"></a>编译时处理注解</h2><p>可以使用APT(Annotation Processing Tool)来在编译期进行注解处理，生成额外的源文件和其他文件。</p>\n<p>Annotation注解处理器需要实现javax.annotation.processing.Processor接口，也可以通过继承javax.annotation.processing.AbstractProcessor类来实现Annotation注解处理器</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"ArrayList详解","url":"/2021/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/ArrayList%E8%AF%A6%E8%A7%A3/","content":"<h2 id=\"ArrayList详解\"><a href=\"#ArrayList详解\" class=\"headerlink\" title=\"ArrayList详解\"></a>ArrayList详解</h2><p>List中使用最多的就是ArrayList，基本上大家在实例化一个List的时候都是</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">List list = <span class=\"keyword\">new</span> ArrayList();</span><br></pre></td></tr></table></figure>\n\n<p>所以在这里了解一下ArrayList的实现过程(以java8为例)</p>\n<h3 id=\"主要特点\"><a href=\"#主要特点\" class=\"headerlink\" title=\"主要特点\"></a>主要特点</h3><ul>\n<li>有序存储元素</li>\n<li>允许元素重复，允许存储null值</li>\n<li>支持动态扩容</li>\n<li>非线程安全</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"继承关系\"><a href=\"#继承关系\" class=\"headerlink\" title=\"继承关系\"></a>继承关系</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ArrayList</span>&lt;<span class=\"title\">E</span>&gt; <span class=\"keyword\">extends</span> <span class=\"title\">AbstractList</span>&lt;<span class=\"title\">E</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"keyword\">implements</span> <span class=\"title\">List</span>&lt;<span class=\"title\">E</span>&gt;, <span class=\"title\">RandomAccess</span>, <span class=\"title\">Cloneable</span>, <span class=\"title\">java</span>.<span class=\"title\">io</span>.<span class=\"title\">Serializable</span></span></span><br></pre></td></tr></table></figure>\n\n<img src=\"/images/java基础/集合/ArrayList.png\" alt=\"ArrayList\" style=\"zoom:50%;\">\n\n<p>继承了AbstractList类，实现了List接口、RandomAccess接口、Cloneable接口和Serializable接口，所以ArrayList是支持随机访问、克隆和序列化的</p>\n<h3 id=\"源码分析\"><a href=\"#源码分析\" class=\"headerlink\" title=\"源码分析\"></a>源码分析</h3><h4 id=\"关键变量\"><a href=\"#关键变量\" class=\"headerlink\" title=\"关键变量\"></a>关键变量</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 默认的初始化容量</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> DEFAULT_CAPACITY = <span class=\"number\">10</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 默认的空数组</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Object[] EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 默认无参构造器使用的空数组</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* ArrayList底层用来存储数据的数组</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">transient</span> Object[] elementData; <span class=\"comment\">// non-private to simplify nested class access</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* ArrayList实际的长度</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> size;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 可分配的最大容量</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> MAX_ARRAY_SIZE = Integer.MAX_VALUE - <span class=\"number\">8</span>;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"构造函数\"><a href=\"#构造函数\" class=\"headerlink\" title=\"构造函数\"></a>构造函数</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 自定义初始化容量，根据传入的初始化容量来确定elementData的数组容量</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArrayList</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (initialCapacity &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.elementData = <span class=\"keyword\">new</span> Object[initialCapacity];</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (initialCapacity == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.elementData = EMPTY_ELEMENTDATA;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Illegal Capacity: &quot;</span>+</span><br><span class=\"line\">                                           initialCapacity);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 无参构造器，可以看到并没有在实例化的时候分配数组容量，而是使用了空数组</span></span><br><span class=\"line\"><span class=\"comment\"> * 在真正存放元素时才会分配</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArrayList</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 通过集合来进行初始化，使用了Arrays.copyOf来将集合中的数据copy到数组中</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ArrayList</span><span class=\"params\">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class=\"line\">    Object[] a = c.toArray();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((size = a.length) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (c.getClass() == ArrayList.class) &#123;</span><br><span class=\"line\">            elementData = a;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            elementData = Arrays.copyOf(a, size, Object[].class);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// replace with empty array.</span></span><br><span class=\"line\">        elementData = EMPTY_ELEMENTDATA;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"add方法\"><a href=\"#add方法\" class=\"headerlink\" title=\"add方法\"></a>add方法</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">add</span><span class=\"params\">(E e)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 在添加元素之前先确认一下容量是否足够</span></span><br><span class=\"line\">    ensureCapacityInternal(size + <span class=\"number\">1</span>);  <span class=\"comment\">// Increments modCount!!</span></span><br><span class=\"line\">    elementData[size++] = e;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// minCapacity为当前所需要的最小容量</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">ensureCapacityInternal</span><span class=\"params\">(<span class=\"keyword\">int</span> minCapacity)</span> </span>&#123;</span><br><span class=\"line\">  ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 计算容量</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> <span class=\"title\">calculateCapacity</span><span class=\"params\">(Object[] elementData, <span class=\"keyword\">int</span> minCapacity)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 如果在进行初始化的时候使用的无参构造器，此时才会给赋初始容量为10</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> Math.max(DEFAULT_CAPACITY, minCapacity);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> minCapacity;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">ensureExplicitCapacity</span><span class=\"params\">(<span class=\"keyword\">int</span> minCapacity)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 计算修改次数</span></span><br><span class=\"line\">  modCount++;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 需要的容量大于数组容量的话，需要进行扩容</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (minCapacity - elementData.length &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    grow(minCapacity);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">grow</span><span class=\"params\">(<span class=\"keyword\">int</span> minCapacity)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// overflow-conscious code</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> oldCapacity = elementData.length;</span><br><span class=\"line\">  <span class=\"comment\">// 扩容1.5倍</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class=\"number\">1</span>);</span><br><span class=\"line\">  <span class=\"comment\">// 当原数组为空数组时，newCapacity为0，是小于minCapacity 10 的</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (newCapacity - minCapacity &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    newCapacity = minCapacity;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    newCapacity = hugeCapacity(minCapacity);</span><br><span class=\"line\">  <span class=\"comment\">// minCapacity is usually close to size, so this is a win:</span></span><br><span class=\"line\">  elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"remove方法\"><a href=\"#remove方法\" class=\"headerlink\" title=\"remove方法\"></a>remove方法</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> E <span class=\"title\">remove</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 数组下标检查</span></span><br><span class=\"line\">    rangeCheck(index);</span><br><span class=\"line\">        <span class=\"comment\">// 计算修改次数</span></span><br><span class=\"line\">    modCount++;</span><br><span class=\"line\">      <span class=\"comment\">// 获取该所索引位置下原来的的元素</span></span><br><span class=\"line\">    E oldValue = elementData(index);</span><br><span class=\"line\">        <span class=\"comment\">// 所要移动的数量</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> numMoved = size - index - <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (numMoved &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">          <span class=\"comment\">// 第一个参数为源数据</span></span><br><span class=\"line\">          <span class=\"comment\">// 第二个参数为从源数据的哪个位置开始复制</span></span><br><span class=\"line\">          <span class=\"comment\">// 第三个参数为目标数据</span></span><br><span class=\"line\">          <span class=\"comment\">// 第四个参数为从目标数据的哪个位置开始被复制</span></span><br><span class=\"line\">          <span class=\"comment\">// 第五个参数为被复制的元素数量</span></span><br><span class=\"line\">        System.arraycopy(elementData, index+<span class=\"number\">1</span>, elementData, index,</span><br><span class=\"line\">                         numMoved); <span class=\"comment\">// index所对应的元素被删除，后续所有的元素向前移动一位</span></span><br><span class=\"line\">    elementData[--size] = <span class=\"keyword\">null</span>; <span class=\"comment\">// clear to let GC do its work</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>其他的方法都是中规中矩的操作数组</p>\n<p>如:</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// get</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> E <span class=\"title\">get</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">    rangeCheck(index);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> elementData(index);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// indexOf</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">indexOf</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (o == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; size; i++)</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (elementData[i]==<span class=\"keyword\">null</span>)</span><br><span class=\"line\">              <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; size; i++)</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (o.equals(elementData[i]))</span><br><span class=\"line\">              <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"迭代器\"><a href=\"#迭代器\" class=\"headerlink\" title=\"迭代器\"></a>迭代器</h3><p><strong><em>在使用foreach循环遍历的时候实际上是使用的迭代器，对于ArrayList而言，使用普通的for循环会比使用foreach效率更高</em></strong></p>\n<p>接下来看一下ArrayList的迭代器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Iterator&lt;E&gt; <span class=\"title\">iterator</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Itr();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Itr是ArrayList的内部类，实现了Iterator接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Itr</span> <span class=\"keyword\">implements</span> <span class=\"title\">Iterator</span>&lt;<span class=\"title\">E</span>&gt; </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 游标</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> cursor;       <span class=\"comment\">// index of next element to return</span></span><br><span class=\"line\">      <span class=\"comment\">// 最后一次返回的索引位置</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> lastRet = -<span class=\"number\">1</span>; <span class=\"comment\">// index of last element returned; -1 if no such</span></span><br><span class=\"line\">      <span class=\"comment\">// 当Itr被实例化的时候，记录一下迭代器被实例化时ArrayList的修改次数(在用ArrayList进行add/remove操作时modCount每次都加一)</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> expectedModCount = modCount;</span><br><span class=\"line\"></span><br><span class=\"line\">    Itr() &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">hasNext</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> cursor != size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> E <span class=\"title\">next</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 检查是否被修改了</span></span><br><span class=\"line\">        checkForComodification();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> i = cursor;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i &gt;= size)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NoSuchElementException();</span><br><span class=\"line\">        Object[] elementData = ArrayList.<span class=\"keyword\">this</span>.elementData;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i &gt;= elementData.length)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException();</span><br><span class=\"line\">          <span class=\"comment\">// 游标加一，指向下一个元素位置</span></span><br><span class=\"line\">        cursor = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (E) elementData[lastRet = i];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">remove</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (lastRet &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException();</span><br><span class=\"line\">          <span class=\"comment\">// 检查是否被修改了</span></span><br><span class=\"line\">        checkForComodification();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// list移除元素</span></span><br><span class=\"line\">            ArrayList.<span class=\"keyword\">this</span>.remove(lastRet);</span><br><span class=\"line\">            cursor = lastRet;</span><br><span class=\"line\">            lastRet = -<span class=\"number\">1</span>;</span><br><span class=\"line\">              <span class=\"comment\">// 移除之后会将修改次数modCount重新赋给expectedModCount</span></span><br><span class=\"line\">            expectedModCount = modCount;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">forEachRemaining</span><span class=\"params\">(Consumer&lt;? <span class=\"keyword\">super</span> E&gt; consumer)</span> </span>&#123;</span><br><span class=\"line\">        Objects.requireNonNull(consumer);</span><br><span class=\"line\">        <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size = ArrayList.<span class=\"keyword\">this</span>.size;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> i = cursor;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i &gt;= size) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Object[] elementData = ArrayList.<span class=\"keyword\">this</span>.elementData;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i &gt;= elementData.length) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (i != size &amp;&amp; modCount == expectedModCount) &#123;</span><br><span class=\"line\">            consumer.accept((E) elementData[i++]);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// update once at end of iteration to reduce heap write traffic</span></span><br><span class=\"line\">        cursor = i;</span><br><span class=\"line\">        lastRet = i - <span class=\"number\">1</span>;</span><br><span class=\"line\">          <span class=\"comment\">// 检查是否被修改了</span></span><br><span class=\"line\">        checkForComodification();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 检查是否被修改了</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">checkForComodification</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 当修改次数与Itr被实例化时的修改次数不一致时，说明在进行迭代操作的时候其他线程进行了ArrrayList的add/remove操作，此时抛出ConcurrentModificationException，即为fast-fail快速失败机制</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (modCount != expectedModCount)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用说明\"><a href=\"#使用说明\" class=\"headerlink\" title=\"使用说明\"></a>使用说明</h3><ul>\n<li><p>由于ArrayList的默认初始值为10，扩容为1.5倍，如果集合中所需要存储的元素数量多的话，需要进行多次扩容，重新申请内存并进行赋值，比较耗时，所以如果在进行实例化时指定初始容量，可以减少扩容次数，提升性能</p>\n</li>\n<li><p>在遍历删除的时候注意了，不要使用foreach来循环遍历list删除数据，最好使用iterator进行遍历删除</p>\n</li>\n</ul>\n","categories":["java基础"],"tags":["java基础"]},{"title":"HashSet详解","url":"/2021/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/HasSet%E8%AF%A6%E8%A7%A3/","content":"<h2 id=\"HashSet详解\"><a href=\"#HashSet详解\" class=\"headerlink\" title=\"HashSet详解\"></a>HashSet详解</h2><p>HashSet是基于HashMap实现的一个单列存储的集合类，将所有的数据存在HashMap的key值中，而value全部使用一个Object对象存储</p>\n<h3 id=\"继承关系\"><a href=\"#继承关系\" class=\"headerlink\" title=\"继承关系\"></a>继承关系</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HashSet</span>&lt;<span class=\"title\">E</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"keyword\">extends</span> <span class=\"title\">AbstractSet</span>&lt;<span class=\"title\">E</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"keyword\">implements</span> <span class=\"title\">Set</span>&lt;<span class=\"title\">E</span>&gt;, <span class=\"title\">Cloneable</span>, <span class=\"title\">java</span>.<span class=\"title\">io</span>.<span class=\"title\">Serializable</span></span></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<img src=\"/images/java基础/集合/HashSet.png\" alt=\"HashSet\" style=\"zoom:50%;\">\n\n\n\n<p>继承了AbstractSet类，实现了Set接口、Cloneable接口和Serializable接口，所以HashSet是支持克隆和序列化的</p>\n<h3 id=\"源码分析\"><a href=\"#源码分析\" class=\"headerlink\" title=\"源码分析\"></a>源码分析</h3><h4 id=\"关键变量\"><a href=\"#关键变量\" class=\"headerlink\" title=\"关键变量\"></a>关键变量</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 使用HashMap存储数据  map的key为HashSet的元素值</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> HashMap&lt;E,Object&gt; map;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Dummy value to associate with an Object in the backing Map</span></span><br><span class=\"line\"><span class=\"comment\">// map中所有的值都是该Object对象</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Object PRESENT = <span class=\"keyword\">new</span> Object();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"构造器\"><a href=\"#构造器\" class=\"headerlink\" title=\"构造器\"></a>构造器</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 无参构造器，直接实例化一个HashMap</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HashSet</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    map = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 使用的是HahMap中传入初始容量的构造器</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HashSet</span><span class=\"params\">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class=\"line\">    map = <span class=\"keyword\">new</span> HashMap&lt;&gt;(Math.max((<span class=\"keyword\">int</span>) (c.size()/.<span class=\"number\">75f</span>) + <span class=\"number\">1</span>, <span class=\"number\">16</span>));</span><br><span class=\"line\">    addAll(c);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 使用的是HahMap中传入初始容量和加载因子的构造器</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HashSet</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity, <span class=\"keyword\">float</span> loadFactor)</span> </span>&#123;</span><br><span class=\"line\">    map = <span class=\"keyword\">new</span> HashMap&lt;&gt;(initialCapacity, loadFactor);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 使用的是HahMap中传入初始容量的构造器</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HashSet</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity)</span> </span>&#123;</span><br><span class=\"line\">    map = <span class=\"keyword\">new</span> HashMap&lt;&gt;(initialCapacity);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 该构造器是提供给LinkedHashSet使用的，不对外暴露，实例化的是LinkedHashMap</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\">HashSet(<span class=\"keyword\">int</span> initialCapacity, <span class=\"keyword\">float</span> loadFactor, <span class=\"keyword\">boolean</span> dummy) &#123;</span><br><span class=\"line\">    map = <span class=\"keyword\">new</span> LinkedHashMap&lt;&gt;(initialCapacity, loadFactor);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"方法分析\"><a href=\"#方法分析\" class=\"headerlink\" title=\"方法分析\"></a>方法分析</h4><p>HashSet的方法实现都非常简单，直接使用封装的HashMap来操作数据，真正执行的是HashMap的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Returns an iterator over the elements in this set.  The elements</span></span><br><span class=\"line\"><span class=\"comment\"> * are returned in no particular order.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> an Iterator over the elements in this set</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@see</span> ConcurrentModificationException</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Iterator&lt;E&gt; <span class=\"title\">iterator</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> map.keySet().iterator();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Returns the number of elements in this set (its cardinality).</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> the number of elements in this set (its cardinality)</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">size</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> map.size();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Returns &lt;tt&gt;true&lt;/tt&gt; if this set contains no elements.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> &lt;tt&gt;true&lt;/tt&gt; if this set contains no elements</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isEmpty</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> map.isEmpty();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Returns &lt;tt&gt;true&lt;/tt&gt; if this set contains the specified element.</span></span><br><span class=\"line\"><span class=\"comment\"> * More formally, returns &lt;tt&gt;true&lt;/tt&gt; if and only if this set</span></span><br><span class=\"line\"><span class=\"comment\"> * contains an element &lt;tt&gt;e&lt;/tt&gt; such that</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;tt&gt;(o==null&amp;nbsp;?&amp;nbsp;e==null&amp;nbsp;:&amp;nbsp;o.equals(e))&lt;/tt&gt;.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> o element whose presence in this set is to be tested</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> &lt;tt&gt;true&lt;/tt&gt; if this set contains the specified element</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">contains</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> map.containsKey(o);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Adds the specified element to this set if it is not already present.</span></span><br><span class=\"line\"><span class=\"comment\"> * More formally, adds the specified element &lt;tt&gt;e&lt;/tt&gt; to this set if</span></span><br><span class=\"line\"><span class=\"comment\"> * this set contains no element &lt;tt&gt;e2&lt;/tt&gt; such that</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;tt&gt;(e==null&amp;nbsp;?&amp;nbsp;e2==null&amp;nbsp;:&amp;nbsp;e.equals(e2))&lt;/tt&gt;.</span></span><br><span class=\"line\"><span class=\"comment\"> * If this set already contains the element, the call leaves the set</span></span><br><span class=\"line\"><span class=\"comment\"> * unchanged and returns &lt;tt&gt;false&lt;/tt&gt;.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> e element to be added to this set</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> &lt;tt&gt;true&lt;/tt&gt; if this set did not already contain the specified</span></span><br><span class=\"line\"><span class=\"comment\"> * element</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">add</span><span class=\"params\">(E e)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> map.put(e, PRESENT)==<span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Removes the specified element from this set if it is present.</span></span><br><span class=\"line\"><span class=\"comment\"> * More formally, removes an element &lt;tt&gt;e&lt;/tt&gt; such that</span></span><br><span class=\"line\"><span class=\"comment\"> * &lt;tt&gt;(o==null&amp;nbsp;?&amp;nbsp;e==null&amp;nbsp;:&amp;nbsp;o.equals(e))&lt;/tt&gt;,</span></span><br><span class=\"line\"><span class=\"comment\"> * if this set contains such an element.  Returns &lt;tt&gt;true&lt;/tt&gt; if</span></span><br><span class=\"line\"><span class=\"comment\"> * this set contained the element (or equivalently, if this set</span></span><br><span class=\"line\"><span class=\"comment\"> * changed as a result of the call).  (This set will not contain the</span></span><br><span class=\"line\"><span class=\"comment\"> * element once the call returns.)</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> o object to be removed from this set, if present</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@return</span> &lt;tt&gt;true&lt;/tt&gt; if the set contained the specified element</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">remove</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> map.remove(o)==PRESENT;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Removes all of the elements from this set.</span></span><br><span class=\"line\"><span class=\"comment\"> * The set will be empty after this call returns.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    map.clear();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"ConcurrentHashMap详解","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/ConcurrentHashMap%E8%AF%A6%E8%A7%A3/","content":"<h2 id=\"ConcurrentHashMap详解\"><a href=\"#ConcurrentHashMap详解\" class=\"headerlink\" title=\"ConcurrentHashMap详解\"></a>ConcurrentHashMap详解</h2><h3 id=\"JDK7\"><a href=\"#JDK7\" class=\"headerlink\" title=\"JDK7\"></a>JDK7</h3><h4 id=\"Segment\"><a href=\"#Segment\" class=\"headerlink\" title=\"Segment\"></a>Segment</h4><p>在jdk8之前concurrentHashMap使用该对象进行分段加锁，降低了锁的粒度，使得并发效率提高，Segment本身也相当于一个HashMap，Segment包含一个HashEntry数组，数组中每个HashEntry既是一个键值对，又是一个链表的头结点</p>\n<a id=\"more\"></a>\n\n<h4 id=\"get方法\"><a href=\"#get方法\" class=\"headerlink\" title=\"get方法\"></a>get方法</h4><ul>\n<li>根据key做hash运算，得到hash值</li>\n<li>通过hash值，定位到对应的segment对象</li>\n<li>再次通过hash值，定位到segment当中数组的具体位置</li>\n</ul>\n<h4 id=\"put方法\"><a href=\"#put方法\" class=\"headerlink\" title=\"put方法\"></a>put方法</h4><ul>\n<li>根据key做hash运算，得到hash值</li>\n<li>通过hash值，定位到对应的segment对象</li>\n<li>获取可重入锁</li>\n<li>再次通过hash值，定位到segment当中数组的具体位置</li>\n<li>插入或覆盖hashEntry对象</li>\n<li>释放锁</li>\n</ul>\n<p>但是使用这种方式实现需要进行两次hash操作，第一次hash操作找到对应的segment，第二次hash操作定位到元素所在链表的头部</p>\n<h3 id=\"JDK8\"><a href=\"#JDK8\" class=\"headerlink\" title=\"JDK8\"></a>JDK8</h3><p>在jdk8的时候参考了HashMap的设计，采用了数组+链表+红黑树的方式，内部大量采用CAS操作，舍弃了分段锁的思想</p>\n<h4 id=\"CAS\"><a href=\"#CAS\" class=\"headerlink\" title=\"CAS\"></a>CAS</h4><p>CAS是compare and swap的缩写，即我们所说的比较交换，CAS属于乐观锁。</p>\n<p>CAS包含三个操作数，—内存中的值(V)，预期原值(A)，新值(B)  如果内存中的值和A的值一样，就可以将内存中的值更新为B。CAS通过无限循环来获取数据，一直到V和A一致为止</p>\n<h5 id=\"乐观锁\"><a href=\"#乐观锁\" class=\"headerlink\" title=\"乐观锁\"></a>乐观锁</h5><p>乐观锁会很乐观的认为不会出现并发问题，所以采用无锁的机制来进行处理，比如通过给记录加version来获取数据，性能比悲观锁要高</p>\n<h5 id=\"悲观锁\"><a href=\"#悲观锁\" class=\"headerlink\" title=\"悲观锁\"></a>悲观锁</h5><p>悲观锁会很悲观的认为肯定会出现并发问题，所以会将资源锁住，该资源只能有一个线程进行操作，只有前一个获得锁的线程释放锁之后，下一个线程才可以访问</p>\n<h4 id=\"源码分析\"><a href=\"#源码分析\" class=\"headerlink\" title=\"源码分析\"></a>源码分析</h4><h5 id=\"重要变量\"><a href=\"#重要变量\" class=\"headerlink\" title=\"重要变量\"></a>重要变量</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 表示整个hash表，初始化阶段是在第一次插入的时候，容量总是2的次幂</span></span><br><span class=\"line\"><span class=\"keyword\">transient</span> <span class=\"keyword\">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 下一个使用的表 只有在扩容的时候非空，其他情况都是null</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Base counter value, used mainly when there is no contention,</span></span><br><span class=\"line\"><span class=\"comment\"> * but also as a fallback during table initialization</span></span><br><span class=\"line\"><span class=\"comment\"> * races. Updated via CAS.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">long</span> baseCount;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 用于初始化和扩容控制</span></span><br><span class=\"line\"><span class=\"comment\">// 0：默认值</span></span><br><span class=\"line\"><span class=\"comment\">// -1:正在初始化</span></span><br><span class=\"line\"><span class=\"comment\">// 大于0：为hash表的阈值</span></span><br><span class=\"line\"><span class=\"comment\">// 小于-1:有多个线程在进行扩容 该值为 -(1+正在扩容的线程数)</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">int</span> sizeCtl;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The next table index (plus one) to split while resizing.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">int</span> transferIndex;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Spinlock (locked via CAS) used when resizing and/or creating CounterCells.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">int</span> cellsBusy;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Table of counter cells. When non-null, size is a power of 2.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">volatile</span> CounterCell[] counterCells;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// views</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> KeySetView&lt;K,V&gt; keySet;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> ValuesView&lt;K,V&gt; values;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> EntrySetView&lt;K,V&gt; entrySet;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"构造函数\"><a href=\"#构造函数\" class=\"headerlink\" title=\"构造函数\"></a>构造函数</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Creates a new, empty map with the default initial table size (16).</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConcurrentHashMap</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Creates a new, empty map with an initial table size</span></span><br><span class=\"line\"><span class=\"comment\"> * accommodating the specified number of elements without the need</span></span><br><span class=\"line\"><span class=\"comment\"> * to dynamically resize.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> initialCapacity The implementation performs internal</span></span><br><span class=\"line\"><span class=\"comment\"> * sizing to accommodate this many elements.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> IllegalArgumentException if the initial capacity of</span></span><br><span class=\"line\"><span class=\"comment\"> * elements is negative</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConcurrentHashMap</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (initialCapacity &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException();</span><br><span class=\"line\">    <span class=\"keyword\">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class=\"number\">1</span>)) ?</span><br><span class=\"line\">               MAXIMUM_CAPACITY :</span><br><span class=\"line\">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class=\"number\">1</span>) + <span class=\"number\">1</span>));</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.sizeCtl = cap;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Creates a new map with the same mappings as the given map.</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> m the map</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConcurrentHashMap</span><span class=\"params\">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.sizeCtl = DEFAULT_CAPACITY;</span><br><span class=\"line\">    putAll(m);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Creates a new, empty map with an initial table size based on</span></span><br><span class=\"line\"><span class=\"comment\"> * the given number of elements (&#123;<span class=\"doctag\">@code</span> initialCapacity&#125;) and</span></span><br><span class=\"line\"><span class=\"comment\"> * initial table density (&#123;<span class=\"doctag\">@code</span> loadFactor&#125;).</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> initialCapacity the initial capacity. The implementation</span></span><br><span class=\"line\"><span class=\"comment\"> * performs internal sizing to accommodate this many elements,</span></span><br><span class=\"line\"><span class=\"comment\"> * given the specified load factor.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> loadFactor the load factor (table density) for</span></span><br><span class=\"line\"><span class=\"comment\"> * establishing the initial table size</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> IllegalArgumentException if the initial capacity of</span></span><br><span class=\"line\"><span class=\"comment\"> * elements is negative or the load factor is nonpositive</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@since</span> 1.6</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConcurrentHashMap</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity, <span class=\"keyword\">float</span> loadFactor)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>(initialCapacity, loadFactor, <span class=\"number\">1</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Creates a new, empty map with an initial table size based on</span></span><br><span class=\"line\"><span class=\"comment\"> * the given number of elements (&#123;<span class=\"doctag\">@code</span> initialCapacity&#125;), table</span></span><br><span class=\"line\"><span class=\"comment\"> * density (&#123;<span class=\"doctag\">@code</span> loadFactor&#125;), and number of concurrently</span></span><br><span class=\"line\"><span class=\"comment\"> * updating threads (&#123;<span class=\"doctag\">@code</span> concurrencyLevel&#125;).</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> initialCapacity the initial capacity. The implementation</span></span><br><span class=\"line\"><span class=\"comment\"> * performs internal sizing to accommodate this many elements,</span></span><br><span class=\"line\"><span class=\"comment\"> * given the specified load factor.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> loadFactor the load factor (table density) for</span></span><br><span class=\"line\"><span class=\"comment\"> * establishing the initial table size</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> concurrencyLevel the estimated number of concurrently</span></span><br><span class=\"line\"><span class=\"comment\"> * updating threads. The implementation may use this value as</span></span><br><span class=\"line\"><span class=\"comment\"> * a sizing hint.</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@throws</span> IllegalArgumentException if the initial capacity is</span></span><br><span class=\"line\"><span class=\"comment\"> * negative or the load factor or concurrencyLevel are</span></span><br><span class=\"line\"><span class=\"comment\"> * nonpositive</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConcurrentHashMap</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                         <span class=\"keyword\">float</span> loadFactor, <span class=\"keyword\">int</span> concurrencyLevel)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(loadFactor &gt; <span class=\"number\">0.0f</span>) || initialCapacity &lt; <span class=\"number\">0</span> || concurrencyLevel &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (initialCapacity &lt; concurrencyLevel)   <span class=\"comment\">// Use at least as many bins</span></span><br><span class=\"line\">        initialCapacity = concurrencyLevel;   <span class=\"comment\">// as estimated threads</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> size = (<span class=\"keyword\">long</span>)(<span class=\"number\">1.0</span> + (<span class=\"keyword\">long</span>)initialCapacity / loadFactor);</span><br><span class=\"line\">    <span class=\"keyword\">int</span> cap = (size &gt;= (<span class=\"keyword\">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class=\"line\">        MAXIMUM_CAPACITY : tableSizeFor((<span class=\"keyword\">int</span>)size);</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.sizeCtl = cap;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"重要方法\"><a href=\"#重要方法\" class=\"headerlink\" title=\"重要方法\"></a>重要方法</h5><h6 id=\"put方法-1\"><a href=\"#put方法-1\" class=\"headerlink\" title=\"put方法\"></a>put方法</h6><p>ConcurrentHashMap是如何保证在插入的时候线程安全的呢</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">put</span><span class=\"params\">(K key, V value)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> putVal(key, value, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> V <span class=\"title\">putVal</span><span class=\"params\">(K key, V value, <span class=\"keyword\">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// ConcurrentHashMap不允许key和value为null</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (key == <span class=\"keyword\">null</span> || value == <span class=\"keyword\">null</span>) <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NullPointerException();</span><br><span class=\"line\">      <span class=\"comment\">// 计算hash值</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> hash = spread(key.hashCode());</span><br><span class=\"line\">    <span class=\"keyword\">int</span> binCount = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class=\"line\">        Node&lt;K,V&gt; f; <span class=\"keyword\">int</span> n, i, fh;</span><br><span class=\"line\">          <span class=\"comment\">// tab为null，哈希表还没有初始化，进行初始化哈希表</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (tab == <span class=\"keyword\">null</span> || (n = tab.length) == <span class=\"number\">0</span>)</span><br><span class=\"line\">            tab = initTable();</span><br><span class=\"line\">          <span class=\"comment\">// 该索引位置为null，表示还没有元素</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((f = tabAt(tab, i = (n - <span class=\"number\">1</span>) &amp; hash)) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 使用CAS的方式添加节点</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (casTabAt(tab, i, <span class=\"keyword\">null</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">new</span> Node&lt;K,V&gt;(hash, key, value, <span class=\"keyword\">null</span>)))</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;                   <span class=\"comment\">// no lock when adding to empty bin</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">          <span class=\"comment\">// 节点的hash值为-1，表示该哈希表正在扩容</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((fh = f.hash) == MOVED)</span><br><span class=\"line\">            tab = helpTransfer(tab, f);</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            V oldVal = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">              <span class=\"comment\">// 对头节点加锁</span></span><br><span class=\"line\">            <span class=\"keyword\">synchronized</span> (f) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 再次判断一下该节点是否为目标索引位置的头节点，防止期间被修改</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class=\"line\">                      <span class=\"comment\">// 表示是普通的链表</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (fh &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                        binCount = <span class=\"number\">1</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class=\"line\">                            K ek;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                                ((ek = e.key) == key ||</span><br><span class=\"line\">                                 (ek != <span class=\"keyword\">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class=\"line\">                                oldVal = e.val;</span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (!onlyIfAbsent)</span><br><span class=\"line\">                                    e.val = value;</span><br><span class=\"line\">                                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                            Node&lt;K,V&gt; pred = e;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> ((e = e.next) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                                pred.next = <span class=\"keyword\">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class=\"line\">                                                          value, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">                                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                      <span class=\"comment\">// 红黑树 TreeBin的hash值为TREEBIN，是-2</span></span><br><span class=\"line\">                    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (f <span class=\"keyword\">instanceof</span> TreeBin) &#123;</span><br><span class=\"line\">                        Node&lt;K,V&gt; p;</span><br><span class=\"line\">                        binCount = <span class=\"number\">2</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class=\"line\">                                                       value)) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            oldVal = p.val;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (!onlyIfAbsent)</span><br><span class=\"line\">                                p.val = value;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">              <span class=\"comment\">// 可以看一下上述的赋值流程</span></span><br><span class=\"line\">              <span class=\"comment\">// 默认初始值是0</span></span><br><span class=\"line\">              <span class=\"comment\">// 链表时为1 在遍历时进行累加，直到找到所要添加的位置为止</span></span><br><span class=\"line\">              <span class=\"comment\">// 红黑树时为2</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (binCount != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 链表的长度是否达到8  达到8转为红黑树</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class=\"line\">                    treeifyBin(tab, i);</span><br><span class=\"line\">                  <span class=\"comment\">// oldVal不为null，表示只是对key的值进行的修改，没有添加元素，直接返回即可</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (oldVal != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> oldVal;</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">      <span class=\"comment\">// </span></span><br><span class=\"line\">    addCount(<span class=\"number\">1L</span>, binCount);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>哈希函数根据hashCode计算出哈希值，这里的hash值与HashMap的计算方式稍微有点不同，在低十六位异或高十六位之后还需要与HASH_BITS在进行与运算，HASH_BITS的值是0x7fffffff，转为二进制是31个1，进行与运算是为了保证得到的hash值为正数。</p>\n<p>ConcurrentHashMap中hash值为负数包含有其他含义，-1表示为ForwardingNode节点，-2表示为TreeBin节点</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">spread</span><span class=\"params\">(<span class=\"keyword\">int</span> h)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// (h ^ (h &gt;&gt;&gt; 16)与hashMap相同</span></span><br><span class=\"line\">      <span class=\"comment\">// HASH_BITS进行与运算</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (h ^ (h &gt;&gt;&gt; <span class=\"number\">16</span>)) &amp; HASH_BITS;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>初始化hash表的操作</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class=\"line\">    Node&lt;K,V&gt;[] tab; <span class=\"keyword\">int</span> sc;</span><br><span class=\"line\">      <span class=\"comment\">// hash表为null时才需要进行初始化</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> ((tab = table) == <span class=\"keyword\">null</span> || tab.length == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// sizeCtl小于0表示有其他线程在进行初始化操作了</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((sc = sizeCtl) &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            Thread.yield(); <span class=\"comment\">// lost initialization race; just spin</span></span><br><span class=\"line\">          <span class=\"comment\">// 将SIZECTL设为-1，表示该线程要开始初始化表了</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (U.compareAndSwapInt(<span class=\"keyword\">this</span>, SIZECTL, sc, -<span class=\"number\">1</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((tab = table) == <span class=\"keyword\">null</span> || tab.length == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">int</span> n = (sc &gt; <span class=\"number\">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class=\"line\">                    <span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class=\"keyword\">new</span> Node&lt;?,?&gt;[n];</span><br><span class=\"line\">                    table = tab = nt;</span><br><span class=\"line\">                      <span class=\"comment\">// n右移两位  表示1/4n n-1/4n为3/4n  即为n*0.75</span></span><br><span class=\"line\">                    sc = n - (n &gt;&gt;&gt; <span class=\"number\">2</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                sizeCtl = sc;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> tab;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">addCount</span><span class=\"params\">(<span class=\"keyword\">long</span> x, <span class=\"keyword\">int</span> check)</span> </span>&#123;</span><br><span class=\"line\">    CounterCell[] as; <span class=\"keyword\">long</span> b, s;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((as = counterCells) != <span class=\"keyword\">null</span> ||</span><br><span class=\"line\">        !U.compareAndSwapLong(<span class=\"keyword\">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class=\"line\">        CounterCell a; <span class=\"keyword\">long</span> v; <span class=\"keyword\">int</span> m;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> uncontended = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (as == <span class=\"keyword\">null</span> || (m = as.length - <span class=\"number\">1</span>) &lt; <span class=\"number\">0</span> ||</span><br><span class=\"line\">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class=\"keyword\">null</span> ||</span><br><span class=\"line\">            !(uncontended =</span><br><span class=\"line\">              U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class=\"line\">            fullAddCount(x, uncontended);</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (check &lt;= <span class=\"number\">1</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        s = sumCount();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (check &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        Node&lt;K,V&gt;[] tab, nt; <span class=\"keyword\">int</span> n, sc;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (s &gt;= (<span class=\"keyword\">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class=\"keyword\">null</span> &amp;&amp;</span><br><span class=\"line\">               (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> rs = resizeStamp(n);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (sc &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class=\"number\">1</span> ||</span><br><span class=\"line\">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class=\"keyword\">null</span> ||</span><br><span class=\"line\">                    transferIndex &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (U.compareAndSwapInt(<span class=\"keyword\">this</span>, SIZECTL, sc, sc + <span class=\"number\">1</span>))</span><br><span class=\"line\">                    transfer(tab, nt);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (U.compareAndSwapInt(<span class=\"keyword\">this</span>, SIZECTL, sc,</span><br><span class=\"line\">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class=\"number\">2</span>))</span><br><span class=\"line\">                transfer(tab, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">            s = sumCount();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"LinkedList详解","url":"/2021/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/LinkedList%E8%AF%A6%E8%A7%A3/","content":"<h2 id=\"LinkedList详解\"><a href=\"#LinkedList详解\" class=\"headerlink\" title=\"LinkedList详解\"></a>LinkedList详解</h2><p>LinkedList是List接口的一个主要的实现类之一。以java8为例来了解一下LinkedList的源码实现</p>\n<a id=\"more\"></a>\n\n<h3 id=\"继承关系\"><a href=\"#继承关系\" class=\"headerlink\" title=\"继承关系\"></a>继承关系</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LinkedList</span>&lt;<span class=\"title\">E</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"keyword\">extends</span> <span class=\"title\">AbstractSequentialList</span>&lt;<span class=\"title\">E</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"keyword\">implements</span> <span class=\"title\">List</span>&lt;<span class=\"title\">E</span>&gt;, <span class=\"title\">Deque</span>&lt;<span class=\"title\">E</span>&gt;, <span class=\"title\">Cloneable</span>, <span class=\"title\">java</span>.<span class=\"title\">io</span>.<span class=\"title\">Serializable</span></span></span><br></pre></td></tr></table></figure>\n\n\n\n<img src=\"/images/java基础/集合/LinkedList.png\" alt=\"LinkedList\" style=\"zoom:50%;\">\n\n<p>继承了AbstractSequentialList，实现了List接口、Deque接口、Cloneable接口、Serializable接口</p>\n<h3 id=\"关键变量\"><a href=\"#关键变量\" class=\"headerlink\" title=\"关键变量\"></a>关键变量</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 链表的长度</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">transient</span> <span class=\"keyword\">int</span> size = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 头节点</span></span><br><span class=\"line\"><span class=\"comment\"> * Invariant: (first == null &amp;&amp; last == null) ||</span></span><br><span class=\"line\"><span class=\"comment\"> *            (first.prev == null &amp;&amp; first.item != null)</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">transient</span> Node&lt;E&gt; first;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 尾结点</span></span><br><span class=\"line\"><span class=\"comment\"> * Invariant: (first == null &amp;&amp; last == null) ||</span></span><br><span class=\"line\"><span class=\"comment\"> *            (last.next == null &amp;&amp; last.item != null)</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">transient</span> Node&lt;E&gt; last;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 这里用到了一个内部类Node，看到Node的结构就知道是一个双向链表了，保存了前驱节点和后继节点</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Node</span>&lt;<span class=\"title\">E</span>&gt; </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 当前元素</span></span><br><span class=\"line\">  E item;</span><br><span class=\"line\">  <span class=\"comment\">// 后继节点</span></span><br><span class=\"line\">  Node&lt;E&gt; next;</span><br><span class=\"line\">  <span class=\"comment\">// 前驱结点</span></span><br><span class=\"line\">  Node&lt;E&gt; prev;</span><br><span class=\"line\"></span><br><span class=\"line\">  Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.item = element;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.next = next;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.prev = prev;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"构造器\"><a href=\"#构造器\" class=\"headerlink\" title=\"构造器\"></a>构造器</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 无参默认构造器</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LinkedList</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 传入一个集合作为参数</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LinkedList</span><span class=\"params\">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>();</span><br><span class=\"line\">    addAll(c);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">addAll</span><span class=\"params\">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> addAll(size, c);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">addAll</span><span class=\"params\">(<span class=\"keyword\">int</span> index, Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 检查是否越界</span></span><br><span class=\"line\">  checkPositionIndex(index);</span><br><span class=\"line\"></span><br><span class=\"line\">  Object[] a = c.toArray();</span><br><span class=\"line\">  <span class=\"comment\">// 新增元素的数量</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> numNew = a.length;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (numNew == <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 前置节点和后置节点</span></span><br><span class=\"line\">  Node&lt;E&gt; pred, succ;</span><br><span class=\"line\">  <span class=\"comment\">// index == size时表示是从链表尾部添加元素，所以前置节点为当前链表的尾结点</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (index == size) &#123;</span><br><span class=\"line\">    succ = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    pred = last;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 不是从链表尾部添加，需要修改前置节点和后置节点</span></span><br><span class=\"line\">    succ = node(index);</span><br><span class=\"line\">    pred = succ.prev;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (Object o : a) &#123;</span><br><span class=\"line\">    <span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span> E e = (E) o;</span><br><span class=\"line\">    Node&lt;E&gt; newNode = <span class=\"keyword\">new</span> Node&lt;&gt;(pred, e, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 前置节点为null，表示这是头节点</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pred == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">      first = newNode;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      pred.next = newNode;</span><br><span class=\"line\">    pred = newNode;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">    <span class=\"comment\">// succ == null,说明是从尾部添加的，将最后一个节点赋给尾结点</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (succ == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    last = pred;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    pred.next = succ;</span><br><span class=\"line\">    succ.prev = pred;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  size += numNew;</span><br><span class=\"line\">  modCount++;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 获取index位置的节点</span></span><br><span class=\"line\"><span class=\"function\">Node&lt;E&gt; <span class=\"title\">node</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// assert isElementIndex(index);</span></span><br><span class=\"line\">    <span class=\"comment\">// index小于链表长度的一半，从链表头部开始遍历</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (index &lt; (size &gt;&gt; <span class=\"number\">1</span>)) &#123;</span><br><span class=\"line\">    Node&lt;E&gt; x = first;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; index; i++)</span><br><span class=\"line\">      x = x.next;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> x;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// index不小于链表长度的一半，从链表尾部开始遍历</span></span><br><span class=\"line\">    Node&lt;E&gt; x = last;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = size - <span class=\"number\">1</span>; i &gt; index; i--)</span><br><span class=\"line\">      x = x.prev;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> x;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"add方法\"><a href=\"#add方法\" class=\"headerlink\" title=\"add方法\"></a>add方法</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 逻辑比较简单，与上边addAll类似，一通插</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">add</span><span class=\"params\">(<span class=\"keyword\">int</span> index, E element)</span> </span>&#123;</span><br><span class=\"line\">    checkPositionIndex(index);</span><br><span class=\"line\">        <span class=\"comment\">// index == size表示在链表尾部添加</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (index == size)</span><br><span class=\"line\">        linkLast(element);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"comment\">// 否则在中间插入  先找到index所在位置的节点</span></span><br><span class=\"line\">        linkBefore(element, node(index));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">linkLast</span><span class=\"params\">(E e)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">final</span> Node&lt;E&gt; l = last;</span><br><span class=\"line\">  <span class=\"keyword\">final</span> Node&lt;E&gt; newNode = <span class=\"keyword\">new</span> Node&lt;&gt;(l, e, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">  last = newNode;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (l == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">      first = newNode;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">      l.next = newNode;</span><br><span class=\"line\">  size++;</span><br><span class=\"line\">  modCount++;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">linkBefore</span><span class=\"params\">(E e, Node&lt;E&gt; succ)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// assert succ != null;</span></span><br><span class=\"line\">  <span class=\"keyword\">final</span> Node&lt;E&gt; pred = succ.prev;</span><br><span class=\"line\">  <span class=\"keyword\">final</span> Node&lt;E&gt; newNode = <span class=\"keyword\">new</span> Node&lt;&gt;(pred, e, succ);</span><br><span class=\"line\">  succ.prev = newNode;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (pred == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">      first = newNode;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">      pred.next = newNode;</span><br><span class=\"line\">  size++;</span><br><span class=\"line\">  modCount++;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"remove方法\"><a href=\"#remove方法\" class=\"headerlink\" title=\"remove方法\"></a>remove方法</h3><p>LinkedList的remove方法比较</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> E <span class=\"title\">remove</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 检测该索引位置是否符合要求  index &gt;= 0 &amp;&amp; index &lt; size</span></span><br><span class=\"line\">    checkElementIndex(index);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> unlink(node(index));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 找到当前索引位置的节点</span></span><br><span class=\"line\"><span class=\"function\">Node&lt;E&gt; <span class=\"title\">node</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// assert isElementIndex(index);</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (index &lt; (size &gt;&gt; <span class=\"number\">1</span>)) &#123; <span class=\"comment\">// 索引位置小于长度的一半时，从头节点开始遍历</span></span><br><span class=\"line\">    Node&lt;E&gt; x = first;</span><br><span class=\"line\">    <span class=\"comment\">// 遍历</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; index; i++)</span><br><span class=\"line\">      x = x.next;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> x;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 索引位置大于长度的一半时，从尾节点开始遍历</span></span><br><span class=\"line\">    Node&lt;E&gt; x = last;</span><br><span class=\"line\">    <span class=\"comment\">// 遍历</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = size - <span class=\"number\">1</span>; i &gt; index; i--)</span><br><span class=\"line\">      x = x.prev;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> x;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">E <span class=\"title\">unlink</span><span class=\"params\">(Node&lt;E&gt; x)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// assert x != null;</span></span><br><span class=\"line\">  <span class=\"comment\">// 所要删除的元素</span></span><br><span class=\"line\">  <span class=\"keyword\">final</span> E element = x.item;</span><br><span class=\"line\">  <span class=\"comment\">// 所要删除的元素的后继节点</span></span><br><span class=\"line\">  <span class=\"keyword\">final</span> Node&lt;E&gt; next = x.next;</span><br><span class=\"line\">  <span class=\"comment\">// 所要删除的元素前驱结点</span></span><br><span class=\"line\">  <span class=\"keyword\">final</span> Node&lt;E&gt; prev = x.prev;</span><br><span class=\"line\">    <span class=\"comment\">// 前驱节点为null，表示为头节点，头节点指向后继节点即可</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (prev == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    first = next;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 前驱节点的后继节点指向该元素的后继节点</span></span><br><span class=\"line\">    prev.next = next;</span><br><span class=\"line\">    x.prev = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">    <span class=\"comment\">// 后继节点为null，表示为尾节点，尾节点指向前驱节点即可</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (next == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    last = prev;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 后继节点的前驱节点指向该元素的前驱节点</span></span><br><span class=\"line\">    next.prev = prev;</span><br><span class=\"line\">    x.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  x.item = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  size--;</span><br><span class=\"line\">  modCount++;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> element;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"迭代器\"><a href=\"#迭代器\" class=\"headerlink\" title=\"迭代器\"></a>迭代器</h3><p>LinkedList使用的迭代器是其父类AbstractSequentialList中的iterator方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// AbstractSequentialList类方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Iterator&lt;E&gt; <span class=\"title\">iterator</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> listIterator();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// LinkedList类方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> ListIterator&lt;E&gt; <span class=\"title\">listIterator</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">  checkPositionIndex(index);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ListItr(index);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  与ArrayList的迭代器不同的是，ArrayList的迭代器实现的是Iterator接口 而LinkedList为ListIterator接口，相当于ArrayList的listIterator()方法</span></span><br><span class=\"line\"><span class=\"comment\">//  Iterator只能向前遍历，ListIterator可以向前也可以向后</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ListItr</span> <span class=\"keyword\">implements</span> <span class=\"title\">ListIterator</span>&lt;<span class=\"title\">E</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Node&lt;E&gt; lastReturned;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Node&lt;E&gt; next;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> nextIndex;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> expectedModCount = modCount;</span><br><span class=\"line\"></span><br><span class=\"line\">    ListItr(<span class=\"keyword\">int</span> index) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// assert isPositionIndex(index);</span></span><br><span class=\"line\">        next = (index == size) ? <span class=\"keyword\">null</span> : node(index);</span><br><span class=\"line\">        nextIndex = index;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">hasNext</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> nextIndex &lt; size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> E <span class=\"title\">next</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        checkForComodification();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!hasNext())</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NoSuchElementException();</span><br><span class=\"line\"></span><br><span class=\"line\">        lastReturned = next;</span><br><span class=\"line\">        next = next.next;</span><br><span class=\"line\">        nextIndex++;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> lastReturned.item;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">hasPrevious</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> nextIndex &gt; <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> E <span class=\"title\">previous</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        checkForComodification();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!hasPrevious())</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NoSuchElementException();</span><br><span class=\"line\"></span><br><span class=\"line\">        lastReturned = next = (next == <span class=\"keyword\">null</span>) ? last : next.prev;</span><br><span class=\"line\">        nextIndex--;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> lastReturned.item;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">nextIndex</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> nextIndex;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">previousIndex</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> nextIndex - <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">remove</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        checkForComodification();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (lastReturned == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException();</span><br><span class=\"line\"></span><br><span class=\"line\">        Node&lt;E&gt; lastNext = lastReturned.next;</span><br><span class=\"line\">        unlink(lastReturned);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (next == lastReturned)</span><br><span class=\"line\">            next = lastNext;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            nextIndex--;</span><br><span class=\"line\">        lastReturned = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        expectedModCount++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">set</span><span class=\"params\">(E e)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (lastReturned == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException();</span><br><span class=\"line\">        checkForComodification();</span><br><span class=\"line\">        lastReturned.item = e;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">add</span><span class=\"params\">(E e)</span> </span>&#123;</span><br><span class=\"line\">        checkForComodification();</span><br><span class=\"line\">        lastReturned = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (next == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            linkLast(e);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            linkBefore(e, next);</span><br><span class=\"line\">        nextIndex++;</span><br><span class=\"line\">        expectedModCount++;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">forEachRemaining</span><span class=\"params\">(Consumer&lt;? <span class=\"keyword\">super</span> E&gt; action)</span> </span>&#123;</span><br><span class=\"line\">        Objects.requireNonNull(action);</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (modCount == expectedModCount &amp;&amp; nextIndex &lt; size) &#123;</span><br><span class=\"line\">            action.accept(next.item);</span><br><span class=\"line\">            lastReturned = next;</span><br><span class=\"line\">            next = next.next;</span><br><span class=\"line\">            nextIndex++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        checkForComodification();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">checkForComodification</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (modCount != expectedModCount)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"Map","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/Map/","content":"<h2 id=\"Map\"><a href=\"#Map\" class=\"headerlink\" title=\"Map\"></a>Map</h2><p>Map是一个接口，下面介绍一下Map接口的一些常用的实现类</p>\n<a id=\"more\"></a>\n\n<h3 id=\"Hashtable\"><a href=\"#Hashtable\" class=\"headerlink\" title=\"Hashtable\"></a>Hashtable</h3><p>Hashtable是在java1.0中实现的最早的Map，继承自Dictionary类，底层使用的哈希表，是线程安全的，因为该类中的方法都是用了synchronized修饰，但是也因此存在了效率问题</p>\n<p>如果想要使用具有用线程安全能力的map可以使用Collections.synchronizedMap()方法或者使用ConcurrentHashMap</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Hashtable</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"keyword\">extends</span> <span class=\"title\">Dictionary</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"keyword\">implements</span> <span class=\"title\">Map</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt;, <span class=\"title\">Cloneable</span>, <span class=\"title\">java</span>.<span class=\"title\">io</span>.<span class=\"title\">Serializable</span> </span>&#123;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> V <span class=\"title\">get</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">  Entry&lt;?,?&gt; tab[] = table;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> hash = key.hashCode();</span><br><span class=\"line\">  <span class=\"keyword\">int</span> index = (hash &amp; <span class=\"number\">0x7FFFFFFF</span>) % tab.length;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (Entry&lt;?,?&gt; e = tab[index] ; e != <span class=\"keyword\">null</span> ; e = e.next) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> (V)e.value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>内部所使用的是一个Entry数组进行存储的，Entry实际上是一个链表，key和value都保存在Entry中</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The hash table data.</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> Entry&lt;?,?&gt;[] table;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Entry</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; <span class=\"keyword\">implements</span> <span class=\"title\">Map</span>.<span class=\"title\">Entry</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> hash;</span><br><span class=\"line\">  <span class=\"keyword\">final</span> K key;</span><br><span class=\"line\">  V value;</span><br><span class=\"line\">  Entry&lt;K,V&gt; next;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"title\">Entry</span><span class=\"params\">(<span class=\"keyword\">int</span> hash, K key, V value, Entry&lt;K,V&gt; next)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.hash = hash;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.key =  key;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.value = value;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.next = next;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">protected</span> Object <span class=\"title\">clone</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Entry&lt;&gt;(hash, key, value,</span><br><span class=\"line\">                       (next==<span class=\"keyword\">null</span> ? <span class=\"keyword\">null</span> : (Entry&lt;K,V&gt;) next.clone()));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Map.Entry Ops</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> K <span class=\"title\">getKey</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> key;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">getValue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">setValue</span><span class=\"params\">(V value)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (value == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NullPointerException();</span><br><span class=\"line\"></span><br><span class=\"line\">    V oldValue = <span class=\"keyword\">this</span>.value;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.value = value;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!(o <span class=\"keyword\">instanceof</span> Map.Entry))</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (key==<span class=\"keyword\">null</span> ? e.getKey()==<span class=\"keyword\">null</span> : key.equals(e.getKey())) &amp;&amp;</span><br><span class=\"line\">      (value==<span class=\"keyword\">null</span> ? e.getValue()==<span class=\"keyword\">null</span> : value.equals(e.getValue()));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> hash ^ Objects.hashCode(value);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">toString</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> key.toString()+<span class=\"string\">&quot;=&quot;</span>+value.toString();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>HashTable的key和value都不允许为null，可以看到在put操作的时候，会校验value值是否为null，而且会获取key的hashCode，所以key和value都不可以为null</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> V <span class=\"title\">put</span><span class=\"params\">(K key, V value)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// Make sure the value is not null</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (value == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NullPointerException();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Makes sure the key is not already in the hashtable.</span></span><br><span class=\"line\">  Entry&lt;?,?&gt; tab[] = table;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> hash = key.hashCode();</span><br><span class=\"line\">  <span class=\"keyword\">int</span> index = (hash &amp; <span class=\"number\">0x7FFFFFFF</span>) % tab.length;</span><br><span class=\"line\">  <span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\">  Entry&lt;K,V&gt; entry = (Entry&lt;K,V&gt;)tab[index];</span><br><span class=\"line\">  <span class=\"keyword\">for</span>(; entry != <span class=\"keyword\">null</span> ; entry = entry.next) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((entry.hash == hash) &amp;&amp; entry.key.equals(key)) &#123;</span><br><span class=\"line\">      V old = entry.value;</span><br><span class=\"line\">      entry.value = value;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> old;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  addEntry(hash, key, value, index);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h3><p>当前用的最多的还是HashMap</p>\n<p>HashMap是线程不安全的，底层也是哈希表，与HashTable不同的是，key和value可以为null</p>\n<p>可以看到在put方法取key的hash值时对key进行了判断，key为null的话，hash值为0</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">put</span><span class=\"params\">(K key, V value)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> putVal(hash(key), key, value, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">hash</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> h;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (key == <span class=\"keyword\">null</span>) ? <span class=\"number\">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class=\"number\">16</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>HashMap的底层使用Node数组来存储的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">transient</span> Node&lt;K,V&gt;[] table;</span><br></pre></td></tr></table></figure>\n\n<p>HashMap如果出现hash冲突的话，会在放到链表中，但是如果hash冲突过多的话，会导致链表太长，查询时性能会下降，在链表长度超过一定值时，会进行结构改造，将链表转换为树状结构，这里TREEIFY_THRESHOLD是8</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> V <span class=\"title\">putVal</span><span class=\"params\">(<span class=\"keyword\">int</span> hash, K key, V value, <span class=\"keyword\">boolean</span> onlyIfAbsent,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">               <span class=\"keyword\">boolean</span> evict)</span> </span>&#123;</span><br><span class=\"line\">  Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class=\"keyword\">int</span> n, i;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((tab = table) == <span class=\"keyword\">null</span> || (n = tab.length) == <span class=\"number\">0</span>) <span class=\"comment\">// table为null，进行初始化</span></span><br><span class=\"line\">    n = (tab = resize()).length;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((p = tab[i = (n - <span class=\"number\">1</span>) &amp; hash]) == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">    tab[i] = newNode(hash, key, value, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">  <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    Node&lt;K,V&gt; e; K k;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;</span><br><span class=\"line\">        ((k = p.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">      e = p;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">      e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class=\"keyword\">this</span>, tab, hash, key, value);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 遍历map</span></span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> binCount = <span class=\"number\">0</span>; ; ++binCount) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 遍历完依旧没有该key，需要添加一个新的节点</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((e = p.next) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">          p.next = newNode(hash, key, value, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class=\"number\">1</span>) <span class=\"comment\">// -1 for 1st</span></span><br><span class=\"line\">            <span class=\"comment\">// 链表转为树状结构</span></span><br><span class=\"line\">            treeifyBin(tab, hash);</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">            ((k = e.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        p = e;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (e != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// existing mapping for key</span></span><br><span class=\"line\">      V oldValue = e.value;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!onlyIfAbsent || oldValue == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        e.value = value;</span><br><span class=\"line\">      afterNodeAccess(e);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ++modCount;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (++size &gt; threshold)</span><br><span class=\"line\">    resize();</span><br><span class=\"line\">  afterNodeInsertion(evict);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"TreeMap\"><a href=\"#TreeMap\" class=\"headerlink\" title=\"TreeMap\"></a>TreeMap</h3><p>TreeMap底层是红黑树，实现了SortedMap接口，顺序由key控制(默认是按key进行，key必须实现Comparable接口或者在构造器传入自定义的Comparator)，通过Comparator或者Comparable决定，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TreeMap</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"keyword\">extends</span> <span class=\"title\">AbstractMap</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"keyword\">implements</span> <span class=\"title\">NavigableMap</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt;, <span class=\"title\">Cloneable</span>, <span class=\"title\">java</span>.<span class=\"title\">io</span>.<span class=\"title\">Serializable</span></span></span><br><span class=\"line\"><span class=\"class\"></span></span><br><span class=\"line\"><span class=\"class\"> <span class=\"title\">public</span> <span class=\"title\">interface</span> <span class=\"title\">NavigableMap</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; <span class=\"keyword\">extends</span> <span class=\"title\">SortedMap</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// key进行比较</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">compare</span><span class=\"params\">(Object k1, Object k2)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> comparator==<span class=\"keyword\">null</span> ? ((Comparable&lt;? <span class=\"keyword\">super</span> K&gt;)k1).compareTo((K)k2)</span><br><span class=\"line\">        : comparator.compare((K)k1, (K)k2);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"LinkedHashMap\"><a href=\"#LinkedHashMap\" class=\"headerlink\" title=\"LinkedHashMap\"></a>LinkedHashMap</h3><p>LinkedHashMap属于一个双向链表，通过键值来维护，遍历顺序为插入顺序，相当于一个有顺序的HashMap</p>\n<p>增加了两个属性来保证迭代顺序，分别是双向链表的头结点header和标志位accessOrder(值为true表示按照访问顺序迭代，值为false表示按照插入顺序迭代)</p>\n<p>默认构造器accessOrder为false是按照插入顺序迭代的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LinkedHashMap</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">super</span>();</span><br><span class=\"line\">  accessOrder = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ConcurrentHashMap\"><a href=\"#ConcurrentHashMap\" class=\"headerlink\" title=\"ConcurrentHashMap\"></a>ConcurrentHashMap</h3><p>ConcurrentHashMap是并发包下的类，属于线程安全的HashMap。</p>\n<p>java8中ConcurrentHashMap放弃了Segment分段加锁的机制，采用了Node+CAS+Syncronized保证并发安全。</p>\n<p>大量地采用了自旋+CAS操作</p>\n<p>key和value都不可以为null，否则会抛出空指针异常</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> V <span class=\"title\">putVal</span><span class=\"params\">(K key, V value, <span class=\"keyword\">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (key == <span class=\"keyword\">null</span> || value == <span class=\"keyword\">null</span>) <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NullPointerException();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> hash = spread(key.hashCode());</span><br><span class=\"line\">        <span class=\"keyword\">int</span> binCount = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class=\"line\">            Node&lt;K,V&gt; f; <span class=\"keyword\">int</span> n, i, fh;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tab == <span class=\"keyword\">null</span> || (n = tab.length) == <span class=\"number\">0</span>)</span><br><span class=\"line\">                tab = initTable();</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((f = tabAt(tab, i = (n - <span class=\"number\">1</span>) &amp; hash)) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (casTabAt(tab, i, <span class=\"keyword\">null</span>,</span><br><span class=\"line\">                             <span class=\"keyword\">new</span> Node&lt;K,V&gt;(hash, key, value, <span class=\"keyword\">null</span>)))</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;                   <span class=\"comment\">// no lock when adding to empty bin</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((fh = f.hash) == MOVED)</span><br><span class=\"line\">                tab = helpTransfer(tab, f);</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                V oldVal = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">synchronized</span> (f) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (fh &gt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                            binCount = <span class=\"number\">1</span>;</span><br><span class=\"line\">                            <span class=\"keyword\">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class=\"line\">                                K ek;</span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">                                    ((ek = e.key) == key ||</span><br><span class=\"line\">                                     (ek != <span class=\"keyword\">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class=\"line\">                                    oldVal = e.val;</span><br><span class=\"line\">                                    <span class=\"keyword\">if</span> (!onlyIfAbsent)</span><br><span class=\"line\">                                        e.val = value;</span><br><span class=\"line\">                                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                                Node&lt;K,V&gt; pred = e;</span><br><span class=\"line\">                                <span class=\"keyword\">if</span> ((e = e.next) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                                    pred.next = <span class=\"keyword\">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class=\"line\">                                                              value, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">                                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (f <span class=\"keyword\">instanceof</span> TreeBin) &#123;</span><br><span class=\"line\">                            Node&lt;K,V&gt; p;</span><br><span class=\"line\">                            binCount = <span class=\"number\">2</span>;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class=\"line\">                                                           value)) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                                oldVal = p.val;</span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (!onlyIfAbsent)</span><br><span class=\"line\">                                    p.val = value;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (binCount != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class=\"line\">                        treeifyBin(tab, i);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (oldVal != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> oldVal;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        addCount(<span class=\"number\">1L</span>, binCount);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"HashMap和HashTable的区别\"><a href=\"#HashMap和HashTable的区别\" class=\"headerlink\" title=\"HashMap和HashTable的区别\"></a>HashMap和HashTable的区别</h3><ul>\n<li>HashMap线程不安全，HashTable线程安全</li>\n<li>HashMap性能比HashTable好</li>\n<li>HashMap键值允许为null，HashTable键值不允许为null</li>\n<li>HashMap继承AbstractMap，HashTable继承Dictionary类</li>\n<li>HashMap初始容量为16，HashTable初始容量为11</li>\n<li>HashMap扩容是翻一倍，HashTable是翻一倍+1</li>\n<li>HashMap的Iterator迭代器是fail-fast的，而HashTable的Enumerator是fail-safe的</li>\n</ul>\n","categories":["java基础"],"tags":["java基础"]},{"title":"TreeMap详解","url":"/2021/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/TreeMap%E8%AF%A6%E8%A7%A3/","content":"<h2 id=\"TreeMap详解\"><a href=\"#TreeMap详解\" class=\"headerlink\" title=\"TreeMap详解\"></a>TreeMap详解</h2><p>TreeMap是Map接口的一个实现类，底层基于红黑树的实现</p>\n<a id=\"more\"></a>\n\n<img src=\"/images/java基础/集合/TreeMap.png\" alt=\"TreeMap\" style=\"zoom:50%;\">\n\n<p>从继承机构可以看到TreeMap除了继承了AbstractMap类，还实现了NavigableMap接口，而NavigableMap接口是继承自SortedMap接口的，所以TreeMap是可以进行排序的</p>\n<h3 id=\"关键变量\"><a href=\"#关键变量\" class=\"headerlink\" title=\"关键变量\"></a>关键变量</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 比较器，根据比较器来决定TreeMap的排序，如果为空，按照key做自然排序(最小的在根节点)</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Comparator&lt;? <span class=\"keyword\">super</span> K&gt; comparator;</span><br><span class=\"line\"><span class=\"comment\">// 根节点</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> Entry&lt;K,V&gt; root;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The number of entries in the tree</span></span><br><span class=\"line\"><span class=\"comment\"> * 树的大小</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">int</span> size = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * The number of structural modifications to the tree.</span></span><br><span class=\"line\"><span class=\"comment\"> * 修改次数</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> <span class=\"keyword\">int</span> modCount = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Entry为TreeMap的内部类</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Entry</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; <span class=\"keyword\">implements</span> <span class=\"title\">Map</span>.<span class=\"title\">Entry</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; </span>&#123;</span><br><span class=\"line\">        K key;</span><br><span class=\"line\">        V value;</span><br><span class=\"line\">        Entry&lt;K,V&gt; left;</span><br><span class=\"line\">        Entry&lt;K,V&gt; right;</span><br><span class=\"line\">        Entry&lt;K,V&gt; parent;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> color = BLACK;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"构造函数\"><a href=\"#构造函数\" class=\"headerlink\" title=\"构造函数\"></a>构造函数</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 默认空参构造器，比较器设置为空</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TreeMap</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    comparator = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 提供比较器</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TreeMap</span><span class=\"params\">(Comparator&lt;? <span class=\"keyword\">super</span> K&gt; comparator)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.comparator = comparator;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TreeMap</span><span class=\"params\">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class=\"line\">  comparator = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  putAll(m);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TreeMap</span><span class=\"params\">(SortedMap&lt;K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class=\"line\">  comparator = m.comparator();</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    buildFromSorted(m.size(), m.entrySet().iterator(), <span class=\"keyword\">null</span>, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (java.io.IOException cannotHappen) &#123;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException cannotHappen) &#123;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"get方法\"><a href=\"#get方法\" class=\"headerlink\" title=\"get方法\"></a>get方法</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">get</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">    Entry&lt;K,V&gt; p = getEntry(key);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (p==<span class=\"keyword\">null</span> ? <span class=\"keyword\">null</span> : p.value);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> Entry&lt;K,V&gt; <span class=\"title\">getEntry</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// Offload comparator-based version for sake of performance</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (comparator != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> getEntryUsingComparator(key);</span><br><span class=\"line\">  <span class=\"comment\">// 从这里可以看出TreeMap的key不可以为null</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (key == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NullPointerException();</span><br><span class=\"line\">  <span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\">  Comparable&lt;? <span class=\"keyword\">super</span> K&gt; k = (Comparable&lt;? <span class=\"keyword\">super</span> K&gt;) key;</span><br><span class=\"line\">  <span class=\"comment\">// 获取根节点</span></span><br><span class=\"line\">  Entry&lt;K,V&gt; p = root;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (p != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 判断是根节点的左子树还是右子树</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> cmp = k.compareTo(p.key);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (cmp &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">      p = p.left;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (cmp &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">      p = p.right;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"keyword\">return</span> p;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"put方法\"><a href=\"#put方法\" class=\"headerlink\" title=\"put方法\"></a>put方法</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">put</span><span class=\"params\">(K key, V value)</span> </span>&#123;</span><br><span class=\"line\">    Entry&lt;K,V&gt; t = root;</span><br><span class=\"line\">      <span class=\"comment\">// 根节点为null，表示这是第一个元素</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (t == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 主要是为了确保key是可排序的类，以及key不能为null</span></span><br><span class=\"line\">        compare(key, key); <span class=\"comment\">// type (and possibly null) check</span></span><br><span class=\"line\">                <span class=\"comment\">// 第三个参数为父节点的entry，根节点没有父节点，所以为null</span></span><br><span class=\"line\">        root = <span class=\"keyword\">new</span> Entry&lt;&gt;(key, value, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">        size = <span class=\"number\">1</span>;</span><br><span class=\"line\">        modCount++;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> cmp;</span><br><span class=\"line\">    Entry&lt;K,V&gt; parent;</span><br><span class=\"line\">    <span class=\"comment\">// split comparator and comparable paths</span></span><br><span class=\"line\">    Comparator&lt;? <span class=\"keyword\">super</span> K&gt; cpr = comparator;</span><br><span class=\"line\">      <span class=\"comment\">// 存在比较器的情况</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (cpr != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">            parent = t;</span><br><span class=\"line\">            cmp = cpr.compare(key, t.key);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cmp &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                t = t.left;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (cmp &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                t = t.right;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> t.setValue(value);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">while</span> (t != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">      <span class=\"comment\">// 不存在比较器，进行自然排序</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// key不能为null</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (key == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NullPointerException();</span><br><span class=\"line\">        <span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\">            Comparable&lt;? <span class=\"keyword\">super</span> K&gt; k = (Comparable&lt;? <span class=\"keyword\">super</span> K&gt;) key;</span><br><span class=\"line\">      <span class=\"comment\">// do...while是为了找到该key所要存放的位置(找到父节点)</span></span><br><span class=\"line\">        <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">            parent = t;</span><br><span class=\"line\">            cmp = k.compareTo(t.key);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cmp &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                t = t.left;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (cmp &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">                t = t.right;</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> t.setValue(value);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">while</span> (t != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    Entry&lt;K,V&gt; e = <span class=\"keyword\">new</span> Entry&lt;&gt;(key, value, parent);</span><br><span class=\"line\">      <span class=\"comment\">// 比父节点小，是左子树</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (cmp &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        parent.left = e;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        parent.right = e;</span><br><span class=\"line\">      <span class=\"comment\">// 插入之后还要进行平衡操作</span></span><br><span class=\"line\">    fixAfterInsertion(e);</span><br><span class=\"line\">    size++;</span><br><span class=\"line\">    modCount++;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">fixAfterInsertion</span><span class=\"params\">(Entry&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class=\"line\">  x.color = RED;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (x != <span class=\"keyword\">null</span> &amp;&amp; x != root &amp;&amp; x.parent.color == RED) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (parentOf(x) == leftOf(parentOf(parentOf(x)))) &#123;</span><br><span class=\"line\">      Entry&lt;K,V&gt; y = rightOf(parentOf(parentOf(x)));</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (colorOf(y) == RED) &#123;</span><br><span class=\"line\">        setColor(parentOf(x), BLACK);</span><br><span class=\"line\">        setColor(y, BLACK);</span><br><span class=\"line\">        setColor(parentOf(parentOf(x)), RED);</span><br><span class=\"line\">        x = parentOf(parentOf(x));</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (x == rightOf(parentOf(x))) &#123;</span><br><span class=\"line\">          x = parentOf(x);</span><br><span class=\"line\">          rotateLeft(x);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        setColor(parentOf(x), BLACK);</span><br><span class=\"line\">        setColor(parentOf(parentOf(x)), RED);</span><br><span class=\"line\">        rotateRight(parentOf(parentOf(x)));</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      Entry&lt;K,V&gt; y = leftOf(parentOf(parentOf(x)));</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (colorOf(y) == RED) &#123;</span><br><span class=\"line\">        setColor(parentOf(x), BLACK);</span><br><span class=\"line\">        setColor(y, BLACK);</span><br><span class=\"line\">        setColor(parentOf(parentOf(x)), RED);</span><br><span class=\"line\">        x = parentOf(parentOf(x));</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (x == leftOf(parentOf(x))) &#123;</span><br><span class=\"line\">          x = parentOf(x);</span><br><span class=\"line\">          rotateRight(x);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        setColor(parentOf(x), BLACK);</span><br><span class=\"line\">        setColor(parentOf(parentOf(x)), RED);</span><br><span class=\"line\">        rotateLeft(parentOf(parentOf(x)));</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  root.color = BLACK;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"remove方法\"><a href=\"#remove方法\" class=\"headerlink\" title=\"remove方法\"></a>remove方法</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">remove</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 获取到该key对应的节点 和get相同</span></span><br><span class=\"line\">    Entry&lt;K,V&gt; p = getEntry(key);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    V oldValue = p.value;</span><br><span class=\"line\">    deleteEntry(p);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">deleteEntry</span><span class=\"params\">(Entry&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class=\"line\">  modCount++;</span><br><span class=\"line\">  size--;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// If strictly internal, copy successor&#x27;s element to p and then make p</span></span><br><span class=\"line\">  <span class=\"comment\">// point to successor.</span></span><br><span class=\"line\">  <span class=\"comment\">// 存在两个子树(左子树和右子树)</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (p.left != <span class=\"keyword\">null</span> &amp;&amp; p.right != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 找到与p数值最接近的节点(即右子树的最左叶子节点)</span></span><br><span class=\"line\">    Entry&lt;K,V&gt; s = successor(p);</span><br><span class=\"line\">    p.key = s.key;</span><br><span class=\"line\">    p.value = s.value;</span><br><span class=\"line\">    p = s;</span><br><span class=\"line\">  &#125; <span class=\"comment\">// p has 2 children</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Start fixup at replacement node, if it exists.</span></span><br><span class=\"line\">  <span class=\"comment\">// 找到所要替代的节点</span></span><br><span class=\"line\">  Entry&lt;K,V&gt; replacement = (p.left != <span class=\"keyword\">null</span> ? p.left : p.right);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (replacement != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Link replacement to parent</span></span><br><span class=\"line\">    <span class=\"comment\">// 替换节点</span></span><br><span class=\"line\">    replacement.parent = p.parent;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p.parent == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">      root = replacement;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p == p.parent.left)</span><br><span class=\"line\">      p.parent.left  = replacement;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      p.parent.right = replacement;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Null out links so they are OK to use by fixAfterDeletion.</span></span><br><span class=\"line\">    p.left = p.right = p.parent = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Fix replacement</span></span><br><span class=\"line\">    <span class=\"comment\">// 删除的节点为黑色节点，需要进行平衡</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p.color == BLACK)</span><br><span class=\"line\">      fixAfterDeletion(replacement);</span><br><span class=\"line\">  &#125; </span><br><span class=\"line\">  <span class=\"comment\">// 此时replacement为null(表明 p没有左子树也没有右子树)，如果p没有父节点，表明该树只有一个根节点</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p.parent == <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// return if we are the only node.</span></span><br><span class=\"line\">    root = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  &#125; </span><br><span class=\"line\">  <span class=\"comment\">// 此时replacement为null(表明 p没有左子树也没有右子树)，表明该节点为叶子节点</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span> &#123; <span class=\"comment\">//  No children. Use self as phantom replacement and unlink.</span></span><br><span class=\"line\">    <span class=\"comment\">// 删除的节点为黑色节点，需要进行平衡</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p.color == BLACK)</span><br><span class=\"line\">      fixAfterDeletion(p);</span><br><span class=\"line\">        <span class=\"comment\">// 将p从树中移除</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p.parent != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (p == p.parent.left)</span><br><span class=\"line\">        p.parent.left = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p == p.parent.right)</span><br><span class=\"line\">        p.parent.right = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">      p.parent = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> &lt;K,V&gt; TreeMap.<span class=\"function\">Entry&lt;K,V&gt; <span class=\"title\">successor</span><span class=\"params\">(Entry&lt;K,V&gt; t)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (t == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (t.right != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 右节点不为null，找到后继节点(即右子树的左叶子节点)</span></span><br><span class=\"line\">    Entry&lt;K,V&gt; p = t.right;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (p.left != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">      p = p.left;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> p;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    Entry&lt;K,V&gt; p = t.parent;</span><br><span class=\"line\">    Entry&lt;K,V&gt; ch = t;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (p != <span class=\"keyword\">null</span> &amp;&amp; ch == p.right) &#123;</span><br><span class=\"line\">      ch = p;</span><br><span class=\"line\">      p = p.parent;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> p;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">fixAfterDeletion</span><span class=\"params\">(Entry&lt;K,V&gt; x)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (x != root &amp;&amp; colorOf(x) == BLACK) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (x == leftOf(parentOf(x))) &#123;</span><br><span class=\"line\">      Entry&lt;K,V&gt; sib = rightOf(parentOf(x));</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (colorOf(sib) == RED) &#123;</span><br><span class=\"line\">        setColor(sib, BLACK);</span><br><span class=\"line\">        setColor(parentOf(x), RED);</span><br><span class=\"line\">        rotateLeft(parentOf(x));</span><br><span class=\"line\">        sib = rightOf(parentOf(x));</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (colorOf(leftOf(sib))  == BLACK &amp;&amp;</span><br><span class=\"line\">          colorOf(rightOf(sib)) == BLACK) &#123;</span><br><span class=\"line\">        setColor(sib, RED);</span><br><span class=\"line\">        x = parentOf(x);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (colorOf(rightOf(sib)) == BLACK) &#123;</span><br><span class=\"line\">          setColor(leftOf(sib), BLACK);</span><br><span class=\"line\">          setColor(sib, RED);</span><br><span class=\"line\">          rotateRight(sib);</span><br><span class=\"line\">          sib = rightOf(parentOf(x));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        setColor(sib, colorOf(parentOf(x)));</span><br><span class=\"line\">        setColor(parentOf(x), BLACK);</span><br><span class=\"line\">        setColor(rightOf(sib), BLACK);</span><br><span class=\"line\">        rotateLeft(parentOf(x));</span><br><span class=\"line\">        x = root;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// symmetric</span></span><br><span class=\"line\">      Entry&lt;K,V&gt; sib = leftOf(parentOf(x));</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (colorOf(sib) == RED) &#123;</span><br><span class=\"line\">        setColor(sib, BLACK);</span><br><span class=\"line\">        setColor(parentOf(x), RED);</span><br><span class=\"line\">        rotateRight(parentOf(x));</span><br><span class=\"line\">        sib = leftOf(parentOf(x));</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (colorOf(rightOf(sib)) == BLACK &amp;&amp;</span><br><span class=\"line\">          colorOf(leftOf(sib)) == BLACK) &#123;</span><br><span class=\"line\">        setColor(sib, RED);</span><br><span class=\"line\">        x = parentOf(x);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (colorOf(leftOf(sib)) == BLACK) &#123;</span><br><span class=\"line\">          setColor(rightOf(sib), BLACK);</span><br><span class=\"line\">          setColor(sib, RED);</span><br><span class=\"line\">          rotateLeft(sib);</span><br><span class=\"line\">          sib = leftOf(parentOf(x));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        setColor(sib, colorOf(parentOf(x)));</span><br><span class=\"line\">        setColor(parentOf(x), BLACK);</span><br><span class=\"line\">        setColor(leftOf(sib), BLACK);</span><br><span class=\"line\">        rotateRight(parentOf(x));</span><br><span class=\"line\">        x = root;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  setColor(x, BLACK);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"PriorityQueue详解","url":"/2021/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/PriorityQueue%E8%AF%A6%E8%A7%A3/","content":"<h2 id=\"PriorityQueue详解\"><a href=\"#PriorityQueue详解\" class=\"headerlink\" title=\"PriorityQueue详解\"></a>PriorityQueue详解</h2><p>PriorityQueue是优先级队列，底层使用数组存储，是基于二叉堆的一个无界队列，可以使用默认排序或者提供Comparator比较器使得队列中的元素有序</p>\n<a id=\"more\"></a>\n\n<h3 id=\"存储结构\"><a href=\"#存储结构\" class=\"headerlink\" title=\"存储结构\"></a>存储结构</h3><h4 id=\"小顶堆\"><a href=\"#小顶堆\" class=\"headerlink\" title=\"小顶堆\"></a>小顶堆</h4><p>根节点的元素最小是小顶堆(小于左右子节点的值)</p>\n<pre class=\"mermaid\">graph TD\n0((0)) --- 1((1)) --- 3((3))\n1((1)) --- 4((4))\n0((0)) --- 2((2))</pre>\n\n<h4 id=\"大顶堆\"><a href=\"#大顶堆\" class=\"headerlink\" title=\"大顶堆\"></a>大顶堆</h4><p>根节点的元素最大是大顶堆(大于左右子节点的值)</p>\n<pre class=\"mermaid\">graph TD\n0((4)) --- 1((3)) --- 3((1))\n1((3)) --- 4((0))\n0((4)) --- 2((2))</pre>\n\n<h3 id=\"源码分析\"><a href=\"#源码分析\" class=\"headerlink\" title=\"源码分析\"></a>源码分析</h3><h4 id=\"重要属性\"><a href=\"#重要属性\" class=\"headerlink\" title=\"重要属性\"></a>重要属性</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 默认的初始容量</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> DEFAULT_INITIAL_CAPACITY = <span class=\"number\">11</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 使用数组存放  是一个平衡二叉堆，对于queue[n]有两个子节点queue[2*n+1] 和 queue[2*(n+1)]</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">transient</span> Object[] queue; <span class=\"comment\">// non-private to simplify nested class access</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 优先队列中的元素个数</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> size = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 比较器，如果为null，为使用默认的自然排序</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Comparator&lt;? <span class=\"keyword\">super</span> E&gt; comparator;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 修改次数</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">transient</span> <span class=\"keyword\">int</span> modCount = <span class=\"number\">0</span>; <span class=\"comment\">// non-private to simplify nested class access</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 最大容量</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> MAX_ARRAY_SIZE = Integer.MAX_VALUE - <span class=\"number\">8</span>;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"构造器\"><a href=\"#构造器\" class=\"headerlink\" title=\"构造器\"></a>构造器</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PriorityQueue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>(DEFAULT_INITIAL_CAPACITY, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PriorityQueue</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>(initialCapacity, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PriorityQueue</span><span class=\"params\">(Comparator&lt;? <span class=\"keyword\">super</span> E&gt; comparator)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>(DEFAULT_INITIAL_CAPACITY, comparator);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PriorityQueue</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                     Comparator&lt;? <span class=\"keyword\">super</span> E&gt; comparator)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Note: This restriction of at least one is not actually needed,</span></span><br><span class=\"line\">    <span class=\"comment\">// but continues for 1.5 compatibility</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (initialCapacity &lt; <span class=\"number\">1</span>)</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException();</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.queue = <span class=\"keyword\">new</span> Object[initialCapacity];</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.comparator = comparator;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PriorityQueue</span><span class=\"params\">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (c <span class=\"keyword\">instanceof</span> SortedSet&lt;?&gt;) &#123;</span><br><span class=\"line\">        SortedSet&lt;? extends E&gt; ss = (SortedSet&lt;? extends E&gt;) c;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.comparator = (Comparator&lt;? <span class=\"keyword\">super</span> E&gt;) ss.comparator();</span><br><span class=\"line\">        initElementsFromCollection(ss);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (c <span class=\"keyword\">instanceof</span> PriorityQueue&lt;?&gt;) &#123;</span><br><span class=\"line\">        PriorityQueue&lt;? extends E&gt; pq = (PriorityQueue&lt;? extends E&gt;) c;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.comparator = (Comparator&lt;? <span class=\"keyword\">super</span> E&gt;) pq.comparator();</span><br><span class=\"line\">        initFromPriorityQueue(pq);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.comparator = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        initFromCollection(c);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PriorityQueue</span><span class=\"params\">(PriorityQueue&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.comparator = (Comparator&lt;? <span class=\"keyword\">super</span> E&gt;) c.comparator();</span><br><span class=\"line\">    initFromPriorityQueue(c);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PriorityQueue</span><span class=\"params\">(SortedSet&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.comparator = (Comparator&lt;? <span class=\"keyword\">super</span> E&gt;) c.comparator();</span><br><span class=\"line\">    initElementsFromCollection(c);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"常用方法\"><a href=\"#常用方法\" class=\"headerlink\" title=\"常用方法\"></a>常用方法</h4><h5 id=\"获取顶端元素\"><a href=\"#获取顶端元素\" class=\"headerlink\" title=\"获取顶端元素\"></a>获取顶端元素</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 直接取数组中的第一个元素就是顶端元素</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> E <span class=\"title\">peek</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (size == <span class=\"number\">0</span>) ? <span class=\"keyword\">null</span> : (E) queue[<span class=\"number\">0</span>];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"插入\"><a href=\"#插入\" class=\"headerlink\" title=\"插入\"></a>插入</h5><p>以使用默认比较器为例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// add方法直接调用offer方法，往数组末尾添加元素</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">add</span><span class=\"params\">(E e)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> offer(e);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">offer</span><span class=\"params\">(E e)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (e == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NullPointerException();</span><br><span class=\"line\">  modCount++;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> i = size;</span><br><span class=\"line\">  <span class=\"comment\">// 看一下数组容量是否足够</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (i &gt;= queue.length) <span class=\"comment\">// 不够则扩容</span></span><br><span class=\"line\">    grow(i + <span class=\"number\">1</span>);</span><br><span class=\"line\">  size = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (i == <span class=\"number\">0</span>) <span class=\"comment\">// 首次添加，将元素放到顶端即可</span></span><br><span class=\"line\">    queue[<span class=\"number\">0</span>] = e;</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    siftUp(i, e);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 传入的minCapacity为插入该数据所需要的最小容量</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">grow</span><span class=\"params\">(<span class=\"keyword\">int</span> minCapacity)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> oldCapacity = queue.length;</span><br><span class=\"line\">  <span class=\"comment\">// 如果原始容量小于64，则容量加2，否则容量增加50%</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> newCapacity = oldCapacity + ((oldCapacity &lt; <span class=\"number\">64</span>) ?</span><br><span class=\"line\">                                   (oldCapacity + <span class=\"number\">2</span>) :</span><br><span class=\"line\">                                   (oldCapacity &gt;&gt; <span class=\"number\">1</span>));</span><br><span class=\"line\">  <span class=\"comment\">// overflow-conscious code</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"comment\">// 如果扩容之后的容量大于MAX_ARRAY_SIZE,则比较所需要的容量和MAX_ARRAY_SIZE的大小  </span></span><br><span class=\"line\">    <span class=\"comment\">//(minCapacity &gt; MAX_ARRAY_SIZE) ? Integer.MAX_VALUE : MAX_ARRAY_SIZE;</span></span><br><span class=\"line\">    newCapacity = hugeCapacity(minCapacity);</span><br><span class=\"line\">  queue = Arrays.copyOf(queue, newCapacity);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">siftUp</span><span class=\"params\">(<span class=\"keyword\">int</span> k, E x)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (comparator != <span class=\"keyword\">null</span>) <span class=\"comment\">// 使用自定义选择器</span></span><br><span class=\"line\">    siftUpUsingComparator(k, x);</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"comment\">// 使用默认的自然排序，默认的排序为小顶堆</span></span><br><span class=\"line\">    siftUpComparable(k, x);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 存放数据的核心代码</span></span><br><span class=\"line\"><span class=\"comment\">// k为所要存放的索引位置，x为元素</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">siftUpComparable</span><span class=\"params\">(<span class=\"keyword\">int</span> k, E x)</span> </span>&#123;</span><br><span class=\"line\">  Comparable&lt;? <span class=\"keyword\">super</span> E&gt; key = (Comparable&lt;? <span class=\"keyword\">super</span> E&gt;) x;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (k &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> parent = (k - <span class=\"number\">1</span>) &gt;&gt;&gt; <span class=\"number\">1</span>; <span class=\"comment\">// 左移一位找到父节点的位置</span></span><br><span class=\"line\">    Object e = queue[parent];<span class=\"comment\">// 父节点元素</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (key.compareTo((E) e) &gt;= <span class=\"number\">0</span>) <span class=\"comment\">// 比较该元素和父节点元素大小,如果该节点大，则跳出循环</span></span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    queue[k] = e; <span class=\"comment\">// 将父节点的值存到k索引位置</span></span><br><span class=\"line\">    k = parent; <span class=\"comment\">// 索引位置变成父节点的索引位置，继续对比父节点的父节点</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  queue[k] = key;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"删除\"><a href=\"#删除\" class=\"headerlink\" title=\"删除\"></a>删除</h5><p>还是以默认的比较器为例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">remove</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 找到该对象对应的索引位置</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> i = indexOf(o);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i == -<span class=\"number\">1</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        removeAt(i);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 找到该对象对应的索引位置</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">int</span> <span class=\"title\">indexOf</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (o != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; size; i++)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (o.equals(queue[i]))</span><br><span class=\"line\">        <span class=\"keyword\">return</span> i;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> -<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> E <span class=\"title\">removeAt</span><span class=\"params\">(<span class=\"keyword\">int</span> i)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// assert i &gt;= 0 &amp;&amp; i &lt; size;</span></span><br><span class=\"line\">  modCount++;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> s = --size;</span><br><span class=\"line\">  <span class=\"comment\">// 尾结点</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (s == i) <span class=\"comment\">// removed last element</span></span><br><span class=\"line\">    queue[i] = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 尾结点的元素</span></span><br><span class=\"line\">    E moved = (E) queue[s];</span><br><span class=\"line\">    <span class=\"comment\">// 将尾结点置空</span></span><br><span class=\"line\">    queue[s] = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    siftDown(i, moved);</span><br><span class=\"line\">    <span class=\"comment\">// 没有进while循环时(表示在siftDown()方法中直接走到queue[k] = key;),删除节点没有子节点，开始向上查找</span></span><br><span class=\"line\">    <span class=\"comment\">// 向上查找的原因是因为可能所删除的节点与尾结点处于不同的子树下</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (queue[i] == moved) &#123;</span><br><span class=\"line\">      siftUp(i, moved);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (queue[i] != moved)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> moved;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// k为所要删除的元素位置  x为尾结点元素</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">siftDown</span><span class=\"params\">(<span class=\"keyword\">int</span> k, E x)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (comparator != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">    siftDownUsingComparator(k, x);</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    siftDownComparable(k, x);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// k为所要移除的索引位置   x为尾结点元素</span></span><br><span class=\"line\"><span class=\"comment\">// 该方法为从删除节点向下查找</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">siftDownComparable</span><span class=\"params\">(<span class=\"keyword\">int</span> k, E x)</span> </span>&#123;</span><br><span class=\"line\">  Comparable&lt;? <span class=\"keyword\">super</span> E&gt; key = (Comparable&lt;? <span class=\"keyword\">super</span> E&gt;)x;</span><br><span class=\"line\">  <span class=\"comment\">// 中间元素，判断是否有子节点</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> half = size &gt;&gt;&gt; <span class=\"number\">1</span>;        <span class=\"comment\">// loop while a non-leaf</span></span><br><span class=\"line\">  <span class=\"keyword\">while</span> (k &lt; half) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 找到子节点</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> child = (k &lt;&lt; <span class=\"number\">1</span>) + <span class=\"number\">1</span>; <span class=\"comment\">// assume left child is least</span></span><br><span class=\"line\">    Object c = queue[child];</span><br><span class=\"line\">    <span class=\"comment\">// 找到子节点的兄弟节点</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> right = child + <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 子节点和子节点的兄弟节点中找到小的</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (right &lt; size &amp;&amp;</span><br><span class=\"line\">        ((Comparable&lt;? <span class=\"keyword\">super</span> E&gt;) c).compareTo((E) queue[right]) &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">      c = queue[child = right];</span><br><span class=\"line\">    <span class=\"comment\">// 尾结点元素小于子节点元素，结束循环</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (key.compareTo((E) c) &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 继续向下查找</span></span><br><span class=\"line\">    queue[k] = c;</span><br><span class=\"line\">    k = child;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">//跳出循环的条件是尾结点元素大于子节点元素了，所以将尾结点元素放到k索引位置</span></span><br><span class=\"line\">  queue[k] = key;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// k为要删除的索引位置  x为尾结点元素</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">siftUp</span><span class=\"params\">(<span class=\"keyword\">int</span> k, E x)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (comparator != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">    siftUpUsingComparator(k, x);</span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    siftUpComparable(k, x);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// k为要删除的索引位置  x为尾结点元素</span></span><br><span class=\"line\"><span class=\"comment\">// 从删除索引位置开始向上查找</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">siftUpComparable</span><span class=\"params\">(<span class=\"keyword\">int</span> k, E x)</span> </span>&#123;</span><br><span class=\"line\">  Comparable&lt;? <span class=\"keyword\">super</span> E&gt; key = (Comparable&lt;? <span class=\"keyword\">super</span> E&gt;) x;</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (k &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 找到父节点</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> parent = (k - <span class=\"number\">1</span>) &gt;&gt;&gt; <span class=\"number\">1</span>;</span><br><span class=\"line\">    Object e = queue[parent];</span><br><span class=\"line\">    <span class=\"comment\">// 尾结点大于父节点，直接跳出循环</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (key.compareTo((E) e) &gt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 继续向上查找</span></span><br><span class=\"line\">    queue[k] = e;</span><br><span class=\"line\">    k = parent;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  queue[k] = key;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"hash","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/hash/","content":"<h2 id=\"hash\"><a href=\"#hash\" class=\"headerlink\" title=\"hash\"></a>hash</h2><p>在HashMap和Hashtable中为了减少哈希碰撞，分别采用了不同的hash方法(使用的版本为JDK1.8)</p>\n<h3 id=\"HashMap\"><a href=\"#HashMap\" class=\"headerlink\" title=\"HashMap\"></a>HashMap</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">(key == <span class=\"keyword\">null</span>) ? <span class=\"number\">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class=\"number\">16</span>);</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>采用了高16位异或低16位来对hashCode进行扰动，防止hashCode高位不同低位相同导致hash冲突</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">(n - <span class=\"number\">1</span>) &amp; hash</span><br></pre></td></tr></table></figure>\n\n<p>采用与运算来计算索引位置，由于HashMap中的数组容量为2^m，所以对于(n-1)来说，二进制数全为1，该作用相当于对于hash取模运算，但是比取模运算效率高。</p>\n<h3 id=\"Hashtable\"><a href=\"#Hashtable\" class=\"headerlink\" title=\"Hashtable\"></a>Hashtable</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span> hash = key.hashCode();</span><br><span class=\"line\"><span class=\"keyword\">int</span> index = (hash &amp; <span class=\"number\">0x7FFFFFFF</span>) % tab.length;</span><br></pre></td></tr></table></figure>\n\n<p>首先 看一下0x7FFFFFFF这个十六进制的二进制代表的是多少</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">System.out.println(Integer.toBinaryString(<span class=\"number\">0x7FFFFFFF</span>));<span class=\"comment\">//1111111111111111111111111111111</span></span><br></pre></td></tr></table></figure>\n\n<p>结果是31个1，而它是一个有符号数，第一位为0，所以0x7FFFFFFF表示的是01111111111111111111111111111111，hash &amp; 0x7FFFFFFF 表示的就是取hash值的绝对值(因为hash值是一个int类型的数字，而int的取值范围是-2^31 ~ 2^31 - 1是存在负数的，所以先取绝对值得到正数)，然后再与数组长度取模，来保证均匀分布</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"hash冲突","url":"/2021/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/hash%E5%86%B2%E7%AA%81/","content":"<h2 id=\"hash冲突\"><a href=\"#hash冲突\" class=\"headerlink\" title=\"hash冲突\"></a>hash冲突</h2><p>在使用hash表时肯定会遇到hash冲突的情况(看你设计的hashCode如何，设计的好，冲突就少一些)</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"集合","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E9%9B%86%E5%90%88/","content":"<p>有时候需要存储一组数据，之前使用数组，但是数组具有固定的容量，但是在写程序时并不知道需要多少对象，在java.util包下提供了一套完整的集合类，包含List、Set、Queue、Map。java集合类都可以自动地调整自己的大小。  </p>\n<a id=\"more\"></a>\n\n<p>在创建集合时，经常使用泛型，可以在编译期防止将错误的类型放入到集合中。</p>\n<h2 id=\"集合概念\"><a href=\"#集合概念\" class=\"headerlink\" title=\"集合概念\"></a>集合概念</h2><p>集合分为两个基本接口</p>\n<ul>\n<li><p>集合(Collection)：一个独立元素的序列，List必须已插入顺序保存元素，Set不能包含重复元素，Queue按照排队规则来确定对象产生的顺序（一般是插入顺序）</p>\n</li>\n<li><p>映射(Map)：一组成对的”键值对”对象，允许使用键来查找值。map允许我们使用一个对象来查找另一个对象</p>\n<p>Arrays.asList()的输出是一个List，但是底层实现是数组，没法调整大小。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">List&lt;String&gt; list = Arrays.asList(<span class=\"string\">&quot;123&quot;</span>,<span class=\"string\">&quot;234&quot;</span>);</span><br><span class=\"line\">list.add(<span class=\"string\">&quot;345&quot;</span>);<span class=\"comment\">//java.lang.UnsupportedOperationException</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h2 id=\"List\"><a href=\"#List\" class=\"headerlink\" title=\"List\"></a>List</h2><p>存储有序，可以重复的元素，相当于动态数组<br>集合中元素所在类要重写equals方法</p>\n<ul>\n<li>ArrayList</li>\n<li>LinkedList</li>\n<li>Vector</li>\n</ul>\n<p><strong>两种类型的list</strong></p>\n<ul>\n<li><p>ArrayList：擅长随机访问元素，但在List中间插入和删除元素时速度较慢</p>\n</li>\n<li><p>LinkedList：擅长在List中间进行插入和删除操作，提供了优化的顺序访问，对于随机访问相对较慢</p>\n</li>\n</ul>\n<h3 id=\"List特性\"><a href=\"#List特性\" class=\"headerlink\" title=\"List特性\"></a>List特性</h3><ul>\n<li>允许插入重复元素</li>\n<li>允许插入多个null元素</li>\n<li>List提供了ListIterator迭代器，可以提供双向访问</li>\n</ul>\n<h3 id=\"ArrayList和Vector的异同点\"><a href=\"#ArrayList和Vector的异同点\" class=\"headerlink\" title=\"ArrayList和Vector的异同点\"></a>ArrayList和Vector的异同点</h3><p>相同点</p>\n<ul>\n<li><p>两者都是基于索引的，内部使用数组</p>\n</li>\n<li><p>两者维护插入顺序，可以根据插入顺序来获取元素</p>\n</li>\n<li><p>ArrayList和Vector的迭代器实现都是fail-fast的</p>\n</li>\n<li><p>ArrayList和Vector两者都允许null值，也可以使用索引值对元素进行随机访问</p>\n</li>\n</ul>\n<p>不同点</p>\n<ul>\n<li>Vector是同步的，ArrayList不是，但是已过时，使用CopyOnWriteArrayList</li>\n<li>ArrayList比Vector快</li>\n</ul>\n<h3 id=\"LinkedList链表\"><a href=\"#LinkedList链表\" class=\"headerlink\" title=\"LinkedList链表\"></a>LinkedList链表</h3><p>LinkedList添加了一些方法，使其可以被用作栈，队列和双向队列，方法差异</p>\n<ul>\n<li><p>getFirst()和element()是相同的，都是返回列表的头部，而并不删除它，如果list为空，则抛出NoSuchElementException异常。peek()方法在列表为空时返回null</p>\n</li>\n<li><p>removeFirst()和remove()方法相同，删除并返回列表头部元素，在列表为空时返回NoSuchElementException异常，poll()在列表为空时返回null</p>\n</li>\n<li><p>addFirst()在列表头部插入一个元素</p>\n</li>\n<li><p>offer()和add()和addLast()相同，在列表尾部添加一个元素</p>\n</li>\n<li><p>removeLast()删除并返回列表的最后一个元素</p>\n</li>\n</ul>\n<h3 id=\"ArrayList和LinkedList的区别\"><a href=\"#ArrayList和LinkedList的区别\" class=\"headerlink\" title=\"ArrayList和LinkedList的区别\"></a>ArrayList和LinkedList的区别</h3><ul>\n<li>ArrayList是由数组支持的基于索引的数据结构，支持对元素的随机访问，复杂度为O(1)，但是LinkedList是基于链表的，存储一系列的节点数据，每个节点都与前一个节点和下一个节点相连。虽然存在使用索引获取元素的方法，但是内部实现是从起始点开始遍历的，时间复杂度是O(n)</li>\n<li>与ArrayList相比，在LinkedList中插入、添加和删除一个元素会更快</li>\n<li>LinkedList比ArrayList消耗更多内存，因为需要存储前后节点的引用</li>\n</ul>\n<h3 id=\"迭代器Iterators\"><a href=\"#迭代器Iterators\" class=\"headerlink\" title=\"迭代器Iterators\"></a>迭代器Iterators</h3><h4 id=\"Iterator\"><a href=\"#Iterator\" class=\"headerlink\" title=\"Iterator\"></a>Iterator</h4><p>Iterator接口提供了遍历任何Collection的接口，取代了java集合框架中的Enumeration，迭代器允许调用者在迭代过程中移除数据</p>\n<p>​    iterator只能单向移动</p>\n<ul>\n<li><p>使用iterator()方法使集合返回一个Iterator。Iterator将准备好返回序列中的第一个元素。</p>\n</li>\n<li><p>使用next()方法获得序列中的下一个元素。</p>\n</li>\n<li><p>使用hasNext()方法检查序列中是否含有元素。</p>\n</li>\n<li><p>使用remove()方法将迭代器最近返回的那个元素删除。</p>\n</li>\n</ul>\n<p><strong>Enumeration和iterator的区别</strong></p>\n<ul>\n<li>Enumeration的速度是Iterator的两倍，使用内存也少，但是iterator更加安全，使得一个集合在遍历时，会阻止其他线程去修改集合，Iterator允许移除元素</li>\n<li>Iterator支持fail-fast机制，而Enumeration不支持，Iterator遍历时，当其他线程修改集合内容时，迭代器会立马感知到，引起快速失败，抛出ConcurrentModificationException异常</li>\n<li>Enumeration本身不支持同步，只是在Vector和hashtable实现Enumeration时，添加了同步</li>\n</ul>\n<h4 id=\"ListIterator\"><a href=\"#ListIterator\" class=\"headerlink\" title=\"ListIterator\"></a>ListIterator</h4><ul>\n<li>ListIterator是Iterator的子类型，只能由各种List类生成，</li>\n<li>Iterator只能向前移动，ListIterator可以双向移动，可以生成迭代器在列表中指向位置的后一个和前一个元素的索引。</li>\n</ul>\n<h2 id=\"堆栈stack\"><a href=\"#堆栈stack\" class=\"headerlink\" title=\"堆栈stack\"></a>堆栈stack</h2><p>堆栈是后进先出(LIFO)，最后压入(push)栈的元素，第一个被弹出(pop)栈。</p>\n<p>java1.0中有一个stack类，但是设计的不好，Java6添加了ArrayDeque，其中包含了直接实现堆栈功能的方法</p>\n<ul>\n<li>push()添加元素到栈底</li>\n<li>peek()和pop()返回对象，peek()返回栈顶元素，但不从栈顶删除，而pop()删除并返回栈顶元素</li>\n</ul>\n<h2 id=\"Set\"><a href=\"#Set\" class=\"headerlink\" title=\"Set\"></a>Set</h2><p>Set不保存重复的元素。查找是Set最重要的操作，选择HashSet实现，针对快速查找进行了优化。</p>\n<p><strong><em>存储无序，不可重复</em></strong><br>添加Set集合中的元素所在类要重写equals和hashCode方法</p>\n<p>无序性：指的是元素在底层存储的位置是无序的</p>\n<ul>\n<li><p>HashSet没有顺序，使用散列函数，HashSet维护顺序与TreeSet或LinkedHashSet不同，因为它们实现具有不同的元素存储方式</p>\n</li>\n<li><p>LinkedHashSet 也使用了散列，使用了链表来维护元素的插入顺序，结果将按元素的插入顺序显示。元素必须定义hashCode()和equals()方法，遍历元素时，会按照添加的进去的顺序</p>\n</li>\n<li><p>TreeSet将元素存储在红黑树数据结构，可以从Set中获取有序序列，其中元素必须实现Comparable接口</p>\n<p>要求添加进TreeSet的必须是同一个类的<br>两种排序方式</p>\n<pre><code>1）自然排序：添加的类要实现Comparable接口，重写compareTo方法\n2）定制排序: 使用TreeSet(Comparator&lt;? super E&gt; comparator) 构造器    重写compare(T o1, T o2);方法</code></pre>\n</li>\n</ul>\n<h2 id=\"Map\"><a href=\"#Map\" class=\"headerlink\" title=\"Map\"></a>Map</h2><p>键值<br>key不可重复，一个key-value组成一个entry</p>\n<h3 id=\"map的分类\"><a href=\"#map的分类\" class=\"headerlink\" title=\"map的分类\"></a>map的分类</h3><p>HashMap专为快速访问而设计，TreeMap保持键始终处于排序状态，没有HashMap快。LinkedHashMap按插入顺序保存其元素，但使用散列提供快速访问的能力。</p>\n<ul>\n<li>HashMap   基于哈希表的实现。为插入和定位键值对提供了常数时间性能。可以通过构造方法调整性能，这些构造方法允许设置哈希表的容量和装填因子。可以添加key为null，value为null</li>\n<li>LinkedHashMap  与HashMap类似，但是当遍历时，可以按照插入顺序或最近最少使用(LRU)顺序获取键值对。只比HashMap略慢，一个例外是在迭代时，由于其使用链表维护内部顺序，所以会更快些，按照添加进Map的顺序遍历</li>\n<li>TreeMap  基于红黑树实现，当查看键或键值对时，按排序顺序(由Comparable或Comparator确定)。TreeMap的侧重点在于按排序顺序获得结果。TreeMap是唯一使用subMap()方法的Map，返回红黑树的一部分，按照key所在类的指定属性进行排序，要求key是同一个类的对象（同TreeSet）</li>\n<li>WeakHashMap  一个具有弱键的Map，为了解决某些类型的问题，它允许释放Map所引用的对象。如果Map外没有对特定键的引用，则可以对该键进行垃圾回收</li>\n<li>ConcurrentHashMap   不使用同步锁定的线程安全Map</li>\n<li>IdentityHashMap   使用==来比较键，仅用于解决特殊问题</li>\n<li>HashTable 不可添加key为null，value为null的 子类Properties   处理属性文件</li>\n</ul>\n<h3 id=\"HashMap工作情况\"><a href=\"#HashMap工作情况\" class=\"headerlink\" title=\"HashMap工作情况\"></a>HashMap工作情况</h3><p>HashMap在Map.Entry静态内部类实现存储键值对，HashMap使用哈希算法，在put和get方法中，使用hashCode和equals方法，使用put方法时，使用key的hashcode和哈希算法来找出存储键值对的索引，Entry存储在LinkedList中，如果存在entry，使用equals检查传递的key是否存在，如果存在，会覆盖掉value，如果不存在，会创建一个新的entry然后保存。get的时候也是先通过hashcode找到数组中的索引，然后使用equals找到正确的Entry，在进行取值</p>\n<p>HashMap默认初始容量是32，负载因子是0.75，阈值是容量乘以负载因子，当map的大小比阈值大时，HashMap会对map的内容进行重新哈希。</p>\n<h3 id=\"HashMap和HashTable的区别\"><a href=\"#HashMap和HashTable的区别\" class=\"headerlink\" title=\"HashMap和HashTable的区别\"></a>HashMap和HashTable的区别</h3><ul>\n<li>HashMap允许key和value为null，HashTable不允许</li>\n<li>HashTable是同步的，HashMap不是</li>\n<li>HashMap可以转为LinkedHashMap，使得遍历有序，HashTable的顺序无法预知</li>\n<li>HashMap提供对key的set进行遍历，所以是fail-fast的，HashTable提供对key的Enumeration进行遍历，不支持fail-fast</li>\n<li>HashTable应该被CocurrentHashMap替代</li>\n</ul>\n<h2 id=\"队列\"><a href=\"#队列\" class=\"headerlink\" title=\"队列\"></a>队列</h2><h3 id=\"队列操作\"><a href=\"#队列操作\" class=\"headerlink\" title=\"队列操作\"></a>队列操作</h3><p>队列是一个先进先出(FIFO)集合，LinkedList实现了Queue接口，并且提供了一些方法支持队列行为</p>\n<ul>\n<li><p>offer()在队列尾部插入一个元素</p>\n</li>\n<li><p>peek()和element()返回队列头而不删除它，如果队列为空，element()抛出NoSuchElementException，而peek()返回null</p>\n</li>\n<li><p>poll()和remove()都删除并返回队头元素，如果队列为空，poll()返回null，remove()抛出NoSuchElementException</p>\n</li>\n</ul>\n<h3 id=\"PriorityQueue优先级队列\"><a href=\"#PriorityQueue优先级队列\" class=\"headerlink\" title=\"PriorityQueue优先级队列\"></a>PriorityQueue优先级队列</h3><p>优先级队列声明下一个弹出的元素是最需要的元素。</p>\n<h3 id=\"BlockingQueue队列\"><a href=\"#BlockingQueue队列\" class=\"headerlink\" title=\"BlockingQueue队列\"></a>BlockingQueue队列</h3><p>是concurrent包下的类，在进行检索或移除一个元素的时候，会等待队列变成非空；当添加一个元素的时候，会等待队列中的可用空间。主要用于实现生产者-消费者模式</p>\n<h2 id=\"Collections工具类\"><a href=\"#Collections工具类\" class=\"headerlink\" title=\"Collections工具类\"></a>Collections工具类</h2><h3 id=\"unmodifiableCollection方法\"><a href=\"#unmodifiableCollection方法\" class=\"headerlink\" title=\"unmodifiableCollection方法\"></a>unmodifiableCollection方法</h3><p>Collections.unmodifiableCollection(list)；Collections.unmodifiableList(list)；使用该方法会创建一个只读集合，所有改变集合的操作都会抛出UnsupportedOperationException</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;T&gt; <span class=\"function\">Collection&lt;T&gt; <span class=\"title\">unmodifiableCollection</span><span class=\"params\">(Collection&lt;? extends T&gt; c)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> UnmodifiableCollection&lt;&gt;(c);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"synchronizedCollection方法\"><a href=\"#synchronizedCollection方法\" class=\"headerlink\" title=\"synchronizedCollection方法\"></a>synchronizedCollection方法</h3><p>Collections.synchronizedCollection(list)方法可以创建一个线程安全的集合</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> &lt;T&gt; <span class=\"function\">Collection&lt;T&gt; <span class=\"title\">synchronizedCollection</span><span class=\"params\">(Collection&lt;T&gt; c)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> SynchronizedCollection&lt;&gt;(c);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h2><h3 id=\"1、遍历时移除List中的元素\"><a href=\"#1、遍历时移除List中的元素\" class=\"headerlink\" title=\"1、遍历时移除List中的元素\"></a>1、遍历时移除List中的元素</h3><h4 id=\"使用forEach和Iterator\"><a href=\"#使用forEach和Iterator\" class=\"headerlink\" title=\"使用forEach和Iterator\"></a>使用forEach和Iterator</h4><p>在使用forEach遍历时，实际上是使用的Iterator，使用的核心方法是hasNext()和next()，但是使用的是list.remove，来看个例子</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//源码</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestList</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        List&lt;String&gt; list = <span class=\"keyword\">new</span> ArrayList&lt;&gt;();</span><br><span class=\"line\">        list.add(<span class=\"string\">&quot;J&quot;</span>);</span><br><span class=\"line\">        list.add(<span class=\"string\">&quot;A&quot;</span>);</span><br><span class=\"line\">        list.add(<span class=\"string\">&quot;V&quot;</span>);</span><br><span class=\"line\">        list.add(<span class=\"string\">&quot;A&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String s: list) &#123;</span><br><span class=\"line\">            list.remove(s);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//编译之后</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestList</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TestList</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        List&lt;String&gt; list = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\">        list.add(<span class=\"string\">&quot;J&quot;</span>);</span><br><span class=\"line\">        list.add(<span class=\"string\">&quot;A&quot;</span>);</span><br><span class=\"line\">        list.add(<span class=\"string\">&quot;V&quot;</span>);</span><br><span class=\"line\">        list.add(<span class=\"string\">&quot;A&quot;</span>);</span><br><span class=\"line\">        Iterator var2 = list.iterator();</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(var2.hasNext()) &#123;</span><br><span class=\"line\">            String s = (String)var2.next();</span><br><span class=\"line\">            list.remove(s);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n\n<p>之前说过，Iterator在遍历时，不允许其他线程对该集合进行操作，看一下ArrayList的iterator是怎么实现的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> E <span class=\"title\">next</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    checkForComodification();</span><br><span class=\"line\">    <span class=\"keyword\">int</span> i = cursor;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i &gt;= size)</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> NoSuchElementException();</span><br><span class=\"line\">    Object[] elementData = ArrayList.<span class=\"keyword\">this</span>.elementData;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (i &gt;= elementData.length)</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException();</span><br><span class=\"line\">    cursor = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (E) elementData[lastRet = i];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">checkForComodification</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (modCount != expectedModCount)</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在每次获取下一个元素时，都会比较modCount 和 expectedModCount</p>\n<p>然后在调用的list的remove方法会导致modCount增加（modCount表示被修改次数）</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> E <span class=\"title\">remove</span><span class=\"params\">(<span class=\"keyword\">int</span> index)</span> </span>&#123;</span><br><span class=\"line\">        rangeCheck(index);</span><br><span class=\"line\"></span><br><span class=\"line\">        modCount++;</span><br><span class=\"line\">        E oldValue = elementData(index);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> numMoved = size - index - <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (numMoved &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">            System.arraycopy(elementData, index+<span class=\"number\">1</span>, elementData, index,</span><br><span class=\"line\">                             numMoved);</span><br><span class=\"line\">        elementData[--size] = <span class=\"keyword\">null</span>; <span class=\"comment\">// clear to let GC do its work</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>此时iterator的next方法中两个变量就不一致了，就会抛出ConcurrentModificationException异常</p>\n<p>再看一下如果使用iterator的remove方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">remove</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (lastRet &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException();</span><br><span class=\"line\">    checkForComodification();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        ArrayList.<span class=\"keyword\">this</span>.remove(lastRet);</span><br><span class=\"line\">        cursor = lastRet;</span><br><span class=\"line\">        lastRet = -<span class=\"number\">1</span>;</span><br><span class=\"line\">        expectedModCount = modCount;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (IndexOutOfBoundsException ex) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>iterator在remove之后会将modCount的值赋给expectedModCount，就不会出现两个变量不等的情况了</p>\n<h4 id=\"不使用forEach遍历\"><a href=\"#不使用forEach遍历\" class=\"headerlink\" title=\"不使用forEach遍历\"></a>不使用forEach遍历</h4><p>使用普通for循环，有两种方式，第一种是使用正序遍历，但是进行remove操作之后要把遍历的索引进行修正减一，否则在移除下一个的时候就会出错，第二种就是使用倒序遍历</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 正序遍历</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class=\"line\">    String s = list.remove(i);</span><br><span class=\"line\">    i = i - <span class=\"number\">1</span>;</span><br><span class=\"line\">    System.out.println(s);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//倒序遍历</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = list.size() - <span class=\"number\">1</span>; i &gt;= <span class=\"number\">0</span>; i--) &#123;</span><br><span class=\"line\">    String s = list.remove(i);</span><br><span class=\"line\">    System.out.println(s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、fail-fast和fail-safe\"><a href=\"#2、fail-fast和fail-safe\" class=\"headerlink\" title=\"2、fail-fast和fail-safe\"></a>2、fail-fast和fail-safe</h3><p>java.util包中集合类被设计为fail-fast的，而java.util.concurrent中集合为fail-safe的。fail-fast迭代器抛出ConcurrentModificationException，而fail-safe迭代器从不抛出ConcurrentModificationException</p>\n<h3 id=\"3、Arrays-asList\"><a href=\"#3、Arrays-asList\" class=\"headerlink\" title=\"3、Arrays.asList\"></a>3、Arrays.asList</h3><p>这个方法返回的是一个ArrayList，不过这个ArrayList是Arrays类的内部类，在调用add方法的时候会直接报错</p>\n<p>UnsupportedOperationException这是运行时异常</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">add</span><span class=\"params\">(<span class=\"keyword\">int</span> index, E element)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> UnsupportedOperationException();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"内部类","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%86%85%E9%83%A8%E7%B1%BB/","content":"<p>定义在另一个类中的类，叫做内部类，可以把一些逻辑相关的类组织在一起，并控制位于内部的类的可见性。</p>\n<p>内部类分为</p>\n<ul>\n<li>静态内部类</li>\n<li>成员内部类</li>\n<li>局部内部类</li>\n<li>匿名内部类</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"成员内部类\"><a href=\"#成员内部类\" class=\"headerlink\" title=\"成员内部类\"></a>成员内部类</h3><p>成员内部类可以等同的看做是成员变量，可以有权限修饰符，内部不能有静态声明</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Outter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Inner</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">print</span><span class=\"params\">(String s)</span> </span>&#123;</span><br><span class=\"line\">            System.out.println(s);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Inner <span class=\"title\">buildInner</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Inner();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Outter outter = <span class=\"keyword\">new</span> Outter();</span><br><span class=\"line\">        Inner inner = outter.buildInner();</span><br><span class=\"line\">        inner.print(<span class=\"string\">&quot;输出&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"成员内部类与外部类联系\"><a href=\"#成员内部类与外部类联系\" class=\"headerlink\" title=\"成员内部类与外部类联系\"></a>成员内部类与外部类联系</h4><p>成员内部类可以使用外部类的所有成员，而且不需要任何特殊条件，且拥有其对于外部类所有元素的访问权。</p>\n<p>在创建成员内部类对象时，它会与创建它的外围对象有某种联系(内部类对象会秘密的捕获一个指向外部类的引用，通过这个引用可以用来访问外部类的成员)，使得可以访问外部类类的所有成员</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Sequence</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Object[] items;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> next;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Sequence</span><span class=\"params\">(<span class=\"keyword\">int</span> size)</span> </span>&#123;</span><br><span class=\"line\">        items = <span class=\"keyword\">new</span> Object[size];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 添加元素</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> obj</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">add</span><span class=\"params\">(Object obj)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (next &lt; items.length) &#123;</span><br><span class=\"line\">            items[next] = obj;</span><br><span class=\"line\">            next++;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> SequenceSelector <span class=\"title\">selector</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> SequenceSelector();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Sequence sequence = <span class=\"keyword\">new</span> Sequence(<span class=\"number\">10</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">10</span>; i++) &#123;</span><br><span class=\"line\">            sequence.add(i);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        SequenceSelector selector = sequence.selector();</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (!selector.end()) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">            System.out.print(selector.current() + <span class=\"string\">&quot; &quot;</span>);</span><br><span class=\"line\">            selector.next();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SequenceSelector</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> current = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">end</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> current == size();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">size</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> items.length;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">current</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> items[current];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">previous</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (current &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                current--;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">next</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (current &lt; items.length) &#123;</span><br><span class=\"line\">                current++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用-this和-new\"><a href=\"#使用-this和-new\" class=\"headerlink\" title=\"使用.this和.new\"></a>使用.this和.new</h4><p>在成员内部类如何生成外部类对象的引用，使用外部类名.this</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DoThis</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Inner</span></span>&#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> DoThis <span class=\"title\">outer</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> DoThis.<span class=\"keyword\">this</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">f</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;DoThis.f()&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Inner <span class=\"title\">inner</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Inner();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        DoThis doThis = <span class=\"keyword\">new</span> DoThis();</span><br><span class=\"line\">        Inner inner = doThis.inner();</span><br><span class=\"line\">        inner.outer().f();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>外部类如何创建成员内部类的对象，需要使用外部类名.new</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DoNew</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Inner</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">f</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;Inner.f()&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        DoNew doNew = <span class=\"keyword\">new</span> DoNew();</span><br><span class=\"line\">        Inner inner = doNew.<span class=\"function\">new <span class=\"title\">Inner</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">        inner.f();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>在拥有外部类对象之前是不可能创建成员内部类对象的，成员内部类对象会连接到创建它的外部类对象上</strong>，静态内部类不需要外部类对象的引用。  </p>\n<p>对于私有的成员内部类，外部类是可以访问到它的，其他的类无法访问到，如下</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DoNew</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Inner</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">f</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;Inner.f()&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        DoNew doNew = <span class=\"keyword\">new</span> DoNew();</span><br><span class=\"line\">        <span class=\"comment\">// 外部类中可以访问到</span></span><br><span class=\"line\">        Inner inner = doNew.new Inner();</span><br><span class=\"line\">        inner.f();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        DoNew doNew = <span class=\"keyword\">new</span> DoNew();</span><br><span class=\"line\">        <span class=\"comment\">// 其他类无法访问</span></span><br><span class=\"line\">        <span class=\"comment\">// &#x27;DoNew.Inner&#x27; has private access in &#x27;DoNew&#x27;</span></span><br><span class=\"line\">        <span class=\"comment\">//doNew.new Inner();</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"局部内部类\"><a href=\"#局部内部类\" class=\"headerlink\" title=\"局部内部类\"></a>局部内部类</h3><p>在方法作用域内创建的类，称为局部内部类，局部内部类没有访问修饰符，可以等同的看做是局部变量，**<em>局部内部类在访问局部变量时，局部变量必须使用final修改**</em></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">Variable <span class=\"string\">&#x27;name&#x27;</span> is accessed from within inner <span class=\"class\"><span class=\"keyword\">class</span>, <span class=\"title\">needs</span> <span class=\"title\">to</span> <span class=\"title\">be</span> <span class=\"title\">final</span> <span class=\"title\">or</span> <span class=\"title\">effectively</span> <span class=\"title\">final</span></span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MethodOuter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Destination <span class=\"title\">desc</span><span class=\"params\">(String s)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 局部内部类</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Inner</span> <span class=\"keyword\">implements</span> <span class=\"title\">Destination</span></span>&#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">f</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;Inner.f()传入参数&quot;</span>+s);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Inner();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        MethodOuter methodOuter = <span class=\"keyword\">new</span> MethodOuter();</span><br><span class=\"line\">        methodOuter.desc(<span class=\"string\">&quot;test&quot;</span>).f();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Inner是desc()方法的一部分，在方法之外访问不到</p>\n<h3 id=\"匿名内部类\"><a href=\"#匿名内部类\" class=\"headerlink\" title=\"匿名内部类\"></a>匿名内部类</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Outer1</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Contents <span class=\"title\">contents</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Contents()&#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">f</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;Contents匿名内部类.f()&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Outer1 outer1 = <span class=\"keyword\">new</span> Outer1();</span><br><span class=\"line\">        outer1.contents().f();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"静态内部类\"><a href=\"#静态内部类\" class=\"headerlink\" title=\"静态内部类\"></a>静态内部类</h3><p>静态内部类可以等同的看做是静态变量，可以有权限修饰符</p>\n<p>静态内部类，内部类对象与外部类对象之间没有联系，将内部类声明为static，普通的内部类对象隐式的保存了一个引用，指向创建它的外部类对象，当内部类是static的时候，意味着</p>\n<ul>\n<li><p>要创建嵌套类的对象，并不需要其外部类的对象</p>\n</li>\n<li><p>不能从嵌套类的对象中访问非静态的外围对象</p>\n<p>普通内部类不能有static数据和static字段，也不能包含嵌套类，但是嵌套类可以。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Outer2</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Inner2</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">f</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;Inner2.f()&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Inner2.f();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<p>在创建静态内部类时不需要将静态内部类的实例绑定在外部类实例上。</p>\n<h4 id=\"接口内部类\"><a href=\"#接口内部类\" class=\"headerlink\" title=\"接口内部类\"></a>接口内部类</h4><p>  静态内部类可以作为接口的一部分，放到接口中任何类都是public static的</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"初始化","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%88%9D%E5%A7%8B%E5%8C%96/","content":"<h2 id=\"初始化顺序\"><a href=\"#初始化顺序\" class=\"headerlink\" title=\"初始化顺序\"></a>初始化顺序</h2><p>在类中变量定义的顺序决定了它们初始化的顺序。  </p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">House</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 构造器之前</span></span><br><span class=\"line\">    Window w1 = <span class=\"keyword\">new</span> Window(<span class=\"number\">1</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    House()&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;House()&quot;</span>);</span><br><span class=\"line\">        Window window = <span class=\"keyword\">new</span> Window(<span class=\"number\">11</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 构造器之后</span></span><br><span class=\"line\">    Window w2 = <span class=\"keyword\">new</span> Window(<span class=\"number\">2</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">f</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;f()&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Window w3 = <span class=\"keyword\">new</span> Window(<span class=\"number\">3</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        House house = <span class=\"keyword\">new</span> House();</span><br><span class=\"line\">        house.f();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Window</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Window</span><span class=\"params\">(<span class=\"keyword\">int</span> mark)</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Window(&quot;</span>+mark+<span class=\"string\">&quot;)&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>执行结果</p>\n<figure class=\"highlight stylus\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"title\">Window</span><span class=\"params\">(<span class=\"number\">1</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">Window</span><span class=\"params\">(<span class=\"number\">2</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">Window</span><span class=\"params\">(<span class=\"number\">3</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">House</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">Window</span><span class=\"params\">(<span class=\"number\">11</span>)</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">f</span><span class=\"params\">()</span></span></span><br></pre></td></tr></table></figure>\n\n<p>验证类加载</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Initable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 非编译期常量</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> COUNT =<span class=\"keyword\">new</span> Random().nextInt(<span class=\"number\">1000</span>);</span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Initable初始化&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Initable1</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 编译期常量</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> COUNT = <span class=\"number\">47</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Initable1初始化&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Initable2</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> COUNT = <span class=\"number\">56</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Initable2初始化&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Initable3</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> COUNT = <span class=\"number\">33</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Initable3初始化&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Initable4</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">int</span> COUNT = <span class=\"number\">44</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Initable4初始化&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">结果：</span><br><span class=\"line\">Initable---------------</span><br><span class=\"line\">Initable初始化</span><br><span class=\"line\"><span class=\"number\">457</span></span><br><span class=\"line\">Initable1---------------</span><br><span class=\"line\"><span class=\"number\">47</span></span><br><span class=\"line\">Initable2---------------</span><br><span class=\"line\">Initable2初始化</span><br><span class=\"line\"><span class=\"number\">56</span></span><br><span class=\"line\">Initable3---------------</span><br><span class=\"line\">Initable4---------------</span><br><span class=\"line\">Initable4初始化</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>对于static final的值是一个编译期常量的话(如Initable1.COUNT)，获取这个值时不需要对Initable1进行初始化就可以读取，如果用static final的值不是一个编译期常量(如Initable.COUNT)，访问这个变量会强制对该类进行初始化</p>\n<p>对于一个仅仅是static修饰的字段而不是final的，在读取这个字段之前，需要为该字段分配存储空间以及初始化该存储空间</p>\n<p>使用.class语法不会对类进行初始化，而使用Class.forName()来产生Class引用会直接引发类的初始化</p>\n<blockquote>\n<p>注意：如果没有显式的编写构造器的话，java编译器会默认提供一个无参构造器，但是如果提供了自己的构造器，编译器将不会再生成默认构造器。</p>\n</blockquote>\n","categories":["java基础"],"tags":["java基础"]},{"title":"万事万物皆对象","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E5%AF%B9%E8%B1%A1/","content":"<h2 id=\"操作对象\"><a href=\"#操作对象\" class=\"headerlink\" title=\"操作对象\"></a>操作对象</h2><p>所有编程语言都会操作内存中的元素，java通过对象的引用来操作对象<br>创建一个String引用，代码示例：</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">String s;</span><br></pre></td></tr></table></figure>\n<p>上面的代码只是创建了一个String对象的引用，变量s没有进行初始化，并没有指向任何对象。java中使用new来创建对象，代码示例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">String s = <span class=\"keyword\">new</span> String(<span class=\"string\">&quot;abc&quot;</span>);</span><br></pre></td></tr></table></figure>\n<h2 id=\"基本数据类型\"><a href=\"#基本数据类型\" class=\"headerlink\" title=\"基本数据类型\"></a>基本数据类型</h2><p>boolean、char、byte、short、int、long、float、double这些都是基本数据类型，基本数据类型不需要使用new关键字来创建对象，直接存储值，存储在栈内存内。java直接确定了每种基本类型的内存占用大小。 </p>\n<table>\n<thead>\n<tr>\n<th>基本类型</th>\n<th>大小</th>\n<th>范围</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>boolean</td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>char</td>\n<td>16bits</td>\n<td>0~2^16 -1</td>\n</tr>\n<tr>\n<td>byte</td>\n<td>8bits</td>\n<td>-2^7~2^7-1</td>\n</tr>\n<tr>\n<td>short</td>\n<td>16bits</td>\n<td>-2^15~2^15-1</td>\n</tr>\n<tr>\n<td>int</td>\n<td>32bits</td>\n<td>-2^31~2^31-1</td>\n</tr>\n<tr>\n<td>long</td>\n<td>64bits</td>\n<td>-2^63~2^63-1</td>\n</tr>\n<tr>\n<td>float</td>\n<td>32bits</td>\n<td>-2^31~2^31-1</td>\n</tr>\n<tr>\n<td>double</td>\n<td>64bits</td>\n<td>-2^63~2^63-1</td>\n</tr>\n</tbody></table>\n<h2 id=\"数据存储\"><a href=\"#数据存储\" class=\"headerlink\" title=\"数据存储\"></a>数据存储</h2><p>内存分配</p>\n<ul>\n<li>寄存器  位于CPU内部，最快的存储区域</li>\n<li>栈内存 存在于RAM（随机访问存储器）内存区域内，可通过栈指针获得处理器的直接支持。栈指针下移分配内存，上移释放内存，速度仅次于寄存器。创建程序时，java系统必须准确地知道栈内保存的所有项的生命周期。对象引用存储在栈内存中，但对象保存在堆内存中。占中存储方法帧和局部变量。栈比堆小，也不会在多个线程之间共享，而堆被整个JVM的所有线程共享</li>\n<li>堆内存 也存在RAM（随机访问存储器），所有java对象都存在其中。与栈内存不同，编译器不需要知道对象必须在堆内存上停留多长时间。创建一个对象时，只需new关键字实例化对象，执行代码时，会自动在堆中进行内存分配。代价是：分配和清理堆内存要比栈内存需要更多的时间。</li>\n<li>常量存储 常量值直接放在程序代码中，因为他们永远不会改变</li>\n<li>非RAM存储 数据完全存在于程序之外，在程序未运行以及脱离程序控制后依然存在<br>两个示例：<ul>\n<li>序列化对象：对象被转换为字节流，通常被发送到另一台机器</li>\n<li>持久化对象：对象被放置在磁盘上，即使程序终止，数据依然存在。这些存储的方式是将对象转存于另一个介质中，并在需要时恢复成常规的、基于RAM的对象。Java为轻量级持久化提供了支持。<h2 id=\"创建类\"><a href=\"#创建类\" class=\"headerlink\" title=\"创建类\"></a>创建类</h2>使用class关键字来描述一种新的对象。在class关键字的后面紧跟类的名称。<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyClass</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n上例中，引入了一个新的类型，我们可以通过new关键字来创建一个这种类型的对象。<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">MyClass myClass = <span class=\"keyword\">new</span> MyClass();</span><br></pre></td></tr></table></figure>\n在方法中可以存在两种元素：方法和字段</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"多态\"><a href=\"#多态\" class=\"headerlink\" title=\"多态\"></a>多态</h2><p>实现多态的机制是父类或接口定义的引用变量可以指向子类或具体实现类的实例变量，而程序调用的方法是在运行期才动态绑定的</p>\n<p>多态主要分为引用多态和方法多态</p>\n<ul>\n<li><p>引用多态：父类引用指向子类对象，也可以指向本类对象</p>\n</li>\n<li><p>方法多态：创建本类对象时，方法调用为本类方法；创建子类对象时，方法调用为子类重写的方法或者子类继承的方法</p>\n</li>\n</ul>\n<p>多态的必要条件：继承，重写</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"接口和抽象类","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%8E%A5%E5%8F%A3%E5%92%8C%E6%8A%BD%E8%B1%A1%E7%B1%BB/","content":"<h2 id=\"抽象类\"><a href=\"#抽象类\" class=\"headerlink\" title=\"抽象类\"></a>抽象类</h2><p>抽象方法的声明没有方法体。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span></span>;</span><br></pre></td></tr></table></figure>\n<p>包含抽象方法的类叫做抽象类。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Basic</span></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">func</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">func1</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">func2</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>抽象方法默认是public的，不可以设置为private</p>\n<h3 id=\"抽象类总结\"><a href=\"#抽象类总结\" class=\"headerlink\" title=\"抽象类总结\"></a>抽象类总结</h3><ul>\n<li>抽象类不能被实例化，应该由实现了其抽象方法的子类来进行实例化</li>\n<li>抽象方法必须由子类来重写</li>\n<li>只要包含了一个抽象方法的类，该类就是抽象类</li>\n<li>抽象类中可以包含具体的方法，当然也可以不包含抽象方法</li>\n<li>子类的抽象方法不能与父类的抽象方法同名</li>\n<li>abstract不能与final同时修饰一个类(因为final不可被继承，而abstract必须由子类来继承实现)</li>\n<li>abstract不能与private、static、final或native同时修饰一个方法</li>\n</ul>\n<h2 id=\"接口\"><a href=\"#接口\" class=\"headerlink\" title=\"接口\"></a>接口</h2><p>在java8之前的接口只允许有抽象方法，是一个完全抽象的类，没有提供任何实现<br><strong>接口中的属性被隐式指明为static和final</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Inter</span></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">m</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>java8之后允许接口包含默认方法和静态方法<br>默认方法允许在不破坏已使用接口的代码的情况下，在接口中新增方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Inter</span></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">m</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">default</span> <span class=\"keyword\">void</span> <span class=\"title\">newMethod</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;新增方法&quot;</span>);</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>静态方法可以将工具功能放在接口，从而操作接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Operations</span></span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">runOps</span><span class=\"params\">(Operations... ops)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(Operations op : ops)&#123;</span><br><span class=\"line\">            op.execute();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">test</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;接口静态方法&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        test();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"接口总结\"><a href=\"#接口总结\" class=\"headerlink\" title=\"接口总结\"></a>接口总结</h3><ul>\n<li>在java8之前只能有抽象方法，java8之后可以有默认方法和静态方法</li>\n<li>接口不能有构造器</li>\n<li>接口的方法默认是public的</li>\n<li>接口中的属性全部为public static final修饰</li>\n<li>java8之前接口没有main方法，java8之后可以有main方法</li>\n</ul>\n<h2 id=\"抽象类和接口比较\"><a href=\"#抽象类和接口比较\" class=\"headerlink\" title=\"抽象类和接口比较\"></a>抽象类和接口比较</h2><ul>\n<li>可以实现多个接口；但只能继承一个抽象类</li>\n<li>接口只能包含静态属性，不支持对象状态，成员变量默认是public static final的；抽象类可以包含属性，非抽象方法可能引用这些属性</li>\n<li>接口不需要在子类实现默认方法，默认方法可以引用其他接口的方法；抽象类必须在子类中实现抽象方法</li>\n<li>接口没有构造器；抽象类可以有构造器</li>\n<li>接口隐式为public；抽象类可以为protected</li>\n<li>抽象类是对事物的抽象，接口是对行为的抽象</li>\n</ul>\n","categories":["java基础"],"tags":["java基础"]},{"title":"数组","url":"/2021/java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%95%B0%E7%BB%84/","content":"<h2 id=\"数组\"><a href=\"#数组\" class=\"headerlink\" title=\"数组\"></a>数组</h2><p>数组的本质是一个相同数据类型的元素集合。元素是数组的组成部分，数组中每一个元素都可以使用唯一的索引值来访问，这个索引值也可以叫做数组下标。数组是很多集合类的底层存储结构，在了解java集合类之前大家先了解一下数组吧。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"数组初始化\"><a href=\"#数组初始化\" class=\"headerlink\" title=\"数组初始化\"></a>数组初始化</h3><p>数组的声明语法为</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// type为类型  arrayName为数组变量名称</span></span><br><span class=\"line\">type[] arrayName;</span><br><span class=\"line\"><span class=\"comment\">//如：</span></span><br><span class=\"line\"><span class=\"keyword\">int</span>[] numbers;</span><br></pre></td></tr></table></figure>\n\n<p>在进行数组初始化时，有静态初始化和动态初始化两种方式。</p>\n<h4 id=\"静态初始化\"><a href=\"#静态初始化\" class=\"headerlink\" title=\"静态初始化\"></a>静态初始化</h4><p>静态初始化是指在初始化数组时为数组的每个元素赋值，由元素的个数来决定数组的长度</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span>[] numbers = &#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;;</span><br><span class=\"line\"><span class=\"comment\">// 或者</span></span><br><span class=\"line\">numbers = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[]&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"动态初始化\"><a href=\"#动态初始化\" class=\"headerlink\" title=\"动态初始化\"></a>动态初始化</h4><p>动态初始化是指在初始化数组时指定数组长度，系统为每个元素分配初始值，之后再按照需要为每个元素修改值。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span>[] numbers = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[<span class=\"number\">3</span>];<span class=\"comment\">// 此时numbers中的元素为 0,0,0</span></span><br><span class=\"line\">numbers[<span class=\"number\">0</span>] = <span class=\"number\">1</span>;<span class=\"comment\">// 将索引0的位置赋值为1</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意：数组的索引是从0开始的</p>\n</blockquote>\n<h3 id=\"二维数组\"><a href=\"#二维数组\" class=\"headerlink\" title=\"二维数组\"></a>二维数组</h3><p>上面说的数组是一个一维数组，java可以构建多维数组，其实本质上来说还是一维数组，只是数组中的元素存储的还是数组而已。</p>\n<p>二维数组可以看做是一个表格，有行有列，二维数组中的每一个元素就代表了确定行列的一个单元格</p>\n<p>二维数组的声明为</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// type为类型  arrayName为数组变量名称</span></span><br><span class=\"line\">type[][] arrayName;</span><br><span class=\"line\"><span class=\"comment\">//如：</span></span><br><span class=\"line\"><span class=\"keyword\">int</span>[][] numbers;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"静态初始化-1\"><a href=\"#静态初始化-1\" class=\"headerlink\" title=\"静态初始化\"></a>静态初始化</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span>[][] numbers = &#123;&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;,&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;&#125;;</span><br><span class=\"line\"><span class=\"comment\">// 或者</span></span><br><span class=\"line\">numbers = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[][]&#123;&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;,&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;&#125;;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"动态初始化-1\"><a href=\"#动态初始化-1\" class=\"headerlink\" title=\"动态初始化\"></a>动态初始化</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span>[][] numbers = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[<span class=\"number\">3</span>][<span class=\"number\">3</span>];<span class=\"comment\">// 此时numbers中的每个元素都为0</span></span><br><span class=\"line\"><span class=\"comment\">// 如果需要确认某个元素的话，需要指定两个索引，第一个索引找到该位置下的一维数组，第二个索引找到所需要的元素</span></span><br><span class=\"line\">numbers[<span class=\"number\">0</span>][<span class=\"number\">0</span>] = <span class=\"number\">1</span>;<span class=\"comment\">// 将该位置赋值为1</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"非矩形数组\"><a href=\"#非矩形数组\" class=\"headerlink\" title=\"非矩形数组\"></a>非矩形数组</h3><p>由于第二个索引代表的是该索引位置对应的一维数组，每个索引下的数组长度不同时就是非矩形数组。</p>\n<h4 id=\"静态初始化-2\"><a href=\"#静态初始化-2\" class=\"headerlink\" title=\"静态初始化\"></a>静态初始化</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">int</span>[][] numbers = &#123;&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;,&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>&#125;&#125;;</span><br><span class=\"line\"><span class=\"comment\">// 或者</span></span><br><span class=\"line\">numbers = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[][]&#123;&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>&#125;,&#123;<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>&#125;&#125;;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"动态初始化-2\"><a href=\"#动态初始化-2\" class=\"headerlink\" title=\"动态初始化\"></a>动态初始化</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 第二个索引长度不指定，因为每个是不同的</span></span><br><span class=\"line\"><span class=\"keyword\">int</span>[][] numbers = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[<span class=\"number\">3</span>][];</span><br><span class=\"line\">numbers[<span class=\"number\">0</span>] = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[<span class=\"number\">4</span>];</span><br><span class=\"line\">numbers[<span class=\"number\">1</span>] = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[<span class=\"number\">5</span>];</span><br><span class=\"line\">numbers[<span class=\"number\">2</span>] = <span class=\"keyword\">new</span> <span class=\"keyword\">int</span>[<span class=\"number\">6</span>];</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"时间操作","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%97%B6%E9%97%B4%E6%93%8D%E4%BD%9C/","content":"<p>java操作时间的方式</p>\n<h3 id=\"获取年月日时分秒\"><a href=\"#获取年月日时分秒\" class=\"headerlink\" title=\"获取年月日时分秒\"></a>获取年月日时分秒</h3><a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;----------使用Calendar--------------------&quot;</span>);</span><br><span class=\"line\">        Calendar cal = Calendar.getInstance();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;年&quot;</span>+cal.get(Calendar.YEAR));</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;月&quot;</span>+(cal.get(Calendar.MONTH)+<span class=\"number\">1</span>)); <span class=\"comment\">// Calendar.MONTH  获取到的是0-11</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;日&quot;</span>+cal.get(Calendar.DATE));</span><br><span class=\"line\">        System.out.println(cal.get(Calendar.HOUR)); <span class=\"comment\">// 12小时制的小时</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;时&quot;</span>+cal.get(Calendar.HOUR_OF_DAY)); <span class=\"comment\">// 24小时制的小时</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;分&quot;</span>+cal.get(Calendar.MINUTE));</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;秒&quot;</span>+cal.get(Calendar.SECOND));</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;--------------使用java8的LocalDateTime----------------&quot;</span>);</span><br><span class=\"line\">        LocalDateTime local = LocalDateTime.now();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;年&quot;</span>+local.getYear());</span><br><span class=\"line\">        System.out.println(local.getMonth().name());  <span class=\"comment\">// 英文的月</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;月&quot;</span>+local.getMonthValue());  <span class=\"comment\">// 阿拉伯数字 相当于local.getMonth().getValue()</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;日&quot;</span>+local.getDayOfMonth());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;时&quot;</span>+local.getHour()); <span class=\"comment\">// 24小时制的小时</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;分&quot;</span>+local.getMinute());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;秒&quot;</span>+local.getSecond());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"时间格式化中的字符含义\"><a href=\"#时间格式化中的字符含义\" class=\"headerlink\" title=\"时间格式化中的字符含义\"></a>时间格式化中的字符含义</h3><table>\n<thead>\n<tr>\n<th>字符</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>G</td>\n<td>时代指示器(AD)</td>\n</tr>\n<tr>\n<td>y</td>\n<td>年(2001)</td>\n</tr>\n<tr>\n<td>M</td>\n<td>月(07)</td>\n</tr>\n<tr>\n<td>d</td>\n<td>天(20)</td>\n</tr>\n<tr>\n<td>h</td>\n<td>带有A.M./P.M.的小时(1~12)</td>\n</tr>\n<tr>\n<td>H</td>\n<td>小时(0~23)</td>\n</tr>\n<tr>\n<td>m</td>\n<td>分钟(0~59)</td>\n</tr>\n<tr>\n<td>s</td>\n<td>秒(0~59)</td>\n</tr>\n<tr>\n<td>S</td>\n<td>毫秒</td>\n</tr>\n<tr>\n<td>E</td>\n<td>周几(星期四)</td>\n</tr>\n<tr>\n<td>D</td>\n<td>一年中的第几天</td>\n</tr>\n<tr>\n<td>w</td>\n<td>一年中的第几周</td>\n</tr>\n<tr>\n<td>W</td>\n<td>一月中的第几周</td>\n</tr>\n<tr>\n<td>a</td>\n<td>A.M./P.M.标记</td>\n</tr>\n<tr>\n<td>k</td>\n<td>一天中的第几个小时(1~24)</td>\n</tr>\n<tr>\n<td>K</td>\n<td>带有A.M./P.M.的小时</td>\n</tr>\n<tr>\n<td>z</td>\n<td>时区</td>\n</tr>\n</tbody></table>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">DateFormat format = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">&quot;yyyy.MM.dd E&quot;</span>); <span class=\"comment\">//2021.01.14 星期四</span></span><br><span class=\"line\">System.out.println(format.format(<span class=\"keyword\">new</span> Date()));</span><br><span class=\"line\"><span class=\"comment\">// 一年中的第几天</span></span><br><span class=\"line\">format = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">&quot;yyyy.MM.dd D&quot;</span>); <span class=\"comment\">//2021.01.14 14</span></span><br><span class=\"line\">System.out.println(format.format(<span class=\"keyword\">new</span> Date()));</span><br><span class=\"line\"><span class=\"comment\">// 一年中的第几周</span></span><br><span class=\"line\">format = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">&quot;yyyy.MM.dd w&quot;</span>); <span class=\"comment\">//2021.01.14 3</span></span><br><span class=\"line\">System.out.println(format.format(<span class=\"keyword\">new</span> Date()));</span><br><span class=\"line\"><span class=\"comment\">// 一月中的第几周</span></span><br><span class=\"line\">format = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">&quot;yyyy.MM.dd W&quot;</span>); <span class=\"comment\">//2021.01.14 3</span></span><br><span class=\"line\">System.out.println(format.format(<span class=\"keyword\">new</span> Date()));</span><br><span class=\"line\"><span class=\"comment\">// A.M./P.M.标记</span></span><br><span class=\"line\">format = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">&quot;yyyy.MM.dd a&quot;</span>); <span class=\"comment\">//2021.01.14 下午</span></span><br><span class=\"line\">System.out.println(format.format(<span class=\"keyword\">new</span> Date()));</span><br><span class=\"line\"><span class=\"comment\">// 一天中的第几个小时(1~24)</span></span><br><span class=\"line\">format = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">&quot;yyyy.MM.dd k&quot;</span>); <span class=\"comment\">//2021.01.14 14</span></span><br><span class=\"line\">System.out.println(format.format(<span class=\"keyword\">new</span> Date()));</span><br><span class=\"line\"><span class=\"comment\">// 带有A.M./P.M.的小时</span></span><br><span class=\"line\">format = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">&quot;yyyy.MM.dd K&quot;</span>); <span class=\"comment\">//2021.01.14 2</span></span><br><span class=\"line\">System.out.println(format.format(<span class=\"keyword\">new</span> Date()));</span><br><span class=\"line\"><span class=\"comment\">// 时区</span></span><br><span class=\"line\">format = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">&quot;yyyy.MM.dd z&quot;</span>); <span class=\"comment\">//2021.01.14 14</span></span><br><span class=\"line\">System.out.println(format.format(<span class=\"keyword\">new</span> Date()));</span><br></pre></td></tr></table></figure>\n\n","categories":["java基础"],"tags":["java基础"]},{"title":"java基础之构造器","url":"/2021/java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%9E%84%E9%80%A0%E5%99%A8/","content":"<h2 id=\"构造器\"><a href=\"#构造器\" class=\"headerlink\" title=\"构造器\"></a>构造器</h2><p>学习java对于构造器应该很熟悉，但是有些人会认为构造器不是必要的，这就是对于构造器没有深入的了解。</p>\n<p>每一个java类中都必须至少有一个显式或隐式的构造器，很多时候看到类中并没有定义构造器，有人会认为构造器不是必须的，其实那是编译器隐式的提供了一个无参构造器，否则在进行实例化的时候就无法成立</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">Person person = <span class=\"keyword\">new</span> Person();</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>如果父类中只有一个有参构造器，而没有无参构造器的话，就需要子类必须提供一个构造器去显式的调用父类的有参构造器方法，否则就会出现编译错误</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">There is no <span class=\"keyword\">default</span> constructor available in <span class=\"string\">&#x27;com.zhanghe.study.duotai.Parent&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>这里就验证了在子类构造器中会隐式的调用父类构造器(super())，而此时没有无参构造器了，就会出现异常</p>\n<p><strong><em>建议如果添加构造器的话保留一个无参构造器</em></strong></p>\n<blockquote>\n<p>注意：在构造器中的第一条语句要么是调用父类的构造器(使用super())，要么是调用本类中的另一个构造器(使用this());而且如果使用super()或this()语句的话，就必须是构造器的第一条语句，否则编译器就会报错，是为了让父类中的变量在使用前被正确的初始化</p>\n</blockquote>\n","categories":["java基础"],"tags":["java基础"]},{"title":"组合和继承","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E7%BB%84%E5%90%88%E4%B8%8E%E7%BB%A7%E6%89%BF/","content":"<p>为了避免重复代码太多，导致代码不好维护，大家需要学会如何复用代码，代码复用的两种方式，组合和继承 </p>\n<a id=\"more\"></a> \n<p>组合：在新类中创建现有类的对象<br>继承：创建现有类的新类</p>\n<h2 id=\"向上转型\"><a href=\"#向上转型\" class=\"headerlink\" title=\"向上转型\"></a>向上转型</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Instrument</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">play</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Instrument.play()&quot;</span>);</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Wind</span> <span class=\"keyword\">extends</span> <span class=\"title\">Instrument</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">play</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;Wind.play()&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Music</span> </span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">tune</span><span class=\"params\">(Instrument i)</span></span>&#123;</span><br><span class=\"line\">        i.play();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Wind flute = <span class=\"keyword\">new</span> Wind();</span><br><span class=\"line\">        Music.tune(flute); <span class=\"comment\">// 向上转型</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>从一个更具体的类型转化为更一般的类型，所以向上转型用法是安全的。子类可能会比父类包含更多的方法，必须至少具有和父类一样的方法。</p>\n<h2 id=\"final\"><a href=\"#final\" class=\"headerlink\" title=\"final\"></a>final</h2><h3 id=\"final方法\"><a href=\"#final方法\" class=\"headerlink\" title=\"final方法\"></a>final方法</h3><p>final方法的作用是防止子类通过重写改变方法的行为<br>类中所有的private方法都是隐式的指定为final，因为不能访问private方法，所以不能重写它。给private方法加上final修饰并不会给方法带来额外的含义。<strong>重写一个private方法时编译并不会报错，一个方法是private的，他就不属于父类的一部分，只是创建了一个同名的方法而已</strong>  </p>\n<p>final方法的好处</p>\n<ul>\n<li>可以防止子类中的方法重写</li>\n<li>final方法会告诉编译器对于final方法的调用不需要动态绑定，在运行时，不需要进行解析方法调用</li>\n<li>能够带来更好的效率，编译器duifinal方法的调用为内联调用。当编译器看到final方法调用时，可以根据自己的判断，略去一般通过方法调用机制插入代码的方式。调用机制包括将方法参数压栈、清除栈参数和最后处理返回值。而对于final方法编译器在方法体中使用实际代码来替换方法调用</li>\n</ul>\n<h3 id=\"final类\"><a href=\"#final类\" class=\"headerlink\" title=\"final类\"></a>final类</h3><p>final类的作用是该类不允许被继承</p>\n<h3 id=\"final变量\"><a href=\"#final变量\" class=\"headerlink\" title=\"final变量\"></a>final变量</h3><p>使用final关键字修饰的变量会被认为是常量。任何在程序中试图改变常量值的操作，都会导致编译错误</p>\n<h2 id=\"多态\"><a href=\"#多态\" class=\"headerlink\" title=\"多态\"></a>多态</h2><h3 id=\"方法绑定\"><a href=\"#方法绑定\" class=\"headerlink\" title=\"方法绑定\"></a>方法绑定</h3><p>对于上述向上转型的例子，编译器如何知道该调用哪个方法，方法的入参只是一个Instrument引用<br>java采用后期绑定，在运行时根据对象的类型进行绑定，在运行时判断对象的类型，从而调用方法，在编译时编译器不知道对象的类型，<strong>java对于static和final方法无法采用后期绑定(private方法也是隐式的final)</strong></p>\n<h3 id=\"多态的陷阱\"><a href=\"#多态的陷阱\" class=\"headerlink\" title=\"多态的陷阱\"></a>多态的陷阱</h3><p><strong>注:多态只是针对于普通方法，对于属性和静态方法不会存在多态</strong><br>属性在编译时就会被解析</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Parent</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">int</span> field = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getField</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> field;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Child</span> <span class=\"keyword\">extends</span> <span class=\"title\">Parent</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">int</span> field = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getField</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> field;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestField</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Parent parent = <span class=\"keyword\">new</span> Child();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parent.field= &quot;</span>+parent.field);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parent.getField= &quot;</span>+parent.getField());</span><br><span class=\"line\">        Child child = <span class=\"keyword\">new</span> Child();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;child.field= &quot;</span>+child.field);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;child.getField= &quot;</span>+child.getField());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>执行结果</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">parent.field</span>= <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">parent.getField</span>= <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">child.field</span>= <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">child.getField</span>= <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<p>Parent.field和Child。field被分配了不同的存储空间，Child其实是存在两个filed属性的：本身的以及父类的，但是在引用Child的field的时候，默认的field属性是来自于本身的，如果要获取父类的该属性，需要使用super.field来显示地指定获取父类属性<br>但是这种情况一般不会发生，首先属性一般来说都是私有private的，其次子类和父类一般也不会起相同的属性名字  </p>\n<p>对于静态方法的话，静态方法只与类关联，与对象无关</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"访问权限","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/java%E5%9F%BA%E7%A1%80%E4%B9%8B%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90/","content":"<p>从最大访问权限到最小访问权限依次是：public、protected、包访问权限（default）、private。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"包\"><a href=\"#包\" class=\"headerlink\" title=\"包\"></a>包</h2><p>包内包含一些类，被组织在一个单独的命名空间下。<br>类的全名是包名+类名<br>如 java的util包下有一个类是ArrayList ，在使用这个类的时候需要java.util.ArrayList来使用，但是这种写法太过于长，所以使用import关键字。如果需要导入哪个类，就需要在import语句声明<br>如：import java.util.ArrayList;</p>\n<h2 id=\"访问权限\"><a href=\"#访问权限\" class=\"headerlink\" title=\"访问权限\"></a>访问权限</h2><table>\n<thead>\n<tr>\n<th>访问权限</th>\n<th>本类</th>\n<th>本包的类</th>\n<th>子类</th>\n<th>非子类</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>public</td>\n<td>是</td>\n<td>是</td>\n<td>是</td>\n<td>是</td>\n</tr>\n<tr>\n<td>protected</td>\n<td>是</td>\n<td>是</td>\n<td>是</td>\n<td>否</td>\n</tr>\n<tr>\n<td>default</td>\n<td>是</td>\n<td>是</td>\n<td>否</td>\n<td>否</td>\n</tr>\n<tr>\n<td>private</td>\n<td>是</td>\n<td>否</td>\n<td>否</td>\n<td>否</td>\n</tr>\n</tbody></table>\n<ul>\n<li>private  只能由本类中的代码进行访问</li>\n<li>default  本类或者同包中的类可以访问</li>\n<li>protected  本类、同包中的类以及子类可以访问</li>\n<li>public  可以被任意访问</li>\n</ul>\n","categories":["java基础"],"tags":["java基础"]},{"title":"java的重载与重写","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/%E9%87%8D%E8%BD%BD%E4%B8%8E%E9%87%8D%E5%86%99/","content":"<h2 id=\"重载与重写\"><a href=\"#重载与重写\" class=\"headerlink\" title=\"重载与重写\"></a>重载与重写</h2><p>java中有overload重载和override重写</p>\n<a id=\"more\"></a>\n\n<h3 id=\"重载\"><a href=\"#重载\" class=\"headerlink\" title=\"重载\"></a>重载</h3><p>重载是指一个类中有多个名称相同但是参数列表不同的方法(参数列表不同是指参数个数或类型不同)，编译器在比较方法重载时会忽略掉它们的返回类型以及抛出的异常</p>\n<h3 id=\"重写\"><a href=\"#重写\" class=\"headerlink\" title=\"重写\"></a>重写</h3><p>重写是指子类中的方法与父类中的某个方法名称和参数完全相同，通过子类创建的实例对象将父类中的这个方法覆盖掉，是面向对象多态性的一种表现。</p>\n<p>子类重写父类的方法</p>\n<ul>\n<li>只能比父类抛出更少的异常，或者抛出父类抛出异常的子异常</li>\n<li>子类方法的访问权限只能比父类的更大，如果父类方法为private，那么相当于子类中增加了一个全新的方法</li>\n</ul>\n<blockquote>\n<p>必须符合以上两点的原因是因为多态的机制，在使用子类对象指向父类引用时，调用父类的方法被认为是合法的，但是如果子类的访问权限比父类小，或者子类抛出的异常比父类多，这在编译上是不允许的，与多态机制是矛盾的</p>\n</blockquote>\n<ul>\n<li><p>静态方法不可被重写，否则会出现编译错误  </p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">Instance method <span class=\"string\">&#x27;testStatic()&#x27;</span> in <span class=\"string\">&#x27;com.zhanghe.study.duotai.Child&#x27;</span> cannot     override <span class=\"keyword\">static</span> method <span class=\"string\">&#x27;testStatic()&#x27;</span> in <span class=\"string\">&#x27;com.zhanghe.study.duotai.Parent&#x27;</span>  </span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n","categories":["java基础"],"tags":["java基础"]},{"title":"bash中的特殊符号","url":"/2021/linux/shell/bash%E4%B8%AD%E7%9A%84%E7%89%B9%E6%AE%8A%E7%AC%A6%E5%8F%B7/","content":"<h2 id=\"bash中的特殊符号\"><a href=\"#bash中的特殊符号\" class=\"headerlink\" title=\"bash中的特殊符号\"></a>bash中的特殊符号</h2><table>\n<thead>\n<tr>\n<th>符号</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>‘’     单引号</td>\n<td>在单引号中所有的特殊字符都没有特殊含义</td>\n</tr>\n<tr>\n<td>“”    双引号</td>\n<td>双引号中$  `(反引) \\ 有特殊含义，分别是调用变量的值、引用命令、转义符</td>\n</tr>\n<tr>\n<td>``     反引号</td>\n<td>反引号中的是系统命令，在bash中会优先执行</td>\n</tr>\n<tr>\n<td>$()</td>\n<td>和反引号作用一样，用于引用命令，不过推荐使用该命令，因为反引号不明显</td>\n</tr>\n<tr>\n<td>()</td>\n<td>用于一串命令的执行，会在子shell中运行，括号内容仅在括号内生效，多条命令使用;隔开</td>\n</tr>\n<tr>\n<td>{}</td>\n<td>用于一串命令的执行，会在当前shell中执行，也可用于变量变形和替换，多条命令使用;隔开</td>\n</tr>\n<tr>\n<td>[]</td>\n<td>用于变量的测试</td>\n</tr>\n<tr>\n<td>#</td>\n<td>#开头代表注释</td>\n</tr>\n<tr>\n<td>$</td>\n<td>用于调用变量的值</td>\n</tr>\n<tr>\n<td>\\</td>\n<td>转义</td>\n</tr>\n</tbody></table>\n","categories":["shell"],"tags":["shell"]},{"title":"sed命令","url":"/2021/linux/shell/sed%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"sed命令\"><a href=\"#sed命令\" class=\"headerlink\" title=\"sed命令\"></a>sed命令</h2><p>sed主要用于将数据进行选取、替换、删除、新增的命令</p>\n<p>语法格式为sed [选项] ‘[动作]’ 文件名</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">删除第二行</span></span><br><span class=\"line\">sed &#x27;2d&#x27; stu.txt</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-n   把经过sed命令处理的数据输出到屏幕</span><br><span class=\"line\">-e   允许对输入数据应用多条sed命令</span><br><span class=\"line\">-f 脚本文件名   从sed脚本中读入sed操作</span><br><span class=\"line\">-r   在sed中支持正则</span><br><span class=\"line\">-i   用sed的修改结果直接修改读取数据的文件，而不是由屏幕输出</span><br><span class=\"line\"></span><br><span class=\"line\">动作</span><br><span class=\"line\">a \\   追加，在当前行后添加一行或多行。添加多行时，除最后一行外，每行末尾都需要用\\来表示数据未完结</span><br><span class=\"line\">c \\   行替换，用c后的字符串替换原数据行，替换多行时，除最后一行外，每行末尾都需要用\\来表示数据未完结</span><br><span class=\"line\">i \\   插入，在当前行前插入一行或多行，插入多行时，除最后一行外，每行末尾都需要用\\来表示数据未完结</span><br><span class=\"line\">d     删除指定行</span><br><span class=\"line\">p     打印，输出指定行</span><br><span class=\"line\">s     字符替换，用一个字符串替换另一个字符串。格式为&#x27;行范围s/旧字符串/新字符串/g&#x27;</span><br></pre></td></tr></table></figure>\n\n","categories":["shell"],"tags":["shell"]},{"title":"位置参数变量","url":"/2021/linux/shell/%E4%BD%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E5%8F%98%E9%87%8F/","content":"<h2 id=\"位置参数变量\"><a href=\"#位置参数变量\" class=\"headerlink\" title=\"位置参数变量\"></a>位置参数变量</h2><p>在写shell脚本的时候，难免会进行命令行传参，下面来介绍一下位置参数变量</p>\n<ul>\n<li>$n     n为数字，$0代表本身  $1-$9代表第一到第九个参数，十以上的参数需要使用大括号，如${10}</li>\n<li>$*      表示命令行中的所有参数，把所有参数看成一个整体</li>\n<li>$@    也表示命令行中的所有参数，但是把每个参数区分对待</li>\n<li>$#     表示命令行中所有参数的个数</li>\n</ul>\n<p>例：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">在hello.sh中</span></span><br><span class=\"line\">echo &quot;参数个数为$#&quot;</span><br><span class=\"line\">echo &quot;第一个参数是$1&quot;</span><br><span class=\"line\">------------------------------</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">执行hello.sh</span></span><br><span class=\"line\">sh hello.sh 1 2 3</span><br><span class=\"line\">参数个数为3</span><br><span class=\"line\">第一个参数是1</span><br></pre></td></tr></table></figure>\n\n","categories":["shell"],"tags":["shell"]},{"title":"判断语句","url":"/2021/linux/shell/%E5%88%A4%E6%96%AD%E8%AF%AD%E5%8F%A5/","content":"<h2 id=\"判断语句\"><a href=\"#判断语句\" class=\"headerlink\" title=\"判断语句\"></a>判断语句</h2><p>使用test来进行判断</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> <span class=\"built_in\">test</span> [选项] 文件</span></span><br><span class=\"line\">test -d /Users/zhanghe/desktop/user/shell</span><br><span class=\"line\">---------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">示例：</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">如果该文件是目录则输出yes，否则输出no</span></span><br><span class=\"line\">test -d /Users/zhanghe/desktop/user/shell &amp;&amp; echo yes || echo no</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"选项\"><a href=\"#选项\" class=\"headerlink\" title=\"选项\"></a>选项</h3><h4 id=\"按照文件类型判断\"><a href=\"#按照文件类型判断\" class=\"headerlink\" title=\"按照文件类型判断\"></a>按照文件类型判断</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">-d  判断文件是否存在，且为目录</span><br><span class=\"line\">-e  判断文件是否存在</span><br><span class=\"line\">-f  判断文件是否存在，且为普通文件</span><br><span class=\"line\">-s  判断文件是否存在，并且是否为非空文件</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">示例</span></span><br><span class=\"line\">test -s stu.txt</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"按照权限判断\"><a href=\"#按照权限判断\" class=\"headerlink\" title=\"按照权限判断\"></a>按照权限判断</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">-r 判断文件是否存在，且是否有读权限</span><br><span class=\"line\">-w 判断文件是否存在，且是否有写权限</span><br><span class=\"line\">-x 判断文件是否存在，且是否有执行权限</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">示例</span></span><br><span class=\"line\">test -w stu.txt</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"数值比较\"><a href=\"#数值比较\" class=\"headerlink\" title=\"数值比较\"></a>数值比较</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">-eq   比较两个数是否相等</span><br><span class=\"line\">-ne   比较数1是否与数2不相等</span><br><span class=\"line\">-gt   比较数1是否大于数2</span><br><span class=\"line\">-lt   比较数1是否小于数2</span><br><span class=\"line\">-ge   比较数1是否大于等于数2</span><br><span class=\"line\">-le   比较数1是否小于等于数2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">示例</span></span><br><span class=\"line\">test 1 -eq 2</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"字符串比较\"><a href=\"#字符串比较\" class=\"headerlink\" title=\"字符串比较\"></a>字符串比较</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">-z  判断字符串是否为空</span><br><span class=\"line\">-n  判断字符串是否非空</span><br><span class=\"line\">==  判断两个字符串是否相等</span><br><span class=\"line\">!=  判断两个字符串是否不等</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">示例</span></span><br><span class=\"line\">test &quot;aa&quot; == &quot;ab&quot;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"逻辑判断\"><a href=\"#逻辑判断\" class=\"headerlink\" title=\"逻辑判断\"></a>逻辑判断</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">-a   逻辑与</span><br><span class=\"line\">-o   逻辑或</span><br><span class=\"line\">!    逻辑非</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">示例</span></span><br><span class=\"line\">test &quot;aa&quot; == &quot;aa&quot; -a &quot;ab&quot; == &quot;aa&quot;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>上述的test可以使用[  ]来替代</p>\n<p>如：</p>\n<p>[ -s stu.txt ]</p>\n<p>[ “aa” == “ab” ]</p>\n</blockquote>\n","categories":["shell"],"tags":["shell"]},{"title":"循环语句","url":"/2021/linux/shell/%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5/","content":"<h2 id=\"循环语句\"><a href=\"#循环语句\" class=\"headerlink\" title=\"循环语句\"></a>循环语句</h2><h3 id=\"for循环\"><a href=\"#for循环\" class=\"headerlink\" title=\"for循环\"></a>for循环</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"keyword\">for</span>循环的语法一  </span></span><br><span class=\"line\">for 变量 in 列表  </span><br><span class=\"line\">do  </span><br><span class=\"line\">    语句  </span><br><span class=\"line\">done</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"keyword\">for</span>循环的语法二</span></span><br><span class=\"line\">for (( 初始值;循环控制条件;变量变化 ))</span><br><span class=\"line\">    do</span><br><span class=\"line\">        语句</span><br><span class=\"line\">    done</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>示例：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 语法一</span></span><br><span class=\"line\">for num in 1 2 3 4 5</span><br><span class=\"line\">do</span><br><span class=\"line\">    echo &quot;num is $num&quot;</span><br><span class=\"line\">done</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">语法二</span></span><br><span class=\"line\">for (( i=0;i&lt;=5;i++ ))</span><br><span class=\"line\">    do</span><br><span class=\"line\">        echo &quot;num is $i&quot;</span><br><span class=\"line\">    done</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"while循环\"><a href=\"#while循环\" class=\"headerlink\" title=\"while循环\"></a>while循环</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"keyword\">while</span>循环的语法  </span></span><br><span class=\"line\">while [ 循环条件 ]  </span><br><span class=\"line\">do  </span><br><span class=\"line\">   语句  </span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n\n\n\n<p>示例：</p>\n<p>1到10相加</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\">sum=0</span><br><span class=\"line\">i=1</span><br><span class=\"line\">while [ $i -le 10 ]</span><br><span class=\"line\">do </span><br><span class=\"line\">    sum=$(($sum+$i))</span><br><span class=\"line\">    i=$(($i+1))</span><br><span class=\"line\">done</span><br><span class=\"line\">echo $sum</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"until循环\"><a href=\"#until循环\" class=\"headerlink\" title=\"until循环\"></a>until循环</h3><p>until循环和while循环相反，until循环只要条件不成立则进行循环，一旦条件成立，则终止</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">until循环的语法</span></span><br><span class=\"line\">until [ 循环条件 ]</span><br><span class=\"line\">do</span><br><span class=\"line\">    语句</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n\n<p>示例：</p>\n<p>1到10相加</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\">sum=0</span><br><span class=\"line\">i=1</span><br><span class=\"line\">until [ $i -gt 10 ]</span><br><span class=\"line\">do</span><br><span class=\"line\">    sum=$(($sum+$i))</span><br><span class=\"line\">    i=$(($i+1))</span><br><span class=\"line\">done</span><br><span class=\"line\">echo $sum</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"退出循环\"><a href=\"#退出循环\" class=\"headerlink\" title=\"退出循环\"></a>退出循环</h3><p>退出循环主要使用exit、continue、break这三个来进行控制</p>\n<h4 id=\"exit\"><a href=\"#exit\" class=\"headerlink\" title=\"exit\"></a>exit</h4><p>exit表示退出当前shell脚本，后续程序不再执行，可以指定返回值</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\">for num in 1 2 3 4 5</span><br><span class=\"line\">do</span><br><span class=\"line\">    if [ $num == 2 ]</span><br><span class=\"line\">    then </span><br><span class=\"line\">        exit 0</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    echo &quot;num is $num&quot;</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"break\"><a href=\"#break\" class=\"headerlink\" title=\"break\"></a>break</h4><p>使用break会跳出当前循环</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\">for num in 1 2 3 4 5</span><br><span class=\"line\">do</span><br><span class=\"line\">    if [ $num == 3 ] </span><br><span class=\"line\">    then</span><br><span class=\"line\">        break</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    echo &quot;num is $num&quot;</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"continue\"><a href=\"#continue\" class=\"headerlink\" title=\"continue\"></a>continue</h4><p>使用continue跳出本次循环</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\">for num in 1 2 3 4 5</span><br><span class=\"line\">do</span><br><span class=\"line\">    if [ $num == 3 ] </span><br><span class=\"line\">    then</span><br><span class=\"line\">        continue</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    echo &quot;num is $num&quot;</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n\n","categories":["shell"],"tags":["shell"]},{"title":"流程控制","url":"/2021/linux/shell/%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/","content":"<h2 id=\"流程控制\"><a href=\"#流程控制\" class=\"headerlink\" title=\"流程控制\"></a>流程控制</h2><h3 id=\"if条件判断\"><a href=\"#if条件判断\" class=\"headerlink\" title=\"if条件判断\"></a>if条件判断</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"keyword\">if</span>语句的语法</span></span><br><span class=\"line\">if condition1</span><br><span class=\"line\">then</span><br><span class=\"line\">    command1</span><br><span class=\"line\">elif condition2 </span><br><span class=\"line\">then </span><br><span class=\"line\">    command2</span><br><span class=\"line\">else</span><br><span class=\"line\">    commandN</span><br><span class=\"line\">fi</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果then需要和if放在同一行的话，使用;分隔</p>\n</blockquote>\n<p>fi用来结束if语句，相当于endif</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">a=10</span><br><span class=\"line\">b=20</span><br><span class=\"line\">if [ $a == $b ]</span><br><span class=\"line\">then</span><br><span class=\"line\">   echo &quot;a 等于 b&quot;</span><br><span class=\"line\">elif [ $a -gt $b ]</span><br><span class=\"line\">then</span><br><span class=\"line\">   echo &quot;a 大于 b&quot;</span><br><span class=\"line\">elif [ $a -lt $b ]</span><br><span class=\"line\">then</span><br><span class=\"line\">   echo &quot;a 小于 b&quot;</span><br><span class=\"line\">else</span><br><span class=\"line\">   echo &quot;没有符合的条件&quot;</span><br><span class=\"line\">fi</span><br></pre></td></tr></table></figure>\n<p>注意：<br>“[“ 符号前后、  “]”前边都要有空格</p>\n<h4 id=\"case条件控制\"><a href=\"#case条件控制\" class=\"headerlink\" title=\"case条件控制\"></a>case条件控制</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"keyword\">case</span>语句的语法</span></span><br><span class=\"line\">case 值 in</span><br><span class=\"line\">模式1)</span><br><span class=\"line\">    command1</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">模式2）</span><br><span class=\"line\">    commandN</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">esac</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">echo &quot;input your name:&quot;</span><br><span class=\"line\">read name</span><br><span class=\"line\">case $name in</span><br><span class=\"line\">    zhanghe) echo &quot;你是管理员，权限最大&quot;;;</span><br><span class=\"line\">    zhangsan) echo &quot;你是谁呀，张三吗&quot;;;</span><br><span class=\"line\">    *) echo &quot;你我可不认识&quot;;;</span><br><span class=\"line\">esac</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/images/linux/%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6.png\" alt=\"image\"></p>\n<ul>\n<li>取值后边一定要用in</li>\n<li>变量的值会匹配)符号前面的字符串</li>\n<li>如果匹配的话，会执行该case下的语句，直到发现;;时停止</li>\n<li>如果没有匹配，就会执行最后*)这一行的内容</li>\n<li>如果没有匹配到不想执行任何内容的话，可以不写*)</li>\n</ul>\n<p>注意：<br>一定注意;;如果不加;;的话，执行会出错的</p>\n","categories":["shell"],"tags":["shell"]},{"title":"读取变量","url":"/2021/linux/shell/%E8%AF%BB%E5%8F%96%E5%8F%98%E9%87%8F/","content":"<h2 id=\"读取变量\"><a href=\"#读取变量\" class=\"headerlink\" title=\"读取变量\"></a>读取变量</h2><p>可以使用read来接收键盘输入的变量，与位置参数变量相比更适合于人机交互</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">read [选项] [变量]</span><br><span class=\"line\">------------------------</span><br><span class=\"line\">-s  隐藏输入(密码)</span><br><span class=\"line\">-p  提示信息</span><br><span class=\"line\">-t  等待时间</span><br><span class=\"line\">-n  限制字符个数</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 将键盘输入的内容赋给num1变量</span></span><br><span class=\"line\">read -p &quot;输入数字1: &quot; num1</span><br><span class=\"line\">read -p &quot;输入数字2: &quot; num2</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">$((运算式))可以进行数值运算</span></span><br><span class=\"line\">echo &quot;两个数之和为&quot;$(($num1 + num2))</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">zhanghe@bogon shell % sh add.sh </span><br><span class=\"line\">输入数字1: 13</span><br><span class=\"line\">输入数字2: 12</span><br><span class=\"line\">两个数之和为25</span><br></pre></td></tr></table></figure>\n\n","categories":["shell"],"tags":["shell"]},{"title":"输出重定向","url":"/2021/linux/shell/%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91/","content":"<h2 id=\"输出重定向\"><a href=\"#输出重定向\" class=\"headerlink\" title=\"输出重定向\"></a>输出重定向</h2><p>bash的输出分为标准输出和错误输出</p>\n<ul>\n<li>标准输出    文件描述符是1</li>\n<li>错误输出   文件描述符是2</li>\n</ul>\n<p>而输出重定向可以将本应该输出到控制台的内容输出到文件</p>\n<ul>\n<li>标准输出重定向     命令 &gt; 文件    覆盖原文件内容           命令 &gt;&gt; 文件   追加</li>\n<li>错误输出重定向     错误命令 2&gt;文件    覆盖原文件内容    错误命令 2&gt;文件  追加</li>\n</ul>\n<p>使用</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 把命令的标准输出保存到文件中 再将错误输出保存到参数1中，即文件中</span></span><br><span class=\"line\">命令 &gt;&gt; 文件 2&gt;&amp;1</span><br></pre></td></tr></table></figure>\n\n<p>可以将命令输出内容追加到文件中(不管是错误信息还是正确信息)</p>\n","categories":["shell"],"tags":["shell"]},{"title":"linux下载软件包","url":"/2021/linux/%E5%8C%85%E7%AE%A1%E7%90%86/linux%E4%B8%8B%E8%BD%BD%E8%BD%AF%E4%BB%B6%E5%8C%85/","content":"<h2 id=\"linux下载软件包\"><a href=\"#linux下载软件包\" class=\"headerlink\" title=\"linux下载软件包\"></a>linux下载软件包</h2><p>linux下只有两种软件包</p>\n<ul>\n<li>源码包</li>\n<li>二进制包(rpm)  centos下</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"RPM包操作\"><a href=\"#RPM包操作\" class=\"headerlink\" title=\"RPM包操作\"></a>RPM包操作</h3><h4 id=\"rpm安装\"><a href=\"#rpm安装\" class=\"headerlink\" title=\"rpm安装\"></a>rpm安装</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">rpm -ivh 包全名</span><br><span class=\"line\">-------</span><br><span class=\"line\">-i     install安装</span><br><span class=\"line\">-v     verbose显示详细信息</span><br><span class=\"line\">-h     显示安装进度</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"rpm包升级\"><a href=\"#rpm包升级\" class=\"headerlink\" title=\"rpm包升级\"></a>rpm包升级</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">rpm -Uvh  包全名</span><br><span class=\"line\">------</span><br><span class=\"line\">-U    升级安装</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"rpm包卸载\"><a href=\"#rpm包卸载\" class=\"headerlink\" title=\"rpm包卸载\"></a>rpm包卸载</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">rpm -e 包名</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"rpm包查询\"><a href=\"#rpm包查询\" class=\"headerlink\" title=\"rpm包查询\"></a>rpm包查询</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查询是否安装</span></span><br><span class=\"line\">rpm -q 包名</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查询系统上所有安装的包</span></span><br><span class=\"line\">rpm -qa</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查询软件包的文件列表</span></span><br><span class=\"line\">rpm -ql 包名</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查询某个文件属于哪个包</span></span><br><span class=\"line\">rpm -qf 文件名</span><br><span class=\"line\"></span><br><span class=\"line\">------------------</span><br><span class=\"line\">-i  info信息</span><br><span class=\"line\">-a  all所有</span><br><span class=\"line\">-l  list文件列表</span><br><span class=\"line\">-f  file文件</span><br></pre></td></tr></table></figure>\n\n<p>由于rpm安装软件包时比较麻烦，各个包之间的依赖需要去人工下载，所以一般使用yum来在线安装</p>\n<h3 id=\"yum安装软件包\"><a href=\"#yum安装软件包\" class=\"headerlink\" title=\"yum安装软件包\"></a>yum安装软件包</h3><p>yum的源配置文件保存在/etc/yum.repos.d文件夹中，默认使用的是CentOS-Base.repo</p>\n<blockquote>\n<p>我在使用系统自带的yum源文件时发现无法访问那些网站，所以去找了个搜狐的镜像源，将原本的baseurl的前半部分换为<a href=\"http://mirrors.sohu.com/\">http://mirrors.sohu.com/</a></p>\n<p>如：baseurl=<a href=\"http://mirrors.sohu.com/centos/$releasever/os/$basearch/\">http://mirrors.sohu.com/centos/$releasever/os/$basearch/</a></p>\n</blockquote>\n<h4 id=\"查询\"><a href=\"#查询\" class=\"headerlink\" title=\"查询\"></a>查询</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查询yum源服务器上的所有软件包</span></span><br><span class=\"line\">yum list</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查询是否包含某个软件包</span></span><br><span class=\"line\">yum list 包名</span><br><span class=\"line\"></span><br><span class=\"line\">yum search 关键字</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install 包名</span><br><span class=\"line\">-------</span><br><span class=\"line\">install  安装</span><br><span class=\"line\">-y  自动回答yes</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"升级\"><a href=\"#升级\" class=\"headerlink\" title=\"升级\"></a>升级</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y update 包名</span><br><span class=\"line\">-------</span><br><span class=\"line\">update  升级</span><br><span class=\"line\">-y  自动回答yes</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"卸载\"><a href=\"#卸载\" class=\"headerlink\" title=\"卸载\"></a>卸载</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum remove 包名</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>卸载需要谨慎，会把依赖该包的所有包都卸载掉</p>\n</blockquote>\n<h4 id=\"软件组操作\"><a href=\"#软件组操作\" class=\"headerlink\" title=\"软件组操作\"></a>软件组操作</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum grouplist</span><br><span class=\"line\"></span><br><span class=\"line\">yum groupinfo</span><br><span class=\"line\"></span><br><span class=\"line\">yum -y groupinstall 组名</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"源码包安装\"><a href=\"#源码包安装\" class=\"headerlink\" title=\"源码包安装\"></a>源码包安装</h3><p>首先下载源码包的压缩包，解压之后进入目录</p>\n<h4 id=\"第一步\"><a href=\"#第一步\" class=\"headerlink\" title=\"第一步\"></a>第一步</h4><p>先执行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">./configure --prefix=安装到的目录位置</span><br></pre></td></tr></table></figure>\n\n<p>该命令使编译前检测系统环境是否符合安装要求，把系统环境的检测结果写入Makefile文件中，后续的安装过程都会依赖该文件。</p>\n<h4 id=\"第二步\"><a href=\"#第二步\" class=\"headerlink\" title=\"第二步\"></a>第二步</h4><p>如果检测成功，则继续执行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">make</span><br></pre></td></tr></table></figure>\n\n<p>该命令的作用是调用gcc编译器，读取上述Makefile文件中的信息进行系统软件编译，编译是为了把源码程序转换成linux可执行的文件</p>\n<h4 id=\"第三步\"><a href=\"#第三步\" class=\"headerlink\" title=\"第三步\"></a>第三步</h4><p>如果编译出错执行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">make clean</span><br></pre></td></tr></table></figure>\n\n<p>清空编译内容</p>\n<p>如果编译没有出错，执行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">make install</span><br></pre></td></tr></table></figure>\n\n<p>编译安装</p>\n","categories":["shell"],"tags":["shell"]},{"title":"linux权限管理命令","url":"/2021/linux/%E5%9F%BA%E7%A1%80/linux%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/","content":"<h2 id=\"权限管理命令\"><a href=\"#权限管理命令\" class=\"headerlink\" title=\"权限管理命令\"></a>权限管理命令</h2><h3 id=\"权限的查看及含义\"><a href=\"#权限的查看及含义\" class=\"headerlink\" title=\"权限的查看及含义\"></a>权限的查看及含义</h3><p>可以使用ls -l来查看每个文件或目录的权限，一共有十位</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">ls -ls</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">-rw-------. 1 root root   946 Feb 14 16:13 anaconda-ks.cfg</span><br><span class=\"line\">drwxr-xr-x. 2 root root  4096 Feb 15 15:47 Desktop</span><br><span class=\"line\">drwxr-xr-x. 2 root root  4096 Feb 15 15:47 Documents</span><br><span class=\"line\">drwxr-xr-x. 2 root root  4096 Feb 15 15:47 Downloads</span><br><span class=\"line\">drwxr-xr-x. 2 root root  4096 Feb 15 15:47 Music</span><br><span class=\"line\">drwxr-xr-x. 2 root root  4096 Feb 15 15:47 Pictures</span><br><span class=\"line\">-rw-r--r--. 1 root root 12148 Nov 30  2013 post-install</span><br><span class=\"line\">-rw-r--r--. 1 root root   552 Nov 30  2013 post-install.log</span><br><span class=\"line\">drwxr-xr-x. 2 root root  4096 Feb 15 15:47 Public</span><br><span class=\"line\">drwxr-xr-x. 2 root root  4096 Feb 15 15:47 Templates</span><br><span class=\"line\">drwxr-xr-x. 2 root root  4096 Feb 15 15:47 Videos</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<ul>\n<li>第 1 个字符表示文件类型，其中，普通文件 (-)、目录文件 (d)、套接字文件 (s)，管道文件 (p)，字符设备文件 (c)，块设备文件 (b)，软链接文件 (l)；</li>\n<li>第 2 个字符开始的 rwxr-xr-x 部分表示文件的权限位，共有 9 位。每三位为一组，分别为所有者的权限u、所属组的权限g、其他人权限o<ul>\n<li>第 2~4 位的 rwx 表示该文件可被它的 所有者以 r(读) 或 w(写) 或 x(执行) 的权限访问。</li>\n<li>第 5~7 位的 r-x 表示该文件可被与该文件同一所有组的用户以 r 或 x 的权限访问</li>\n<li>第 8~10 位的 r-x 表示该文件可被其它未知用户以 r 或 x 的权限访问。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"权限修改\"><a href=\"#权限修改\" class=\"headerlink\" title=\"权限修改\"></a>权限修改</h3><p>使用设置权限的命令 chmod<br>语法：<br> chmod [设置权限的对象]+/-[权限] [文件]<br> 设置权限的对象包括 所有者、所属组、其他这三类。u表示文件的所有者，g表示文件的所属组，o代表其他人<br> +代表增加权限，-代表去掉权限<br> 文件的权限就是读、写和执行，分别用r、w、x表示</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">chmod g+w abc.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">多个设置权限可以使用逗号分隔</span></span><br><span class=\"line\">chmod u+x,g+w abc.txt</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"数字权限\"><a href=\"#数字权限\" class=\"headerlink\" title=\"数字权限\"></a>数字权限</h4><p>使用字母设置权限命令比较长，linux支持使用数字来替代权限</p>\n<ul>\n<li>4  代表r权限</li>\n<li>2  代表w权限</li>\n<li>1  代表x权限</li>\n</ul>\n<p>可以使用多个数字加和的方式来设置权限</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置u权限为7=4+2+1，设置g权限为5=4+1，设置o权限为5=4+1</span></span><br><span class=\"line\">chmod 755 abc.txt</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"用户操作\"><a href=\"#用户操作\" class=\"headerlink\" title=\"用户操作\"></a>用户操作</h3><h4 id=\"添加用户\"><a href=\"#添加用户\" class=\"headerlink\" title=\"添加用户\"></a>添加用户</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">添加用户</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">useradd 用户名</span></span><br><span class=\"line\">useradd user1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">给user1设置密码</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">passwd 用户名</span></span><br><span class=\"line\">passwd user1</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改文件所有者\"><a href=\"#修改文件所有者\" class=\"headerlink\" title=\"修改文件所有者\"></a>修改文件所有者</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">chown 用户名 文件</span></span><br><span class=\"line\">chown user1 abc.txt</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">chown 用户名:组名 文件</span></span><br><span class=\"line\">chown user1:user1 abc.txt</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改所属组\"><a href=\"#修改所属组\" class=\"headerlink\" title=\"修改所属组\"></a>修改所属组</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">chgrp 组名 文件名</span></span><br><span class=\"line\">chgrp user1 abc.txt</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ACL操作\"><a href=\"#ACL操作\" class=\"headerlink\" title=\"ACL操作\"></a>ACL操作</h3><p>ACL是用来解决用户对文件身份不足的问题，上述权限管理只能对三类人群进行权限区分，这明显是不够的，所以出现了ACL操作</p>\n<p>先确认一下acl是否开启(一般情况下acl是开启的)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> dumpe2fs 查询指定分区详细文件系统信息的命令</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 这里我的sda1是根分区，</span></span><br><span class=\"line\">dumpe2fs -h /dev/sda1</span><br><span class=\"line\"></span><br><span class=\"line\">-h 只显示超级块中的信息，不显示磁盘块组的信息</span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">如果在查询结果中找到Default mount options:    user_xattr acl则说明acl是开启状态</span></span><br></pre></td></tr></table></figure>\n\n<p>如果acl没有开启</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">重新挂载根分区</span></span><br><span class=\"line\">mount -o remount,acl /</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"ACL基本命令\"><a href=\"#ACL基本命令\" class=\"headerlink\" title=\"ACL基本命令\"></a>ACL基本命令</h4><p>查看文件acl权限</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">getfacl 1.txt</span><br><span class=\"line\"></span><br><span class=\"line\">-----------------</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> file: 1.txt</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> owner: root</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> group: root</span></span><br><span class=\"line\">user::rw-</span><br><span class=\"line\">group::r--</span><br><span class=\"line\">other::r--</span><br></pre></td></tr></table></figure>\n\n<p>设定acl权限</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">setfacl [options] 文件名</span></span><br><span class=\"line\">setfacl -m u:test1:6 1.txt</span><br><span class=\"line\">-----------------</span><br><span class=\"line\">-m u:用户名:权限 | g:组名:权限  设定acl权限</span><br><span class=\"line\">-b  删除acl权限</span><br><span class=\"line\">-R 递归，只能作用于目录，将权限同样赋给目录中的文件  setfacl -m u:test1:6 -R src  只能对已存在的文件设置权限</span><br><span class=\"line\">                                             setfacl -m d:u:test1:6 -R src  对以后创建的文件也生效，d表示默认</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"sudo授权\"><a href=\"#sudo授权\" class=\"headerlink\" title=\"sudo授权\"></a>sudo授权</h3><p>给普通用户赋予部分管理员权限</p>\n","categories":["linux"],"tags":["linux"]},{"title":"linux版本","url":"/2021/linux/%E5%9F%BA%E7%A1%80/linux%E7%89%88%E6%9C%AC/","content":"<h2 id=\"linux版本\"><a href=\"#linux版本\" class=\"headerlink\" title=\"linux版本\"></a>linux版本</h2><p>linux主要分为了内核版和发行版</p>\n<p>内核版是由linus进行维护的，要使用RHEL6.5以上</p>\n<p>发行版主要有两个系列</p>\n<ul>\n<li>RedHat系列(contos、suse等)<ul>\n<li>个人版：Fedora</li>\n<li>服务器版：RHEL(RedHat Enterprise Linux)</li>\n</ul>\n</li>\n<li>Debian系列(ubuntu、knoppix等)</li>\n</ul>\n","categories":["linux"],"tags":["linux"]},{"title":"vim编辑器","url":"/2021/linux/%E5%9F%BA%E7%A1%80/vim%E7%BC%96%E8%BE%91%E5%99%A8/","content":"<h2 id=\"vim编辑器\"><a href=\"#vim编辑器\" class=\"headerlink\" title=\"vim编辑器\"></a>vim编辑器</h2><p>vim有三种模式，命令模式，插入模式，末行模式，在一开始的时候默认进入的是命令模式  </p>\n<h3 id=\"命令模式\"><a href=\"#命令模式\" class=\"headerlink\" title=\"命令模式\"></a>命令模式</h3><p>命令模式：默认的模式，该模式下有很多的快捷键 </p>\n<a id=\"more\"></a> \n\n<h4 id=\"移动光标\"><a href=\"#移动光标\" class=\"headerlink\" title=\"移动光标\"></a>移动光标</h4><h5 id=\"文件内移动\"><a href=\"#文件内移动\" class=\"headerlink\" title=\"文件内移动\"></a><strong>文件内移动</strong></h5><ul>\n<li>Shift+g快速定位到指定的行，先按你想要的跳转的行，然后按Shift+g，如：要跳到第三行，先按数字3，然后按下Shift+g  </li>\n<li>Shift+g(或者G)跳转到尾行</li>\n<li>gg跳转到首行</li>\n<li>:n 跳到指定行  n为指定的行号</li>\n</ul>\n<h5 id=\"行内移动\"><a href=\"#行内移动\" class=\"headerlink\" title=\"行内移动\"></a><strong>行内移动</strong></h5><ul>\n<li>^  移动到行首</li>\n<li>$  移动到行尾</li>\n<li>w、b键，分别表示向后和向前移动一个单词</li>\n</ul>\n<h5 id=\"删除字母\"><a href=\"#删除字母\" class=\"headerlink\" title=\"删除字母\"></a>删除字母</h5><ul>\n<li>x 删除单个字母</li>\n<li>nx 删除多个字符</li>\n</ul>\n<h5 id=\"删除整行\"><a href=\"#删除整行\" class=\"headerlink\" title=\"删除整行\"></a>删除整行</h5><ul>\n<li>dd  删除整行 </li>\n<li>ndd  删除多行 </li>\n<li>:n1,n2d删除指定行</li>\n<li>dG  从当前行删除到文件尾</li>\n<li>想要删除该行末尾的回车，也就是两行合并为一行，使用Shift+j</li>\n</ul>\n<h5 id=\"剪切、复制、粘贴\"><a href=\"#剪切、复制、粘贴\" class=\"headerlink\" title=\"剪切、复制、粘贴\"></a>剪切、复制、粘贴</h5><ul>\n<li>dd  既是删除也是剪切，按p是粘贴至光标后，P是粘贴至光标前</li>\n<li>yy  复制单行</li>\n<li>nyy  复制多行</li>\n</ul>\n<h5 id=\"撤销\"><a href=\"#撤销\" class=\"headerlink\" title=\"撤销\"></a>撤销</h5><ul>\n<li>u  撤销修改</li>\n<li>Ctrl+r  反撤销</li>\n</ul>\n<h5 id=\"替换\"><a href=\"#替换\" class=\"headerlink\" title=\"替换\"></a>替换</h5><ul>\n<li>r  替换光标所在处的字母</li>\n<li>R  进入替换模式，从光标所在处开始替换字符，按esc结束</li>\n</ul>\n<ul>\n<li>查找，按下/键，然后输入所要查找的字符，按回车，如果找到光标会跳转到第一个搜索结果的位置，然后按n，继续向下查找，如果按Shift+n，会反向向上查找</li>\n</ul>\n<h3 id=\"插入模式\"><a href=\"#插入模式\" class=\"headerlink\" title=\"插入模式\"></a>插入模式</h3><p>插入模式(输入模式)：可以向文件中输入字符的模式。</p>\n<p>在命令模式下，</p>\n<ul>\n<li>按a 在光标所在位置后插入(追加)</li>\n<li>按i 在光标所在位置前插入(插入)</li>\n<li>按A 在光标所在行尾插入</li>\n<li>按I 在光标所在行首插入</li>\n<li>按o 在光标上插入新行</li>\n<li>按O 在光标上插入新行</li>\n</ul>\n<p>按Esc退出输入模式，进入命令模式</p>\n<h3 id=\"末行模式\"><a href=\"#末行模式\" class=\"headerlink\" title=\"末行模式\"></a>末行模式</h3><p>末行模式：该模式下，在vim界面最下边可以输入命令，来执行各种操作，编辑完文件之后，想要保存修改或者不保存修改都需要进入末行模式来进行操作，从命令模式切到底末模式，按:（冒号）进入末行模式  </p>\n<h4 id=\"文件编辑\"><a href=\"#文件编辑\" class=\"headerlink\" title=\"文件编辑\"></a>文件编辑</h4><ul>\n<li>:w 保存文件但不退出vi</li>\n<li>:w 文件名 将修改另外保存到新的文件中，不退出vi</li>\n<li>new 文件名 如果该文件存在则打开该文件，如果不存在，则新建(只有保存之后该文件才会创建成功)</li>\n<li>:w! 强制保存，不退出vi</li>\n<li>:wq 保存文件并退出vi</li>\n<li>:wq! 强制保存文件，并退出vi</li>\n<li>:q 不保存文件，退出vi</li>\n<li>:q! 不保存文件，强制退出vi</li>\n<li>:e! 放弃所有修改，从上次保存文件开始再编辑</li>\n</ul>\n<h4 id=\"参数设置\"><a href=\"#参数设置\" class=\"headerlink\" title=\"参数设置\"></a>参数设置</h4><ul>\n<li>:set nu   显示行号</li>\n<li>:set nonu  隐藏行号</li>\n<li>:set list  显示特殊符号(Tab用^I表示，换行符用$显示)</li>\n<li>:set nolist  不显示特殊符号</li>\n</ul>\n<h4 id=\"查找\"><a href=\"#查找\" class=\"headerlink\" title=\"查找\"></a>查找</h4><ul>\n<li>/查找内容    从光标处往下查找</li>\n<li>?查找内容   从光标处往上查找</li>\n<li>n  下一个</li>\n<li>N  上一个</li>\n</ul>\n<h4 id=\"替换-1\"><a href=\"#替换-1\" class=\"headerlink\" title=\"替换\"></a>替换</h4><ul>\n<li>:1,10s/old/new/g     替换1到10行的所有old为new</li>\n<li>:%s/old/new/g    替换全文的所有old为new</li>\n</ul>\n<figure class=\"highlight vim\"><table><tr><td class=\"code\"><pre><span class=\"line\">#<span class=\"number\">1</span>到<span class=\"number\">10</span>行添加注释#  (使用^是因为^在正则中表示行首)</span><br><span class=\"line\">:<span class=\"number\">1</span>,<span class=\"number\">10</span>s/^/#/g</span><br><span class=\"line\">#<span class=\"number\">1</span>到<span class=\"number\">10</span>行取消注释#  (使用^是因为^在正则中表示行首)</span><br><span class=\"line\">:<span class=\"number\">1</span>,<span class=\"number\">10</span>s/^#//g</span><br></pre></td></tr></table></figure>\n\n","categories":["linux"],"tags":["linux"]},{"title":"使用ssh连接被拒","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E4%BD%BF%E7%94%A8ssh%E8%BF%9E%E6%8E%A5%E8%A2%AB%E6%8B%92/","content":"<h2 id=\"使用ssh连接被拒\"><a href=\"#使用ssh连接被拒\" class=\"headerlink\" title=\"使用ssh连接被拒\"></a>使用ssh连接被拒</h2><p>在使用电脑连接虚拟机时，发现ssh连接被拒</p>\n<p>进入虚拟机Linux的 /etc/init.d目录下，查看sshd是否启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">./sshd status</span><br></pre></td></tr></table></figure>\n\n<p>发现是停止状态，重启一下即可</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">./sshd restart</span><br></pre></td></tr></table></figure>\n\n<p>也可以使用</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">service sshd start</span><br></pre></td></tr></table></figure>\n\n","categories":["linux"],"tags":["linux"]},{"title":"linux关机和重启","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E5%85%B3%E6%9C%BA%E5%92%8C%E9%87%8D%E5%90%AF/","content":"<h2 id=\"关机和重启\"><a href=\"#关机和重启\" class=\"headerlink\" title=\"关机和重启\"></a>关机和重启</h2><p>关机和重启之前最好先数据数据同步一下</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">sync</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">shutdown [选项] 时间</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">现在重启</span></span><br><span class=\"line\">shutdown -r now</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">关机</span></span><br><span class=\"line\">shutdown -h now</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">取消重启</span></span><br><span class=\"line\">shutdown -c</span><br></pre></td></tr></table></figure>\n\n","categories":["linux"],"tags":["linux"]},{"title":"linux压缩解压缩","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E5%8E%8B%E7%BC%A9%E8%A7%A3%E5%8E%8B%E7%BC%A9/","content":"<h2 id=\"压缩解压缩\"><a href=\"#压缩解压缩\" class=\"headerlink\" title=\"压缩解压缩\"></a>压缩解压缩</h2><p>linux中压缩和解压文件也是很常见的</p>\n<h3 id=\"zip格式\"><a href=\"#zip格式\" class=\"headerlink\" title=\"zip格式\"></a>zip格式</h3><p>zip格式的压缩包在windows很常见，linux中也有zip格式的压缩包</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">压缩</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">zip [选项] 压缩包名 文件(多个文件空格隔开)</span></span><br><span class=\"line\">zip 1.zip 123.txt 456.txt</span><br><span class=\"line\"> </span><br><span class=\"line\">zip -r 2.zip /home/user1</span><br><span class=\"line\"></span><br><span class=\"line\"> ----------------------</span><br><span class=\"line\"> -r 压缩目录</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta\"> #</span><span class=\"bash\">解压缩</span></span><br><span class=\"line\"> unzip [选项] 压缩包名</span><br><span class=\"line\"> --------------------</span><br><span class=\"line\"> -d  指定解压缩位置</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"gz格式\"><a href=\"#gz格式\" class=\"headerlink\" title=\"gz格式\"></a>gz格式</h3><p>gz格式在linux中是一种很常用的格式</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">压缩</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">gzip [选项] 源文件</span></span><br><span class=\"line\">gzip test.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">解压</span></span><br><span class=\"line\">gzip -d test.txt.gz</span><br><span class=\"line\"></span><br><span class=\"line\">----------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-d  解压缩</span><br><span class=\"line\">-c  将源文件输出到控制台</span><br><span class=\"line\">-r  压缩目录(也是将该目录下的文件分别压缩)</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>gzip压缩之后源文件就不见了，且不支持将多个文件压缩至一个压缩包中，压缩包的名称为源文件名称+.gz</p>\n</blockquote>\n<h3 id=\"bz2格式\"><a href=\"#bz2格式\" class=\"headerlink\" title=\"bz2格式\"></a>bz2格式</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">压缩</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">bzip2 [选项] 源文件</span></span><br><span class=\"line\">bzip2 123.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">解压缩</span></span><br><span class=\"line\">bzip2 -d 123.txt.bz2</span><br><span class=\"line\"></span><br><span class=\"line\">---------------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-d  解压缩</span><br><span class=\"line\">-v  显示压缩时详细信息</span><br><span class=\"line\">-k  压缩时保留原文件</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>该格式不可以压缩目录</p>\n</blockquote>\n<h3 id=\"tar格式\"><a href=\"#tar格式\" class=\"headerlink\" title=\"tar格式\"></a>tar格式</h3><p>由于多个文件一起压缩打包gzip和bz2无法完成，需要使用tar，但是tar命令只可以打包，不会压缩  </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">压缩</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">tar [选项] [-f 压缩名] 源文件</span></span><br><span class=\"line\">tar -cvf 11.tar 123.txt</span><br><span class=\"line\">-------------------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-c 打包</span><br><span class=\"line\">-f 压缩名</span><br><span class=\"line\">-v 显示打包过程</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">解压缩</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">tar [选项] 压缩包</span></span><br><span class=\"line\">tar -xvf 11.tar</span><br><span class=\"line\"></span><br><span class=\"line\">---------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\"></span><br><span class=\"line\">-f 压缩名</span><br><span class=\"line\">-v 显示解压缩过程</span><br><span class=\"line\">-x 解压缩</span><br><span class=\"line\">-t 查看保重有哪些文件，不解压</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"tar-gz和tar-bz2格式\"><a href=\"#tar-gz和tar-bz2格式\" class=\"headerlink\" title=\"tar.gz和tar.bz2格式\"></a>tar.gz和tar.bz2格式</h3><p>由于tar格式只会打包不会压缩，而gzip和bz2只会压缩不会打包，所以将两者结合了一下，先进行tar打包，在进行gzip压缩，但是如果每次压缩和解压都要两步操作太麻烦了，所以出现了.tar.gz和.tar.bz2格式</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">压缩</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">tar [选项] [-f 压缩名] 源文件</span></span><br><span class=\"line\">tar -zcvf 11.tar.gz 123.txt</span><br><span class=\"line\">-------------------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-z 压缩和解压缩tar.gz格式(仅用于识别格式)</span><br><span class=\"line\">-j 压缩个解压缩tar.bz2格式(仅用于识别格式)</span><br><span class=\"line\">-c 打包</span><br><span class=\"line\">-f 压缩名</span><br><span class=\"line\">-v 显示打包过程</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">解压缩</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">tar [选项] 压缩包</span></span><br><span class=\"line\">tar -zxvf 11.tar</span><br><span class=\"line\"></span><br><span class=\"line\">---------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-z 压缩和解压缩tar.gz格式(仅用于识别格式)</span><br><span class=\"line\">-j 压缩个解压缩tar.bz2格式(仅用于识别格式)</span><br><span class=\"line\">-f 压缩名</span><br><span class=\"line\">-v 显示解压缩过程</span><br><span class=\"line\">-x 解压缩</span><br><span class=\"line\">-t 查看保重有哪些文件，不解压</span><br></pre></td></tr></table></figure>","categories":["linux"],"tags":["linux"]},{"title":"linux帮助命令","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E5%B8%AE%E5%8A%A9%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"帮助命令\"><a href=\"#帮助命令\" class=\"headerlink\" title=\"帮助命令\"></a>帮助命令</h2><p>linux中命令很多，而且每个命令还有不同的选项，在使用命令的时候经常忘记该命令后应该跟什么选项来进行操作，linux中是有帮助命令来介绍每个命令及每个选项的</p>\n<h3 id=\"man命令\"><a href=\"#man命令\" class=\"headerlink\" title=\"man命令\"></a>man命令</h3><p>man命令是linux中最常用的帮助命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">man [选项] 命令</span></span><br><span class=\"line\">man ls</span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------</span><br><span class=\"line\">-f  查看命令拥有哪个级别的帮助</span><br><span class=\"line\">-k  查看和命令相关的所有帮助</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"info命令\"><a href=\"#info命令\" class=\"headerlink\" title=\"info命令\"></a>info命令</h3><p>info命令是比man命令展示更多的命令信息</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">info ls</span><br></pre></td></tr></table></figure>\n\n","categories":["linux"],"tags":["linux"]},{"title":"linux命令行快捷键","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE/","content":"<h2 id=\"linux命令行快捷键\"><a href=\"#linux命令行快捷键\" class=\"headerlink\" title=\"linux命令行快捷键\"></a>linux命令行快捷键</h2><ul>\n<li>Tab  命令补全或文件补全</li>\n<li>Ctrl+u  删除或剪切光标之前的命令</li>\n<li>Ctrl+a  将光标移动到命令行开头</li>\n<li>Ctrl+e  将光标移动到命令行结尾</li>\n<li>ctrl+c   终止当前命令</li>\n<li>ctrl+l  清屏</li>\n<li>ctrl+y  粘贴ctrl+u的内容</li>\n</ul>\n","categories":["linux"],"tags":["linux"]},{"title":"linux搜索命令","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E6%90%9C%E7%B4%A2%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"搜索命令\"><a href=\"#搜索命令\" class=\"headerlink\" title=\"搜索命令\"></a>搜索命令</h2><h3 id=\"locate命令\"><a href=\"#locate命令\" class=\"headerlink\" title=\"locate命令\"></a>locate命令</h3><p>搜索速度快，是按照数据库进行搜索的(数据库位置在/var/lib/mlocate/mlocate.db)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">locate abc.txt</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"find命令\"><a href=\"#find命令\" class=\"headerlink\" title=\"find命令\"></a>find命令</h3><p>虽然locate命令搜索速度很快，但是locate只能搜索文件名，不能根据权限、类型、时间来进行搜索，而使用find命令来搜索文件就可以进行细分了</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">find 搜索路径 [选项] 搜索内容</span></span><br><span class=\"line\">find . db</span><br><span class=\"line\"></span><br><span class=\"line\">------------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">按文件名</span><br><span class=\"line\">-name  按文件名</span><br><span class=\"line\">-iname 按文件名，不区分大小写</span><br><span class=\"line\">-inum  按inode搜索</span><br><span class=\"line\">按大小</span><br><span class=\"line\">-size  [+|-]大小  按照文件大小来搜索</span><br><span class=\"line\">按修改时间</span><br><span class=\"line\">-atime [+|-]时间  访问时间</span><br><span class=\"line\">-mtime [+|-]时间  数据修改时间</span><br><span class=\"line\">-ctime [+|-]时间  状态修改时间</span><br><span class=\"line\">按权限</span><br><span class=\"line\">-perm</span><br><span class=\"line\">按文件所有者和所属组</span><br><span class=\"line\">-uid  用户id</span><br><span class=\"line\">-gid  组id</span><br><span class=\"line\">-user 用户名</span><br><span class=\"line\">-group 组名</span><br><span class=\"line\">-nouser  没有所有者的文件</span><br><span class=\"line\">按类型</span><br><span class=\"line\">-type  d目录 f普通文件 l软链接</span><br><span class=\"line\">按逻辑运算，可以使得多种条件组合</span><br><span class=\"line\">-a   与</span><br><span class=\"line\">-o   或</span><br><span class=\"line\">-not 非</span><br></pre></td></tr></table></figure>\n\n<p>find命令还可以进行组合操作</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">find 路径 [选项] 内容 -<span class=\"built_in\">exec</span> 命令2 &#123;&#125; \\;</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">把find命令搜索到的结果交给-<span class=\"built_in\">exec</span>中命令2去处理  &#123;&#125;代表了find命令搜索到的结果</span></span><br><span class=\"line\"> find . -name *.cfg -exec ls -l &#123;&#125; \\;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">find 路径 [选项] 内容 -ok 命令2 &#123;&#125; \\;</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">ok与<span class=\"built_in\">exec</span>的区别在于  <span class=\"built_in\">exec</span>直接执行，ok会进行询问</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"grep命令\"><a href=\"#grep命令\" class=\"headerlink\" title=\"grep命令\"></a>grep命令</h3><p>用于在文件中搜索符合条件的字符串</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">grep [选项] 字符串 文件名</span></span><br><span class=\"line\">grep  &quot;cd&quot; 123.txt</span><br><span class=\"line\"></span><br><span class=\"line\">--------------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-i  忽略大小写</span><br><span class=\"line\">-n  输出行号</span><br><span class=\"line\">-v  反向查找</span><br><span class=\"line\">--color=auto 搜索出来的文字颜色显示</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"cut命令\"><a href=\"#cut命令\" class=\"headerlink\" title=\"cut命令\"></a>cut命令</h3><p>与grep相对应，grep是提取一行数据，cut是提取一列数据(列与列之间必须使用tab分隔)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cut -f 2 stu.txt</span><br><span class=\"line\">name</span><br><span class=\"line\">张三</span><br><span class=\"line\">李四</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">提取多列</span></span><br><span class=\"line\">cut -f 1,2 stu.txt</span><br><span class=\"line\">id    name</span><br><span class=\"line\">1    张三</span><br><span class=\"line\">2    李四</span><br><span class=\"line\"></span><br><span class=\"line\">--------------------</span><br><span class=\"line\">参数</span><br><span class=\"line\">-f 列号  提取第几列</span><br><span class=\"line\">-d 分隔符  按照指定分隔符分隔列(默认是tab)</span><br><span class=\"line\">-c 字符范围  n- 表示从第n个字符到行尾   n-m表示从第n个字符到第m个字符 -m表示从第1个字符到第m个字符</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","categories":["linux"],"tags":["linux"]},{"title":"linux文件操作命令","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"文件操作命令\"><a href=\"#文件操作命令\" class=\"headerlink\" title=\"文件操作命令\"></a>文件操作命令</h2><h3 id=\"创建文件\"><a href=\"#创建文件\" class=\"headerlink\" title=\"创建文件\"></a>创建文件</h3><p>使用touch命令可以创建和修改文件时间</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">touch test.txt</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"删除文件\"><a href=\"#删除文件\" class=\"headerlink\" title=\"删除文件\"></a>删除文件</h3><p>在使用rmdir删除目录的时候如果目录中存在子目录是不可以被删除的，使用起来比较恶心，所以在删除文件或者目录的时候都习惯于使用rm来删除</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">这里注意如果加上-f选项的话，就会强制删除，无法找回，删除之前要考虑清楚</span></span><br><span class=\"line\">rm -rf test.txt</span><br><span class=\"line\"></span><br><span class=\"line\">---------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-f  强制删除</span><br><span class=\"line\">-r  递归删除</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看文件\"><a href=\"#查看文件\" class=\"headerlink\" title=\"查看文件\"></a>查看文件</h3><h4 id=\"stat命令\"><a href=\"#stat命令\" class=\"headerlink\" title=\"stat命令\"></a>stat命令</h4><p>查看文件详细信息</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"> stat abc.txt</span><br><span class=\"line\"> </span><br><span class=\"line\"> ----------------------------</span><br><span class=\"line\">  File: `abc.txt&#x27;</span><br><span class=\"line\">  Size: 5               Blocks: 8          IO Block: 4096   regular file</span><br><span class=\"line\">Device: fd00h/64768d    Inode: 131272      Links: 1</span><br><span class=\"line\">Access: (0664/-rw-rw-r--)  Uid: (  500/ zhanghe)   Gid: (  500/ zhanghe)</span><br><span class=\"line\">Access: 2021-02-14 18:34:47.995289019 +0800</span><br><span class=\"line\">Modify: 2021-02-14 18:34:58.308673839 +0800</span><br><span class=\"line\">Change: 2021-02-14 18:34:58.308673839 +0800</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"cat命令\"><a href=\"#cat命令\" class=\"headerlink\" title=\"cat命令\"></a>cat命令</h4><p>查看文件内容</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cat abc.txt</span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-A 相当于-vET，列出所有的隐藏字符</span><br><span class=\"line\">-E 列出每行结尾的回车符$</span><br><span class=\"line\">-n 显示行号</span><br><span class=\"line\">-T 把Tab键用^I表示出来</span><br><span class=\"line\">-v 展示特殊字符</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"more命令\"><a href=\"#more命令\" class=\"headerlink\" title=\"more命令\"></a>more命令</h4><p>cat不适合查看大文件，使用more命令来分屏显示</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">more abc.txt</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">--------------------</span><br><span class=\"line\">空格键  向下翻页</span><br><span class=\"line\">b   向上翻页</span><br><span class=\"line\">回车   向下滚动一行</span><br><span class=\"line\">q   退出</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"head和tail命令\"><a href=\"#head和tail命令\" class=\"headerlink\" title=\"head和tail命令\"></a>head和tail命令</h4><p>head是显示文件头，tail是显示文件尾，默认10行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">tail abc.txt</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-n   显示行数</span><br><span class=\"line\">-f   监听文件新增内容，滚动</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"软链接\"><a href=\"#软链接\" class=\"headerlink\" title=\"软链接\"></a>软链接</h3><p>建立文件的软链接（可以看作是windows的快捷方式）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">ln -s abc.txt abc_c.txt</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">ls -l</span><br><span class=\"line\">-------------------------------</span><br><span class=\"line\">total 4</span><br><span class=\"line\">lrwxrwxrwx. 1 zhanghe zhanghe 7 Feb 14 19:59 abc_c.txt -&gt; abc.txt</span><br><span class=\"line\">-rw-rw-r--. 1 zhanghe zhanghe 5 Feb 14 18:34 abc.txt</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>特征</p>\n<ul>\n<li>软链接和源文件拥有不同的Inode和block</li>\n<li>修改任意一个，两者都会修改</li>\n<li>删除源文件，软链接不可用；删除软链接，源文件没有影响</li>\n<li>软链接不存储真实数据，存储的是源文件的Inode</li>\n</ul>\n<h3 id=\"复制文件\"><a href=\"#复制文件\" class=\"headerlink\" title=\"复制文件\"></a>复制文件</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cp abc.txt /home/zhanghe/Documents/test/aaa.txt</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">----------------------------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-r   递归复制，用于复制目录</span><br><span class=\"line\">-p   保留源文件的属性，如所有者、权限和时间</span><br><span class=\"line\">-i   询问是否覆盖</span><br><span class=\"line\">-d   如果源文件是软链接，则复制出来的也是软链接</span><br><span class=\"line\">-a   相当于-dpr</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>在复制的时候，如果目标位置是目录，则将文件复制过去，如果目标位置是文件，则将文件内容复制过去</p>\n</blockquote>\n<h3 id=\"剪切或者重命名\"><a href=\"#剪切或者重命名\" class=\"headerlink\" title=\"剪切或者重命名\"></a>剪切或者重命名</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"> mv aaa.txt acs.txt</span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------</span><br><span class=\"line\">-f   如果文件存在，强制覆盖</span><br><span class=\"line\">-i   询问</span><br><span class=\"line\">-v   显示详细信息</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>剪切如果在同一目录下就是重命名，不在同一目录下就是剪切</p>\n</blockquote>\n<p>查看文件格式及其编码</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">file -b read.sh</span><br></pre></td></tr></table></figure>\n\n<p>查看文件的MIME类型</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">file -i read.sh</span><br></pre></td></tr></table></figure>\n\n\n\n<p>可以通过file命令来看该软链接的文件本身是谁</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">file read_s.sh</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n","categories":["linux"],"tags":["linux"]},{"title":"文件系统命令","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"文件系统命令\"><a href=\"#文件系统命令\" class=\"headerlink\" title=\"文件系统命令\"></a>文件系统命令</h2><h3 id=\"df命令\"><a href=\"#df命令\" class=\"headerlink\" title=\"df命令\"></a>df命令</h3><p>查看分区存储情况，大小，使用率等</p>\n<p>df统计的剩余空间是准确的</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">df [选项]</span></span><br><span class=\"line\">df -h </span><br><span class=\"line\">---------------</span><br><span class=\"line\">-h  使用K或M或G为单位，显示文件系统</span><br><span class=\"line\">-T  显示文件系统类型</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"du命令\"><a href=\"#du命令\" class=\"headerlink\" title=\"du命令\"></a>du命令</h3><p>查看目录所占内存</p>\n<p>du统计的文件大小是准确的</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">du [选项] [目录]</span></span><br><span class=\"line\">du -hs /lib</span><br><span class=\"line\">-------------------</span><br><span class=\"line\">-a  显示每个子文件的磁盘占用量</span><br><span class=\"line\">-h  使用K或M或G为单位</span><br><span class=\"line\">-s  统计总占用量</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"dump2fs命令\"><a href=\"#dump2fs命令\" class=\"headerlink\" title=\"dump2fs命令\"></a>dump2fs命令</h3><p>显示磁盘状态</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">dump2fs [选项] [分区号]</span></span><br><span class=\"line\">dump2fs -h /dev/sda1</span><br><span class=\"line\"></span><br><span class=\"line\">-------------</span><br><span class=\"line\">-h 只查看超级块信息</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["linux"],"tags":["linux"]},{"title":"服务开机自启","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E6%9C%8D%E5%8A%A1%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/","content":"<h2 id=\"服务开机自启\"><a href=\"#服务开机自启\" class=\"headerlink\" title=\"服务开机自启\"></a>服务开机自启</h2><p>Centos有两种方式，一是修改/etc/rc.local文件，二是使用chkconfig来管理开机自启(chkconfig无法自启动源码包)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> /etc/init.d/目录下必须有启动脚本</span></span><br><span class=\"line\">ls /etc/init.d/httpd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 添加服务，以便让chkconfig指令管理它</span></span><br><span class=\"line\">chkconfig --add httpd</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 删除指定的服务，不再让chkconfig指令管理它</span></span><br><span class=\"line\">chkconfig --del httpd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置开机运行该服务，默认是设置2345等级开机运行服务</span></span><br><span class=\"line\">chkconfig httpd on</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 指定等级</span></span><br><span class=\"line\">chkconfig --level 35 httpd on</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置开机不运行服务</span></span><br><span class=\"line\">chkconfig httpd off           </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 列出所有被chkconfig管理的服务</span></span><br><span class=\"line\">chkconfig --list</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>等级</p>\n<ul>\n<li>等级0：关机</li>\n<li>等级1：单用户模式</li>\n<li>等级2：无网络连接的多用户命令行模式</li>\n<li>等级3：有网络连接的多用户命令行模式</li>\n<li>等级4：不可用</li>\n<li>等级5：带图形界面的多用户模式</li>\n<li>等级6：重启</li>\n</ul>\n","categories":["linux"],"tags":["linux"]},{"title":"环境变量","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/","content":"<h2 id=\"环境变量\"><a href=\"#环境变量\" class=\"headerlink\" title=\"环境变量\"></a>环境变量</h2><h3 id=\"环境变量的设置\"><a href=\"#环境变量的设置\" class=\"headerlink\" title=\"环境变量的设置\"></a>环境变量的设置</h3><p>使用export命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">export age=18</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"环境变量查询\"><a href=\"#环境变量查询\" class=\"headerlink\" title=\"环境变量查询\"></a>环境变量查询</h3><p>使用set可以查看所有变量，使用env只能查看环境变量</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">set</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">env</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"环境变量删除\"><a href=\"#环境变量删除\" class=\"headerlink\" title=\"环境变量删除\"></a>环境变量删除</h3><p>使用unset来删除环境变量</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">删除age环境变量</span></span><br><span class=\"line\">unset age</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"PATH变量\"><a href=\"#PATH变量\" class=\"headerlink\" title=\"PATH变量\"></a>PATH变量</h3><p>系统查找命令是查的PATH变量中所定义的路径</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">echo $PATH</span><br><span class=\"line\">/Users/zhanghe/.nvm/versions/node/v14.7.0/bin:/usr/local/Cellar/flume/1.9.0_1/libexec/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Users/zhanghe/Desktop/user/apache-maven-3.6.3/bin:/Users/zhanghe/Desktop/user/scala-2.13.3/bin</span><br></pre></td></tr></table></figure>\n\n<p>每一个路径使用”:”来分隔</p>\n<p>所以可以通过拼接PATH变量来使得命令变成系统命令</p>\n<h3 id=\"环境变量配置文件\"><a href=\"#环境变量配置文件\" class=\"headerlink\" title=\"环境变量配置文件\"></a>环境变量配置文件</h3><p>linux系统生效的配置文件有五个</p>\n<p>对所有用户生效</p>\n<ul>\n<li>/etc/profile</li>\n<li>/etc/profile.d/*.sh</li>\n<li>/etc/bashrc</li>\n</ul>\n<p>对当前用户生效</p>\n<ul>\n<li>~/.bash_profile</li>\n<li>~/.bashrc</li>\n</ul>\n<p>调用过程</p>\n<pre class=\"mermaid\">graph LR;\nA[\"/etc/profile\"]\nB[\"~/.bash_profile\"]\nC[\"~/.bashrc\"]\nD[\"/etc/bashrc\"]\nE[\"/etc/profile.d/*.sh\"]\nF[\"/etc/profile.d/lang.sh\"]\nG[\"/etc/sysconfig/il18\"]\nH[命令提示符]\nA-->B-->C-->D\nD-->H\nD-->E\nA-->E\nE-->F-->G</pre>\n\n\n\n<p>下面以配置java环境变量为例</p>\n<h4 id=\"配置java环境变量\"><a href=\"#配置java环境变量\" class=\"headerlink\" title=\"配置java环境变量\"></a>配置java环境变量</h4><p>找到用户根目录</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> -a是为了找到当前路径下的所有文件，包括隐藏文件</span></span><br><span class=\"line\">ls -a</span><br></pre></td></tr></table></figure>\n\n<p>找到.bash_profile，linux下使用.bash_profile来配置环境变量的</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim .bash_profile</span><br></pre></td></tr></table></figure>\n\n<p>编辑该文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">export PATH=$PATH:/java/jdk1.8/bin</span><br></pre></td></tr></table></figure>\n\n<p>linux多个路径之间使用冒号(:)来分隔，$PATH是用于引用之前的PATH变量值</p>\n<p>保存文件之后，执行该命令使PATH生效</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">source .bash_profile</span><br></pre></td></tr></table></figure>\n\n","categories":["linux"],"tags":["linux"]},{"title":"linux用户管理","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/","content":"<h2 id=\"linux用户管理\"><a href=\"#linux用户管理\" class=\"headerlink\" title=\"linux用户管理\"></a>linux用户管理</h2><h3 id=\"用户信息文件\"><a href=\"#用户信息文件\" class=\"headerlink\" title=\"用户信息文件\"></a>用户信息文件</h3><p>在linux中的/etc/passwd文件中保存着linux的所有用户信息</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class=\"line\">bin:x:1:1:bin:&#x2F;bin:&#x2F;sbin&#x2F;nologin</span><br><span class=\"line\">adm:x:3:4:adm:&#x2F;var&#x2F;adm:&#x2F;sbin&#x2F;nologin</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>以冒号分隔分为七列</p>\n<p>第一列为用户名</p>\n<p>第二列为密码标志  x表示有密码，密码存在/etc/shadow文件中</p>\n<p>第三列为用户ID  0是超级用户  1-499是系统用户  500-65535是普通用户</p>\n<p>第四列为组id  对应着/etc/group文件中的记录</p>\n<p>第五列为用户说明</p>\n<p>第六列为用户家目录</p>\n<p>第七列为登录shell</p>\n<h3 id=\"密码文件\"><a href=\"#密码文件\" class=\"headerlink\" title=\"密码文件\"></a>密码文件</h3><p>用户的密码存在/etc/shadow文件中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">bin:*:15980:0:99999:7:::</span><br><span class=\"line\">daemon:*:15980:0:99999:7:::</span><br><span class=\"line\">adm:*:15980:0:99999:7:::</span><br></pre></td></tr></table></figure>\n\n<p>以冒号分隔分为九列</p>\n<p>第一列  用户名</p>\n<p>第二列  加密后的密码</p>\n<p>第三列  密码最近修改时间 (距离1970年1月1日的天数)</p>\n<p>第四列  两次密码的修改间隔时间</p>\n<p>第五列  密码有效期</p>\n<p>第六列  密码到期前的警告时间</p>\n<p>第七列  密码到期后的宽限天数</p>\n<p>第八列  密码失效时间</p>\n<p>第九列  保留字段</p>\n<h3 id=\"组信息文件\"><a href=\"#组信息文件\" class=\"headerlink\" title=\"组信息文件\"></a>组信息文件</h3><p>组信息存在/etc/group文件中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">root:x:0:</span><br><span class=\"line\">bin:x:1:bin,daemon</span><br><span class=\"line\">daemon:x:2:bin,daemon</span><br></pre></td></tr></table></figure>\n\n<p>以冒号分隔分为四列</p>\n<p>第一列  组名</p>\n<p>第二列  组密码</p>\n<p>第三列  组ID</p>\n<p>第四列  此组中支持的其他用户</p>\n<h3 id=\"用户命令\"><a href=\"#用户命令\" class=\"headerlink\" title=\"用户命令\"></a>用户命令</h3><h4 id=\"添加用户\"><a href=\"#添加用户\" class=\"headerlink\" title=\"添加用户\"></a>添加用户</h4><p>添加用户使用useradd命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">useradd [option] 用户名</span><br><span class=\"line\"></span><br><span class=\"line\">  -c, --comment COMMENT         GECOS field of the new account  说明</span><br><span class=\"line\">  -d, --home-dir HOME_DIR       home directory of the new account  家目录</span><br><span class=\"line\">  -g, --gid GROUP               name or ID of the primary group of the new </span><br><span class=\"line\">                                account   初始组id或组名，默认是与用户名相同</span><br><span class=\"line\">  -G, --groups GROUPS           list of supplementary groups of the new</span><br><span class=\"line\">                                account   附加组</span><br><span class=\"line\">  -p, --password PASSWORD       encrypted password of the new account  密码</span><br><span class=\"line\">  -r, --system                  create a system account   创建一个系统用户</span><br><span class=\"line\">  -s, --shell SHELL             login shell of the new account  登录shell，默认是bin/bash</span><br><span class=\"line\">  -u, --uid UID                 user ID of the new account   用户id</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改用户信息\"><a href=\"#修改用户信息\" class=\"headerlink\" title=\"修改用户信息\"></a>修改用户信息</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">usermod [options] 用户名</span><br><span class=\"line\"></span><br><span class=\"line\">-c, --comment COMMENT         GECOS field of the new account  说明</span><br><span class=\"line\">  -d, --home-dir HOME_DIR       home directory of the new account  家目录</span><br><span class=\"line\">  -g, --gid GROUP               name or ID of the primary group of the new </span><br><span class=\"line\">                                account   初始组id或组名，默认是与用户名相同</span><br><span class=\"line\">  -G, --groups GROUPS           list of supplementary groups of the new</span><br><span class=\"line\">                                account   附加组</span><br><span class=\"line\">  -p, --password PASSWORD       encrypted password of the new account  密码</span><br><span class=\"line\">  -r, --system                  create a system account   创建一个系统用户</span><br><span class=\"line\">  -s, --shell SHELL             login shell of the new account  登录shell，默认是bin/bash</span><br><span class=\"line\">  -u, --uid UID                 user ID of the new account   用户id</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"删除用户\"><a href=\"#删除用户\" class=\"headerlink\" title=\"删除用户\"></a>删除用户</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">userdel [-r] 用户名</span><br><span class=\"line\"></span><br><span class=\"line\">-r 表示删除用户的同时删除家目录</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"切换用户\"><a href=\"#切换用户\" class=\"headerlink\" title=\"切换用户\"></a>切换用户</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">su - 用户名</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"密码设置修改\"><a href=\"#密码设置修改\" class=\"headerlink\" title=\"密码设置修改\"></a>密码设置修改</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">密码设置</span></span><br><span class=\"line\">passwd 用户名</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">对于普通用户来说，只可以修改当前用户密码，不需要指定用户名</span></span><br><span class=\"line\">passwd</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"组命令\"><a href=\"#组命令\" class=\"headerlink\" title=\"组命令\"></a>组命令</h3><h4 id=\"添加组\"><a href=\"#添加组\" class=\"headerlink\" title=\"添加组\"></a>添加组</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">groupadd 组名</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"删除组\"><a href=\"#删除组\" class=\"headerlink\" title=\"删除组\"></a>删除组</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">groupdel 组名</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"把用户加入组或者删除组\"><a href=\"#把用户加入组或者删除组\" class=\"headerlink\" title=\"把用户加入组或者删除组\"></a>把用户加入组或者删除组</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">gpasswd [options] 组名</span><br><span class=\"line\"></span><br><span class=\"line\">-a, --add USER                add USER to GROUP 把用户加入组</span><br><span class=\"line\">-d, --delete USER             remove USER from GROUP 把用户移出组</span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n\n","categories":["linux"],"tags":["linux"]},{"title":"linux目录操作命令","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E7%9B%AE%E5%BD%95%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"目录操作命令\"><a href=\"#目录操作命令\" class=\"headerlink\" title=\"目录操作命令\"></a>目录操作命令</h2><h3 id=\"文件列表\"><a href=\"#文件列表\" class=\"headerlink\" title=\"文件列表\"></a>文件列表</h3><p>ls命令文件列表</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">ls [选项] [参数]</span><br><span class=\"line\"></span><br><span class=\"line\">------------------------------</span><br><span class=\"line\">-l 详细信息</span><br><span class=\"line\">-a 所有文件，包含隐藏文件</span><br><span class=\"line\">-d 查看目录信息，而不是子目录信息</span><br><span class=\"line\">-h 人性化设置</span><br><span class=\"line\">-i 查看文件节点号</span><br><span class=\"line\"></span><br><span class=\"line\">多个参数可以拼接，且没有先后顺序</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"跳转转位置\"><a href=\"#跳转转位置\" class=\"headerlink\" title=\"跳转转位置\"></a>跳转转位置</h3><p>cd命令跳转位置</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd home</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建目录\"><a href=\"#创建目录\" class=\"headerlink\" title=\"创建目录\"></a>创建目录</h3><p>mkdir命令创建目录</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir test</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除目录\"><a href=\"#删除目录\" class=\"headerlink\" title=\"删除目录\"></a>删除目录</h3><p>rmdir命令删除目录</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">rmdir test</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"当前所在位置\"><a href=\"#当前所在位置\" class=\"headerlink\" title=\"当前所在位置\"></a>当前所在位置</h3><p>pwd命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">pwd</span><br></pre></td></tr></table></figure>\n\n","categories":["linux"],"tags":["linux"]},{"title":"linux目录结构","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84/","content":"<h2 id=\"linux目录结构\"><a href=\"#linux目录结构\" class=\"headerlink\" title=\"linux目录结构\"></a>linux目录结构</h2><table>\n<thead>\n<tr>\n<th><strong>存放命令目录</strong></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>/bin/、/usr/bin/</td>\n<td>是普通用户和超级用户都可以使用的命令，/bin/是usr/bin/目录的软链接</td>\n</tr>\n<tr>\n<td>/sbin/、/usr/sbin/</td>\n<td>是超级用户可以使用的命令，/sbin/是usr/sbin/目录的软链接</td>\n</tr>\n<tr>\n<td><strong>系统启动目录</strong></td>\n<td></td>\n</tr>\n<tr>\n<td>/boot/</td>\n<td>系统启动目录，保存与系统相关的文件，如内核文件和启动引导程序</td>\n</tr>\n<tr>\n<td><strong>硬件设备目录</strong></td>\n<td></td>\n</tr>\n<tr>\n<td>/dev/</td>\n<td>硬件设备文件目录</td>\n</tr>\n<tr>\n<td><strong>配置文件目录</strong></td>\n<td></td>\n</tr>\n<tr>\n<td>/etc/</td>\n<td>配置文件目录，系统内所有默认安装方式的服务配置文件都在此目录中</td>\n</tr>\n<tr>\n<td><strong>普通用户的家目录</strong></td>\n<td></td>\n</tr>\n<tr>\n<td>/home/</td>\n<td>home目录中有用户</td>\n</tr>\n<tr>\n<td><strong>函数库目录</strong></td>\n<td></td>\n</tr>\n<tr>\n<td>/lib/、/lib64/</td>\n<td>系统调用的函数库，lib64为64位的，分别是/usr/lib/和/usr/lib64/的软链接</td>\n</tr>\n<tr>\n<td><strong>备份恢复目录</strong></td>\n<td></td>\n</tr>\n<tr>\n<td>/lost+found/</td>\n<td>系统意外崩溃产生的一些文件碎片，当系统启动时fsck工具会自动扫描并修复</td>\n</tr>\n<tr>\n<td><strong>挂载目录</strong></td>\n<td></td>\n</tr>\n<tr>\n<td>/midea/</td>\n<td>挂光盘</td>\n</tr>\n<tr>\n<td>/misc/</td>\n<td>挂NFS服务</td>\n</tr>\n<tr>\n<td>/mnt/</td>\n<td>之前的挂载目录</td>\n</tr>\n<tr>\n<td><strong>第三方软件安装目录</strong></td>\n<td></td>\n</tr>\n<tr>\n<td>/opt/</td>\n<td></td>\n</tr>\n<tr>\n<td><strong>系统软件资源目录</strong></td>\n<td></td>\n</tr>\n<tr>\n<td>/usr/</td>\n<td></td>\n</tr>\n</tbody></table>\n","categories":["linux"],"tags":["linux"]},{"title":"系统安装","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85/","content":"<h2 id=\"系统安装\"><a href=\"#系统安装\" class=\"headerlink\" title=\"系统安装\"></a>系统安装</h2><h3 id=\"磁盘分区\"><a href=\"#磁盘分区\" class=\"headerlink\" title=\"磁盘分区\"></a>磁盘分区</h3><p>有两种形式的分区表</p>\n<h4 id=\"MBR分区表\"><a href=\"#MBR分区表\" class=\"headerlink\" title=\"MBR分区表\"></a>MBR分区表</h4><p>最大支持2.1T的硬盘，最多支持4个分区</p>\n<a id=\"more\"></a>\n\n<h5 id=\"分区类型\"><a href=\"#分区类型\" class=\"headerlink\" title=\"分区类型\"></a>分区类型</h5><ul>\n<li>主分区  最多有四个</li>\n<li>扩展分区<ul>\n<li>每块硬盘最多只能有一个</li>\n<li>主分区加扩展分区最多只能有4个</li>\n<li>不能写入数据，只能包含逻辑分区</li>\n</ul>\n</li>\n<li>逻辑分区</li>\n</ul>\n<h4 id=\"GPT分区表\"><a href=\"#GPT分区表\" class=\"headerlink\" title=\"GPT分区表\"></a>GPT分区表</h4><p>全局唯一标示分区表，支持9.4ZB硬盘，理论上支持的分区数没有限制，windows支持128个分区</p>\n<h3 id=\"格式化\"><a href=\"#格式化\" class=\"headerlink\" title=\"格式化\"></a>格式化</h3><p>格式化是为了写入文件系统，根据用户选定的文件系统(如FAT32、NTFS、EXT4、XFS等)，在磁盘的特定区域写入特定数据，在分区中划出一块用于文件分配表、目录表等用于文件管理的磁盘空间</p>\n<p>将磁盘分为两部分，一部分比较小，存放索引节点(INode)，每个INode128B；一部分比较大，用于存储数据块(block)，每个数据块默认4KB，block是存储数据的最小单位</p>\n<h3 id=\"挂载点\"><a href=\"#挂载点\" class=\"headerlink\" title=\"挂载点\"></a>挂载点</h3><p>linux的挂载点相当于windows的盘符，使用已经存在的空目录作为挂载点</p>\n<ol>\n<li>必须分区<ul>\n<li>/(根分区)</li>\n<li>swap(交换分区)</li>\n</ul>\n</li>\n<li>推荐分区<ul>\n<li>/boot(启动分区)</li>\n</ul>\n</li>\n<li>常用分区<ul>\n<li>/home(用于文件服务器)</li>\n<li>/www(用于web服务器)</li>\n</ul>\n</li>\n</ol>\n","categories":["linux"],"tags":["linux"]},{"title":"linux统计命令","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E7%BB%9F%E8%AE%A1%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"统计命令\"><a href=\"#统计命令\" class=\"headerlink\" title=\"统计命令\"></a>统计命令</h2><p>使用wc来进行统计</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> wc [选项] 文件名</span></span><br><span class=\"line\">wc -l a</span><br><span class=\"line\">       2 a</span><br><span class=\"line\">wc -w a</span><br><span class=\"line\">      8 a</span><br><span class=\"line\"></span><br><span class=\"line\">--------------</span><br><span class=\"line\">-l  统计行数</span><br><span class=\"line\">-w  统计单词数</span><br><span class=\"line\">-m  统计字符数</span><br></pre></td></tr></table></figure>\n\n","categories":["linux"],"tags":["linux"]},{"title":"linux网络命令","url":"/2021/linux/%E5%9F%BA%E7%A1%80/%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"网络命令\"><a href=\"#网络命令\" class=\"headerlink\" title=\"网络命令\"></a>网络命令</h2><h3 id=\"配置ip\"><a href=\"#配置ip\" class=\"headerlink\" title=\"配置ip\"></a>配置ip</h3><p>配置ip有两种方式</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">方式一</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">setup可以使用配置工具进行配置</span></span><br><span class=\"line\">setup</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">方式二</span></span><br><span class=\"line\">/etc/sysconfig/network-scripts</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>配置完之后重启网络服务</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">service network restart</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"查看ip信息\"><a href=\"#查看ip信息\" class=\"headerlink\" title=\"查看ip信息\"></a>查看ip信息</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">ifconfig</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ping\"><a href=\"#ping\" class=\"headerlink\" title=\"ping\"></a>ping</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">ping [选项] ip</span></span><br><span class=\"line\">ping www.baidu.com</span><br><span class=\"line\"></span><br><span class=\"line\">------------------------</span><br><span class=\"line\">-c 次数</span><br><span class=\"line\">-b 对ip段进行广播</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"netstat\"><a href=\"#netstat\" class=\"headerlink\" title=\"netstat\"></a>netstat</h3><p>查看网络状态，既可以查看本级开启端口，也可以查看有哪些客户端连接</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">netstat [选项]</span></span><br><span class=\"line\">netstat -tunl</span><br><span class=\"line\"></span><br><span class=\"line\">---------------------------</span><br><span class=\"line\">-a  列出网络状态</span><br><span class=\"line\">-c  每隔几秒刷新一次网络状态</span><br><span class=\"line\">-n  使用ip和端口号显示，不使用域名</span><br><span class=\"line\">-p  显示PID和程序名</span><br><span class=\"line\">-t  显示tcp协议连接状况</span><br><span class=\"line\">-u  显示udp协议连接状况</span><br><span class=\"line\">-l  仅显示监听状态的连接</span><br><span class=\"line\">-r  显示路由表</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["linux"],"tags":["linux"]},{"title":"定时任务","url":"/2021/linux/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/","content":"<h2 id=\"定时任务\"><a href=\"#定时任务\" class=\"headerlink\" title=\"定时任务\"></a>定时任务</h2><h3 id=\"at一次性执行定时任务\"><a href=\"#at一次性执行定时任务\" class=\"headerlink\" title=\"at一次性执行定时任务\"></a>at一次性执行定时任务</h3><p>依赖于atd服务</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">service atd start</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> at [选项] 时间</span></span><br><span class=\"line\">----------</span><br><span class=\"line\">-m  at工作完成后，使用email通知执行at命令的用户</span><br><span class=\"line\">-c 工作号  显示该at工作的实际内容</span><br><span class=\"line\"></span><br><span class=\"line\">时间格式</span><br><span class=\"line\">HH:MM</span><br><span class=\"line\">HH:MM YYYY-MM-DD</span><br><span class=\"line\">HH:MM[am|pm] [month] [date]</span><br><span class=\"line\">HH:MM[am|pm] + [minutes|hours|days|weeks]  </span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"crontab循环执行定时任务\"><a href=\"#crontab循环执行定时任务\" class=\"headerlink\" title=\"crontab循环执行定时任务\"></a>crontab循环执行定时任务</h3><p>由于at只能执行一次，所以使用的并不多，真正使用的多的是crontab执行定时任务</p>\n<p>依赖于crond服务</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">service crond start</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用命令执行定时任务\"><a href=\"#使用命令执行定时任务\" class=\"headerlink\" title=\"使用命令执行定时任务\"></a>使用命令执行定时任务</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">crontab [选项]</span></span><br><span class=\"line\"></span><br><span class=\"line\">----------</span><br><span class=\"line\">-e  编辑crontab定时任务</span><br><span class=\"line\">-l  查询crontab任务</span><br><span class=\"line\">-r  删除任务</span><br><span class=\"line\">-u 用户名  修改/删除其他用户的任务</span><br></pre></td></tr></table></figure>\n\n<p>时间表达式</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">* * * * *</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 第一位为分钟</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 第二位为小时</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 第三位为天</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 第四位为月</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 第五位为周几</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"使用配置文件设置定时任务\"><a href=\"#使用配置文件设置定时任务\" class=\"headerlink\" title=\"使用配置文件设置定时任务\"></a>使用配置文件设置定时任务</h4><p>在/etc/crontab配置文件中配置</p>\n","categories":["linux"],"tags":["linux"]},{"title":"后台运行命令","url":"/2021/linux/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8C%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"后台运行命令\"><a href=\"#后台运行命令\" class=\"headerlink\" title=\"后台运行命令\"></a>后台运行命令</h2><p>很多时候需要将命令放在后台执行，那么如何让命令在后台运行呢，只需要在命令后加上&amp;即可</p>\n<p>如：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">java -jar test.jar &amp;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>查看后台进程</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">-l 表示显示工作的PID</span></span><br><span class=\"line\">jobs [-l]</span><br></pre></td></tr></table></figure>\n\n<p>但是后台运行的命令在关闭终端之后就会终止，如何解决这个问题呢？</p>\n<ul>\n<li><p>使用定时任务，让系统执行该命令，这样该命令就与终端无关了，不依赖所登录的终端</p>\n</li>\n<li><p>使用nohup命令，使得后台命令在离开操作终端也可以正确的在后台执行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">nohup [命令] &amp;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n","categories":["linux"],"tags":["linux"]},{"title":"系统资源命令","url":"/2021/linux/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"系统资源命令\"><a href=\"#系统资源命令\" class=\"headerlink\" title=\"系统资源命令\"></a>系统资源命令</h2><h3 id=\"系统资源查看\"><a href=\"#系统资源查看\" class=\"headerlink\" title=\"系统资源查看\"></a>系统资源查看</h3><h4 id=\"vmstat命令\"><a href=\"#vmstat命令\" class=\"headerlink\" title=\"vmstat命令\"></a>vmstat命令</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">vmstat [刷新延时 刷新次数]</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 使用vmstat检测，每1秒刷新一次，一共刷新3次</span></span><br><span class=\"line\">vmstat 1 3</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/images/linux/vmstat%E5%91%BD%E4%BB%A4%E7%BB%93%E6%9E%9C.png\" alt=\"vmstat命令结果\"></p>\n<a id=\"more\"></a>\n\n<p>结果信息</p>\n<p><strong>procs</strong>   进程</p>\n<ul>\n<li>r  等待运行的进程数，数量越大，系统越繁忙</li>\n<li>b  不可唤醒的进程数，数量越大，系统越繁忙</li>\n</ul>\n<p>**memory ** 内存</p>\n<ul>\n<li>swpd   虚拟内存的使用情况，单位kb</li>\n<li>free      空闲的内存容量，单位kb</li>\n<li>buff      缓冲的内存容量，单位kb</li>\n<li>cache   缓存的内存容量，单位kb</li>\n</ul>\n<p><strong>swap</strong>  交换分区，这两个数越大，说明数据经常在内存和磁盘中交换，性能较差</p>\n<ul>\n<li>si   从磁盘中交换到内存中的数据的容量</li>\n<li>so  从内存中交换到磁盘中的数量</li>\n</ul>\n<p>**io **  磁盘IO，这两个数越大，代表磁盘IO越繁忙</p>\n<ul>\n<li>bi   从块设备读入数据的总量</li>\n<li>bo  写入块设备的数据的总量</li>\n</ul>\n<p><strong>system</strong>  系统信息，这两个数越大，表示系统与接口设备的通信越繁忙</p>\n<ul>\n<li>in   每秒被中断的进程次数</li>\n<li>cs  每秒进行事件切换次数</li>\n</ul>\n<p><strong>cpu</strong>  CPU信息</p>\n<ul>\n<li>us   非内核进程消耗CPU运算时间的百分比</li>\n<li>sy   内核进程消耗CPU运算时间的百分比</li>\n<li>id    空闲CPU的百分比</li>\n<li>wa  等待IO所消耗的CPU百分比</li>\n<li>st    被虚拟机所盗用的CPU占比</li>\n</ul>\n<h3 id=\"free命令\"><a href=\"#free命令\" class=\"headerlink\" title=\"free命令\"></a>free命令</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">free</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/images/linux/free%E5%91%BD%E4%BB%A4%E7%BB%93%E6%9E%9C.png\" alt=\"free命令结果\"></p>\n<p>第一行是内存信息：total表示总内存数，used表示已经使用的，free表示空闲的，shared表示多个进程共享的，buffers表示缓冲内存数，cached表示缓存内存数</p>\n<p>第二行是缓冲缓存信息：-/buffers/cache 相当于 used-buffers-cached，+/buffers/cache 相当于 free+buffers+cached</p>\n<p>第三行是分区信息：total是swap的总数，used是已经使用的，free是空闲的</p>\n<h3 id=\"查看CPU-内存信息\"><a href=\"#查看CPU-内存信息\" class=\"headerlink\" title=\"查看CPU/内存信息\"></a>查看CPU/内存信息</h3><p>在/proc文件夹中有cpuinfo/meminfo可以查看CPU/内存信息</p>\n","categories":["linux"],"tags":["linux"]},{"title":"进程管理命令","url":"/2021/linux/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"进程管理命令\"><a href=\"#进程管理命令\" class=\"headerlink\" title=\"进程管理命令\"></a>进程管理命令</h2><h3 id=\"查看进程命令\"><a href=\"#查看进程命令\" class=\"headerlink\" title=\"查看进程命令\"></a>查看进程命令</h3><h4 id=\"ps命令\"><a href=\"#ps命令\" class=\"headerlink\" title=\"ps命令\"></a>ps命令</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看系统中所有正在运行的系统</span></span><br><span class=\"line\">ps aux</span><br><span class=\"line\"></span><br><span class=\"line\">------------</span><br><span class=\"line\">a  显示一个终端的所有进程，除了会话引线</span><br><span class=\"line\">u  显示进程的归属用户及内存的使用情况</span><br><span class=\"line\">x  显示没有控制终端的进程</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>显示的内容</p>\n<p><img src=\"/images/linux/ps%E5%91%BD%E4%BB%A4%E7%BB%93%E6%9E%9C.png\" alt=\"ps命令结果\"></p>\n<ul>\n<li>USER    哪个用户产生的</li>\n<li>PID        进程的ID号</li>\n<li>%CPU   该进程占用CPU资源的百分比</li>\n<li>%MEM  该进程占用物理内存的百分比</li>\n<li>VSZ        该进程占用虚拟内存的大小，单位KB</li>\n<li>RSS        该进程占用实际物理内存的大小，单位KB</li>\n<li>TTY         该进程是在哪个终端中运行的。tty1-tty7代表本地控制台终端，tty1-tty6是本地字符界面终端，tty7是图形终端。pts/0-255代表虚拟终端，一般是远程连接的终端，第一个远程连接占用的是pts/0终端，依次递增，?表示由内核直接启动的，是系统进程</li>\n<li>STAT        进程状态。<ul>\n<li>D表示不可唤醒的睡眠状态，通常用于I/O情况</li>\n<li>R表示进程正在进行</li>\n<li>S表示进程在睡眠状态，可被唤醒</li>\n<li>T表示停止状态，可能是在后台暂停或进程在出错状态</li>\n<li>W表示内存交互状态</li>\n<li>X表示死掉的进程</li>\n<li>Z表示僵尸进程。进程已经终止，但是部分程序还在内存当中</li>\n<li>&lt;表示高优先级</li>\n<li>N表示低优先级</li>\n<li>L表示被锁入内存</li>\n<li>s表示饱汉子进程</li>\n<li>l表示多线程</li>\n<li>+表示位于后台</li>\n</ul>\n</li>\n<li>START   该进程的启动时间</li>\n<li>TIME      该进程占用CPU的运算时间</li>\n<li>COMMAND  产生此进程的命令</li>\n</ul>\n<h4 id=\"top命令\"><a href=\"#top命令\" class=\"headerlink\" title=\"top命令\"></a>top命令</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">top -p  1298</span><br><span class=\"line\"></span><br><span class=\"line\">-------</span><br><span class=\"line\">选项</span><br><span class=\"line\">-p  只查看某个PID</span><br><span class=\"line\">-b  把数据可以写入文件</span><br><span class=\"line\">-n  刷新几次</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">------</span><br><span class=\"line\">交互选项</span><br><span class=\"line\">P  按照CPU排序，默认</span><br><span class=\"line\">M  按照内存使用率排序</span><br><span class=\"line\">N  按照PID排序</span><br><span class=\"line\">q  退出top命令</span><br></pre></td></tr></table></figure>\n\n<p>显示的内容</p>\n<p><img src=\"/images/linux/top%E5%91%BD%E4%BB%A4%E7%BB%93%E6%9E%9C.png\" alt=\"top命令结果\"></p>\n<h4 id=\"pstree命令\"><a href=\"#pstree命令\" class=\"headerlink\" title=\"pstree命令\"></a>pstree命令</h4><p>可以查看到依赖关系</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">pstree</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"杀死进程命令\"><a href=\"#杀死进程命令\" class=\"headerlink\" title=\"杀死进程命令\"></a>杀死进程命令</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kill -9 pid</span><br></pre></td></tr></table></figure>\n\n","categories":["linux"],"tags":["linux"]},{"title":"DOM解析","url":"/2020/xml/DOM/DOM%E8%A7%A3%E6%9E%90/","content":"<h2 id=\"DOM解析\"><a href=\"#DOM解析\" class=\"headerlink\" title=\"DOM解析\"></a>DOM解析</h2><h3 id=\"DOM解析介绍\"><a href=\"#DOM解析介绍\" class=\"headerlink\" title=\"DOM解析介绍\"></a>DOM解析介绍</h3><p>DOM是基于属性结构的XML解析方式，会将整个XML文档读入内存并构建一个DOM树，基于这棵树型结构对各个节点进行操作。XML文档中每个成分都是一个节点，<a id=\"more\"></a>整个文档是一个文档节点，每个XML标签对应一个元素节点，包含在XML标签中的文本是文本节点，每一个XML属性是一个属性节点，注释属于注释节点。</p>\n<p>DOM树所提供的随机访问方式很灵活方便，可以任意地控制整个XML文档中的内容，但是DOM分析器把整个XML文件转化为DOM树放到了内存中，当文档比较大或者结构比较复杂时，对内存需求比较高。</p>\n<h3 id=\"DOM解析示例\"><a href=\"#DOM解析示例\" class=\"headerlink\" title=\"DOM解析示例\"></a>DOM解析示例</h3><h4 id=\"xml文件示例\"><a href=\"#xml文件示例\" class=\"headerlink\" title=\"xml文件示例\"></a>xml文件示例</h4><p>下面以mybatis的一个mapper.xml为例讲解各个方法</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">mapper</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-keyword\">PUBLIC</span> <span class=\"meta-string\">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mapper</span> <span class=\"attr\">namespace</span>=<span class=\"string\">&quot;org.apache.ibatis.submitted.rounding.Mapper&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;org.apache.ibatis.submitted.rounding.User&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;usermap&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;funkyNumber&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;funkyNumber&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;roundingMode&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;roundingMode&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getUser&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;usermap&quot;</span>&gt;</span></span><br><span class=\"line\">        select * from users</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">insert</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;insert&quot;</span>&gt;</span></span><br><span class=\"line\">        insert into users (id, name, funkyNumber, roundingMode) values (</span><br><span class=\"line\">            #&#123;id&#125;, #&#123;name&#125;, #&#123;funkyNumber&#125;, #&#123;roundingMode&#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">insert</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;org.apache.ibatis.submitted.rounding.User&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;usermap2&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;funkyNumber&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;funkyNumber&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;roundingMode&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;roundingMode&quot;</span> <span class=\"attr\">typeHandler</span>=<span class=\"string\">&quot;org.apache.ibatis.type.EnumTypeHandler&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getUser2&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;usermap2&quot;</span>&gt;</span></span><br><span class=\"line\">        select * from users2</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">insert</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;insert2&quot;</span>&gt;</span></span><br><span class=\"line\">        insert into users2 (id, name, funkyNumber, roundingMode) values (</span><br><span class=\"line\">            #&#123;id&#125;, #&#123;name&#125;, #&#123;funkyNumber&#125;, #&#123;roundingMode, typeHandler=org.apache.ibatis.type.EnumTypeHandler&#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">insert</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"DOM接口介绍\"><a href=\"#DOM接口介绍\" class=\"headerlink\" title=\"DOM接口介绍\"></a>DOM接口介绍</h4><p>介绍一下DOM解析中的核心接口</p>\n<ul>\n<li>Document：代表了整个XML文档，表示整棵DOM树的根，常用方法<ul>\n<li>public NodeList getElementsByTagName(String tagname); 取得指定节点名称的NodeList</li>\n<li>public Element createElement(String tagName)  创建一个指定名称的节点</li>\n<li>public Text createTextNode(String data)  创建一个文本内容节点</li>\n<li>public Attr createAttribute(String name)  创建一个属性</li>\n</ul>\n</li>\n<li>NodeList： 表示一个节点的集合<ul>\n<li>public int getLength();  取得节点的个数</li>\n<li>public Node item(int index);  根据索引取得节点对象</li>\n</ul>\n</li>\n<li>Node：每一个Node代表了DOM树中的一个节点<ul>\n<li>public Node appendChild(Node newChild)  在当前节点下增加一个新的节点</li>\n<li>public NodeList getChildNodes()  得到本节点下的全部子节点</li>\n<li>public Node getFirstChild()  得到本节点下的第一个子节点</li>\n<li>public Node getLastChild()  得到本节点下最后一个子节点</li>\n<li>public boolean hasChildNodes()  判断是否还有其他节点</li>\n<li>public boolean hasAttributes()  判断是否还有其他属性</li>\n<li>public String getNodeValue()  获取节点内容</li>\n</ul>\n</li>\n<li>NamedNodeMap：表示一组节点和其唯一名称对应的一一对应关系，主要用于属性节点的表示</li>\n</ul>\n<h4 id=\"方法使用示例\"><a href=\"#方法使用示例\" class=\"headerlink\" title=\"方法使用示例\"></a>方法使用示例</h4><h5 id=\"将xml文件转为dom树\"><a href=\"#将xml文件转为dom树\" class=\"headerlink\" title=\"将xml文件转为dom树\"></a>将xml文件转为dom树</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Document <span class=\"title\">getDefaultDocument</span><span class=\"params\">(File file)</span> <span class=\"keyword\">throws</span> ParserConfigurationException, IOException, SAXException </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 创建DocumentBuilderFactory，用于取得DocumentBuilder</span></span><br><span class=\"line\">    DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class=\"line\">    DocumentBuilder builder = factory.newDocumentBuilder();</span><br><span class=\"line\">      <span class=\"comment\">// 使用DocumentBuilder进行DOM树的转换操作，读取指定的xml文件</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> builder.parse(file);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"操作dom树读取节点内容\"><a href=\"#操作dom树读取节点内容\" class=\"headerlink\" title=\"操作dom树读取节点内容\"></a>操作dom树读取节点内容</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取mapper节点</span></span><br><span class=\"line\">NodeList mapperList = document.getElementsByTagName(<span class=\"string\">&quot;mapper&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;i&lt;mapperList.getLength();i++)&#123;</span><br><span class=\"line\">  Node mapperNode = mapperList.item(i);</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(mapperNode.hasAttributes())&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 找到mapper节点的namespace属性节点</span></span><br><span class=\"line\">    Node namespace = mapperNode.getAttributes().getNamedItem(<span class=\"string\">&quot;namespace&quot;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// namespace属性节点内容</span></span><br><span class=\"line\">    System.out.println(namespace.getNodeValue());</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(mapperNode.hasChildNodes())&#123;</span><br><span class=\"line\">    <span class=\"comment\">// mapper节点的子节点</span></span><br><span class=\"line\">    NodeList childNodes = mapperNode.getChildNodes();</span><br><span class=\"line\">    <span class=\"comment\">// 遍历子节点</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> j = <span class=\"number\">0</span>;j&lt;childNodes.getLength();j++)&#123;</span><br><span class=\"line\">      Node childNode = childNodes.item(j);</span><br><span class=\"line\">      <span class=\"keyword\">if</span>(<span class=\"string\">&quot;resultMap&quot;</span>.equals(childNode.getNodeName()))&#123;</span><br><span class=\"line\">        <span class=\"comment\">//TODO</span></span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"string\">&quot;select&quot;</span>.equals(childNode.getNodeName()))&#123;</span><br><span class=\"line\">        <span class=\"comment\">//TODO</span></span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"string\">&quot;insert&quot;</span>.equals(childNode.getNodeName()))&#123;</span><br><span class=\"line\">        <span class=\"comment\">//TODO</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"创建dom节点\"><a href=\"#创建dom节点\" class=\"headerlink\" title=\"创建dom节点\"></a>创建dom节点</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 创建test节点作为根节点</span></span><br><span class=\"line\">Element root = document.createElement(<span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 创建type属性</span></span><br><span class=\"line\">Attr type = document.createAttribute(<span class=\"string\">&quot;type&quot;</span>);</span><br><span class=\"line\">type.setNodeValue(<span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 创建id节点</span></span><br><span class=\"line\">Element id = document.createElement(<span class=\"string\">&quot;id&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 创建文本节点，并放到id节点中</span></span><br><span class=\"line\">id.appendChild(document.createTextNode(<span class=\"string\">&quot;001&quot;</span>));</span><br><span class=\"line\"><span class=\"comment\">// 创建name节点</span></span><br><span class=\"line\">Element name = document.createElement(<span class=\"string\">&quot;name&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 创建文本节点，并放到name节点中</span></span><br><span class=\"line\">name.appendChild(document.createTextNode(<span class=\"string\">&quot;张三&quot;</span>));</span><br><span class=\"line\"><span class=\"comment\">// 设置属性节点</span></span><br><span class=\"line\">root.setAttributeNode(type);</span><br><span class=\"line\"><span class=\"comment\">// 将节点放入父节点中</span></span><br><span class=\"line\">root.appendChild(id);</span><br><span class=\"line\">root.appendChild(name);</span><br><span class=\"line\">document.appendChild(root);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"DOM持久化\"><a href=\"#DOM持久化\" class=\"headerlink\" title=\"DOM持久化\"></a>DOM持久化</h3><p>将生成的xml保存到文件中，需要使用TransformerFactory、Transformer、DOMSource和StreamResult四个类来完成</p>\n<h4 id=\"类介绍\"><a href=\"#类介绍\" class=\"headerlink\" title=\"类介绍\"></a>类介绍</h4><ul>\n<li>TransformerFactory 取得一个Transformer对象</li>\n<li>DOMSource  接收Document对象</li>\n<li>StreamResult   指定要使用的输出流对象(可以向文件输出，也可以指定其他输出流)</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">TransformerFactory factory = TransformerFactory.newInstance();</span><br><span class=\"line\">Transformer transformer;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    transformer = factory.newTransformer();</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;创建Transformer失败&quot;</span>,e);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 设置xml属性 只设置了version和ecoding  还需要设置其他属性可以从OutputKeys中查找</span></span><br><span class=\"line\">transformer.setOutputProperty(OutputKeys.VERSION,<span class=\"string\">&quot;1.0&quot;</span>);</span><br><span class=\"line\">transformer.setOutputProperty(OutputKeys.ENCODING,<span class=\"string\">&quot;UTF-8&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// dom数据源</span></span><br><span class=\"line\">DOMSource source = <span class=\"keyword\">new</span> DOMSource(document);</span><br><span class=\"line\"><span class=\"comment\">// 目的地</span></span><br><span class=\"line\">StreamResult result = <span class=\"keyword\">new</span> StreamResult(<span class=\"keyword\">new</span> File(fileName));</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 进行转换</span></span><br><span class=\"line\">    transformer.transform(source,result);</span><br><span class=\"line\">&#125; <span class=\"keyword\">catch</span> (TransformerException e) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;输出文件错误&quot;</span>,e);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析器自定义设置方法介绍\"><a href=\"#解析器自定义设置方法介绍\" class=\"headerlink\" title=\"解析器自定义设置方法介绍\"></a>解析器自定义设置方法介绍</h3><p>下面介绍一些DocumentBuilderFactory中用来设置解析器行为的一些配置可能会用到的方法，但是就不写代码示例了</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 该方法指定解析器是否将CDATA节点转换为文本节点，以及是否将它和周围的文本节点合并，默认false</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setCoalescing</span><span class=\"params\">(<span class=\"keyword\">boolean</span> coalescing)</span></span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// 指定解析器是否展开外部实体引用，如果为true，外部数据将插入文档，默认true</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setExpandEntityReferences</span><span class=\"params\">(<span class=\"keyword\">boolean</span> expandEntityRef)</span></span></span><br><span class=\"line\"><span class=\"function\"> </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// 指定解析器是否忽略文档中的注释。默认false</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setIgnoringComments</span><span class=\"params\">(<span class=\"keyword\">boolean</span> ignoreComments)</span></span></span><br><span class=\"line\"><span class=\"function\">  </span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// 指定是否忽略元素内容中的空白。默认false</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setIgnoringElementContentWhitespace</span><span class=\"params\">(<span class=\"keyword\">boolean</span> whitespace)</span> </span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// 指定是否支持XML的名称空间。默认false</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setNamespaceAware</span><span class=\"params\">(<span class=\"keyword\">boolean</span> awareness)</span></span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"comment\">// 是否验证文档，默认false</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setValidating</span><span class=\"params\">(<span class=\"keyword\">boolean</span> validating)</span></span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"DOM解析的优缺点\"><a href=\"#DOM解析的优缺点\" class=\"headerlink\" title=\"DOM解析的优缺点\"></a>DOM解析的优缺点</h3><ul>\n<li>优点：可以根据需求在树形结构的各节点之间导航，轻易获取到所要的数据，也可以很容易地添加和修改树中的元素。</li>\n<li>缺点： 需要将整个XML加载到内存中并构造树形结构，当XML文档的数据量较大时，会造成较大的内存消耗。</li>\n</ul>\n","categories":["xml"],"tags":["xml"]},{"title":"SAX解析","url":"/2020/xml/SAX/SAX%E8%A7%A3%E6%9E%90/","content":"<h2 id=\"SAX解析\"><a href=\"#SAX解析\" class=\"headerlink\" title=\"SAX解析\"></a>SAX解析</h2><h3 id=\"SAX解析介绍\"><a href=\"#SAX解析介绍\" class=\"headerlink\" title=\"SAX解析介绍\"></a>SAX解析介绍</h3><p>由于DOM解析XML的弊端,一种替代的技术就是使用SAX解析。</p>\n<p>SAX是基于事件模型的XML解析方式，不需要将整个XML文档加载到内存中，只需加载一部分即可开始解析，在处理过程中不会在内存中记录XML中的数据，占用的资源比较少，当程序处理满足一定条件时，可以立即停止解析，这样不必解析剩余的XML内容。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"SAX处理机制\"><a href=\"#SAX处理机制\" class=\"headerlink\" title=\"SAX处理机制\"></a>SAX处理机制</h3><p>SAX解析主要涉及两个部分：解析器和事件处理器。解析器负责读取XML文档，并向事件处理器发送事件，如元素开始和结束事件；事件处理器则负责对事件做出响应，对传递的XML数据进行处理。</p>\n<p>当SAX解析器解析到某类型节点时，会触发注册在该类型节点上的回调函数，继承SAX提供的DefaultHandler来重写相应事件的处理方法并进行注册即可。(事件是由解析器产生并通过回调函数发送给应用程序的，这种模式称为推模式)。</p>\n<ul>\n<li><input disabled type=\"checkbox\"> 实现待写</li>\n</ul>\n<h3 id=\"SAX的缺点\"><a href=\"#SAX的缺点\" class=\"headerlink\" title=\"SAX的缺点\"></a>SAX的缺点</h3><ul>\n<li>由于不存储XML文档结构，需要开发人员自己负责维护多层节点之间的关系</li>\n<li>由于是流式处理，只能单向处理，无法回到之前处理过的节点</li>\n<li>不提供写文档的功能</li>\n</ul>\n","categories":["xml"],"tags":["xml"]},{"title":"StAX解析","url":"/2020/xml/StAX/StAX%E8%A7%A3%E6%9E%90/","content":"<h2 id=\"StAX解析\"><a href=\"#StAX解析\" class=\"headerlink\" title=\"StAX解析\"></a>StAX解析</h2><h3 id=\"StAX解析介绍\"><a href=\"#StAX解析介绍\" class=\"headerlink\" title=\"StAX解析介绍\"></a>StAX解析介绍</h3><p>StAX解析与SAX解析类似，也是基于事件驱动的，不同之处在于StAX采用的是拉模式，应用程序通过调用解析器推进解析的进程，可以调用next()方法来获取下一个解析事件(开始文档，结束文档，开始标签，结束标签)，当处于某个元素时可以调用XmlPullParser的getAttribute()方法来获取属性的值，也可以调用nextText()获取本节点的值。</p>\n<a id=\"more\"></a>\n\n<p>应用程序控制着整个解析过程的推进，可以简化应用处理XML文档的代码，并且决定何时停止解析，而且可以同时处理多个XML文档。</p>\n","categories":["xml"],"tags":["xml"]},{"title":"Ajax","url":"/2020/%E5%89%8D%E7%AB%AF/AJAX/Ajax/","content":"<h2 id=\"Ajax\"><a href=\"#Ajax\" class=\"headerlink\" title=\"Ajax\"></a>Ajax</h2><p>Ajax(Asynchronous JavaScript and XML)，是指一种创建交互式、快速动态<a href=\"https://baike.baidu.com/item/%E7%BD%91%E9%A1%B5/99347\">网页</a>应用的网页开发技术，无需重新加载整个网页的情况下，能够更新部分网页的技术。</p>\n<a id=\"more\"></a>\n\n<p>使用XMLHttpRequest对象来进行Ajax交互，该对象是对JavaScript的一个扩展，可以使网页与服务器进行通信。</p>\n<h3 id=\"XMLHttpRequest\"><a href=\"#XMLHttpRequest\" class=\"headerlink\" title=\"XMLHttpRequest\"></a>XMLHttpRequest</h3><p>创建XMLHttpRequest对象</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</span><br></pre></td></tr></table></figure>\n\n<p>常用的方法</p>\n<ul>\n<li>open(method,url)   建立对服务器的调用。method可以是GET/POST/PUT</li>\n<li>send(content)  向服务器发送请求</li>\n<li>sendRequestHeader(header,value)  设置请求头</li>\n<li>onreadystatechange  每个状态改变都会触发这个事件处理器</li>\n<li>readyState   请求的状态，有5个取值  0-&gt;未初始化，1-&gt;正在加载，2-&gt;已经加载，3-&gt;交互中，4-&gt;完成</li>\n<li>responseText   服务器的响应，表示为字符串</li>\n<li>responseXML   服务器的响应，表示为XML</li>\n<li>status    服务器的HTTP状态码</li>\n<li>statusText   HTTP状态码的相应文本</li>\n</ul>\n<p>发送GET请求</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</span><br><span class=\"line\"><span class=\"keyword\">var</span> url = <span class=\"string\">&quot;http://localhost:8080/test.html&quot;</span>;</span><br><span class=\"line\">xhr.open(<span class=\"string\">&quot;GET&quot;</span>,url);</span><br><span class=\"line\">xhr.send();</span><br><span class=\"line\">xhr.onreadystatechange = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span>(xhr.readyState == <span class=\"number\">4</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(xhr.status == <span class=\"number\">200</span>)&#123;</span><br><span class=\"line\">      alert(xhr.responseText);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"JS中使用JSON\"><a href=\"#JS中使用JSON\" class=\"headerlink\" title=\"JS中使用JSON\"></a>JS中使用JSON</h3><figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 直接创建json对象</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> json = &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;name&quot;</span>:<span class=\"string\">&quot;张三&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">alert(json.name);</span><br></pre></td></tr></table></figure>\n\n<p>如果为json字符串是无法进行直接解析的，可以使用eval来进行解析</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> json1 = <span class=\"string\">&quot;&#123;&#x27;name&#x27;:&#x27;李四&#x27;&#125;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">alert(<span class=\"built_in\">eval</span>(<span class=\"string\">&quot;(&quot;</span>+json1+<span class=\"string\">&quot;)&quot;</span>).name);</span><br></pre></td></tr></table></figure>\n\n<p>加上()是由于json是以”{}”的方式来开始以及结束的，在JS中，它会被当成一个语句块来处理，所以必须强制性的将它转换成一种表达式。</p>\n<p>加上圆括号的目的是迫使eval函数在处理JavaScript代码的时候强制将括号内的表达式转化为对象，而不是作为语句来执行。</p>\n<h3 id=\"jquery中使用ajax\"><a href=\"#jquery中使用ajax\" class=\"headerlink\" title=\"jquery中使用ajax\"></a>jquery中使用ajax</h3><h4 id=\"load\"><a href=\"#load\" class=\"headerlink\" title=\"load\"></a>load</h4><p>load()方法是jquery中最为简单的ajax方法，能载入远程HTML代码并插入到DOM中</p>\n<p>参数</p>\n<ul>\n<li>url    地址</li>\n<li>data(可选)   发送到服务器的数据</li>\n<li>callback(可选)   请求完成时的回调函数</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">$(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> url = <span class=\"string\">&quot;http://localhost:8080/test.html&quot;</span>;</span><br><span class=\"line\">      <span class=\"comment\">// 会直接将该html插入到#content元素中</span></span><br><span class=\"line\">    $(<span class=\"string\">&quot;#content&quot;</span>).load(url);</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"get或post\"><a href=\"#get或post\" class=\"headerlink\" title=\"get或post\"></a>get或post</h4><p>使用get或post方法时，需要自已编写回调函数来处理数据</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> args = &#123;<span class=\"string\">&quot;date&quot;</span>:<span class=\"keyword\">new</span> <span class=\"built_in\">Date</span>()&#125;</span><br><span class=\"line\">$.post(url,args,<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> name = data.person.name;</span><br><span class=\"line\">&#125;,<span class=\"string\">&quot;JSON&quot;</span>)</span><br></pre></td></tr></table></figure>","categories":["Ajax"],"tags":["Ajax"]},{"title":"DOM操作","url":"/2020/%E5%89%8D%E7%AB%AF/JS/DOM%E6%93%8D%E4%BD%9C/","content":"<h2 id=\"DOM操作\"><a href=\"#DOM操作\" class=\"headerlink\" title=\"DOM操作\"></a>DOM操作</h2><h3 id=\"节点类型\"><a href=\"#节点类型\" class=\"headerlink\" title=\"节点类型\"></a>节点类型</h3><figure class=\"highlight html\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">p</span> <span class=\"attr\">title</span>=<span class=\"string\">&quot;remark&quot;</span>&gt;</span>备注<span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>节点分为三个类型</p>\n<a id=\"more\"></a>\n\n<ul>\n<li>元素节点   如上述html中的p标签</li>\n<li>属性节点   如上述html中的title属性，元素节点的属性</li>\n<li>文本节点   如上述html中的 备注，元素节点的子节点</li>\n</ul>\n<h3 id=\"文档加载顺序\"><a href=\"#文档加载顺序\" class=\"headerlink\" title=\"文档加载顺序\"></a>文档加载顺序</h3><p>html的文档是按照顺序进行加载的，如果将js写在<head>中，获取</head><body>中节点时会获取不到，使用两种方式来解决这种情况</body></p>\n<p>第一种方式：在<html>之后编写<script></p>\n<p>第二种方式：在<script>中使用window.onload来加载html文档，加载完之后再去获取html中的元素节点就可以获取到</p>\n<h3 id=\"获取节点\"><a href=\"#获取节点\" class=\"headerlink\" title=\"获取节点\"></a>获取节点</h3><h4 id=\"获取元素节点\"><a href=\"#获取元素节点\" class=\"headerlink\" title=\"获取元素节点\"></a>获取元素节点</h4><p><strong>获取id为content的节点，html中需要确保id值唯一</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> content = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">&quot;content&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>获取li节点，使用标签名获取节点的集合</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> liNodes = <span class=\"built_in\">document</span>.getElementsByTagName(<span class=\"string\">&quot;li&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<p>属于node的方法，可以使用任何节点来调用该方法</p>\n<figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> content = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">&quot;content&quot;</span>);</span><br><span class=\"line\"><span class=\"keyword\">var</span> liNodes = content.getElementsByTagName(<span class=\"string\">&quot;li&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<p><strong>根据元素的name属性获取指定的节点集合</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> genders = <span class=\"built_in\">document</span>.getElementsByName(<span class=\"string\">&quot;gender&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"操作属性节点\"><a href=\"#操作属性节点\" class=\"headerlink\" title=\"操作属性节点\"></a>操作属性节点</h4><p>通过元素节点 . 的当时来获取和设置</p>\n<figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取元素节点</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> nameNode = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">&quot;name&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 读取属性的值</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> value = nameNode.value;</span><br><span class=\"line\"><span class=\"comment\">// 设置指定的属性值</span></span><br><span class=\"line\">nameNode.value = <span class=\"string\">&quot;你好&quot;</span>;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取元素节点的子节点\"><a href=\"#获取元素节点的子节点\" class=\"headerlink\" title=\"获取元素节点的子节点\"></a>获取元素节点的子节点</h4><figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 获取city节点</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> city = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">&quot;city&quot;</span>);</span><br><span class=\"line\">  <span class=\"comment\">// 获取city节点的所有li子节点</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> cityLiNode = city.getElementsByTagName(<span class=\"string\">&quot;li&quot;</span>);</span><br><span class=\"line\">  alert(cityLiNode.length);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"节点的属性\"><a href=\"#节点的属性\" class=\"headerlink\" title=\"节点的属性\"></a>节点的属性</h3><p>所有的节点都包含有nodeType、nodeName、nodeValue</p>\n<figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 元素节点</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> elementNode = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">&quot;bj&quot;</span>);</span><br><span class=\"line\">alert(elementNode.nodeType);  <span class=\"comment\">// 元素节点:1</span></span><br><span class=\"line\">alert(elementNode.nodeName);  <span class=\"comment\">// 节点名：li</span></span><br><span class=\"line\">alert(elementNode.nodeValue); <span class=\"comment\">// 元素节点没有nodeValue属性值：null</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 属性节点</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> attributeNode = elementNode.getAttributeNode(<span class=\"string\">&quot;name&quot;</span>);</span><br><span class=\"line\">alert(attributeNode.nodeType); <span class=\"comment\">//属性节点：2</span></span><br><span class=\"line\">alert(attributeNode.nodeName); <span class=\"comment\">// 属性节点的节点名：属性名</span></span><br><span class=\"line\">alert(attributeNode.nodeValue); <span class=\"comment\">// 属性节点的nodeValue属性值 ： 属性值</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 文本节点</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> textNode = elementNode.firstChild;</span><br><span class=\"line\">alert(textNode.nodeType); <span class=\"comment\">//文本节点：3</span></span><br><span class=\"line\">alert(textNode.nodeName); <span class=\"comment\">// 文本节点的nodeName：#text</span></span><br><span class=\"line\">alert(textNode.nodeValue); <span class=\"comment\">// 属性节点的nodeValue ：文本值</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建节点\"><a href=\"#创建节点\" class=\"headerlink\" title=\"创建节点\"></a>创建节点</h3><figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 新创建一个元素节点</span></span><br><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 创建li元素节点</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> liNode = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">&quot;li&quot;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 获取需要加入li节点的父节点</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> cityNode = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">&quot;city&quot;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 将li元素节点添加到父节点中</span></span><br><span class=\"line\">    cityNode.appendChild(liNode);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 创建一个文本节点</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> textNode = <span class=\"built_in\">document</span>.createTextNode(<span class=\"string\">&quot;香港&quot;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 将文本节点放入li元素节点中</span></span><br><span class=\"line\">    liNode.appendChild(textNode);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除节点\"><a href=\"#删除节点\" class=\"headerlink\" title=\"删除节点\"></a>删除节点</h3><figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> cityNode = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">&quot;city&quot;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 删除子节点</span></span><br><span class=\"line\">    cityNode.parentNode.removeChild(cityNode);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n</script></html></p>","categories":["JavaScript"],"tags":["JavaScript"]},{"title":"jQuery基本操作","url":"/2020/%E5%89%8D%E7%AB%AF/jQuery/jQuery%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/","content":"<h2 id=\"jQuery基本操作\"><a href=\"#jQuery基本操作\" class=\"headerlink\" title=\"jQuery基本操作\"></a>jQuery基本操作</h2><h3 id=\"jQuery对象\"><a href=\"#jQuery对象\" class=\"headerlink\" title=\"jQuery对象\"></a>jQuery对象</h3><p>jQuery对象是一个数组，可以通过数组下标转为DOM对象</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// jQuery和DOM对象的互转</span></span><br><span class=\"line\"><span class=\"comment\">// 相当于window.onload</span></span><br><span class=\"line\">$(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">  $(<span class=\"string\">&quot;button&quot;</span>).click(</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">      alert(<span class=\"string\">&quot;helloWorld&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">var</span> $btn = $(<span class=\"string\">&quot;button&quot;</span>);</span><br><span class=\"line\">      alert($btn.length);</span><br><span class=\"line\">      <span class=\"comment\">// 使用数组下标来转为DOM对象</span></span><br><span class=\"line\">      alert($btn[<span class=\"number\">0</span>].firstChild.nodeValue);</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">var</span> btn = <span class=\"built_in\">document</span>.getElementById(<span class=\"string\">&quot;btn&quot;</span>);</span><br><span class=\"line\">      <span class=\"comment\">// 使用$()进行包装将DOM对象转为jQuery对象</span></span><br><span class=\"line\">      alert($(btn).text());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  )</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"基本选择器\"><a href=\"#基本选择器\" class=\"headerlink\" title=\"基本选择器\"></a>基本选择器</h3><p>基本选择器根据id，class和标签名来查找DOM元素</p>\n<ul>\n<li>#id    id选择器 </li>\n<li>.class  class选择器</li>\n<li>element   标签选择器</li>\n<li>*匹配所有元素</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">$(<span class=\"string\">&quot;#id&quot;</span>)</span><br><span class=\"line\">$(<span class=\"string\">&quot;.class&quot;</span>)</span><br><span class=\"line\">$(<span class=\"string\">&quot;div&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"层次选择器\"><a href=\"#层次选择器\" class=\"headerlink\" title=\"层次选择器\"></a>层次选择器</h4><ul>\n<li>派生选择器 $(“div span”)  选取div的所有span(后代)元素   不考虑层次</li>\n<li>父子选择器 $(“parent &gt; child”)  选取parent元素下的child元素</li>\n<li>直接兄弟选择器 $(“prev + next”)  选取紧接在prev元素后的下第一个兄弟关系的next元素</li>\n<li>后续全部兄弟节点选择器 $(“prev ~ siblings”) 选取prev元素后的所有兄弟关系的siblings元素</li>\n</ul>\n<p>(“prev ~ siblings”)选择器只能选择”#prev”元素后面的同辈元素，而jquery中的方法siblings()与前后位置无关，只要是同辈节点就可以选取</p>\n<figure class=\"highlight html\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;content&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">span</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">span</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">$(<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 派生选择器 $(&quot;div span&quot;)  选取div的所有span(后代)元素   不考虑层次</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> ele = $(<span class=\"string\">&quot;div span&quot;</span>);</span><br><span class=\"line\">  alert(ele.length); <span class=\"comment\">// 4</span></span><br><span class=\"line\">  <span class=\"comment\">// 父子选择器 $(&quot;parent &gt; child&quot;)  选取parent元素下的child元素</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> ele1 = $(<span class=\"string\">&quot;div &gt; span&quot;</span>);</span><br><span class=\"line\">  alert(ele1.length); <span class=\"comment\">// 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 直接兄弟选择器 $(&quot;prev + next&quot;)  选取紧接在prev元素后的下第一个兄弟关系的next元素</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> ele2 = $(<span class=\"string\">&quot;div span + p&quot;</span>);</span><br><span class=\"line\">  alert(ele2.length); <span class=\"comment\">// 1</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 后续全部兄弟节点选择器 $(&quot;prev ~ siblings&quot;) 选取prev元素后的所有兄弟关系的siblings元素</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> ele3 = $(<span class=\"string\">&quot;div span ~ p&quot;</span>);</span><br><span class=\"line\">  alert(ele3.length); <span class=\"comment\">// 3</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"过滤选择器\"><a href=\"#过滤选择器\" class=\"headerlink\" title=\"过滤选择器\"></a>过滤选择器</h3><p>过滤选择器通过特定的过滤规则来筛选出所需的DOM元素，该选择器都以”:”开头</p>\n<p>按照不同的过滤规则，过滤选择器可以分为基本过滤，内容过滤，可见性过滤，属性过滤，子元素过滤和表单对象属性过滤选择器</p>\n<h4 id=\"基本过滤选择器\"><a href=\"#基本过滤选择器\" class=\"headerlink\" title=\"基本过滤选择器\"></a>基本过滤选择器</h4><ul>\n<li>:first  $(“li:first”)  选取第一个元素</li>\n<li>:last  $(“li:last”)  选取最后一个元素</li>\n<li>:not(selector)  $(“li:not(.red)”)  选取class不是red的li元素</li>\n<li>:even  $(“li:even”)  选取索引(0开始)是偶数的所有元素</li>\n<li>:odd  $(“li:odd”)  选取索引(0开始)是奇数的所有元素</li>\n<li>:eq(index)  $(“li:eq(2)”)  选择索引等于index的元素 </li>\n<li>:gt(index)  $(“li:gt(2)”)  选择索引大于index的元素 </li>\n<li>:lt(index)  $(“li:lt(2)”)  选择索引小于index的元素 </li>\n<li>:header  $(“:header”)  选择标题元素  h1~h6</li>\n<li>:animated  $(“animated”)  选择正在执行动画的元素</li>\n<li>:focus  $(“:focus”)  选择当前被焦点的元素</li>\n</ul>\n<h4 id=\"内容过滤选择器\"><a href=\"#内容过滤选择器\" class=\"headerlink\" title=\"内容过滤选择器\"></a>内容过滤选择器</h4><ul>\n<li>:contains(text)  $(“:contains(‘com’)”)  选取含有”com”文本的元素</li>\n<li>:empty  $(“:empty”)  选取不包含子元素或空文本的元素</li>\n<li>:has(selector)  $(“has(.red)”)  选取含有class是red的元素</li>\n<li>:parent  $(“:parent”)  选取含有子元素或文本的元素</li>\n</ul>\n<h4 id=\"可见性过滤选择器\"><a href=\"#可见性过滤选择器\" class=\"headerlink\" title=\"可见性过滤选择器\"></a>可见性过滤选择器</h4><ul>\n<li>:hidden  $(“:hidden”)  选取所有不可见元素</li>\n<li>:visible   $(“:visible”)  选取所有可见元素</li>\n</ul>\n<h4 id=\"属性过滤选择器\"><a href=\"#属性过滤选择器\" class=\"headerlink\" title=\"属性过滤选择器\"></a>属性过滤选择器</h4><ul>\n<li>[attribute]  $(“div[id]”)  匹配包含给定属性的元素，查找含有id属性的div元素</li>\n<li>[attribute=value]  $(“input[name=’basketball’]”)   匹配给定属性是某个特定值的元素，查找name属性值为basketball的input元素</li>\n<li>[attribute!=value]  $(“input[name!=’basketball’]”)   匹配给定属性是某个特定值的元素，查找name属性值不为basketball的input元素</li>\n<li>[attribute^=value]  $(“input[name^=’foot’]”)  匹配给定的属性是以某些值开始的元素</li>\n<li>[attribute$=value]  $(“input[name$=’end’]”)  匹配给定的属性是以某些值结尾的元素</li>\n<li>[attribute*=value]  $(“input[name*=’com’]”)  匹配给定的属性是包含某些值的元素</li>\n<li>[selector1][selector2]  $(“input[id][name=’aa’]”)  复合属性过滤选择器，同时满足多个条件，找到含有id属性，且name等于aa的元素</li>\n</ul>\n<h4 id=\"子元素过滤选择器\"><a href=\"#子元素过滤选择器\" class=\"headerlink\" title=\"子元素过滤选择器\"></a>子元素过滤选择器</h4><ul>\n<li>:first-child   $(“li:first-child”)  获取每个父元素的第一个子元素</li>\n<li>:last-child  $(“li:last-child”)  获取每个父元素的最后一个子元素</li>\n<li>:only-child  $(“li:only-child”)  获取只有一个子元素的元素</li>\n<li>:nth-child(odd/even/eq(index))  获取每个自定义子元素的元素(索引值从1开始)</li>\n</ul>\n<h4 id=\"表单对象属性过滤选择器\"><a href=\"#表单对象属性过滤选择器\" class=\"headerlink\" title=\"表单对象属性过滤选择器\"></a>表单对象属性过滤选择器</h4><ul>\n<li>:enabled  $(“#form1:enabled”)  选取id为form1所有可用元素</li>\n<li>:disabled  $(“#form1:enabled”)  选取id为form1所有不可用元素</li>\n<li>:checked  $(“input:checked”)  选取所有被选中的input元素(单选框、复选框)</li>\n<li>:selected  $(“select option:selector”)  选取所有被选中的选项元素(下拉框)</li>\n</ul>\n<h3 id=\"操作文本节点\"><a href=\"#操作文本节点\" class=\"headerlink\" title=\"操作文本节点\"></a>操作文本节点</h3><p>使用text()方法</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 读取文本</span></span><br><span class=\"line\">$(<span class=\"string\">&quot;#bj&quot;</span>).text();</span><br><span class=\"line\"><span class=\"comment\">// 修改文本  将文本改成北京</span></span><br><span class=\"line\">$(<span class=\"string\">&quot;bj&quot;</span>).text(<span class=\"string\">&quot;北京&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"操作属性节点\"><a href=\"#操作属性节点\" class=\"headerlink\" title=\"操作属性节点\"></a>操作属性节点</h3><p>使用attr()方法</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//获取属性  获取value属性</span></span><br><span class=\"line\">$(<span class=\"string\">&quot;input[name=&#x27;username&#x27;]&quot;</span>).attr(<span class=\"string\">&quot;value&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">//修改属性  修改value属性值为张三</span></span><br><span class=\"line\">$(<span class=\"string\">&quot;input[name=&#x27;username&#x27;]&quot;</span>).attr(<span class=\"string\">&quot;value&quot;</span>,<span class=\"string\">&quot;张三&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建节点并插入节点\"><a href=\"#创建节点并插入节点\" class=\"headerlink\" title=\"创建节点并插入节点\"></a>创建节点并插入节点</h3><h4 id=\"创建节点\"><a href=\"#创建节点\" class=\"headerlink\" title=\"创建节点\"></a>创建节点</h4><p>使用jquery的工厂函数$(html)  会根据html来创建一个DOM对象，并把这个DOM对象包装秤一个jQuery对象</p>\n<h4 id=\"插入节点\"><a href=\"#插入节点\" class=\"headerlink\" title=\"插入节点\"></a>插入节点</h4><p>创建好节点之后需要将创建的节点插入文档中</p>\n<ul>\n<li>append()  向每个匹配的元素的内部结尾处追加内容</li>\n<li>appendTo()  将每个匹配的元素追加到指定元素中的内部结尾处</li>\n<li>prepend()  向每个匹配元素的内部的开始处插入内容</li>\n<li>prependTo()  向每个匹配的元素插入到指定的元素内部的开始处</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">$(<span class=\"string\">&quot;&lt;li id=&#x27;bj&#x27;&gt;北京&lt;/li&gt;&quot;</span>).appendTo($(<span class=\"string\">&quot;#city&quot;</span>));</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>after()  向每个匹配的元素之后插入内容</li>\n<li>insertAfter()  向每个匹配的元素的插入到指定的元素之后</li>\n<li>before()   向每个匹配的元素之前插入内容</li>\n<li>insertBefore()   向每个匹配的元素的插入到指定的元素之前</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">$(<span class=\"string\">&quot;&lt;li id=&#x27;sh&#x27;&gt;上海&lt;/li&gt;&quot;</span>).insertAfter($(<span class=\"string\">&quot;#bj&quot;</span>));</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除节点\"><a href=\"#删除节点\" class=\"headerlink\" title=\"删除节点\"></a>删除节点</h3><ul>\n<li>remove()  删除所有匹配的元素，该节点包括子节点都被删除</li>\n<li>empty()  清空元素中所有后代节点(不包括属性节点)</li>\n</ul>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">$(<span class=\"string\">&quot;#bj&quot;</span>).remove();</span><br><span class=\"line\"></span><br><span class=\"line\">$(<span class=\"string\">&quot;#city&quot;</span>).empty();</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"属性操作\"><a href=\"#属性操作\" class=\"headerlink\" title=\"属性操作\"></a>属性操作</h3><p>可以使用attr()方法来进行属性操作</p>\n<p>jQuery中提供了很多方法来实现获取和设置某些属性。</p>\n<ul>\n<li>attr()</li>\n<li>html()  读取和设置某个元素中的HTML内容</li>\n<li>text()  读取和设置某个元素中的文本内容</li>\n<li>val()  读取和设置某个元素中的值  value属性</li>\n<li>height()</li>\n<li>width()</li>\n<li>css()</li>\n</ul>\n<p>removerAttr()可以删除指定元素的指定属性</p>\n<h3 id=\"样式操作\"><a href=\"#样式操作\" class=\"headerlink\" title=\"样式操作\"></a>样式操作</h3><ul>\n<li>addClass()  追加样式</li>\n<li>removeClass()  移除样式</li>\n<li>toggleClass()  切换样式</li>\n<li>hasClass()  判断元素中是否含有某个class</li>\n</ul>\n<h3 id=\"事件操作\"><a href=\"#事件操作\" class=\"headerlink\" title=\"事件操作\"></a>事件操作</h3><h4 id=\"加载事件\"><a href=\"#加载事件\" class=\"headerlink\" title=\"加载事件\"></a>加载事件</h4><p>$(document).ready()  网页中所有的DOM绘制完毕后执行，可能DOM元素关联的东西并没有加载完，简写$()  与window.onload类似</p>\n<h4 id=\"事件绑定\"><a href=\"#事件绑定\" class=\"headerlink\" title=\"事件绑定\"></a>事件绑定</h4><p>对匹配的元素进行特定的事件绑定  bind()</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">$(<span class=\"string\">&quot;.class&quot;</span>).bind(<span class=\"string\">&quot;click&quot;</span>,<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">  alert(<span class=\"string\">&quot;点击事件绑定&quot;</span>);</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"合成事件\"><a href=\"#合成事件\" class=\"headerlink\" title=\"合成事件\"></a>合成事件</h4><ul>\n<li>hover()  模拟光标悬停事件，当光标移到元素上时，会触发指定的第一个元素，光标移出这个元素时，触发第二个函数</li>\n<li>toggle()  模拟鼠标连续单击事件，第一次单击元素，触发指定的第一个函数，再次单击同一个元素，触发指定的下一个函数</li>\n</ul>\n<h4 id=\"移除事件\"><a href=\"#移除事件\" class=\"headerlink\" title=\"移除事件\"></a>移除事件</h4><ul>\n<li>移除某个元素上的某类事件  $(“#btn”).unbind(“click”)</li>\n<li>移除某个元素的所有事件  $(“#btn”).unbind()</li>\n</ul>\n","categories":["jQuery"],"tags":["jQuery"]},{"title":"flume简介","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume/flume/","content":"<h2 id=\"flume简介\"><a href=\"#flume简介\" class=\"headerlink\" title=\"flume简介\"></a>flume简介</h2><p>flume是Cloudera提供的高可用的、高可靠的、分布式的海量日志采集、聚合和传输的系统。基于流式架构</p>\n<p>我下载的最新的flume，为1.9.0版本</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">flume-ng version </span></span><br><span class=\"line\">Flume 1.9.0</span><br><span class=\"line\">Source code repository: https://git-wip-us.apache.org/repos/asf/flume.git</span><br><span class=\"line\">Revision: d4fcab4f501d41597bc616921329a4339f73585e</span><br><span class=\"line\">Compiled by fszabo on Mon Dec 17 20:45:25 CET 2018</span><br><span class=\"line\">From source with checksum 35db629a3bda49d23e9b3690c80737f9</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>下载之后修改flume-env.sh中的JAVA_HOME即可</p>\n</blockquote>\n<a id=\"more\"></a>\n\n<p>Flume NG主要由事件源(Source)、通道(Channel)和接收器(Sink)3个组件组成，由3个组件组成一个代理Agent，一个Flume代理可能包括多个事件源、通道和接收器。</p>\n<p><img src=\"/images/flume/flume.png\" alt=\"flume\"></p>\n<h3 id=\"名词解释\"><a href=\"#名词解释\" class=\"headerlink\" title=\"名词解释\"></a>名词解释</h3><h4 id=\"事件Event\"><a href=\"#事件Event\" class=\"headerlink\" title=\"事件Event\"></a>事件Event</h4><p>Flume将一个具有有效负荷的字节数据流和可选的字符串属性集称为事件，一个事件由Header和Body两部分组成，Header中存放event的一些属性，Body用于存放该条数据，形式为字节数组，事件是Flume数据传输的基本单位。</p>\n<h4 id=\"事件源Source\"><a href=\"#事件源Source\" class=\"headerlink\" title=\"事件源Source\"></a>事件源Source</h4><p>事件源就是负责从数据源采集数据将事件发送到一到多个通道中，是数据流入的入口。常见事件源有文件、网络、数据库、kafka等，官网上列举出来了很多的事件源，而且还可以自定义事件源，不过一般情况下不需要进行自定义</p>\n<p><img src=\"/images/flume/source%E7%B1%BB%E5%9E%8B.png\" alt=\"source类型\"></p>\n<h4 id=\"通道Channel\"><a href=\"#通道Channel\" class=\"headerlink\" title=\"通道Channel\"></a>通道Channel</h4><p>通道负责将事件源流入的数据进行聚合、暂存，通常数据在通道停留的时间不会太长，是位于事件源与接收器之间的构件。通道主要包括非持久性通道(如内存通道Memory Channel)与持久化通道(如文件通道File Channel、数据库JDBC Channel)</p>\n<p><img src=\"/images/flume/%E9%80%9A%E9%81%93%E7%B1%BB%E5%9E%8B.png\" alt=\"通道类型\"></p>\n<p>对于通道来说还有一个通道的选择器，官方提供了两种选择器，Replicating Channel Selector和Multiplexing Channel Selector，默认使用的是replicating，replicating会将sources中发过来的事件发给所有的channel，Multiplexing可以来配置将事件发给某些channel</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">a1.sources</span> = <span class=\"string\">r1</span></span><br><span class=\"line\"><span class=\"comment\"># 多个channel</span></span><br><span class=\"line\"><span class=\"meta\">a1.channels</span> = <span class=\"string\">c1 c2 c3 c4</span></span><br><span class=\"line\"><span class=\"meta\">a1.sources.r1.selector.type</span> = <span class=\"string\">multiplexing</span></span><br><span class=\"line\"><span class=\"comment\"># 根据头信息 state的值来进行匹配</span></span><br><span class=\"line\"><span class=\"meta\">a1.sources.r1.selector.header</span> = <span class=\"string\">state</span></span><br><span class=\"line\"><span class=\"meta\">a1.sources.r1.selector.mapping.CZ</span> = <span class=\"string\">c1</span></span><br><span class=\"line\"><span class=\"meta\">a1.sources.r1.selector.mapping.US</span> = <span class=\"string\">c2 c3</span></span><br><span class=\"line\"><span class=\"meta\">a1.sources.r1.selector.default</span> = <span class=\"string\">c4</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"接收器Sink\"><a href=\"#接收器Sink\" class=\"headerlink\" title=\"接收器Sink\"></a>接收器Sink</h4><p>接收器负责从通道消费数据，将数据转移到其他存储系统，例如将数据存储到文件、数据库、HDFS、Kafka、HBase等，官网上列举出来了很多的接收器，而且还可以自定义接收器，不过一般情况下不需要进行自定义</p>\n<p><img src=\"/images/flume/sink%E7%B1%BB%E5%9E%8B.png\" alt=\"sink类型\"></p>\n<p>sink还有一个sink组的概念</p>\n","categories":["flume![source类型](/images/flume/source类型.png)"],"tags":["flume"]},{"title":"flume事务","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume/flume%E4%BA%8B%E5%8A%A1/","content":"<h2 id=\"flume事务\"><a href=\"#flume事务\" class=\"headerlink\" title=\"flume事务\"></a>flume事务</h2><p>flume为了保证数据的原子性，内部存在了事务功能，在Source-&gt;Channel过程中存在一个事务，在Channel-&gt;Sink过程中存在一个事务</p>\n<a id=\"more\"></a>\n\n<h3 id=\"Put事务\"><a href=\"#Put事务\" class=\"headerlink\" title=\"Put事务\"></a>Put事务</h3><p>在Source-&gt;Channel过程中存在的事务是Put事务</p>\n<h4 id=\"事务流程\"><a href=\"#事务流程\" class=\"headerlink\" title=\"事务流程\"></a>事务流程</h4><ul>\n<li>doPut 将批数据写入到临时缓冲区putlist中</li>\n<li>doCommit  检查channel中内存是否足够</li>\n<li>doRollback  channel中内存不足，回滚数据至putlist中</li>\n</ul>\n<h3 id=\"Take事务\"><a href=\"#Take事务\" class=\"headerlink\" title=\"Take事务\"></a>Take事务</h3><p>在Channel-&gt;Sink过程中存在的事务是Take事务</p>\n<h4 id=\"事务流程-1\"><a href=\"#事务流程-1\" class=\"headerlink\" title=\"事务流程\"></a>事务流程</h4><ul>\n<li>doTake  将数据取到临时缓冲区takelist，将数据发送给sink对应的目的地</li>\n<li>doCommit  如果数据发送成功，清空takelist</li>\n<li>doRollback  如果数据发送失败，将缓冲区takelist中的数据返回给channel</li>\n</ul>\n","categories":["flume"],"tags":["flume"]},{"title":"flume扩展","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume/flume%E6%89%A9%E5%B1%95/","content":"<h2 id=\"flume扩展\"><a href=\"#flume扩展\" class=\"headerlink\" title=\"flume扩展\"></a>flume扩展</h2><p>flume可以自定义拦截器、自定义事件源、自定义接收器，可以通过自定义各个组件来进行flume的扩展</p>\n<p>依赖</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- flume核心包 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.flume<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>flume-ng-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.9.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"拦截器\"><a href=\"#拦截器\" class=\"headerlink\" title=\"拦截器\"></a>拦截器</h3><p>Flume提供了拦截器功能，可以在源之后、接收器之前定义多个拦截器，可以通过拦截器在数据流入通道之前或数据流出通道之后对数据进行处理。</p>\n<a id=\"more\"></a>\n\n<p>通过实现org.apache.flume.interceptor.Interceptor来自定义自己的拦截器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyInterceptor</span> <span class=\"keyword\">implements</span> <span class=\"title\">Interceptor</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">initialize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 单个事件拦截</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> event</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Event <span class=\"title\">intercept</span><span class=\"params\">(Event event)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 获取头信息</span></span><br><span class=\"line\">        Map&lt;String,String&gt; headers = event.getHeaders();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取数据</span></span><br><span class=\"line\">        String body = <span class=\"keyword\">new</span> String(event.getBody());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 根据body内容来添加头信息</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(body.startsWith(<span class=\"string\">&quot;number==&quot;</span>))&#123;</span><br><span class=\"line\">            headers.put(<span class=\"string\">&quot;type&quot;</span>,<span class=\"string\">&quot;num&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            headers.put(<span class=\"string\">&quot;type&quot;</span>,<span class=\"string\">&quot;str&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> event;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 批量事件拦截</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> list</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;Event&gt; <span class=\"title\">intercept</span><span class=\"params\">(List&lt;Event&gt; list)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">close</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Builder</span> <span class=\"keyword\">implements</span> <span class=\"title\">Interceptor</span>.<span class=\"title\">Builder</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Interceptor <span class=\"title\">build</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> MyInterceptor();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(Context context)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以搭配multiplexing  channel选择器来根据头信息选择不同的通道</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#拦截器名称</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.interceptors</span> = <span class=\"string\">myInterceptor</span></span><br><span class=\"line\"><span class=\"comment\"># 配置拦截器</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.interceptors.myInterceptor.type</span> = <span class=\"string\">com.zhanghe.study.custom_flume.interceptor.MyInterceptor$Builder</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.channels</span> = <span class=\"string\">memoryChannel1 memoryChannel2</span></span><br><span class=\"line\"><span class=\"comment\"># 配置channel选择器</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.selector.type</span> = <span class=\"string\">multiplexing</span></span><br><span class=\"line\"><span class=\"comment\"># 配置channel选择器的映射  根据header中的type来进行映射</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.selector.header</span> = <span class=\"string\">type</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.selector.mapping.num</span> = <span class=\"string\">memoryChannel1</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.selector.mapping.str</span> = <span class=\"string\">memoryChannel2</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"自定义Source\"><a href=\"#自定义Source\" class=\"headerlink\" title=\"自定义Source\"></a>自定义Source</h3><p>自定义的Source需要继承AbstractSource，实现Configurable和PollableSource接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MySource</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractSource</span> <span class=\"keyword\">implements</span> <span class=\"title\">Configurable</span>, <span class=\"title\">PollableSource</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String myProp;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">volatile</span> AtomicInteger count = <span class=\"keyword\">new</span> AtomicInteger(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 获取配置信息</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(Context context)</span> </span>&#123;</span><br><span class=\"line\">        String myProp = context.getString(<span class=\"string\">&quot;myProp&quot;</span>, <span class=\"string\">&quot;defaultValue&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.myProp = myProp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 核心方法</span></span><br><span class=\"line\">    <span class=\"comment\">// 1.接收数据</span></span><br><span class=\"line\">    <span class=\"comment\">// 2.封装为事件</span></span><br><span class=\"line\">    <span class=\"comment\">// 3.将事件传给channel</span></span><br><span class=\"line\">    <span class=\"comment\">//</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Status <span class=\"title\">process</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> EventDeliveryException </span>&#123;</span><br><span class=\"line\">        Status status;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(count.get() &lt;= <span class=\"number\">5</span>)&#123;</span><br><span class=\"line\">            count.incrementAndGet();</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 接收数据</span></span><br><span class=\"line\">                Event e = <span class=\"keyword\">new</span> SimpleEvent();</span><br><span class=\"line\"></span><br><span class=\"line\">                e.setBody((myProp+<span class=\"string\">&quot;==&quot;</span>+<span class=\"string\">&quot;hello&quot;</span>).getBytes());</span><br><span class=\"line\">                <span class=\"comment\">// 将事件传给channel</span></span><br><span class=\"line\">                getChannelProcessor().processEvent(e);</span><br><span class=\"line\"></span><br><span class=\"line\">                status = Status.READY;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;</span><br><span class=\"line\">                status = Status.BACKOFF;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (t <span class=\"keyword\">instanceof</span> Error) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> (Error)t;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            status = Status.BACKOFF;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> status;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getBackOffSleepIncrement</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getMaxBackOffSleepInterval</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#事件源名称</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources</span> = <span class=\"string\">mySource</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.type</span> = <span class=\"string\">com.zhanghe.study.custom_flume.source.MySource</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.myProp</span> = <span class=\"string\">str</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"自定义Sink\"><a href=\"#自定义Sink\" class=\"headerlink\" title=\"自定义Sink\"></a>自定义Sink</h3><p>自定义的Sink需要继承AbstractSink类,实现Configurable接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MySink</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractSink</span> <span class=\"keyword\">implements</span> <span class=\"title\">Configurable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String myProp;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 获取配置信息</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(Context context)</span> </span>&#123;</span><br><span class=\"line\">        String myProp = context.getString(<span class=\"string\">&quot;myProp&quot;</span>, <span class=\"string\">&quot;defaultValue&quot;</span>);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">this</span>.myProp = myProp;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 核心方法</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Status <span class=\"title\">process</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> EventDeliveryException </span>&#123;</span><br><span class=\"line\">        Status status = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        </span><br><span class=\"line\">          <span class=\"comment\">// 获取Channel</span></span><br><span class=\"line\">        Channel ch = getChannel();</span><br><span class=\"line\">        <span class=\"comment\">// 开启事务</span></span><br><span class=\"line\">        Transaction txn = ch.getTransaction();</span><br><span class=\"line\">        txn.begin();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 从channel中获取事件</span></span><br><span class=\"line\">            Event event = ch.take();</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(event != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                LOGGER.info(myProp+<span class=\"string\">&quot;--&quot;</span>+<span class=\"keyword\">new</span> String(event.getBody()));</span><br><span class=\"line\">                status = Status.READY;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                status = Status.BACKOFF;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            txn.commit();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Throwable t) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 事务回滚</span></span><br><span class=\"line\">            txn.rollback();</span><br><span class=\"line\"></span><br><span class=\"line\">            status = Status.BACKOFF;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (t <span class=\"keyword\">instanceof</span> Error) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> (Error)t;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 关闭事务</span></span><br><span class=\"line\">            txn.close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> status;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">agent2.sinks.mySink.type</span> = <span class=\"string\">com.zhanghe.study.custom_flume.sink.MySink</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sinks.mySink.myProp</span> = <span class=\"string\">mySink//</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"整体配置\"><a href=\"#整体配置\" class=\"headerlink\" title=\"整体配置\"></a>整体配置</h3><figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#事件源名称</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources</span> = <span class=\"string\">mySource</span></span><br><span class=\"line\"><span class=\"comment\">#通道名称</span></span><br><span class=\"line\"><span class=\"meta\">agent2.channels</span> = <span class=\"string\">memoryChannel1  memoryChannel2</span></span><br><span class=\"line\"><span class=\"comment\">#接收器名称</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sinks</span> = <span class=\"string\">loggerSink mySink</span></span><br><span class=\"line\"><span class=\"comment\">#拦截器名称</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.interceptors</span> = <span class=\"string\">myInterceptor</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#source</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.type</span> = <span class=\"string\">com.zhanghe.study.custom_flume.source.MySource</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.myProp</span> = <span class=\"string\">str</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置拦截器</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.interceptors.myInterceptor.type</span> = <span class=\"string\">com.zhanghe.study.custom_flume.interceptor.MyInterceptor$Builder</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># sink</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sinks.loggerSink.type</span> = <span class=\"string\">logger</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sinks.mySink.type</span> = <span class=\"string\">com.zhanghe.study.custom_flume.sink.MySink</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sinks.mySink.myProp</span> = <span class=\"string\">mySink//</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#channel</span></span><br><span class=\"line\"><span class=\"meta\">agent2.channels.memoryChannel1.type</span> = <span class=\"string\">memory</span></span><br><span class=\"line\"><span class=\"meta\">agent2.channels.memoryChannel2.type</span> = <span class=\"string\">memory</span></span><br><span class=\"line\"><span class=\"comment\"># 通道中停留的最大事件数</span></span><br><span class=\"line\"><span class=\"meta\">agent2.channels.memoryChannel1.capacity</span> = <span class=\"string\">100</span></span><br><span class=\"line\"><span class=\"meta\">agent2.channels.memoryChannel2.capacity</span> = <span class=\"string\">100</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.channels</span> = <span class=\"string\">memoryChannel1 memoryChannel2</span></span><br><span class=\"line\"><span class=\"comment\"># 配置channel选择器</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.selector.type</span> = <span class=\"string\">multiplexing</span></span><br><span class=\"line\"><span class=\"comment\"># 配置channel选择器的映射  根据header中的type来进行映射</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.selector.header</span> = <span class=\"string\">type</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.selector.mapping.num</span> = <span class=\"string\">memoryChannel1</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.mySource.selector.mapping.str</span> = <span class=\"string\">memoryChannel2</span></span><br><span class=\"line\"><span class=\"comment\">#Specify the channel the sink should use</span></span><br><span class=\"line\"><span class=\"comment\"># 接收器通道名称，绑定通道</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sinks.loggerSink.channel</span> = <span class=\"string\">memoryChannel1</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sinks.mySink.channel</span> = <span class=\"string\">memoryChannel2</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","categories":["flume"],"tags":["flume"]},{"title":"flume拓扑结构","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume/flume%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84/","content":"<h2 id=\"flume拓扑结构\"><a href=\"#flume拓扑结构\" class=\"headerlink\" title=\"flume拓扑结构\"></a>flume拓扑结构</h2><p>官网对于flume的搭建和使用提供了三种拓扑结构</p>\n<h3 id=\"简单串联\"><a href=\"#简单串联\" class=\"headerlink\" title=\"简单串联\"></a>简单串联</h3><p><img src=\"/images/flume/%E7%BB%93%E6%9E%84%E4%B9%8B%E7%AE%80%E5%8D%95%E4%B8%B2%E8%81%94.png\" alt=\"结构之简单串联\"></p>\n<p>将多个flume简单的串联起来</p>\n<a id=\"more\"></a>\n\n<h3 id=\"复制和多路复用\"><a href=\"#复制和多路复用\" class=\"headerlink\" title=\"复制和多路复用\"></a>复制和多路复用</h3><p><img src=\"/images/flume/%E7%BB%93%E6%9E%84%E4%B9%8B%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8.png\" alt=\"结构之多路复用\"></p>\n<p>一个事件源对应多个通道和多个接收器</p>\n<h3 id=\"聚合\"><a href=\"#聚合\" class=\"headerlink\" title=\"聚合\"></a>聚合</h3><p><img src=\"/images/flume/%E7%BB%93%E6%9E%84%E4%B9%8B%E8%81%9A%E5%90%88.png\" alt=\"结构之负载均衡\"></p>\n","categories":["flume"],"tags":["flume"]},{"title":"flume监控文件写入kafka","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume/flume%E7%9B%91%E6%8E%A7%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5kafka/","content":"<h2 id=\"flume监控文件写入kafka\"><a href=\"#flume监控文件写入kafka\" class=\"headerlink\" title=\"flume监控文件写入kafka\"></a>flume监控文件写入kafka</h2><p>之前了解过log4j2将日志直接写入kafka中，这样会导致应用程序直接依赖于kafka运行环境。</p>\n<p>而一般通常的做法是应用程序将日志写入本地，通过日志采集工具将本地日志同步到远程服务器，flume就是常用的数据采集工具之一。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#事件源名称</span></span><br><span class=\"line\"><span class=\"meta\">agent.sources</span> = <span class=\"string\">execSource</span></span><br><span class=\"line\"><span class=\"comment\">#通道名称</span></span><br><span class=\"line\"><span class=\"meta\">agent.channels</span> = <span class=\"string\">memoryChannel</span></span><br><span class=\"line\"><span class=\"comment\">#接收器名称</span></span><br><span class=\"line\"><span class=\"meta\">agent.sinks</span> = <span class=\"string\">kafkaSink</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># For each one of the sources, the type is defined</span></span><br><span class=\"line\"><span class=\"meta\">agent.sources.execSource.type</span> = <span class=\"string\">exec</span></span><br><span class=\"line\"><span class=\"meta\">agent.sources.execSource.command</span> = <span class=\"string\">echo &quot;测试一下&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The channel can be defined as follows.</span></span><br><span class=\"line\"><span class=\"comment\"># 事件源的通道，绑定通道</span></span><br><span class=\"line\"><span class=\"meta\">agent.sources.execSource.channels</span> = <span class=\"string\">memoryChannel</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Each sink&#x27;s type must be defined</span></span><br><span class=\"line\"><span class=\"comment\"># kafka接收器配置</span></span><br><span class=\"line\"><span class=\"meta\">agent.sinks.kafkaSink.type</span> = <span class=\"string\">org.apache.flume.sink.kafka.KafkaSink</span></span><br><span class=\"line\"><span class=\"meta\">agent.sinks.kafkaSink.kafka.bootstrap.servers</span> = <span class=\"string\">localhost:9092</span></span><br><span class=\"line\"><span class=\"meta\">agent.sinks.kafkaSink.kafka.topic</span> = <span class=\"string\">flume-kafka</span></span><br><span class=\"line\"><span class=\"meta\">agent.sinks.kafkaSink.kafka.serializer.class</span> = <span class=\"string\">kafka.serializer.StringEncoder</span></span><br><span class=\"line\"><span class=\"meta\">agent.sinks.kafkaSink.kafka.producer.acks</span> = <span class=\"string\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#Specify the channel the sink should use</span></span><br><span class=\"line\"><span class=\"comment\"># 接收器通道名称，绑定通道</span></span><br><span class=\"line\"><span class=\"meta\">agent.sinks.kafkaSink.channel</span> = <span class=\"string\">memoryChannel</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Each channel&#x27;s type is defined.</span></span><br><span class=\"line\"><span class=\"meta\">agent.channels.memoryChannel.type</span> = <span class=\"string\">memory</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Other config values specific to each type of channel(sink or source)</span></span><br><span class=\"line\"><span class=\"comment\"># can be defined as well</span></span><br><span class=\"line\"><span class=\"comment\"># In this case, it specifies the capacity of the memory channel</span></span><br><span class=\"line\"><span class=\"comment\"># 通道中停留的最大事件数</span></span><br><span class=\"line\"><span class=\"meta\">agent.channels.memoryChannel.capacity</span> = <span class=\"string\">100</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"执行命令\"><a href=\"#执行命令\" class=\"headerlink\" title=\"执行命令\"></a>执行命令</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">flume-ng agent -c /usr/local/Cellar/flume/1.9.0_1/libexec/conf -f conf/flume-kafka-conf.properties --name agent</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看kafka结果\"><a href=\"#查看kafka结果\" class=\"headerlink\" title=\"查看kafka结果\"></a>查看kafka结果</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">kafka-run-class kafka.tools.DumpLogSegments --files /usr/<span class=\"built_in\">local</span>/var/lib/kafka-logs/flume-kafka-0/00000000000000000000.log --<span class=\"built_in\">print</span>-data-log</span></span><br><span class=\"line\"></span><br><span class=\"line\">Dumping /usr/local/var/lib/kafka-logs/flume-kafka-0/00000000000000000000.log</span><br><span class=\"line\">Starting offset: 0</span><br><span class=\"line\">baseOffset: 0 lastOffset: 0 count: 1 baseSequence: -1 lastSequence: -1 producerId: -1 producerEpoch: -1 partitionLeaderEpoch: 0 isTransactional: false isControl: false position: 0 CreateTime: 1603274630544 size: 82 magic: 2 compresscodec: NONE crc: 2637763778 isvalid: true</span><br><span class=\"line\">| offset: 0 CreateTime: 1603274630544 keysize: -1 valuesize: 14 sequence: -1 headerKeys: [] payload: &quot;测试一下&quot;</span><br></pre></td></tr></table></figure>\n\n","categories":["flume"],"tags":["flume"]},{"title":"flume监控目录文件","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume/flume%E7%9B%91%E6%8E%A7%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6/","content":"<h2 id=\"flume监控目录文件\"><a href=\"#flume监控目录文件\" class=\"headerlink\" title=\"flume监控目录文件\"></a>flume监控目录文件</h2><p>使用flume来监控目录文件的变化，并将目录中的文件内容传至hdfs中，有三种事件源可供选择</p>\n<p>一是Exec Source来监控文件，适用于监控一个实时追加的文件，但是不能保证数据不丢失</p>\n<p>二是Spooldir Source来监控目录，可以保证不丢失数据，且可以做到断点续传，但是延迟过高，无法保证实时监控</p>\n<p>三是Tairdir Source来监控，既可以保证不丢失数据，又可以保证断点续传，还可以保证实时监控</p>\n<a id=\"more\"></a>\n\n<h3 id=\"使用exec-Source\"><a href=\"#使用exec-Source\" class=\"headerlink\" title=\"使用exec Source\"></a>使用exec Source</h3><p><strong>配置</strong></p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#事件源名称</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources</span> = <span class=\"string\">execSource</span></span><br><span class=\"line\"><span class=\"comment\">#通道名称</span></span><br><span class=\"line\"><span class=\"meta\">agent1.channels</span> = <span class=\"string\">memoryChannel</span></span><br><span class=\"line\"><span class=\"comment\">#接收器名称</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks</span> = <span class=\"string\">hdfsSink</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># For each one of the sources, the type is defined</span></span><br><span class=\"line\"><span class=\"comment\"># 事件源类型 常见的有avro(监听Avro端口并从外部Avro客户端流接收事件)、thrift(监听Thrift端口并从外部Thrift客户端流接收事件)、exec(Exec源在启动时运行给定的Unix命令，并期望该进程在标准输出上连续产生数据)、spooldir(此源允许您通过将要提取的文件放入磁盘上的“spooling”目录中来提取数据。此源将监视新文件的指定目录，并在新文件显示时解析新文件中的事件)、org.apache.flume.source.kafka.KafkaSource(从Kafka主题读取消息的Apache Kafka消费者)、seq(简单的序列发生器，不断的产生事件，值是从0开始每次递增1)</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.execSource.type</span> = <span class=\"string\">exec</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.execSource.command</span> = <span class=\"string\">tail -F /Users/zhanghe/desktop/user/test/testExec.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Each sink&#x27;s type must be defined</span></span><br><span class=\"line\"><span class=\"comment\"># 接收器的类型 常见的有hdfs(将事件写入Hadoop分布式文件系统（HDFS）)、hive(将包含定界文本或JSON数据的事件直接传输到Hive表或分区)、hbase、avro、org.apache.flume.sink.kafka.KafkaSink(将数据发布到Kafka主题)</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.type</span> = <span class=\"string\">hdfs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置hdfs路径，按照日期和小时切割文件</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.path</span> = <span class=\"string\">hdfs://localhost:9000/exec-flume-hdfs/%Y-%m-%d/%H</span></span><br><span class=\"line\"><span class=\"comment\"># 文件前缀</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.filePrefix</span> = <span class=\"string\">test-</span></span><br><span class=\"line\"><span class=\"comment\"># 正在接收数据写操作的临时文件后缀</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.inUseSuffix</span> = <span class=\"string\">.tmp</span></span><br><span class=\"line\"><span class=\"comment\"># 文件归档为目标文件的文件后缀名</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.fileSuffix</span> = <span class=\"string\">.txt</span></span><br><span class=\"line\"><span class=\"comment\"># 使用本地时间</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.useLocalTimeStamp</span> = <span class=\"string\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##############切割文件</span></span><br><span class=\"line\"><span class=\"comment\"># 若以时间切割文件时，滚动为目标文件之前的最大时间间隔，单位秒</span></span><br><span class=\"line\"><span class=\"comment\"># 如果为0，则表示不根据时间来滚动文件</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.rollInverval</span> = <span class=\"string\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 若以大小切割文件时，滚动为目标文件之前的最多字节数</span></span><br><span class=\"line\"><span class=\"comment\"># 如果为0，则表示不根据临时文件大小来滚动文件</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.rollSize</span> = <span class=\"string\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置当事件数据达到该数量时，将临时文件滚动成目标文件</span></span><br><span class=\"line\"><span class=\"comment\"># 如果为0，表示不根据事件数据来滚动文件</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.rollCount</span> = <span class=\"string\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">############文件夹</span></span><br><span class=\"line\"><span class=\"comment\"># 是否更换文件夹</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.round</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"comment\"># 周期值</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.roundValue</span>=<span class=\"string\">1</span></span><br><span class=\"line\"><span class=\"comment\"># 周期单元  注意与hdfs。path的文件夹进行匹配，如果文件夹没有%H文件夹，不生效</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.roundUnit</span>=<span class=\"string\">hour</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 每个批次刷新到HDFS上的事件数量</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.batchSize</span> = <span class=\"string\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 文件格式，默认为SequenceFile</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.fileType</span> = <span class=\"string\">DataStream</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 写sequence文件的格式，默认Writable</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.writeFormat</span> = <span class=\"string\">Text</span></span><br><span class=\"line\"><span class=\"comment\"># 配置当前被打开的临时文件在该参数指定的时间内，没有任何数据写入时则将该临时文件关闭并重命名为目标文件</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.idleTimeout</span> = <span class=\"string\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 接收器启动操作HDFS的线程数，默认10</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.threadsPoolSize</span> = <span class=\"string\">15</span></span><br><span class=\"line\"><span class=\"comment\"># 执行HDFS操作的超时时间，默认10s</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.callTimeout</span> = <span class=\"string\">60000</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Each channel&#x27;s type is defined.</span></span><br><span class=\"line\"><span class=\"comment\"># 通道类型  常见的有 file(将数据存储到磁盘上)、memory(存储在具有可配置最大大小的内存队列中)、jdbc(存放于一个支持JDBC连接的数据库中)、SPILLABLEMEMORY(存放在内存和磁盘上，内存作为主要存储，当内存达到一定临界点的时候会溢写到磁盘上。其中和了memory channel和File channel的优缺点)</span></span><br><span class=\"line\"><span class=\"meta\">agent1.channels.memoryChannel.type</span> = <span class=\"string\">memory</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Other config values specific to each type of channel(sink or source)</span></span><br><span class=\"line\"><span class=\"comment\"># can be defined as well</span></span><br><span class=\"line\"><span class=\"comment\"># In this case, it specifies the capacity of the memory channel</span></span><br><span class=\"line\"><span class=\"comment\"># 通道中停留的最大事件数</span></span><br><span class=\"line\"><span class=\"meta\">agent1.channels.memoryChannel.capacity</span> = <span class=\"string\">100</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The channel can be defined as follows.</span></span><br><span class=\"line\"><span class=\"comment\"># 事件源的通道，绑定通道</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.execSource.channels</span> = <span class=\"string\">memoryChannel</span></span><br><span class=\"line\"><span class=\"comment\">#Specify the channel the sink should use</span></span><br><span class=\"line\"><span class=\"comment\"># 接收器通道名称，绑定通道</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.channel</span> = <span class=\"string\">memoryChannel</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用Spooldir-Source\"><a href=\"#使用Spooldir-Source\" class=\"headerlink\" title=\"使用Spooldir Source\"></a>使用Spooldir Source</h3><p>接收器/通道的配置与上述一致,只需要调整事件源的配置即可</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#事件源名称</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources</span> = <span class=\"string\">spooldirSource</span></span><br><span class=\"line\"><span class=\"comment\">#通道名称</span></span><br><span class=\"line\"><span class=\"meta\">agent1.channels</span> = <span class=\"string\">memoryChannel</span></span><br><span class=\"line\"><span class=\"comment\">#接收器名称</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks</span> = <span class=\"string\">hdfsSink</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.spooldirSource.type</span> = <span class=\"string\">spooldir</span></span><br><span class=\"line\"><span class=\"comment\"># 监听的目录</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.spooldirSource.spoolDir</span> = <span class=\"string\">/Users/zhanghe/desktop/user/test/</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用Taildir-Source\"><a href=\"#使用Taildir-Source\" class=\"headerlink\" title=\"使用Taildir Source\"></a>使用Taildir Source</h3><figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">agent2.sources.tairDirSource.type</span> = <span class=\"string\">TAILDIR</span></span><br><span class=\"line\"><span class=\"comment\"># 文件组,可以有多个，空格隔开</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.tairDirSource.filegroups</span> = <span class=\"string\">log1</span></span><br><span class=\"line\"><span class=\"comment\"># log1文件组的文件位置</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.tairDirSource.filegroups.log1</span> = <span class=\"string\">/Users/zhanghe/desktop/user/test/testTailDir/test1.log</span></span><br><span class=\"line\"><span class=\"comment\"># 该文件用于记录最后读取到的文件位置了</span></span><br><span class=\"line\"><span class=\"meta\">agent2.sources.tairDirSource.positionFile</span> = <span class=\"string\">/Users/zhanghe/desktop/user/test/testTailDir/taildir_position.json</span></span><br></pre></td></tr></table></figure>\n\n","categories":["flume"],"tags":["flume"]},{"title":"flume简单配置与执行","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume/flume%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%89%A7%E8%A1%8C/","content":"<h2 id=\"flume简单配置与执行\"><a href=\"#flume简单配置与执行\" class=\"headerlink\" title=\"flume简单配置与执行\"></a>flume简单配置与执行</h2><h3 id=\"命令参数\"><a href=\"#命令参数\" class=\"headerlink\" title=\"命令参数\"></a>命令参数</h3><ul>\n<li>agent 指定以agent角色启动，另一个角色为avro-client</li>\n<li>conf或c  指定flume-env.sh和log4j.properties的所在目录</li>\n<li>config-file或f  指定配置源和接收器配置文件的相对路径，相对于执行该命令的目录，包括文件名</li>\n<li>name或n  指定agent的名称</li>\n<li>D  -D后接键值对，指定java相关配置</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#agent表示agent的名字，可以任意取名</span></span><br><span class=\"line\"><span class=\"comment\">#seqGenSrc表示事件源名称</span></span><br><span class=\"line\"><span class=\"meta\">agent.sources</span> = <span class=\"string\">seqGenSrc</span></span><br><span class=\"line\"><span class=\"comment\">#memoryChannel表示通道名称</span></span><br><span class=\"line\"><span class=\"meta\">agent.channels</span> = <span class=\"string\">memoryChannel</span></span><br><span class=\"line\"><span class=\"comment\">#loggerSink表示接收器名称</span></span><br><span class=\"line\"><span class=\"meta\">agent.sinks</span> = <span class=\"string\">loggerSink</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 事件源配置</span></span><br><span class=\"line\"><span class=\"comment\"># 事件源类型 常见的有avro(监听Avro端口并从外部Avro客户端流接收事件)、thrift(监听Thrift端口并从外部Thrift客户端流接收事件)、exec(Exec源在启动时运行给定的Unix命令，并期望该进程在标准输出上连续产生数据)、spooldir(此源允许您通过将要提取的文件放入磁盘上的“spooling”目录中来提取数据。此源将监视新文件的指定目录，并在新文件显示时解析新文件中的事件)、org.apache.flume.source.kafka.KafkaSource(从Kafka主题读取消息的Apache Kafka消费者)、seq(简单的序列发生器，不断的产生事件，值是从0开始每次递增1)</span></span><br><span class=\"line\"><span class=\"meta\">agent.sources.seqGenSrc.type</span> = <span class=\"string\">seq</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 接收器配置</span></span><br><span class=\"line\"><span class=\"comment\"># 接收器的类型 常见的有hdfs(将事件写入Hadoop分布式文件系统（HDFS）)、hive(将包含定界文本或JSON数据的事件直接传输到Hive表或分区)、hbase、avro、org.apache.flume.sink.kafka.KafkaSink(将数据发布到Kafka主题)</span></span><br><span class=\"line\"><span class=\"meta\">agent.sinks.loggerSink.type</span> = <span class=\"string\">logger</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通道配置</span></span><br><span class=\"line\"><span class=\"comment\"># 通道类型  常见的有 file(将数据存储到磁盘上)、memory(存储在具有可配置最大大小的内存队列中)、jdbc(存放于一个支持JDBC连接的数据库中)、SPILLABLEMEMORY(存放在内存和磁盘上，内存作为主要存储，当内存达到一定临界点的时候会溢写到磁盘上。其中和了memory channel和File channel的优缺点)</span></span><br><span class=\"line\"><span class=\"meta\">agent.channels.memoryChannel.type</span> = <span class=\"string\">memory</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Other config values specific to each type of channel(sink or source)</span></span><br><span class=\"line\"><span class=\"comment\"># can be defined as well</span></span><br><span class=\"line\"><span class=\"comment\"># In this case, it specifies the capacity of the memory channel</span></span><br><span class=\"line\"><span class=\"comment\"># 通道中停留的最大事件数</span></span><br><span class=\"line\"><span class=\"meta\">agent.channels.memoryChannel.capacity</span> = <span class=\"string\">100</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绑定到通道</span></span><br><span class=\"line\"><span class=\"comment\"># 事件源的通道，绑定通道</span></span><br><span class=\"line\"><span class=\"meta\">agent.sources.seqGenSrc.channels</span> = <span class=\"string\">memoryChannel</span></span><br><span class=\"line\"><span class=\"comment\"># 接收器通道名称，绑定通道</span></span><br><span class=\"line\"><span class=\"meta\">agent.sinks.loggerSink.channel</span> = <span class=\"string\">memoryChannel</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"命令\"><a href=\"#命令\" class=\"headerlink\" title=\"命令\"></a>命令</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">flume-ng agent -c /usr/local/Cellar/flume/1.9.0_1/libexec/conf -f conf/flume-conf.properties --name agent</span><br></pre></td></tr></table></figure>\n\n<p>按照上述配置的话，该命令会在log文件中一直打印数字，日志所在位置查看log4j.properties中的配置</p>\n<blockquote>\n<p>name需要和配置文件中配置的agent中的名字一致</p>\n</blockquote>\n","categories":["flume"],"tags":["flume"]},{"title":"flume采集kafka消息写入HDFS","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume/flume%E9%87%87%E9%9B%86kafka%E4%BF%A1%E6%81%AF%E5%86%99%E5%85%A5hdfs/","content":"<h2 id=\"flume采集kafka消息写入HDFS\"><a href=\"#flume采集kafka消息写入HDFS\" class=\"headerlink\" title=\"flume采集kafka消息写入HDFS\"></a>flume采集kafka消息写入HDFS</h2><h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p>该配置采用kafka作为事件源，kafka作为通道，hdfs作为接收器</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#事件源名称</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources</span> = <span class=\"string\">kafkaSource</span></span><br><span class=\"line\"><span class=\"comment\">#通道名称</span></span><br><span class=\"line\"><span class=\"meta\">agent1.channels</span> = <span class=\"string\">kafka-channel</span></span><br><span class=\"line\"><span class=\"comment\">#接收器名称</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks</span> = <span class=\"string\">hdfsSink</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">###############################事件源source###########################################</span></span><br><span class=\"line\"><span class=\"comment\">## flume-kafka-source-1.9.0.jar</span></span><br><span class=\"line\"><span class=\"comment\"># For each one of the sources, the type is defined</span></span><br><span class=\"line\"><span class=\"comment\"># 使用kafka事件源</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.kafkaSource.type</span> = <span class=\"string\">org.apache.flume.source.kafka.KafkaSource</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.kafkaSource.kafka.bootstrap.servers</span> = <span class=\"string\">localhost:9092</span></span><br><span class=\"line\"><span class=\"comment\"># 注意这里的topic配置是topics  我当初没有写s导致事件源没有启动  数据进不去  找了很长时间问题</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.kafkaSource.kafka.topics</span> = <span class=\"string\">kafka-flume</span></span><br><span class=\"line\"><span class=\"comment\"># 消费者组id</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.kafkaSource.kafka.consumer.group.id</span> = <span class=\"string\">kafka-flume-hdfs</span></span><br><span class=\"line\"><span class=\"comment\"># 批量写入的最大数量</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.kafkaSource.kafka.batchSize</span> = <span class=\"string\">1000</span></span><br><span class=\"line\"><span class=\"comment\"># 批量写入最长等待时间</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.kafkaSource.kafka.batchDurationMillis</span> = <span class=\"string\">1000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The channel can be defined as follows.</span></span><br><span class=\"line\"><span class=\"comment\"># 事件源的通道，绑定通道</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sources.kafkaSource.channels</span> = <span class=\"string\">kafka-channel</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#############################通道channel#############################################</span></span><br><span class=\"line\"><span class=\"comment\">## flume-kafka-channel-1.9.0.jar</span></span><br><span class=\"line\"><span class=\"meta\">agent1.channels.kafka-channel.type</span> = <span class=\"string\">org.apache.flume.channel.kafka.KafkaChannel</span></span><br><span class=\"line\"><span class=\"meta\">agent1.channels.kafka-channel.kafka.bootstrap.servers</span> = <span class=\"string\">localhost:9092</span></span><br><span class=\"line\"><span class=\"comment\"># 指定通道用于缓存数据的主题</span></span><br><span class=\"line\"><span class=\"meta\">agent1.channels.kafka-channel.kafka.topic</span> = <span class=\"string\">kafka-channel</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##################################接收器sink##############################################</span></span><br><span class=\"line\"><span class=\"comment\">## flume-hdfs-sink-1.9.0.jar</span></span><br><span class=\"line\"><span class=\"comment\">## 采用HDFSEventSink，将KafkaChannel中的数据写入到HDFS中，以日期和小时来切割文件，即每天的每个小时生成一个子目录</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.type</span> = <span class=\"string\">hdfs</span></span><br><span class=\"line\"><span class=\"comment\"># 配置hdfs路径，按照日期和小时切割文件</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.path</span> = <span class=\"string\">hdfs://localhost:9000/kafka-flume-hdfs/%Y-%m-%d/%H</span></span><br><span class=\"line\"><span class=\"comment\"># 文件前缀</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.filePrefix</span> = <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"comment\"># 正在接收数据写操作的临时文件后缀</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.inUseSuffix</span> = <span class=\"string\">.tmp</span></span><br><span class=\"line\"><span class=\"comment\"># 文件归档为目标文件的文件后缀名</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.fileSuffix</span> = <span class=\"string\">.txt</span></span><br><span class=\"line\"><span class=\"comment\"># 使用本地时间</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.useLocalTimeStamp</span> = <span class=\"string\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 若以时间切割文件时，滚动为目标文件之前的最大时间间隔，单位秒</span></span><br><span class=\"line\"><span class=\"comment\"># 如果为0，则表示不根据时间来滚动文件</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.rollInverval</span> = <span class=\"string\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 若以大小切割文件时，滚动为目标文件之前的最多字节数</span></span><br><span class=\"line\"><span class=\"comment\"># 如果为0，则表示不根据临时文件大小来滚动文件</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.rollSize</span> = <span class=\"string\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置当事件数据达到该数量时，将临时文件滚动成目标文件</span></span><br><span class=\"line\"><span class=\"comment\"># 如果为0，表示不根据事件数据来滚动文件</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.rollCount</span> = <span class=\"string\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 每个批次刷新到HDFS上的事件数量</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.batchSize</span> = <span class=\"string\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 文件格式，默认为SequenceFile</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.fileType</span> = <span class=\"string\">DataStream</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 写sequence文件的格式，默认Writable</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.writeFormat</span> = <span class=\"string\">Text</span></span><br><span class=\"line\"><span class=\"comment\"># 配置当前被打开的临时文件在该参数指定的时间内，没有任何数据写入时则将该临时文件关闭并重命名为目标文件</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.idleTimeout</span> = <span class=\"string\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 接收器启动操作HDFS的线程数，默认10</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.threadsPoolSize</span> = <span class=\"string\">15</span></span><br><span class=\"line\"><span class=\"comment\"># 执行HDFS操作的超时时间，默认10s</span></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.hdfs.callTimeout</span> = <span class=\"string\">60000</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">agent1.sinks.hdfsSink.channel</span> = <span class=\"string\">kafka-channel</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h3><p>首先要启动zookeeper和kafka</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">zookeeper-server-start /usr/local/etc/kafka/zookeeper.properties &amp; kafka-server-start /usr/local/etc/kafka/server.properties &amp;</span><br></pre></td></tr></table></figure>\n\n<p>然后启动hadoop(hadoop的启动要在start-all.sh所在目录启动)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">./start-all.sh</span><br></pre></td></tr></table></figure>\n\n<p>最后启动flume</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">flume-ng agent -c /usr/local/Cellar/flume/1.9.0_1/libexec/conf -f conf/kafka-flume-hdfs-conf.properties --name agent1</span><br></pre></td></tr></table></figure>\n\n<p>使用kafka发送数据</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-console-producer --bootstrap-server localhost:9092 --topic kafka-flume</span><br></pre></td></tr></table></figure>\n\n<p>可以查看通道中是否包含数据</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-run-class kafka.tools.DumpLogSegments --files /usr/local/var/lib/kafka-logs/kafka-channel-0/00000000000000000000.log --print-data-log</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看hdfs数据\"><a href=\"#查看hdfs数据\" class=\"headerlink\" title=\"查看hdfs数据\"></a>查看hdfs数据</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">hdfs dfs -cat /kafka-flume-hdfs/2020-10-26/15/test.1603698368703.txt</span><br></pre></td></tr></table></figure>\n\n","categories":["flume"],"tags":["flume"]},{"title":"接收处理器","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume/%E6%8E%A5%E6%94%B6%E5%A4%84%E7%90%86%E5%99%A8/","content":"<h2 id=\"接收处理器\"><a href=\"#接收处理器\" class=\"headerlink\" title=\"接收处理器\"></a>接收处理器</h2><p>可以使用接收处理器来创建sink组，进而实现故障转移和负载均衡的功能，官方提供了三种处理器，Default Sink Processor、Failover Sink Processor、Load balancing Sink Processor，可以使用Failover Sink Processor来完成故障转移，使用Load balancing Sink Processor来完成负载均衡</p>\n<a id=\"more\"></a>\n\n<p>Default Sink Processormore的处理器只能接收一个接收器，不能创建sink组</p>\n<h3 id=\"故障转移\"><a href=\"#故障转移\" class=\"headerlink\" title=\"故障转移\"></a>故障转移</h3><p>Flume提供了故障转移功能，通过为接收器Processor配置维护一个优先级列表，以保证每一个有效事件都能够处理。通过processor.type来指定是故障转移还是负载均衡，failover表示故障转移</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 声明sink组</span></span><br><span class=\"line\"><span class=\"meta\">a1.sinkgroups</span> = <span class=\"string\">g1</span></span><br><span class=\"line\"><span class=\"meta\">a1.sinkgroups.g1.sinks</span> = <span class=\"string\">k1 k2</span></span><br><span class=\"line\"><span class=\"comment\"># 配置处理器类型为故障转移</span></span><br><span class=\"line\"><span class=\"meta\">a1.sinkgroups.g1.processor.type</span> = <span class=\"string\">failover</span></span><br><span class=\"line\"><span class=\"comment\"># 配置优先级，数值越大优先级越高，只有优先级高的挂掉之后才会给优先级低的发送</span></span><br><span class=\"line\"><span class=\"meta\">a1.sinkgroups.g1.processor.priority.k1</span> = <span class=\"string\">5</span></span><br><span class=\"line\"><span class=\"meta\">a1.sinkgroups.g1.processor.priority.k2</span> = <span class=\"string\">10</span></span><br><span class=\"line\"><span class=\"comment\"># 挂掉之后多长时间不考虑该sink</span></span><br><span class=\"line\"><span class=\"meta\">a1.sinkgroups.g1.processor.maxpenalty</span> = <span class=\"string\">10000</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h3><p>Flume提供了负载均衡功能，提供了轮询(round_robin)和随机(random)两种策略，可以通过processor.selector属性指定</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">a1.sinkgroups</span> = <span class=\"string\">g1</span></span><br><span class=\"line\"><span class=\"meta\">a1.sinkgroups.g1.sinks</span> = <span class=\"string\">k1 k2</span></span><br><span class=\"line\"><span class=\"comment\"># 配置处理器类型为负载均衡</span></span><br><span class=\"line\"><span class=\"meta\">a1.sinkgroups.g1.processor.type</span> = <span class=\"string\">load_balance</span></span><br><span class=\"line\"><span class=\"meta\">a1.sinkgroups.g1.processor.backoff</span> = <span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"comment\"># 配置策略为随机</span></span><br><span class=\"line\"><span class=\"meta\">a1.sinkgroups.g1.processor.selector</span> = <span class=\"string\">random</span></span><br></pre></td></tr></table></figure>\n\n","categories":["flume"],"tags":["flume"]},{"title":"kafka streams","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%20Streams/","content":"<h2 id=\"kafka-Streams\"><a href=\"#kafka-Streams\" class=\"headerlink\" title=\"kafka Streams\"></a>kafka Streams</h2><p>kafka Streams是一个用来构建流处理程序的java库，基于Kafka的分区水平扩展来对数据进行有序高效的处理，利用kafka的并发模型来实现透明的负载均衡。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"可以解决的问题\"><a href=\"#可以解决的问题\" class=\"headerlink\" title=\"可以解决的问题\"></a>可以解决的问题</h3><ul>\n<li>一次一件事件的处理而不是微批处理</li>\n<li>有状态的处理，包括连接操作(join)和聚合类操作</li>\n<li>提供了必要的流处理原语，包括高级流处理DSL和低级处理器API<ul>\n<li>高级流处理DSL 提供了常用流处理变换操作</li>\n<li>低级流处理API  支持客户端自定义处理器并与状态仓库交互</li>\n</ul>\n</li>\n<li>使用类似于DataFlow的模型来处理乱序数据的时间窗口问题</li>\n<li>分布式处理，并且有容错机制，可以快速地实现容错</li>\n<li>有重新处理数据的能力</li>\n</ul>\n<h3 id=\"基本概念\"><a href=\"#基本概念\" class=\"headerlink\" title=\"基本概念\"></a>基本概念</h3><h4 id=\"流\"><a href=\"#流\" class=\"headerlink\" title=\"流\"></a>流</h4><p>流(stream)是kafka Streams提供的最重要的抽象，它代表的是一个无限的、不断更新的数据集。</p>\n<p>一个流就是由一个有序的、可重放的、支持故障转移的不可变的数据记录序列，其中每个记录被定义为一个键值对。</p>\n<h4 id=\"流处理器\"><a href=\"#流处理器\" class=\"headerlink\" title=\"流处理器\"></a>流处理器</h4><p>一个流处理器(stream processor)是处理拓扑的一个节点，它代表了拓扑中的处理步骤。一个流处理器从它所在的拓扑上游接收数据，通过kafka streams提供的流处理的基本方法，如map()、filter()、join()以及聚合等方法，对数据进行处理，然后将处理后的一个或多个输出结果发送给下游流处理器。一个拓扑中的流处理器当中有Source处理器和Sink处理器两个特殊的流处理器。</p>\n<ul>\n<li>Source处理器：在一个处理拓扑中该处理器没有任何上游处理器。该处理器从kafka的一个或多个主题消费数据作为处理拓扑的输入流，将该输入流发送到下游处理器。</li>\n<li>Sink处理器：在一个处理拓扑中该处理器没有任何下游处理器。该处理器将从上游处理器接收到的任何数据发送到指定的主题当中。</li>\n</ul>\n<h4 id=\"处理器拓扑\"><a href=\"#处理器拓扑\" class=\"headerlink\" title=\"处理器拓扑\"></a>处理器拓扑</h4><p>处理器拓扑(processor topology)是流处理应用程序进行数据处理的计算逻辑。一个处理器拓扑是由流处理器和相连接的流组成的有向无环图，其中流处理器是图的节点，流是图的边。</p>\n<p>kafka提供两种定义流处理拓扑的API。</p>\n<ul>\n<li>kafka streams DSL API：提供了一些开箱即用的数据转换操作算子，如map、filter、join和聚合类算子，操作简单，但是不够灵活</li>\n<li>Low-Level Processor API：允许开发者自定义处理器，构造处理器拓扑，还可以与状态仓库进行交互操作。由于可定制处理器，该类API相对来说更加灵活，开发者根据自己业务需要定制开发相应的处理逻辑，但同时涉及底层的操作处理，开发成本相对较高</li>\n</ul>\n<h4 id=\"时间\"><a href=\"#时间\" class=\"headerlink\" title=\"时间\"></a>时间</h4><p>流处理定义了通用3种类型的时间</p>\n<ul>\n<li>事件时间(event time)：指事件或数据记录产生的时间，即kafka消息源对应的时间</li>\n<li>处理时间(processing time)：指事件或数据记录被流处理应用处理的时间点，也就是对消息源进行处理时的时间。处理时间一般晚于事件时间。</li>\n<li>摄入时间(ingestion time)：指消息被处理后保存到kafka主题时间。有可能消息不会被处理而直接保存到主题当中，此时指的是存储时间。</li>\n</ul>\n<p>kafka有时间戳类型，每条消息都会被附加一个时间戳，可以根据配置来设置消息的时间戳类型。通过message.timestamp.type配置来设置时间戳类型是LogAppendTime还是CreateTime，分别对应处理时间和存储时间。</p>\n<p>Kafka Streams通过TimestampExtractor接口给每个数据记录赋一个时间戳，开发者可以根据不同的需要来确定时间戳的实现。每个数据记录赋予时间戳之后就可以对数据进行聚合操作，实现窗口功能，能够方便地解决数据乱序的问题。</p>\n<h4 id=\"状态\"><a href=\"#状态\" class=\"headerlink\" title=\"状态\"></a>状态</h4><p>一些流处理并不关注状态，即对每个消息的处理都是相互独立的，如对消息进行简单的转换操作或者基于某些条件对消息进行筛选操作等。</p>\n<p>某些场景可能需要保存流处理的中间结果，即流的中间状态。同时保存状态的话可以提供更多复杂的操作，如对流进行join，group和聚合操作等。Kafka Streams DSL提供了很多这样的包含状态的DSL。Kafka Streams提供了一种状态仓库，被流处理应用用来存储和查询状态数据，默认状态存储在本地RocksDB当中，存储路径通过参数state.dir配置，默认路径是/tmp/kafka-streams。Kafka Streams的每个Task使用一个或多个状态仓库，可通过API来访问和存储流处理需要的数据。这种状态仓库可以是持久化的键值对引擎，也可以是内存中的HashMap或其他方便合理的数据结构。</p>\n<p>Kafka Streams对本地状态仓库提供了容错和自动恢复，这是由于本地状态本身是通过kafka进行复制的，所以当一个机器出现故障时，其他机器可以自动恢复本地状态，并且从故障出错点继续处理。</p>\n<h4 id=\"KStream和KTable\"><a href=\"#KStream和KTable\" class=\"headerlink\" title=\"KStream和KTable\"></a>KStream和KTable</h4><p>Kafka Stream定义了KStream和KTable两种基本抽象。两者的区别在于，KStream是一个由键值对构成的抽象记录流，每个键值对是一个独立单元，即使相同的key也不会被覆盖，类似数据库的插入操作；KTable可以理解为一个基于表主键的日志更新流，相同key的每条记录只保存最新的一条记录，类似数据库基于主键更新。</p>\n<p>无论是记录流(用KStream定义)还是更新日志流(用KTable定义)，都可以从一个或多个Kafka主题数据源来创建。一个KStream可以与另一个KStream或者KTable进行join操作，或者聚合成一个KTable，一个KTable也可以转换成一个KStream。KStream和KTable都提供了一系列的转换操作，每个转换操作都可以转化为一个KStream或者KTable对象，将这些转换操作连接在一起就构成了一个处理器拓扑。</p>\n<h4 id=\"窗口\"><a href=\"#窗口\" class=\"headerlink\" title=\"窗口\"></a>窗口</h4><p>对流处理时可能需要把数据记录按时间分组。窗口是流处理状态转换操作的基本条件，一个窗口相关操作通常需要存储中间状态，根据窗口的设置旧的状态在窗口中持续时间大于窗口大小之后就会被删除。一个窗口包括<strong>窗口大小</strong>和<strong>滑动步长</strong>两个属性。</p>\n<p><strong>窗口大小</strong>是指一条记录在窗口中持续的时间，持续时间超过窗口大小的记录就会被删除。</p>\n<p><strong>滑动步长</strong>指定了一个窗口每次相对于前一个窗口向前移动的距离。滑动步长不可以大于窗口大小，否则会导致部分记录不属于任何窗口而不被处理。</p>\n<h5 id=\"跳跃时间窗口\"><a href=\"#跳跃时间窗口\" class=\"headerlink\" title=\"跳跃时间窗口\"></a>跳跃时间窗口</h5><p>滑动步长小于窗口大小，基于时间间隔，大小固定，可能会重叠的窗口模型。</p>\n<h5 id=\"翻转时间窗口\"><a href=\"#翻转时间窗口\" class=\"headerlink\" title=\"翻转时间窗口\"></a>翻转时间窗口</h5><p>滑动步长等于窗口大小，基于时间间隔，大小固定，不可重叠，无间隙的窗口模型。一条记录仅属于唯一的窗口。</p>\n<h5 id=\"滑动窗口\"><a href=\"#滑动窗口\" class=\"headerlink\" title=\"滑动窗口\"></a>滑动窗口</h5><p>大小固定并沿着时间轴连续滑动的窗口模型。如果两条数据的时间戳之差在窗口大小之内，则两条数据记录属于同一个窗口。</p>\n<h3 id=\"使用介绍\"><a href=\"#使用介绍\" class=\"headerlink\" title=\"使用介绍\"></a>使用介绍</h3><h4 id=\"maven依赖\"><a href=\"#maven依赖\" class=\"headerlink\" title=\"maven依赖\"></a>maven依赖</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.kafka<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>kafka-streams<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.6.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"KStream-与-KTable\"><a href=\"#KStream-与-KTable\" class=\"headerlink\" title=\"KStream 与 KTable\"></a>KStream 与 KTable</h4><h5 id=\"KStream\"><a href=\"#KStream\" class=\"headerlink\" title=\"KStream\"></a>KStream</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">KStreamTest</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Properties prop = init();</span><br><span class=\"line\">        StreamsBuilder builder = <span class=\"keyword\">new</span> StreamsBuilder();</span><br><span class=\"line\">        <span class=\"comment\">// 构造kstream日志流（数据来源来自  kafka的主题stream-input）</span></span><br><span class=\"line\">        KStream&lt;String,String&gt; source = builder.stream(<span class=\"string\">&quot;stream-input&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 打印到控制台</span></span><br><span class=\"line\">        source.print(Printed.&lt;String, String&gt;toSysOut());</span><br><span class=\"line\">        Topology topology = builder.build();</span><br><span class=\"line\">        System.out.println(topology.describe());</span><br><span class=\"line\">        <span class=\"keyword\">final</span> KafkaStreams kafkaStreams = <span class=\"keyword\">new</span> KafkaStreams(topology,prop);</span><br><span class=\"line\">        <span class=\"keyword\">final</span> CountDownLatch latch = <span class=\"keyword\">new</span> CountDownLatch(<span class=\"number\">1</span>);</span><br><span class=\"line\">        Runtime.getRuntime().addShutdownHook(<span class=\"keyword\">new</span> Thread(<span class=\"string\">&quot;hook&quot;</span>)&#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;线程停止&quot;</span>);</span><br><span class=\"line\">                kafkaStreams.close();</span><br><span class=\"line\">                latch.countDown();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            kafkaStreams.start();</span><br><span class=\"line\">            latch.await();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InterruptedException e)&#123;</span><br><span class=\"line\">            System.exit(<span class=\"number\">1</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;项目终止&quot;</span>);</span><br><span class=\"line\">        System.exit(<span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Properties <span class=\"title\">init</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">        <span class=\"comment\">// 流处理应用的id，必须指定</span></span><br><span class=\"line\">        properties.put(StreamsConfig.APPLICATION_ID_CONFIG,<span class=\"string\">&quot;KStream-test&quot;</span>);</span><br><span class=\"line\">        properties.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG,<span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">// key序列化反序列化</span></span><br><span class=\"line\">        properties.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());</span><br><span class=\"line\">        <span class=\"comment\">//value序列化反序列化</span></span><br><span class=\"line\">        properties.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG,Serdes.String().getClass());</span><br><span class=\"line\">        properties.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class=\"string\">&quot;earliest&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> properties;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"> kafka-console-producer --bootstrap-server localhost:9092 --topic stream-input --property parse.key=true                         </span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">aa    bb</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">aa    cc</span></span><br><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">aa    dd</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight markdown\"><table><tr><td class=\"code\"><pre><span class=\"line\">[<span class=\"symbol\">KSTREAM-SOURCE-0000000000</span>]: <span class=\"link\">aa, bb</span></span><br><span class=\"line\">[<span class=\"symbol\">KSTREAM-SOURCE-0000000000</span>]: <span class=\"link\">aa, cc</span></span><br><span class=\"line\">[<span class=\"symbol\">KSTREAM-SOURCE-0000000000</span>]: <span class=\"link\">aa, dd</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"KTable\"><a href=\"#KTable\" class=\"headerlink\" title=\"KTable\"></a>KTable</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 构造kstream日志流（数据来源来自  kafka的主题stream-input）</span></span><br><span class=\"line\">KTable&lt;String,String&gt; kTable = builder.table(<span class=\"string\">&quot;stream-input&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"计数程序\"><a href=\"#计数程序\" class=\"headerlink\" title=\"计数程序\"></a>计数程序</h4><p>此程序是用来进行统计value出现的次数的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestCount</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        Properties prop = init();</span><br><span class=\"line\">        StreamsBuilder builder = <span class=\"keyword\">new</span> StreamsBuilder();</span><br><span class=\"line\">        KStream&lt;String,String&gt; stream = builder.stream(<span class=\"string\">&quot;testCountInputTopic&quot;</span>);</span><br><span class=\"line\">        stream.print(Printed.toSysOut());</span><br><span class=\"line\">        KTable&lt;String,Long&gt; table = stream</span><br><span class=\"line\"><span class=\"comment\">//                .flatMapValues(line -&gt; Arrays.asList(line.split(&quot;\\\\t&quot;)))</span></span><br><span class=\"line\">                .groupBy((key,value) -&gt; value)</span><br><span class=\"line\">                <span class=\"comment\">//指定状态仓库的名称  （路径默认在/tmp/kafka-streams中）防止重启之后数据从头开始</span></span><br><span class=\"line\">                .count(Materialized.as(<span class=\"string\">&quot;counts-store&quot;</span>));</span><br><span class=\"line\">        <span class=\"comment\">// 指定序列化</span></span><br><span class=\"line\">        table.toStream().to(<span class=\"string\">&quot;testCountOutputTopic&quot;</span>, Produced.with(Serdes.String(),Serdes.Long()));</span><br><span class=\"line\">        KafkaStreams kafkaStreams = <span class=\"keyword\">new</span> KafkaStreams(builder.build(),prop);</span><br><span class=\"line\">        kafkaStreams.start();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Properties <span class=\"title\">init</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">        <span class=\"comment\">// 流处理应用的id，必须指定</span></span><br><span class=\"line\">        properties.put(StreamsConfig.APPLICATION_ID_CONFIG,<span class=\"string\">&quot;KStream-test&quot;</span>);</span><br><span class=\"line\">        properties.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG,<span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">// key序列化反序列化</span></span><br><span class=\"line\">        properties.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());</span><br><span class=\"line\">        <span class=\"comment\">//value序列化反序列化</span></span><br><span class=\"line\">        properties.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG,Serdes.String().getClass());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> properties;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka简介","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E7%AE%80%E4%BB%8B/","content":"<p>kafka是一个高吞吐量、分布式的发布-订阅系统，核心模块使用Scala语言开发，开源的、轻量级的、分布式的、可分区和有复制备份的、基于zookeeper协调管理的分布式流平台的功能强大的消息系统。  </p>\n<a id=\"more\"></a>\n\n<h2 id=\"基本结构\"><a href=\"#基本结构\" class=\"headerlink\" title=\"基本结构\"></a>基本结构</h2><p>生产者负责生产消息，将消息写入kafka集群。<br>消费者从kafka集群中拉取消息。</p>\n<h2 id=\"基本概念\"><a href=\"#基本概念\" class=\"headerlink\" title=\"基本概念\"></a>基本概念</h2><ul>\n<li><strong>主题</strong>  kafka将一组消息抽象归纳为一个主题(Topic)，生产者将消息发送到特定主题，消费者订阅主题或主题的某些分区来进行消费。</li>\n<li><strong>消息</strong>  消息(Record)是kafka通信的基本单位，由一个固定长度的消息头和一个可变长度的消息体构成</li>\n<li><strong>分区</strong>  每个主题分为一个或多个分区(Partition)。每个分区由一系列有序、不可变的消息组成，是一个有序队列。每个分区在物理上对应为一个文件夹，分区命名规则为主题名称后接”-“连接符，之后再接分区编号，分区编号从0开始，编号最大值为分区总数减一。  分区数越多吞吐量越高，分区是kafka保证消息被顺序消费以及对消息进行负载均衡的基础。kafka只能保证一个分区之内消息的有序性，并不能保证跨分区消息的有序性。</li>\n<li><strong>副本</strong>  每个分区有一个或多个副本(Replica)，分区的副本分布在集群的不同代理上，以提高可用性。从存储角度上分析，分区的每个副本在逻辑上抽象为一个日志对象，一一对应。</li>\n<li><strong>Leader副本和Follower副本</strong>  由于kafka副本的存在，需要保证一个分区的多个副本之间的数据一致性，kafka会选择该分区的一个副本作为Leader副本，其他副本为Follower副本，只有Leader副本才负责处理客户端读写请求，Follower只负责从Leader副本同步数据</li>\n<li><strong>偏移量</strong>  任何发布到分区的消息会被直接追加到日志文件(分区目录下一”.log”后缀的文件)的尾部，而每条消息在日志文件中的位置都会对应一个按序递增的偏移量。偏移量是一个分区下严格有序的逻辑值，消费者可以通过控制消息偏移量来对消息进行消费。</li>\n<li><strong>日志段</strong>  一个日志又被划分为多个日志段(LogSegment)，日志段是kafka日志对象分片的最小单位。一个日志段对应磁盘上一个具体日志文件和两个索引文件。两个索引文件分别是”.index”和”.timeindex”，分别表示消息偏移量索引文件和消息时间戳索引文件</li>\n<li><strong>代理</strong>  kafka集群就是有一个或多个kafka实例构成的，我们将每个kafka实例称为代理(Broker)，也称之为kafka服务器(kafkaServer)，kafka集群一般包括一台或多台服务器，可以在一台服务器上配置一个或多个代理。每一个代理都有唯一标识id，在一个kafka集群中，每增加一个代理就需要为这个代理配置一个与该集群中其他代理不同的id，保证在整个kafka集群中唯一，这个id就是代理的名字，就是broker.id</li>\n<li><strong>生产者</strong> 生产者(Producer)负责将消息发送给代理</li>\n<li><strong>消费者和消费者组</strong>  消费者(Comsumer)以拉取(pull)的方式拉取数据，在kafka中每一个消费者都属于一个消费者组(CommsumerGroup)，可以为每个消费者指定一个消费者组，通过group.id配置，每个消费者也有一个全局唯一的id，通过client.id配置，如果没有指定client.id，会默认生成，格式为${groupId}-${hostName}-${timestamp}-${UUID前8位}，同一个主题的一条消息只能被通一个消费者组下的某一个消费者消费，但不同的消费者组的消费者可同时消费该消息。消费者组是kafka用来实现对一个主题消息进行广播和单播的手段，实现消息广播只需执行各消费者均属于不同的消费者组，消息单播只需让各消费者属于同一个消费者组。</li>\n<li><strong>ISR</strong>  kafka在zookeeper中动态维护了一个ISR(In-sync-Replica)，即保持同步的副本列表，该列表中保存的是与Leader副本保持消息同步的所有副本对应的代理节点id，如果一个Follower副本宕机或落后太多，该节点会从ISR列表中移除。</li>\n<li><strong>zookeeper</strong>  kafka利用zookeeper保存相关元数据信息，包括代理节点信息、kafka集群信息、消费偏移量信息、主题信息、分区状态信息、分区副本分配方案信息、动态配置信息等。kafka在启动或运行过程中会在zookeeper上创建相应节点来保存元数据信息，kafka通过监听机制在这些节点注册相应监听器来监听节点元数据变化，从而由zookeeper负责管理和维护kafka集群</li>\n</ul>\n<h2 id=\"kafka特性\"><a href=\"#kafka特性\" class=\"headerlink\" title=\"kafka特性\"></a>kafka特性</h2><ul>\n<li><strong>消息持久化</strong>  依赖于文件系统来存储和缓存消息</li>\n<li><strong>高吞吐量</strong></li>\n<li><strong>扩展性</strong></li>\n<li><strong>多客户端支持</strong></li>\n<li><strong>kafka streams</strong>  流处理</li>\n<li><strong>安全机制</strong>  </li>\n<li><strong>数据备份</strong></li>\n<li><strong>轻量级</strong></li>\n<li><strong>消息压缩</strong>  支持Gzip、Snappy、LZ4三种压缩方式，把多条消息放在一起组成MessageSet，再把MessageSet放到一条消息中，从而提高压缩比率来提高吞吐量。<h2 id=\"应用场景\"><a href=\"#应用场景\" class=\"headerlink\" title=\"应用场景\"></a>应用场景</h2>消息队列用来解决应用解耦、异步通信、流量控制等问题  </li>\n<li>消息系统</li>\n<li>应用监控</li>\n<li>网站用户行为追踪</li>\n<li>流处理</li>\n<li>持久性日志</li>\n</ul>\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka自定义组件","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6/","content":"<p>kafka对于部分配置提供了统一接口，允许用户自定义接口实现，根据业务需求进行定制，如自定义分区器以及序列化反序列化</p>\n<a id=\"more\"></a>\n\n<h3 id=\"自定义分区器\"><a href=\"#自定义分区器\" class=\"headerlink\" title=\"自定义分区器\"></a>自定义分区器</h3><p>kafka的默认分区策略可能不能很傲的满足业务需求，可以需要根据kafka提供的API开发定制满足业务场景的分区策略，自定义一个分区器</p>\n<ul>\n<li><p>实现org.apache.kafka.clients.producer.Partitioner接口，重写该接口的partition方法，在该方法中实现分区分配的算法</p>\n</li>\n<li><p>实例化KafkaProducer的配置中指定partitioner.class为自定义的分区器</p>\n</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 自定义分区器</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomPartition</span> <span class=\"keyword\">implements</span> <span class=\"title\">Partitioner</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Integer PARTITIONS = <span class=\"number\">6</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">partition</span><span class=\"params\">(String topic, Object key, <span class=\"keyword\">byte</span>[] keyBytes, Object value, <span class=\"keyword\">byte</span>[] valueBytes, Cluster cluster)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 如果key为null，采用默认分区</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (key == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;key为null,采用默认分区&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> DefaultPartitioner().partition(topic, key, keyBytes, value, valueBytes, cluster);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            String code = String.valueOf(key);</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">int</span> partitionId = code.hashCode() % PARTITIONS;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;-----------&quot;</span> + code.hashCode() + <span class=\"string\">&quot;-----------------&quot;</span> + partitionId);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> partitionId;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                System.out.println(<span class=\"string\">&quot;分区出现异常，采用分区0&quot;</span> + e.getMessage());</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">close</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configure</span><span class=\"params\">(Map&lt;String, ?&gt; configs)</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestPartition</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 设置生产消息的总数</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> MSG_SIZE = <span class=\"number\">10</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 主题名称</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_NAME = <span class=\"string\">&quot;test-topic&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> KafkaProducer&lt;String, String&gt; producer;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        Properties properties = initConfig();</span><br><span class=\"line\">        producer = <span class=\"keyword\">new</span> KafkaProducer&lt;String, String&gt;(properties);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 初始化kafka配置</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Properties <span class=\"title\">initConfig</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br><span class=\"line\">        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br><span class=\"line\">        <span class=\"comment\">// 配置分区器</span></span><br><span class=\"line\">        properties.put(ProducerConfig.PARTITIONER_CLASS_CONFIG,CustomPartition.class.getName());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> properties;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        ProducerRecord&lt;String, String&gt; record = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; MSG_SIZE; i++) &#123;</span><br><span class=\"line\">                record = <span class=\"keyword\">new</span> ProducerRecord&lt;&gt;(TOPIC_NAME,<span class=\"string\">&quot;分区消息key&quot;</span>+i,<span class=\"string\">&quot;分区消息体&quot;</span>+i);</span><br><span class=\"line\">                producer.send(record);</span><br><span class=\"line\">                Thread.sleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            producer.close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"自定义序列化\"><a href=\"#自定义序列化\" class=\"headerlink\" title=\"自定义序列化\"></a>自定义序列化</h3><p>需要实现org.apache.kafka.common.serialization.Serializer接口</p>\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka客户端流程分析","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kakfa%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/","content":"<h2 id=\"生产者\"><a href=\"#生产者\" class=\"headerlink\" title=\"生产者\"></a>生产者</h2><h3 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h3><a id=\"more\"></a>\n\n<h3 id=\"发送消息\"><a href=\"#发送消息\" class=\"headerlink\" title=\"发送消息\"></a>发送消息</h3><ul>\n<li><p>拉取元数据</p>\n<p>sender线程拉取，主线程等待(使用version和上一次版本号进行比较，来等待sender线程唤醒或者时间超时)</p>\n<p>RecordAccumulator缓存区有一个对象batches，存在多个队列，每个队列代表一个分区</p>\n</li>\n</ul>\n<p>sender线程<br>NetWorkClient   Selector  KafkaChannel  NIO<br>kafka发消息只会发送到leader  partition</p>\n","categories":["kafka"],"tags":["kafka"]},{"title":"scala简介","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/scala/scala%E7%AE%80%E4%BB%8B/","content":"<h2 id=\"scala简介\"><a href=\"#scala简介\" class=\"headerlink\" title=\"scala简介\"></a>scala简介</h2><p>由于大数据的兴起，spark的使用越来越多，然而带动了scala语言的兴起</p>\n","categories":["scala"],"tags":["scala"]},{"title":"spark简介","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/spark/spark%E7%AE%80%E4%BB%8B/","content":"<h2 id=\"spark简介\"><a href=\"#spark简介\" class=\"headerlink\" title=\"spark简介\"></a>spark简介</h2><p>spark是一个快速、通用的计算引擎，Apache Spark 是专为大规模数据处理而设计的快速通用的计算引擎。Spark是UC Berkeley AMP lab (加州大学伯克利分校的AMP实验室)所开源的类Hadoop MapReduce的通用并行框架，<a id=\"more\"></a>Spark，拥有Hadoop MapReduce所具有的优点；但不同于MapReduce的是——Job中间输出结果可以保存在内存中，从而不再需要读写HDFS，因此Spark能更好地适用于数据挖掘与机器学习等需要迭代的MapReduce的算法。<br>Spark 是一种与 Hadoop 相似的开源集群计算环境，但是两者之间还存在一些不同之处，这些有用的不同之处使 Spark 在某些工作负载方面表现得更加优越，换句话说，Spark 启用了内存分布数据集，除了能够提供交互式查询外，它还可以优化迭代工作负载。<br>Spark 是在 Scala 语言中实现的，它将 Scala 用作其应用程序框架。与 Hadoop 不同，Spark 和 Scala 能够紧密集成，其中的 Scala 可以像操作本地集合对象一样轻松地操作分布式数据集。<br>尽管创建 Spark 是为了支持分布式数据集上的迭代作业，但是实际上它是对 Hadoop 的补充，可以在 Hadoop 文件系统中并行运行。通过名为 Mesos 的第三方集群框架可以支持此行为，spark可用来构建大型的、低延迟的数据分析应用程序。</p>\n<h3 id=\"spark构成\"><a href=\"#spark构成\" class=\"headerlink\" title=\"spark构成\"></a>spark构成</h3><p>spark生态圈包括Spark的任务调度、内存管理、容错机制等功能</p>\n<ul>\n<li>Spark SQL：使Spark处理结构化数据，支持通过SQL查询数据，类似于hive SQL，并且支持多数据源</li>\n<li>Spark Streaming：用于实时流处理组件，Spark Streaming支持Kafka、Flume、ZeroMQ、HDFS等多种数据输入源，使用诸如map()、join()、window()等高级函数进行处理，并支持将处理后的最终结果存储到文件系统、数据库等。</li>\n<li>MLib：用于机器学习，包括机器学习通过的算法库，如分类、聚类、回归及协同过滤等算法，还包括模型评估及数据导入等。</li>\n<li>GraphX：分布试图处理框架，提供与图计算和图挖掘相关的接口，包括常用图计算的算法。</li>\n</ul>\n<p>Spark 将内存数据抽象为弹性分布式数据集(resilient distributed dataset，RDD)，可以理解为RDD是Spark分布式计算的数据结构，表示一个不可变、可分区、可并行操作、有容错机制的数据集合。</p>\n<p>而Spark Streaming则提供了一个叫做DStream(Discretized Stream)的高级抽象，DStream表示一个持续不断输入的数据流，一个DStream实际上是由一个RDD序列组成的，可由基于Kafka、HDFS、Flume、Socket等输入流创建。</p>\n<p>RDD提供了transformations和actions两种类型的操作。transformations操作是得到一个新的RDD，如map、filter、groupByKey、flatMap、join、union等；actions操作是得到一个值或者一个计算结果，如reduce、collect、count、take、first、saveAsTestFile等。所有的transformations操作都是采用惰性策略，只有在actions类操作被提交时才会触发执行计算，而只将transformations类操作提交时是不会触发计算的。</p>\n<p>Spark采用Master-Slave架构模式。Master对应集群中含有Master进程的节点，是Spark集群的主控节点；Slave是集群中含有Worker进程的节点，在集群模式下Worker是集群中任何可以运行Spark应用程序的节点，类似Yarn中的NodeManager节点，在基于Yarn的Spark集群模式Worker指的就是NodeManager节点，在单机模式下Worker负责管理本地节点资源，接收Master的命令进行状态汇报。</p>\n<p>Spark整体架构中还包含了Driver、Executor、Client几个角色。Driver是应用程序逻辑执行起点，负责作业的解析、生成作业stage，并将作业调度到Executor上执行；Executor是Spark应用程序运行在Worker节点上的一个进程，该进程负责运行Task，并且负责将执行状态存储在内存或者磁盘上，在Yarn模式下，进程名为CoarseGrainedExecutorBackend；Client则是客户端进程，负责提交作业到Master</p>\n<h3 id=\"spark运行模式\"><a href=\"#spark运行模式\" class=\"headerlink\" title=\"spark运行模式\"></a>spark运行模式</h3><p>Spark有五种运行模式</p>\n<ul>\n<li>本地单机模式：所有spark进程都运行在同一个JVM中。在该模式下可以通过local[n]来指定Master变量以设置并行级别，n表示线程数</li>\n<li>集群单机模式：使用Spark内置的任务调度框架，通过Spark://${mastreIP}:${port}来指定连接Spark集群</li>\n<li>基于Yarn的集群模式：Spark运行在Yarn资源管理器上，基于Hadoop，由Yarn负责资源管理，Spark负责任务调度与计算</li>\n<li>基于Mesos的集群模式：运行在Mesos资源管理器上</li>\n<li>基于Amazon EC2的集群模式：在Amazon EC2云端上部署Spark环境</li>\n</ul>\n","categories":["spark"],"tags":["spark"]},{"title":"下载spark","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/spark/%E4%B8%8B%E8%BD%BD/","content":"<p>mac上下载spark使用</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">brew install apache-spark</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>","categories":["spark"],"tags":["spark"]},{"title":"zookeeper介绍","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/zookeeper/zookeeper/","content":"<h2 id=\"为什么需要zookeeper\"><a href=\"#为什么需要zookeeper\" class=\"headerlink\" title=\"为什么需要zookeeper\"></a>为什么需要zookeeper</h2><p>对于多线程的弊端，看下图</p>\n<a id=\"more\"></a>\n\n<img src=\"/images/zookeeper/zookeeper多线程弊端.jpg\" style=\"zoom:50%;\">\n\n<p>由于多线程的运行比较难，所以把线程换成进程，相当于每台服务器上跑一个程序，相同的程序运行在多个服务器集群上，是为了解决单台服务器面对高并发处理不过来的情况<br>但是对于集群又会出现一些新的问题</p>\n<ul>\n<li>多台服务器一个集群，如何保证所有机器共享的配置信息一致</li>\n<li>有一台服务器挂掉了，其他机器如何感知</li>\n<li>用户量突然暴增，需要新增机器缓解压力，如何做到不重启集群完成机器的添加</li>\n<li>分布式系统，怎么高效协同多台服务对同一网络文件进行写操作<br>因此需要一个能让各个程序进行协同的工具  zookeeper应运而生</li>\n</ul>\n<h2 id=\"zookeeper介绍\"><a href=\"#zookeeper介绍\" class=\"headerlink\" title=\"zookeeper介绍\"></a>zookeeper介绍</h2><p>zookeeper是一个分布式服务协调组件，特点是数据存于内存中的，持久化实现在日志中。它的内存类似于树形结构，且高吞吐低延迟。<br>组成zookeeper服务的服务器必须彼此了解，它们维护内存中的状态图像，以及持久化存储中的事务日志和快照。<br>客户端连接到单个zookeeper服务器，客户端维护TCP连接，通过该连接发送请求，获取响应，获取监听事件以及发送tick。如果服务器的TCP连接中断，则客户端将连接到其他服务器。</p>\n<h2 id=\"zookeeper可以做什么\"><a href=\"#zookeeper可以做什么\" class=\"headerlink\" title=\"zookeeper可以做什么\"></a>zookeeper可以做什么</h2><ul>\n<li>主要用于分布式系统，可以用zookeeper做统一配置管理、统一命名服务、分布式锁、集群管理。</li>\n<li>使用分布式系统对节点管理</li>\n</ul>\n<h2 id=\"zookeeper数据结构\"><a href=\"#zookeeper数据结构\" class=\"headerlink\" title=\"zookeeper数据结构\"></a>zookeeper数据结构</h2><p>与Unix文件系统类似，可以看做是一棵树，以”/“为根节点，每个节点叫做ZNode，每个节点可以通过路径来标识<br>zookeeper的节点称为Znode</p>\n<img src=\"/images/zookeeper/zookeeper结构.jpg\" style=\"zoom:50%;\">\n\n\n\n<p>znode类型</p>\n<ul>\n<li>短暂/临时（Ephemeral）节点：当客户端和服务器断开连接后，所创建的Znode会自动删除（临时节点不能挂子节点，只有永久节点才可以）</li>\n<li>持久（Persistent）节点：当客户端和服务器断开连接后，所创建的Znode不会删除</li>\n<li>无序（Non-sequence）节点：多个客户端同时创建同一个无序节点时，只有一个可以创建成功，其他均失败，且节点名字与指定名完全相同</li>\n<li>有序（Sequence）节点：创建出的节点名在指定名称之后带有10位10进制的序号，多个客户端创建同一名称节点时，都能成功，只是序号不同<br>Znode包含ACL权限控制、修改/访问时间、最后一次操作的事务id（zxid）等</li>\n</ul>\n<h2 id=\"zookeeper的特点\"><a href=\"#zookeeper的特点\" class=\"headerlink\" title=\"zookeeper的特点\"></a>zookeeper的特点</h2><ul>\n<li>原子性  只有成功或失败，没有部分结果</li>\n<li>有序（顺序一致性）<br>zookeeper给每个更新贴上一个数字，这个数字反映了所有zookeeper事务的顺序<ul>\n<li>Zxid：zookeeper中每次写请求都对应一个唯一的事务id，称为Zxid，它是全局有序的，如果Zxid1小于Zxid2，那么Zxid1一定会发生在Zxid2前</li>\n<li>version numbers：版本号，对节点的写请求都会导致该节点的3种版本号增加  dataVersion（对znode数据的更改次数）， cversion（对znode子节点的更改次数），aclversion（对znode ACL的更改次数）</li>\n<li>ticks：当使用多服务器zookeeper时，服务器使用一个”滴答”来定义事件的时间，如状态上传，会话超时等，通过最小会话超时时间（默认是滴答事件*2）间接公开，如果客户端请求超过这个时间，那客户端就不能在连接上服务器端</li>\n</ul>\n</li>\n<li>唯一视图，无论连接到哪个服务器，客户端都可看到相同的内容</li>\n<li>可靠性  数据的变更不会丢失，除非被客户端覆盖修改</li>\n<li>及时性  保证系统的客户端当时读取到的数据是最新的</li>\n</ul>\n<h2 id=\"zookeeper理论\"><a href=\"#zookeeper理论\" class=\"headerlink\" title=\"zookeeper理论\"></a>zookeeper理论</h2><h3 id=\"会话机制\"><a href=\"#会话机制\" class=\"headerlink\" title=\"会话机制\"></a>会话机制</h3><ul>\n<li>一个客户端连接一个会话，由zookeeper分配唯一会话id</li>\n<li>客户端以特定的时间间隔发送心跳以保持会话有效，超过会话超时时间未收到客户端的心跳，则判断客户端无效（默认2倍tickTime）</li>\n<li>会话中请求时FIFO（先进先出原则）的顺序执行<h3 id=\"znode的数据构成\"><a href=\"#znode的数据构成\" class=\"headerlink\" title=\"znode的数据构成\"></a>znode的数据构成</h3></li>\n<li>节点数据：存储的基本信息（状态，配置，位置等）</li>\n<li>节点元数据：stat命令下的数据</li>\n<li>数据大小：限制1M<h3 id=\"znode节点类型\"><a href=\"#znode节点类型\" class=\"headerlink\" title=\"znode节点类型\"></a>znode节点类型</h3></li>\n<li>持久节点： 直接通过create path value创建</li>\n<li>临时节点：create -e path value</li>\n<li>顺序节点：create -s path value</li>\n</ul>\n<p>注：</p>\n<ul>\n<li>session会话失效时，临时节点就会被删除</li>\n<li>顺序节点的创建，每个父节点拥有一个计数器，这个计数器是有限制的，2147483647之后将溢出</li>\n<li>顺序节点在会话结束后仍存在</li>\n</ul>\n<h3 id=\"Watch监听机制\"><a href=\"#Watch监听机制\" class=\"headerlink\" title=\"Watch监听机制\"></a>Watch监听机制</h3><p>客户端能在znodes上设置watch，监听znode的变化，包括增删改查，通过stat path，ls2 path get path皆可查看<br>触发watch事件的条件有4种，create，delete，change，child（子节点事件）</p>\n<h4 id=\"监听步骤\"><a href=\"#监听步骤\" class=\"headerlink\" title=\"监听步骤\"></a>监听步骤</h4><ul>\n<li><p>任何session（s1、s2）都可以对自己感兴趣的znode监听</p>\n</li>\n<li><p>当znode通过s1对节点进行了修改</p>\n</li>\n<li><p>s1、s2都会收到znode的变更事件通知</p>\n</li>\n</ul>\n<p>  注意:</p>\n<ul>\n<li><p>仅一次性：watch触发后删除，要持续监听的话需要持续提供设置watch</p>\n</li>\n<li><p>有序性：客户端先得到watch通知才可以查看变化结果</p>\n</li>\n<li><p>一个watch对象只会被通知一次，如果一个watch同时注册了多个接口，如果此时删除节点，这个事件对多个接口都有效，但是watch只会被调用一次</p>\n</li>\n</ul>\n<h2 id=\"zookeeper拥有的功能\"><a href=\"#zookeeper拥有的功能\" class=\"headerlink\" title=\"zookeeper拥有的功能\"></a>zookeeper拥有的功能</h2><p>监视节点、通知进程、保持长连接、会话延续</p>\n<h2 id=\"zookeeper应用场景\"><a href=\"#zookeeper应用场景\" class=\"headerlink\" title=\"zookeeper应用场景\"></a>zookeeper应用场景</h2><h3 id=\"注册中心\"><a href=\"#注册中心\" class=\"headerlink\" title=\"注册中心\"></a>注册中心</h3><h4 id=\"zookeeper作为注册中心\"><a href=\"#zookeeper作为注册中心\" class=\"headerlink\" title=\"zookeeper作为注册中心\"></a>zookeeper作为注册中心</h4><ul>\n<li>依赖于临时节点</li>\n<li>服务提供者启动时，将服务名称，ip地址注册到配置中心</li>\n<li>服务消费者启动的时候，会先去注册中心中全量拉取服务的注册列表，缓存到本地，当消费者调用服务时，不会再去请求注册中心，直接通过负载均衡算法从ip列表中取出一个ip进行调用</li>\n<li>当服务提供者下线（上线），相应的ip会从服务提供者列表中移除（新增），注册中心会将服务ip列表发送给服务消费者，刷新缓存</li>\n<li>感知服务上下线（心跳检测，定时向服务提供者发送请求，确认是否在线）</li>\n</ul>\n<h4 id=\"注册中心对比\"><a href=\"#注册中心对比\" class=\"headerlink\" title=\"注册中心对比\"></a>注册中心对比</h4><p>关系型数据库遵循的原则：ACID原则 （A:原子性 C:一致性 I:独立性 D:持久性）<br>非关系型数据库遵循的原则：CAP原则 （C:强一致性 A:可用性 P:分区容错性）  </p>\n<p>Eureka保证AP<br>zookeeper保证CP  </p>\n<h3 id=\"分布式协调\"><a href=\"#分布式协调\" class=\"headerlink\" title=\"分布式协调\"></a>分布式协调</h3><p>以mq举例，A系统发个请求到mq，B系统消息消费之后处理了。A系统如何知道B系统的处理结果？<br>使用zookeeper实现分布式系统之间的协调工作。A系统发送请求知乎可以在zookeeper上对某个节点的值注册个监听器，一旦B系统处理完了之后就修改zookeeper那个节点的值，A系统就可以收到通知</p>\n<h3 id=\"分布式锁\"><a href=\"#分布式锁\" class=\"headerlink\" title=\"分布式锁\"></a>分布式锁</h3><ul>\n<li>依赖于临时顺序节点</li>\n<li>三个系统A/B/C都去访问locks节点，访问的时候会创建带顺序号的临时/短暂节点，（例如，A创建了id_0000节点，B创建了id_0001节点，C创建了id_0002节点）</li>\n<li>拿到/locks节点下的所有子节点（id_0000，id_0001，id_0002），判断自己创建的是不是最小的节点  </li>\n<li>如果是，则拿到锁，执行完操作之后，把创建的节点删掉，即为释放锁  </li>\n<li>如果不是，则监听比自己小1地节点变化，发现比自己小1的节点删掉之后，发现自己已经是最小的节点了，拿到锁</li>\n</ul>\n<p>另一种方式<br>对某数据连续发出两个修改操作，两台机器同时收到了请求，但是只能一台机器先执行完另一个再执行。使用zookeeper，一台机器接收到请求之后先获取zookeeper上的一把分布式锁（创建一个znode），接着执行操作，另一个机器也尝试去创建那个znode，发现自己创建不了，因为别人已创建，等第一个机器执行完之后再执行。</p>\n<h3 id=\"集群管理与master选举\"><a href=\"#集群管理与master选举\" class=\"headerlink\" title=\"集群管理与master选举\"></a>集群管理与master选举</h3><ul>\n<li>依赖于临时节点<br>感知节点变化来获取集群状态<br>如系统A、B、C，在集群groupMember下挂三个临时节点A、B、C，只要A系统挂掉，groupMember/A节点就会删除，通过监听groupMember下的子节点，B、C系统就可以感知到系统A挂了<br>除了感知节点上下线变化之外，zookeeper还可以实现动态选举master功能（主从架构下）<br>zookeeper每次选举最小编号的作为master，如果master挂了，对应节点删除。然后让最小的编号节点做为master，这样就可以实现动态选举功能了。</li>\n</ul>\n<p>可切换主备，主挂了通过zookeeper感知切换到备。</p>\n<h3 id=\"统一配置管理\"><a href=\"#统一配置管理\" class=\"headerlink\" title=\"统一配置管理\"></a>统一配置管理</h3><p>将公共配置放在zookeeper的Znode节点中，各个系统监听这个节点有无变更，如果变更了，及时响应</p>\n<h3 id=\"统一命名服务\"><a href=\"#统一命名服务\" class=\"headerlink\" title=\"统一命名服务\"></a>统一命名服务</h3><p>为某一部分的资源进行命名，别人通过这个名字就可以拿到对应的资源了</p>\n<h2 id=\"ZAB协议\"><a href=\"#ZAB协议\" class=\"headerlink\" title=\"ZAB协议\"></a>ZAB协议</h2><p>zookeeper采用的ZAB协议（ZooKeeper Atomic Broadcast，ZooKeeper原子广播协议），基于ZAB协议，zookeeper实现了一职中主备模式（Leader、Follower）的系统架构来保持集群中各副本之间的数据一致性<br>zookeeper中有三种类型的节点leader、follower、observer（follower、observer属于learner）<br>分为三个步骤</p>\n<ul>\n<li>Leader包装写请求，生成唯一zxid，发起提议，广播给所有Follower</li>\n<li>Follower收到提议后，写入本地事务日志，根据自身情况，是否同意该事务的提交</li>\n<li>Leader收到过半的follower同意，自己先添加事务。然后对所有的learner节点发送提交事务请求</li>\n</ul>\n<p>如果leader挂了之后，会从follower中选举（谁的数据最新，谁就有优先被选为Leader的资格）比较事务id</p>\n","categories":["zookeeper"],"tags":["zookeeper"]},{"title":"jenkins构建","url":"/2021/%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/jenkins/jenkins%E6%9E%84%E5%BB%BA/","content":"<h2 id=\"jenkins构建\"><a href=\"#jenkins构建\" class=\"headerlink\" title=\"jenkins构建\"></a>jenkins构建</h2><h3 id=\"下载及启动\"><a href=\"#下载及启动\" class=\"headerlink\" title=\"下载及启动\"></a>下载及启动</h3><p>我是在mac电脑上进行操作的，所以就使用mac电脑做的示例(其他可以在<a href=\"https://www.jenkins.io/download/\">https://www.jenkins.io/download/</a>下载)</p>\n<p>首先下载jenkins</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">下载最新版本</span></span><br><span class=\"line\">brew install jenkins-lts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">下载想要的特定版本</span></span><br><span class=\"line\">brew install jenkins-lts@YOUR_VERSION</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>下载好了之后有两种启动方式</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">直接使用后台服务</span></span><br><span class=\"line\">brew services start jenkins-lts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">不使用后台服务，仅仅启动</span></span><br><span class=\"line\">jenkins-lts</span><br></pre></td></tr></table></figure>\n\n<p>启动之后默认端口是8080，使用<a href=\"http://localhost:8080/\">http://localhost:8080</a>访问即可进入jenkins页面</p>\n<p>根据指引登录，安装插件即可</p>\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><h4 id=\"配置全局工具\"><a href=\"#配置全局工具\" class=\"headerlink\" title=\"配置全局工具\"></a>配置全局工具</h4><p>进入全局工具配置</p>\n<img src=\"/images/jenkins/配置-全局工具配置入口.png\" alt=\"配置-全局工具配置入口\" style=\"zoom:50%;\">\n\n<p>配置maven、jdk、git等，根据自己的需要进行配置</p>\n<h4 id=\"插件管理\"><a href=\"#插件管理\" class=\"headerlink\" title=\"插件管理\"></a>插件管理</h4><p>然后进入插件管理</p>\n<img src=\"/images/jenkins/配置-插件管理入口.png\" alt=\"配置-插件管理入口\" style=\"zoom:50%;\">\n\n<p>由于我使用的Gitee做的源代码管理，所以我需要下载一下Gitee的插件</p>\n<ul>\n<li>前往 Manage Jenkins -&gt; Manage Plugins -&gt; Available</li>\n<li>右侧 Filter 输入： Gitee</li>\n<li>勾选下载即可</li>\n</ul>\n<h4 id=\"系统配置\"><a href=\"#系统配置\" class=\"headerlink\" title=\"系统配置\"></a>系统配置</h4><p>接下里就要配置gitee地址了</p>\n<img src=\"/images/jenkins/配置-系统配置.png\" alt=\"配置-系统配置\" style=\"zoom:50%;\">\n\n<ol>\n<li><p>前往 Jenkins -&gt; Manage Jenkins -&gt; Configure System -&gt; Gitee Configuration -&gt; Gitee connections</p>\n</li>\n<li><p>在 <code>Connection name</code> 中输入 <code>Gitee</code> 或者你想要的名字</p>\n</li>\n<li><p><code>Gitee host URL</code> 中输入 Gitee 完整 URL地址： <code>https://gitee.com</code> （Gitee 私有化客户输入部署的域名）</p>\n</li>\n<li><p>Credentials 中如还未配置 Gitee APIV5 私人令牌，点击</p>\n</li>\n</ol>\n<p>Add  选择Jenkins</p>\n<ol>\n<li><code>Domain</code> 选择 <code>Global credentials</code></li>\n<li><code>Kind</code> 选择 <code>Gitee API Token</code><ol start=\"3\">\n<li><code>Scope</code> 选择你需要的范围</li>\n</ol>\n</li>\n<li><code>Gitee API Token</code> 输入你的 Gitee 私人令牌，获取地址：<a href=\"https://gitee.com/profile/personal_access_tokens\">https://gitee.com/profile/personal_access_tokens</a></li>\n<li><code>ID</code>, <code>Descripiton</code> 中输入你想要的 ID 和描述即可。</li>\n</ol>\n<ol start=\"5\">\n<li><p><code>Credentials</code> 选择配置好的 Gitee APIV5 Token</p>\n</li>\n<li><p>点击 <code>Advanced</code> ，可配置是否忽略 SSL 错误（视您的Jenkins环境是否支持），并可设置链接测超时时间（视您的网络环境而定）</p>\n</li>\n<li><p>点击 <code>Test Connection</code> 测试链接是否成功，如失败请检查以上 3，5，6 步骤。</p>\n</li>\n</ol>\n<h3 id=\"构建\"><a href=\"#构建\" class=\"headerlink\" title=\"构建\"></a>构建</h3><p>接下来就是构建新的项目了</p>\n<img src=\"/images/jenkins/构建-入口.png\" alt=\"构建-入口\" style=\"zoom:50%;\">\n\n<p>之后就是配置源代码地址以及构建步骤了</p>\n<h4 id=\"配置源码管理\"><a href=\"#配置源码管理\" class=\"headerlink\" title=\"配置源码管理\"></a>配置源码管理</h4><img src=\"/images/jenkins/构建-源码管理.png\" alt=\"构建-源码管理\" style=\"zoom:50%;\">\n\n<h4 id=\"配置构建步骤\"><a href=\"#配置构建步骤\" class=\"headerlink\" title=\"配置构建步骤\"></a>配置构建步骤</h4><p>这里我用的是maven，所以构建的时候选择的是maven，选择之前配置好的maven，然后目标为clean install</p>\n<img src=\"/images/jenkins/构建-构建配置.png\" alt=\"构建-构建配置\" style=\"zoom:50%;\">\n\n<p>配置完之后保存即可</p>\n<h4 id=\"构建-1\"><a href=\"#构建-1\" class=\"headerlink\" title=\"构建\"></a>构建</h4><p>找到配置好的项目，进行构建</p>\n<img src=\"/images/jenkins/构建-开始构建.png\" alt=\"构建-开始构建\" style=\"zoom:50%;\">\n\n<p>构建的时候可以查看构建日志</p>\n<p>点击构建的项目序号</p>\n<img src=\"/images/jenkins/构建.png\" alt=\"构建\" style=\"zoom:50%;\">\n\n<p>点控制台输出就可以看到构建的日志了</p>\n<img src=\"/images/jenkins/构建-控制台输出.png\" alt=\"构建-控制台输出\" style=\"zoom:50%;\">\n\n<p>构建完成之后可以看到工作空间中会有构建完成的项目</p>\n<img src=\"/images/jenkins/构建-工作空间.png\" alt=\"构建-工作空间\" style=\"zoom:50%;\">\n\n<p>此时就可以拿到war包了，拿到war包之后就可以开始进行构建后的操作了，下一步就是部署</p>\n<h3 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h3><p>部署的话因为需要部署war包，所以这里还需要去下载一个插件</p>\n<img src=\"/images/jenkins/部署-插件.png\" alt=\"部署-插件\" style=\"zoom:50%;\">\n\n<p>回到项目的配置中，增加构建后操作步骤</p>\n<img src=\"/images/jenkins/部署-构建后操作.png\" alt=\"部署-构建后操作\" style=\"zoom:50%;\">\n\n<p>然后开始进行配置</p>\n<img src=\"/images/jenkins/部署-部署配置.png\" alt=\"部署-部署配置\" style=\"zoom:50%;\">\n\n<p>在这里注意一下，由于这里需要配置tomcat的权限，所以在tomcat的tomcat-users.xml中进行配置一下用户和角色</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- jenkins使用 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">role</span> <span class=\"attr\">rolename</span>=<span class=\"string\">&quot;manager-gui&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">role</span> <span class=\"attr\">rolename</span>=<span class=\"string\">&quot;manager-script&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">role</span> <span class=\"attr\">rolename</span>=<span class=\"string\">&quot;manager-jmx&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">role</span> <span class=\"attr\">rolename</span>=<span class=\"string\">&quot;manager-status&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">user</span> <span class=\"attr\">username</span>=<span class=\"string\">&quot;jenkins_user&quot;</span> <span class=\"attr\">password</span>=<span class=\"string\">&quot;tomcat&quot;</span> <span class=\"attr\">roles</span>=<span class=\"string\">&quot;manager-gui,manager-script,manager-jmx,manager-status&quot;</span>/&gt;</span> </span><br></pre></td></tr></table></figure>\n\n<p>配置完成之后启动tomcat即可</p>\n","categories":["jenkins"],"tags":["jenkins"]},{"title":"基本语法","url":"/2020/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/","content":"<p><strong>查询语法：</strong></p>\n<p>select &lt;字段&gt; from &lt;表名&gt; where &lt;条件&gt; group by &lt;分组字段&gt; having &lt;分组条件&gt; order by &lt;排序规则&gt;</p>\n<a id=\"more\"></a>\n\n<p><strong>插入语法：</strong></p>\n<ul>\n<li><p>插入单行  insert into &lt;表名&gt; (列名) values (列值)</p>\n</li>\n<li><p>将现有数据添加到一个已有表  insert into &lt;表名&gt; (列名) select &lt;源表列名&gt; from &lt;源表名&gt; </p>\n</li>\n<li><p>使用现有表数据创建一个新表并填充   select &lt;新建表列名&gt; into &lt;新建表名&gt; from &lt;源表名&gt;</p>\n</li>\n</ul>\n<p><strong>删除语法：</strong></p>\n<ul>\n<li><p>删除满足条件的行  delete from &lt;表名&gt; where &lt;条件&gt;</p>\n</li>\n<li><p>删除整个表(删除的数据，并非表结构)  truncate table &lt;表名&gt;</p>\n</li>\n</ul>\n<p><strong>修改语法：</strong></p>\n<p>update &lt;表名&gt; set &lt;列名=列值&gt; where &lt;条件&gt;</p>\n","categories":["数据库"],"tags":["数据库"]},{"title":"NoSQL简介","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/NoSQL%E7%AE%80%E4%BB%8B/","content":"<h2 id=\"NoSQL简介\"><a href=\"#NoSQL简介\" class=\"headerlink\" title=\"NoSQL简介\"></a>NoSQL简介</h2><p>NoSQL最常见的解释是”non-relational”，”Not Only SQL”也被很多人接受，泛指非关系型数据库，NoSQL数据库的产生就是为了解决大规模数据集合多重数据种类带来的挑战，特别是大数据应用难题，它不能替代关系型数据库，只能作为关系型数据库的一个良好补充。</p>\n<a id=\"more\"></a>\n\n<h4 id=\"NoSQL分类\"><a href=\"#NoSQL分类\" class=\"headerlink\" title=\"NoSQL分类\"></a>NoSQL分类</h4><p>其主要产品包含有redis、hbase、MongoDB、Neo4j，也以这几个为代表的分为了四类</p>\n<ul>\n<li>键值存储数据库    如：Tokyo Cabinet/Tyrant、Redis、Voldemort、Oracle BDB    应用场景：缓存，用于处理大量数据的高访问负载，可以快速查询</li>\n<li>列存储数据库       如：Cassandra、HBase、Riak   应用场景：分布式存储的海量数据，查找速度快，可扩展性强</li>\n<li>文档型数据库       如：CouchDB、MongoDb</li>\n<li>图形数据库           如：Neo4J、InfoGrid、Infinite Graph   应用场景：复杂的社交网络</li>\n</ul>\n","categories":["NoSQL"],"tags":["NoSQL"]},{"title":"log4j2配置","url":"/2021/%E6%97%A5%E5%BF%97/log4j2/%E9%85%8D%E7%BD%AE/","content":"<h2 id=\"log4j2配置\"><a href=\"#log4j2配置\" class=\"headerlink\" title=\"log4j2配置\"></a>log4j2配置</h2><h3 id=\"配置文件结构\"><a href=\"#配置文件结构\" class=\"headerlink\" title=\"配置文件结构\"></a>配置文件结构</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Configuration</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Appenders</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Appender</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">Filters</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">LevelRangeFilter</span> <span class=\"attr\">minLevel</span>=<span class=\"string\">&quot;...&quot;</span> <span class=\"attr\">maxLevel</span>=<span class=\"string\">&quot;...&quot;</span> <span class=\"attr\">onMatch</span>=<span class=\"string\">&quot;...&quot;</span> <span class=\"attr\">onMismatch</span>=<span class=\"string\">&quot;...&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">Filters</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;...&quot;</span> <span class=\"attr\">charset</span>=<span class=\"string\">&quot;...&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">Policies</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">CronTriggeringPolicy</span> <span class=\"attr\">schedule</span>=<span class=\"string\">&quot;...&quot;</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">SizeBasedTriggeringPolicy</span> <span class=\"attr\">size</span>=<span class=\"string\">&quot;...&quot;</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">TimeBasedTriggeringPolicy</span> /&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">Policies</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Appender</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Appenders</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Loggers</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Logger</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">AppenderRef</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;...&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Logger</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Root</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">AppenderRef</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;...&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Root</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Loggers</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>先进行拆分一下，Configuration下分为两部分，Appenders和Loggers</p>\n<h3 id=\"Appenders详解\"><a href=\"#Appenders详解\" class=\"headerlink\" title=\"Appenders详解\"></a>Appenders详解</h3><p>Appenders部分就是配置了一个Appender集合，Appender就是一个日志输出的管道，定义日志输出到的位置，而Appender在log4j2中有很多实现类，如ConsoleAppender(插件名称为Console)、FileAppender(插件名称为File)、RollingFileAppender(插件名称为RollingFile)等，在配置时使用插件名称即可</p>\n<h4 id=\"Appender\"><a href=\"#Appender\" class=\"headerlink\" title=\"Appender\"></a>Appender</h4><p>由于配置时使用插件名称即可，所以下述介绍时就直接使用插件名称了，比较简洁</p>\n<h5 id=\"Console\"><a href=\"#Console\" class=\"headerlink\" title=\"Console\"></a>Console</h5><p>Console就是输出到控制台，有两种输出方式SYSTEM_OUT和SYSTEM_ERR，默认为SYSTEM_OUT</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Console</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;stdout&quot;</span> <span class=\"attr\">target</span>=<span class=\"string\">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class=\"line\">     <span class=\"comment\">&lt;!--输出日志的格式--&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span> <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;[%-5p %d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;] %l [%m]%n&quot;</span>/&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">Console</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"File\"><a href=\"#File\" class=\"headerlink\" title=\"File\"></a>File</h5><p>File是指输出到文件，fileName指定日志文件位置，append表示是否追加，如果不追加，则使用的该日志文件原本内容就会清空，默认为true</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">File</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;log&quot;</span> <span class=\"attr\">fileName</span>=<span class=\"string\">&quot;log/test.log&quot;</span> <span class=\"attr\">append</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">File</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"RollingFile\"><a href=\"#RollingFile\" class=\"headerlink\" title=\"RollingFile\"></a>RollingFile</h5><p>File不可以进行日志滚动，实际项目中使用的并不多，而RollingFile是可以进行日志滚动的，在实际项目中使用较多。</p>\n<blockquote>\n<p>日志滚动是指在达到一定条件时，日志文件进行分割</p>\n</blockquote>\n<p>filePattern是指定日志文件命名格式</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">RollingFile</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;file&quot;</span> <span class=\"attr\">fileName</span>=<span class=\"string\">&quot;$&#123;LOG_HOME&#125;/test.log&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">             <span class=\"attr\">filePattern</span>=<span class=\"string\">&quot;$&#123;LOG_HOME&#125;/%d&#123;yyyyMMdd&#125;/test.log.%d&#123;yyyyMMdd&#125;.%i.bz2&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span>  <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;[%-5p %d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;] %l [%m]%n&quot;</span>/&gt;</span></span><br><span class=\"line\">   <span class=\"comment\">&lt;!-- 配置日志何时滚动，分为时间和大小两类规则 --&gt;</span> </span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">Policies</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">TimeBasedTriggeringPolicy</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">SizeBasedTriggeringPolicy</span> <span class=\"attr\">size</span>=<span class=\"string\">&quot;500MB&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Policies</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- 配置日志如何翻滚，指定了最大翻滚次数，超过之后按照规则删除 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">DefaultRolloverStrategy</span> <span class=\"attr\">max</span>=<span class=\"string\">&quot;30&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Delete</span> <span class=\"attr\">basePath</span>=<span class=\"string\">&quot;$&#123;LOG_HOME&#125;/%d&#123;yyyyMMdd&#125;/&quot;</span> <span class=\"attr\">maxDepth</span>=<span class=\"string\">&quot;2&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">IfFileName</span> <span class=\"attr\">glob</span>=<span class=\"string\">&quot;*.log&quot;</span> /&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!--!<span class=\"doctag\">Note:</span> 这里的age必须和filePattern协调, 后者是精确到天,age的单位就是天</span></span><br><span class=\"line\"><span class=\"comment\">            另外, 数字最好&gt;2, 否则可能造成删除的时候, 最近的文件还处于被占用状态,导致删除不成功!--&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!--7天--&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">IfLastModified</span> <span class=\"attr\">age</span>=<span class=\"string\">&quot;7d&quot;</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Delete</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">DefaultRolloverStrategy</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">RollingFile</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Filter\"><a href=\"#Filter\" class=\"headerlink\" title=\"Filter\"></a>Filter</h5><p>Filter决定日志能否被输出，过滤条件有ACCEPT(接受)，DENY(拒绝)，NEUTRAL(中立)，如果为ACCEPT或DENY，则后续Filter将不会执行，只有当是NEUTRAL是才会执行后续的Filter</p>\n<p>常用的有TimeFilter、LevelRangeFilter、ThresholdFilter</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">ThresholdFilter</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;warn&quot;</span> <span class=\"attr\">onMatch</span>=<span class=\"string\">&quot;ACCEPT&quot;</span> <span class=\"attr\">onMismatch</span>=<span class=\"string\">&quot;DENY&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Layout\"><a href=\"#Layout\" class=\"headerlink\" title=\"Layout\"></a>Layout</h5><p>控制日志的输出格式，基本上只使用PatternLayout这一种就够了</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span>  <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;[%-5p %d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;] %l [%m]%n&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"Policy\"><a href=\"#Policy\" class=\"headerlink\" title=\"Policy\"></a>Policy</h5><p>控制日志何时滚动，常用的有TimeBasedTriggeringPolicy、SizeBasedTriggeringPolicy、CronTriggeringPolicy</p>\n<ul>\n<li><p>TimeBasedTriggeringPolicy表示使用时间滚动策略，依赖于filePattern中配置的时间单位</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- interval表示间隔，默认为1</span></span><br><span class=\"line\"><span class=\"comment\">         modulate true表示从启动时间开始算起，false表示从0开始算起，默认为false</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">TimeBasedTriggeringPolicy</span> <span class=\"attr\">interval</span>=<span class=\"string\">&quot;1&quot;</span> <span class=\"attr\">modulate</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n<ul>\n<li><p>SizeBasedTriggeringPolicy根据日志文件大小进行滚动，单位为KB/MB/GB</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">SizeBasedTriggeringPolicy</span> <span class=\"attr\">size</span>=<span class=\"string\">&quot;100 MB&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>CronTriggeringPolicy使用表达式来进行日志滚动</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 默认为&quot;0 0 0 * * ?&quot; 每天0点触发 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">CronTriggeringPolicy</span> <span class=\"attr\">schedule</span>=<span class=\"string\">&quot;0 0 0 * * ?&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h5 id=\"Strategy\"><a href=\"#Strategy\" class=\"headerlink\" title=\"Strategy\"></a>Strategy</h5><p>控制日志如何滚动，使用DefaultRolloverStrategy即可</p>\n<h3 id=\"Loggers详解\"><a href=\"#Loggers详解\" class=\"headerlink\" title=\"Loggers详解\"></a>Loggers详解</h3><p>Loggers中配置的是指定类或者指定包中的日志信息流向哪个Appender，以及输出的控制日志级别</p>\n<p>对应的对象为LoggerConfig</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ConcurrentMap&lt;String, LoggerConfig&gt; map;</span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> LoggerConfig root;</span><br></pre></td></tr></table></figure>\n\n<p>分为root的和一般的logger</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">loggers</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- 如果不将additivity设为false，将会打印两遍日志，即logger打印一遍，root打印一遍 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">logger</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;com.zhanghe.study.java8.Main&quot;</span> <span class=\"attr\">additivity</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;Console&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">logger</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">root</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;info&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;Console&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">root</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">loggers</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>记录一下</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!--日志级别以及优先级排序: OFF &gt; FATAL &gt; ERROR &gt; WARN &gt; INFO &gt; DEBUG &gt; TRACE &gt; ALL --&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!--Configuration后面的status，这个用于设置log4j2自身内部的信息输出，可以不设置，当设置成trace时，你会看到log4j2内部各种详细输出--&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!--monitorInterval：Log4j能够自动检测修改配置 文件和重新配置本身，设置间隔秒数--&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">configuration</span> <span class=\"attr\">status</span>=<span class=\"string\">&quot;WARN&quot;</span> <span class=\"attr\">monitorInterval</span>=<span class=\"string\">&quot;30&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!--先定义所有的appender--&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">appenders</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!--这个输出控制台的配置--&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">console</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;Console&quot;</span> <span class=\"attr\">target</span>=<span class=\"string\">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class=\"line\">          <span class=\"comment\">&lt;!--输出日志的格式--&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;[%d&#123;HH:mm:ss:SSS&#125;] [%p] - %l - %m%n&quot;</span>/&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">console</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!--文件会打印出所有信息，这个log每次运行程序会自动清空，由append属性决定，这个也挺有用的，适合临时测试用--&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">File</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;log&quot;</span> <span class=\"attr\">fileName</span>=<span class=\"string\">&quot;log/test.log&quot;</span> <span class=\"attr\">append</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;%d&#123;HH:mm:ss.SSS&#125; %-5level %class&#123;36&#125; %L %M - %msg%xEx%n&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">File</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- 这个会打印出所有的info及以下级别的信息，每次大小超过size，则这size大小的日志会自动存入按年份-月份建立的文件夹下面并进行压缩，作为存档--&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">RollingFile</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;RollingFileInfo&quot;</span> <span class=\"attr\">fileName</span>=<span class=\"string\">&quot;$&#123;sys:user.home&#125;/logs/info.log&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">                       <span class=\"attr\">filePattern</span>=<span class=\"string\">&quot;$&#123;sys:user.home&#125;/logs/$$&#123;date:yyyy-MM&#125;/info-%d&#123;yyyy-MM-dd&#125;-%i.log&quot;</span>&gt;</span></span><br><span class=\"line\">              <span class=\"comment\">&lt;!--控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch）--&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">ThresholdFilter</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;info&quot;</span> <span class=\"attr\">onMatch</span>=<span class=\"string\">&quot;ACCEPT&quot;</span> <span class=\"attr\">onMismatch</span>=<span class=\"string\">&quot;DENY&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;[%d&#123;HH:mm:ss:SSS&#125;] [%p] - %l - %m%n&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">Policies</span>&gt;</span></span><br><span class=\"line\">                  <span class=\"tag\">&lt;<span class=\"name\">TimeBasedTriggeringPolicy</span>/&gt;</span></span><br><span class=\"line\">                  <span class=\"tag\">&lt;<span class=\"name\">SizeBasedTriggeringPolicy</span> <span class=\"attr\">size</span>=<span class=\"string\">&quot;100 MB&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;/<span class=\"name\">Policies</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">RollingFile</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">RollingFile</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;RollingFileWarn&quot;</span> <span class=\"attr\">fileName</span>=<span class=\"string\">&quot;$&#123;sys:user.home&#125;/logs/warn.log&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">                       <span class=\"attr\">filePattern</span>=<span class=\"string\">&quot;$&#123;sys:user.home&#125;/logs/$$&#123;date:yyyy-MM&#125;/warn-%d&#123;yyyy-MM-dd&#125;-%i.log&quot;</span>&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">ThresholdFilter</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;warn&quot;</span> <span class=\"attr\">onMatch</span>=<span class=\"string\">&quot;ACCEPT&quot;</span> <span class=\"attr\">onMismatch</span>=<span class=\"string\">&quot;DENY&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;[%d&#123;HH:mm:ss:SSS&#125;] [%p] - %l - %m%n&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">Policies</span>&gt;</span></span><br><span class=\"line\">                  <span class=\"tag\">&lt;<span class=\"name\">TimeBasedTriggeringPolicy</span>/&gt;</span></span><br><span class=\"line\">                  <span class=\"tag\">&lt;<span class=\"name\">SizeBasedTriggeringPolicy</span> <span class=\"attr\">size</span>=<span class=\"string\">&quot;100 MB&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;/<span class=\"name\">Policies</span>&gt;</span></span><br><span class=\"line\">          <span class=\"comment\">&lt;!-- DefaultRolloverStrategy属性如不设置，则默认为最多同一文件夹下7个文件，这里设置了20 --&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">DefaultRolloverStrategy</span> <span class=\"attr\">max</span>=<span class=\"string\">&quot;20&quot;</span>/&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">RollingFile</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">RollingFile</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;RollingFileError&quot;</span> <span class=\"attr\">fileName</span>=<span class=\"string\">&quot;$&#123;sys:user.home&#125;/logs/error.log&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">                       <span class=\"attr\">filePattern</span>=<span class=\"string\">&quot;$&#123;sys:user.home&#125;/logs/$$&#123;date:yyyy-MM&#125;/error-%d&#123;yyyy-MM-dd&#125;-%i.log&quot;</span>&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">ThresholdFilter</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;error&quot;</span> <span class=\"attr\">onMatch</span>=<span class=\"string\">&quot;ACCEPT&quot;</span> <span class=\"attr\">onMismatch</span>=<span class=\"string\">&quot;DENY&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;[%d&#123;HH:mm:ss:SSS&#125;] [%p] - %l - %m%n&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">Policies</span>&gt;</span></span><br><span class=\"line\">                  <span class=\"tag\">&lt;<span class=\"name\">TimeBasedTriggeringPolicy</span>/&gt;</span></span><br><span class=\"line\">                  <span class=\"tag\">&lt;<span class=\"name\">SizeBasedTriggeringPolicy</span> <span class=\"attr\">size</span>=<span class=\"string\">&quot;100 MB&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;/<span class=\"name\">Policies</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">RollingFile</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">appenders</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!--然后定义logger，只有定义了logger并引入的appender，appender才会生效--&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">loggers</span>&gt;</span></span><br><span class=\"line\">          <span class=\"comment\">&lt;!--过滤掉spring和mybatis的一些无用的DEBUG信息--&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">logger</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;org.springframework&quot;</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;INFO&quot;</span>/&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">logger</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;org.mybatis&quot;</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;INFO&quot;</span>/&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">root</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;all&quot;</span>&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;Console&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;RollingFileInfo&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;RollingFileWarn&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"tag\">&lt;<span class=\"name\">appender-ref</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;RollingFileError&quot;</span>/&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;/<span class=\"name\">root</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">loggers</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["日志"],"tags":["日志"]},{"title":"Gzip压缩","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/Gzip%E5%8E%8B%E7%BC%A9/","content":"<h2 id=\"Gzip压缩\"><a href=\"#Gzip压缩\" class=\"headerlink\" title=\"Gzip压缩\"></a>Gzip压缩</h2><p>通过gzip相关指令可以配置Gzip压缩，对响应数据进行在线实时压缩。</p>\n<p><strong>相关配置参数说明:</strong></p>\n<ul>\n<li>gzip: on; # 开启或关闭gzip功能，默认为off</li>\n<li>gzip_buffers: 16 8K; # 配置Gzip压缩文件时使用的缓存空间大小，语法结构为gzip_buffers number size;number表示需要向服务器申请的缓存空间的个数；size表示指定每个缓存空间的大小，默认number*size=128K</li>\n<li>gzip_comp_level: 9; # 压缩级别，压缩程度越高，压缩效率最低，最费时间</li>\n<li>gzip_min_length:# 配置最小压缩的数据大小，如果响应页面的大小大于该值，才开启Gzip功能（一些小文件会导致压缩后的大小比源文件还大），默认为20，建议设置为1k(1024)</li>\n<li>gzip_http_version:1.0; # 配置只有高于指定版本的HTTP协议才能开启Gzip，默认为1.1, 目前绝大多数浏览器都支持Gzip自解压，一般采用默认值即可</li>\n<li>gzip_proxied:any; # 设置是否对被代理服务器返回的数据进行压缩，默认为off</li>\n<li>gzip_vary: on; # 开启压缩标记，开启后在响应头部添加 Vary: Accept-Encoding,默认为off</li>\n<li>gzip_types:text/plain application/x-javascript text/css application/xml text/javascript; # 对指定类型的文档进行Gzip压缩</li>\n<li>gzip_static:on; # 对于存在服务器上.gz作为后缀的文件，且客户端浏览器支持gzip压缩，就直接返回压缩后的数据</li>\n</ul>\n<a id=\"more\"></a>\n\n<p>示例</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#将访问的文件压缩传输 （减少文件资源大小，提高传输速度）</span><br><span class=\"line\">#当访问内容以gif或jpg结尾的资源时</span><br><span class=\"line\">location ~ .*\\.(gif|jpg)$ &#123;</span><br><span class=\"line\">    gzip on; #开启</span><br><span class=\"line\">    gzip_http_version 1.1; #服务器传输版本</span><br><span class=\"line\">    gzip_comp_level 2; #压缩比，越高压缩越多，压缩越高可能会消耗服务器性能</span><br><span class=\"line\">    gzip_types   text&#x2F;plain application&#x2F;javascript application&#x2F;x-javascript text&#x2F;javascript text&#x2F;css application&#x2F;xml application&#x2F;xml+rss image&#x2F;jpeg image&#x2F;gif image&#x2F;png;     #压缩文件类型</span><br><span class=\"line\">    root &#x2F;www&#x2F;app&#x2F;web;     #对应目录（去该目录下寻找对应文件）</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">#直接访问已压缩文件</span><br><span class=\"line\">#当访问路径以download开头时，如www.baidu.com&#x2F;download&#x2F;test.img</span><br><span class=\"line\">#去&#x2F;www&#x2F;app&#x2F;web目录下寻找test.img.gz文件，返回到前端时已是可以浏览的img文件</span><br><span class=\"line\">location ~ load^&#x2F;download &#123;</span><br><span class=\"line\">    gzip_static on #开启;</span><br><span class=\"line\">    tcp_nopush on;</span><br><span class=\"line\">    root &#x2F;www&#x2F;app&#x2F;web;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"Nginx常用命令","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/Nginx%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"Nginx常用命令\"><a href=\"#Nginx常用命令\" class=\"headerlink\" title=\"Nginx常用命令\"></a>Nginx常用命令</h2><ul>\n<li><p>查看版本</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">仅显示nginx版本</span></span><br><span class=\"line\">nginx -v</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">显示nginx版本、编译器版本以及配置参数</span></span><br><span class=\"line\">nginx -V</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n</li>\n<li><p>启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">使用默认配置文件启动</span></span><br><span class=\"line\">nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">指定配置文件加载</span></span><br><span class=\"line\">nginx -c  filename</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>停止</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">快速关闭，可能不保存相关信息，并迅速终止web服务</span></span><br><span class=\"line\">nginx -s stop</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">正常关闭，保存相关信息</span></span><br><span class=\"line\">nginx -s quit</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>验证</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">验证配置文件的正确性，不运行</span></span><br><span class=\"line\">nginx -t</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">验证指定位置的配置文件</span></span><br><span class=\"line\">nginx -t -c filename</span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n<ul>\n<li><p>重新加载</p>\n<p>修改nginx配置的话需要重新加载才会生效</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">nginx -s reload</span><br></pre></td></tr></table></figure>\n\n\n</li>\n</ul>\n<blockquote>\n<p>nginx -s reopen     (待验证)</p>\n</blockquote>\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"Nginx概念","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/Nginx%E6%A6%82%E5%BF%B5/","content":"<h2 id=\"Nginx概念\"><a href=\"#Nginx概念\" class=\"headerlink\" title=\"Nginx概念\"></a>Nginx概念</h2><p>Nginx 是一款面向性能设计的 HTTP 服务器，相较于 Apache、lighttpd 具有占有内存少，稳定性高等优势，同时也是一个非常高效的反向代理、负载平衡服务器</p>\n<a id=\"more\"></a>\n\n<p>nginx在启动后会有一个master进程和多个worker进程</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">worker_processes  4;</span><br></pre></td></tr></table></figure>\n\n<p>可以看到现在就有四个worker进程了</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">ps -ef | grep nginx</span><br><span class=\"line\"> 501  4106     1   0 10:43上午 ??         0:00.01 nginx: master process nginx</span><br><span class=\"line\"> 501 11007  4106   0  5:00下午 ??         0:00.00 nginx: worker process</span><br><span class=\"line\"> 501 11008  4106   0  5:00下午 ??         0:00.00 nginx: worker process</span><br><span class=\"line\"> 501 11009  4106   0  5:00下午 ??         0:00.00 nginx: worker process</span><br><span class=\"line\"> 501 11010  4106   0  5:00下午 ??         0:00.00 nginx: worker process</span><br></pre></td></tr></table></figure>\n\n<p>master进程主要用来管理worker进程，多个worker进程来竞争客户端的请求</p>\n<h3 id=\"反向代理\"><a href=\"#反向代理\" class=\"headerlink\" title=\"反向代理\"></a>反向代理</h3><p>对于正向代理来说，需要在浏览器配置代理服务器，通过代理服务器去访问目标服务器，而反向代理是不需要在浏览器进行配置的，浏览器对此是无感知的，只需要将请求发送到反向代理服务器，再由反向代理服务器去选择目标服务器获取数据后，再返回给客户端，对外暴露的是反向代理服务器的地址，隐藏了真实服务器的IP地址</p>\n<h3 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h3><p>在最初项目起步的时候，是由客户端访问单个服务器，但是由于并发以及高可用的一些要求，需要增加服务器的数量，将请求分发到不同的服务器上，此时将原本一个服务器的压力分散到多个服务器上，就是负载均衡</p>\n<h3 id=\"动静分离\"><a href=\"#动静分离\" class=\"headerlink\" title=\"动静分离\"></a>动静分离</h3><p>为了加快网站的解析速度，把动态页面和静态页面由不同的服务器解析，来加快解析速度，</p>\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"mac下Nginx的安装","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/Nginx%E7%9A%84%E5%AE%89%E8%A3%85/","content":"<h2 id=\"mac下Nginx的安装\"><a href=\"#mac下Nginx的安装\" class=\"headerlink\" title=\"mac下Nginx的安装\"></a>mac下Nginx的安装</h2><p>首先看一下nginx的信息</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">执行命令</span></span><br><span class=\"line\">brew info nginx</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">下面来解释一下下面的意思</span></span><br><span class=\"line\">--------------------------------------------------------</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">最新已经到了1.19.6版本</span></span><br><span class=\"line\">nginx: stable 1.19.6 (bottled), HEAD</span><br><span class=\"line\"></span><br><span class=\"line\">HTTP(S) server and reverse proxy, and IMAP/POP3 proxy server</span><br><span class=\"line\"></span><br><span class=\"line\">https://nginx.org/</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">已经安装过了  安装的位置</span></span><br><span class=\"line\"></span><br><span class=\"line\">/usr/local/Cellar/nginx/1.19.4 (25 files, 2.2MB) *</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 以及安装的时间</span></span><br><span class=\"line\"></span><br><span class=\"line\"> Poured from bottle on 2020-11-13 at 11:31:37</span><br><span class=\"line\"><span class=\"meta\"> #</span><span class=\"bash\"> 从哪个网站下载的</span></span><br><span class=\"line\"></span><br><span class=\"line\">From: https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/nginx.rb</span><br><span class=\"line\"></span><br><span class=\"line\">License: BSD-2-Clause</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 依赖</span></span><br><span class=\"line\"></span><br><span class=\"line\">==&gt; **Dependencies**</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> openssl是可以没有的   pcre必须要有</span></span><br><span class=\"line\"></span><br><span class=\"line\">Required: **openssl@1.1** **✘**, **pcre** **✔**</span><br><span class=\"line\"></span><br><span class=\"line\">==&gt; **Options**</span><br><span class=\"line\"></span><br><span class=\"line\">--HEAD</span><br><span class=\"line\"></span><br><span class=\"line\">​    Install HEAD version</span><br><span class=\"line\"></span><br><span class=\"line\">==&gt; **Caveats**</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> Docroot网站根目录位置</span></span><br><span class=\"line\"></span><br><span class=\"line\">Docroot is: /usr/local/var/www</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 默认配置位置</span></span><br><span class=\"line\">The default port has been set in /usr/local/etc/nginx/nginx.conf to 8080 so that</span><br><span class=\"line\"></span><br><span class=\"line\">nginx can run without sudo.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">nginx加载servers下的所有文件</span></span><br><span class=\"line\">nginx will load all files in /usr/local/etc/nginx/servers/.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">To have launchd start nginx now and restart at login:</span><br><span class=\"line\"></span><br><span class=\"line\"> brew services start nginx</span><br><span class=\"line\"></span><br><span class=\"line\">Or, if you don&#x27;t want/need a background service you can just run:</span><br><span class=\"line\"></span><br><span class=\"line\"> nginx</span><br><span class=\"line\"></span><br><span class=\"line\">==&gt; **Analytics**</span><br><span class=\"line\"></span><br><span class=\"line\">install: 35,316 (30 days), 124,077 (90 days), 453,743 (365 days)</span><br><span class=\"line\"></span><br><span class=\"line\">install-on-request: 35,265 (30 days), 123,459 (90 days), 445,150 (365 days)</span><br><span class=\"line\"></span><br><span class=\"line\">build-error: 0 (30 days)</span><br></pre></td></tr></table></figure>\n\n<p>既然说需要依赖pcre组件，那么pcre是干什么的呢</p>\n<p>PCRE库支持正则表达式。如果我们在配置文件nginx.conf中使用了正则表达式，那么在编译Nginx时就必须把PCRE库编译进Nginx，因为Nginx的HTTP模块需要靠它来解析正则表达式。</p>\n<p>进行安装nginx</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">brew install nginx</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"启动和停止nginx\"><a href=\"#启动和停止nginx\" class=\"headerlink\" title=\"启动和停止nginx\"></a>启动和停止nginx</h3><p>这里提供两种方式来启动和停止nginx</p>\n<p>一种是不作为一个后台服务来启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">启动</span></span><br><span class=\"line\">nginx</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 停止</span></span><br><span class=\"line\">nginx -s stop</span><br></pre></td></tr></table></figure>\n\n<p>一种是作为后台服务来启动(开机自启动)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">brew services start nginx</span><br><span class=\"line\"></span><br><span class=\"line\">brew services stop nginx</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n\n\n\n\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"Nginx缓存","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/Nginx%E7%BC%93%E5%AD%98/","content":"<h2 id=\"Nginx缓存\"><a href=\"#Nginx缓存\" class=\"headerlink\" title=\"Nginx缓存\"></a>Nginx缓存</h2><p>一般情况下系统用到的缓存有三种</p>\n<ul>\n<li>服务端缓存：缓存存在后端服务器，如redis</li>\n<li>代理缓存：缓存存储在代理服务器或中间件，内容从后端服务器获取，保存在本地</li>\n<li>客户端缓存：缓存在浏览器</li>\n</ul>\n<p>Nginx使用的缓存属于代理缓存</p>\n<a id=\"more\"></a>\n\n<p>Nginx通过proxy_cache来实现缓存。Buffer(缓冲)主要用于传输效率不同步或者优先级不相同的设备之间传输数据，通过对一方数据进行临时存放，在统一发送的方式传递给另一方，以降低进程间的等待时间；Cache(缓存)主要用于将硬盘上已有的数据在内存中建立缓存数据，提高数据的访问效率。</p>\n<p>而proxy_cache只有在Proxy Buffer机制开启的情况下Proxy Cache的配置才会发挥作用</p>\n<p>相关配置</p>\n<ul>\n<li>proxy_zone:zone | off  默认是off，即关闭proxy_cache功能，zone为用于存放缓存的内存区域名称</li>\n<li>proxy_cache_path: path [levels=levels] keys_zone-name:size [inactive=time] [max_size=size]<ul>\n<li>path设置缓存数据存放的路径</li>\n<li>levels设置目录层级，如levels=1:2，表示有两个子目录</li>\n<li>keys_zone 设置内存zone的名称和大小，如keys_zone=my:10m</li>\n<li>inactive设置缓存多长时间失效，当磁盘上的缓存数据在改时间段内没有被访问过，就会失效，数据将被删除，默认10s</li>\n<li>max_size 设置硬盘中最多缓存多少数据，数据超出，则删除最少访问的数据</li>\n</ul>\n</li>\n</ul>\n<p>示例</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">http &#123;</span><br><span class=\"line\">    proxy_cache_path    &#x2F;var&#x2F;www&#x2F;cache #缓存地址</span><br><span class=\"line\">                        levels&#x3D;1:2 #目录分级</span><br><span class=\"line\">                        keys_zone&#x3D;test_cache:10m #开启的keys空间名字:空间大小(1m可以存放8000个key)</span><br><span class=\"line\">                        max_size&#x3D;10g #目录最大大小(超过时，不常用的将被删除)</span><br><span class=\"line\">                        inactive&#x3D;60m #60分钟内没有被访问的缓存将清理</span><br><span class=\"line\">                        use_temp_path&#x3D;off; #是否开启存放临时文件目录，关闭默认存储在缓存地址</span><br><span class=\"line\">                                         </span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">            # 使用缓存</span><br><span class=\"line\">        location &#x2F; &#123;</span><br><span class=\"line\">            proxy_cache test_cache;    #开启缓存对应的名称，在keys_zone命名好</span><br><span class=\"line\">            proxy_cache_valid 200 304 12h;    #状态码为200 304的缓存12小时</span><br><span class=\"line\">            proxy_cache_valid any 10m;    #其他状态缓存10小时</span><br><span class=\"line\">            proxy_cache_key $host$uri$is_args$args;    #设置key值</span><br><span class=\"line\">            add_header Nginx-Cache &quot;$upstream_cache_status&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        #不使用缓存</span><br><span class=\"line\">        if ($request_uri ~ ^&#x2F;(login|register) ) &#123;    #当请求地址有login或register时</span><br><span class=\"line\">            set $nocache &#x3D; 1;    #设置一个自定义变量为true</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            location &#x2F; &#123;</span><br><span class=\"line\">            proxy_no_cache $nocache $arg_nocache $arg_comment;</span><br><span class=\"line\">            proxy_no_cache $http_pragma $http_authoriztion;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"Nginx配置详解","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/Nginx%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/","content":"<h2 id=\"Nginx配置详解\"><a href=\"#Nginx配置详解\" class=\"headerlink\" title=\"Nginx配置详解\"></a>Nginx配置详解</h2><p>Nginx的配置是在nginx.conf中进行配置的</p>\n<p>主要由三部分组成</p>\n<ul>\n<li>全局块</li>\n<li>events块</li>\n<li>http块</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"全局块\"><a href=\"#全局块\" class=\"headerlink\" title=\"全局块\"></a>全局块</h3><p>从配置文件开始到events块之间的内容是全局块，主要用来配置Nginx服务器整体运行的配置指令，主要包括配置运行Nginx的用户组、允许生成的worker process数，进行PID存放路径、日志存放路径和类型以及配置文件的引入</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#nginx的用户和用户组</span><br><span class=\"line\">#user  nobody;</span><br><span class=\"line\"># nginx处理并发的数量，值越大，处理并发数量越多</span><br><span class=\"line\"># 通常为cpu数量</span><br><span class=\"line\">worker_processes  1;</span><br><span class=\"line\">#全局错误日志定义 位置 级别([ debug | info | notice | warn | error | crit ])</span><br><span class=\"line\">#error_log  logs&#x2F;error.log;</span><br><span class=\"line\">#error_log  logs&#x2F;error.log  notice;</span><br><span class=\"line\">#error_log  logs&#x2F;error.log  info;</span><br><span class=\"line\">#进程文件</span><br><span class=\"line\">#pid        logs&#x2F;nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">#一个nginx进程打开的最多文件描述符数目,理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除,但是nginx分配请求并不均匀,所以建议与ulimit -n的值保持一致.</span><br><span class=\"line\">worker_rlimit_nofile 65535;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"events块\"><a href=\"#events块\" class=\"headerlink\" title=\"events块\"></a>events块</h3><p>主要是影响Nginx服务器与用户网络的连接，常用的配置包括是否开启对多worker process下的网络连接进行序列化，是否允许同时接受多个网络连接，选取那种事件驱动模型来处理连接请求，每个worker process可以同时支持的并发数</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">events &#123;</span><br><span class=\"line\">#use [ kqueue | rtsig | epoll | &#x2F;dev&#x2F;poll | select | poll ];</span><br><span class=\"line\">    #epoll模型是Linux内核中的高性能网络I&#x2F;O模型，如果在mac上面，就用kqueue模型。</span><br><span class=\"line\">    use kqueue;</span><br><span class=\"line\"># 每个worker process可以同时支持的连接数为1024</span><br><span class=\"line\"># nginx支持的最大并发数是worker_processes*worker_connections</span><br><span class=\"line\">#如果是作为反向代理服务器的话，最大并发数是worker_processes*worker_connections&#x2F;2,因为反向代理服务器，每个并发会建立与客户端的连接和与后端的连接，会占用两个连接</span><br><span class=\"line\">    worker_connections  1024;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"http块\"><a href=\"#http块\" class=\"headerlink\" title=\"http块\"></a>http块</h3><p>Nginx配置中修改最频繁的配置就是http块的配置</p>\n<p>http块又分为了http全局块和server块</p>\n<h4 id=\"http全局块\"><a href=\"#http全局块\" class=\"headerlink\" title=\"http全局块\"></a>http全局块</h4><p>主要配置的是文件的引入、MIME-TYPE定义、日志自定义、连接超时时间、单链接请求上限等</p>\n<p>server块主要是虚拟主机的配置</p>\n<p>又分为了server全局块和location块</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">http &#123;</span><br><span class=\"line\">        # 文件扩展名与文件类型映射表</span><br><span class=\"line\">    include       mime.types;</span><br><span class=\"line\">    # 默认文件类型</span><br><span class=\"line\">    default_type  application&#x2F;octet-stream;</span><br><span class=\"line\">    </span><br><span class=\"line\">    #默认编码</span><br><span class=\"line\">    #charset utf-8; </span><br><span class=\"line\">    #服务器名字的hash表大小</span><br><span class=\"line\">    server_names_hash_bucket_size 128; </span><br><span class=\"line\">    #上传文件大小限制</span><br><span class=\"line\">    client_header_buffer_size 32k; </span><br><span class=\"line\">    #设定请求缓冲</span><br><span class=\"line\">    large_client_header_buffers 4 64k; </span><br><span class=\"line\">     #设定请求缓冲</span><br><span class=\"line\">    client_max_body_size 8m;</span><br><span class=\"line\">    </span><br><span class=\"line\">    # 开启目录列表访问,合适下载服务器,默认关闭.</span><br><span class=\"line\">    # 显示目录</span><br><span class=\"line\">    autoindex on; </span><br><span class=\"line\">    # 显示文件大小 默认为on,显示出文件的确切大小,单位是bytes 改为off后,显示出文件的大概大小,单位是kB或者MB或者GB</span><br><span class=\"line\">    autoindex_exact_size on; </span><br><span class=\"line\">    # 显示文件时间 默认为off,显示的文件时间为GMT时间 改为on后,显示的文件时间为文件的服务器时间</span><br><span class=\"line\">    autoindex_localtime on; </span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">        #日志格式化</span><br><span class=\"line\">    #log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class=\"line\">    #                  &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class=\"line\">    #                  &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br><span class=\"line\">        # 日志保存 日志的格式使用main</span><br><span class=\"line\">    #access_log  logs&#x2F;access.log  main;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">        # sendfile  高效传输文件的模式</span><br><span class=\"line\">    sendfile        on;</span><br><span class=\"line\">    # 将文件一次性一起传输给客户端，提高网络包的传输效率</span><br><span class=\"line\">    #tcp_nopush     on;</span><br><span class=\"line\">    # 开启实时传输，与tcp_nopush相反，只在长连接下有效</span><br><span class=\"line\">    #tcp_nodelay on;</span><br><span class=\"line\">        </span><br><span class=\"line\">        #连接超时时间</span><br><span class=\"line\">    #keepalive_timeout  0;</span><br><span class=\"line\">    keepalive_timeout  65;</span><br><span class=\"line\">    </span><br><span class=\"line\">    # FastCGI相关参数是为了改善网站的性能：减少资源占用,提高访问速度.下面参数看字面意思都能理解.</span><br><span class=\"line\">    fastcgi_connect_timeout 300;</span><br><span class=\"line\">    fastcgi_send_timeout 300;</span><br><span class=\"line\">    fastcgi_read_timeout 300;</span><br><span class=\"line\">    fastcgi_buffer_size 64k;</span><br><span class=\"line\">    fastcgi_buffers 4 64k;</span><br><span class=\"line\">    fastcgi_busy_buffers_size 128k;</span><br><span class=\"line\">    fastcgi_temp_file_write_size 128k;</span><br><span class=\"line\"></span><br><span class=\"line\">        #gzip压缩</span><br><span class=\"line\">    #gzip  on;</span><br><span class=\"line\">    #允许压缩的页面的最小字节数,页面字节数从header偷得content-length中获取.默认是0,不管页面多大都进行压缩.建议设置成大于1k的字节数,小于1k可能会越压越大</span><br><span class=\"line\">    gzip_min_length 1k; </span><br><span class=\"line\">    #表示申请4个单位为16k的内存作为压缩结果流缓存,默认值是申请与原始数据大小相同的内存空间来存储gzip压缩结果</span><br><span class=\"line\">    gzip_buffers 4 16k; </span><br><span class=\"line\">    #压缩版本（默认1.1,目前大部分浏览器已经支持gzip解压.前端如果是squid2.5请使用1.0）</span><br><span class=\"line\">    gzip_http_version 1.1; </span><br><span class=\"line\">    #压缩等级.1压缩比最小,处理速度快.9压缩比最大,比较消耗cpu资源,处理速度最慢,但是因为压缩比最大,所以包最小,传输速度快</span><br><span class=\"line\">    gzip_comp_level 2; </span><br><span class=\"line\">    #压缩类型,默认就已经包含text&#x2F;html,所以下面就不用再写了,写上去也不会有问题,但是会有一个warn.</span><br><span class=\"line\">    gzip_types text&#x2F;plain application&#x2F;x-javascript text&#x2F;css application&#x2F;xml;</span><br><span class=\"line\">    #选项可以让前端的缓存服务器缓存经过gzip压缩的页面.例如:用squid缓存经过nginx压缩的数据</span><br><span class=\"line\">    gzip_vary on;</span><br><span class=\"line\">    </span><br><span class=\"line\">    #实际的服务器列表</span><br><span class=\"line\">    #upstream myserver &#123;</span><br><span class=\"line\">    #    server 127.0.0.1:8080;</span><br><span class=\"line\">    #    server 127.0.0.1:8082;</span><br><span class=\"line\">    #&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        # 虚拟主机设置</span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">            #监听的端口号</span><br><span class=\"line\">        listen       8080;</span><br><span class=\"line\">        #访问域名</span><br><span class=\"line\">        server_name  localhost;</span><br><span class=\"line\">                #编码格式</span><br><span class=\"line\">        #charset koi8-r;</span><br><span class=\"line\">                #虚拟主机访问日志定义</span><br><span class=\"line\">        #access_log  logs&#x2F;host.access.log  main;</span><br><span class=\"line\">                # url匹配</span><br><span class=\"line\">        location &#x2F; &#123;</span><br><span class=\"line\">            root   html;</span><br><span class=\"line\">            index  index.html index.htm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        #error_page  404              &#x2F;404.html;</span><br><span class=\"line\"></span><br><span class=\"line\">        # redirect server error pages to the static page &#x2F;50x.html</span><br><span class=\"line\">        #</span><br><span class=\"line\">        error_page   500 502 503 504  &#x2F;50x.html;</span><br><span class=\"line\">        location &#x3D; &#x2F;50x.html &#123;</span><br><span class=\"line\">            root   html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        # deny access to .htaccess files, if Apache&#39;s document root</span><br><span class=\"line\">        # concurs with nginx&#39;s one</span><br><span class=\"line\">        # 禁止访问.ht文件</span><br><span class=\"line\">        #location ~ &#x2F;\\.ht &#123;</span><br><span class=\"line\">        #    禁止下载</span><br><span class=\"line\">        #    deny  all;</span><br><span class=\"line\">        #&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    server</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        # 监听端口 HTTPS</span><br><span class=\"line\">        listen 443 ssl;</span><br><span class=\"line\">        server_name ably.com;</span><br><span class=\"line\">        </span><br><span class=\"line\">        # 配置域名证书</span><br><span class=\"line\">        ssl_certificate      &#x2F;server&#x2F;Certs&#x2F;certificate.crt;</span><br><span class=\"line\">        ssl_certificate_key  &#x2F;WebServer&#x2F;Certs&#x2F;private.key;</span><br><span class=\"line\">        ssl_session_cache    shared:SSL:1m;</span><br><span class=\"line\">        ssl_session_timeout  5m;</span><br><span class=\"line\">        ssl_protocols SSLv2 SSLv3 TLSv1;</span><br><span class=\"line\">        ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;</span><br><span class=\"line\">        ssl_prefer_server_ciphers  on;</span><br><span class=\"line\">    </span><br><span class=\"line\">        index index.html index.htm index.php;</span><br><span class=\"line\">        root &#x2F;data&#x2F;www&#x2F;;</span><br><span class=\"line\">        location ~ .*\\.(php|php5)?$</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            fastcgi_pass 127.0.0.1:9000;</span><br><span class=\"line\">            fastcgi_index index.php;</span><br><span class=\"line\">            include fastcgi.conf;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        # 配置地址拦截转发，解决跨域验证问题</span><br><span class=\"line\">        location &#x2F;oauth&#x2F;&#123;</span><br><span class=\"line\">            proxy_pass https:&#x2F;&#x2F;localhost:13580&#x2F;oauth&#x2F;;</span><br><span class=\"line\">            proxy_set_header HOST $host;</span><br><span class=\"line\">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        # 图片缓存时间设置</span><br><span class=\"line\">        location ~ .*\\.(gif|jpg|jpeg|png|bmp|swf)$ &#123;</span><br><span class=\"line\">            expires 10d;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        # JS和CSS缓存时间设置</span><br><span class=\"line\">        location ~ .*\\.(js|css)?$ &#123;</span><br><span class=\"line\">            expires 1h;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        # 日志格式设定</span><br><span class=\"line\">        log_format access &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class=\"line\">        &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class=\"line\">        &#39;&quot;$http_user_agent&quot; $http_x_forwarded_for&#39;;</span><br><span class=\"line\">        # 定义本虚拟主机的访问日志</span><br><span class=\"line\">        access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log access;</span><br><span class=\"line\">        </span><br><span class=\"line\">        # 设定查看Nginx状态的地址.StubStatus模块能够获取Nginx自上次启动以来的工作状态，此模块非核心模块，需要在Nginx编译安装时手工指定才能使用</span><br><span class=\"line\">        location &#x2F;NginxStatus &#123;</span><br><span class=\"line\">            stub_status on;</span><br><span class=\"line\">            access_log on;</span><br><span class=\"line\">            auth_basic &quot;NginxStatus&quot;;</span><br><span class=\"line\">            auth_basic_user_file conf&#x2F;htpasswd;</span><br><span class=\"line\">            #htpasswd文件的内容可以用apache提供的htpasswd工具来产生.</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    include servers&#x2F;*;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"location配置\"><a href=\"#location配置\" class=\"headerlink\" title=\"location配置\"></a>location配置</h5><h6 id=\"匹配规则\"><a href=\"#匹配规则\" class=\"headerlink\" title=\"匹配规则\"></a>匹配规则</h6><p>location有多种匹配规则[=|<del>|</del>*|^~] /url/</p>\n<ul>\n<li>=表示精确匹配，优先级最高</li>\n<li>^~表示uri以某个字符串开头，即^~/spring/ 可以被所有以/spring/开头的匹配到</li>\n<li>~为区分大小写的正则匹配，如果使用!~则表示取反，不匹配的正则</li>\n<li>~<em>为不区分大小写的正则匹配，如果使用!~\\</em>则表示取反，不匹配的正则</li>\n<li>/通用匹配，任何请求都会匹配到</li>\n</ul>\n<h5 id=\"静态文件路径\"><a href=\"#静态文件路径\" class=\"headerlink\" title=\"静态文件路径\"></a>静态文件路径</h5><p>可以使用root或alias来指定静态资源文件路径，root可以配置在http块、server块、location块以及if块中，alias只能配置在location块中</p>\n<h6 id=\"root\"><a href=\"#root\" class=\"headerlink\" title=\"root\"></a>root</h6><p>使用root来表示请求的url时会进行完整的拼接，即如果请求使用的uri是/pic/index.html的话，使用root实际获取的是/data/www/web/pic/index.html</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">location &#x2F;pic&#x2F; &#123;</span><br><span class=\"line\">    root &#x2F;data&#x2F;www&#x2F;web;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h6 id=\"alias\"><a href=\"#alias\" class=\"headerlink\" title=\"alias\"></a>alias</h6><p>alias会将location中配置的路径丢弃掉，即即如果请求使用的uri是/pic/index.html的话，使用alias实际获取的是/data/www/web/index.html</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">location &#x2F;pic&#x2F; &#123;</span><br><span class=\"line\">    alias &#x2F;data&#x2F;www&#x2F;web;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Nginx常见配置参数\"><a href=\"#Nginx常见配置参数\" class=\"headerlink\" title=\"Nginx常见配置参数\"></a>Nginx常见配置参数</h3><ul>\n<li>server_names_hash_max_size 1024;</li>\n<li>server_names_hash_bucket_size 512;</li>\n<li>client_header_buffer_size 32k; # 客户端请求头部的缓冲区大</li>\n<li>large_client_header_buffers 4 32k;</li>\n<li>client_max_body_size 10m;#设置最大的允许客户端请求主体的大小(上传文件大小限制), 默认为1m</li>\n<li>client_body_buffer_size 128k;</li>\n<li>keepalive_timeout 60; #客户端连接超时时间，单位是秒, 默认是75秒</li>\n<li>sendfile on; # 开启高效传输模式,默认为off</li>\n<li>tcp_nopush on;</li>\n<li>tcp_nodelay on;</li>\n<li>ssi on; # 开启ssi支持，默认为false</li>\n<li>ssi_silent_errors on; # 设置为on表示在处理ssi文件时不输出错误信息，默认为false</li>\n<li>ssi_types text/html; # 默认支持html ,如果需要支持shtml(服务器执行脚本)，需要设置为ssi_types text/shtml</li>\n<li>server_tokens off; # 关闭nginx版本号的显示，默认为on</li>\n</ul>\n<h3 id=\"Nginx优化相关参数\"><a href=\"#Nginx优化相关参数\" class=\"headerlink\" title=\"Nginx优化相关参数\"></a>Nginx优化相关参数</h3><ul>\n<li>worker_processes 2; # 配置生成的worker process数量，一般为cpu核数</li>\n<li>worker_rlimit_nofile 65536; # 一个nginx进程打开的最多文件描述符数目，一般设置为与系统设定的值相同(ulimit -n)</li>\n<li>worker_cpu_affinity 01 10;# 为每个进程分配CPU的工作内核</li>\n<li>use epoll; # 事务模型</li>\n</ul>\n<figure class=\"highlight nginx\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\"> <span class=\"attribute\">use</span> <span class=\"literal\">epoll</span>; <span class=\"comment\"># 事务模型</span></span><br><span class=\"line\"> <span class=\"attribute\">worker_connections</span> <span class=\"number\">20000</span>; <span class=\"comment\"># 一个nginx进程的连接数，nginx服务器允许的同事连接的客户端最大数量Client = worker_processes * worker_connections/2;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Nginx常见用法\"><a href=\"#Nginx常见用法\" class=\"headerlink\" title=\"Nginx常见用法\"></a>Nginx常见用法</h3><h4 id=\"依据UA屏蔽爬虫\"><a href=\"#依据UA屏蔽爬虫\" class=\"headerlink\" title=\"依据UA屏蔽爬虫\"></a>依据UA屏蔽爬虫</h4><figure class=\"highlight autoit\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($http_user_agent ~* <span class=\"string\">&quot;qihoobot|Baiduspider|Googlebot|Googlebot-Mobile|Googlebot-Image|Mediapartners-Google|Adsbot-Google|Feedfetcher-Google|Yahoo! Slurp|Yahoo! Slurp China|YoudaoBot|Sosospider|Sogou</span></span><br><span class=\"line\"><span class=\"string\">spider|Sogou web spider|MSNBot|ia_archiver|Tomato Bot&quot;</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">403</span><span class=\"comment\">;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"屏蔽IP访问\"><a href=\"#屏蔽IP访问\" class=\"headerlink\" title=\"屏蔽IP访问\"></a>屏蔽IP访问</h4><figure class=\"highlight angelscript\"><table><tr><td class=\"code\"><pre><span class=\"line\">allow <span class=\"number\">133.27</span><span class=\"number\">.182</span><span class=\"number\">.82</span>;</span><br><span class=\"line\">allow <span class=\"number\">113.106</span><span class=\"number\">.18</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>;</span><br><span class=\"line\">allow <span class=\"number\">121.201</span><span class=\"number\">.104</span><span class=\"number\">.0</span>/<span class=\"number\">24</span>;</span><br><span class=\"line\">deny all;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用Auth权限访问\"><a href=\"#使用Auth权限访问\" class=\"headerlink\" title=\"使用Auth权限访问\"></a>使用Auth权限访问</h4><figure class=\"highlight awk\"><table><tr><td class=\"code\"><pre><span class=\"line\">auth_basic <span class=\"string\">&quot;bbs-auth&quot;</span>;</span><br><span class=\"line\">auth_basic_user_file <span class=\"regexp\">/usr/</span>local<span class=\"regexp\">/nginx/</span>conf/bbsauthpwd;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"限制带宽\"><a href=\"#限制带宽\" class=\"headerlink\" title=\"限制带宽\"></a>限制带宽</h4><figure class=\"highlight angelscript\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 用户下载达到 <span class=\"number\">500</span>k 后，便控制其速度在 <span class=\"number\">50</span>k 以内</span><br><span class=\"line\">location /download/ &#123;</span><br><span class=\"line\">    limit_rate_after <span class=\"number\">500</span>k;</span><br><span class=\"line\">    limit_rate <span class=\"number\">50</span>k;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"限制连接\"><a href=\"#限制连接\" class=\"headerlink\" title=\"限制连接\"></a>限制连接</h4><figure class=\"highlight nginx\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义了一个名为“down”，10M大小，以连接IP为key的连接数据存储空间</span></span><br><span class=\"line\"><span class=\"attribute\">limit_conn_zone</span> <span class=\"variable\">$binary_remote_addr</span> zone=down:<span class=\"number\">10m</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\"># 读取名为`down`连接数据存储空间的数据，限制每个key(上面是以ip作为IP) 最大同时连接数为4</span></span><br><span class=\"line\"><span class=\"attribute\">location</span> <span class=\"regexp\">~ .*\\.(rar|zip|apk)?$</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">limit_conn</span> down <span class=\"number\">4</span>;</span><br><span class=\"line\">    <span class=\"attribute\">limit_rate</span> <span class=\"number\">150k</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"attribute\">limit_conn_log_level</span> <span class=\"literal\">notice</span>: 指定当触发limit的时候日志打印级别</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"限制请求\"><a href=\"#限制请求\" class=\"headerlink\" title=\"限制请求\"></a>限制请求</h4><figure class=\"highlight angelscript\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 定义一个名为”one”, <span class=\"number\">10</span>M大小，每秒<span class=\"number\">1</span>个请求的请求数据存储空间</span><br><span class=\"line\">limit_req_zone $binary_remote_addr zone=one:<span class=\"number\">10</span>m rate=<span class=\"number\">10</span>r/s;</span><br><span class=\"line\">    </span><br><span class=\"line\"># 引用名为“one”的存储空间，burst为等待请求数量数，当等待请求数量超过<span class=\"number\">50</span>个时，则抛出<span class=\"number\">503</span>错误,nodelay 针对的是 burst 参数，burst=<span class=\"number\">50</span> nodelay 表示这<span class=\"number\">50</span>个请求立马处理，不能延迟，相当于特事特办。不过，即使这<span class=\"number\">20</span>个突发请求立马处理结束，后续来了请求也不会立马处理。burst=<span class=\"number\">50</span> 相当于缓存队列中占了<span class=\"number\">50</span>个坑，即使请求被处理了，这<span class=\"number\">20</span>个位置这只能按 <span class=\"number\">100</span>ms一个来释放</span><br><span class=\"line\">limit_req zone=one burst=<span class=\"number\">50</span> nodelay;</span><br><span class=\"line\">limit_req_log_level notice: 指定当触发limit的时候日志打印级别</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"实时显示Nginx运行状况\"><a href=\"#实时显示Nginx运行状况\" class=\"headerlink\" title=\"实时显示Nginx运行状况\"></a>实时显示Nginx运行状况</h4><p>在安装nginx是编译http_stub_status_module即可，使用参数为–with-http_stub_status_module</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span> /ngx_status &#123;</span><br><span class=\"line\">    <span class=\"attribute\">stub_status</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"设置错误页面\"><a href=\"#设置错误页面\" class=\"headerlink\" title=\"设置错误页面\"></a>设置错误页面</h4><figure class=\"highlight angelscript\"><table><tr><td class=\"code\"><pre><span class=\"line\">error_page <span class=\"number\">404</span> /<span class=\"number\">404.</span>html</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Nginx-常见错误码\"><a href=\"#Nginx-常见错误码\" class=\"headerlink\" title=\"Nginx 常见错误码\"></a>Nginx 常见错误码</h4><ul>\n<li>301 永久重定向</li>\n<li>302 临时重定向</li>\n<li>403 禁止访问</li>\n<li>404 文件不存在</li>\n<li>413 文件上传超过限制</li>\n<li>500 服务器错误</li>\n<li>502 后台服务器无响应</li>\n<li>504 Nginx超时，请求过多，工作进程不足</li>\n</ul>\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"Nginx重定向","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/Nginx%E9%87%8D%E5%AE%9A%E5%90%91/","content":"<h2 id=\"Nginx重定向\"><a href=\"#Nginx重定向\" class=\"headerlink\" title=\"Nginx重定向\"></a>Nginx重定向</h2><p>可以使用Nginx来设置重定向，Nginx有两种设置重定向方式</p>\n<ul>\n<li>return形式</li>\n<li>rewrite形式</li>\n</ul>\n<h3 id=\"return形式\"><a href=\"#return形式\" class=\"headerlink\" title=\"return形式\"></a>return形式</h3><p>可以使用</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#以下三种都可以</span><br><span class=\"line\">return code;</span><br><span class=\"line\">return url;</span><br><span class=\"line\">return code url;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>示例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#301表示永久重定向  302表示临时重定向</span><br><span class=\"line\">return 301 http:&#x2F;&#x2F;baidu.com</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"rewrite形式\"><a href=\"#rewrite形式\" class=\"headerlink\" title=\"rewrite形式\"></a>rewrite形式</h3><p>示例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">rewrite ^&#x2F;$ http:&#x2F;&#x2F;baidu.com permanent</span><br></pre></td></tr></table></figure>\n\n<p>最后一项为flag，有以下几种选择</p>\n<ul>\n<li>last      停止处理后续rewrite指令集，然后对当前重写的新url在rewrite指令集上重新查找</li>\n<li>break   停职处理后续rewrite指令集，并不在重新查找，但是当前location内剩余非rewrite语句和location外的非rewrite语句可以执行</li>\n<li>redirect  如果replacament不是以http://或https://开头，返回302临时重定向</li>\n<li>parmanent  返回301永久重定向</li>\n</ul>\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"Nginx可用参数","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/%E5%8F%82%E6%95%B0/","content":"<h2 id=\"Nginx可用参数\"><a href=\"#Nginx可用参数\" class=\"headerlink\" title=\"Nginx可用参数\"></a>Nginx可用参数</h2><table>\n<thead>\n<tr>\n<th>参数名称</th>\n<th>注释</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>$arg_NAME</td>\n<td>HTTP 请求中某个参数的值，如/index.html?name=zhangsan，可以用$arg_name 取得zhangsan</td>\n</tr>\n<tr>\n<td>$args</td>\n<td>HTTP 请求中的完整参数。例如，在请求/index.html?id=1&amp;name=zhangsan 中，$args 表示字符串 id=1&amp;name=zhangsan.</td>\n</tr>\n<tr>\n<td>$binary_remote_addr</td>\n<td>二进制格式的客户端地址。例如：\\x0A\\xE0B\\x0E</td>\n</tr>\n<tr>\n<td>$body_bytes_sent</td>\n<td>表示在向客户端发送的 http 响应中，包体部分的字节数</td>\n</tr>\n<tr>\n<td>$content_length</td>\n<td>表示客户端请求头部中的 Content-Length 字段</td>\n</tr>\n<tr>\n<td>$content_type</td>\n<td>表示客户端请求头部中的 Content-Type 字段</td>\n</tr>\n<tr>\n<td>$cookie_NAME</td>\n<td>表示在客户端请求头部中的 cookie 字段，获取指定cookie</td>\n</tr>\n<tr>\n<td>$document_root</td>\n<td>表示当前请求所使用的 root 配置项的值</td>\n</tr>\n<tr>\n<td>$uri</td>\n<td>表示当前请求的 URI，不带任何参数</td>\n</tr>\n<tr>\n<td>$document_uri</td>\n<td>与$uri 含义相同</td>\n</tr>\n<tr>\n<td>$request_uri</td>\n<td>表示客户端发来的原始请求 URI，带完整的参数。$uri 和$document_uri 未必是用户的原始请求，在内部重定向后可能是重定向后的 URI，而$request_uri 永远不会改变，始终是客户端的原始 URI.</td>\n</tr>\n<tr>\n<td>$host</td>\n<td>表示客户端请求头部中的 Host 字段。如果 Host 字段不存在，则以实际处理的 server（虚拟主机）名称代替。如果 Host 字段中带有端口，如 IP:PORT，那么$host 是去掉端口的，它的值为 IP。$host 是全小写的。这些特性与 http_HEADER 中的 http_host 不同，http_host 只取出 Host 头部对应的值。</td>\n</tr>\n<tr>\n<td>$hostname</td>\n<td>表示 Nginx 所在机器的名称，与 gethostbyname 调用返回的值相同</td>\n</tr>\n<tr>\n<td>$http_HEADER</td>\n<td>表示当前 HTTP 请求中相应头部的值。HEADER 名称全小写。例如，示请求中 Host 头部对应的值</td>\n</tr>\n<tr>\n<td>$sent_http_HEADER</td>\n<td>表示返回客户端的 HTTP 响应中相应头部的值。HEADER 名称全小写。例如，用 $sent_http_content_type 表示响应中 Content-Type 头部对应的值</td>\n</tr>\n<tr>\n<td>$is_args</td>\n<td>表示请求中的 URI 是否带参数，如果带参数，$is_args 值为 ?，如果不带参数，则是空字符串</td>\n</tr>\n<tr>\n<td>$limit_rate</td>\n<td>表示当前连接的限速是多少，0 表示无限速</td>\n</tr>\n<tr>\n<td>$nginx_version</td>\n<td>表示当前 Nginx 的版本号</td>\n</tr>\n<tr>\n<td>$query_string</td>\n<td>请求 URI 中的参数，与 $args 相同，然而 $query_string 是只读的不会改变</td>\n</tr>\n<tr>\n<td>$remote_addr</td>\n<td>表示客户端的地址</td>\n</tr>\n<tr>\n<td>$remote_port</td>\n<td>表示客户端连接使用的端口</td>\n</tr>\n<tr>\n<td>$remote_user</td>\n<td>表示使用 Auth Basic Module 时定义的用户名</td>\n</tr>\n<tr>\n<td>$request_filename</td>\n<td>表示用户请求中的 URI 经过 root 或 alias 转换后的文件路径</td>\n</tr>\n<tr>\n<td>$request_body</td>\n<td>表示 HTTP 请求中的包体，该参数只在 proxy_pass 或 fastcgi_pass 中有意义</td>\n</tr>\n<tr>\n<td>$request_body_file</td>\n<td>表示 HTTP 请求中的包体存储的临时文件名</td>\n</tr>\n<tr>\n<td>$request_completion</td>\n<td>当请求已经全部完成时，其值为 “ok”。若没有完成，就要返回客户端，则其值为空字符串；或者在断点续传等情况下使用 HTTP range 访问的并不是文件的最后一块，那么其值也是空字符串。</td>\n</tr>\n<tr>\n<td>$request_method</td>\n<td>表示 HTTP 请求的方法名，如 GET、PUT、POST 等</td>\n</tr>\n<tr>\n<td>$scheme</td>\n<td>表示 HTTP scheme，如在请求 <a href=\"https://nginx.com/%E4%B8%AD%E8%A1%A8%E7%A4%BA\">https://nginx.com/中表示</a> https</td>\n</tr>\n<tr>\n<td>$server_addr</td>\n<td>表示服务器地址</td>\n</tr>\n<tr>\n<td>$server_name</td>\n<td>表示服务器名称</td>\n</tr>\n<tr>\n<td>$server_port</td>\n<td>表示服务器端口</td>\n</tr>\n<tr>\n<td>$server_protocol</td>\n<td>表示服务器向客户端发送响应的协议，如 HTTP/1.1 或 HTTP/1.0</td>\n</tr>\n</tbody></table>\n<a id=\"more\"></a>\n\n<h3 id=\"使用参数来进行条件判断\"><a href=\"#使用参数来进行条件判断\" class=\"headerlink\" title=\"使用参数来进行条件判断\"></a>使用参数来进行条件判断</h3><p>if(codition) {…}</p>\n<p>可以在server、location块使用</p>\n<p>示例</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">if($request_method &#x3D; POST)&#123;</span><br><span class=\"line\">    return 405;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>比较符：</p>\n<ul>\n<li>使用=、!=比较变量和字符串</li>\n<li>使用~、~*与正则表达式匹配的变量，如果正则中存在}或者;，则必须给整个正则加上引号</li>\n<li>使用-f、!-f 检查文件是否存在</li>\n<li>使用-d、!-d检查一个目录是否存在</li>\n<li>使用-e、!-e检查一个文件、目录、符号链接是否存在</li>\n<li>使用-x、!-x检查一个文件是否可执行</li>\n</ul>\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"Nginx日志设置","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/%E6%97%A5%E5%BF%97%E8%AE%BE%E7%BD%AE/","content":"<h2 id=\"Nginx日志设置\"><a href=\"#Nginx日志设置\" class=\"headerlink\" title=\"Nginx日志设置\"></a>Nginx日志设置</h2><p>Nginx日志分为两种，access_log(访问日志)和error_log(错误日志)</p>\n<h3 id=\"设置access-log\"><a href=\"#设置access-log\" class=\"headerlink\" title=\"设置access_log\"></a>设置access_log</h3><p>access_log主要用来记录客户端的请求。</p>\n<h4 id=\"作用域\"><a href=\"#作用域\" class=\"headerlink\" title=\"作用域\"></a>作用域</h4><p>可以在http、server、location中指定access_log</p>\n<a id=\"more\"></a>\n\n<h4 id=\"语法\"><a href=\"#语法\" class=\"headerlink\" title=\"语法\"></a>语法</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># path 指定日志存放位置</span><br><span class=\"line\"># format 日志格式</span><br><span class=\"line\"># buffer 日志写入时缓存大小，默认64K</span><br><span class=\"line\"># gzip 日志写入时先进行压缩，level来指定压缩率，默认1，从1到9数值越大，压缩比越高，速度越慢</span><br><span class=\"line\"># flush 缓存有效时间，超过flush设置的时间，缓存内容清空</span><br><span class=\"line\"># if 是否写入日志的条件判断，如果为0或者空字符串，该请求将不会写入日志</span><br><span class=\"line\">access_log path [format [buffer&#x3D;size] [gzip&#x3D;level] [flush&#x3D;time] [if&#x3D;condition]];</span><br><span class=\"line\"># 开启access_log</span><br><span class=\"line\">access_log on;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"设置日志格式\"><a href=\"#设置日志格式\" class=\"headerlink\" title=\"设置日志格式\"></a>设置日志格式</h4><h5 id=\"语法-1\"><a href=\"#语法-1\" class=\"headerlink\" title=\"语法\"></a>语法</h5><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># name 格式名称，用来在日志指定中引用</span><br><span class=\"line\"># escape  编码格式使用，默认是default</span><br><span class=\"line\"># string  日志格式内容</span><br><span class=\"line\">log_format name [escape&#x3D;default|json] string;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"可用参数\"><a href=\"#可用参数\" class=\"headerlink\" title=\"可用参数\"></a>可用参数</h5><p>日志格式中可用的参数有</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">$bytes_sent</span><br><span class=\"line\">发送给客户端的总字节数</span><br><span class=\"line\"></span><br><span class=\"line\">$body_bytes_sent</span><br><span class=\"line\">发送给客户端的字节数，不包括响应头的大小</span><br><span class=\"line\"></span><br><span class=\"line\">$connection</span><br><span class=\"line\">连接序列号</span><br><span class=\"line\"></span><br><span class=\"line\">$connection_requests</span><br><span class=\"line\">当前通过连接发出的请求数量</span><br><span class=\"line\"></span><br><span class=\"line\">$msec</span><br><span class=\"line\">日志写入时间，单位为秒，精度是毫秒</span><br><span class=\"line\"></span><br><span class=\"line\">$pipe</span><br><span class=\"line\">如果请求是通过http流水线发送，则其值为&quot;p&quot;，否则为“.&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">$request_length</span><br><span class=\"line\">请求长度（包括请求行，请求头和请求体）</span><br><span class=\"line\"></span><br><span class=\"line\">$request_time</span><br><span class=\"line\">请求处理时长，单位为秒，精度为毫秒，从读入客户端的第一个字节开始，直到把最后一个字符发送张客户端进行日志写入为止</span><br><span class=\"line\"></span><br><span class=\"line\">$status</span><br><span class=\"line\">响应状态码</span><br><span class=\"line\"></span><br><span class=\"line\">$time_iso8601</span><br><span class=\"line\">标准格式的本地时间,形如“2017-05-24T18:31:27+08:00”</span><br><span class=\"line\"></span><br><span class=\"line\">$time_local</span><br><span class=\"line\">通用日志格式下的本地时间，如&quot;24&#x2F;May&#x2F;2017:18:31:27 +0800&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">$http_referer</span><br><span class=\"line\">请求的referer地址。</span><br><span class=\"line\"></span><br><span class=\"line\">$http_user_agent</span><br><span class=\"line\">客户端浏览器信息。</span><br><span class=\"line\"></span><br><span class=\"line\">$remote_addr</span><br><span class=\"line\">客户端IP</span><br><span class=\"line\"></span><br><span class=\"line\">$http_x_forwarded_for</span><br><span class=\"line\">当前端有代理服务器时，设置web节点记录客户端地址的配置，此参数生效的前提是代理服务器也要进行相关的x_forwarded_for设置。</span><br><span class=\"line\"></span><br><span class=\"line\">$request</span><br><span class=\"line\">完整的原始请求行，如 &quot;GET &#x2F; HTTP&#x2F;1.1&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">$remote_user</span><br><span class=\"line\">客户端用户名称，针对启用了用户认证的请求</span><br><span class=\"line\"></span><br><span class=\"line\">$request_uri</span><br><span class=\"line\">完整的请求地址，如 &quot;https:&#x2F;&#x2F;daojia.com&#x2F;&quot;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h5><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;</span><br><span class=\"line\">                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;</span><br><span class=\"line\">                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"设置error-log\"><a href=\"#设置error-log\" class=\"headerlink\" title=\"设置error_log\"></a>设置error_log</h3><h4 id=\"语法-2\"><a href=\"#语法-2\" class=\"headerlink\" title=\"语法\"></a>语法</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># file  日志文件写入位置</span><br><span class=\"line\"># level  日志级别，debug, info, notice, warn, error, crit, alert,emerg，默认是error</span><br><span class=\"line\">error_log file [level]</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"Nginx配置反向代理","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/%E9%85%8D%E7%BD%AE%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/","content":"<h2 id=\"Nginx配置反向代理\"><a href=\"#Nginx配置反向代理\" class=\"headerlink\" title=\"Nginx配置反向代理\"></a>Nginx配置反向代理</h2><p>在server块中配置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#监听80端口</span><br><span class=\"line\">listen       80;</span><br><span class=\"line\">#监听的ip或域名</span><br><span class=\"line\">server_name  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">#charset koi8-r;</span><br><span class=\"line\"></span><br><span class=\"line\">#access_log  logs&#x2F;host.access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">location &#x2F; &#123;</span><br><span class=\"line\">    root   html;</span><br><span class=\"line\">    index  index.html index.htm;</span><br><span class=\"line\">    # 转发到127.0.0.1:8080</span><br><span class=\"line\">    proxy_pass http:&#x2F;&#x2F;127.0.0.1:8080;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>也可以根据访问路径的不同来访问不同的服务器</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">   listen       8000;</span><br><span class=\"line\">   server_name  localhost;</span><br><span class=\"line\">   #项目的目录</span><br><span class=\"line\">root &#x2F;www&#x2F;work&#x2F;;</span><br><span class=\"line\">   # 路径中包含&#x2F;springmvc&#x2F;则跳转至8080端口</span><br><span class=\"line\">   #~表示后边是正则表达式</span><br><span class=\"line\">   location ~ &#x2F;springmvc&#x2F; &#123;</span><br><span class=\"line\">       root   html;</span><br><span class=\"line\">       index  index.html index.htm;</span><br><span class=\"line\">       # 转发到http:&#x2F;&#x2F;127.0.0.1:8080</span><br><span class=\"line\">       proxy_pass http:&#x2F;&#x2F;127.0.0.1:8080;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   # 路径中包含&#x2F;webstudy&#x2F;则跳转至8081端口</span><br><span class=\"line\">   location ~ &#x2F;webstudy&#x2F; &#123;</span><br><span class=\"line\">       root   html;</span><br><span class=\"line\">       index  index.html index.htm;</span><br><span class=\"line\">       # 转发到http:&#x2F;&#x2F;127.0.0.1:8081</span><br><span class=\"line\">       proxy_pass http:&#x2F;&#x2F;127.0.0.1:8081;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"※proxy-pass\"><a href=\"#※proxy-pass\" class=\"headerlink\" title=\"※proxy_pass\"></a>※proxy_pass</h3><p>proxy_pass将请求传递给HTTP服务器，这个也是用的最多的</p>\n<figure class=\"highlight apache\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">proxy_pass</span> http://baidu.com; # 设置被代理服务器的地址</span><br><span class=\"line\"><span class=\"attribute\">proxy_redirect</span> <span class=\"literal\">off</span>; # 修改响应头Location值，<span class=\"literal\">off</span>表示直接返回proxy_pass后的值，默认为default(客户端请求的URI),</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">proxy_connect_timeout</span> <span class=\"number\">600</span>;# 设置Nginx服务器与后端被代理服务器尝试建立连接的超时时间，默认为<span class=\"number\">60</span>s</span><br><span class=\"line\"><span class=\"attribute\">proxy_read_timeout</span> <span class=\"number\">600</span>; # 设置Nginx服务器向后端被代理服务器发出read请求后，等待响应的超时时间，默认为<span class=\"number\">60</span>s</span><br><span class=\"line\"><span class=\"attribute\">proxy_send_timeout</span> <span class=\"number\">600</span>; # 设置Nginx服务器向后端被代理服务器发出write请求后，等待响应的超时时间，默认为<span class=\"number\">60</span>s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">proxy_buffering</span>: <span class=\"literal\">on</span>; # 设置是否开启Proxy Buffer，默认为<span class=\"literal\">on</span></span><br><span class=\"line\"><span class=\"attribute\">proxy_buffer_size</span> <span class=\"number\">8</span>k; # 设置Nginx服务器从被代理服务器获取的第一段数据buffer大小，一般和proxy_buffers设置的buffer大小一致，或者更小, 默认为<span class=\"number\">4</span>k或者<span class=\"number\">8</span>k</span><br><span class=\"line\"><span class=\"attribute\">proxy_buffers</span> <span class=\"number\">4</span> <span class=\"number\">32</span>k; # 设置Proxy Buffer的个数和每个Buffer的大小</span><br><span class=\"line\"><span class=\"attribute\">proxy_busy_buffers_size</span> <span class=\"number\">64</span>k; # 设置处在Busy状态的Buffer总大小上限，默认为<span class=\"number\">8</span>K或者<span class=\"number\">16</span>K</span><br><span class=\"line\"><span class=\"attribute\">proxy_temp_file_write_size</span> <span class=\"number\">64</span>k; #当超过内存允许大小时，存到临时文件</span><br><span class=\"line\"><span class=\"attribute\">proxy_next_upstream</span> error timeout invalid_header http_<span class=\"number\">500</span> http_<span class=\"number\">503</span> http_<span class=\"number\">404</span>; # upstream设置被代理服务器集群时，设置组内服务器出现哪些异常时，可以依次轮询到下一个组内服务器处理</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">proxy_set_header</span> #设置请求头  如：proxy_set_header Host $http_host</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"fastcgi-pass\"><a href=\"#fastcgi-pass\" class=\"headerlink\" title=\"fastcgi_pass\"></a>fastcgi_pass</h3><p>fastcgi_pass将请求传递给FastCGI服务器</p>\n<figure class=\"highlight angelscript\"><table><tr><td class=\"code\"><pre><span class=\"line\">fastcgi_connect_timeout <span class=\"number\">3000</span>;</span><br><span class=\"line\">fastcgi_send_timeout <span class=\"number\">3000</span>;</span><br><span class=\"line\">fastcgi_read_timeout <span class=\"number\">3000</span>;</span><br><span class=\"line\">fastcgi_buffer_size <span class=\"number\">200</span>k;</span><br><span class=\"line\">fastcgi_buffers <span class=\"number\">8</span> <span class=\"number\">200</span>k;</span><br><span class=\"line\">fastcgi_busy_buffers_size <span class=\"number\">200</span>k;</span><br><span class=\"line\">fastcgi_max_temp_file_size:<span class=\"number\">1024</span>M; # 设置临时文件大小，默认为<span class=\"number\">1024</span>M</span><br><span class=\"line\">fastcgi_temp_file_write_size <span class=\"number\">200</span>k;# 配置同时写入临时文件的数据量的大小，合理的配置可以避免磁盘IO负载过高，导致系统性能下降,默认为<span class=\"number\">8</span>KB或<span class=\"number\">16</span>KB</span><br><span class=\"line\">fastcgi_temp_path /dev/shm; # 配置磁盘上的一个文件路径，用于临时存放代理服务器的大体积响应数据，如果proxy buffer 被装满后，响应数据仍然没有被Nginx服务器完全接收，响应数据就被会临时存放在该文件中</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"uwsgi-pass\"><a href=\"#uwsgi-pass\" class=\"headerlink\" title=\"uwsgi_pass\"></a>uwsgi_pass</h3><p>uwsgi_pass将请求传递给uwsgi服务器(如python服务)</p>\n<h3 id=\"scgi-pass\"><a href=\"#scgi-pass\" class=\"headerlink\" title=\"scgi_pass\"></a>scgi_pass</h3><p>scgi_pass将请求传递给SCGI服务器</p>\n<h3 id=\"memcached-pass\"><a href=\"#memcached-pass\" class=\"headerlink\" title=\"memcached_pass\"></a>memcached_pass</h3><p>memcached_pass将请求传递给memcached服务器</p>\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"Nginx配置负载均衡","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/","content":"<h2 id=\"Nginx配置负载均衡\"><a href=\"#Nginx配置负载均衡\" class=\"headerlink\" title=\"Nginx配置负载均衡\"></a>Nginx配置负载均衡</h2><p>使用nginx来配置负载均衡也是比较简单的</p>\n<p>首先在http块中配置虚拟域名所对应的地址</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 负载均衡</span><br><span class=\"line\">upstream myserver &#123;</span><br><span class=\"line\">    server 127.0.0.1:8080;</span><br><span class=\"line\">    server 127.0.0.1:8082;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<blockquote>\n<p>可以配置的参数有以下选项<br>#down         不参与负载均衡<br>#weight=5;    权重，越高分配越多<br>#backup;      预留的备份服务器<br>#max_fails    允许失败的次数<br>#fail_timeout 超过失败次数后，服务暂停时间<br>#max_coons    限制最大的接受的连接数<br>#根据服务器性能不同，配置适合的参数</p>\n</blockquote>\n<p>然后在server块中配置监听</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       9000;</span><br><span class=\"line\">    server_name  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">    location &#x2F; &#123;</span><br><span class=\"line\">        root   html;</span><br><span class=\"line\">        index  index.html index.htm;</span><br><span class=\"line\">        # 对应上述upstream所配置的名称</span><br><span class=\"line\">        proxy_pass http:&#x2F;&#x2F;myserver;</span><br><span class=\"line\">        </span><br><span class=\"line\">        ### 下面都是次要关注项</span><br><span class=\"line\">        proxy_set_header Host $host;</span><br><span class=\"line\">        proxy_method POST;</span><br><span class=\"line\"></span><br><span class=\"line\">          # 指定不转发的头部字段</span><br><span class=\"line\">        proxy_hide_header Cache-Control;</span><br><span class=\"line\"></span><br><span class=\"line\">          # 指定转发的头部字段</span><br><span class=\"line\">        proxy_pass_header Server-IP;</span><br><span class=\"line\"></span><br><span class=\"line\">          # 是否转发包体</span><br><span class=\"line\">        proxy_pass_request_body on | off;</span><br><span class=\"line\"></span><br><span class=\"line\">          # 是否转发头部</span><br><span class=\"line\">        proxy_pass_request_headers on | off;</span><br><span class=\"line\"></span><br><span class=\"line\">          # 显形&#x2F;隐形 URI，上游发生重定向时，Nginx 是否同步更改 uri</span><br><span class=\"line\">        proxy_redirect on | off;</span><br><span class=\"line\">        #允许客户端请求的最大单文件字节数</span><br><span class=\"line\">        client_max_body_size 10m; </span><br><span class=\"line\">        #缓冲区代理缓冲用户端请求的最大字节数</span><br><span class=\"line\">        client_body_buffer_size 128k;</span><br><span class=\"line\">        #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class=\"line\">        proxy_connect_timeout 90; </span><br><span class=\"line\">        #后端服务器数据回传时间(代理发送超时)</span><br><span class=\"line\">        proxy_send_timeout 90; </span><br><span class=\"line\">        #连接成功后,后端服务器响应时间(代理接收超时)</span><br><span class=\"line\">        proxy_read_timeout 90; </span><br><span class=\"line\">        #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class=\"line\">        proxy_buffer_size 4k; </span><br><span class=\"line\">        #proxy_buffers缓冲区,网页平均在32k以下的设置</span><br><span class=\"line\">        proxy_buffers 4 32k;</span><br><span class=\"line\">        #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class=\"line\">        proxy_busy_buffers_size 64k; </span><br><span class=\"line\">        #设定缓存文件夹大小,大于这个值,将从upstream服务器传</span><br><span class=\"line\">        proxy_temp_file_write_size 64k;</span><br><span class=\"line\">        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这样在使用9000端口访问服务器的时候就会进行8080和8082的负载调用</p>\n<h3 id=\"Nginx-负载均衡策略\"><a href=\"#Nginx-负载均衡策略\" class=\"headerlink\" title=\"Nginx 负载均衡策略\"></a>Nginx 负载均衡策略</h3><h4 id=\"轮询-默认\"><a href=\"#轮询-默认\" class=\"headerlink\" title=\"轮询(默认)\"></a>轮询(默认)</h4><p>按照时间顺序逐一的分配到不同的服务器，如果后端服务器挂掉，会自动删除</p>\n<h4 id=\"权重-weight\"><a href=\"#权重-weight\" class=\"headerlink\" title=\"权重(weight)\"></a>权重(weight)</h4><p>weight代表权重，默认为1，权重越大分配的请求越多</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 负载均衡</span><br><span class=\"line\">upstream myserver &#123;</span><br><span class=\"line\">    server 127.0.0.1:8080 weight&#x3D;1;</span><br><span class=\"line\">    server 127.0.0.1:8082 weight&#x3D;2;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"最少连接\"><a href=\"#最少连接\" class=\"headerlink\" title=\"最少连接\"></a>最少连接</h4><p>使用最少连接的负载均衡，可以防止过多的请求都堆积到一台服务器上</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 负载均衡</span><br><span class=\"line\">    upstream myserver &#123;</span><br><span class=\"line\">            least_conn;</span><br><span class=\"line\">        server 127.0.0.1:8080;</span><br><span class=\"line\">        server 127.0.0.1:8082;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"ip-hash\"><a href=\"#ip-hash\" class=\"headerlink\" title=\"ip_hash\"></a>ip_hash</h4><p>每个请求按照访问的ip进行hash分配，使得每个访问者固定访问某一个服务器，可以解决session问题</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 负载均衡</span><br><span class=\"line\">upstream myserver &#123;</span><br><span class=\"line\">        ip_hash;</span><br><span class=\"line\">    server 127.0.0.1:8080;</span><br><span class=\"line\">    server 127.0.0.1:8082;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"url-hash\"><a href=\"#url-hash\" class=\"headerlink\" title=\"url_hash\"></a>url_hash</h4><p>按照访问的url进行hash分配，每一个url定向到同一个后端服务器</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 负载均衡</span><br><span class=\"line\">upstream myserver &#123;</span><br><span class=\"line\">  hash $request_uri;</span><br><span class=\"line\">  server 127.0.0.1:8080;</span><br><span class=\"line\">  server 127.0.0.1:8082;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"fair-第三方\"><a href=\"#fair-第三方\" class=\"headerlink\" title=\"fair(第三方)\"></a>fair(第三方)</h4><p>根据请求的响应时间来分配，哪个服务器响应的快分配给谁</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 负载均衡</span><br><span class=\"line\">upstream myserver &#123;</span><br><span class=\"line\">        fair;</span><br><span class=\"line\">    server 127.0.0.1:8080;</span><br><span class=\"line\">    server 127.0.0.1:8082;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"Nginx配置限流","url":"/2021/%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx/%E9%85%8D%E7%BD%AE%E9%99%90%E6%B5%81/","content":"<h2 id=\"Nginx配置限流\"><a href=\"#Nginx配置限流\" class=\"headerlink\" title=\"Nginx配置限流\"></a>Nginx配置限流</h2><p>Nginx有限流功能，是基于漏桶算法实现的</p>\n<p>limit_req_zone是配置在http模块中的</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#设置限流  zone用来定义ip状态和url访问频率的共享区域，其中mylimit为区域名称，冒号后为区域大小，16000个IP地址的状态信息大约是1M，rate为最大请求速率(如每分钟一个请求)</span><br><span class=\"line\">limit_req_zone $binary_remote_addr zone&#x3D;mylimit:1m rate&#x3D;1r&#x2F;m;</span><br></pre></td></tr></table></figure>\n\n<p>limit_req是配置在location块、server块、http块中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 请求限流 zone为上述定义的区域名称  burst为排队大小  nodelay表示不限制单个请求的延迟时间</span><br><span class=\"line\">limit_req zone&#x3D;mylimit burst&#x3D;10 nodelay;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"burst作用\"><a href=\"#burst作用\" class=\"headerlink\" title=\"burst作用\"></a>burst作用</h3><p>漏桶算法是匀速的，如上述的示例rate=1r/m，每分钟就只漏出一个请求，如果一分钟来了很多的请求，就只能处理一个，其他的都抛弃掉。</p>\n<p>但是burst的配置可以使用FIFO队列可以将请求缓存起来，只有队列满了才会拒绝新的请求，默认情况下就算进了队列也是按照rate速率来执行的，每分钟执行一个</p>\n<h3 id=\"delay作用\"><a href=\"#delay作用\" class=\"headerlink\" title=\"delay作用\"></a>delay作用</h3><p>由于排队执行，延迟大大增加，可以使用delay来进行设置，首先nodelay表示没有延迟，在队列里的也是直接就执行</p>\n<p>由于没有延时了，导致同一时刻要同时处理漏出来的以及队列中的，那么如何控制并发数呢，可以使用delay来进行精确地配置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">limit_req zone&#x3D;mylimit burst&#x3D;10 delay&#x3D;5;</span><br></pre></td></tr></table></figure>\n\n<p>上述配置delay=5表示从队列中的第6个请求开始延时，这样可以控制并发的数量</p>\n","categories":["Nginx"],"tags":["Nginx"]},{"title":"DefaultServlet和JspServlet","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/DefaultServlet%E5%92%8CJspServlet/","content":"<p>在tomcat的conf/web.xml中有两个默认的Servlet，DefaultServlet和JspServlet</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>default<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.apache.catalina.servlets.DefaultServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>debug<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>listings<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>jsp<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.apache.jasper.servlet.JspServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>fork<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>xpoweredBy<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>false<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>3<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>default<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- The mappings for the JSP servlet --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>jsp<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>*.jsp<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>*.jspx<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"DefaultServlet\"><a href=\"#DefaultServlet\" class=\"headerlink\" title=\"DefaultServlet\"></a>DefaultServlet</h3><p>由于url-pattern为/，是默认的Servlet，当客户端请求不能匹配其他所有的Servlet时，由该Servlet处理</p>\n<p>主要用于处理静态资源，为了提升服务器性能，对访问文件进行了缓存</p>\n<h3 id=\"JspServlet\"><a href=\"#JspServlet\" class=\"headerlink\" title=\"JspServlet\"></a>JspServlet</h3><p>负责处理所有的jsp文件请求</p>\n<ul>\n<li>根据JSP文件生成对应的Servlet的java代码</li>\n<li>将java代码编译为java类</li>\n<li>构造Servlet实例并执行请求</li>\n</ul>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"tomcat之Coyote","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E4%B9%8BCoyote/","content":"<p>Catalina是Tomcat提供的Servlet容器，负责处理来自客户端的请求并输出响应，但是仅有Servlet容器服务器无法对外提供服务，还需要由链接器接收来自客户端的请求，并按照既定协议进行解析，然后交给Servlet容器处理。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"Coyote\"><a href=\"#Coyote\" class=\"headerlink\" title=\"Coyote\"></a>Coyote</h2><p>Coyote是Tomcat链接器框架的名称，是Tomcat服务器提供的供客户端访问的外部接口。客户端通过Coyote与服务器建立连接、发送请求并接收响应。</p>\n<p>Coyote封装了底层的网络通信（Socket请求和响应），为Catalina容器提供了统一的接口，使Catalina容器与具体的请求协议及I/O方式解耦。Coyote将Socket输入转换为Request对象，交由Catalina容器进行处理，处理完成后，Catalina通过Coyote提供的Response对象将结果写入到输出流</p>\n<p>Coyote中，Tomcat支持3种传输协议</p>\n<ul>\n<li><p>HTTP/1.1   主要用于Tomcat单独运行（不与Web服务器集成）的情况</p>\n</li>\n<li><p>AJP协议     用于和Web服务器集成，以实现针对静态资源的优化以及集群部署</p>\n</li>\n<li><p>HTTP/2.0   新的HTTP协议（Tomcat8.5之后开始支持）</p>\n</li>\n</ul>\n<p>针对HTTP和AJP协议，Coyote又按照I/O方式提供了几种方案（8.5之后移除了对BIO的支持）</p>\n<ul>\n<li>NIO   采用Java NIO类库实现</li>\n<li>NIO2  采用JDK7中最新的NIO2实现</li>\n<li>APR   采用APR实现。是使用C/C++编写的本地库，如果选择该方案，需要单独安装APR库</li>\n</ul>\n<h3 id=\"Connector核心概念\"><a href=\"#Connector核心概念\" class=\"headerlink\" title=\"Connector核心概念\"></a>Connector核心概念</h3><h4 id=\"Endpoint\"><a href=\"#Endpoint\" class=\"headerlink\" title=\"Endpoint\"></a>Endpoint</h4><p>Coyote通信端点，即通信监听的接口，是具体的Socket接收处理类，是对传输层的抽象。AbstractEndpoint抽象类，对于不同的I/O方式有不同的子类，NioEndpoint(NIO)、AprEndpoint(APR)以及Nio2Endpoint</p>\n<h4 id=\"Processor\"><a href=\"#Processor\" class=\"headerlink\" title=\"Processor\"></a>Processor</h4><p>Coyote协议处理接口，负责构造Request和Response对象，并通过Adapter将其提交到Catalina容器处理，是对应用层的抽象。Processor是单线程的，Tomcat在同一次链接中复用Processor。</p>\n<h4 id=\"ProtocolHandler\"><a href=\"#ProtocolHandler\" class=\"headerlink\" title=\"ProtocolHandler\"></a>ProtocolHandler</h4><p>Coyote协议接口，通过封装Endpoint和Processor，实现针对具体协议的处理功能。</p>\n<h4 id=\"UpgradeProtocol\"><a href=\"#UpgradeProtocol\" class=\"headerlink\" title=\"UpgradeProtocol\"></a>UpgradeProtocol</h4><p>Tomcat采用UpgradeProtocol接口表示HTTP升级协议，当前只提供了一个实现用于处理HTTP2.0</p>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"tomcat之JSP引擎","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E4%B9%8BJSP%E5%BC%95%E6%93%8E/","content":"<h2 id=\"JSP引擎\"><a href=\"#JSP引擎\" class=\"headerlink\" title=\"JSP引擎\"></a>JSP引擎</h2><p>Tomcat的jsp引擎是Jasper</p>\n<a id=\"more\"></a>\n\n<p>Tomcat JSP编译分为运行时编译和预编译两种。</p>\n<h4 id=\"运行时编译\"><a href=\"#运行时编译\" class=\"headerlink\" title=\"运行时编译\"></a>运行时编译</h4><p>Tomcat并不会在启动web应用时自动编译JSP文件，而是在客户端第一次请求时才编译需要访问的JSP文件</p>\n<p>在web.xml中默认配置了一个org.apache.jsper.servlet.JspServlet，用于处理所有的jsp结尾的请求，该Servlet实现即为运行时编译的入口。</p>\n<ul>\n<li><p>获取jsp文件路径</p>\n</li>\n<li><p>判断当前请求是否为预编译请求     预编译请求只是为了完成编译，而不实际执行    请求路径中包含jsp_precompile参数即为预编译请求（该参数只适用于请求直接定向到jsp页面的情况，如果采用spring mvc框架，还是会执行控制器代码，由于先走控制器，在将请求forward到jsp页面）</p>\n</li>\n<li><p>根据jsp文件构造JspServletWrapper对象，每个jsp页面对应一个JspServletWrapper实例</p>\n</li>\n</ul>\n<h4 id=\"预编译\"><a href=\"#预编译\" class=\"headerlink\" title=\"预编译\"></a>预编译</h4><p>Tomcat提供了一个shell程序JspC，用于支持Jsp预编译，将所有的jsp页面一次性编译完</p>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"tomcat之server配置文件","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E4%B9%8Bserver%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/","content":"<h2 id=\"server-xml配置文件\"><a href=\"#server-xml配置文件\" class=\"headerlink\" title=\"server.xml配置文件\"></a>server.xml配置文件</h2><h3 id=\"Server节点\"><a href=\"#Server节点\" class=\"headerlink\" title=\"Server节点\"></a>Server节点</h3><p>Server节点是server.xml的根元素，用于创建Server实例</p>\n<a id=\"more\"></a>\n\n<h4 id=\"属性\"><a href=\"#属性\" class=\"headerlink\" title=\"属性\"></a>属性</h4><ul>\n<li>port   端口</li>\n<li>shutdown   关闭服务器的指令字符串</li>\n</ul>\n<h4 id=\"子节点\"><a href=\"#子节点\" class=\"headerlink\" title=\"子节点\"></a>子节点</h4><p>内嵌子元素为Service、GlobalNamingResources和Listener</p>\n<p>GlobalNamingResources定义了全局的命名服务</p>\n<p>Listener用于为Server添加生命周期监听器</p>\n<h3 id=\"Service节点\"><a href=\"#Service节点\" class=\"headerlink\" title=\"Service节点\"></a>Service节点</h3><p>用于创建Service实例</p>\n<p>默认情况下，tomcat仅指定了Service的名称，值为Catalina</p>\n<h4 id=\"子节点-1\"><a href=\"#子节点-1\" class=\"headerlink\" title=\"子节点\"></a>子节点</h4><p>子节点为Listener、Executor、Connector、Engine</p>\n<p>Executor用于配置Service共享线程池</p>\n<p>Connector用于配置Service包含的链接器</p>\n<p>Engine用于配置Service中链接器对应的Servlet容器引擎</p>\n<h3 id=\"Executor节点\"><a href=\"#Executor节点\" class=\"headerlink\" title=\"Executor节点\"></a>Executor节点</h3><p>默认没有配置共享线程池</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Executor</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;tomcatThreadPool&quot;</span> <span class=\"attr\">namePrefix</span>=<span class=\"string\">&quot;catalina-exec-&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">maxThreads</span>=<span class=\"string\">&quot;150&quot;</span> <span class=\"attr\">minSpareThreads</span>=<span class=\"string\">&quot;4&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"属性-1\"><a href=\"#属性-1\" class=\"headerlink\" title=\"属性\"></a>属性</h4><ul>\n<li>name   Executor名称，唯一</li>\n<li>namePrefix    创建的线程名称前缀</li>\n<li>maxThreads    线程池中活动现成的最大数目</li>\n<li>minSpareThreads   备用线程的最小数量</li>\n</ul>\n<h3 id=\"Connector节点\"><a href=\"#Connector节点\" class=\"headerlink\" title=\"Connector节点\"></a>Connector节点</h3><p>默认配置了两个链接器，一个支持HTTP协议，一个支持AJP协议</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">&quot;8090&quot;</span> <span class=\"attr\">protocol</span>=<span class=\"string\">&quot;HTTP/1.1&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">connectionTimeout</span>=<span class=\"string\">&quot;20000&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">redirectPort</span>=<span class=\"string\">&quot;8443&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">&quot;8009&quot;</span> <span class=\"attr\">protocol</span>=<span class=\"string\">&quot;AJP/1.3&quot;</span> <span class=\"attr\">redirectPort</span>=<span class=\"string\">&quot;8443&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"属性-2\"><a href=\"#属性-2\" class=\"headerlink\" title=\"属性\"></a>属性</h4><ul>\n<li>port    端口号</li>\n<li>protocol   当前Connector支持的访问协议</li>\n<li>connectionTimeout    等待超时时间，-1表示不超时</li>\n<li>redirectPort    如果当前Connector支持non-ssl请求，并且接收到有个请求，符合<security-constraint>约束，需要SSL传输，Catalina自动将请求重定向到此处指定的端口</security-constraint></li>\n<li>executor   线程池，指定线程池名称</li>\n<li>acceptCount   最大接收链接数，用于控制Socket的排队链接的最大个数，大于acceptCount时，将拒绝新的链接请求</li>\n<li>URIEncoding   URI编码  默认为ISO-8859-1</li>\n<li>GZIP压缩      compression设置为on表示开启压缩    compressableMimeType表示指定哪些类型的响应可以压缩     compressionMinSize指定响应内容大小的限制，当响应大于该值时，才会压缩     noCompressionUserAgent用于指定正则表达式，对于user-agent头信息匹配的HTTP请求不进行压缩</li>\n<li>enableLookups    true表示调用request.getRemoteHost()将执行DNS查询     false直接返回IP</li>\n</ul>\n<h3 id=\"Engine节点\"><a href=\"#Engine节点\" class=\"headerlink\" title=\"Engine节点\"></a>Engine节点</h3><h4 id=\"子节点-2\"><a href=\"#子节点-2\" class=\"headerlink\" title=\"子节点\"></a>子节点</h4><p>Cluster、Listener、Realm、Value、Host</p>\n<h4 id=\"属性-3\"><a href=\"#属性-3\" class=\"headerlink\" title=\"属性\"></a>属性</h4><ul>\n<li>name   指定Engine的名称，默认为Catalina</li>\n<li>defaultHost    默认使用的虚拟主机名称，当客户端请求指向的主机无效时，将交由默认虚拟主机处理。默认localhost   </li>\n<li>jvmRoute   用于负载均衡场景下启用粘性会话，使得将来自于某个特定会话的请求定向到同一个Tomcat实例</li>\n</ul>\n<h3 id=\"Host节点\"><a href=\"#Host节点\" class=\"headerlink\" title=\"Host节点\"></a>Host节点</h3><p>用于配置一个虚拟主机，一个Host代表一个Web站点</p>\n<h4 id=\"子节点-3\"><a href=\"#子节点-3\" class=\"headerlink\" title=\"子节点\"></a>子节点</h4><p>Alias、Cluster、Listener、Value、Realm、Context</p>\n<h4 id=\"属性-4\"><a href=\"#属性-4\" class=\"headerlink\" title=\"属性\"></a>属性</h4><ul>\n<li>name    当前Host通用的网络名称，必须与DNS服务器上的注册信息一致</li>\n<li>appBase    当前Host的应用基础目录，默认为webapps</li>\n<li>unpackWARs   true表示Host在启动时会将appBase目录下的WAR包解压成目录     false直接从WAR文件中启动web应用</li>\n<li>autoDeploy    true表示tomcat将定期检查appBase和xmlBase目录，部署新发现的web应用或者context描述文件</li>\n</ul>\n<h3 id=\"Context节点\"><a href=\"#Context节点\" class=\"headerlink\" title=\"Context节点\"></a>Context节点</h3><p>用于配置web应用，相当于web站点中的虚拟子目录</p>\n<h4 id=\"子节点-4\"><a href=\"#子节点-4\" class=\"headerlink\" title=\"子节点\"></a>子节点</h4><p>CookieProcessor、Loader、Manager、Realm、Resources、WatchResource、JarScanner、Value</p>\n<h3 id=\"属性-5\"><a href=\"#属性-5\" class=\"headerlink\" title=\"属性\"></a>属性</h3><ul>\n<li>docBase   web应用目录或者WAR包的部署路径</li>\n<li>path   web应用的context路径</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 将d:\\myweb目录映射到Web站点的/test虚拟子目录上 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Context</span> <span class=\"attr\">path</span>=<span class=\"string\">&quot;/test&quot;</span> <span class=\"attr\">docBase</span>=<span class=\"string\">&quot;d:\\myweb&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"CookieProcessor节点\"><a href=\"#CookieProcessor节点\" class=\"headerlink\" title=\"CookieProcessor节点\"></a>CookieProcessor节点</h3><p>用于将HTTP请求中的cookie头信息转为javax.servlet.http.Cookie对象，或者将Cookie对象转为HTTP响应中的Cookie头信息</p>\n<h3 id=\"Loader节点\"><a href=\"#Loader节点\" class=\"headerlink\" title=\"Loader节点\"></a>Loader节点</h3><p>用于配置当前Context对应的web应用的类加载器，默认为org.apache.catalina.loader.WebappLoader</p>\n<h4 id=\"属性-6\"><a href=\"#属性-6\" class=\"headerlink\" title=\"属性\"></a>属性</h4><ul>\n<li>delegate   控制类加载顺序      true表示采用标准的java委派模式加载类，先尝试从父类加载器加载，然后才会从web应用的类加载器加载     false先从web应用的类加载器加载，然后从父类加载器加载    默认false</li>\n<li>reloadable    true   catalina监控WEB-INF/classes和WEB-INF/lib的变更，自动重新加载web应用</li>\n<li>loaderClass    指定Loader创建的web应用类加载器的具体实现</li>\n</ul>\n<h3 id=\"Manager节点\"><a href=\"#Manager节点\" class=\"headerlink\" title=\"Manager节点\"></a>Manager节点</h3><p>用于配置当前web应用的会话管理器</p>\n<p>tomcat提供了独立管理和集群管理两种方式</p>\n<h4 id=\"独立会话管理器\"><a href=\"#独立会话管理器\" class=\"headerlink\" title=\"独立会话管理器\"></a>独立会话管理器</h4><ul>\n<li><p>org.apache.catalina.session.StandardManager  简单的会话存储，在Tomcat正常停止时，会将所有会话串行化到一个文件(默认SESSION.ser)，在Tomcat启动时，加载有效会话</p>\n</li>\n<li><p>org.apache.catalina.session.PersistentManager  在每次会话过期检测之后，将超过配置数量的活跃会话以及空闲会话持久化到文件或者数据库，即使tomcat强制关闭，也只会丢失没有持久化的会话</p>\n<p>包含两种会话持久化存储方案</p>\n<ul>\n<li><p>org.apache.catalina.session.FileStore</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Context</span> <span class=\"attr\">docBase</span>=<span class=\"string\">&quot;myApp&quot;</span> <span class=\"attr\">path</span>=<span class=\"string\">&quot;/myApp&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Manager</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.session.PersistentManager&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">             <span class=\"attr\">saveOnRestart</span>=<span class=\"string\">&quot;true&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">             <span class=\"attr\">maxActiveSession</span>=<span class=\"string\">&quot;-1&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">             <span class=\"attr\">minIdleSwap</span>=<span class=\"string\">&quot;30&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">             <span class=\"attr\">maxIdleBackup</span>=<span class=\"string\">&quot;0&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Store</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.session.FileStore&quot;</span> <span class=\"attr\">directory</span>=<span class=\"string\">&quot;sessions&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">Store</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Manager</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><p>org.apache.catalina.session.JDBCStore</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Context</span> <span class=\"attr\">docBase</span>=<span class=\"string\">&quot;myApp&quot;</span> <span class=\"attr\">path</span>=<span class=\"string\">&quot;/myApp&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Manager</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.session.PersistentManager&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">             <span class=\"attr\">saveOnRestart</span>=<span class=\"string\">&quot;true&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">             <span class=\"attr\">maxActiveSession</span>=<span class=\"string\">&quot;-1&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">             <span class=\"attr\">minIdleSwap</span>=<span class=\"string\">&quot;30&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">             <span class=\"attr\">maxIdleBackup</span>=<span class=\"string\">&quot;0&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Store</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.session.JDBCStore&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">driverName</span>=<span class=\"string\">&quot;com.mysql.jdbc.Driver&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">connectionURL</span>=<span class=\"string\">&quot;jdbc:mysql://localhost:3306/demo?user=&amp;password=&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">sessionTable</span>=<span class=\"string\">&quot;session_table&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">sessionIdCol</span>=<span class=\"string\">&quot;id&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">sessionDataCol</span>=<span class=\"string\">&quot;data&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">sessionValidCol</span>=<span class=\"string\">&quot;valid&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">sessionMaxInactiveCol</span>=<span class=\"string\">&quot;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">sessionLastAccessedCol</span>=<span class=\"string\">&quot;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">sessionAppCol</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">Store</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Manager</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"tomcat之web应用加载","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E4%B9%8Bweb%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD/","content":"<h2 id=\"Web应用加载\"><a href=\"#Web应用加载\" class=\"headerlink\" title=\"Web应用加载\"></a>Web应用加载</h2><p>Catalina对于Web应用的加载主要由StandardHost、HostConfig、StandardContext、ContextConfig、StandardWrapper这五个类完成。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"StandardHost\"><a href=\"#StandardHost\" class=\"headerlink\" title=\"StandardHost\"></a>StandardHost</h3><p>StandardHost加载Web应用(即StandardContext)的入口有两个。</p>\n<p>一个入口是Catalina构造Server实例时，如果Host元素存在Context子元素时，那么Context元素将会作为Host容器的子容器加到Host实例中，并在Host启动时，由生命周期管理接口的start()方法启动</p>\n<p>此时Context的配置为</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Host</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;localhost&quot;</span> <span class=\"attr\">appBase</span>=<span class=\"string\">&quot;webapps&quot;</span> <span class=\"attr\">unparkWARs</span>=<span class=\"string\">&quot;true&quot;</span> <span class=\"attr\">autoDeploy</span>=<span class=\"string\">&quot;true&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- docBase是Web应用根目录的文件路径   path为Web应用根请求地址 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Context</span> <span class=\"attr\">docBase</span>=<span class=\"string\">&quot;myApp&quot;</span> <span class=\"attr\">path</span>=<span class=\"string\">&quot;myApp&quot;</span> <span class=\"attr\">reloadable</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Host</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>这种配置需要每次部署新的Web应用或者删除旧应用时，都必须修改一下server.xml文件。</p>\n<h4 id=\"StandardHost启动加载过程\"><a href=\"#StandardHost启动加载过程\" class=\"headerlink\" title=\"StandardHost启动加载过程\"></a>StandardHost启动加载过程</h4><ul>\n<li><p>为Host添加一个Value实现ErrorReportValue，该类主要用于在服务器处理异常时输出错误页面。如果没有在web.xml中配置错误处理页面，Tomcat返回的异常栈页面便是由ErrorReportValue生成的。</p>\n</li>\n<li><p>调用StandardHost父类ContainerBase的startInternal()方法启动虚拟主机，处理步骤为</p>\n<ul>\n<li><p>如果配置了集群组件Cluster，则启动</p>\n</li>\n<li><p>如果配置了安全组件Realm，则启动</p>\n</li>\n<li><p>启动子节点(server.xml中<Context>创建的StandardContext实例)</Context></p>\n</li>\n<li><p>启动Host持有的Pipeline组件</p>\n</li>\n<li><p>设置HOST状态为STARTING，触发START_EVENT生命周期时间。HostConfig监听该事件，扫描Web部署目录，对于部署描述文件、WAR包、目录会自动创建StandardContext实例，添加到Host并启动</p>\n</li>\n<li><p>启动Host层级的后台任务处理：cluster后台任务处理、Realm后台任务处理、Pipeline中Value的后台任务处理</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"HostConfig\"><a href=\"#HostConfig\" class=\"headerlink\" title=\"HostConfig\"></a>HostConfig</h3><p>另一个入口则是由HostConfig自动扫描部署目录</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 默认的server.xml配置 --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- appBase为web应用部署的基础目录，所有需要部署的Web应用都会复制到此目录下，Tomcat通过HostConfig完成该目录下Web应用的自动部署 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Host</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;localhost&quot;</span>  <span class=\"attr\">appBase</span>=<span class=\"string\">&quot;webapps&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">unpackWARs</span>=<span class=\"string\">&quot;true&quot;</span> <span class=\"attr\">autoDeploy</span>=<span class=\"string\">&quot;true&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"生命周期事件\"><a href=\"#生命周期事件\" class=\"headerlink\" title=\"生命周期事件\"></a>生命周期事件</h4><p>HostConfig处理的生命周期事件包括：START_EVENT、PERIODIC_EVENT、STOP_EVENT</p>\n<h5 id=\"START-EVENT事件\"><a href=\"#START-EVENT事件\" class=\"headerlink\" title=\"START_EVENT事件\"></a>START_EVENT事件</h5><p>在Host启动时触发，完成服务器启动过程中的Web应用部署(只有当Host的deployOnStartup属性为true时，服务器才会在启动过程中部署web应用，默认为true)</p>\n<p>该事件完成了Context描述文件部署、web目录部署、WAR包部署，对应于3种不同的部署方式</p>\n<h6 id=\"Context描述文件部署\"><a href=\"#Context描述文件部署\" class=\"headerlink\" title=\"Context描述文件部署\"></a>Context描述文件部署</h6><p>Tomcat支持通过一个独立的Context描述文件来配置Web应用,该配置文件的存储路径由Host的xmlBase属性指定。默认为$CATALINA_BASE/conf/&lt;Egnine名称&gt;/&lt;Host名称&gt;，对于Tomcat默认的Host，$CATALINA_BASE/conf/Catalina/localhost</p>\n<p>在该目录下创建文件，为myApp.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Context</span> <span class=\"attr\">docBase</span>=<span class=\"string\">&quot;test/myApp&quot;</span> <span class=\"attr\">path</span>=<span class=\"string\">&quot;/myApp&quot;</span> <span class=\"attr\">reloadable</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">WatchdResource</span>&gt;</span>WEB-INF/web.xml<span class=\"tag\">&lt;/<span class=\"name\">WatchdResource</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>将myApp的web应用复制到test目录下，Tomcat启动时便会自动部署该Web应用</p>\n<h6 id=\"web目录部署\"><a href=\"#web目录部署\" class=\"headerlink\" title=\"web目录部署\"></a>web目录部署</h6><p>以目录的形式发布并部署到Web应用是Tomcat中最常见的部署方式，只需将包含Web应用所有资源文件、jar包、描述文件的目录复制到Host指定的appBase目录下即可完成部署</p>\n<p>根据web应用中的配置文件来实例化Context(默认为META-INF目录下的context.xml)，但是无法覆盖name、path、webappVersion、docBase这四个属性，这些由Web目录的路径及名称确定</p>\n<h6 id=\"WAR包部署\"><a href=\"#WAR包部署\" class=\"headerlink\" title=\"WAR包部署\"></a>WAR包部署</h6><p>与web目录部署类似</p>\n<h5 id=\"PERIODIC-EVENT事件\"><a href=\"#PERIODIC-EVENT事件\" class=\"headerlink\" title=\"PERIODIC_EVENT事件\"></a>PERIODIC_EVENT事件</h5><p>用于定时扫描Web应用的变更，并进行重新加载</p>\n<h3 id=\"StandardContext\"><a href=\"#StandardContext\" class=\"headerlink\" title=\"StandardContext\"></a>StandardContext</h3><p>包含了具体的Web应用初始化及启动工作，该部分工作由组件Context完成</p>\n<p>StandardContext的启动过程</p>\n<ul>\n<li><p>发布正在启动的JMX通知，可以通过NotifycationListener来监听Web应用启动</p>\n</li>\n<li><p>启动当前Context维护的JNDI资源</p>\n</li>\n<li><p>初始化当前Context使用的WebResourceRoot并启动</p>\n<ul>\n<li><p>pre资源：在context.xml中通过<PreResources>配置的资源</PreResources></p>\n</li>\n<li><p>Main资源：web应用目录、WAR包或者WAE包解压目录包含的文件，这些资源的查找顺序为WEB-INF/classes、WEB-INF/lib</p>\n</li>\n<li><p>Jar资源：<JarResources>配置的资源</JarResources></p>\n</li>\n<li><p>Post资源：<PostResources>配置的资源</PostResources></p>\n</li>\n</ul>\n</li>\n<li><p>创建web应用类加载器WebappLoader</p>\n</li>\n<li><p>如果没有设置Cookie处理器，则创建默认的Rfc6265CokkieProcessor</p>\n</li>\n<li><p>设置字符集映射CharsetMapper，该映射主要用于根据Locale获取字符集编码</p>\n</li>\n<li><p>初始化临时目录，默认为$CATALINA_BASE/work/&lt;Egnine名称&gt;/&lt;Host名称&gt;/&lt;Context名称&gt;</p>\n</li>\n<li><p>web应用的依赖检测，主要检测依赖扩展点完整性</p>\n</li>\n<li><p>如果当前Context使用JNDI，则添加NamingContextListener</p>\n</li>\n<li><p>启动web应用类加载器WebappLoader.start</p>\n</li>\n<li><p>启动安全组件Realm</p>\n</li>\n<li><p>发布CONFIGURE_START_EVENT事件，ContextConfig监听该事件以完成Servlet的创建</p>\n</li>\n<li><p>启动Context子节点Wrapper</p>\n</li>\n<li><p>启动Context维护的Pipeline</p>\n</li>\n<li><p>创建会话管理器</p>\n</li>\n<li><p>将Context的web资源集合添加到ServletContext属性，属性名为org.apache.catalina.resources</p>\n</li>\n<li><p>创建实例管理器InstanceManager，用于创建对象实例，如Servlet、Filter等</p>\n</li>\n<li><p>将Jar包扫描器JarScanner添加到ServletContext属性</p>\n</li>\n<li><p>合并ServletContext初始化参数和Context组件中的ApplicationParameter。</p>\n</li>\n<li><p>启动添加到当前Context的ServletContainerInitializer</p>\n</li>\n<li><p>实例化应用监听器ApplicationListener，分为事件监听器(ServletContextAttributeListener、ServletRequestAttributeListener、ServletRequestListener、HttpSessionIdListener、HttpSessionAttributeListener)以及生命周期监听器(HttpSessionListener、ServletContextListener)</p>\n</li>\n<li><p>检测未覆盖的HTTP方法的安全约束</p>\n</li>\n<li><p>启动会话管理器</p>\n</li>\n<li><p>实例化FilterConfig、Filter，并调用Filter.init初始化</p>\n</li>\n<li><p>对于loadOnStartUp&gt;=0的Wrapper，调用Wrapper.load()，该方法负责实例化Servlet，并调用Servlet.init进行初始化</p>\n</li>\n<li><p>启动后台定时处理线程</p>\n</li>\n<li><p>发布正在运行的JMX通知</p>\n</li>\n<li><p>调用WebResourceRoot.gc()释放资源</p>\n</li>\n<li><p>设置Context的状态，如果启动成功，设置为STARTING，否则设为FAILED</p>\n</li>\n</ul>\n<h3 id=\"ContextConfig\"><a href=\"#ContextConfig\" class=\"headerlink\" title=\"ContextConfig\"></a>ContextConfig</h3><p>Context创建时会默认添加一个生命周期监听器–ContextConfig，一共处理6类事件，与Context启动有关系的3类：AFTER_INIT_EVENT、BEFORE_START_EVENT、CONFIGURE_STRAT_EVENT</p>\n<h4 id=\"AFTER-INIT-EVENT事件\"><a href=\"#AFTER-INIT-EVENT事件\" class=\"headerlink\" title=\"AFTER_INIT_EVENT事件\"></a>AFTER_INIT_EVENT事件</h4><p>属于Context初始化阶段，主要用于Context属性的配置工作</p>\n<p>Context的创建分为三种方式</p>\n<ul>\n<li>在实例化Server时，解析server.xml文件中的Context元素创建</li>\n<li>在HostConfig部署web应用时，解析web应用根目录下的META-INF/context.xml文件创建。如果不存在该文件，则自动创建一个Context对象，仅设置path、docBase等少数几个属性</li>\n<li>在Host部署web应用时，解析$CATALINA_BASE/conf/&lt;Egnine名称&gt;/&lt;Host名称&gt;下的Context部署配置文件创建</li>\n</ul>\n<p>该事件负责将tomcat提供的默认配置也一并添加到Context实例</p>\n<ul>\n<li><p>如果Context的override属性为false(表示使用的默认配置)</p>\n<ul>\n<li><p>如果存在conf/context.xml文件，那么解析该文件，更新当前Context实例属性</p>\n</li>\n<li><p>如果存在conf/&lt;Engine名称&gt;/&lt;Host名称&gt;/context.xml.default文件(Host级默认配置)，那么解析该文件，更新当前Context实例属性</p>\n</li>\n</ul>\n</li>\n<li><p>如果Context的configFile属性不为空，那么解析该文件，更新当前Context实例属性</p>\n</li>\n</ul>\n<p>Tomcat中Context属性优先级是   configFile -&gt;conf/&lt;Engine名称&gt;/&lt;Host名称&gt;/context.xml.default -&gt;conf/context.xml</p>\n<h4 id=\"BEFORE-START-EVENT事件\"><a href=\"#BEFORE-START-EVENT事件\" class=\"headerlink\" title=\"BEFORE_START_EVENT事件\"></a>BEFORE_START_EVENT事件</h4><p>该事件在Context启动之前触发用于更新Context的docBase属性和解决web目录锁的问题</p>\n<p>更新Context的docBase属性主要是为了满足WAR部署的情况，当Web应用为一个WAR压缩包且需要解压部署时，docBase属性指向的是解压后的文件夹目录，而非WAR包的路径</p>\n<p>处理过程(ContextConfig.fixDocBase)</p>\n<ul>\n<li>根据Host的appBase以及Context的docBase计算docBase的绝对路径</li>\n<li>如果docBase为一个WAR文件，则需要解压部署</li>\n<li>如果docBase为一个有效目录，而且存在与该目录同名的WAR包，则解压部署，覆盖之前的文件</li>\n<li>如果docBase为一个不存在的目录，但是存在与该目录同名的WAR包，则解压部署</li>\n</ul>\n<h4 id=\"CONFIGURE-START-EVENT事件\"><a href=\"#CONFIGURE-START-EVENT事件\" class=\"headerlink\" title=\"CONFIGURE_START_EVENT事件\"></a>CONFIGURE_START_EVENT事件</h4><p>Context在启动子节点之前，触发CONFIGURE_START_EVENT事件，解析web.xml，创建Wrapper(Servlet)、Filter、ServletContextListener等一系列Web容器相关的对象，完成Web容器的初始化</p>\n<p>该事件工作内容</p>\n<ul>\n<li><p>根据配置创建Wrapper(Servlet)、Filter、ServletContextListener等，完成web容器的初始化</p>\n</li>\n<li><p>如果StandardContext的ignoreAnnotations为false，则解析应用程序注解配置，添加相关JNDI资源引用</p>\n</li>\n<li><p>基于解析完成的web容器，检测web应用部署描述文件中使用的安全角色名称，当发现使用了未定义的角色时，提示警告同时将未定义的角色添加到Context安全角色列表中</p>\n</li>\n<li><p>当Context需要进行安全认证但是没有指定具体的Authenticator时，根据服务器配置自动创建默认实例</p>\n</li>\n</ul>\n<h5 id=\"web容器初始化\"><a href=\"#web容器初始化\" class=\"headerlink\" title=\"web容器初始化\"></a>web容器初始化</h5><ul>\n<li><p>解析默认配置，生成WebXml对象</p>\n</li>\n<li><p>解析Web应用的web.xml文件</p>\n</li>\n<li><p>扫描web应用所有的JAR包，如果包含META-INF/web-fragment.xml，则解析文件并创建WebXml对象（部分片段）</p>\n</li>\n<li><p>将web-fragment.xml创建的WebXml对象按照Servlet规范进行排序，同时将排序结果对应的JAR文件名列表设置到ServletContext属性中，javax.servlet.context.orderedLibs</p>\n</li>\n<li><p>查找ServletContainerInitializer实现，并创建实例，查找范围分为两部分</p>\n<ul>\n<li><p>web应用下的包：如果javax.servlet.context.orderedLibs不为空，仅搜索该属性中包含的包，否则搜索WEB-INF/lib下的所有包</p>\n</li>\n<li><p>容器包：搜索所有的包</p>\n</li>\n</ul>\n</li>\n<li><p>根据ServletContainerInitializer查询结果以及javax.servlet.annotation.HandlersTypes注解配置，初始化typeInitializerMap和initializerClassMap两个映射</p>\n</li>\n<li><p>当主Web.xml的metadataComplete为false或者typeInitializerMap不为空时，处理注解</p>\n</li>\n<li><p>当主Web.xml的metadataComplete为false，将所有的片段WebXml按照顺序排序合并至主WebXml</p>\n</li>\n<li><p>将默认WebXml合并至主WebXml</p>\n</li>\n<li><p>配置JspServlet</p>\n</li>\n<li><p>使用主WebXml配置当前StandardContext</p>\n</li>\n<li><p>将合并后的WebXml保存到ServletContext属性中</p>\n</li>\n<li><p>查找JAR包META-INF/resources/下的静态资源，并添加到StandardContext</p>\n</li>\n<li><p>将ServletContainerInitializer扫描结果添加到StandardContext，以便StandardContext启动时使用</p>\n</li>\n</ul>\n<h5 id=\"应用程序注解配置\"><a href=\"#应用程序注解配置\" class=\"headerlink\" title=\"应用程序注解配置\"></a>应用程序注解配置</h5><p>当StandardContext的ignoreAnnotations为false时，Tomcat支持读取如下接口的Java命名服务注解配置，添加相关的JNDI资源引用，以便在实例化相关接口时，进行JNDI资源依赖注入</p>\n<p>支持读取的接口</p>\n<ul>\n<li><p>web应用程序监听器</p>\n<ul>\n<li><p>javax.servlet.ServletContextAttributeListener</p>\n</li>\n<li><p>javax.servlet.ServletRequestListener</p>\n</li>\n<li><p>javax.servlet.ServletRequestAttributeListener</p>\n</li>\n<li><p>javax.servlet.http.HttpSessionAttributeListener</p>\n</li>\n<li><p>javax.servlet.http.HttpSessionListener</p>\n</li>\n<li><p>javax.servlet.ServletContextListener</p>\n</li>\n</ul>\n</li>\n<li><p>javax.servlet.Filter</p>\n</li>\n<li><p>javax.servlet.Servlet</p>\n</li>\n</ul>\n<p>支持读取的注解包括类注解、属性注解、方法注解</p>\n<ul>\n<li><p>类：javax.annotation.Resource、javax.annotation.Resources</p>\n</li>\n<li><p>属性和方法：javax.annotation.Resource</p>\n</li>\n</ul>\n<h3 id=\"StandardWrapper\"><a href=\"#StandardWrapper\" class=\"headerlink\" title=\"StandardWrapper\"></a>StandardWrapper</h3><p>StandardWrapper具体维护了Servlet实例，StandardWrapper的处理分为两部分</p>\n<ul>\n<li>当通过ContextConfig完成web容器初始化后，先调用StandardWrapper.start，此时StarndardWrapper组件状态将变为STARTED</li>\n<li>对于启动时加载的Servlet，调用StandardWrapper.load，完成Servlet的加载<ul>\n<li>创建Servlet实例，如果添加了JNDI资源注解，将进行资源注入</li>\n<li>读取javax.servlet.annotation.MultipartConfig注解配置，以用于multipart/form-data请求处理，包括临时文件存储路径、上传文件最大字节数、请求最大字节数、文件大小阈值</li>\n<li>读取javax.servlet.annotation.ServletSecurity()注解配置，添加Servlet安全</li>\n<li>调用javax.servlet.Servlet.init()方法进行Servlet初始化</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Context的命名规则\"><a href=\"#Context的命名规则\" class=\"headerlink\" title=\"Context的命名规则\"></a>Context的命名规则</h3><p>Context的name、path、version与文件名称相关</p>\n<p>当未指定version时，name与path相同，如果path为空字符，基础文件名称为ROOT;否则，将path起始的/删除，其余/替换为#的基础文件</p>\n<p>path为/foo/bar     name为/foo/path   基础文件名称为foo#bar</p>\n<p>如果指定了version，则path不变，name和基础文件名称将追加##和具体版本号</p>\n<p>path为/foo/bar   version为2   name为/foo/bar##2   基础文件名称为foo#bar##2</p>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"tomcat之web请求处理","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E4%B9%8Bweb%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86/","content":"<h2 id=\"Web请求处理\"><a href=\"#Web请求处理\" class=\"headerlink\" title=\"Web请求处理\"></a>Web请求处理</h2><h3 id=\"总体过程\"><a href=\"#总体过程\" class=\"headerlink\" title=\"总体过程\"></a>总体过程</h3><p>请求处理使用org.apache.catalina.connector.CoyoteAdapter.service()方法</p>\n<a id=\"more\"></a>\n\n<p>具体处理过程</p>\n<ul>\n<li><p>根据Connector的请求(org.apache.coyote.Request)和响应(org.apache.coyote.Response)对象创建Servlet请求(org.apache.catalina.connector.Request)和响应(org.apache.catalina.connector.Response)</p>\n</li>\n<li><p>转换请求参数并完成请求映射</p>\n<ul>\n<li><p>请求URI转码，初始化请求的路径参数</p>\n</li>\n<li><p>检测URI是否合法，如果非法，返回404</p>\n</li>\n<li><p>请求映射，映射结果保存到org.apache.catalina.connector.Request.mappingData，类型为org.apache.tomcat.util.http.mapper.MappingData，请求映射处理最终会根据URL定位到一个有效的Wrapper</p>\n</li>\n<li><p>如果映射结果MappingData的redirectPath属性不为空(即为重定向请求)，则调用org.apache.catalina.connector.Response.sendRedirect发送重定向并结束</p>\n</li>\n<li><p>如果当前Connector不允许追踪(allowTrace为false)且当前请求的Method为Trace，则返回405</p>\n</li>\n<li><p>执行连接器的认证和授权</p>\n</li>\n</ul>\n</li>\n<li><p>得到当前Engine的第一个Value并执行，完成客户端请求处理</p>\n</li>\n<li><p>如果为异步请求</p>\n<ul>\n<li><p>获得请求读取事件监听器(ReadListener)</p>\n</li>\n<li><p>如果请求读取已经结束，触发ReadListener.onAllDataRead</p>\n</li>\n</ul>\n</li>\n<li><p>如果为同步请求</p>\n<ul>\n<li>Flush并关闭请求输入流</li>\n<li>Flush并关闭请求输出流</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"HTTP-Connector请求处理\"><a href=\"#HTTP-Connector请求处理\" class=\"headerlink\" title=\"HTTP Connector请求处理\"></a>HTTP Connector请求处理</h3><ul>\n<li><p>当Connector启动时，会同时启动其持有的Endpoint实例。Endpoint并行运行多个线程（由属性acceptorThreadCount确定），每个线程运行一个AbstractEndpoint.Acceptor实例。在AbstractEndpoint.Acceptor实例中监听端口通信，而且只要Endpoint处于运行状态，始终循环监听</p>\n</li>\n<li><p>当监听到请求时，Acceptor将Ssocket封装为SocketWrapper实例，并交由一个SocketProcessor对象处理。</p>\n</li>\n<li><p>SocketProcessor是一个线程池Worker实例，每一个I/O方式均有自己的实现。首先判断Socket的状态，然后提交到ConnectionHandler处理</p>\n</li>\n<li><p>ConnectionHandler是AbstractProtocol的一个内部类，主要用于为链接选择一个合适的Processor实现以进行请求处理</p>\n<p>为了提升性能，针对每个有效的链接都会缓存其Processor对象。链接关闭时，其Processor对象还会释放到一个回收队列，这样后续链接可以重置并重复利用，以减少对象构造</p>\n</li>\n<li><p>协议升级时，ConnectionHandler会从当前Processor得到一个UpgradeToken对象，并构造一个升级Processor实例替换当前的Processor，并将当前的Processor释放回收。</p>\n</li>\n<li><p>通过UpgradeToken中HttpUpgradeHandler对象的init()方法进行初始化，以便准备开使启用新协议</p>\n</li>\n</ul>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"tomcat之web配置文件","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E4%B9%8Bweb%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/","content":"<h2 id=\"web-xml配置文件\"><a href=\"#web-xml配置文件\" class=\"headerlink\" title=\"web.xml配置文件\"></a>web.xml配置文件</h2><p>web.xml是web应用的部署文件，包括tomcat中conf/web.xml中的默认配置以及web应用WEB-INF/web.xml下的定制配置</p>\n<a id=\"more\"></a>\n\n<p>主要分为以下几类</p>\n<ul>\n<li><p>ServletContext初始化参数</p>\n</li>\n<li><p>会话配置</p>\n</li>\n<li><p>Servlet声明配置</p>\n</li>\n<li><p>应用生命周期监听器</p>\n</li>\n<li><p>Filter定义及映射</p>\n</li>\n<li><p>MIME类型映射</p>\n</li>\n<li><p>欢迎文件列表</p>\n</li>\n<li><p>错误页面</p>\n</li>\n<li><p>本地化及编码映射</p>\n</li>\n<li><p>安全配置</p>\n</li>\n<li><p>JNDI配置</p>\n</li>\n</ul>\n<h3 id=\"ServletContext初始化参数\"><a href=\"#ServletContext初始化参数\" class=\"headerlink\" title=\"ServletContext初始化参数\"></a>ServletContext初始化参数</h3><p>使用<context-param>添加初始化参数，可以使用javax.servlet.ServletContext.getInitParameter()方法获取参数值</context-param></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">context-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>name<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>value<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"会话配置\"><a href=\"#会话配置\" class=\"headerlink\" title=\"会话配置\"></a>会话配置</h3><p><session-config>用于配置web应用会话，包括超时时间、cookie配置以及会话追踪模式。</session-config></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">session-config</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">session-timeout</span>&gt;</span>30<span class=\"tag\">&lt;/<span class=\"name\">session-timeout</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">cookie-config</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>jessionid<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">domain</span>&gt;</span>myApp.com<span class=\"tag\">&lt;/<span class=\"name\">domain</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span>/<span class=\"tag\">&lt;/<span class=\"name\">path</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 安全性配置，只有mode为cookie时才会生效 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">http-only</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">http-only</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 安全性配置，只有mode为cookie时才会生效 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">secure</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">secure</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">max-age</span>&gt;</span>3600<span class=\"tag\">&lt;/<span class=\"name\">max-age</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">cookie-config</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 会话追踪模式 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">tracking-mode</span>&gt;</span>COOKIE<span class=\"tag\">&lt;/<span class=\"name\">tracking-mode</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">session-config</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Servlet支持三种会话追踪模式：COOKIE、URL、SSL</p>\n<ul>\n<li>COOKIE：通过HTTP    Cookie追踪会话，当首次发起HTTP请求时，Servlet容器会发送一个用于会话的Cookie到客户端，在后续请求中，客户端会将该Cookie返回到服务端，服务端根据该Cookie确定请求会话。默认情况下，Cookie的名称为JSESSIONID，可以通过<Context>的sessionCookieName属性或者<cookie-config>的name属性修改</cookie-config></Context></li>\n<li>URL：当客户端不支持Cookie时，可以采用URL重写的方式。当采用URL追踪模式时，请求路径需要包含会话标识信息，Servlet容器会根据路径中的会话标识设置请求的会话信息，参数名为jessionid</li>\n<li>SSL：对于SSL请求，通过SSL会话标识确定请求会话标识</li>\n</ul>\n<h3 id=\"Servlet声明和映射\"><a href=\"#Servlet声明和映射\" class=\"headerlink\" title=\"Servlet声明和映射\"></a>Servlet声明和映射</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>ad<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>com.zhanghe.servlet.MyMainServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>name<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>value<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 上传文件配置 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">multipart-config</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">max-file-size</span>&gt;</span>1024<span class=\"tag\">&lt;/<span class=\"name\">max-file-size</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">max-request-size</span>&gt;</span>2048<span class=\"tag\">&lt;/<span class=\"name\">max-request-size</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 文件超过该大小后将写入磁盘 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">file-size-threshold</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">file-size-threshold</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 标识该Servlet是否启用 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">enabled</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">enabled</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 安全角色的引用 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">security-role-ref</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- 代码中使用的角色名称 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">role-name</span>&gt;</span>admin<span class=\"tag\">&lt;/<span class=\"name\">role-name</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- 对应tomcat-user.xml中服务器配置角色名称 --&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">role-link</span>&gt;</span>manager<span class=\"tag\">&lt;/<span class=\"name\">role-link</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">security-role-ref</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">multipart-config</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>ad<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>*.*<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/myapp/*<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"应用生命周期监听器\"><a href=\"#应用生命周期监听器\" class=\"headerlink\" title=\"应用生命周期监听器\"></a>应用生命周期监听器</h3><p>监听器要实现javax.servlet.ServletContextListener接口，执行顺序与web.xml的配置顺序一致，停止时与启动顺序相反</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">listener</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">listener-class</span>&gt;</span>com.zhanghe.listener.MyListener<span class=\"tag\">&lt;/<span class=\"name\">listener-class</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">listener</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Filter定义和映射\"><a href=\"#Filter定义和映射\" class=\"headerlink\" title=\"Filter定义和映射\"></a>Filter定义和映射</h3><p>过滤器，用于过滤资源请求及响应</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>myFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">filter-class</span>&gt;</span>com.zhanghe.filter.MyFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-class</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>name<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>value<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter-mapping</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>myFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 也可以设置servlet-name --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/myApp/*<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"MIME类型映射\"><a href=\"#MIME类型映射\" class=\"headerlink\" title=\"MIME类型映射\"></a>MIME类型映射</h3><p>设定某类型的扩展名文件使用何种应用程序打开</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mime-mapping</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">extension</span>&gt;</span>doc<span class=\"tag\">&lt;/<span class=\"name\">extension</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mime-type</span>&gt;</span>application/msword<span class=\"tag\">&lt;/<span class=\"name\">mime-type</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mime-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"欢迎文件列表\"><a href=\"#欢迎文件列表\" class=\"headerlink\" title=\"欢迎文件列表\"></a>欢迎文件列表</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">welcome-file-list</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">welcome-file</span>&gt;</span>index.html<span class=\"tag\">&lt;/<span class=\"name\">welcome-file</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">welcome-file</span>&gt;</span>index.htm<span class=\"tag\">&lt;/<span class=\"name\">welcome-file</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">welcome-file</span>&gt;</span>index.jsp<span class=\"tag\">&lt;/<span class=\"name\">welcome-file</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">welcome-file-list</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"错误页面\"><a href=\"#错误页面\" class=\"headerlink\" title=\"错误页面\"></a>错误页面</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">error-code</span>&gt;</span>404<span class=\"tag\">&lt;/<span class=\"name\">error-code</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">localtion</span>&gt;</span>/404.html<span class=\"tag\">&lt;/<span class=\"name\">localtion</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">error-type</span>&gt;</span>java.lang.Exception<span class=\"tag\">&lt;/<span class=\"name\">error-type</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">localtion</span>&gt;</span>/error.html<span class=\"tag\">&lt;/<span class=\"name\">localtion</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"本地化及编码映射\"><a href=\"#本地化及编码映射\" class=\"headerlink\" title=\"本地化及编码映射\"></a>本地化及编码映射</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">locale-encoding-mapping-list</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">locale-encoding-mapping</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">locale</span>&gt;</span>zh<span class=\"tag\">&lt;/<span class=\"name\">locale</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">encoding</span>&gt;</span>UTF-8<span class=\"tag\">&lt;/<span class=\"name\">encoding</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">locale-encoding-mapping</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">locale-encoding-mapping-list</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安全配置\"><a href=\"#安全配置\" class=\"headerlink\" title=\"安全配置\"></a>安全配置</h3><p>为web应用增加页面的访问权限</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 针对符合url-pattern的请求进行安全约束 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">security-constraint</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">display-name</span>&gt;</span>user<span class=\"tag\">&lt;/<span class=\"name\">display-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">web-resource-collection</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">web-resource-name</span>&gt;</span>user<span class=\"tag\">&lt;/<span class=\"name\">web-resource-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>*.html<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">http-method</span>&gt;</span>POST<span class=\"tag\">&lt;/<span class=\"name\">http-method</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">web-resource-collection</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">auth-constraint</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">role-name</span>&gt;</span>user<span class=\"tag\">&lt;/<span class=\"name\">role-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">auth-constraint</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">user-data-constraint</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">transport-guarantee</span>&gt;</span>NONE<span class=\"tag\">&lt;/<span class=\"name\">transport-guarantee</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">user-data-constraint</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">security-constraint</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 为web应用添加角色 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">security-role</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">user-name</span>&gt;</span>user<span class=\"tag\">&lt;/<span class=\"name\">user-name</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">security-role</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 用于指定对于security-constraint中http-method中未指定的请求是否允许访问 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">deny-uncovered-http-methods</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">deny-uncovered-http-methods</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 认证方式   BASIC/DIGEST/FORM/CLIENT-CERT --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">login-config</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">auth-method</span>&gt;</span>FORM<span class=\"tag\">&lt;/<span class=\"name\">auth-method</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">form-login-config</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">form-login-page</span>&gt;</span>/login.html<span class=\"tag\">&lt;/<span class=\"name\">form-login-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">form-error-page</span>&gt;</span>/error.html<span class=\"tag\">&lt;/<span class=\"name\">form-error-page</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">form-login-config</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">login-config</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"tomcat之性能优化","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/","content":"<h2 id=\"性能优化\"><a href=\"#性能优化\" class=\"headerlink\" title=\"性能优化\"></a>性能优化</h2><p>有几个与性能关系密切的属性</p>\n<a id=\"more\"></a>\n\n<ul>\n<li>maxThreads：指定Connector创建的请求处理线程的最大数目。该属性决定了可以并行处理的请求最大数目，即并发上限。当并发请求数超过maxThreads时，多余的请求只能排队等待</li>\n<li>maxSpareThreads：Tomcat允许的空闲线程的最大数目，超出的空闲线程将被直接关闭默认50</li>\n<li>minSpareThreads：Tomcat允许的空闲线程的最小数目，也是启动时Connector创建的线程数目。如果空闲线程数小于该值，Tomcat将创建新的线程。默认4</li>\n<li>tcpNoDelay：该属性为true，会启用Socket的TCP_NO_DELAY选项。会禁用Nagle算法，该算法通过降低网络发送包的数量提升网络利用率。在非交互式的web应用环境中，该算法会缩短响应时间。但是在交互式web应用环境中则会加大响应时间，因为它会将小包拼接为大包在进行发送，从而导致响应延迟</li>\n<li>maxKeepAliveRequest：用于控制HTTP请求的“keep-alive”行为，以启用持续链接（多个请求通过同一个HTTP连接发送）。该属性指定HTTP连接在被服务器关闭之前处理的请求最大数目。默认100，如果设置为1，表示禁用该特性</li>\n<li>socketBuffer：用于指定Socket输出缓冲的大小，单位为字节</li>\n<li>enableLookups：设置为false，会禁用request.getRemoteHost()方法的DNS查询，从而提升响应性能（减少DNS查询耗时）</li>\n</ul>\n<h3 id=\"JVM优化\"><a href=\"#JVM优化\" class=\"headerlink\" title=\"JVM优化\"></a>JVM优化</h3><p>内存分配以及GC策略调整，选择不同的垃圾回收策略，调整JVM以及垃圾回收参数，可以极大地减少垃圾回收次数，提升垃圾回收效率，从而改善程序运行性能。</p>\n<p>垃圾收集器</p>\n<ul>\n<li><p>串行收集器：采用单线程执行所有的垃圾回收工作，适用于单核的服务器</p>\n</li>\n<li><p>并行收集器：以并行的方式执行Minor回收（年轻代垃圾回收），可以降低垃圾回收的开销，适用于多处理器，需要启用并行压缩</p>\n</li>\n<li><p>并发收集器：以并发的方式执行大部分垃圾回收工作，缩短垃圾回收的暂停时间，适用于数据集中为中型到大型、响应时间优先于吞吐量的应用。虽然减少了暂停时间，但是会降低应用程序性能</p>\n<p>JDK8中提供了两种并发收集器</p>\n<ul>\n<li><p>CMS收集器：并发标记扫描收集器，适用于缩短垃圾回收暂停时间并且负担得起与垃圾回收共享资源的应用</p>\n</li>\n<li><p>G1收集器：适用于大容量内存的多核服务器，在满足垃圾回收暂停时间目标的同时，以最大可能性实现高吞吐量</p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"JVM参数\"><a href=\"#JVM参数\" class=\"headerlink\" title=\"JVM参数\"></a>JVM参数</h4><ul>\n<li>-Xms  初始堆的大小，如不指定，初始化大小为分配的年轻代和年老代之和</li>\n<li>-Xmx  最大堆内存，xms和xmx设置为一个值，可以减少程序运行过程中调整堆内存分配的耗时</li>\n<li>-Xmn  年轻代的初始值及最大值，推荐为堆内存的1/2~1/4之间</li>\n<li>-XX:NewSize  年轻代初始值</li>\n<li>-XX:MaxNewSize  年轻代最大值</li>\n<li>-XX:MetaspaceSize  元数据空间的初始值</li>\n<li>-XX:MaxMetaspaceSize  分配用于类元数据的本地内存上限，默认不受限</li>\n<li>-Xss  线程栈大小</li>\n<li>-XX:ThreadStackSize  等价于xss</li>\n<li>-XX:NewRatio  设置年轻代和年老代大小的比值，默认2</li>\n<li>-XX:SurvivorRatio  Eden区和Survivor区大小的比值，默认为2</li>\n<li>-XX:LargePageSizeInBytes  堆内存的内存页大小，默认0，表示由JVM动态选择</li>\n<li>-XX:+DisableExplicitGC  禁用Sytem.gc</li>\n<li>-XX:MaxTenuringThreshold  在新生代中对象存活次数后仍然存活，晋升到旧生代，最大值15</li>\n<li>-XX:+AggressiveOpts  开启新的编译器性能优化选项</li>\n<li>-XX:+UseBiasedLocking  启用偏向锁</li>\n<li>-Xnoclassgc  禁用类的垃圾回收，即类对象不会回收</li>\n<li>-XX:SoftRefLRUPolicyMSPerMB  每兆空闲堆内存中，SoftReference对象在最后一次引用后的存活时间，默认1s</li>\n<li>-XX:MaxHeapFreeRatio  垃圾回收后，堆内存空闲空间最大允许百分比，如果超过该值，堆内存会收缩</li>\n<li>-XX:MinHeapFreeRatio  垃圾回收后，堆内存空闲空间最小百分比，如果低于该值，堆内存会扩大</li>\n<li>-XX:+ParallelRefProcEnabled  启用并行引用处理。如果应用存在大量的引用或者finalizable对象需要处理，可以减少垃圾回收时间</li>\n<li>-XX:TargetSurivorRatio  设定幸存区的目标使用率</li>\n<li>-XX:+UseGCOverheadLimit  限定JVM耗费在GC上的时间百分比</li>\n<li>-XX:+UseSerialGC  启用串行收集器</li>\n</ul>\n<h3 id=\"Tomcat配置\"><a href=\"#Tomcat配置\" class=\"headerlink\" title=\"Tomcat配置\"></a>Tomcat配置</h3><h4 id=\"server-xml配置\"><a href=\"#server-xml配置\" class=\"headerlink\" title=\"server.xml配置\"></a>server.xml配置</h4><ul>\n<li>修改链接器的maxConnections属性该属性决定了服务器在同一时间接收并处理的最大连接数</li>\n<li>tcpNoDeply属性设置为true，会开启Socket的TCP_NO_DEPLY选项，禁用Nagle算法，该算法用于链接小的缓冲消息，会降低通过网络发送数据包的数量，提升网络传输效率，但是对于交互式应用会增加响应时间</li>\n<li>调整maxKeepAliveRequest属性，用于控制keep-alive行为，指定了链接被服务器关闭之前可以接受的请求最大数目</li>\n<li>调整socketBuffer，调整Socket缓冲区大小</li>\n<li>将enableLookups属性设置为false，禁用request.getRemoteHost的DNS查找功能，减少查找时间</li>\n<li>IO方式最好使用NIO2或者APR</li>\n</ul>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"tomcat之过滤器","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E4%B9%8B%E8%BF%87%E6%BB%A4%E5%99%A8/","content":"<h2 id=\"过滤器\"><a href=\"#过滤器\" class=\"headerlink\" title=\"过滤器\"></a>过滤器</h2><h3 id=\"CorsFilter\"><a href=\"#CorsFilter\" class=\"headerlink\" title=\"CorsFilter\"></a>CorsFilter</h3><p>org.apache.catalina.filters.CorsFilter是W3C CORS(跨域资源共享)规范的一种实现，在HttpServletResponse中增加Acess-Control-*头，同时保护HTTP响应避免拆分。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>CorsFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">filter-class</span>&gt;</span>org.apache.catalina.filters.CorsFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-class</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 允许访问资源的域列表  多个域以,分隔 --&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>cors.allowed.origins<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>*<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 允许访问资源的HTTP方法   Access-Control-Allow-Methods的一部分 --&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>cors.allowed.methods<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>GET,POST,HEAD,OPTIONS,PUT<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 构造实际请求时可以使用的请求头  Access-Control-Allow-Headers的一部分 --&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>cors.allowed.headers<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>Content-Type,X-Requested-With,accept,Origin,Access-Control-Request-Method,Access-Control-Request-Headers<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 允许访问的头信息列表  Access-Control-Allow-Headers的一部分 --&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>cors.exposed.headers<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>Access-Control-Allow-Origin,Access-Control-Allow-Credentials<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 资源是否支持用户证书 --&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>cors.support.credentials<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 浏览器允许缓存Preflight请求结果的时间  单位s --&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>cors.preflight.maxage<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>10<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter-mapping</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>CorsFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/*<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"CsrfPreventionFilter\"><a href=\"#CsrfPreventionFilter\" class=\"headerlink\" title=\"CsrfPreventionFilter\"></a>CsrfPreventionFilter</h3><p>CSRF  跨域请求伪造     CsrfPreventionFilter过滤器提供了基本的CSRF保护，通过生成一个随机数存储到会话中，URL使用该随机数进行编码。当接收到下一个请求时，请求中的随机数与会话中的进行对比，两者相同，请求才会允许</p>\n<h3 id=\"ExpiresFilter\"><a href=\"#ExpiresFilter\" class=\"headerlink\" title=\"ExpiresFilter\"></a>ExpiresFilter</h3><p>负责设置服务器响应中的Expires头和Cache-Control头的max-age</p>\n<h3 id=\"FailedRequestFilter\"><a href=\"#FailedRequestFilter\" class=\"headerlink\" title=\"FailedRequestFilter\"></a>FailedRequestFilter</h3><p>参数解析失败时，拒绝该请求，原理是先调用getParameter进行解析参数</p>\n<p>可能会消费HTTP的请求体，如果使用该Filter保护请求，为了POST请求可以正常解析，需要在该Filter之前配置SetCharacterEncodingFilter过滤器</p>\n<h3 id=\"RemoteAddrFilter\"><a href=\"#RemoteAddrFilter\" class=\"headerlink\" title=\"RemoteAddrFilter\"></a>RemoteAddrFilter</h3><p>比较提交请求的客户端ip地址是否符合指定的正则表达式</p>\n<h3 id=\"RemoteHostFilter\"><a href=\"#RemoteHostFilter\" class=\"headerlink\" title=\"RemoteHostFilter\"></a>RemoteHostFilter</h3><p>比较提交请求的客户端主机域名是否符合指定的正则表达式</p>\n<h3 id=\"RemoteIpFilter\"><a href=\"#RemoteIpFilter\" class=\"headerlink\" title=\"RemoteIpFilter\"></a>RemoteIpFilter</h3><p>使用X-Forwarded-For来获取最原始的客户端ip</p>\n<p>X-Forwarded-For: client,proxy1,proxy2</p>\n<h3 id=\"SetCharacterEncodingFilter\"><a href=\"#SetCharacterEncodingFilter\" class=\"headerlink\" title=\"SetCharacterEncodingFilter\"></a>SetCharacterEncodingFilter</h3><p>设置编码格式</p>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"tomcat管理","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E7%AE%A1%E7%90%86/","content":"<h2 id=\"Tomcat管理\"><a href=\"#Tomcat管理\" class=\"headerlink\" title=\"Tomcat管理\"></a>Tomcat管理</h2><h3 id=\"host-manager\"><a href=\"#host-manager\" class=\"headerlink\" title=\"host-manager\"></a>host-manager</h3><p>访问<a href=\"http://localhst:8080/host-manager/html\">http://localhst:8080/host-manager/html</a> 可以访问host-manager页面，该页面存在访问权限控制，在tomcat-users.xml中进行配置</p>\n<p>包含两个角色，admin-gui和admin-script</p>\n<a id=\"more\"></a>\n\n<ul>\n<li><p>admin-gui用于控制页面的访问权限</p>\n</li>\n<li><p>admin-script用于控制以简单文本的形式进行访问</p>\n</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">user</span> <span class=\"attr\">username</span>=<span class=\"string\">&quot;tomcat&quot;</span> <span class=\"attr\">password</span>=<span class=\"string\">&quot;tomcat&quot;</span> <span class=\"attr\">roles</span>=<span class=\"string\">&quot;admin-gui,admin-scprit&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>可以添加虚拟主机</p>\n<h3 id=\"manager\"><a href=\"#manager\" class=\"headerlink\" title=\"manager\"></a>manager</h3><p>访问<a href=\"http://localhost:8080/manager%E9%A1%B5%E9%9D%A2%EF%BC%8C%E4%B9%9F%E5%AD%98%E5%9C%A8%E9%A1%B5%E9%9D%A2%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6\">http://localhost:8080/manager页面，也存在页面访问控制</a></p>\n<p>包含四个角色</p>\n<ul>\n<li><code>manager-gui</code> - 控制manager页面访问</li>\n<li><code>manager-script</code> - 控制以简单文本的形式访问</li>\n<li><code>manager-jmx</code> - 控制JMX访问</li>\n<li><code>manager-status</code> - 控制服务器状态查看</li>\n</ul>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"tomcat组件说明","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E7%BB%84%E4%BB%B6%E8%AF%B4%E6%98%8E/","content":"<h2 id=\"tomcat组件说明\"><a href=\"#tomcat组件说明\" class=\"headerlink\" title=\"tomcat组件说明\"></a>tomcat组件说明</h2><ul>\n<li><p>Server  表示整个Servlet容器，tomcat运行环境中只有唯一一个Server实例</p>\n<a id=\"more\"></a>\n</li>\n<li><p>Service   表示一个或多个Connector的集合，这些Connector共享同一个Container来处理其请求。在同一个tomcat实例内可以包含任意多个Service实例，它们彼此独立</p>\n</li>\n<li><p>Connector  tomcat连接器，用于监听并转化Socket请求,同时将读取的Socket请求交由Container处理，支持不同的协议以及不同的I/O方式</p>\n</li>\n<li><p>Container  表示能够执行客户端请求并返回响应的一类对象，在tomcat中存在不同级别的容器：Engine、Host、Context、Wrapper</p>\n</li>\n<li><p>Engine   表示整个Servlet引擎。在tomcat中，Engine为最高级别的容器对象，Engine不是直接处理请求的容器，是获得目标容器的入口</p>\n</li>\n<li><p>Host  表示Servlet引擎(即Engine)中的虚拟机，与一个服务器的网络名有关，如域名等。客户端可以使用这个网络名连接服务器，这个名称必须要在DNS服务器上注册</p>\n</li>\n<li><p>Context   表示ServletContext，在Servlet规范中，一个ServletContext即表示一个独立的Web应用</p>\n</li>\n<li><p>Wrapper  表示Web应用中定义的Servlet</p>\n</li>\n<li><p>Executor   表示tomcat组件间可以共享的线程池</p>\n</li>\n</ul>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"web服务器与应用服务器","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/web%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8/","content":"<h2 id=\"web服务器与应用服务器\"><a href=\"#web服务器与应用服务器\" class=\"headerlink\" title=\"web服务器与应用服务器\"></a>web服务器与应用服务器</h2><h3 id=\"Web服务器\"><a href=\"#Web服务器\" class=\"headerlink\" title=\"Web服务器\"></a>Web服务器</h3><p>是一个处理web请求的计算机系统，常见作用是托管web网站，主要功能是存储、处理、传送web页面到客户端。客户端与服务端之间的通信协议为HTTP，传送的页面多数情况下是HTML，同时包含图片、CSS以及JavaScript脚本</p>\n<a id=\"more\"></a>\n\n<p>如：Apache HTTP Server、Nginx、Lighttpd、IIS等</p>\n<p>场景：</p>\n<ul>\n<li>静态资源优化</li>\n<li>多应用、多虚拟机整合</li>\n<li>负载均衡</li>\n<li>复合场景</li>\n</ul>\n<h3 id=\"应用服务器\"><a href=\"#应用服务器\" class=\"headerlink\" title=\"应用服务器\"></a>应用服务器</h3><p>用于提供创建应用程序服务端实现和应用程序功能的通用方法，致力于程序或脚本的处理效率以支撑其应用</p>\n<p>大多数应用服务器框架包含了一个综合的服务层模型。应用服务器对于软件开发者来说是一套可访问的组件，可通过平台定义的API访问。</p>\n<p>如：Tomcat、JBOSS、Weblogic、WebSphere</p>\n<p>web服务器是应用服务器的子集。，但是web服务器更侧重于对HTTP请求的处理，而应用服务器侧重于构建业务系统的组件支撑</p>\n<h3 id=\"各自的优势\"><a href=\"#各自的优势\" class=\"headerlink\" title=\"各自的优势\"></a>各自的优势</h3><ul>\n<li>Web服务器侧重于系统的吞吐量、并发量的支持，性能高于应用服务器</li>\n<li>Web服务器大多提供了反向代理，用于负载均衡，应用服务器如果使用负载均衡的话一般采用LVS等方案。而应用服务器可以很好地支持集群架构，如会话集群、集群部署</li>\n<li>多数web服务器提供了静态文件缓存服务，对于静态文件的请求性能要好于应用服务器</li>\n<li>web服务器可以通过相关模块支持IMAP/POP3/SMTP</li>\n</ul>\n<h3 id=\"Nginx\"><a href=\"#Nginx\" class=\"headerlink\" title=\"Nginx\"></a>Nginx</h3><h4 id=\"集成多个应用\"><a href=\"#集成多个应用\" class=\"headerlink\" title=\"集成多个应用\"></a>集成多个应用</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#配置服务器1</span><br><span class=\"line\">upstream sample1 &#123;</span><br><span class=\"line\">    server 127.0.0.1:8080</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">#配置服务器2</span><br><span class=\"line\">upstream sample2 &#123;</span><br><span class=\"line\">    server 127.0.0.1:8081</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    # 映射服务器1</span><br><span class=\"line\">    location &#x2F;simple1&#x2F;&#123;</span><br><span class=\"line\">        proxy_pass http:&#x2F;&#x2F;sample1;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    # 映射服务器2</span><br><span class=\"line\">    location &#x2F;simple2&#x2F;&#123;</span><br><span class=\"line\">        proxy_pass http:&#x2F;&#x2F;sample2;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#配置服务器集群组</span><br><span class=\"line\">upstream sample1&#123;</span><br><span class=\"line\">    #实例1 设置权重 通信失败的最大次数  失败次数达到max_fails时，多久内该服务器无效</span><br><span class=\"line\">    server 127.0.0.1:8080 weight&#x3D;1 max_fails&#x3D;3 fail_timeout&#x3D;30s</span><br><span class=\"line\">    #实例2</span><br><span class=\"line\">    server 127.0.0.1:8081 weight&#x3D;1 max_fails&#x3D;3 fail_timeout&#x3D;30s</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    # 映射服务器集群</span><br><span class=\"line\">    location &#x2F;sample1&#x2F; &#123;</span><br><span class=\"line\">        proxy_pass http:&#x2F;&#x2F;simple1;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"性能调优","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98/","content":"<h2 id=\"性能调优\"><a href=\"#性能调优\" class=\"headerlink\" title=\"性能调优\"></a>性能调优</h2><h3 id=\"性能测试\"><a href=\"#性能测试\" class=\"headerlink\" title=\"性能测试\"></a>性能测试</h3><h4 id=\"负载测试\"><a href=\"#负载测试\" class=\"headerlink\" title=\"负载测试\"></a>负载测试</h4><a id=\"more\"></a>\n\n<p>应用系统接收正常情况的访问量，一开始访问量低，然后逐步增加，直至应用系统达到一个较高的负载。通过负载测试，可以知道应用系统随着并发用户数的增加，其响应时间的变化情况，从而确定系统的伸缩性以及在访问高峰系统响应时间是否仍然合理</p>\n<h4 id=\"压力测试\"><a href=\"#压力测试\" class=\"headerlink\" title=\"压力测试\"></a>压力测试</h4><p>系统接收异常情况的用户访问量，正常访问量的数倍或者数十倍，并持续增加负载，直至系统崩溃，通过压力测试，可以获知系统崩溃的临界负载以及在极端条件下才会出现的系统BUG</p>\n<h4 id=\"持续运行时间测试\"><a href=\"#持续运行时间测试\" class=\"headerlink\" title=\"持续运行时间测试\"></a>持续运行时间测试</h4><p>需要让应用系统不间断运行数天甚至更久，而且模拟正常用户访问系统，可以发现那些负载测试中不易发现的BUG，内存泄漏等问题。</p>\n<h4 id=\"性能测试工具\"><a href=\"#性能测试工具\" class=\"headerlink\" title=\"性能测试工具\"></a>性能测试工具</h4><p>ApacheBench、Apache JMeter、Grinder、Pylot、WCAT、Web Polygraph</p>\n<p>查看网络使用 ： nload、bmon、slurm</p>\n<p>查看每个套接字iftop、iptraf、tcptrack、pktstat、newwatch</p>\n<p>查看内存/CPU   top命令 </p>\n<ul>\n<li>-h 输出当前版本信息</li>\n<li>-c  切换显示命令名称和完整命令行</li>\n<li>-d  指定每两次屏幕信息刷新之间的时间间隔</li>\n<li>-o  指定显示项目的顺序</li>\n<li>-p  通过指定监控进程ID来仅仅监控某个进程的状态</li>\n<li>-u  指定显示用户进程</li>\n</ul>\n<p>JVM运行状况    jstat</p>\n<p>jmap用于打印进程的堆内存详情、产生对象数量以及内存使用情况，可以用于检查内存泄漏、对象不合理创建及销毁的问题</p>\n<p>对于jmap -dump生成的hprof文件，可以使用jhat命令查看，jhat [options] head-dump-file   在浏览器中输入localhost:7000查看结果    也可以使用mat工具来分析dump文件</p>\n<p>还可以使用jstack在代码级别帮助我们定位问题，可以输出指定进程或远程主机的栈信息</p>\n<p>两个可视化工具，JConsole(使用jconsole命令)和VisualVM(使用jvisualvm命令)</p>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"SSM基本配置","url":"/2020/%E6%A1%86%E6%9E%B6/SSM/%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/","content":"<h2 id=\"基本配置\"><a href=\"#基本配置\" class=\"headerlink\" title=\"基本配置\"></a>基本配置</h2><p>web.xml配置</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">web-app</span> <span class=\"attr\">version</span>=<span class=\"string\">&quot;3.0&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://java.sun.com/xml/ns/javaee </span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\"> </span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">display-name</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">display-name</span>&gt;</span>    </span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 404错误拦截 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">error-code</span>&gt;</span>404<span class=\"tag\">&lt;/<span class=\"name\">error-code</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">location</span>&gt;</span>/error404.jsp<span class=\"tag\">&lt;/<span class=\"name\">location</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 500错误拦截 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">error-code</span>&gt;</span>500<span class=\"tag\">&lt;/<span class=\"name\">error-code</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">location</span>&gt;</span>/error500.jsp<span class=\"tag\">&lt;/<span class=\"name\">location</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">error-page</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 加载spring容器 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">context-param</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>contextConfigLocation<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>WEB-INF/classes/spring/applicationContext-*.xml<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">context-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">listener</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class=\"tag\">&lt;/<span class=\"name\">listener-class</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">listener</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 配置前端控制器 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>spring<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">          <span class=\"comment\">&lt;!-- ContextconfigLocation配置springmvc加载的配置文件</span></span><br><span class=\"line\"><span class=\"comment\">          适配器、处理映射器等</span></span><br><span class=\"line\"><span class=\"comment\">           --&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>contextConfigLocation<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>WEB-INF/classes/spring/springmvc.xml<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>spring<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- 1、.action访问以.action结尾的  由DispatcherServlet进行解析</span></span><br><span class=\"line\"><span class=\"comment\">           2、/,所有访问都由DispatcherServlet进行解析</span></span><br><span class=\"line\"><span class=\"comment\">       --&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 解决post乱码问题的过滤器 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>CharacterEncodingFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-class</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>encoding<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">          <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>utf-8<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">filter-mapping</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>CharacterEncodingFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/*<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">filter-mapping</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">welcome-file-list</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">welcome-file</span>&gt;</span>welcome.jsp<span class=\"tag\">&lt;/<span class=\"name\">welcome-file</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">welcome-file-list</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>springmvc.xml的配置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:context</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:mvc</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:jdbc</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/jdbc&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:jee</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/jee&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:aop</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:tx</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/context</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/context/spring-context.xsd </span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/mvc</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/mvc/spring-mvc.xsd </span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/tx</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/aop</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class=\"line\">     <span class=\"comment\">&lt;!-- 配置视图解析器 --&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class=\"line\">         <span class=\"comment\">&lt;!-- 使用前缀和后缀 --&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;prefix&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;/&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;suffix&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;.jsp&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">     <span class=\"comment\">&lt;!-- 使用组件扫描的方式可以一次扫描多个Controller --&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">context:component-scan</span> <span class=\"attr\">base-package</span>=<span class=\"string\">&quot;com.zhanghe.study&quot;</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;/<span class=\"name\">context:component-scan</span>&gt;</span></span><br><span class=\"line\">     <span class=\"comment\">&lt;!-- 配置注解的处理器映射器和处理器适配器 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mvc:annotation-driven</span> <span class=\"attr\">conversion-service</span>=<span class=\"string\">&quot;conversionService&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">mvc:annotation-driven</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 自定义参数类型绑定 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;conversionService&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.format.support.FormattingConversionServiceFactoryBean&quot;</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;converters&quot;</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">             <span class=\"comment\">&lt;!-- 日期类型绑定 --&gt;</span></span><br><span class=\"line\">             <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.controller.converter.DateConverter&quot;</span>/&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;/<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 访问静态资源文件 --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- &lt;mvc:default-servlet-handler/&gt; 需要在web.xml中配置--&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 访问静态资源文件 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mvc:resources</span> <span class=\"attr\">mapping</span>=<span class=\"string\">&quot;/images/**&quot;</span> <span class=\"attr\">location</span>=<span class=\"string\">&quot;/images/&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mvc:resources</span> <span class=\"attr\">mapping</span>=<span class=\"string\">&quot;/css/**&quot;</span> <span class=\"attr\">location</span>=<span class=\"string\">&quot;/css/&quot;</span> /&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mvc:resources</span> <span class=\"attr\">mapping</span>=<span class=\"string\">&quot;/js/**&quot;</span> <span class=\"attr\">location</span>=<span class=\"string\">&quot;/js/&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mvc:resources</span> <span class=\"attr\">mapping</span>=<span class=\"string\">&quot;/imgdata/**&quot;</span> <span class=\"attr\">location</span>=<span class=\"string\">&quot;/imgdata/&quot;</span> /&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 定义拦截器 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mvc:interceptors</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 直接定义拦截所有请求 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.interceptor.CustomInterceptor&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">mvc:interceptors</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">&lt;!--配置上传文件数据解析器  --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;multipartResolver&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;maxUploadSize&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>9242880<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 定义全局异常处理器 --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 只有一个全局异常处理器起作用 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;exceptionResolver&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.exception.OverallExceptionResolver&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>applicationContext-*.xml配置</p>\n<p>包含三个配置文件，分别对应控制层，业务逻辑service层和事务控制层</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:context</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:mvc</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:jdbc</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/jdbc&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:jee</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/jee&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:aop</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:tx</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/context</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/mvc</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/tx</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/aop</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 加载数据库连接的资源文件 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">context:property-placeholder</span> <span class=\"attr\">location</span>=<span class=\"string\">&quot;/WEB-INF/classes/jdbc.properties&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 配置数据源   dbcp数据库连接池 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.commons.dbcp2.BasicDataSource&quot;</span> <span class=\"attr\">destroy-method</span>=<span class=\"string\">&quot;close&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;driverClassName&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;url&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 配置sqlSessionFactory --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;sqlSessionFactory&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 数据库连接池 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 加载Mybatis全局配置文件 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;configLocation&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;/WEB-INF/classes/mybatis/SqlMapConfig.xml&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 配置mapper扫描器 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 扫描包路径，如果需要扫描多个包中间用半角逗号隔开 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;basePackage&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;com.zhanghe.study.mapper&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;sqlSessionFactoryBeanName&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;sqlSessionFactory&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>事务控制</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:context</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:mvc</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:jdbc</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/jdbc&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:jee</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/jee&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:aop</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xmlns:tx</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/context</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/mvc</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/tx</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/tx/spring-tx.xsd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/aop</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 事务控制  对MyBatis操作数据库  spring使用JDBC事务控制类 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;transactionManager&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 配置数据源 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 通知 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">tx:advice</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;txAdvice&quot;</span> <span class=\"attr\">transaction-manager</span>=<span class=\"string\">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!-- 传播行为 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;save*&quot;</span> <span class=\"attr\">propagation</span>=<span class=\"string\">&quot;REQUIRED&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;insert*&quot;</span> <span class=\"attr\">propagation</span>=<span class=\"string\">&quot;REQUIRED&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;update*&quot;</span> <span class=\"attr\">propagation</span>=<span class=\"string\">&quot;REQUIRED&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;delete*&quot;</span> <span class=\"attr\">propagation</span>=<span class=\"string\">&quot;REQUIRED&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;find*&quot;</span> <span class=\"attr\">propagation</span>=<span class=\"string\">&quot;SUPPORTS&quot;</span> <span class=\"attr\">read-only</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;select*&quot;</span> <span class=\"attr\">propagation</span>=<span class=\"string\">&quot;SUPPORTS&quot;</span> <span class=\"attr\">read-only</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">tx:advice</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 配置aop  --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:config</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">aop:advisor</span> <span class=\"attr\">advice-ref</span>=<span class=\"string\">&quot;txAdvice&quot;</span> <span class=\"attr\">pointcut</span>=<span class=\"string\">&quot;execution(* com.zhanghe.study.service.impl.*.*(..))&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">aop:config</span>&gt;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["SSM"],"tags":["SSM"]},{"title":"OID映射对象标识符","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/OID%E6%98%A0%E5%B0%84%E5%AF%B9%E8%B1%A1%E6%A0%87%E8%AF%86%E7%AC%A6/","content":"<h2 id=\"OID映射对象标识符\"><a href=\"#OID映射对象标识符\" class=\"headerlink\" title=\"OID映射对象标识符\"></a>OID映射对象标识符</h2><h3 id=\"OID存在的意义\"><a href=\"#OID存在的意义\" class=\"headerlink\" title=\"OID存在的意义\"></a>OID存在的意义</h3><p>关系型数据库通过主键来区分同一张表的不同数据，java语言使用内存地址来区分同一类的不同对象，hibernate则使用OID来同一两者之间的矛盾，在运行时，hibernate通过OID来维持java对象和数据库表中记录的对应关系。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"OID的配置\"><a href=\"#OID的配置\" class=\"headerlink\" title=\"OID的配置\"></a>OID的配置</h3><p>在hibernate映射文件中配置，使用<id>元素来设置对象标识符</id></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">column</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">generator</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;increment&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><generator>子元素来设定标识符生成器，标识符生成器的接口为org.hibernate.id.IdentifierGenerator接口，以及提供了几种内置的实现</generator></p>\n<ul>\n<li>increment     Hibernate以递增的方式赋值  先查该表的id最大值，再加一   存在并发问题</li>\n<li>identity         由底层数据库生成，需要把主键设置为自增的(需要底层数据库支持自增  如DB2、Mysql、SQL SERVER)</li>\n<li>sequence     底层数据库序列生成(需要底层数据库支持序列  如Oracle、DB2、PostgreSQL)</li>\n<li>hilo               由hibernate按照一种high/low算法生成，hibernate把特定表的字段最为high值。默认为hibernate_unique_key表的next_hi字段      注意：hilo的方式需要在单独的事务中处理，不使用session对象的当前数据库连接和事务，而是单独的在一个新的数据库连接中创建新的事务，与spring结合时以及配置数据源时注意不可使用该方式生成</li>\n<li>native          根据底层数据库对自动生成主键的支持能力，来选择identity,sequence或hilo生成器</li>\n<li>uuid.hex     hibernate采用128位的UUID生成</li>\n<li>assigned    由java程序负责生成</li>\n<li>select         由数据库中的触发器来生成</li>\n<li>foreign       用另一个关联对象的标识符来作为当前对象的标识符，主要用于一对一关联关系</li>\n</ul>\n<h3 id=\"复合主键的配置\"><a href=\"#复合主键的配置\" class=\"headerlink\" title=\"复合主键的配置\"></a>复合主键的配置</h3><p>复合主键的配置使用<composite-id></composite-id></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">composite-id</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">key-property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.String&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">key-property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;companyId&quot;</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;company_id&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.Long&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">composite-id</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>注意在使用复合主键时，需要定义version版本控制属性，用来区分临时对象和游离对象，判断是保存还是更新</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 表示当对象的version对象为null时为游离对象，还没有被保存过 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">version</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;version&quot;</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;version&quot;</span> <span class=\"attr\">unsaved-value</span>=<span class=\"string\">&quot;null&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"hibernate异常org.hibernate.NonUniqueObjectException","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/hibernate%E4%B9%8B%E6%89%A7%E8%A1%8C%E5%BC%82%E5%B8%B8%E9%97%AE%E9%A2%98/","content":"<p>异常报错：org.hibernate.NonUniqueObjectException: a different object with the same identifier value was already associated with the session:</p>\n<a id=\"more\"></a>\n\n<p>出现原因：发生这种异常的原因是在执行修改操作的时候，session管理两个具有相同标识符的持久对象造成的</p>\n<p> 解决方法：使用this.getHibernateTemplate().getSessionFactory().getCurrentSession().clear();在进行第二次数据库操作之前，将hibernate中的缓存清除掉</p>\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"hibernate开发步骤","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/hibernate%E5%BC%80%E5%8F%91%E6%AD%A5%E9%AA%A4/","content":"<h2 id=\"hibernate开发步骤\"><a href=\"#hibernate开发步骤\" class=\"headerlink\" title=\"hibernate开发步骤\"></a>hibernate开发步骤</h2><ul>\n<li>创建hibernate配置文件</li>\n<li>创建实体类</li>\n<li>创建对象-关系映射文件</li>\n<li>通过hibernate访问数据库</li>\n</ul>\n<a id=\"more\"></a>\n\n<p>下面提供一个简单地示例</p>\n<h3 id=\"hibernate配置文件\"><a href=\"#hibernate配置文件\" class=\"headerlink\" title=\"hibernate配置文件\"></a>hibernate配置文件</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">hibernate-configuration</span> <span class=\"meta-keyword\">PUBLIC</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;-//Hibernate/Hibernate Configuration DTD//EN&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">hibernate-configuration</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">session-factory</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 配置连接数据库信息 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;connection.url&quot;</span>&gt;</span>jdbc:mysql://localhost:3306/studyhibernate<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;connection.driver_class&quot;</span>&gt;</span>com.mysql.jdbc.Driver<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;connection.username&quot;</span>&gt;</span>root<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;connection.password&quot;</span>&gt;</span>123456<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 配置hibernate的基本信息 --&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- hibernate方言 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;dialect&quot;</span>&gt;</span>org.hibernate.dialect.MySQL5InnoDBDialect<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 执行操作时是否在控制台打印 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;show_sql&quot;</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 是否对SQL进行格式化 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;format_sql&quot;</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 指定自动生成数据表的策略 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;hibernate.hbm2ddl.auto&quot;</span>&gt;</span>update<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 指定关联的映射文件 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">mapping</span> <span class=\"attr\">resource</span>=<span class=\"string\">&quot;User.hbm.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">session-factory</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">hibernate-configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"实体类\"><a href=\"#实体类\" class=\"headerlink\" title=\"实体类\"></a>实体类</h3><ul>\n<li>提供一个无参构造器：hibernate使用Constructor.newInstance()来实例化</li>\n<li>提供一个主键字段</li>\n<li>实体类的字段要声明get/set方法：hibernate通过get/set方法来获取字段</li>\n<li>使用非final的类：如果没有实现接口的话，hibernate会使用cglib来生成代理，final类不可以生成cglib代理</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.zhanghe.study.model;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> zh</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2020/12/4 10:26</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">User</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> id;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> age;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> id;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setId</span><span class=\"params\">(<span class=\"keyword\">int</span> id)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.id = id;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setName</span><span class=\"params\">(String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getAge</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setAge</span><span class=\"params\">(<span class=\"keyword\">int</span> age)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.age = age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"hibernate映射文件\"><a href=\"#hibernate映射文件\" class=\"headerlink\" title=\"hibernate映射文件\"></a>hibernate映射文件</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">hibernate-mapping</span> <span class=\"meta-keyword\">PUBLIC</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;-//Hibernate/Hibernate Mapping DTD//EN&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">hibernate-mapping</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- name为实体类   table为表名 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">class</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;com.zhanghe.study.model.User&quot;</span> <span class=\"attr\">table</span>=<span class=\"string\">&quot;user&quot;</span>&gt;</span></span><br><span class=\"line\">          <span class=\"comment\">&lt;!-- name为字段名  type为类型  column为表的字段名 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">column</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!-- 指定主键生成方式  navive 使用数据库本地方式 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">generator</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;native&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">column</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;age&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">column</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;age&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">class</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">hibernate-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"hibernate访问数据库\"><a href=\"#hibernate访问数据库\" class=\"headerlink\" title=\"hibernate访问数据库\"></a>hibernate访问数据库</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.zhanghe.study;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> com.zhanghe.study.model.User;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.hibernate.HibernateException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.hibernate.Session;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.hibernate.SessionFactory;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.hibernate.Transaction;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.hibernate.boot.registry.StandardServiceRegistryBuilder;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.hibernate.cfg.Configuration;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.hibernate.service.ServiceRegistry;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> zh</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2020/12/4 10:00</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Main</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> SessionFactory sessionFactory;</span><br><span class=\"line\">    <span class=\"comment\">// 创建sessionFactory对象</span></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 对应的hibernate基本配置信息和对象关系映射信息</span></span><br><span class=\"line\">            Configuration configuration = <span class=\"keyword\">new</span> Configuration();</span><br><span class=\"line\">            <span class=\"comment\">// 找到hibernate.cfg.xml配置文件,如果没有会报错  当然也可以调用configure(String resource)有参的方法，自己指定配置文件名称及位置</span></span><br><span class=\"line\">            configuration.configure();</span><br><span class=\"line\">            <span class=\"comment\">// 4.0之前不需要使用serviceRegistry  直接构建sessionFactory  configuration.buildSessionFactory()</span></span><br><span class=\"line\">            <span class=\"comment\">// 4.0之后创建serviceRegistry,所有的配置和服务都要在该对象中注册才可以生效</span></span><br><span class=\"line\">            <span class=\"comment\">// 4.3之前使用该方式new ServiceRegistryBuilder().applySettings(configuration.getProperties()).buildServiceRegistry();</span></span><br><span class=\"line\">            ServiceRegistry serviceRegistry = <span class=\"keyword\">new</span> StandardServiceRegistryBuilder().applySettings(configuration.getProperties()).build();</span><br><span class=\"line\">            sessionFactory = configuration.buildSessionFactory(serviceRegistry);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Throwable ex) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExceptionInInitializerError(ex);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 创建session对象</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Session <span class=\"title\">getSession</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> HibernateException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> sessionFactory.openSession();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">final</span> String[] args)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">final</span> Session session = getSession();</span><br><span class=\"line\">        <span class=\"comment\">// 开启事务</span></span><br><span class=\"line\">        Transaction transaction = session.beginTransaction();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            User user = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">            user.setAge(<span class=\"number\">20</span>);</span><br><span class=\"line\">            user.setName(<span class=\"string\">&quot;张三&quot;</span>);</span><br><span class=\"line\">            session.save(user);</span><br><span class=\"line\">            transaction.commit();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e)&#123;</span><br><span class=\"line\">            transaction.rollback();</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            session.close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"hibernate映射文件","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/hibernate%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6/","content":"<h2 id=\"hibernate映射文件\"><a href=\"#hibernate映射文件\" class=\"headerlink\" title=\"hibernate映射文件\"></a>hibernate映射文件</h2><h3 id=\"配置访问持久化类属性的策略\"><a href=\"#配置访问持久化类属性的策略\" class=\"headerlink\" title=\"配置访问持久化类属性的策略\"></a>配置访问持久化类属性的策略</h3><p>可以在property元素中配置access属性来指定hibernate访问持久化类属性的方式</p>\n<ul>\n<li><p>property  默认值，使用getter/setter方法来访问类的属性，不需要管有没有该成员变量</p>\n</li>\n<li><p>field  使用java的反射机制来直接访问类的属性</p>\n<a id=\"more\"></a>\n\n</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;customerName&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.String&quot;</span> <span class=\"attr\">access</span>=<span class=\"string\">&quot;property&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">column</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;customer_name&quot;</span>/&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"设置派生属性\"><a href=\"#设置派生属性\" class=\"headerlink\" title=\"设置派生属性\"></a>设置派生属性</h3><p>有些属性的值需要在运行时进行计算才可以获取到，此时可以使用property元素的formula属性，该属性用来设置一个SQL表达式，hibernate根据SQL来计算出派生属性的值</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;totalPrice&quot;</span> <span class=\"attr\">formula</span>=<span class=\"string\">&quot;(select sum(price) from orders where custom_id=id)&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>在查询的时候就会进行拼接子查询来获取该属性的值</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"keyword\">id</span>,<span class=\"keyword\">name</span>,(<span class=\"keyword\">select</span> <span class=\"keyword\">sum</span>(price) <span class=\"keyword\">from</span> orders <span class=\"keyword\">where</span> custom_id=<span class=\"number\">1</span>) <span class=\"keyword\">from</span> customer <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> = <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"控制字段的插入和更新\"><a href=\"#控制字段的插入和更新\" class=\"headerlink\" title=\"控制字段的插入和更新\"></a>控制字段的插入和更新</h3><p>hibernate生成的save()、update()语句默认是插入和更新全部的字段，可以进行自定义设置</p>\n<ul>\n<li>property元素的insert属性   默认为true，如果设置为false，表示insert语句中不包含该字段</li>\n<li>property元素的update属性   默认为true，如果设置为false，表示update语句中不包含该字段</li>\n<li>class元素的mutable属性  默认为true，如果设置为false，等价于该类下所有的property元素的update属性为false，整个实例都不可以被更新</li>\n<li>class属性的dynamic-insert属性  默认为false，如果为true，表示当保存一个对象时，会动态的生成insert语句，仅包含取值不为null的字段</li>\n<li>class属性的dynamic-update属性  默认为false，如果为true，表示当更新一个对象时，会动态的生成update语句，仅包含需要更新的字段</li>\n</ul>\n<p>注意：当表的字段比较多时，可以设置dynamic-insert、dynamic-update来提升性能</p>\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"hibernate简介","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/hibernate%E7%AE%80%E4%BB%8B/","content":"<h2 id=\"hibernate简介\"><a href=\"#hibernate简介\" class=\"headerlink\" title=\"hibernate简介\"></a>hibernate简介</h2><h3 id=\"ORM\"><a href=\"#ORM\" class=\"headerlink\" title=\"ORM\"></a>ORM</h3><p>ORM(Object Relation Mapping)对象关系映射</p>\n<p>思想：将关系数据库中表中的记录映射为对象，以对象的形式展现，可以把对数据库的操作转化为对对象的操作。</p>\n<p>采用元数据来描述对象-关系映射细节，元数据通常采用XML格式，存放在专门的对象-关系映射文件中。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"hibernate\"><a href=\"#hibernate\" class=\"headerlink\" title=\"hibernate\"></a>hibernate</h3><p>hibernate是一个老牌的ORM框架，通过hbm.xml映射文件维护Java和数据库表之间的关系，还可以屏蔽不同数据库产品的SQL语句的差异。</p>\n<ul>\n<li><p>提供Criteria条件查询，完全不需要考虑数据库底层如何实现、SQL如何编写</p>\n</li>\n<li><p>还提供了HQL语言，hibernate会根据实际配置的数据库方言，将HQL语句生成对应的SQL语句。</p>\n</li>\n</ul>\n<p>使用这两种方式都可以帮助上层程序屏蔽掉底层数据库的差异，增强程序的可移植性。</p>\n<p>但是数据库结构比较复杂时，hibernate生成的SQL语句会比较复杂，而且会让生成的SQL语句使用正确的索引也比较困难，会导致出现大量慢查询的情况。（Mybatis半自动化的映射方式可以解决性能问题）</p>\n<h3 id=\"hibernate核心接口\"><a href=\"#hibernate核心接口\" class=\"headerlink\" title=\"hibernate核心接口\"></a>hibernate核心接口</h3><h4 id=\"Configuration接口\"><a href=\"#Configuration接口\" class=\"headerlink\" title=\"Configuration接口\"></a>Configuration接口</h4><p>用于配置hibernate，通过configuration实例来获得对象-关系映射文件中的元数据，以及动态配置hibernate属性，创建SessionFactory实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 对应的hibernate基本配置信息和对象关系映射信息</span></span><br><span class=\"line\">Configuration configuration = <span class=\"keyword\">new</span> Configuration();</span><br><span class=\"line\"><span class=\"comment\">// 找的hibernate.cfg.xml配置文件</span></span><br><span class=\"line\">configuration.configure();</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"SessionFactory接口\"><a href=\"#SessionFactory接口\" class=\"headerlink\" title=\"SessionFactory接口\"></a>SessionFactory接口</h4><p>一个SessionFactory实例对应一个数据存储源，应用从SessionFactory中获得Session实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 4.0之前不需要使用serviceRegistry  直接构建sessionFactory  configuration.buildSessionFactory()</span></span><br><span class=\"line\"><span class=\"comment\">// 4.0之后创建serviceRegistry,所有的配置和服务都要在该对象中注册才可以生效</span></span><br><span class=\"line\"><span class=\"comment\">// 4.3之前使用该方式new ServiceRegistryBuilder().applySettings(configuration.getProperties()).buildServiceRegistry();</span></span><br><span class=\"line\">ServiceRegistry serviceRegistry = <span class=\"keyword\">new</span> StandardServiceRegistryBuilder().applySettings(configuration.getProperties()).build();</span><br><span class=\"line\">SessionFactory sessionFactory = configuration.buildSessionFactory(serviceRegistry);</span><br></pre></td></tr></table></figure>\n\n<p>SessionFactory的特点</p>\n<ul>\n<li><p>线程安全，同一个实例可以被应用的多个线程共享</p>\n</li>\n<li><p>重量级，不能随意的创建和销毁,如果应用只访问一个数据库，只需要创建一个SessionFactory实例，多个数据库的话，需要为每个数据库创建一个单独的SessionFactory实例</p>\n</li>\n<li><p>需要很大的缓存来存放预定义的SQL语句及映射元数据等。用户可以为SessionFactory配置一个缓存插件，称为二级缓存，用来存放读取过的数据，</p>\n</li>\n</ul>\n<h4 id=\"Session接口\"><a href=\"#Session接口\" class=\"headerlink\" title=\"Session接口\"></a>Session接口</h4><p>Session被称为持久化管理器，它提供了和持久化相关的操作，如保存、更新、删除、加载和查询对象，是hibernate运作的中心，所有持久化对象必须在session管理下才可以进行持久化操作。生命周期很短，相当于JDBC的connection，对connection进行了包装。</p>\n<p>Session的特点：</p>\n<ul>\n<li><p>不是线程安全的，应避免多个线程共享同一个Session实例</p>\n</li>\n<li><p>Session是轻量级的，创建和销毁不需要消耗太多资源</p>\n</li>\n</ul>\n<p>Session有一个缓存，是Hibernate的一级缓存，存放被当前工作单元加载的对象。每个Session实例都有自己的缓存，这个Session实例的缓存只能被当前工作单元访问</p>\n<h4 id=\"Transaction接口\"><a href=\"#Transaction接口\" class=\"headerlink\" title=\"Transaction接口\"></a>Transaction接口</h4><p>Transaction接口是Hibernate的数据库事务接口，对底层的事务接口做了封装</p>\n<h4 id=\"Query和Criteria接口\"><a href=\"#Query和Criteria接口\" class=\"headerlink\" title=\"Query和Criteria接口\"></a>Query和Criteria接口</h4><p>这两个接口是Hibernate的查询接口。Query实例包装了一个HQL查询语句，Criteria接口完全封装了基于字符串形式的查询语句，擅长执行动态查询</p>\n<h3 id=\"事件处理接口\"><a href=\"#事件处理接口\" class=\"headerlink\" title=\"事件处理接口\"></a>事件处理接口</h3><p>当程序通过Hibernate来加载、保存、更新或删除对象时，会触发Hibernate的拦截器及事件监听器做出相应的处理：</p>\n<ul>\n<li><p>事件及事件监听接口：在Hibernate中，针对每种事件都有相应的事件监听器，如加载对象会触发org.hibernate.event.LoadEvent事件，该事件由org.hibernate.event.LoadEventListener监听器处理。保存对象触发org.hibernate.event.SaveEvent事件，该事件由org.hibernate.event.SaveEventListener监听器处理</p>\n</li>\n<li><p>拦截器：实现org.hibernate.Interceptor接口，Interceptor实现类负责响应持久化类的实例被加载、保存、更新或删除的事件</p>\n</li>\n</ul>\n<h3 id=\"Hibernate可扩展接口\"><a href=\"#Hibernate可扩展接口\" class=\"headerlink\" title=\"Hibernate可扩展接口\"></a>Hibernate可扩展接口</h3><ul>\n<li>定制主键的生成策略：IdentifierGenerator接口</li>\n<li>定制本地SQL方言：Dialect抽象类</li>\n<li>定制缓存机制：Cache和CacheProvicer接口</li>\n<li>定制JDBC连接管理：ConnectionProvder接口</li>\n<li>定制事务管理：TransactionFactory、Transaction和TransactionManagerLookup接口</li>\n<li>定制属性访问策略：PropertyAccessor接口</li>\n<li>创建代理：ProxyFactory接口</li>\n<li>定制客户化映射类型：UserType和CompositeUserType接口</li>\n</ul>\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"hibernate缓存","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/hibernate%E7%BC%93%E5%AD%98/","content":"<h2 id=\"hibernate缓存\"><a href=\"#hibernate缓存\" class=\"headerlink\" title=\"hibernate缓存\"></a>hibernate缓存</h2><p>hibernate提供了两个级别的缓存</p>\n<ul>\n<li>一级缓存  session级别的缓存，属于事务范围的缓存，由hibernate来管理</li>\n<li>二级缓存  sessionFactory级别的缓存，属于进程范围内的缓存</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"二级缓存\"><a href=\"#二级缓存\" class=\"headerlink\" title=\"二级缓存\"></a>二级缓存</h3><p>二级缓存是属于sessionFactory的外置缓存，默认情况下hibernate是不会启用的，需要第三方的插件</p>\n<p>hibernate允许使用的缓存插件</p>\n<ul>\n<li>EHCache  可作为进程范围内的缓存，支持hibernate查询缓存</li>\n<li>OpenSysphony OSCache  可作为进程范围内的缓存，支持hibernate查询缓存</li>\n<li>SwarmCache  可作为集群范围内的缓存，不支持hibernate的查询缓存</li>\n<li>JBossCache  可作为集群范围内的缓存，支持hibernate的查询缓存</li>\n</ul>\n<h4 id=\"二级缓存的使用\"><a href=\"#二级缓存的使用\" class=\"headerlink\" title=\"二级缓存的使用\"></a>二级缓存的使用</h4><p>在hibernate.cfg.xml中配置启用二级缓存</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 启用二级缓存 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;cache.use_second_level_cache&quot;</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 二级缓存指定第三方插件 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;hibernate.cache.provider_class&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 配置哪个类使用二级缓存 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">class-cache</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.model.User&quot;</span> <span class=\"attr\">usage</span>=<span class=\"string\">&quot;read-write&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>哪个类使用二级缓存的配置也可以在.hbm.xml中配置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">cache</span> <span class=\"attr\">usage</span>=<span class=\"string\">&quot;read-write&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>如果有关联关系的话，还需要再进行设置集合的二级缓存</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- collection表示的是全类名加上集合属性名 这时候只会缓存OID--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">collection-cache</span> <span class=\"attr\">collection</span>=<span class=\"string\">&quot;com.zhanghe.study.model.many2one.Customer.orderList&quot;</span> <span class=\"attr\">usage</span>=<span class=\"string\">&quot;read-write&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 在缓存该集合类的实际类型 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">class-cache</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.model.many2one.Order&quot;</span> <span class=\"attr\">usage</span>=<span class=\"string\">&quot;read-write&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>上述配置对于查询缓存不生效，需要再加上以下配置，并且在查询时使用query.setCacheable(true)，查询缓存依赖于二级缓存</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 开启查询缓存 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;cache.use_query_cache&quot;</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"hibernate配置文件","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/hibernate%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/","content":"<h2 id=\"hibernate配置文件\"><a href=\"#hibernate配置文件\" class=\"headerlink\" title=\"hibernate配置文件\"></a>hibernate配置文件</h2>","categories":["hibernate"],"tags":["hibernate"]},{"title":"session接口","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/session%E6%8E%A5%E5%8F%A3/","content":"<h2 id=\"session接口\"><a href=\"#session接口\" class=\"headerlink\" title=\"session接口\"></a>session接口</h2><p>Session接口是hibernate向应用程序提供的操纵数据库的最主要的接口，提供了保存、更新、删除和加载Java对象的方法。</p>\n<p>session具有一个缓存，位于缓存中的对象成为持久化对象，和数据库中的相关记录对应。session能够在某些时间点，按照缓存中对象的变化来执行相关的SQL语句，来同步更新数据库，这一过程称为刷新缓存(flush)。</p>\n<p>hibernate把对象分为4种状态，持久化状态，临时状态，游离状态，删除状态。session的特定方法可以使对象进行状态转换</p>\n<a id=\"more\"></a>\n\n<h3 id=\"session缓存\"><a href=\"#session缓存\" class=\"headerlink\" title=\"session缓存\"></a>session缓存</h3><p>session实例没有结束生命周期，且没有清理缓存，则存放在session缓存中的对象也不会结束生命周期，session缓存可以减少访问数据库的频率。</p>\n<h4 id=\"操作session缓存\"><a href=\"#操作session缓存\" class=\"headerlink\" title=\"操作session缓存\"></a>操作session缓存</h4><h5 id=\"flush方法\"><a href=\"#flush方法\" class=\"headerlink\" title=\"flush方法\"></a>flush方法</h5><p>缓存中对象同步到数据库(会插入或更新数据库)，使数据库中的状态与缓存中一致</p>\n<p>注意：</p>\n<p>session在以下情况下会刷新缓存</p>\n<ul>\n<li><p>hibernate在事务提交之前会执行flush()方法，然后再向数据库提交事务</p>\n</li>\n<li><p>显示调用session.flush()方法</p>\n</li>\n<li><p>在执行HQL或者QBC查询，会先进行flush()操作，以得到数据表最新的记录</p>\n</li>\n</ul>\n<h5 id=\"refresh方法\"><a href=\"#refresh方法\" class=\"headerlink\" title=\"refresh方法\"></a>refresh方法</h5><p>将数据库同步到缓存中(会查询数据库)，使缓存中的状态与数据库一致</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">session.refresh(); </span><br></pre></td></tr></table></figure>\n\n\n\n<h5 id=\"clear方法\"><a href=\"#clear方法\" class=\"headerlink\" title=\"clear方法\"></a>clear方法</h5><p>清理缓存，可以将session中的缓存清除</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">session.clear();</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"四种状态的转换\"><a href=\"#四种状态的转换\" class=\"headerlink\" title=\"四种状态的转换\"></a>四种状态的转换</h3><p><strong>临时状态(Transient)</strong></p>\n<ul>\n<li>在使用代理主键的情况下，OID通常为null</li>\n<li>不处于session缓存中</li>\n<li>在数据库中也没有对应的记录</li>\n</ul>\n<p><strong>持久化状态(Persist)</strong></p>\n<ul>\n<li>OID不为null</li>\n<li>位于session缓存中</li>\n<li>若在数据库中已经有和其对应的记录，持久化对象和数据库中的相关记录对应</li>\n<li>session在flush缓存时，会根据持久化对象的属性变化，来同步数据库</li>\n<li>在同一个session实例的缓存中，数据库表中每条记录只对应唯一的持久化对象</li>\n<li>持久化对象的id不可以被修改，因为hibernate是根据id去进行比较的</li>\n</ul>\n<p><strong>删除状态(Removed)</strong></p>\n<ul>\n<li>在数据库中没有和其OID对应的记录</li>\n<li>不再处于session缓存中</li>\n</ul>\n<p><strong>游离状态(Detached)</strong></p>\n<ul>\n<li><p>OID不为null</p>\n</li>\n<li><p>不再处于session缓存中</p>\n</li>\n<li><p>一般情况下，游离对象是由持久化对象转变过来的，数据库中可能还存在它对应的记录</p>\n<img src=\"/images/hibernate/hibernate四种状态转换.jpg\" alt=\"hibernate四种状态转换\" style=\"zoom:33%;\">\n\n</li>\n</ul>\n<h4 id=\"save方法和persist方法的区别\"><a href=\"#save方法和persist方法的区别\" class=\"headerlink\" title=\"save方法和persist方法的区别\"></a>save方法和persist方法的区别</h4><p>在调用persist()方法时如果存在id，则会抛出异常，而save方法则可以正常执行</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">org.hibernate.PersistentObjectException: detached entity passed to persist</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"get方法和load方法的区别\"><a href=\"#get方法和load方法的区别\" class=\"headerlink\" title=\"get方法和load方法的区别\"></a>get方法和load方法的区别</h4><ul>\n<li><p>执行get方法会立即加载对象，执行load方法若不使用该对象，则不会立即查询，而是返回一个代理对象(延时加载)</p>\n</li>\n<li><p>若数据表中没有对应的记录，get方法返回null，load方法抛出异常</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">org.hibernate.ObjectNotFoundException: No row with the given identifier exists</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>load方法可能会抛出懒加载异常</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">org.hibernate.LazyInitializationException: could not initialize proxy - no Session</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<p>注意：在session缓存中不能够有两个相同OID的对象，否则会报异常</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">testOid</span><span class=\"params\">(Session session)</span></span>&#123;</span><br><span class=\"line\">  User user = (User) session.get(User.class,<span class=\"number\">1</span>);</span><br><span class=\"line\">  System.out.println(user);</span><br><span class=\"line\">  User user1  = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">  user1.setId(<span class=\"number\">1</span>);</span><br><span class=\"line\">  user1.setName(<span class=\"string\">&quot;王五&quot;</span>);</span><br><span class=\"line\">  session.saveOrUpdate(user1);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">org.hibernate.NonUniqueObjectException: A different object with the same identifier value was already associated with the session</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"evict方法\"><a href=\"#evict方法\" class=\"headerlink\" title=\"evict方法\"></a>evict方法</h4><p>从session缓存中将指定的持久化对象移除</p>\n<h4 id=\"hibernate获取原生JDBC连接进行操作\"><a href=\"#hibernate获取原生JDBC连接进行操作\" class=\"headerlink\" title=\"hibernate获取原生JDBC连接进行操作\"></a>hibernate获取原生JDBC连接进行操作</h4><p>可以使用doWork或者doReturnWork来使用原生JDBC操作数据</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">session.doWork(<span class=\"keyword\">new</span> Work() &#123;</span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(Connection connection)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">session.doReturningWork(<span class=\"keyword\">new</span> ReturningWork&lt;Object&gt;() &#123;</span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">execute</span><span class=\"params\">(Connection connection)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"session管理","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/session%E7%AE%A1%E7%90%86/","content":"<h2 id=\"session管理\"><a href=\"#session管理\" class=\"headerlink\" title=\"session管理\"></a>session管理</h2><p>hibernate自身提供了三种管理session的方法</p>\n<ul>\n<li><p>session对象的生命周期与本地线程绑定</p>\n</li>\n<li><p>session对象的生命周期与JTA事务绑定</p>\n</li>\n<li><p>hibernate委托程序管理session对象的生命周期</p>\n</li>\n</ul>\n<a id=\"more\"></a>\n\n<p>分别对应于hibernate配置文件中hibernate.current_session_context_class属性的三个值</p>\n<ul>\n<li>thread</li>\n<li>jta*</li>\n<li>managed</li>\n</ul>\n<h3 id=\"与线程绑定\"><a href=\"#与线程绑定\" class=\"headerlink\" title=\"与线程绑定\"></a>与线程绑定</h3><p>在使用session时，使用sessionFactory.getCurrentSession()来获取当前线程的session</p>\n<p>在用thread来进行管理时，在进行事务的提交或回滚操作时，session就会关闭</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;current_session_context_class&quot;</span>&gt;</span>thread<span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>注意：在与spring集成时，在使用LocalSessionFactoryBean时会自动的设置该配置，无需在配置文件中进行配置</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LocalSessionFactoryBuilder</span><span class=\"params\">(DataSource dataSource, ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.entityTypeFilters = DEFAULT_ENTITY_TYPE_FILTERS;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.getProperties().put(<span class=\"string\">&quot;hibernate.current_session_context_class&quot;</span>, SpringSessionContext.class.getName());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (dataSource != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.getProperties().put(<span class=\"string\">&quot;hibernate.connection.datasource&quot;</span>, dataSource);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.getProperties().put(<span class=\"string\">&quot;hibernate.classLoader.application&quot;</span>, resourceLoader.getClassLoader());</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.resourcePatternResolver = ResourcePatternUtils.getResourcePatternResolver(resourceLoader);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"关联关系","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/%E5%85%B3%E8%81%94%E5%85%B3%E7%B3%BB/","content":"<h2 id=\"关联关系\"><a href=\"#关联关系\" class=\"headerlink\" title=\"关联关系\"></a>关联关系</h2><p>以客户和订单为例来讲解关联关系，一个客户有多个订单，一个订单只能属于一个客户。从Order到Customer是多对一关联，从Customer到order是一对多关联，如果仅有从Order到Customer的关联或者仅有从Custom到Order的关联的话，称为单向关联，如果同时包含两种关联，称为双向关联</p>\n<p>在关系数据库中，只存在外键参照关系，总是由many方参照one方，以消除数据冗余，因此关系型数据库只支持多对一或一对一的单向关联</p>\n<a id=\"more\"></a>\n\n<p>以客户和订单为例</p>\n<h3 id=\"多对一关联\"><a href=\"#多对一关联\" class=\"headerlink\" title=\"多对一关联\"></a>多对一关联</h3><p>如果使用单向关联，最好使用多对一的关联关系，从Order到Customer</p>\n<p>注意由于order在mysql中属于关键字，为了使hibernate给我自动生成表结构，我设置表名为orders</p>\n<p>实体类中Order类中需定义一个customer属性，而customer类中无需定义order对象的集合</p>\n<p>由于在Order类中customer属性是Customer类型，而数据库中外键customer_id是int类型，所以不能用单纯的<property>来进行映射customer属性，需要使用many-to-one来表示</property></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">hibernate-mapping</span> <span class=\"meta-keyword\">PUBLIC</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;-//Hibernate/Hibernate Mapping DTD//EN&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">hibernate-mapping</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">class</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;com.zhanghe.study.model.many2one.Order&quot;</span> <span class=\"attr\">table</span>=<span class=\"string\">&quot;orders&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.Integer&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">column</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">generator</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;native&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">id</span>&gt;</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;orderName&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;java.lang.String&quot;</span> <span class=\"attr\">not-null</span>=<span class=\"string\">&quot;true&quot;</span> <span class=\"attr\">access</span>=<span class=\"string\">&quot;property&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">column</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;order_name&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">many-to-one</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;customer&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.model.many2one.Customer&quot;</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;customer_id&quot;</span> <span class=\"attr\">not-null</span>=<span class=\"string\">&quot;true&quot;</span> <span class=\"attr\">cascade</span>=<span class=\"string\">&quot;save-update&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">many-to-one</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">class</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">hibernate-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>many-to-one标签元素属性说明</p>\n<ul>\n<li>name   持久化类的属性名字</li>\n<li>column   外键字段名</li>\n<li>class  属性的类型</li>\n<li>not-null  为true，表示该属性不可为空，默认为false</li>\n<li>lazy  若为proxy，表示对关联的customer对象使用延迟加载并且使用代理，为false，表示在加载order对象时，会立即加载与之关联的customer对象，默认为proxy</li>\n<li>cascade   在保存或更新操作时会级联保存或更新与之关联的对象，默认为none </li>\n</ul>\n<h3 id=\"一对多关联\"><a href=\"#一对多关联\" class=\"headerlink\" title=\"一对多关联\"></a>一对多关联</h3><p>上面建立了order到customer的多对一关联，但是这样在操作customer的时候还要再去手动的去查所对应的order，这样操作很是麻烦，所以在建立从customer到order的一对多关联，这样就构建成了一个双向关联</p>\n<p>在customer类中新增order的集合属性并进行初始化(防止出现空指针异常)</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\">private Set<span class=\"tag\">&lt;<span class=\"name\">Order</span>&gt;</span> orders = new HashSet();</span><br></pre></td></tr></table></figure>\n\n<p>在customer表中并没有与orders属性对应的字段，所以在配置映射关系时使用<set>标签元素</set></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- table配置的是子表的表名  key为子表的外键  class为子表的实体名</span></span><br><span class=\"line\"><span class=\"comment\">        inverse决定由双向关联的哪一方来维护表的关联关系 inverse=false的为主动方 inverse=true为被动方，由主动方维护关联关系</span></span><br><span class=\"line\"><span class=\"comment\">            没有设置inverse=true时，父子双方都维护父子关系  一对多时由n的一方设为主控方，可以提升性能</span></span><br><span class=\"line\"><span class=\"comment\">         --&gt;</span></span><br><span class=\"line\">                <span class=\"comment\">&lt;!-- cascade设置为delete，使得在删除customer纪录时，同时将order记录删除 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">set</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;orders&quot;</span> <span class=\"attr\">table</span>=<span class=\"string\">&quot;orders&quot;</span> <span class=\"attr\">cascade</span>=<span class=\"string\">&quot;delete&quot;</span> <span class=\"attr\">inverse</span>=<span class=\"string\">&quot;true&quot;</span>&gt;</span></span><br><span class=\"line\">              <span class=\"comment\">&lt;!-- key表明orders表通过外键custom_id关联 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">key</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;customer_id&quot;</span>/&gt;</span></span><br><span class=\"line\">              <span class=\"comment\">&lt;!-- one-to-many表明orders集合中存放的是Order对象集合 --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">one-to-many</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.model.many2one.Order&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">set</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>此处如果不设置inverse的话，在进行两个对象关联时会出现如下情况</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// hibernate检测到order对象的customer属性发生了变化，会执行update语句更新order</span></span><br><span class=\"line\">order.setCustomer(customer);</span><br><span class=\"line\"><span class=\"comment\">// hibernate检测到customer的orders属性发生变化，会执行update语句更新customer</span></span><br><span class=\"line\">customer.getOrders().add(order);</span><br></pre></td></tr></table></figure>\n\n<p>但是实际上customer表中并没有关于order的字段，也就是会出现执行多余SQL的情况，影响java性能，所以将inverse设置为true，仅按照order对象的属性变化来更新数据库</p>\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"批量操作","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C/","content":"<h2 id=\"批量操作\"><a href=\"#批量操作\" class=\"headerlink\" title=\"批量操作\"></a>批量操作</h2><p>有以下四种方式来进行批量操作</p>\n<ul>\n<li><p>通过session</p>\n</li>\n<li><p>通过HQL</p>\n</li>\n<li><p>通过statelessSession</p>\n</li>\n<li><p>通过JDBCAPI    使用该方式效率最高，速度最快</p>\n</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"通过session\"><a href=\"#通过session\" class=\"headerlink\" title=\"通过session\"></a>通过session</h3><p>通过session批量操作时：session的save()及update()方法会把处理的对象存放在自己的缓存中，如果使用session来处理大量持久化对象，需要及时从缓存中清空已经处理完毕且不会再访问的对象(处理完一批对象后，立即调用flush()方法刷新缓存，然后调用clear()方法清空缓存)</p>\n<p><em>注意</em>：</p>\n<ul>\n<li><p>在hibernate配置文件中设置JDBC单次批量的数目，应保证每次想数据库发送的批量SQL语句数目与batch_size属性一致</p>\n</li>\n<li><p>如果主键由数据库自增生成的话，无法使用批量操作</p>\n</li>\n</ul>\n<h4 id=\"通过HQL\"><a href=\"#通过HQL\" class=\"headerlink\" title=\"通过HQL\"></a>通过HQL</h4><p>不能进行批量插入，更新只能操作一条sql语句(比如说将某个值批量改为某个数)</p>\n<h4 id=\"通过StatelessSession\"><a href=\"#通过StatelessSession\" class=\"headerlink\" title=\"通过StatelessSession\"></a>通过StatelessSession</h4><ul>\n<li>StatelessSession没有缓存，使用该类来加载、保存、更新后的对象处于游离状态</li>\n<li>调用save()、update()、delete()方法时会立即执行SQL语句</li>\n<li>StatelessSession不会对所加载的对象自动进行脏检查。需要进行显示的save()/update()</li>\n<li>StatelessSession不会对关联的对象进行任何级联操作</li>\n<li>通过同一个StatelessSession加载相同OID的对象，会得到两个具有不同内存地址的对象</li>\n<li>StatelessSession可以被Interceptor拦截器拦截到，但是会被hibernate事件处理系统忽略</li>\n</ul>\n<h3 id=\"通过JDBCAPI\"><a href=\"#通过JDBCAPI\" class=\"headerlink\" title=\"通过JDBCAPI\"></a>通过JDBCAPI</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">session.doWork(<span class=\"keyword\">new</span> Work() &#123;</span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">execute</span><span class=\"params\">(Connection connection)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"检索方式","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/%E6%A3%80%E7%B4%A2%E6%96%B9%E5%BC%8F/","content":"<h2 id=\"检索方式\"><a href=\"#检索方式\" class=\"headerlink\" title=\"检索方式\"></a>检索方式</h2><p>检索方式即为查询对象的方式</p>\n<p>hibernate提供了几种检索对象的方式</p>\n<ul>\n<li>导航对象图检索方式 ：使用已加载的对象get获取关联对象</li>\n<li>OID检索方式 ：使用OID来获取对象get()和load()方法</li>\n<li>HQL检索方式：使用面向对象的HQL(Hibernate Query Language)查询语言Query</li>\n<li>QBC检索方式：使用QBC(Query By Criteria)API来检索对象</li>\n<li>本地SQL检索方式：使用本地数据库的SQL查询语句</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"HQL检索方式\"><a href=\"#HQL检索方式\" class=\"headerlink\" title=\"HQL检索方式\"></a>HQL检索方式</h3><p>使用Query.createQuery()方法创建Query对象</p>\n<h4 id=\"绑定参数\"><a href=\"#绑定参数\" class=\"headerlink\" title=\"绑定参数\"></a>绑定参数</h4><p>Hibernate的参数绑定机制依赖于JDBC中的PreparedStatement的预定义SQL语句，有两种形式</p>\n<ul>\n<li>按参数名字绑定   命名参数以:开头</li>\n<li>按参数位置绑定   用?来定义参数位置</li>\n</ul>\n<p>相关方法</p>\n<ul>\n<li>setEntity()   把参数与一个持久化类绑定</li>\n<li>setParameter()  绑定任意类型的参数，该方法的第三个参数显示指定Hibernate映射类型</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 使用参数名字</span></span><br><span class=\"line\">String hql = <span class=\"string\">&quot;from User where id &gt; :id&quot;</span>;</span><br><span class=\"line\">List&lt;User&gt; users = session.createQuery(hql)</span><br><span class=\"line\">  .setInteger(<span class=\"string\">&quot;id&quot;</span>,<span class=\"number\">2</span>).list();</span><br><span class=\"line\">System.out.println(users);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 使用参数位置</span></span><br><span class=\"line\">String hql = <span class=\"string\">&quot;from User where id &gt; ?&quot;</span>;</span><br><span class=\"line\">List&lt;User&gt; users = session.createQuery(hql)</span><br><span class=\"line\">  .setInteger(<span class=\"number\">0</span>,<span class=\"number\">2</span>).list();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"分页查询\"><a href=\"#分页查询\" class=\"headerlink\" title=\"分页查询\"></a>分页查询</h4><p>相关方法</p>\n<ul>\n<li>setFirstResult(int)   从哪个位置开始检索</li>\n<li>setMaxResults(int)  一次检索出多少条</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">List&lt;User&gt; users = session.createQuery(<span class=\"string\">&quot;from User&quot;</span>)</span><br><span class=\"line\">                .setFirstResult(<span class=\"number\">1</span>)</span><br><span class=\"line\">                .setMaxResults(<span class=\"number\">2</span>).list();</span><br><span class=\"line\">System.out.println(users);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"投影查询\"><a href=\"#投影查询\" class=\"headerlink\" title=\"投影查询\"></a>投影查询</h4><p>只查部分字段，不查询全部数据</p>\n<p>默认情况下hibernate查询返回的是一个个的Object[]，如果查询部分字段的话，需要一个一个的去遍历赋值</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">List&lt;Object[]&gt; result = session.createQuery(<span class=\"string\">&quot;select id,name from User&quot;</span>).list();</span><br><span class=\"line\"><span class=\"keyword\">for</span>(Object[] objs : result)&#123;</span><br><span class=\"line\">  System.out.println(Arrays.asList(objs));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>当然上述方法太过于麻烦，可以使用构造器来实现</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//  注意：使用这种方式的话，要在类中有这样的构造器，当然不要忘了无参构造器必须有</span></span><br><span class=\"line\">List&lt;User&gt; result = session.createQuery(<span class=\"string\">&quot;select new User(id,name) from User&quot;</span>).list();</span><br><span class=\"line\"><span class=\"keyword\">for</span>(User user : result)&#123;</span><br><span class=\"line\">  System.out.println(user);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"QBC检索方式\"><a href=\"#QBC检索方式\" class=\"headerlink\" title=\"QBC检索方式\"></a>QBC检索方式</h3><p>使用Criteria查询</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">Criteria criteria = session.createCriteria(User.class);</span><br><span class=\"line\">criteria.add(Restrictions.eq(<span class=\"string\">&quot;id&quot;</span>,<span class=\"number\">2</span>));</span><br><span class=\"line\">User user = (User) criteria.uniqueResult();</span><br><span class=\"line\">System.out.println(user);</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"检索策略","url":"/2020/%E6%A1%86%E6%9E%B6/hibernate/%E6%A3%80%E7%B4%A2%E7%AD%96%E7%95%A5/","content":"<h2 id=\"检索策略\"><a href=\"#检索策略\" class=\"headerlink\" title=\"检索策略\"></a>检索策略</h2><h3 id=\"类级别的检索策略\"><a href=\"#类级别的检索策略\" class=\"headerlink\" title=\"类级别的检索策略\"></a>类级别的检索策略</h3><p>有两种方式，一种为立即检索，一种为延迟检索</p>\n<p>在class元素中设置属性lazy   默认为true</p>\n<ul>\n<li>立即检索：立即加载检索方法指定的对象</li>\n<li>延迟检索：只有在使用具体属性(除id之外的属性)的时候才会加载  </li>\n</ul>\n<p>注意：只有在使用load方法的时候，lazy属性才会有用，在使用get()和list()方法时，只会使用立即检索</p>\n<a id=\"more\"></a>\n\n<h3 id=\"一对多和多对多检索策略\"><a href=\"#一对多和多对多检索策略\" class=\"headerlink\" title=\"一对多和多对多检索策略\"></a>一对多和多对多检索策略</h3><p>在set属性中配置一对多和多对多关联关系，set元素有lazy和fetch属性</p>\n<ul>\n<li>lazy：主要决定set被初始化的时间，在加载主表时被初始化还是再被访问时被初始化  默认为true</li>\n<li>fetch：取值为select或subselect时，决定初始化set的查询语句形式；取值为join，决定set被初始化的时机，lazy属性将会被忽略，默认为select<ul>\n<li>select   set元素中每条数据都会执行一条select语句</li>\n<li>subselect  使用子查询，直接初始化set中所有的元素，使用 in (select id from zitable)，此时batch-size属性被忽略</li>\n<li>join 使用左外连接  (Query的list方法会忽略join，使用延迟检索)</li>\n</ul>\n</li>\n<li>batch-size：set中有一个batch-size属性，用来配置在延迟加载的情况下，每次加载几条数据，可以减少查询语句，提升性能（查询多条时使用in语句查询）</li>\n</ul>\n<h3 id=\"多对一和一对一检索策略\"><a href=\"#多对一和一对一检索策略\" class=\"headerlink\" title=\"多对一和一对一检索策略\"></a>多对一和一对一检索策略</h3><p>在many-to-one元素中也包含lazy属性和fetch属性</p>\n<ul>\n<li>lazy： proxy表示延时检索       no-proxy   false 表示立即检索   默认proxy</li>\n<li>fetch：select 每条数据使用一个select     join表示使用左外连接    默认select   </li>\n<li>batch-size：可以在一的一端的class元素中设置batch-size，来配置一次初始化1的这一端的代理的个数</li>\n</ul>\n","categories":["hibernate"],"tags":["hibernate"]},{"title":"mybatis简介","url":"/2021/%E6%A1%86%E6%9E%B6/mybatis/Mybatis%E7%AE%80%E4%BB%8B/","content":"<h2 id=\"Mybatis简介\"><a href=\"#Mybatis简介\" class=\"headerlink\" title=\"Mybatis简介\"></a>Mybatis简介</h2><p>MyBatis 是一款优秀的半自动化的持久层框架，它支持定制化 SQL、存储过程以及高级映射。MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。MyBatis 可以使用简单的 XML 或注解来配置和映射原生信息，将接口和 Java对象映射成数据库中的记录。</p>\n<p>SQL语句与java业务代码分离，一个专注于业务，一个专注于数据</p>\n<h3 id=\"与Hibernate对比优点\"><a href=\"#与Hibernate对比优点\" class=\"headerlink\" title=\"与Hibernate对比优点\"></a>与Hibernate对比优点</h3><ul>\n<li>对于复杂的SQL，Hibernate处理起来比较困难</li>\n<li>Hibernate自动生成SQL，不便于进行SQL优化</li>\n<li>Hibernate是全映射的全自动框架，大量字段的POJO进行部分映射时比较困难，导致数据库性能下降</li>\n<li>Hibernate的功能并不比Mybatis少，但是学习成本太大，需要深入研究Hibernate才可以很好的使用Hibernate中所提供的各种自定义配置</li>\n</ul>\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis基本配置及执行","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B/","content":"<h2 id=\"mybatis基本配置及执行\"><a href=\"#mybatis基本配置及执行\" class=\"headerlink\" title=\"mybatis基本配置及执行\"></a>mybatis基本配置及执行</h2><p>使用了mybatis首先需要两个配置文件，一个是mybatis-config.xml，是mybatis的基础配置文件，配置数据库的地址、用户名、密码、别名信息、映射配置文件位置以及一些全局配置；另一个配置文件是mapper.xml，这是实体与表的映射文件，定义了映射规则以及一些SQL语句。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"配置文件配置\"><a href=\"#配置文件配置\" class=\"headerlink\" title=\"配置文件配置\"></a>配置文件配置</h3><h4 id=\"全局配置文件\"><a href=\"#全局配置文件\" class=\"headerlink\" title=\"全局配置文件\"></a>全局配置文件</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">configuration</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-keyword\">PUBLIC</span> <span class=\"meta-string\">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 数据库配置 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">environments</span> <span class=\"attr\">default</span>=<span class=\"string\">&quot;development&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">environment</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;development&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">transactionManager</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">dataSource</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;POOLED&quot;</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;driver&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;url&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;jdbc:mysql://localhost:3306/test&quot;</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;root&quot;</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123456&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">dataSource</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">environment</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">environments</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- mapper配置 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mappers</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">mapper</span> <span class=\"attr\">resource</span>=<span class=\"string\">&quot;mapper/UserMapper.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">mappers</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"mapper配置文件\"><a href=\"#mapper配置文件\" class=\"headerlink\" title=\"mapper配置文件\"></a>mapper配置文件</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">mapper</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-keyword\">PUBLIC</span> <span class=\"meta-string\">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- namespace为mapper接口的全类名,用于区分不同Mapper接口中的相同方法 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mapper</span> <span class=\"attr\">namespace</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 查询数据的方法 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUser&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.User&quot;</span>&gt;</span></span><br><span class=\"line\">        select * from users where id = #&#123;id&#125;</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"执行流程\"><a href=\"#执行流程\" class=\"headerlink\" title=\"执行流程\"></a>执行流程</h3><p>了解了配置文件之后，进行了解执行的整体流程，首先程序会先加载mybatis-config.xml配置文件，根据配置文件内容创建SqlSessionFactory对象，然后，通过SqlSessionFactory创建SqlSession对象，SqlSession接口中定义了执行SQL语句所需的各种方法，通过SqlSession对象执行配置文件中的定义的SQL语句，完成相应的数据操作，最后通过SqlSession提交事务，关闭SqlSession对象</p>\n<h4 id=\"创建SqlSessionFactory\"><a href=\"#创建SqlSessionFactory\" class=\"headerlink\" title=\"创建SqlSessionFactory\"></a>创建SqlSessionFactory</h4><p>SqlSessionFactory是Mybatis的核心，可以通过SqlSessionFactoryBuilder获得，SqlSessionFactoryBuilder从mybatis的配置文件构建出SqlSessionFactory实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> SqlSessionFactory <span class=\"title\">createFactory</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获取到mybatis-config.xml配置文件，进而构建SqlSessionFactory</span></span><br><span class=\"line\">    InputStream is = Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class=\"string\">&quot;mybatis-config.xml&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> SqlSessionFactoryBuilder().build(is);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取SqlSession\"><a href=\"#获取SqlSession\" class=\"headerlink\" title=\"获取SqlSession\"></a>获取SqlSession</h4><p>通过SqlSessionFactory实例，可以获取到SqlSession的实例，sqlSession提供了在数据库执行SQL命令所需的所有方法，可以通过SqlSession实例来直接执行已映射的SQL语句</p>\n<h5 id=\"老版本执行\"><a href=\"#老版本执行\" class=\"headerlink\" title=\"老版本执行\"></a>老版本执行</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> SqlSession <span class=\"title\">getCurrentSession</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    SqlSessionFactory factory = createFactory();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> factory.openSession();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">SqlSession session = getCurrentSession();</span><br><span class=\"line\"><span class=\"comment\">// selectOne方法的两个参数  1、sql的唯一标识(namespace+id)   2、sql所需要的参数</span></span><br><span class=\"line\">User user = session.selectOne(<span class=\"string\">&quot;com.zhanghe.study.mybatis.mapper.UserMapper.selectUser&quot;</span>,<span class=\"number\">2</span>);</span><br><span class=\"line\">System.out.println(user);</span><br><span class=\"line\"><span class=\"comment\">// 关闭session</span></span><br><span class=\"line\">session.close();</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"新版本执行\"><a href=\"#新版本执行\" class=\"headerlink\" title=\"新版本执行\"></a>新版本执行</h5><p>由于老版本操作时容易出现一些问题，新版本的mybatis进行了改善，将整个mapper文件的命名空间映射为一个接口，每个mapper中的sql语句映射为接口中的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">UserMapper</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">User <span class=\"title\">selectUser</span><span class=\"params\">(Integer id)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">session = getCurrentSession();</span><br><span class=\"line\"><span class=\"comment\">// mybatis为接口创建代理对象</span></span><br><span class=\"line\">UserMapper userMapper = session.getMapper(UserMapper.class);</span><br><span class=\"line\">User user1 = userMapper.selectUser(<span class=\"number\">2</span>);</span><br><span class=\"line\">System.out.println(user1);</span><br><span class=\"line\">session.close();</span><br></pre></td></tr></table></figure>","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis整合spring","url":"/2021/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%95%B4%E5%90%88spring/","content":"<h2 id=\"mybatis整合spring\"><a href=\"#mybatis整合spring\" class=\"headerlink\" title=\"mybatis整合spring\"></a>mybatis整合spring</h2><p>当前spring是最热门的框架之一，很多框架都需要和spring整合，将组件交给spring的IOC容器来管理，下面来带大家来简单地配置一下mybatis和spring的整合</p>\n<a id=\"more\"></a>\n\n<h3 id=\"添加依赖\"><a href=\"#添加依赖\" class=\"headerlink\" title=\"添加依赖\"></a>添加依赖</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.mybatis<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mybatis<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>3.5.5<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>mysql<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>5.1.48<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- mybatis整合spring --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.mybatis<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mybatis-spring<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>1.3.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- spring 相关依赖 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-jdbc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-aop<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-context<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-beans<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-aspects<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-tx<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"mybatis配置文件\"><a href=\"#mybatis配置文件\" class=\"headerlink\" title=\"mybatis配置文件\"></a>mybatis配置文件</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">configuration</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-keyword\">PUBLIC</span> <span class=\"meta-string\">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">settings</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 开启二级缓存 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">setting</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;cacheEnabled&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">setting</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;logImpl&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;STDOUT_LOGGING&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。 特定关联关系中可通过设置 fetchType 属性来覆盖该项的开关状态。 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">setting</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;lazyLoadingEnabled&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 开启时，任一方法的调用都会加载该对象的所有延迟加载属性。 否则，每个延迟加载属性会按需加载 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">setting</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;aggressiveLazyLoading&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;false&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">settings</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">typeAliases</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- typeAlias为某个类起别名 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">typeAlias</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.User&quot;</span> <span class=\"attr\">alias</span>=<span class=\"string\">&quot;User&quot;</span>/&gt;</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 为某个包下所有类批量起别名</span></span><br><span class=\"line\"><span class=\"comment\">            默认值为类名首字母小写</span></span><br><span class=\"line\"><span class=\"comment\">         --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">package</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">typeAliases</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 数据库厂商标识 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">databaseIdProvider</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;DB_VENDOR&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- name为使用DatabaseMetaData#getDatabaseProductName()返回的厂商名称</span></span><br><span class=\"line\"><span class=\"comment\">             value为所设置的别名,使用databaseId时使用别名即可 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;MySQL&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;mysql&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;Oracle&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;oracle&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">databaseIdProvider</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"spring配置文件\"><a href=\"#spring配置文件\" class=\"headerlink\" title=\"spring配置文件\"></a>spring配置文件</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:context</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:mybatis</span>=<span class=\"string\">&quot;http://mybatis.org/schema/mybatis-spring&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:tx</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd   http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">context:component-scan</span> <span class=\"attr\">base-package</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 引入数据库配置文件 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">context:property-placeholder</span> <span class=\"attr\">location</span>=<span class=\"string\">&quot;jdbc.properties&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 数据源 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;datasource&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;driverClassName&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;url&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 事务管理器 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;transactionManager&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;datasource&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 创建sqlSessionFactory --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;sqlSessionFactory&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;datasource&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- mybatis全局配置文件的位置 也可以不使用mybatis全局配置 所有信息都可以在该bean中使用property来配置 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;configLocation&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;mybatis-config1.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- mapper映射文件的位置 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;mapperLocations&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;classpath*:mapper/**/*.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 亲测两种方式都可以 --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 方式一：扫描所有的mapper接口,使得接口自动注入 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;basePackage&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.mapper&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;sqlSessionFactoryBeanName&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;sqlSessionFactory&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 方式二：扫描所有的mapper接口,使得接口自动注入 --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    &lt;mybatis:scan base-package=&quot;com.zhanghe.study.mybatis.mapper&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 事务管理器 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">tx:annotation-driven</span> <span class=\"attr\">transaction-manager</span>=<span class=\"string\">&quot;transactionManager&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"单测结果\"><a href=\"#单测结果\" class=\"headerlink\" title=\"单测结果\"></a>单测结果</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * mybatis、spring整合测试</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> zh</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2021/1/15 16:08</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MybatisSpringTest</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ApplicationContext context;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> SqlSessionFactory sqlSessionFactory;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Before</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">beanFactory</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        context = <span class=\"keyword\">new</span> ClassPathXmlApplicationContext(<span class=\"string\">&quot;applicationContext.xml&quot;</span>);</span><br><span class=\"line\">        sqlSessionFactory = context.getBean(SqlSessionFactory.class);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Test</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">testbeanAutoWired</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        UserMapper userMapper = context.getBean(UserMapper.class);</span><br><span class=\"line\">        System.out.println(userMapper);</span><br><span class=\"line\">        UserService userService = context.getBean(UserService.class);</span><br><span class=\"line\">        userService.print();</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Test</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">testTwoLevelCache</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        SqlSession session = sqlSessionFactory.openSession();</span><br><span class=\"line\">        <span class=\"comment\">// mybatis为接口创建代理对象</span></span><br><span class=\"line\">        UserMapper userMapper = session.getMapper(UserMapper.class);</span><br><span class=\"line\">        User user = userMapper.selectUser(<span class=\"number\">8</span>);</span><br><span class=\"line\">        System.out.println(user);</span><br><span class=\"line\">        userMapper.updateUser(user);</span><br><span class=\"line\">        session.close();</span><br><span class=\"line\">        SqlSession session1 = sqlSessionFactory.openSession();</span><br><span class=\"line\"></span><br><span class=\"line\">        UserMapper userMapper1 = session1.getMapper(UserMapper.class);</span><br><span class=\"line\">        User user1 = userMapper1.selectUser(<span class=\"number\">8</span>);</span><br><span class=\"line\">        System.out.println(user1);</span><br><span class=\"line\">        System.out.println(user == user1);</span><br><span class=\"line\"></span><br><span class=\"line\">        session1.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>参考地址<a href=\"http://mybatis.org/spring/zh/getting-started.html\">http://mybatis.org/spring/zh/getting-started.html</a></p>\n</blockquote>\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis映射文件","url":"/2021/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6/","content":"<h2 id=\"Mybatis映射文件\"><a href=\"#Mybatis映射文件\" class=\"headerlink\" title=\"Mybatis映射文件\"></a>Mybatis映射文件</h2><h3 id=\"增删改查\"><a href=\"#增删改查\" class=\"headerlink\" title=\"增删改查\"></a>增删改查</h3><h4 id=\"简单地增删改查\"><a href=\"#简单地增删改查\" class=\"headerlink\" title=\"简单地增删改查\"></a>简单地增删改查</h4><a id=\"more\"></a>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUser&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;User&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from `user` where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">insert</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;addUser&quot;</span>&gt;</span></span><br><span class=\"line\">    insert into `user` (`name`,account) values (#&#123;name&#125;,#&#123;account&#125;)</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">insert</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">update</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;updateUser&quot;</span>&gt;</span></span><br><span class=\"line\">    update `user` set `name` = #&#123;name&#125;, account = #&#123;account&#125; where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">update</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">delete</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;deleteUser&quot;</span>&gt;</span></span><br><span class=\"line\">    delete from `user` where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">delete</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>使用factory.openSession()得到的sqlSession默认不会自动提交，需要手动的提交事务</p>\n<p>使用factory.openSession(true)得到的sqlSession自动提交</p>\n</blockquote>\n<h4 id=\"select详细属性\"><a href=\"#select详细属性\" class=\"headerlink\" title=\"select详细属性\"></a>select详细属性</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- </span></span><br><span class=\"line\"><span class=\"comment\">    id 命名空间的唯一标识，一般为方法名</span></span><br><span class=\"line\"><span class=\"comment\">  parameterType   入参类型，该参数可选，mybatis通过类型处理器TypeHandler推断出具体传入的参数</span></span><br><span class=\"line\"><span class=\"comment\">  resultType      返回结果的类全限定名或别名(如果为集合，应设置为集合包含的类型，而不是集合本身的类型)</span></span><br><span class=\"line\"><span class=\"comment\">    resultMap       结果映射(resultType和ResultMap只能同时使用一个)</span></span><br><span class=\"line\"><span class=\"comment\">  flushCache      设置为true，该语句被调用后清空本地缓存和二级缓存，默认false</span></span><br><span class=\"line\"><span class=\"comment\">  useCache        设置为true，该语句结果被二级缓存缓存    select语句默认true</span></span><br><span class=\"line\"><span class=\"comment\">    timeout         等待数据库返回的超时时间</span></span><br><span class=\"line\"><span class=\"comment\">  fetchSize       批量返回的行数</span></span><br><span class=\"line\"><span class=\"comment\">  statementType   可选STATEMENT/PREPARED/CALLABLE  分别对应于Statement/PreparedStatement/CallaleStatement   默认PREPARED</span></span><br><span class=\"line\"><span class=\"comment\">  resultSetType   FORWARD_ONLY/SCROLL_SENSITIVE/SCROLL_INSENSITIVE/DEFAULT</span></span><br><span class=\"line\"><span class=\"comment\">  databaseId      数据库厂商id</span></span><br><span class=\"line\"><span class=\"comment\">  resultOrdered   只针对于嵌套结果select语句：如果为true，将会假设包含了嵌套结果集或是分组，当返回一个主结果行时，就不会产生对前面结果集的引用  默认false</span></span><br><span class=\"line\"><span class=\"comment\">  resultSets      针对于多结果集的情况。将列出语句执行后返回的结果集并赋予每个结果集一个名称，多个名称逗号隔开</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUser&quot;</span>    </span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">parameterType</span>=<span class=\"string\">&quot;int&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;hashmap&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;personResultMap&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">flushCache</span>=<span class=\"string\">&quot;false&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">useCache</span>=<span class=\"string\">&quot;true&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">timeout</span>=<span class=\"string\">&quot;10&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">fetchSize</span>=<span class=\"string\">&quot;256&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">statementType</span>=<span class=\"string\">&quot;PREPARED&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">resultSetType</span>=<span class=\"string\">&quot;FORWARD_ONLY&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"insert-update-delete详细属性\"><a href=\"#insert-update-delete详细属性\" class=\"headerlink\" title=\"insert/update/delete详细属性\"></a>insert/update/delete详细属性</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- </span></span><br><span class=\"line\"><span class=\"comment\">    id 命名空间的唯一标识，一般为方法名</span></span><br><span class=\"line\"><span class=\"comment\">  parameterType   入参类型，该参数可选，mybatis通过类型处理器TypeHandler推断出具体传入的参数</span></span><br><span class=\"line\"><span class=\"comment\">  flushCache      设置为true，该语句被调用后清空本地缓存和二级缓存， insert、update、delete语句默认false</span></span><br><span class=\"line\"><span class=\"comment\">    timeout         等待数据库返回的超时时间</span></span><br><span class=\"line\"><span class=\"comment\">  statementType   可选STATEMENT/PREPARED/CALLABLE  分别对应于Statement/PreparedStatement/CallaleStatement   默认PREPARED</span></span><br><span class=\"line\"><span class=\"comment\">  databaseId      数据库厂商id</span></span><br><span class=\"line\"><span class=\"comment\">  useGeneratedKeys  使用JDBC的getGeneratedKeys方法来获取数据库生成的主键，默认false</span></span><br><span class=\"line\"><span class=\"comment\">  keyProperty     指定对象的主键属性，将getGeneratedKeys的返回值赋给该属性，如果生成列不止一个，使用逗号隔开</span></span><br><span class=\"line\"><span class=\"comment\">  keyColumn       指定生成键值在数据库中的列名，如果生成列不止一个，用逗号隔开</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">insert</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">id</span>=<span class=\"string\">&quot;insertAuthor&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">parameterType</span>=<span class=\"string\">&quot;domain.blog.Author&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">flushCache</span>=<span class=\"string\">&quot;true&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">statementType</span>=<span class=\"string\">&quot;PREPARED&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">keyProperty</span>=<span class=\"string\">&quot;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">keyColumn</span>=<span class=\"string\">&quot;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">useGeneratedKeys</span>=<span class=\"string\">&quot;&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">timeout</span>=<span class=\"string\">&quot;20&quot;</span>&gt;</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">update</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">id</span>=<span class=\"string\">&quot;updateAuthor&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">parameterType</span>=<span class=\"string\">&quot;domain.blog.Author&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">flushCache</span>=<span class=\"string\">&quot;true&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">statementType</span>=<span class=\"string\">&quot;PREPARED&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">timeout</span>=<span class=\"string\">&quot;20&quot;</span>&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">delete</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">id</span>=<span class=\"string\">&quot;deleteAuthor&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">parameterType</span>=<span class=\"string\">&quot;domain.blog.Author&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">flushCache</span>=<span class=\"string\">&quot;true&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">statementType</span>=<span class=\"string\">&quot;PREPARED&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">timeout</span>=<span class=\"string\">&quot;20&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"插入扩展\"><a href=\"#插入扩展\" class=\"headerlink\" title=\"插入扩展\"></a>插入扩展</h4><h5 id=\"获取自增id\"><a href=\"#获取自增id\" class=\"headerlink\" title=\"获取自增id\"></a>获取自增id</h5><p>默认情况下，插入数据后无法获取自增属性的主键id</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    自增主键，mybatis利用statement.getGeneratedKeys()来获取</span></span><br><span class=\"line\"><span class=\"comment\">    useGeneratedKeys=&quot;true&quot; 使用自增主键获取主键值策略</span></span><br><span class=\"line\"><span class=\"comment\">    keyProperty  指定对应的主键属性，mybatis获取到主键值后，将值赋给该属性</span></span><br><span class=\"line\"><span class=\"comment\"> --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">insert</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;addUserReturnGeneratedKey&quot;</span> <span class=\"attr\">useGeneratedKeys</span>=<span class=\"string\">&quot;true&quot;</span> <span class=\"attr\">keyProperty</span>=<span class=\"string\">&quot;id&quot;</span>&gt;</span></span><br><span class=\"line\">    insert into `user` (`name`,account) values (#&#123;name&#125;,#&#123;account&#125;)</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"不支持自增主键的方式\"><a href=\"#不支持自增主键的方式\" class=\"headerlink\" title=\"不支持自增主键的方式\"></a>不支持自增主键的方式</h5><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    不支持自增主键的方式</span></span><br><span class=\"line\"><span class=\"comment\"> --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">insert</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;addUserReturnGeneratedKey&quot;</span> <span class=\"attr\">databaseId</span>=<span class=\"string\">&quot;oracle&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 使用selectKey来获取主键序列值</span></span><br><span class=\"line\"><span class=\"comment\">        keyProperty 指定对应的主键属性，mybatis获取到主键值后，将值赋给该属性</span></span><br><span class=\"line\"><span class=\"comment\">        order before表示当前sql在插入sql之前</span></span><br><span class=\"line\"><span class=\"comment\">              after表示当前sql在插入sql之后</span></span><br><span class=\"line\"><span class=\"comment\">        resultType 查出来的数据返回值类型</span></span><br><span class=\"line\"><span class=\"comment\">     --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">selectKey</span> <span class=\"attr\">keyProperty</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">order</span>=<span class=\"string\">&quot;BEFORE&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;Integer&quot;</span>&gt;</span></span><br><span class=\"line\">        select user_seq.nextval from dual</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">selectKey</span>&gt;</span></span><br><span class=\"line\">    insert into `user` (id,`name`,account) values (#&#123;id&#125;,#&#123;name&#125;,#&#123;account&#125;)</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"参数处理\"><a href=\"#参数处理\" class=\"headerlink\" title=\"参数处理\"></a>参数处理</h4><h5 id=\"普通的数据类型\"><a href=\"#普通的数据类型\" class=\"headerlink\" title=\"普通的数据类型\"></a>普通的数据类型</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">User <span class=\"title\">selectUserByIdAndName</span><span class=\"params\">(<span class=\"meta\">@Param(&quot;id&quot;)</span> <span class=\"keyword\">int</span> id,<span class=\"meta\">@Param(&quot;name&quot;)</span> String name)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 测试多个参数取值</span></span><br><span class=\"line\"><span class=\"comment\">    mybatis默认将多个参数封装为一个map</span></span><br><span class=\"line\"><span class=\"comment\">         map的key为param1~paramN</span></span><br><span class=\"line\"><span class=\"comment\">         map的value为传入的参数值</span></span><br><span class=\"line\"><span class=\"comment\">         #&#123;&#125;使用的是map的key来取值</span></span><br><span class=\"line\"><span class=\"comment\">     可以使用命名参数来明确指定封装成map时的key @Param(&quot;id&quot;) @Param(&quot;name&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">        map的key为@Param注解指定的名称</span></span><br><span class=\"line\"><span class=\"comment\">        map的value为传入的参数值</span></span><br><span class=\"line\"><span class=\"comment\"> --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUserByIdAndName&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;User&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from user where id = #&#123;id&#125; and name = #&#123;name&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"自定义的java对象数据类型\"><a href=\"#自定义的java对象数据类型\" class=\"headerlink\" title=\"自定义的java对象数据类型\"></a>自定义的java对象数据类型</h5><p>对于很多入参的情况，不希望方法的入参那么多，而且需要指定@Param参数，可以将这些入参封装为一个对象.</p>\n<p>对于对象，可以直接使用字段来进行获取</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">User <span class=\"title\">selectUserByCondition</span><span class=\"params\">(User user)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUserByCondition&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;User&quot;</span>&gt;</span></span><br><span class=\"line\">        select * from user</span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;id != null and id != 0&quot;</span>&gt;</span></span><br><span class=\"line\">              and id = #&#123;id&#125;</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;name != null&quot;</span>&gt;</span></span><br><span class=\"line\">                and name = #&#123;name&#125;</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;account != null and account != 0&quot;</span>&gt;</span></span><br><span class=\"line\">                and account = #&#123;account&#125;</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"集合属性\"><a href=\"#集合属性\" class=\"headerlink\" title=\"集合属性\"></a>集合属性</h5><p>对于List，mybatis会映射为list，可以通过list来获取集合中的值</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">List&lt;User&gt; <span class=\"title\">selectByIds</span><span class=\"params\">(List&lt;Integer&gt; ids)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectByIds&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;User&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from user</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">        id in</span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">foreach</span> <span class=\"attr\">collection</span>=<span class=\"string\">&quot;list&quot;</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;index&quot;</span> <span class=\"attr\">item</span>=<span class=\"string\">&quot;item&quot;</span> <span class=\"attr\">open</span>=<span class=\"string\">&quot;(&quot;</span> <span class=\"attr\">separator</span>=<span class=\"string\">&quot;,&quot;</span> <span class=\"attr\">close</span>=<span class=\"string\">&quot;)&quot;</span>&gt;</span></span><br><span class=\"line\">            #&#123;item&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">foreach</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"结果映射\"><a href=\"#结果映射\" class=\"headerlink\" title=\"结果映射\"></a>结果映射</h3><p>resultMap和resultType都是作为结果集返回映射</p>\n<h4 id=\"ResultType\"><a href=\"#ResultType\" class=\"headerlink\" title=\"ResultType\"></a>ResultType</h4><h5 id=\"使用map\"><a href=\"#使用map\" class=\"headerlink\" title=\"使用map\"></a>使用map</h5><p>很多情况下使用map作为返回是可以支持的，但是map不是一个很好的领域模型，在获取到数据库结果之后，还需要再去人工的从map中取值给业务需要的字段去赋值，是一件痛苦而繁琐的事情</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUser&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;map&quot;</span>&gt;</span></span><br><span class=\"line\">  select * from user where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"使用PO\"><a href=\"#使用PO\" class=\"headerlink\" title=\"使用PO\"></a>使用PO</h5><p>使用PO进行接收结果集时，考虑到数据库中的列名可能与po中的字段名不一致，需要为每个字段起别名，sql写起来就变长了很多</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUser&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;User&quot;</span>&gt;</span></span><br><span class=\"line\">  select user_id as id,user_name as userName,</span><br><span class=\"line\">  from user where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"ResultMap\"><a href=\"#ResultMap\" class=\"headerlink\" title=\"ResultMap\"></a>ResultMap</h4><p>由于在使用ResultType时有一些的问题，而且ResultType对于一些复杂的查询结果来说处理起来也并不友好，ResultMap自定义映射的好处就凸显出来了。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;user&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.User&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">         id定义主键</span></span><br><span class=\"line\"><span class=\"comment\">             column 指定数据库的列名</span></span><br><span class=\"line\"><span class=\"comment\">             property 指定java的属性名</span></span><br><span class=\"line\"><span class=\"comment\">     --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 普通的列 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;account&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;account&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUserReturnResultMap&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;user&quot;</span>&gt;</span></span><br><span class=\"line\">     select * from `user` where id = #&#123;id&#125;</span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"关联查询一对一\"><a href=\"#关联查询一对一\" class=\"headerlink\" title=\"关联查询一对一\"></a>关联查询一对一</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Employee</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer id;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">double</span> salary;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Department department;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Department</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Integer id;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"级联属性封装\"><a href=\"#级联属性封装\" class=\"headerlink\" title=\"级联属性封装\"></a>级联属性封装</h6><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 级联查询 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;emp1&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.Employee&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;salary&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;salary&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- 使用属性.属性来获取 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;did&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;department.id&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;dname&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;department.name&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getEmpAndDep&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;emp1&quot;</span>&gt;</span></span><br><span class=\"line\">    select emp.id id,emp.name name,emp.salary salary,emp.dep_id did,dep.name dname from employee emp join department dep on  emp.dep_id = dep.id</span><br><span class=\"line\">    where emp.id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"使用association进行join查询\"><a href=\"#使用association进行join查询\" class=\"headerlink\" title=\"使用association进行join查询\"></a>使用association进行join查询</h6><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;emp2&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.Employee&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;salary&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;salary&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 指定该字段的类型 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">association</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;department&quot;</span> <span class=\"attr\">javaType</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.Department&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;did&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;dname&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">association</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getEmpAndDep&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;emp2&quot;</span>&gt;</span></span><br><span class=\"line\">        select emp.id id,emp.name name,emp.salary salary,emp.dep_id did,dep.name dname from employee emp join department dep on  emp.dep_id = dep.id</span><br><span class=\"line\">        where emp.id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h6 id=\"使用association进行分步查询\"><a href=\"#使用association进行分步查询\" class=\"headerlink\" title=\"使用association进行分步查询\"></a>使用association进行分步查询</h6><p>使用分步查询会执行多条sql语句，先查询出主表，之后将关联列作为条件去查询字表信息</p>\n<p>EmployeeMapper的映射文件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;emp3&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.Employee&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;salary&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;salary&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- select 当前属性使用select调用的方法</span></span><br><span class=\"line\"><span class=\"comment\">         column 指定将那一列的值作为参数传入select语句</span></span><br><span class=\"line\"><span class=\"comment\">        --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">association</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;department&quot;</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;dep_id&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">                 <span class=\"attr\">select</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.mapper.DepartmentMapper.selectDepById&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;did&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;dname&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">association</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getEmpAndDep&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;emp3&quot;</span>&gt;</span></span><br><span class=\"line\">      select * from employee where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>DepartmentMapper的映射文件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;dep&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.Department&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectDepById&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;dep&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from department where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>分步查询延迟加载</strong></p>\n<p>在使用子表信息的时候在进行查询</p>\n<p>在全局配置中开启延迟加载</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">settings</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">setting</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;logImpl&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;STDOUT_LOGGING&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。 特定关联关系中可通过设置 fetchType 属性来覆盖该项的开关状态。 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">setting</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;lazyLoadingEnabled&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 开启时，任一方法的调用都会加载该对象的所有延迟加载属性。 否则，每个延迟加载属性会按需加载 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">setting</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;aggressiveLazyLoading&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;false&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"关联查询一对多\"><a href=\"#关联查询一对多\" class=\"headerlink\" title=\"关联查询一对多\"></a>关联查询一对多</h4><p>使用collection标签</p>\n<p>DepartmentMapper的映射文件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;dep1&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.Department&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- select 当前属性使用select调用的方法</span></span><br><span class=\"line\"><span class=\"comment\">         column 指定将那一列的值作为参数传入select语句(如果需要多个条件使用&#123;key1=value1,key2=value2&#125;)</span></span><br><span class=\"line\"><span class=\"comment\">        --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">collection</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;employeeList&quot;</span> <span class=\"attr\">select</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.mapper.EmployeeMapper.getEmployeeByDid&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;salary&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;salary&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;did&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;department.id&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">collection</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getDepAndEmps&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;dep1&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from department where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>EmployeeMapper的映射文件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;emp&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.Employee&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">id</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;id&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;name&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span> <span class=\"attr\">column</span>=<span class=\"string\">&quot;salary&quot;</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;salary&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getEmployeeByDid&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;emp&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from employee where dep_id = #&#123;did&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis缓存机制","url":"/2021/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E7%BC%93%E5%AD%98/","content":"<h2 id=\"mybatis缓存机制\"><a href=\"#mybatis缓存机制\" class=\"headerlink\" title=\"mybatis缓存机制\"></a>mybatis缓存机制</h2><p>mybatis包含缓存机制，恶意方便的配置和定制。</p>\n<p>默认定义了一级缓存和二级缓存。</p>\n<ul>\n<li>默认情况下，只有一级缓存开启(sqlSession级别的缓存，也称本地缓存)</li>\n<li>二级缓存需要手动开启和配置，是基于namespace级别的缓存(全局缓存)</li>\n<li>为了提高扩展性。Mybatis定义了缓存接口Cache，可以通过实现Cache接口来自定义二级缓存</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"一级缓存\"><a href=\"#一级缓存\" class=\"headerlink\" title=\"一级缓存\"></a>一级缓存</h3><p>与数据库同义词会话期间查询到的数据会放在本地缓存中，以后获取相同的数据，只需要从缓存中取，没必要查数据库</p>\n<h4 id=\"一级缓存失效的情况\"><a href=\"#一级缓存失效的情况\" class=\"headerlink\" title=\"一级缓存失效的情况\"></a>一级缓存失效的情况</h4><ul>\n<li>sqlSession不同</li>\n<li>sqlSession相同，查询条件不同(此时该数据在一级缓存中还没有)</li>\n<li>sqlSession相同，但是在两次查询之间执行了增删改操作(这次增删改可能会对当前数据有影响)</li>\n<li>sqlSession相同，手动清除了一级缓存 session.clearCache()</li>\n</ul>\n<h3 id=\"二级缓存\"><a href=\"#二级缓存\" class=\"headerlink\" title=\"二级缓存\"></a>二级缓存</h3><p>一个namespace对应一个二级缓存，不同namespace查出的数据会放在不同的map中</p>\n<p>开启二级缓存后，会使用CacheExecutor来装饰Executor，在查询数据时，先查询二级缓存，二级缓存没有再去查一级缓存</p>\n<h4 id=\"二级缓存的使用\"><a href=\"#二级缓存的使用\" class=\"headerlink\" title=\"二级缓存的使用\"></a>二级缓存的使用</h4><p>开启全局二级缓存配置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">settings</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 开启二级缓存，默认为true --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">setting</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;cacheEnabled&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>在映射文件中配置使用二级缓存</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    eviction: 缓存回收策略</span></span><br><span class=\"line\"><span class=\"comment\">        - LRU  最近最少使用：移除最长时间不被使用的，默认</span></span><br><span class=\"line\"><span class=\"comment\">        - FIFO  先进先出，按照对象进入缓存的顺序移除</span></span><br><span class=\"line\"><span class=\"comment\">        - SOFT  软引用，移除基于垃圾回收器状态和软引用规则的对象</span></span><br><span class=\"line\"><span class=\"comment\">        - WEAK  弱引用，积极地移除基于垃圾收集器状态和弱引用规则的对象</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">     flushInterval: 缓存刷新间隔</span></span><br><span class=\"line\"><span class=\"comment\">        缓存多长时间清空一次，默认不清空，单位毫秒</span></span><br><span class=\"line\"><span class=\"comment\">     readOnly   默认false</span></span><br><span class=\"line\"><span class=\"comment\">        - true  只读，mybatis认为所有从缓存中获取数据的操作都是只读操作，不会修改数据。mybatis为了加快获取速度，</span></span><br><span class=\"line\"><span class=\"comment\">                直接将数据在缓存中的引用交给用户，速度快，但是不安全</span></span><br><span class=\"line\"><span class=\"comment\">        - false 非只读，mybatis会认为获取到的数据可能会被修改，会利用序列化和反序列化机制克隆一份新的数据</span></span><br><span class=\"line\"><span class=\"comment\">     size： 缓存多少元素</span></span><br><span class=\"line\"><span class=\"comment\">     type： 指定自定义缓存的全类名，需要实现Cache接口</span></span><br><span class=\"line\"><span class=\"comment\">         blocking: 若缓存中找不到对应的key，是否会一直阻塞，知道对应的数据进入缓存</span></span><br><span class=\"line\"><span class=\"comment\"> --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">cache</span> <span class=\"attr\">eviction</span>=<span class=\"string\">&quot;FIFO&quot;</span> <span class=\"attr\">flushInterval</span>=<span class=\"string\">&quot;60000&quot;</span> <span class=\"attr\">readOnly</span>=<span class=\"string\">&quot;true&quot;</span> <span class=\"attr\">size</span>=<span class=\"string\">&quot;1024&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>由于可能会用到序列化和反序列化，所以使用缓存的对象要实现序列化接口(readOnly为false的时候需要用到序列化和反序列化)</p>\n<p>否则会报java.io.NotSerializableException异常</p>\n<blockquote>\n<p>注意：一定要在同一个sqlSessionFactory下的不同sqlSession下使用二级缓存，如果为不同的sqlSessionFactory，永远不可能命中二级缓存的(我测试的时候就犯糊涂了，找了半天配置的问题才反应过来)</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Test</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">testTwoLevelCache</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    SqlSession session = sqlSessionFactory.openSession();</span><br><span class=\"line\">    <span class=\"comment\">// mybatis为接口创建代理对象</span></span><br><span class=\"line\">    UserMapper userMapper = session.getMapper(UserMapper.class);</span><br><span class=\"line\">    User user = userMapper.selectUser(<span class=\"number\">8</span>);</span><br><span class=\"line\">    System.out.println(user);</span><br><span class=\"line\">    userMapper.updateUser(user);</span><br><span class=\"line\">    session.close();</span><br><span class=\"line\">    SqlSession session1 = sqlSessionFactory.openSession();</span><br><span class=\"line\"></span><br><span class=\"line\">    UserMapper userMapper1 = session1.getMapper(UserMapper.class);</span><br><span class=\"line\">    User user1 = userMapper1.selectUser(<span class=\"number\">8</span>);</span><br><span class=\"line\">    System.out.println(user1);</span><br><span class=\"line\">    System.out.println(user == user1);</span><br><span class=\"line\"></span><br><span class=\"line\">    session1.close();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"二级缓存失效的情况\"><a href=\"#二级缓存失效的情况\" class=\"headerlink\" title=\"二级缓存失效的情况\"></a>二级缓存失效的情况</h4><ul>\n<li>如果第一个sqlSession没有提交，第二个sqlSeesion是无法命中二级缓存中该数据的，(sqlSession提交的时候才会将数据存入到二级缓存)</li>\n<li>两次查询之间包含了增删改操作(在增删改操作时默认会刷新缓存，导致缓存失效)</li>\n</ul>\n<h3 id=\"缓存相关配置总结\"><a href=\"#缓存相关配置总结\" class=\"headerlink\" title=\"缓存相关配置总结\"></a>缓存相关配置总结</h3><ul>\n<li><p>全局配置文件settings中配置 cacheEnabled=true   该配置只影响二级缓存，对于一级缓存没有影响</p>\n</li>\n<li><p>每个select标签都有useCache=”true”  默认为true，该配置只影响二级缓存，对于一级缓存没有影响</p>\n</li>\n<li><p>每个增删改标签都有flushCache=”true”,增删改操作执行后清除缓存，该清除会清除一级和二级缓存，默认true</p>\n<p>如果在select上使用flushCache=”true”，则查询不会使用缓存，默认false</p>\n</li>\n<li><p>sqlSession.clearCache()   只是清除一级缓存，不会清除二级缓存</p>\n</li>\n<li><p>全局配置文件settings中配置localCacheScope 本地缓存作用域(只针对一级缓存)，有两个取值SESSION|STATEMENT，默认是SESSION</p>\n<p>可以使用STATEMENT来禁用一级缓存</p>\n</li>\n</ul>\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"动态sql","url":"/2021/%E6%A1%86%E6%9E%B6/mybatis/%E5%8A%A8%E6%80%81sql/","content":"<h2 id=\"动态sql\"><a href=\"#动态sql\" class=\"headerlink\" title=\"动态sql\"></a>动态sql</h2><p>在写sql语句时如果使用语句拼接，根据不同的参数组织不同的语句，经常出现少或多一个and，缺少空格，最后出现逗号等问题，mybatis通过动态sql来解决这些问题。</p>\n<p>mybatis中包含有if、choose、when、otherwise、trim、where、set、foreach等标签</p>\n<p>动态sql中的表达式使用的是OGNL表达式</p>\n<a id=\"more\"></a>\n\n<h3 id=\"if标签\"><a href=\"#if标签\" class=\"headerlink\" title=\"if标签\"></a>if标签</h3><p>使用if标签来判断是否符合该条件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 使用动态sql  测试if标签 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getEmployeeByConditon&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;emp&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from employee where id = #&#123;id&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;name != null and name!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class=\"line\">            and name like #&#123;name&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;salary != null and salary != 0&quot;</span>&gt;</span></span><br><span class=\"line\">            and name = #&#123;salary&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"where标签\"><a href=\"#where标签\" class=\"headerlink\" title=\"where标签\"></a>where标签</h3><p>有时后续一个条件都没有，将不需要使用where条件，此时SQL就变成了</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> employee <span class=\"keyword\">where</span></span><br></pre></td></tr></table></figure>\n\n<p>出现这种情况有两种方式解决</p>\n<ul>\n<li>可以使用1=1条件</li>\n<li>可以使用where标签，where会将where标签中拼接的sql中开头多出来的and或者or去掉</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 使用动态sql  测试if和where标签 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getEmployeeByCondition&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;emp&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from employee</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;id != null and id != 0&quot;</span>&gt;</span></span><br><span class=\"line\">            and id = #&#123;id&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;name != null and name!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class=\"line\">            and name like #&#123;name&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;salary != null and salary != 0&quot;</span>&gt;</span></span><br><span class=\"line\">            and salary = #&#123;salary&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"trim标签\"><a href=\"#trim标签\" class=\"headerlink\" title=\"trim标签\"></a>trim标签</h3><p>由于where只会去除开头的and或or，有时使用where元素与预期不符，此时可以使用trim标签</p>\n<p>trim标签有几个子元素prefix/prefixOverrides/suffixOverrides</p>\n<ul>\n<li>prefix  前缀，trim标签体中是整个字符串拼接后的结果，prefix给拼串后的整个字符串加一个前缀</li>\n<li>prefixOverrides  前缀覆盖，去掉整个字符串中前面多余的字符</li>\n<li>suffix 后缀，在整个字符串后加一个后缀</li>\n<li>suffixOverrides 后缀覆盖，去掉整个字符串中后面多余的字符</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getEmployeeByCondition&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;emp&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from employee</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">trim</span> <span class=\"attr\">prefix</span>=<span class=\"string\">&quot;where&quot;</span> <span class=\"attr\">suffixOverrides</span>=<span class=\"string\">&quot;and | or&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;id != null and id != 0&quot;</span>&gt;</span></span><br><span class=\"line\">            id = #&#123;id&#125; and</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;name != null and name!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class=\"line\">            name like #&#123;name&#125; and</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;salary != null and salary != 0&quot;</span>&gt;</span></span><br><span class=\"line\">            salary = #&#123;salary&#125; and</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">trim</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"choose标签\"><a href=\"#choose标签\" class=\"headerlink\" title=\"choose标签\"></a>choose标签</h3><p>choose与when和otherwise组合使用，分支选择，相当于switch-case，只会进入一个分支</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;getEmployeeByConditionChoose&quot;</span> <span class=\"attr\">resultMap</span>=<span class=\"string\">&quot;emp&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from employee</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">trim</span> <span class=\"attr\">prefix</span>=<span class=\"string\">&quot;where&quot;</span> <span class=\"attr\">suffixOverrides</span>=<span class=\"string\">&quot;and | or&quot;</span> <span class=\"attr\">prefixOverrides</span>=<span class=\"string\">&quot;and | or&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 有id时用id查，有name时用name查，否则查询所有 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">choose</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">when</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;id != null and id != 0&quot;</span>&gt;</span></span><br><span class=\"line\">                id = #&#123;id&#125; and</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">when</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">when</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;name != null and name!=&#x27;&#x27;&quot;</span>&gt;</span></span><br><span class=\"line\">                name like #&#123;name&#125; and</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">when</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">otherwise</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">otherwise</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">choose</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">trim</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"set标签\"><a href=\"#set标签\" class=\"headerlink\" title=\"set标签\"></a>set标签</h3><p>set标签用于动态更新，只更新需要更新的列，忽略其他不更新的列，set元素会在字符串开头添加set，并且会删除掉额外的逗号</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">update</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;updateEmployeeBySet&quot;</span>&gt;</span></span><br><span class=\"line\">    update employee</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">set</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class=\"line\">            name = #&#123;name&#125;,</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;salary != null and salary != 0&quot;</span>&gt;</span></span><br><span class=\"line\">            salary = #&#123;salary&#125;,</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">set</span>&gt;</span></span><br><span class=\"line\">    where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">update</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>也可以使用trim来实现</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">update</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;updateEmployeeBySet&quot;</span>&gt;</span></span><br><span class=\"line\">    update employee</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">trim</span> <span class=\"attr\">prifix</span>=<span class=\"string\">&quot;set&quot;</span> <span class=\"attr\">suffixOverrides</span>=<span class=\"string\">&quot;,&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span><br><span class=\"line\">            name = #&#123;name&#125;,</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;salary != null and salary != 0&quot;</span>&gt;</span></span><br><span class=\"line\">            salary = #&#123;salary&#125;,</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">trim</span>&gt;</span></span><br><span class=\"line\">    where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">update</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"foreach标签\"><a href=\"#foreach标签\" class=\"headerlink\" title=\"foreach标签\"></a>foreach标签</h3><p>使用foreach标签来进行对集合的遍历</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectByIds&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;User&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from user</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">        id in</span><br><span class=\"line\">          <span class=\"comment\">&lt;!-- collection:指定遍历的集合  list类型参数会特殊封装到map中，key为list</span></span><br><span class=\"line\"><span class=\"comment\">                          item: 将当前遍历出的元素赋值给指定的变量</span></span><br><span class=\"line\"><span class=\"comment\">                         separator: 每个元素之间的分隔符</span></span><br><span class=\"line\"><span class=\"comment\">                         open: 遍历所有结果拼接一个开始的字符</span></span><br><span class=\"line\"><span class=\"comment\">                         close: 遍历所有结果拼接一个结束的字符</span></span><br><span class=\"line\"><span class=\"comment\">                       index: 索引。遍历list的时候，index是索引，item是当前值；遍历map的时候，index是map的key，item是map的值</span></span><br><span class=\"line\"><span class=\"comment\">                --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">foreach</span> <span class=\"attr\">collection</span>=<span class=\"string\">&quot;list&quot;</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;index&quot;</span> <span class=\"attr\">item</span>=<span class=\"string\">&quot;item&quot;</span> <span class=\"attr\">open</span>=<span class=\"string\">&quot;(&quot;</span> <span class=\"attr\">separator</span>=<span class=\"string\">&quot;,&quot;</span> <span class=\"attr\">close</span>=<span class=\"string\">&quot;)&quot;</span>&gt;</span></span><br><span class=\"line\">            #&#123;item&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">foreach</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"内置参数\"><a href=\"#内置参数\" class=\"headerlink\" title=\"内置参数\"></a>内置参数</h3><p>mybatis包含两个内置参数</p>\n<ul>\n<li>_parameter：代表整个参数。单个参数时，_parameter就是这个参数;多个参数时，参数会被封装为一个map，_parameter代表这个map</li>\n<li>_databaseId:如果配置了databaseIdProvider标签，_databaseId就是代表当前数据库的别名</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUserByCondition&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;User&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from user</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;_parameter != null&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;id != null and id != 0&quot;</span>&gt;</span></span><br><span class=\"line\">                and id = #&#123;_parameter.id&#125;</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;name != null&quot;</span>&gt;</span></span><br><span class=\"line\">                and name = #&#123;_parameter.name&#125;</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;account != null and account != 0&quot;</span>&gt;</span></span><br><span class=\"line\">                and account = #&#123;_parameter.account&#125;</span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"bind绑定\"><a href=\"#bind绑定\" class=\"headerlink\" title=\"bind绑定\"></a>bind绑定</h3><p>bind可以将OGNL表达式的值绑定到一个变量中，并将其绑定到当前上下文，方便后来引用这个变量的值</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUserByCondition&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;User&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from user</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;id != null and id != 0&quot;</span>&gt;</span></span><br><span class=\"line\">            and id = #&#123;id&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;name != null&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">bind</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;_name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;&#x27;%&#x27;+name+&#x27;%&#x27;&quot;</span>/&gt;</span></span><br><span class=\"line\">            and name like #&#123;_name&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">if</span> <span class=\"attr\">test</span>=<span class=\"string\">&quot;account != null and account != 0&quot;</span>&gt;</span></span><br><span class=\"line\">            and account = #&#123;account&#125;</span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">if</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">where</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"sql标签\"><a href=\"#sql标签\" class=\"headerlink\" title=\"sql标签\"></a>sql标签</h3><p>sql标签用于抽取可重用的sql片段，使用include标签来引用sql标签</p>\n<ul>\n<li>经常将查询的列名和插入的列名抽取出来</li>\n<li>include来引用抽取的sql</li>\n<li>include还可以自定义一些property，sql标签内部可以使用自定义的属性，使用${属性名}来取自定义的属性</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">sql</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;insertColumn&quot;</span>&gt;</span></span><br><span class=\"line\">    `name`,account</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">sql</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">insert</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;addUser&quot;</span>&gt;</span></span><br><span class=\"line\">  insert into `user` (</span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">include</span> <span class=\"attr\">refid</span>=<span class=\"string\">&quot;insertColumn&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">include</span>&gt;</span></span><br><span class=\"line\">  )</span><br><span class=\"line\">  values (#&#123;name&#125;,#&#123;account&#125;)</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"Spring AOP","url":"/2020/%E6%A1%86%E6%9E%B6/spring/Spring%20AOP/","content":"<p>AOP称为切面编程，是面向对象的一种补充，用于处理系统中分布于各个模块的横切关注点，比如事务管理、日志、缓存等。Spring AOP中使用的是动态代理。</p>\n<a id=\"more\"></a>\n\n<h2 id=\"Spring-AOP\"><a href=\"#Spring-AOP\" class=\"headerlink\" title=\"Spring AOP\"></a>Spring AOP</h2><p>动态代理不会去修改字节码，而是在内存中临时为方法生成一个AOP对象，这个AOP对象包含了目标对象的全部方法，并且在特定的切点做了增强处理，并回调原对象的方法。</p>\n<p>AOP的核心是切面，它将多个类的通用行为封装成可重用的模块，该模块含有一组API提供横切的功能，在SpringAOP中，切面通过@Aspect注解，也可以使用XML配置</p>\n<h3 id=\"AOP动态代理方式\"><a href=\"#AOP动态代理方式\" class=\"headerlink\" title=\"AOP动态代理方式\"></a>AOP动态代理方式</h3><p>Spring AOP中动态代理主要有两种方式，JDK动态代理和CGLIB动态代理。</p>\n<h4 id=\"JDK动态代理\"><a href=\"#JDK动态代理\" class=\"headerlink\" title=\"JDK动态代理\"></a>JDK动态代理</h4><p>JDK动态代理通过反射来接收被代理的类，并且要求被代理的类必须实现一个接口，JDK代理的核心是InvocationHandler接口和Proxy类。</p>\n<h4 id=\"CGLIB代理\"><a href=\"#CGLIB代理\" class=\"headerlink\" title=\"CGLIB代理\"></a>CGLIB代理</h4><p>如果目标类没有实现接口，那么Spring AOP会使用CGLIB代理来动态代理目标类。CGLIB是一个代码生成的类库，可以在运行时动态的生成某个类的子类(通过继承的方式做的动态代理，如果某个类被标记为final，无法使用CGLIB做动态代理)</p>\n<h3 id=\"AOP中的概念\"><a href=\"#AOP中的概念\" class=\"headerlink\" title=\"AOP中的概念\"></a>AOP中的概念</h3><ul>\n<li>横切关注点  从每个方法中抽取出来的非核心业务</li>\n<li>切面(Aspect) 封装横切关注点的类，被模块化的特殊对象，每个关注点体现为一个通知</li>\n<li>通知(Advice)  切面需要完成的各个具体工作</li>\n<li>目标(Target)  被通知的对象</li>\n<li>代理(Proxy)  向目标对象应用通知之后创建的对象</li>\n<li>连接点(Joinpoint)  横切关注点的具体体现，程序执行的某个特定位置：比如调用前、调用后、抛出异常后</li>\n<li>切点(pointCut)  每个类都有多个连接点，AOP通过切点来定位到特定的连接点</li>\n</ul>\n<p>有五种类型的AOP通知</p>\n<ul>\n<li><p>before  前置通知，在方法执行之前被调用 @Before</p>\n</li>\n<li><p>after     后置通知，在方法执行之后调用，无论方法执行是否成功，所以后置通知无法获取到返回结果@After</p>\n</li>\n<li><p>after-returning  仅当方法成功完成后执行@AfterReturning</p>\n</li>\n<li><p>after-throwing  在方法抛出异常退出时执行@AfterThrowing</p>\n</li>\n<li><p>around  在方法执行之前和之后调用@Around</p>\n</li>\n</ul>\n<h3 id=\"AOP使用方式\"><a href=\"#AOP使用方式\" class=\"headerlink\" title=\"AOP使用方式\"></a>AOP使用方式</h3><p>AOP所需要的依赖</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-aop<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- aspect --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-aspects<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用注解\"><a href=\"#使用注解\" class=\"headerlink\" title=\"使用注解\"></a>使用注解</h4><p>使用注解的时候需要在xml中配置<a href=\"aop:aspectj-autoproxy/\">aop:aspectj-autoproxy/</a></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 使@Aspect注解生效 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">aop:aspectj-autoproxy</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 声明切面</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"meta\">@Aspect</span></span><br><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"meta\">@Order(1)</span><span class=\"comment\">// 使用Order指定切面优先级  数字越小  优先级越高  越先执行</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LoggingAspect</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// @Before  前置通知</span></span><br><span class=\"line\">    <span class=\"comment\">// JoinPoint 可以获取到方法的一些信息</span></span><br><span class=\"line\">    <span class=\"meta\">@Before(&quot;execution(public String com.zhanghe.study.spring4.beans.aoptest.MyInterface.log(..))&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">before</span><span class=\"params\">(JoinPoint point)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 获取方法名</span></span><br><span class=\"line\">        String methodName = point.getSignature().getName();</span><br><span class=\"line\">        <span class=\"comment\">// point.getArgs()获取参数</span></span><br><span class=\"line\">        System.out.println(methodName+<span class=\"string\">&quot;方法执行前,参数为&quot;</span>+ Arrays.toString(point.getArgs()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 方法正常执行完，可以获取方法返回值</span></span><br><span class=\"line\">    <span class=\"comment\">// returning中配置的名字必须与第二个参数同名</span></span><br><span class=\"line\">    <span class=\"meta\">@AfterReturning(value=&quot;execution(public String com.zhanghe.study.spring4.beans.aoptest.MyInterface.log(..))&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">            returning = &quot;result&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">afterReturn</span><span class=\"params\">(JoinPoint point,Object result)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 获取方法名</span></span><br><span class=\"line\">        String methodName = point.getSignature().getName();</span><br><span class=\"line\">        System.out.println(methodName+<span class=\"string\">&quot;方法执行完成,结果为&quot;</span>+ result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 方法出现异常</span></span><br><span class=\"line\">    <span class=\"comment\">// throwing中配置的名字必须与第二个参数同名，且可以指定对于哪些异常进行执行  第二个参数类型可以为所要捕获的异常类型</span></span><br><span class=\"line\">    <span class=\"meta\">@AfterThrowing(value=&quot;execution(public String com.zhanghe.study.spring4.beans.aoptest.MyInterface.log(..))&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">            throwing = &quot;exception&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">afterThrowing</span><span class=\"params\">(JoinPoint point,Exception exception)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 获取方法名</span></span><br><span class=\"line\">        String methodName = point.getSignature().getName();</span><br><span class=\"line\">        System.out.println(methodName+<span class=\"string\">&quot;方法执行出现异常,异常信息为&quot;</span>+ exception.getMessage());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>在使用切面的时候必须保证切面是Spring IOC容器中的bean</p>\n</blockquote>\n<h4 id=\"使用XML\"><a href=\"#使用XML\" class=\"headerlink\" title=\"使用XML\"></a>使用XML</h4><p>所有的aop配置都应该配置在&lt;aop:config&gt;标签中，在xml中只需要关注切面、通知以及切入点表达式</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- LoggingAspect所对应的bean --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;loggingAspect&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.aoptest.LoggingAspect&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 配置AOP --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">aop:config</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 配置切点表达式 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">aop:pointcut</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;pointcut&quot;</span> <span class=\"attr\">expression</span>=<span class=\"string\">&quot;execution(public String com.zhanghe.study.spring4.beans.aoptest.MyInterface.log(..)))&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 配置切面及通知 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">aop:aspect</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;loggingAspect&quot;</span> <span class=\"attr\">order</span>=<span class=\"string\">&quot;1&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 通知 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:before</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;before&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:after-returning</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;afterReturn&quot;</span> <span class=\"attr\">returning</span>=<span class=\"string\">&quot;result&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:after-throwing</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;afterThrowing&quot;</span> <span class=\"attr\">throwing</span>=<span class=\"string\">&quot;exception&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">aop:aspect</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意：使用xml的模式进行配置记得保证切面是Spring IOC容器中的bean</p>\n</blockquote>\n","categories":["spring"],"tags":["spring"]},{"title":"spring事务","url":"/2021/%E6%A1%86%E6%9E%B6/spring/Spring%E4%BA%8B%E5%8A%A1/","content":"<h2 id=\"spring事务\"><a href=\"#spring事务\" class=\"headerlink\" title=\"spring事务\"></a>spring事务</h2><h3 id=\"事务介绍\"><a href=\"#事务介绍\" class=\"headerlink\" title=\"事务介绍\"></a>事务介绍</h3><p>一个事务要么同时成功，要么同时失败</p>\n<h4 id=\"特性\"><a href=\"#特性\" class=\"headerlink\" title=\"特性\"></a>特性</h4><ul>\n<li><p>Atomic原子性  事务是由一个或多个活动组成的一个工作单元。原子性确保事务中的所有操作全部发生或全部不发生</p>\n</li>\n<li><p>Consistent一致性  一旦事务完成，系统必须确保它所建模的业务处于一致的状态</p>\n</li>\n<li><p>Isolated隔离性  事务允许多个用户对数据进行操作，每个用户的操作不会与其他用户纠缠在一起</p>\n</li>\n<li><p>Durable持久性  一旦事务完成，事务的结果应该持久化</p>\n</li>\n</ul>\n<a id=\"more\"></a>\n\n<h4 id=\"事务隔离级别\"><a href=\"#事务隔离级别\" class=\"headerlink\" title=\"事务隔离级别\"></a>事务隔离级别</h4><ul>\n<li>DEFAULT  使用底层数据库预设的隔离层级</li>\n<li>READ_UNCOMMITTED (读未提交的数据)  允许事务读取其他并行的事务还没提交的数据，脏读、不可重复读、幻读问题都存在</li>\n<li>READ_COMMITTED(读已提交的数据)  只允许事务读取其他并行事务提交的数据，可以避免脏读，但是不可重复读和幻读仍存在</li>\n<li>REPEATABLE_READ(可重复读)  确保事务可以多次从一个字段中读取相同的值，在这个事务持续期间，禁止其他事务对这个字段进行更新，可以避免脏读和不可重复读，但幻读仍存在(Mysql默认的事务隔离级别)</li>\n<li>SERIALIZABLE(串行化) 确保事务可以从一个表中读取相同的行，在这个事务持续期间，禁止其他事务对该表执行插入、更新和删除操作，所有并发问题都可以避免，但是性能低下</li>\n</ul>\n<h4 id=\"传播行为\"><a href=\"#传播行为\" class=\"headerlink\" title=\"传播行为\"></a>传播行为</h4><ul>\n<li><p>PROPAGATION_REQUIRED  支持当前事务，如果当前没有事务，就新建一个事务</p>\n</li>\n<li><p>PROPAGATION_SUPPORTS  支持当前事务，如果当前没有事务，就以非事务方式执行</p>\n</li>\n<li><p>PROPAGATION_MANDATORY  支持当前事务，如果当前没有事务，就抛出异常</p>\n</li>\n<li><p>PROPAGATION_REQUIRED_NEW  新建事务，如果当前存在事务，把当前事务挂起</p>\n</li>\n<li><p>PROPAGATION_NOT_SUPPORTED  以非事务方式执行操作，如果当前存在事务，就把当前事务挂起</p>\n</li>\n<li><p>PROPAGATION_NEVER  以非事务方式执行操作，如果当前存在事务，则抛出异常</p>\n</li>\n<li><p>PROPAGATION_NESTED  如果当前存在事务，则在嵌套事务内执行，如果当前没有事务，则新建事务</p>\n</li>\n</ul>\n<h4 id=\"只读\"><a href=\"#只读\" class=\"headerlink\" title=\"只读\"></a>只读</h4><p>事务只进行读取操作</p>\n<p>readOnly=true  告诉spring当前事务只会进行读取操作，不会进行修改操作，可以帮助数据库引擎优化</p>\n<blockquote>\n<p>注：如果设置为只读的话，千万不要在事务里修改数据，使用只读操作时，spring不会进行加锁处理，如果修改数据的话，会出现问题</p>\n</blockquote>\n<h4 id=\"事务超时\"><a href=\"#事务超时\" class=\"headerlink\" title=\"事务超时\"></a>事务超时</h4><p>事务时间过长，则回滚</p>\n<h4 id=\"回滚规则\"><a href=\"#回滚规则\" class=\"headerlink\" title=\"回滚规则\"></a>回滚规则</h4><p>rollback-for 指事务对于那些检查型异常应当回滚而不提交(默认spring会对所有的运行时异常回滚)</p>\n<p>no-rollback-for 指事务对于那些异常继续执行不回滚</p>\n<h3 id=\"事务的使用\"><a href=\"#事务的使用\" class=\"headerlink\" title=\"事务的使用\"></a>事务的使用</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">create</span> <span class=\"keyword\">table</span> <span class=\"keyword\">user</span>(</span><br><span class=\"line\">    <span class=\"keyword\">id</span> <span class=\"built_in\">int</span> primary <span class=\"keyword\">key</span> AUTO_INCREMENT,</span><br><span class=\"line\">    <span class=\"keyword\">name</span> <span class=\"built_in\">varchar</span>(<span class=\"number\">20</span>) <span class=\"keyword\">not</span> <span class=\"literal\">null</span>,</span><br><span class=\"line\">    <span class=\"keyword\">account</span> <span class=\"keyword\">double</span> </span><br><span class=\"line\"> )<span class=\"keyword\">ENGINE</span>=<span class=\"keyword\">InnoDB</span> <span class=\"keyword\">DEFAULT</span> <span class=\"keyword\">CHARSET</span>=utf8;</span><br><span class=\"line\"> </span><br><span class=\"line\"> <span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> <span class=\"keyword\">user</span> (<span class=\"keyword\">name</span>,<span class=\"keyword\">account</span>) <span class=\"keyword\">values</span>(<span class=\"string\">&#x27;张三&#x27;</span>,<span class=\"number\">1000</span>);</span><br><span class=\"line\"> <span class=\"keyword\">insert</span> <span class=\"keyword\">into</span> <span class=\"keyword\">user</span> (<span class=\"keyword\">name</span>,<span class=\"keyword\">account</span>) <span class=\"keyword\">values</span>(<span class=\"string\">&#x27;李四&#x27;</span>,<span class=\"number\">1000</span>);</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 事务 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-tx<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 事务管理器以及数据源 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-jdbc<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>4.3.29.RELEASE<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- mysql驱动 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>mysql<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>mysql-connector-java<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>5.1.48<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"使用注解\"><a href=\"#使用注解\" class=\"headerlink\" title=\"使用注解\"></a>使用注解</h4><p>在这里采用的是spring中的数据源</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 数据源 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;driverClassName&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;url&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;jdbc:mysql://localhost:3306/spring?useUnicode=true<span class=\"symbol\">&amp;amp;</span>characterEncoding=utf-8&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;root&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123456&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 事务管理器 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;transactionManager&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 启用事务注解 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tx:annotation-driven</span> <span class=\"attr\">transaction-manager</span>=<span class=\"string\">&quot;transactionManager&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>当然由于是使用的注解，不要忘记组件扫描</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">context:component-scan</span> <span class=\"attr\">base-package</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.tx&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>之后就可以在要保证事务的方法上配置@Transactional以及在该注解上配置相应的事务隔离级别(isolation)、事务传播行为(propagation)、对哪些异常执行回滚(rollbackFor)以及不执行回滚(noRollbackFor)   默认对运行时异常回滚</p>\n<h4 id=\"使用XML\"><a href=\"#使用XML\" class=\"headerlink\" title=\"使用XML\"></a>使用XML</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 数据源 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;driverClassName&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;com.mysql.jdbc.Driver&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;url&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;jdbc:mysql://localhost:3306/spring?useUnicode=true<span class=\"symbol\">&amp;amp;</span>characterEncoding=utf-8&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;root&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123456&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 事务管理器 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;transactionManager&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;dataSource&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 使用xml配置事务属性 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">tx:advice</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;txAdvice&quot;</span>  <span class=\"attr\">transaction-manager</span>=<span class=\"string\">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 根据方法名指定特定的事务属性 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;get*&quot;</span> <span class=\"attr\">read-only</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;find*&quot;</span> <span class=\"attr\">read-only</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">tx:method</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;save*&quot;</span> <span class=\"attr\">propagation</span>=<span class=\"string\">&quot;REQUIRED&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">tx:attributes</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">tx:advice</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 使用事务切入点，把事务切入点和事务属性关联起来 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">aop:config</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:pointcut</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;pointCut&quot;</span> <span class=\"attr\">expression</span>=<span class=\"string\">&quot;execution(* com.zhanghe.study.spring4.beans.tx.UserService.*(..))&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">aop:advisor</span> <span class=\"attr\">advice-ref</span>=<span class=\"string\">&quot;txAdvice&quot;</span> <span class=\"attr\">pointcut-ref</span>=<span class=\"string\">&quot;pointCut&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["spring"],"tags":["spring"]},{"title":"bean的生命周期","url":"/2021/%E6%A1%86%E6%9E%B6/spring/bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/","content":"<h2 id=\"bean的生命周期\"><a href=\"#bean的生命周期\" class=\"headerlink\" title=\"bean的生命周期\"></a>bean的生命周期</h2><ul>\n<li>bean的构造</li>\n<li>调用set方法设置Bean的属性</li>\n<li>调用BeanNameAware的setBeanName()方法</li>\n<li>调用BeanFactoryAware的setBeanFactory()方法</li>\n<li>调用BeanPostProcessor的postProcessBeforeInitialization()方法</li>\n<li>调用InitializingBean的afterPropertiesSet()方法，需要bean实现InitializingBean</li>\n<li>调用自定义的初始化方法（init-method属性指定该方法）</li>\n<li>调用BeanPostProcessor类的postProcessAfterInitialization()方法</li>\n<li>调用DisposableBean的destory()方法，需要bean实现DisposableBean</li>\n<li>调用自定义的销毁方法（destory-method属性指定该方法）</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"bean的后置处理器\"><a href=\"#bean的后置处理器\" class=\"headerlink\" title=\"bean的后置处理器\"></a>bean的后置处理器</h3><p>spring提供了两种后置处理器</p>\n<ul>\n<li>Bean后置处理器  对容器中Bean进行后处理，对Bean进行额外加强</li>\n<li>容器后置处理器  对IOC容器进行处理，增强容器功能</li>\n</ul>\n<h4 id=\"Bean后置处理器\"><a href=\"#Bean后置处理器\" class=\"headerlink\" title=\"Bean后置处理器\"></a>Bean后置处理器</h4><p>Bean后置处理器是一种特殊的Bean，这种特殊的Bean并不对外服务，主要负责对容器中的其他Bean执行后处理，例如容器中的目标Bean生成代理等。Bean后处理器会在Bean实例创建成功后，为Bean实例进行进一步的增强处理。实现BeanPostProcessor接口，实现postProcessAfterInitialization和postProcessBeforeInitialization方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyProcessor</span> <span class=\"keyword\">implements</span> <span class=\"title\">BeanPostProcessor</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 初始化之前</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> o</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> s</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> BeansException</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">postProcessBeforeInitialization</span><span class=\"params\">(Object o, String s)</span> <span class=\"keyword\">throws</span> BeansException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(o <span class=\"keyword\">instanceof</span> Connection)&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;初始化之前&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> o;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 初始化之后</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> o</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> s</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> BeansException</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">postProcessAfterInitialization</span><span class=\"params\">(Object o, String s)</span> <span class=\"keyword\">throws</span> BeansException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(o <span class=\"keyword\">instanceof</span> Connection)&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;初始化之后&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> o;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里处理完之后一定要将bean返回回去，否则后续无法获取到bean</p>\n</blockquote>\n<p>注：如果使用BeanFactory作为Spring容器，则必须手动注册Bean后置处理器，程序必须获取Bean后置处理器实例，然后手动注册。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">BeanPostProcessor bp = (BeanPostProcessor)beanFactory.getBean(<span class=\"string\">&quot;bp&quot;</span>);</span><br><span class=\"line\">beanFactory.addBeanPostProcessor(bp);</span><br><span class=\"line\">Person p = (Person)beanFactory.getBean(<span class=\"string\">&quot;person&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"容器后置处理器\"><a href=\"#容器后置处理器\" class=\"headerlink\" title=\"容器后置处理器\"></a>容器后置处理器</h4><p>容器后置处理器负责容器本身，实现BeanFactoryPostProcessor接口，实现接口的postProcessBeanFactory方法对Spring容器进行处理，可以对Spring容器进行自定义扩展，</p>\n<p>在BeanFactory标准初始化之后调用，即所有的BeanDefinition已经保存加载到beanFactory中，但是bean的实例还未创建</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">BeanFactoryPostProcessor</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">postProcessBeanFactory</span><span class=\"params\">(ConfigurableListableBeanFactory beanFactory)</span> <span class=\"keyword\">throws</span> BeansException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":["spring"],"tags":["spring"]},{"title":"bean的继承和依赖","url":"/2021/%E6%A1%86%E6%9E%B6/spring/bean%E7%9A%84%E7%BB%A7%E6%89%BF%E5%92%8C%E4%BE%9D%E8%B5%96/","content":"<h2 id=\"bean的继承和依赖\"><a href=\"#bean的继承和依赖\" class=\"headerlink\" title=\"bean的继承和依赖\"></a>bean的继承和依赖</h2><p>spring除了提供了一般的配置bean的方式之外，还实现了java中继承的特性，设置bean的父子关系，这样对于一些重复的配置就可以进行省略</p>\n<a id=\"more\"></a>\n\n<h3 id=\"bean的继承\"><a href=\"#bean的继承\" class=\"headerlink\" title=\"bean的继承\"></a>bean的继承</h3><p>配置bean的父子关系，父bean有的东西，子bean全部继承过来，不一样的进行覆盖</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- bean的继承关系 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;parent&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Person&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;张三&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;car&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;cars&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">bean</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">bean</span>=<span class=\"string\">&quot;car2&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;carMap&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">map</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">entry</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;AA&quot;</span> <span class=\"attr\">value-ref</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">entry</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;BB&quot;</span> <span class=\"attr\">value-ref</span>=<span class=\"string\">&quot;car2&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">map</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 使用parent属性可以继承对应bean的所有属性 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;son&quot;</span> <span class=\"attr\">parent</span>=<span class=\"string\">&quot;person&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;张飞&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"抽象bean\"><a href=\"#抽象bean\" class=\"headerlink\" title=\"抽象bean\"></a>抽象bean</h4><p>既然spring提供了继承，那么也就存在了专门用于被继承的bean，而不进行实例化，这种bean被称为抽象bean，使用abstract=”true”表明这是一个抽象bean</p>\n<p>由于抽象bean不进行实例化，所以抽象bean的class属性是没有意义的，可以省略不写</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 抽象bean，不可被实例化--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;abstract&quot;</span> <span class=\"attr\">abstract</span>=<span class=\"string\">&quot;true&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;张三&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;car&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;cars&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">bean</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">bean</span>=<span class=\"string\">&quot;car2&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;carMap&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">map</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">entry</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;AA&quot;</span> <span class=\"attr\">value-ref</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">entry</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;BB&quot;</span> <span class=\"attr\">value-ref</span>=<span class=\"string\">&quot;car2&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">map</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 使用parent属性可以继承对应bean的所有属性 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;personSon&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Person&quot;</span> <span class=\"attr\">parent</span>=<span class=\"string\">&quot;abstract&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;张飞&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意：抽象bean是不可以被实例化的，也就是说不可以使用上下文强制的获取该bean，否则会报错</p>\n<p>org.springframework.beans.factory.BeanIsAbstractException: Error creating bean with name ‘abstract’: Bean definition is abstract</p>\n</blockquote>\n<h3 id=\"bean的依赖\"><a href=\"#bean的依赖\" class=\"headerlink\" title=\"bean的依赖\"></a>bean的依赖</h3><p>有时候需要保证bean实例化的先后顺序，在创建一个bean的时候必须保证另外一个bean也被创建，如果另一个bean不存在，则无法正常实例化该bean</p>\n<p>可以使用depends-on来实现bean之间的依赖关系</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 依赖关系 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;person2&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Person&quot;</span> <span class=\"attr\">parent</span>=<span class=\"string\">&quot;abstract&quot;</span> <span class=\"attr\">depends-on</span>=<span class=\"string\">&quot;depend1&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;关羽&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;depend1&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Person&quot;</span> <span class=\"attr\">parent</span>=<span class=\"string\">&quot;abstract&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;刘备&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果所依赖的bean不存在，实例化失败</p>\n<p>警告: Exception encountered during context initialization - cancelling refresh attempt:<br>        org.springframework.beans.factory.BeanCreationException:<br>         Error creating bean with name ‘person2’ defined in class path resource [spring-config.xml]:<br>         ‘person2’ depends on missing bean ‘depend1’; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException:<br>        No bean named ‘depend1’ available</p>\n</blockquote>\n","categories":["spring"],"tags":["spring"]},{"title":"spring事件监听","url":"/2021/%E6%A1%86%E6%9E%B6/spring/spring%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC/","content":"<h2 id=\"spring事件监听\"><a href=\"#spring事件监听\" class=\"headerlink\" title=\"spring事件监听\"></a>spring事件监听</h2><p>ApplicationListener监听容器中发布的事件</p>\n<p>实现ApplicationListener来完成事件监听</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ApplicationListener</span>&lt;<span class=\"title\">E</span> <span class=\"keyword\">extends</span> <span class=\"title\">ApplicationEvent</span>&gt; <span class=\"keyword\">extends</span> <span class=\"title\">EventListener</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Handle an application event.</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> event the event to respond to</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">onApplicationEvent</span><span class=\"params\">(E event)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>可以使用publishEvent方法来发布事件</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">ApplicationContext context = <span class=\"keyword\">new</span> AnnotationConfigApplicationContext(MainConfig4.class);</span><br><span class=\"line\"></span><br><span class=\"line\">context.publishEvent(<span class=\"keyword\">new</span> ApplicationEvent() &#123;</span><br><span class=\"line\">        &#125;);</span><br></pre></td></tr></table></figure>\n\n","categories":["spring"],"tags":["spring"]},{"title":"spring依赖注入","url":"/2021/%E6%A1%86%E6%9E%B6/spring/spring%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/","content":"<h2 id=\"spring依赖注入\"><a href=\"#spring依赖注入\" class=\"headerlink\" title=\"spring依赖注入\"></a>spring依赖注入</h2><h3 id=\"IOC-amp-amp-DI\"><a href=\"#IOC-amp-amp-DI\" class=\"headerlink\" title=\"IOC&amp;&amp;DI\"></a>IOC&amp;&amp;DI</h3><p>IOC(Inversion of Control)一般分为两种类型：依赖注入DI(Dependency Injection)和依赖查找(Dependency Lookup)</p>\n<p>org.springframework.beans.factory.BeanFactory是IOC容器的具体实现，是Spring IOC容器的核心接口</p>\n<p>Spring IOC负责创建对象，管理对象，装配对象，配置对象，并且管理这些对象的整个生命周期。</p>\n<a id=\"more\"></a>\n\n<p>优点：把应用的代码量降到最低。最小代价和最小侵入式是松散耦合得以实现。IOC容器支持加载服务时的饿汉式初始化和懒加载</p>\n<p>DI依赖注入是IOC的一个方面，不需要创建对象，只需描述如何被创建，在配置文件中描述组件需要哪些服务，之后IOC容器进行组装</p>\n<p>IOC的注入方式：1、构造器依赖注入  2、Setter方法注入 3、工厂方法注入(很少使用)</p>\n<h5 id=\"Setter方法注入\"><a href=\"#Setter方法注入\" class=\"headerlink\" title=\"Setter方法注入\"></a>Setter方法注入</h5><p>通过Setter方法注入bean的属性值或依赖的对象,是最常用的注入方式</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- property来配置属性  </span></span><br><span class=\"line\"><span class=\"comment\">    name为属性名</span></span><br><span class=\"line\"><span class=\"comment\">     value为属性值</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;helloWorld&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.helloworld.HelloWorld&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;Spring Hello&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h5 id=\"构造器注入\"><a href=\"#构造器注入\" class=\"headerlink\" title=\"构造器注入\"></a>构造器注入</h5><p>构造器注入需要提供相应的构造器</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 可以使用index来指定参数的顺序，默认是按照先后顺序 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;car&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Car&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;法拉利&quot;</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;0&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;200&quot;</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;1&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>但是如果存在重载的构造器的话，只使用index索引方式无法进行精确匹配，还需要使用类型type来进行区分，index和type可以搭配使用</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Car</span><span class=\"params\">(String brand, <span class=\"keyword\">double</span> price)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.brand = brand;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.price = price;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Car</span><span class=\"params\">(String brand, <span class=\"keyword\">int</span> speed)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.brand = brand;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.speed = speed;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;car&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Car&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;法拉利&quot;</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;0&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;20000.0&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;double&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;car2&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Car&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;玛莎拉蒂&quot;</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;0&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;250&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;int&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["spring"],"tags":["spring"]},{"title":"spring容器","url":"/2021/%E6%A1%86%E6%9E%B6/spring/spring%E5%AE%B9%E5%99%A8/","content":"<h2 id=\"spring容器\"><a href=\"#spring容器\" class=\"headerlink\" title=\"spring容器\"></a>spring容器</h2><p>分为两种类型</p>\n<a id=\"more\"></a>\n\n<ul>\n<li><p>BeanFactory   该接口是最简单的容器，提供了基本的DI支持。最常用的BeanFactory实现是XmlBeanFactory类，根据XML文件中的定义加载bean，从XML文件读取配置元数据并用它去创建一个完全配置的系统或应用</p>\n</li>\n<li><p>ApplicationContext应用上下文   基于BeanFactory之上构建，提供面向应用的服务，通常的实现</p>\n<ul>\n<li><p>ClassPathXmlApplicationContext   从类路径下的XML配置文件中加载上下文定义，把应用上下文定义文件当做资源</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">ApplicationContext  context = <span class=\"keyword\">new</span> ClassPathXmlApplicationContext(<span class=\"string\">&quot;application.xml&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>FileSystemXmlApplicationContext  读取文件系统下的XML配置文件并加载上下文定义</p>\n</li>\n<li><p>XmlWebApplicationContext  读取Web应用下的XML配置文件并装载上下文定义</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"BeanFactory和ApplicationContext的区别\"><a href=\"#BeanFactory和ApplicationContext的区别\" class=\"headerlink\" title=\"BeanFactory和ApplicationContext的区别\"></a>BeanFactory和ApplicationContext的区别</h3><p>BeanFactory可以认为是bean集合的工厂类，包含了各种bean的定义，以便在接收到客户端请求时将对应的bean实例化</p>\n<p>ApplicationContext继承了BeanFactory并增加了其他的功能，在初始化上下文时就实例化所有**<em>单例**</em>的bean，提供了支持国际化的文本消息，统一的资源文件读取方式，已在监听器中注册的bean的事件，常见的实现方式</p>\n<ul>\n<li><p>ClassPathXmlApplicationContext:从classpath的XML配置文件中读取上下文，并生成上下文定义。应用程序上下文从程序环境变量中取得</p>\n</li>\n<li><p>FileSystemXmlApplicationContext: 由文件系统中的XML文件读取上下文</p>\n</li>\n<li><p>XmlWebApplicationContext: 由Web应用的XML文件读取上下文</p>\n</li>\n<li><p>AnnotationConfigApplicationContext: 注解方式</p>\n</li>\n</ul>\n<blockquote>\n<p>ConfigurableApplicationContext扩展于ApplicationContext接口，新增了两个主要的方法，refresh()和close()，让ApplicationContext具有启动、刷新和关闭上下文的能力</p>\n<p>WebApplicationContext专门为WEB应用准备的，允许从相对于WEB根目录的路径中初始化上下文</p>\n</blockquote>\n<img src=\"/images/spring/spring容器.png\" alt=\"spring容器\" style=\"zoom:50%;\">","categories":["spring"],"tags":["spring"]},{"title":"spring注解整理","url":"/2021/%E6%A1%86%E6%9E%B6/spring/spring%E6%B3%A8%E8%A7%A3%E6%95%B4%E7%90%86/","content":"<h2 id=\"spring注解整理\"><a href=\"#spring注解整理\" class=\"headerlink\" title=\"spring注解整理\"></a>spring注解整理</h2><h3 id=\"Configuration\"><a href=\"#Configuration\" class=\"headerlink\" title=\"@Configuration\"></a>@Configuration</h3><p>使用@Configuration注解来标注的类为配置类，配置类就相当于配置文件，可以在配置类中来配置bean</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * bean的类型是返回类型，bean的id默认是方法名称</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Person <span class=\"title\">person</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Person(<span class=\"string\">&quot;张三&quot;</span>,<span class=\"number\">18</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Bean\"><a href=\"#Bean\" class=\"headerlink\" title=\"Bean\"></a>Bean</h4><p>使用@Bean来标注方法以此来进行bean的实例化，bean的类型是返回类型，bean的id默认是方法名称，可以使用@Bean注解来自定义bean的id以及初始化方法、销毁方法</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> Bean &#123;</span><br><span class=\"line\">    <span class=\"meta\">@AliasFor(&quot;name&quot;)</span></span><br><span class=\"line\">    String[] value() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@AliasFor(&quot;value&quot;)</span></span><br><span class=\"line\">    String[] name() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">Autowire <span class=\"title\">autowire</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> Autowire.NO</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">initMethod</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">destroyMethod</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;<span class=\"params\">(inferred)</span>&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"bean的作用域-Scope\"><a href=\"#bean的作用域-Scope\" class=\"headerlink\" title=\"bean的作用域@Scope\"></a>bean的作用域@Scope</h5><p>可以在生成bean的方法上使用@Scope来指定bean的作用域</p>\n<ul>\n<li>ConfigurableBeanFactory#SCOPE_PROTOTYPE</li>\n<li>ConfigurableBeanFactory#SCOPE_SINGLETON</li>\n<li>org.springframework.web.context.WebApplicationContext#SCOPE_REQUEST</li>\n<li>org.springframework.web.context.WebApplicationContext#SCOPE_SESSION</li>\n</ul>\n<h5 id=\"懒加载-Lazy\"><a href=\"#懒加载-Lazy\" class=\"headerlink\" title=\"懒加载@Lazy\"></a>懒加载@Lazy</h5><p>对于单例bean默认是在容器启动的时候加载，可以使用懒加载来使其第一次调用时在进行加载</p>\n<p>在生成bean的方法上使用@Lazy来使用来加载</p>\n<h5 id=\"bean的条件注册-Conditional\"><a href=\"#bean的条件注册-Conditional\" class=\"headerlink\" title=\"bean的条件注册@Conditional\"></a>bean的条件注册@Conditional</h5><p>@Conditional可以标注在类上，也可以标注在方法上，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> Conditional &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"comment\">//Condition类数组</span></span><br><span class=\"line\">   Class&lt;? extends Condition&gt;[] value();</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可以自定义Condition，需要实现Condition接口</p>\n<h5 id=\"Primary\"><a href=\"#Primary\" class=\"headerlink\" title=\"@Primary\"></a>@Primary</h5><p>如果存在多个相同类型的bean，可以使用@Primary注解来标注bean，使得该bean为默认获取到的bean</p>\n<h5 id=\"工厂bean\"><a href=\"#工厂bean\" class=\"headerlink\" title=\"工厂bean\"></a>工厂bean</h5><p>可以使用FactoryBean来使用工厂bean来实例化bean，此时使用personFactoryBean来获取到的是Person的实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> PersonFactoryBean <span class=\"title\">personFactoryBean</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> PersonFactoryBean();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PersonFactoryBean</span> <span class=\"keyword\">implements</span> <span class=\"title\">FactoryBean</span>&lt;<span class=\"title\">Person</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Person <span class=\"title\">getObject</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Person();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Person.class;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isSingleton</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果想要获取到FactoryBean本身的实例，可以使用&amp;personFactoryBean来获取</p>\n</blockquote>\n<h3 id=\"ComponentScan\"><a href=\"#ComponentScan\" class=\"headerlink\" title=\"@ComponentScan\"></a>@ComponentScan</h3><p>在配置类上标注组件扫描，相当于&lt;context:component-scan&gt;可以配置扫描的规则，使用basePackages来指定扫描的包，includeFilters和excludeFilters来配置包含或者排除的规则，与配置文件相似</p>\n<p>两个示例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//排除Controller注解标识的bean</span></span><br><span class=\"line\"><span class=\"meta\">@ComponentScan(basePackages = &#123;&quot;com.zhanghe.study.spring4.annotation&quot;&#125;,excludeFilters = &#123;</span></span><br><span class=\"line\"><span class=\"meta\">        @ComponentScan.Filter(type = FilterType.ANNOTATION,classes = &#123;Controller.class&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">&#125;)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 只包含Controller注解标识的bean，不要忘记useDefaultFilters = false,与使用配置文件相似</span></span><br><span class=\"line\"><span class=\"meta\">@ComponentScan(basePackages = &#123;&quot;com.zhanghe.study.spring4.annotation&quot;&#125;,</span></span><br><span class=\"line\"><span class=\"meta\">        useDefaultFilters = false,</span></span><br><span class=\"line\"><span class=\"meta\">        includeFilters = &#123;</span></span><br><span class=\"line\"><span class=\"meta\">        @ComponentScan.Filter(type = FilterType.ANNOTATION,classes = &#123;Controller.class&#125;)</span></span><br><span class=\"line\"><span class=\"meta\"></span></span><br><span class=\"line\"><span class=\"meta\">&#125;)</span></span><br></pre></td></tr></table></figure>\n\n<p>过滤的类型有以下几种</p>\n<ul>\n<li>ANNOTATION  按照注解，最常用</li>\n<li>ASSIGNABLE_TYPE 按照类型</li>\n<li>ASPECTJ  使用ASPECTJ表达式</li>\n<li>REGEX  使用正则表达式</li>\n<li>CUSTOM  使用自定义规则，实现TypeFilter接口</li>\n</ul>\n<h3 id=\"Import\"><a href=\"#Import\" class=\"headerlink\" title=\"@Import\"></a>@Import</h3><p>使用Import可以进行组件导入，对于第三包中的所需要用到的bean，没有必要每一个都使用@Bean来进行一个个的实例化，可以使用@Import来直接导入bean组件</p>\n<ul>\n<li><p>@Import(要导入的组件名)     bean的id默认为全类名</p>\n</li>\n<li><p>@Import(importSelector类)  实现importSelector接口，重写selectImports方法，返回值就是组件全类名的数组</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">String[] selectImports(AnnotationMetadata importingClassMetadata);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>@Import(ImportBeanDefinitionRegistrar类)   实现ImportBeanDefinitionRegistrar接口，重写registerBeanDefinitions方法，自己使用registry进行注册某些bean</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">registerBeanDefinitions</span><span class=\"params\">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span></span>;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"Value\"><a href=\"#Value\" class=\"headerlink\" title=\"@Value\"></a>@Value</h3><p>使用@Value可以为属性进行赋值</p>\n<h4 id=\"基本数值\"><a href=\"#基本数值\" class=\"headerlink\" title=\"基本数值\"></a>基本数值</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Value(&quot;张三&quot;)</span></span><br><span class=\"line\">String name;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Spel表达式\"><a href=\"#Spel表达式\" class=\"headerlink\" title=\"Spel表达式\"></a>Spel表达式</h4><p>#{}</p>\n<h4 id=\"环境变量中的值-配置文件中的值\"><a href=\"#环境变量中的值-配置文件中的值\" class=\"headerlink\" title=\"环境变量中的值(配置文件中的值)\"></a>环境变量中的值(配置文件中的值)</h4><p>${}</p>\n<p>需要引入配置文件，使用@PropertySource</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@PropertySource(value = &quot;classpath:test.properties&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MainConfig4</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Bean</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> TestValue <span class=\"title\">testValue</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> TestValue();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestValue</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 取出配置文件中的值</span></span><br><span class=\"line\">    <span class=\"meta\">@Value(&quot;$&#123;test.value&#125;&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> value;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"EnableAspectJAutoProxy\"><a href=\"#EnableAspectJAutoProxy\" class=\"headerlink\" title=\"@EnableAspectJAutoProxy\"></a>@EnableAspectJAutoProxy</h3><p>在之前为了使@Aspect注解生效需要在配置文件中配置</p>\n<p>&lt;aop:aspectj-autoproxy/&gt;</p>\n<p>而该注解的作用就是使得@Aspect注解生效，开启基于注解的AOP模式，与上述配置功能相同</p>\n<h3 id=\"EnableTransactionManagement\"><a href=\"#EnableTransactionManagement\" class=\"headerlink\" title=\"@EnableTransactionManagement\"></a>@EnableTransactionManagement</h3><p>在之前为了使@Transaction注解生效，需要在配置文件中配置</p>\n<p>&lt;tx:annotation-driven transaction-manager=”transactionManager”/&gt;</p>\n<p>而是用该注解的作用就是使得@Transaction注解生效，与上述配置功能相同</p>\n","categories":["spring"],"tags":["spring"]},{"title":"spring结构","url":"/2020/%E6%A1%86%E6%9E%B6/spring/spring%E7%BB%93%E6%9E%84/","content":"<h2 id=\"spring框架构成\"><a href=\"#spring框架构成\" class=\"headerlink\" title=\"spring框架构成\"></a>spring框架构成</h2><img src=\"/images/spring/模块.jpg\" alt=\"模块\" style=\"zoom:50%;\">\n\n<a id=\"more\"></a>\n\n<ul>\n<li>Spring Core</li>\n</ul>\n<p>核心容器提供Spring框架的基本功能。主要组件是BeanFactory，工厂模式的实现，使用IOC模式将应用程序的配置和依赖性规范与实际的应用程序代码分开</p>\n<ul>\n<li>Spring Context</li>\n</ul>\n<p>Spring Context是Spring上下文，实际上是一个配置文件，由Spring框架提供上下文信息。</p>\n<ul>\n<li>Spring AOP</li>\n</ul>\n<p>通过配置管理特性，AOP模块直接将面向切面的编程功能集成到了Spring框架中。可以很容易的使Spring框架管理的任何对象支持AOP。如事务管理</p>\n<ul>\n<li>Spring DAO</li>\n</ul>\n<p>JDBC DAO抽象层提供了有意义的异常层次结构，可用该结构来管理异常处理和不同数据库供应商抛出的错误消息。异常层次结构简化了错误处理，并且极大地降低了需要编写的异常代码数量</p>\n<ul>\n<li>Spring ORM</li>\n</ul>\n<p>Spring框架插入了若干个ORM框架，从而提供了ORM的对象关系工具，包括JDO、Hibernate和iBatis。都遵从Spring的通用事务和DAO异常层次结构</p>\n<ul>\n<li>Spring Web</li>\n</ul>\n<p>Web上下文模块建立在应用程序上下文模块之上，为基于Web的应用程序提供了上下文。Spring支持与Struts的集成。Web模块还简化了处理多部分请求以及将请求参数绑定到域对象的工作。</p>\n<ul>\n<li>Spring MVC</li>\n</ul>\n<p>MVC框架是一个全功能构建Web应用程序的MVC实现。通过策略接口，MVC框架变成为高度可配置的，MVC容纳了大量视图技术，其中包括JSP、Velocity、Tiles、iText和POI。</p>\n","categories":["spring"],"tags":["spring"]},{"title":"spring配置bean","url":"/2021/%E6%A1%86%E6%9E%B6/spring/spring%E9%85%8D%E7%BD%AEbean/","content":"<h2 id=\"spring配置bean\"><a href=\"#spring配置bean\" class=\"headerlink\" title=\"spring配置bean\"></a>spring配置bean</h2><h3 id=\"使用xml配置\"><a href=\"#使用xml配置\" class=\"headerlink\" title=\"使用xml配置\"></a>使用xml配置</h3><h4 id=\"使用构造器创建\"><a href=\"#使用构造器创建\" class=\"headerlink\" title=\"使用构造器创建\"></a>使用构造器创建</h4><p>构造器创建bean是最常用的，如果不使用构造注入，Spring会调用无参构造器来创建实例</p>\n<p>使用的是反射机制，要求该bean所对应的类必须有一个无参构造器</p>\n<a id=\"more\"></a>\n\n<p>而对于注入方式，有构造器注入和setter方法注入</p>\n<h5 id=\"依赖注入方式\"><a href=\"#依赖注入方式\" class=\"headerlink\" title=\"依赖注入方式\"></a>依赖注入方式</h5><h6 id=\"setter方法注入\"><a href=\"#setter方法注入\" class=\"headerlink\" title=\"setter方法注入\"></a>setter方法注入</h6><p>使用setter方法注入时，注意一定要有无参构造器，spring会根据配置的class来使用class.newInstance()方法来实例化该bean</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">beans</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">       <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 配置bean</span></span><br><span class=\"line\"><span class=\"comment\">     class 配置bean的全类名，使用反射的方式创建bean，要求必须有一个无参构造器</span></span><br><span class=\"line\"><span class=\"comment\">     id 标识容器z中的bean id唯一</span></span><br><span class=\"line\"><span class=\"comment\">     --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;helloWorld&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.helloworld.HelloWorld&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;Spring Hello&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意：bean配置的property属性的name值表示的是setter风格的属性，即setter方法去掉set之后首字母小写的名称，并不是和成员变量进行对应</p>\n</blockquote>\n<h6 id=\"构造方法注入\"><a href=\"#构造方法注入\" class=\"headerlink\" title=\"构造方法注入\"></a>构造方法注入</h6><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- </span></span><br><span class=\"line\"><span class=\"comment\">    value为属性值</span></span><br><span class=\"line\"><span class=\"comment\">     index 表示对应构造器的参数位置  从0开始</span></span><br><span class=\"line\"><span class=\"comment\">    type 表示构造器该参数的类型</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;car&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Car&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;法拉利&quot;</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;0&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;20000.0&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;double&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>获取bean</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 创建spring的IOC容器</span></span><br><span class=\"line\">ApplicationContext context = <span class=\"keyword\">new</span> ClassPathXmlApplicationContext(<span class=\"string\">&quot;spring-config.xml&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 从IOC容器获取HelloWorld  bean实例</span></span><br><span class=\"line\">HelloWorld helloWorld = (HelloWorld) context.getBean(<span class=\"string\">&quot;helloWorld&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"配置bean引用\"><a href=\"#配置bean引用\" class=\"headerlink\" title=\"配置bean引用\"></a>配置bean引用</h5><p>如果bean之间有引用关系，可以使用ref来指定引用关系</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Person</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Car car;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setName</span><span class=\"params\">(String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Car <span class=\"title\">getCar</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> car;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setCar</span><span class=\"params\">(Car car)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.car = car;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">toString</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;Person&#123;&quot;</span> +</span><br><span class=\"line\">                <span class=\"string\">&quot;name=&#x27;&quot;</span> + name + <span class=\"string\">&#x27;\\&#x27;&#x27;</span> +</span><br><span class=\"line\">                <span class=\"string\">&quot;, car=&quot;</span> + car +</span><br><span class=\"line\">                <span class=\"string\">&#x27;&#125;&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这里的ref中写的是其他bean的id值</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;car&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Car&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;法拉利&quot;</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;0&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;20000.0&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;double&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;person&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Person&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;张三&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;car&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"配置集合属性\"><a href=\"#配置集合属性\" class=\"headerlink\" title=\"配置集合属性\"></a>配置集合属性</h5><p>可以使用<list>、<set>、<map>来对集合属性赋值</map></set></list></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;person&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Person&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;张三&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;car&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;cars&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- list的示例 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">bean</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">bean</span>=<span class=\"string\">&quot;car2&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;carMap&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- map的示例  entry可以使用key/key-ref/value/value-ref --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">map</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">entry</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;AA&quot;</span> <span class=\"attr\">value-ref</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">entry</span> <span class=\"attr\">key</span>=<span class=\"string\">&quot;BB&quot;</span> <span class=\"attr\">value-ref</span>=<span class=\"string\">&quot;car2&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">map</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>还有一种集合bean的方式，可以进行配置集合属性</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 配置集合bean --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">util:list</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;cars&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">bean</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">bean</span>=<span class=\"string\">&quot;car2&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">util:list</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>然后在需要使用集合的bean中直接引用该集合bean</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;person1&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Person&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;张三&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;car&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;car&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- 引用上述定义的集合bean --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;cars&quot;</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;cars&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用工厂bean来创建实际bean\"><a href=\"#使用工厂bean来创建实际bean\" class=\"headerlink\" title=\"使用工厂bean来创建实际bean\"></a>使用工厂bean来创建实际bean</h4><p>可以提供一个实现FactoryBean接口的工厂bean来生产所实际需要的bean对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 实现FactoryBean接口来生成car对象</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> zh</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2021/1/30 16:01</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CarFactoryBean</span> <span class=\"keyword\">implements</span> <span class=\"title\">FactoryBean</span>&lt;<span class=\"title\">Car</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 真正获取对象的方法</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> Exception</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Car <span class=\"title\">getObject</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Car(<span class=\"string\">&quot;玛莎拉蒂&quot;</span>,<span class=\"number\">300</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 生成bean的类型</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Car.class;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 是否是单例</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isSingleton</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>使用该factoryBean对象时，由于该bean实现了FactoryBean，所以spring不会把它作为一个普通的bean来处理，而是作为一个工厂bean，调用getObject()方法来创建实际需要的bean对象</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;c&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.CarFactoryBean&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用静态工厂方法创建Bean\"><a href=\"#使用静态工厂方法创建Bean\" class=\"headerlink\" title=\"使用静态工厂方法创建Bean\"></a>使用静态工厂方法创建Bean</h4><p>使用静态工厂方法创建bean实例时，class属性也必须指定，此时的class属性并不是指定Bean实例的实现类，而是静态工厂类，Spring通过该属性知道由哪个工厂类来创建Bean实例，还可以使用factory-method属性来指定静态工厂方法，Spring将调用静态工厂方法返回一个Bean实例，静态工厂方法需要参数的话，使用<constructor-arg>元素指定</constructor-arg></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">StaticCarFactory</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Map&lt;String,Car&gt; cars = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        cars.put(<span class=\"string\">&quot;aa&quot;</span>,<span class=\"keyword\">new</span> Car(<span class=\"string\">&quot;aa&quot;</span>,<span class=\"number\">300</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Car <span class=\"title\">getCar</span><span class=\"params\">(String name)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> cars.get(name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 通过静态工厂方法来配置bean</span></span><br><span class=\"line\"><span class=\"comment\">class 静态工厂类</span></span><br><span class=\"line\"><span class=\"comment\">factory-method 静态工厂方法的名字</span></span><br><span class=\"line\"><span class=\"comment\">constructor-arg 指定静态方法的参数</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;car&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.StaticCarFactory&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">factory-method</span>=<span class=\"string\">&quot;getCar&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;aa&quot;</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;0&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>优点：将对象创建的过程封装到静态方法中，当客户端需要对象时，只需要简单地调用静态方法，不需要关系创建对象的细节</p>\n<h4 id=\"调用实例工厂方法创建bean\"><a href=\"#调用实例工厂方法创建bean\" class=\"headerlink\" title=\"调用实例工厂方法创建bean\"></a>调用实例工厂方法创建bean</h4><p>实例工厂与静态工厂只有一个不同，静态工厂只需要使用工厂类即可，实例工厂需要工厂实例，使用factory-bean指定工厂实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">InstanceCarFactory</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String,Car&gt; cars = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">InstanceCarFactory</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        cars = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">        cars.put(<span class=\"string\">&quot;bb&quot;</span>,<span class=\"keyword\">new</span> Car(<span class=\"string\">&quot;bb&quot;</span>, <span class=\"number\">30000.0</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Car <span class=\"title\">getCar</span><span class=\"params\">(String name)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> cars.get(name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 配置工厂实例 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;instanceCarFactory&quot;</span>     <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.InstanceCarFactory&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 通过实例工厂方法来配置bean</span></span><br><span class=\"line\"><span class=\"comment\">  factory-bean 实例工厂的bean</span></span><br><span class=\"line\"><span class=\"comment\">  factory-method 实例工厂方法的名字</span></span><br><span class=\"line\"><span class=\"comment\">  constructor-arg 指定方法的参数</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;car1&quot;</span> <span class=\"attr\">factory-bean</span>=<span class=\"string\">&quot;instanceCarFactory&quot;</span> <span class=\"attr\">factory-method</span>=<span class=\"string\">&quot;getCar&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">constructor-arg</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;bb&quot;</span> <span class=\"attr\">index</span>=<span class=\"string\">&quot;0&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"自动装配\"><a href=\"#自动装配\" class=\"headerlink\" title=\"自动装配\"></a>自动装配</h4><p>上述的操作方式全是手动地进行注入的，如何进行自动装配呢，可以使用autowire属性来配置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 自动装配 --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- byName 根据属性名称去匹配到对应的bean</span></span><br><span class=\"line\"><span class=\"comment\">         byName  根据属性的类型去匹配到对应的bean</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;testAutoWired&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.beantest.Person&quot;</span> <span class=\"attr\">autowire</span>=<span class=\"string\">&quot;byName&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;张三&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果使用byType，而且存在多个该类型的bean的话，就会出现异常</p>\n<p>Caused by: org.springframework.beans.factory.NoUniqueBeanDefinitionException: No qualifying bean of type ‘com.zhanghe.study.spring4.beans.beantest.Car’ available: expected single matching bean but found 2: car,car2</p>\n</blockquote>\n<h3 id=\"使用注解配置\"><a href=\"#使用注解配置\" class=\"headerlink\" title=\"使用注解配置\"></a>使用注解配置</h3><p>spring可以在classpath下进行组件扫描，包含注解有</p>\n<ul>\n<li>@Component  基本注解，表示是一个受spring管理的组件</li>\n<li>@Respository  表示持久层组件</li>\n<li>@Service  表示业务层组件</li>\n<li>@Controller  表示表现层组件</li>\n</ul>\n<p>spring扫描到组件后，有默认的命名策略，将扫描到的类名进行首字母小写，也可以在注解中使用value属性值来标识组件的名称</p>\n<blockquote>\n<p>如果使用注解来标识bean的话，需要进行配置指定spring扫描的包，会扫描base-package指定的包及其子包</p>\n<p>&lt;context:component=scan base-package=”包名”/&gt;</p>\n</blockquote>\n<h4 id=\"使用注解进行配置\"><a href=\"#使用注解进行配置\" class=\"headerlink\" title=\"使用注解进行配置\"></a>使用注解进行配置</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 设置包扫描路径 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">context:component-scan</span> <span class=\"attr\">base-package</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.annotationtest&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>还可以自定义的设置对于该包下的某些组件是否进行扫描</p>\n<blockquote>\n<p>在使用&lt;context:component=scan base-package=”包名”/&gt;标签时，记得要加上context的命名空间</p>\n<p><beans xmlns=\"http://www.springframework.org/schema/beans\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:context=\"http://www.springframework.org/schema/context\" xsi:schemalocation=\"http://www.springframework.org/schema/beans\n        http://www.springframework.org/schema/beans/spring-beans.xsd\n        http://www.springframework.org/schema/context \n        https://www.springframework.org/schema/context/spring-context.xsd\"></beans></p>\n</blockquote>\n<h5 id=\"设置过滤\"><a href=\"#设置过滤\" class=\"headerlink\" title=\"设置过滤\"></a>设置过滤</h5><p>使用context:exclude-filter来设置排除哪些特定的组件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">context:component-scan</span> <span class=\"attr\">base-package</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.annotationtest&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 使用context:exclude-filter来设置排除哪些特定的组件</span></span><br><span class=\"line\"><span class=\"comment\">        type  annotation表示使用注解的表达式</span></span><br><span class=\"line\"><span class=\"comment\">              assignable保护指定具体bean的类名</span></span><br><span class=\"line\"><span class=\"comment\">        --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">context:exclude-filter</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;annotation&quot;</span> <span class=\"attr\">expression</span>=<span class=\"string\">&quot;org.springframework.stereotype.Service&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"设置包含\"><a href=\"#设置包含\" class=\"headerlink\" title=\"设置包含\"></a>设置包含</h5><p>使用context:include-filter来设置只扫描哪些特定的组件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">context:component-scan</span> <span class=\"attr\">base-package</span>=<span class=\"string\">&quot;com.zhanghe.study.spring4.beans.annotationtest&quot;</span> <span class=\"attr\">use-default-filters</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 使用context:include-filter来设置只扫描哪些特定的组件，如果使用include-filter的话需要设置use-default-filters=&quot;false&quot; --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">context:include-filter</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;annotation&quot;</span> <span class=\"attr\">expression</span>=<span class=\"string\">&quot;org.springframework.stereotype.Service&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"自动装配-1\"><a href=\"#自动装配-1\" class=\"headerlink\" title=\"自动装配\"></a>自动装配</h4><p>使用xml进行自动装配的时候略显笨拙，而且使用起来也并不顺心，因为autowire只能选择byName或者byType，如果存在多个相同类型的bean使用byType就会出现问题，大家可能因此想要放弃自动装配，其实自动装配与注解搭配起来还是很好用的，下面来了解一下</p>\n<p>如果bean与bean之间存在关联关系，如在beanA中需要调用beanB的方法，如何来获取beanB中的实例呢</p>\n<p>&lt;context:component-scan&gt;元素会自动注册AutowiredAnnotationBeanPostProcessor实例，该实例可以自动装配具有@AutoWired、@Resource和@Inject注解的属性</p>\n<p>@Autowired默认使用byType，如果存在类型相同的两个bean，则使用byName来根据属性的名称来匹配bean</p>\n<p>@Resource注解是使用的byName，需要提供bean的名称，如果不提供该bean的名称，则自动使用属性的名称进行匹配</p>\n<p>@Inject与@AutoWired一样，只是没有required属性</p>\n<ul>\n<li><p>使用@Autowired 和@Qualifier结合来明确指定需要装配的Bean</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Autowired</span></span><br><span class=\"line\"><span class=\"meta\">@Qualifier(&quot;bpmServiceImpl&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> BpmService bpmService;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用@Inject和@Named结合来指定</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Inject</span></span><br><span class=\"line\"><span class=\"meta\">@Named(&quot;compensateServiceImpl&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> CompensateService compensateService;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n","categories":["spring"],"tags":["spring"]},{"title":"web应用使用spring","url":"/2021/%E6%A1%86%E6%9E%B6/spring/web%E5%BA%94%E7%94%A8%E4%BD%BF%E7%94%A8spring/","content":"<h2 id=\"web应用使用spring\"><a href=\"#web应用使用spring\" class=\"headerlink\" title=\"web应用使用spring\"></a>web应用使用spring</h2><p>对于java而言，使用最多的还是web开发，如何在web应用中使用spring呢，web应用中没有main方法，而且必须在servlet容器加载时就创建spring的IOC容器，之前在学习Servlet的时候有讲到一个Servlet监听器，可以监听ServletContext、HttpSession、ServletRequest等对象的创建和销毁</p>\n<a id=\"more\"></a>\n\n<p>所以可以实现ServletContextListener接口，重写contextInitialized方法来实现spring的IOC容器的创建</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ServletContextListener</span> <span class=\"keyword\">extends</span> <span class=\"title\">EventListener</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">contextInitialized</span><span class=\"params\">(ServletContextEvent var1)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">contextDestroyed</span><span class=\"params\">(ServletContextEvent var1)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在web.xml中配置listener</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">listener</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class=\"tag\">&lt;/<span class=\"name\">listener-class</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">listener</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 指明配置文件所在位置 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">context-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>contextConfigLocation<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>classpath:applicationContext.xml<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">context-param</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["spring"],"tags":["spring"]},{"title":"springboot主程序","url":"/2021/%E6%A1%86%E6%9E%B6/springboot/%E4%B8%BB%E7%A8%8B%E5%BA%8F/","content":"<h2 id=\"springboot主程序\"><a href=\"#springboot主程序\" class=\"headerlink\" title=\"springboot主程序\"></a>springboot主程序</h2><p>使用过springboot的都应该知道，springboot的主程序类上是由一个注解@SpringBootApplication的，这个注解表明了这个项目是一个springboot项目，也标注了这个类是springboot的主配置类</p>\n<p>但是这个注解里的内容其实是很多的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@SpringBootConfiguration</span></span><br><span class=\"line\"><span class=\"meta\">@EnableAutoConfiguration</span></span><br><span class=\"line\"><span class=\"meta\">@ComponentScan(excludeFilters = &#123;</span></span><br><span class=\"line\"><span class=\"meta\">        @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class=\"line\"><span class=\"meta\">        @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> SpringBootApplication &#123;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>下面就分别介绍一下这里边的注解</p>\n<h4 id=\"SpringBootConfiguration\"><a href=\"#SpringBootConfiguration\" class=\"headerlink\" title=\"@SpringBootConfiguration\"></a>@SpringBootConfiguration</h4><p>这个注解是用来标注springboot的配置类的，看一下该注解的组成就知道了，是@Configuration注解，spring底层就是来以@Configuration注解标注的类作为配置类的</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> SpringBootConfiguration &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"EnableAutoConfiguration\"><a href=\"#EnableAutoConfiguration\" class=\"headerlink\" title=\"@EnableAutoConfiguration\"></a>@EnableAutoConfiguration</h4><p>这个注解是用来开启自动配置功能的，用来告诉springboot开启自动配置功能，看一下这个注解的构成</p>\n<p>看到了@Import注解就知道了，用@Import注解来进行组件导入，还是原来spring的那一套，使用selector选择器来进行操作</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@AutoConfigurationPackage</span></span><br><span class=\"line\"><span class=\"meta\">@Import(EnableAutoConfigurationImportSelector.class)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> EnableAutoConfiguration &#123;</span><br></pre></td></tr></table></figure>\n\n<p>这里主要加载了两个文件META-INF/spring-autoconfigure-metadata.properties和META-INF/spring.factories</p>\n<p>这个EnableAutoConfigurationImportSelector的作用是将META-INF/spring.factories文件中写的org.springframework.boot.autoconfigure.EnableAutoConfiguration对应的所有的xxxAutoConfiguration注册进来  </p>\n<p>接下来看一下@AutoConfigurationPackage里是什么，也是一个@Import注解，使用Registrar注册器来进行组件注册</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Import(AutoConfigurationPackages.Registrar.class)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> AutoConfigurationPackage &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这个AutoConfigurationPackages.Registrar的作用是将被@SpringBootApplication标注的主配置类所在的包以及其子包中的类扫描进spring容器</p>\n<h3 id=\"自动配置报告\"><a href=\"#自动配置报告\" class=\"headerlink\" title=\"自动配置报告\"></a>自动配置报告</h3><p>可以在配置文件中配置来查看哪些自动配置生效了，哪些没生效</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">debug:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<figure class=\"highlight asciidoc\"><table><tr><td class=\"code\"><pre><span class=\"line\">=========================</span><br><span class=\"line\">AUTO-CONFIGURATION REPORT</span><br><span class=\"line\">=========================</span><br><span class=\"line\">Positive matches: (生效的自动配置)</span><br><span class=\"line\">-----------------</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"code\">   DispatcherServletAutoConfiguration matched:</span></span><br><span class=\"line\"><span class=\"code\">      - @ConditionalOnClass found required class &#x27;org.springframework.web.servlet.DispatcherServlet&#x27;; @ConditionalOnMissingClass did not find unwanted class (OnClassCondition)</span></span><br><span class=\"line\"><span class=\"code\">      - @ConditionalOnWebApplication (required) found &#x27;session&#x27; scope (OnWebApplicationCondition)</span></span><br><span class=\"line\"></span><br><span class=\"line\">Negative matches:(没生效的自动配置，以及哪些条件没满足)</span><br><span class=\"line\">-----------------</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"code\">   ActiveMQAutoConfiguration:</span></span><br><span class=\"line\"><span class=\"code\">      Did not match:</span></span><br><span class=\"line\"><span class=\"code\">         - @ConditionalOnClass did not find required classes &#x27;javax.jms.ConnectionFactory&#x27;, &#x27;org.apache.activemq.ActiveMQConnectionFactory&#x27; (OnClassCondition)</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","categories":["springboot"],"tags":["springboot"]},{"title":"springboot多环境配置","url":"/2021/%E6%A1%86%E6%9E%B6/springboot/%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/","content":"<h2 id=\"springboot多环境配置\"><a href=\"#springboot多环境配置\" class=\"headerlink\" title=\"springboot多环境配置\"></a>springboot多环境配置</h2><p>springboot对于多环境配置支持多种方式</p>\n<h3 id=\"方式一：多个配置文件\"><a href=\"#方式一：多个配置文件\" class=\"headerlink\" title=\"方式一：多个配置文件\"></a>方式一：多个配置文件</h3><p>在配置多个环境的配置文件时文件名可以是application-{profile}.properties/yml</p>\n<p>默认使用application.properties/yml的配置，然后在默认配置文件中进行环境激活</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">profiles:</span></span><br><span class=\"line\">    <span class=\"attr\">active:</span> <span class=\"string\">dev</span></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"方式二：yml支持多文档块\"><a href=\"#方式二：yml支持多文档块\" class=\"headerlink\" title=\"方式二：yml支持多文档块\"></a>方式二：yml支持多文档块</h3><p>在yml配置文件中可以使用—来进行环境配置分隔，然后在每个文档块来声明环境</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">port:</span> <span class=\"number\">8081</span></span><br><span class=\"line\"><span class=\"attr\">custom:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">张三</span></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">profiles:</span></span><br><span class=\"line\">    <span class=\"attr\">active:</span> <span class=\"string\">dev</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">profiles:</span> <span class=\"string\">dev</span></span><br><span class=\"line\"><span class=\"attr\">custom:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">赵柳</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">spring:</span></span><br><span class=\"line\">  <span class=\"attr\">profiles:</span> <span class=\"string\">prod</span></span><br><span class=\"line\"><span class=\"attr\">custom:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">孙鸥</span></span><br></pre></td></tr></table></figure>\n\n","categories":["springboot"],"tags":["springboot"]},{"title":"springboot定制嵌入式的servlet容器","url":"/2021/%E6%A1%86%E6%9E%B6/springboot/%E5%AE%9A%E5%88%B6%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%9A%84servlet%E5%AE%B9%E5%99%A8/","content":"<h2 id=\"springboot定制嵌入式的servlet容器\"><a href=\"#springboot定制嵌入式的servlet容器\" class=\"headerlink\" title=\"springboot定制嵌入式的servlet容器\"></a>springboot定制嵌入式的servlet容器</h2><h3 id=\"修改容器配置\"><a href=\"#修改容器配置\" class=\"headerlink\" title=\"修改容器配置\"></a>修改容器配置</h3><p>有两种方式可以修改容器的配置</p>\n<ul>\n<li>可以直接在配置文件中修改和server有关的配置</li>\n</ul>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">server.port</span>=<span class=\"string\">8081</span></span><br><span class=\"line\"><span class=\"meta\">server.tomcat.uri-encoding</span>=<span class=\"string\">UTF-8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">//通用的Servlet容器设置</span></span><br><span class=\"line\"><span class=\"attr\">server.xxx</span></span><br><span class=\"line\"><span class=\"attr\">//指定Tomcat的设置</span></span><br><span class=\"line\"><span class=\"attr\">server.tomcat.xxx</span></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<ul>\n<li>编写一个EmbeddedServletContainerCustomizer组件来进行嵌入式的Servlet容器的定制器，来修改Servlet容器的配置</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Bean</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> EmbeddedServletContainerCustomizer <span class=\"title\">embeddedServletContainerCustomizer</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> EmbeddedServletContainerCustomizer() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//定制嵌入式的Servlet容器相关的规则</span></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">customize</span><span class=\"params\">(ConfigurableEmbeddedServletContainer container)</span> </span>&#123;</span><br><span class=\"line\">            container.setPort(<span class=\"number\">8081</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>其实对于server的配置所采用的ServerProperties也是一个EmbeddedServletContainerCustomizer</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ConfigurationProperties(prefix = &quot;server&quot;, ignoreUnknownFields = true)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ServerProperties</span></span></span><br><span class=\"line\"><span class=\"class\">      <span class=\"keyword\">implements</span> <span class=\"title\">EmbeddedServletContainerCustomizer</span>, <span class=\"title\">EnvironmentAware</span>, <span class=\"title\">Ordered</span> </span>&#123;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h3 id=\"替换为其他的servlet容器\"><a href=\"#替换为其他的servlet容器\" class=\"headerlink\" title=\"替换为其他的servlet容器\"></a>替换为其他的servlet容器</h3><p>默认springboot使用的是tomcat作为servlet容器，可以将servlet容器替换为jetty</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 排除tomcat --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-web<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">exclusions</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">exclusion</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">         <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">exclusion</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">exclusions</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 引入jetty --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>","categories":["springboot"],"tags":["springboot"]},{"title":"springboot扩展SpringMVC","url":"/2021/%E6%A1%86%E6%9E%B6/springboot/%E6%89%A9%E5%B1%95SpringMVC/","content":"<h2 id=\"springboot扩展SpringMVC\"><a href=\"#springboot扩展SpringMVC\" class=\"headerlink\" title=\"springboot扩展SpringMVC\"></a>springboot扩展SpringMVC</h2><h3 id=\"既保留自动配置又有扩展配置\"><a href=\"#既保留自动配置又有扩展配置\" class=\"headerlink\" title=\"既保留自动配置又有扩展配置\"></a>既保留自动配置又有扩展配置</h3><p>根据官网的描述，如果想要扩展SpringBoot对于SpringMVC的配置而又保留SpringBoot对SpringMVC的自动配置，可以编写一个配置类（@Configuration）继承WebMvcConfigurerAdapter类，但是不能标注@EnableWebMvc</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyMvcConfig</span> <span class=\"keyword\">extends</span> <span class=\"title\">WebMvcConfigurerAdapter</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">addInterceptors</span><span class=\"params\">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.addInterceptors(registry);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h4 id=\"原因\"><a href=\"#原因\" class=\"headerlink\" title=\"原因\"></a>原因</h4><p>为什么继承WebMvcConfigurerAdapter就可以扩展springmvc的配置呢?</p>\n<p>在于WebMvcAutoConfiguration类中有一个bean是WebMvcAutoConfigurationAdapter</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@Import(EnableWebMvcConfiguration.class)</span></span><br><span class=\"line\"><span class=\"meta\">@EnableConfigurationProperties(&#123; WebMvcProperties.class, ResourceProperties.class &#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebMvcAutoConfigurationAdapter</span> <span class=\"keyword\">extends</span> <span class=\"title\">WebMvcConfigurerAdapter</span> </span>&#123;</span><br></pre></td></tr></table></figure>\n\n<p>使用@Import来引入的这个组件中有一个方法，会将所有的WebMvcConfigurer类都加入到configurers中</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setConfigurers</span><span class=\"params\">(List&lt;WebMvcConfigurer&gt; configurers)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!CollectionUtils.isEmpty(configurers)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.configurers.addWebMvcConfigurers(configurers);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>而WebMvcConfigurerAdapter就实现于WebMvcConfigurer</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebMvcConfigurerAdapter</span> <span class=\"keyword\">implements</span> <span class=\"title\">WebMvcConfigurer</span> </span>&#123;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用自定义配置抛弃自动配置\"><a href=\"#使用自定义配置抛弃自动配置\" class=\"headerlink\" title=\"使用自定义配置抛弃自动配置\"></a>使用自定义配置抛弃自动配置</h3><p>需要在上述配置类上加上@EnableWebMvc注解，就可以完全取代springboot对于springmvc的自动配置</p>\n<h4 id=\"原因-1\"><a href=\"#原因-1\" class=\"headerlink\" title=\"原因\"></a>原因</h4><p>至于为什么会这样，看一下@EnableWebMvc这个注解就知道了</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Target(ElementType.TYPE)</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"meta\">@Import(DelegatingWebMvcConfiguration.class)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> EnableWebMvc &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这个注解会引入一个DelegatingWebMvcConfiguration组件，而这个类是继承自WebMvcConfigurationSupport</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DelegatingWebMvcConfiguration</span> <span class=\"keyword\">extends</span> <span class=\"title\">WebMvcConfigurationSupport</span> </span>&#123;</span><br></pre></td></tr></table></figure>\n\n<p>接下来看一下WebMvcAutoConfiguration的加载条件是什么</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"meta\">@ConditionalOnWebApplication</span></span><br><span class=\"line\"><span class=\"meta\">@ConditionalOnClass(&#123; Servlet.class, DispatcherServlet.class,</span></span><br><span class=\"line\"><span class=\"meta\">        WebMvcConfigurerAdapter.class &#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</span></span><br><span class=\"line\"><span class=\"meta\">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE + 10)</span></span><br><span class=\"line\"><span class=\"meta\">@AutoConfigureAfter(&#123; DispatcherServletAutoConfiguration.class,</span></span><br><span class=\"line\"><span class=\"meta\">        ValidationAutoConfiguration.class &#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WebMvcAutoConfiguration</span> </span>&#123;</span><br></pre></td></tr></table></figure>\n\n<p>@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</p>\n<p>可以看到是在没有WebMvcConfigurationSupport这个bean的时候才会加载，所以打破了这个条件导致WebMvcAutoConfiguration不会生效</p>\n","categories":["springboot"],"tags":["springboot"]},{"title":"springboot简介","url":"/2021/%E6%A1%86%E6%9E%B6/springboot/%E7%AE%80%E4%BB%8B/","content":"<h2 id=\"springboot简介\"><a href=\"#springboot简介\" class=\"headerlink\" title=\"springboot简介\"></a>springboot简介</h2><p>由于spring和springmvc中存在很多繁琐的配置，springboot应运而生，来简化spring的开发，约定大于配置，可以很快的开发出一个可以运行的产品</p>\n<p><strong>优点</strong></p>\n<ul>\n<li>快速创建独立运行的Spring项目并与主流框架集成</li>\n<li>使用嵌入式servlet容器，无需打成war包</li>\n<li>starters自动依赖与版本控制</li>\n<li>大量的默认配置，简化开发，默认配置可修改</li>\n<li>无需配置xml</li>\n<li>应用监控</li>\n<li>与云计算天然集成</li>\n</ul>\n","categories":["springboot"],"tags":["springboot"]},{"title":"springboot配置文件","url":"/2021/%E6%A1%86%E6%9E%B6/springboot/%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/","content":"<h2 id=\"springboot配置文件\"><a href=\"#springboot配置文件\" class=\"headerlink\" title=\"springboot配置文件\"></a>springboot配置文件</h2><p>虽然springboot提供了一系列的默认配置，但是还是需要使用配置文件来进行进行一些自定义的配置</p>\n<p>springboot中配置文件名称叫做application.properties或者application.yml</p>\n<a id=\"more\"></a>\n\n<p>对于自定义的配置，可以使用@ConfigurationProperties标注所属类来进行与配置文件映射，当然映射的前提是这个类要交由spring ioc容器进行管理，所以首先要将该类作为组件进行注册</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"meta\">@ConfigurationProperties(prefix = &quot;custom&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomConfig</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setName</span><span class=\"params\">(String name)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这样做虽然可以正常的获取配置，但是在进行配置的时候发现在进行配置的时候没有提示，凭什么人家的有提示，我的没有</p>\n<p>加上这个依赖</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.springframework.boot<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">optional</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">optional</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>进行自定义类配置时也如德芙巧克力般丝滑了</p>\n<blockquote>\n<p>这种方式默认是针对于默认的配置文件的，如果不想在默认配置文件中进行配置的话，还需要加上spring的@PropertySource注解来标明所对应的配置文件</p>\n</blockquote>\n<h3 id=\"配置文件加载顺序\"><a href=\"#配置文件加载顺序\" class=\"headerlink\" title=\"配置文件加载顺序\"></a>配置文件加载顺序</h3><p>springboot 启动会扫描以下位置的application.properties/yml文件作为Spring boot的默认配置文件</p>\n<ul>\n<li><p>file:./config/</p>\n</li>\n<li><p>file:./</p>\n</li>\n<li><p>classpath:/config/</p>\n</li>\n<li><p>classpath:/</p>\n</li>\n</ul>\n<p>优先级由高到底，高优先级的配置会覆盖低优先级的配置，SpringBoot会从这四个位置全部加载主配置文件</p>\n<p>也可以使用命令行启动项目时通过spring.config.location来改变默认的配置文件位置</p>\n","categories":["springboot"],"tags":["springboot"]},{"title":"springmvc处理模型数据","url":"/2021/%E6%A1%86%E6%9E%B6/springmvc/springmvc%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B%E6%95%B0%E6%8D%AE/","content":"<h2 id=\"springmvc处理模型数据\"><a href=\"#springmvc处理模型数据\" class=\"headerlink\" title=\"springmvc处理模型数据\"></a>springmvc处理模型数据</h2><p>很多情况下页面上需要很多数据，单单返回页面是不行的，那么springmvc如何将数据返回到该页面呢</p>\n<p>springmvc提供了四种方式来输出模型数据</p>\n<ul>\n<li>ModelAndView: 处理返回值为ModelAndView时，可以将该对象中添加数据模型</li>\n<li>Map及Model：入参为Model、ModelMap或Map时，处理方法返回时，Map中的数据会自动添加到模型中</li>\n<li>@SessionAttributes: 将模型中的某个属性暂存到HttpSession中，以便多个请求之间共享数据</li>\n<li>@ModelAttribute: 方法入参标注该注解后，入参的对象就会放到数据模型中</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"ModelAndView\"><a href=\"#ModelAndView\" class=\"headerlink\" title=\"ModelAndView\"></a>ModelAndView</h3><p>主要有两个重要的变量</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 视图  可以传字符串(视图名字)也可以传View对象</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> Object view;</span><br><span class=\"line\"><span class=\"comment\">// 数据模型 本质是一个map</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> ModelMap model;</span><br></pre></td></tr></table></figure>\n\n<p>视图相关的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 设置视图</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setViewName</span><span class=\"params\">(String viewName)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.view = viewName;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// 获取视图</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getViewName</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.view <span class=\"keyword\">instanceof</span> String ? (String)<span class=\"keyword\">this</span>.view : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>数据模型相关方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 获取数据模型</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> Map&lt;String, Object&gt; <span class=\"title\">getModelInternal</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.model;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> ModelMap <span class=\"title\">getModelMap</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.model == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.model = <span class=\"keyword\">new</span> ModelMap();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.model;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Map&lt;String, Object&gt; <span class=\"title\">getModel</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.getModelMap();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 添加视图模型</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> ModelAndView <span class=\"title\">addObject</span><span class=\"params\">(String attributeName, Object attributeValue)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.getModelMap().addAttribute(attributeName, attributeValue);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>springmvc底层使用request.setAttribute(name,value)来将数据放入到请求中</p>\n<p>示例：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/modelAndViewTest&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> ModelAndView <span class=\"title\">modelAndViewTest</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 视图名</span></span><br><span class=\"line\">    ModelAndView modelAndView = <span class=\"keyword\">new</span> ModelAndView(<span class=\"string\">&quot;modelAndViewTest&quot;</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 包含的数据</span></span><br><span class=\"line\">    modelAndView.addObject(<span class=\"string\">&quot;dateTime&quot;</span>,<span class=\"keyword\">new</span> Date());</span><br><span class=\"line\">    <span class=\"keyword\">return</span> modelAndView;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Map及Model\"><a href=\"#Map及Model\" class=\"headerlink\" title=\"Map及Model\"></a>Map及Model</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/mapTest&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">mapTest</span><span class=\"params\">(Map&lt;String,String&gt; map)</span></span>&#123;</span><br><span class=\"line\">    System.out.println(map.getClass()); <span class=\"comment\">//class org.springframework.validation.support.BindingAwareModelMap</span></span><br><span class=\"line\">    map.put(<span class=\"string\">&quot;name&quot;</span>,<span class=\"string\">&quot;张三&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;hello&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"SessionAttributes\"><a href=\"#SessionAttributes\" class=\"headerlink\" title=\"@SessionAttributes\"></a>@SessionAttributes</h3><p>在类上添加@SessionAttributes可以使该类所代表的路径下的session共享</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;helloWorld&quot;)</span></span><br><span class=\"line\"><span class=\"comment\">// 设置name属性共享</span></span><br><span class=\"line\"><span class=\"meta\">@SessionAttributes(value=&#123;&quot;name&quot;&#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HelloWorldController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/mapTest&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">mapTest</span><span class=\"params\">(Map&lt;String,String&gt; map)</span></span>&#123;</span><br><span class=\"line\">        System.out.println(map.getClass()); <span class=\"comment\">//class org.springframework.validation.support.BindingAwareModelMap</span></span><br><span class=\"line\">        map.put(<span class=\"string\">&quot;name&quot;</span>,<span class=\"string\">&quot;张三&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;hello&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 可以在该方法中获取到name值为张三</span></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/sessionAttributes&quot;)</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">sessionAttributes</span><span class=\"params\">(HttpSession session)</span></span>&#123;</span><br><span class=\"line\">        System.out.println(session.getAttribute(<span class=\"string\">&quot;name&quot;</span>));</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;hello&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ModelAttribute\"><a href=\"#ModelAttribute\" class=\"headerlink\" title=\"@ModelAttribute\"></a>@ModelAttribute</h3>","categories":["springmvc"],"tags":["springmvc"]},{"title":"springmvc异常处理","url":"/2021/%E6%A1%86%E6%9E%B6/springmvc/springmvc%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/","content":"<h2 id=\"springmvc异常处理\"><a href=\"#springmvc异常处理\" class=\"headerlink\" title=\"springmvc异常处理\"></a>springmvc异常处理</h2><p>springmvc通过HandlerExceptionResolver来处理程序的异常</p>\n<p>一般情况下使用@ExceptionHandler注解来进行标注异常处理</p>\n<a id=\"more\"></a>\n\n<h3 id=\"ExceptionHandlerExceptionResolver异常处理\"><a href=\"#ExceptionHandlerExceptionResolver异常处理\" class=\"headerlink\" title=\"ExceptionHandlerExceptionResolver异常处理\"></a>ExceptionHandlerExceptionResolver异常处理</h3><ul>\n<li>如果出现异常，先是查找该Controller中用@ExceptionHandler注解定义的方法</li>\n<li>如果没有找到@ExceptionHandler注解的话，就会寻找标记了@ControllerAdvice注解的类中的@ExceptionHandler注解方法</li>\n</ul>\n<h4 id=\"局部异常处理\"><a href=\"#局部异常处理\" class=\"headerlink\" title=\"局部异常处理\"></a>局部异常处理</h4><p>在当前Controller中处理异常(当前Controller中使用@ExceptionHandler标注的方法)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span></span><br><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/exception&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExceptionController</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">  * 在<span class=\"doctag\">@Controller</span>中所写的<span class=\"doctag\">@ExceptionHandler</span>方法只能处理该Controller类中出现的异常，不可以处理其他Controller中出现的异常，此为局部异常处理</span></span><br><span class=\"line\"><span class=\"comment\">  */</span></span><br><span class=\"line\">    <span class=\"meta\">@ExceptionHandler</span></span><br><span class=\"line\">    <span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">exception</span><span class=\"params\">(Exception e)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;出现异常&quot;</span>+e.getMessage();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@RequestMapping(&quot;/testException&quot;)</span></span><br><span class=\"line\">    <span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">testException</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        User user = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        System.out.println(user.getId());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;success&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"全局异常处理\"><a href=\"#全局异常处理\" class=\"headerlink\" title=\"全局异常处理\"></a>全局异常处理</h4><p>如果当前Controller中没有异常处理，则会使用全局异常(使用@ControllerAdvice标注的类中的@ExceptionHandler方法)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ControllerAdvice</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GlobalExceptionHandler</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@ExceptionHandler</span></span><br><span class=\"line\">    <span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">exception</span><span class=\"params\">(Exception e)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;全局捕获: 出现异常&quot;</span>+e.getMessage();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ResponseStatusExceptionResolver异常处理\"><a href=\"#ResponseStatusExceptionResolver异常处理\" class=\"headerlink\" title=\"ResponseStatusExceptionResolver异常处理\"></a>ResponseStatusExceptionResolver异常处理</h3><p>该异常处理机制是来解析@ResponseStatus来标注的异常</p>\n<p>自定义异常</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// code指定的是状态码，reason指定的是错误信息</span></span><br><span class=\"line\"><span class=\"meta\">@ResponseStatus(code = HttpStatus.BAD_REQUEST,reason = &quot;出现业务异常&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BusinessException</span> <span class=\"keyword\">extends</span> <span class=\"title\">RuntimeException</span></span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/testBusinessException&quot;)</span></span><br><span class=\"line\"><span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">testBusinessException</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BusinessException();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>调用该接口就会返回到状态码为400的错误页面</p>\n","categories":["springmvc"],"tags":["springmvc"]},{"title":"springmvc核心流程及配置","url":"/2020/%E6%A1%86%E6%9E%B6/springmvc/springmvc%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B%E5%8F%8A%E9%85%8D%E7%BD%AE/","content":"<h2 id=\"核心流程及配置\"><a href=\"#核心流程及配置\" class=\"headerlink\" title=\"核心流程及配置\"></a>核心流程及配置</h2><h3 id=\"核心流程\"><a href=\"#核心流程\" class=\"headerlink\" title=\"核心流程\"></a>核心流程</h3><a id=\"more\"></a>\n\n<ul>\n<li><p>首先用户发送请求——–&gt;DispatcherServlet，前端控制器收到请求后自己不进行处理，而是委托给其他的解析器进行处理，作为同一访问点，进行全局的流程控制</p>\n</li>\n<li><p>DispatcherServlet———&gt;HandlerMapping，HandlerMapping将会把请求映射为HandlerExecutionChain对象(包含一个Handler处理器对象、多个HandlerInterceptor拦截器)，通过策略模式，很容易添加新的映射策略</p>\n</li>\n<li><p>DispatcherServlet———-&gt;HandlerAdapter，HandlerAdapter将会把处理器包装为适配器，从而支持多种类型的处理器，即适配设计模式的应用，从而很容易支持很多类型的处理器</p>\n</li>\n<li><p>HandlerAdapter————-&gt;处理器功能处理方法的调用，HandlerAdapter将会根据适配的结果调用真正的处理器的功能处理方法，完成功能处理，并返回一个ModelAndView对象</p>\n</li>\n<li><p>ModelAndView的逻辑视图名——–&gt;ViewResolver，ViewResolver将把逻辑视图解析为具体的View，通过这种策略模式，很容易更换其他视图技术</p>\n</li>\n<li><p>View——&gt;渲染，View会根据传进来的Model模型进行渲染，此处的Model实际是一个Map</p>\n</li>\n<li><p>返回控制权给DispatcherServlet，有DispatcherServlet返回响应给用户</p>\n</li>\n</ul>\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><h4 id=\"DispatcherServlet\"><a href=\"#DispatcherServlet\" class=\"headerlink\" title=\"DispatcherServlet\"></a>DispatcherServlet</h4><p>DispatcherServlet充当SpringMVC的前端控制器。与其他Servlet一样，DispatcherServlet必须在Web应用程序的web.xml文件中进行配置</p>\n<p>web.xml配置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- springmvc会过滤掉.html的 导致视图解析器无法找到</span></span><br><span class=\"line\"><span class=\"comment\">     如果只是使用jsp资源而未使用html的话可以不配置该项</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>default<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>*.html<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 配置DispatcherServlet --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>DispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-class</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 初始化参数：配置Springmvc配置文件的位置和名称</span></span><br><span class=\"line\"><span class=\"comment\">        默认配置文件为：/WEB-INF/&lt;servlet-name&gt;-servlet.xml</span></span><br><span class=\"line\"><span class=\"comment\">  --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-name</span>&gt;</span>contextConfigLocation<span class=\"tag\">&lt;/<span class=\"name\">param-name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">param-value</span>&gt;</span>classpath:springmvc.xml<span class=\"tag\">&lt;/<span class=\"name\">param-value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">init-param</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">load-on-startup</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">load-on-startup</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">servlet-name</span>&gt;</span>DispatcherServlet<span class=\"tag\">&lt;/<span class=\"name\">servlet-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">servlet-mapping</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 处理静态资源 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:resources</span> <span class=\"attr\">mapping</span>=<span class=\"string\">&quot;/images/**&quot;</span> <span class=\"attr\">location</span>=<span class=\"string\">&quot;/images/&quot;</span> <span class=\"attr\">cache-period</span>=<span class=\"string\">&quot;31556926&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">mvc:resources</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:resources</span> <span class=\"attr\">mapping</span>=<span class=\"string\">&quot;/js/**&quot;</span> <span class=\"attr\">location</span>=<span class=\"string\">&quot;/js/&quot;</span> <span class=\"attr\">cache-period</span>=<span class=\"string\">&quot;31556926&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">mvc:resources</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:resources</span> <span class=\"attr\">mapping</span>=<span class=\"string\">&quot;/css/**&quot;</span> <span class=\"attr\">location</span>=<span class=\"string\">&quot;/css/&quot;</span> <span class=\"attr\">cache-period</span>=<span class=\"string\">&quot;31556926&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">mvc:resources</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"静态资源请求问题\"><a href=\"#静态资源请求问题\" class=\"headerlink\" title=\"静态资源请求问题\"></a>静态资源请求问题</h5><p>因为DispatcherServlet的<url-pattern>配置的是/，针对的是所有请求，所以对于一些的静态资源(如.js、.css)等也会经过DispatcherServlet，但是DispatcherServlet是处理动态请求的，无法处理静态资源</url-pattern></p>\n<p>配置&lt;mvc:default-servlet-handler/&gt;来解决，作用是处理静态资源，将在SpringMVC上下文中定义一个DefaultServletHttpRequestHandler,会对进行DispatcherServlet的请求进行筛选，如果发现是没有经过映射的请求，就将请求交给WEB服务器默认的Servlet来处理，否则交由DispatcherServlet来处理</p>\n<p>default-servlet-name默认是default，如果不是default需要显式的进行配置(看所使用的web服务器，tomcat是default</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:default-servlet-handler</span> <span class=\"attr\">default-servlet-name</span>=<span class=\"string\">&quot;default&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>需要注意的是，配置了&lt;mvc:default-servlet-handler/&gt;之后，@RequestMapping的映射会失效，需要加上&lt;mvc:annotation-driven/&gt;配置</p>\n</blockquote>\n<h4 id=\"HandlerMapping\"><a href=\"#HandlerMapping\" class=\"headerlink\" title=\"HandlerMapping\"></a>HandlerMapping</h4><p>spring自带了多个处理器映射实现</p>\n<ul>\n<li><p>BeanNameUrlHandlerMapping  根据控制器Bean的名字将控制器映射到URL</p>\n</li>\n<li><p>ControllerBeanNameHandlerMapping  与BeanNameUrlHandlerMapping类似</p>\n</li>\n<li><p>ControllerClassNameHandlerMapping  通过使用控制器的类名作为URL基础将控制器映射到URL</p>\n</li>\n<li><p>DefaultAnnotationHandlerMapping  将请求映射给使用@RequestMapping注解的控制器和控制器方法</p>\n</li>\n<li><p>SImplerUrlHandlerMapping  使用定义在Spring应用上下文的集合将控制器映射到URL</p>\n</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 开启注解 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:annotation-driven</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;defaultAnnotationHandlerMapping&quot;</span>              <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"mvc-annotation-driven配置的作用\"><a href=\"#mvc-annotation-driven配置的作用\" class=\"headerlink\" title=\"mvc:annotation-driven配置的作用\"></a>mvc:annotation-driven配置的作用</h5><ul>\n<li>&lt;mvc:annotation-driven/&gt;会自动注册RequestMappingHandlerMapping、RequestMappingHandlerAdater、ExceptionHandlerExceptionResolver三个bean</li>\n<li>支持使用ConversionService实例对表单参数进行类型转换</li>\n<li>支持使用@NumberFormatannotation、@DataTimeFormat注解完成数据类型的格式化</li>\n<li>支持使用@Vaild注解对JavaBean实例进行JSR 303验证</li>\n<li>支持使用@RequestBody和@ResponseBody注解</li>\n</ul>\n<h4 id=\"HandlerAdapter\"><a href=\"#HandlerAdapter\" class=\"headerlink\" title=\"HandlerAdapter\"></a>HandlerAdapter</h4>  <figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;annotationMethodHandlerAdapter&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"配置视图\"><a href=\"#配置视图\" class=\"headerlink\" title=\"配置视图\"></a>配置视图</h4><p>InternalResourceViewResolver将逻辑视图名称解析为View对象，架构该对象渲染的任务委托给Web应用程序上下文的一个模板</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 配置视图解析器，将ModelAndView及字符串解析为具体的页面 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;viewClass&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;org.springframework.web.servlet.view.JstlView&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;prefix&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;/WEB-INF/jsp/&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;suffix&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;.jsp&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n\n","categories":["springmvc"],"tags":["springmvc"]},{"title":"springmvc注解的使用","url":"/2021/%E6%A1%86%E6%9E%B6/springmvc/springmvc%E6%B3%A8%E8%A7%A3%E7%9A%84%E4%BD%BF%E7%94%A8/","content":"<h2 id=\"springmvc注解的使用\"><a href=\"#springmvc注解的使用\" class=\"headerlink\" title=\"springmvc注解的使用\"></a>springmvc注解的使用</h2><h3 id=\"RequestMapping\"><a href=\"#RequestMapping\" class=\"headerlink\" title=\"@RequestMapping\"></a>@RequestMapping</h3><p>地址映射，可以用在类和方法上</p>\n<a id=\"more\"></a>\n\n<h3 id=\"PathVariable\"><a href=\"#PathVariable\" class=\"headerlink\" title=\"@PathVariable\"></a>@PathVariable</h3><p>基于REST风格的API，可以在URI地址上拼接参数</p>\n<p>如：get/{id}        </p>\n<p>@PathVariable中的value值要设置为和地址栏中一致，如@PathVariable(“id”)</p>\n<h3 id=\"RequestParam\"><a href=\"#RequestParam\" class=\"headerlink\" title=\"@RequestParam\"></a>@RequestParam</h3><p>可以接收拼接在地址栏中的参数</p>\n<p>如: get?id=1&amp;name=张三</p>\n<p>@RequestParam(“id”) int id,@RequestParam(“name”) String name</p>\n<h3 id=\"RequestHeader\"><a href=\"#RequestHeader\" class=\"headerlink\" title=\"@RequestHeader\"></a>@RequestHeader</h3><p>可以获取请求头参数</p>\n<h3 id=\"CookieValue\"><a href=\"#CookieValue\" class=\"headerlink\" title=\"@CookieValue\"></a>@CookieValue</h3><p>可以绑定请求中的cookie值</p>\n<p>@CookieValue(“JSESSIONID”) String sessionId</p>\n<h3 id=\"SessionAttribute\"><a href=\"#SessionAttribute\" class=\"headerlink\" title=\"@SessionAttribute\"></a>@SessionAttribute</h3>","categories":["springmvc"],"tags":["springmvc"]},{"title":"springmvc返回json","url":"/2021/%E6%A1%86%E6%9E%B6/springmvc/springmvc%E8%BF%94%E5%9B%9Ejson/","content":"<h2 id=\"springmvc返回json\"><a href=\"#springmvc返回json\" class=\"headerlink\" title=\"springmvc返回json\"></a>springmvc返回json</h2><p>现在很多项目已经前后端分离了，不再使用jsp或者使用jsp但是数据使用ajax来获取，实现局部刷新的效果，那么springmvc中如何不返回页面而返回页面所需要的数据呢。</p>\n<p>前后端数据交互现在大多使用json来表示(当然有一部分还是使用xml的)，那如何在springmvc中返回json数据呢。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"返回json\"><a href=\"#返回json\" class=\"headerlink\" title=\"返回json\"></a>返回json</h3><h4 id=\"依赖\"><a href=\"#依赖\" class=\"headerlink\" title=\"依赖\"></a>依赖</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>jackson-databind<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.11.3<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"接口层面的改动\"><a href=\"#接口层面的改动\" class=\"headerlink\" title=\"接口层面的改动\"></a>接口层面的改动</h4><p>在controller返回时不再返回ModelAndView，而是返回具体的数据对象，在方法上添加@ResponseBody注解</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@ResponseBody</span></span><br><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/testJson&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> User <span class=\"title\">testJson</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    User user = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">    user.setName(<span class=\"string\">&quot;张三&quot;</span>);</span><br><span class=\"line\">    user.setId(<span class=\"number\">2</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> user;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Why\"><a href=\"#Why\" class=\"headerlink\" title=\"Why?\"></a>Why?</h4><p>为什么只是加了一个依赖，加一个注解就可以完成返回json数据呢。</p>\n<p>这里用到了一个接口，HttpMessageConverter接口，该接口可以将请求信息转为所对应的入参，将返回结果转为对应类型的响应信息</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">HttpMessageConverter</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">canRead</span><span class=\"params\">(Class&lt;?&gt; var1, MediaType var2)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">canWrite</span><span class=\"params\">(Class&lt;?&gt; var1, MediaType var2)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">List&lt;MediaType&gt; <span class=\"title\">getSupportedMediaTypes</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">T <span class=\"title\">read</span><span class=\"params\">(Class&lt;? extends T&gt; var1, HttpInputMessage var2)</span> <span class=\"keyword\">throws</span> IOException, HttpMessageNotReadableException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">write</span><span class=\"params\">(T var1, MediaType var2, HttpOutputMessage var3)</span> <span class=\"keyword\">throws</span> IOException, HttpMessageNotWritableException</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>spring提供了两种方式</p>\n<ul>\n<li>使用@RequestBody或@ResponseBody对处理的方法进行处理</li>\n<li>使用HttpEntity/ResponseEntity作为方法的入参或返回值</li>\n</ul>\n","categories":["springmvc"],"tags":["springmvc"]},{"title":"spring与springmvc整合","url":"/2021/%E6%A1%86%E6%9E%B6/springmvc/spring%E4%B8%8Espringmvc%E6%95%B4%E5%90%88/","content":"<h2 id=\"spring与springmvc整合\"><a href=\"#spring与springmvc整合\" class=\"headerlink\" title=\"spring与springmvc整合\"></a>spring与springmvc整合</h2><p>在项目中使用springmvc的时候，由于spring和springmvc是同源的，有时候大家会把所有的配置都扔到springmvc的配置文件中，而不去区分spring和springmvc的配置，而我习惯于把两个配置拆分开来，spring来配置数据源、事务以及和其他框架的整合，springmvc来配置web相关的一些配置。</p>\n<p>在这里给大家说明一下两者配置整合时可能会遇到的一些问题</p>\n<a id=\"more\"></a>\n\n<p>之前在 web应用使用spring  一节中说过如何在web应用中加载spring容器，使用的是是监听器，这里就不赘述了，可以去搜一下之前的文章</p>\n<h3 id=\"重复创建bean\"><a href=\"#重复创建bean\" class=\"headerlink\" title=\"重复创建bean\"></a>重复创建bean</h3><p>当springmvc的配置文件和spring的配置文件分离的时候，由于现在使用注解的比较多，大多都是用组件扫描，</p>\n<p>如果两个配置文件都使用&lt;context:component-scan base-package=”com.zhanghe.study.springmvc”/&gt;来进行组件扫描的话，会导致两个配置文件都扫一遍这些组件，这些bean都会创建两次</p>\n<p>这时候就用到了&lt;context:exclude-filter&gt;和&lt;context:include-filter&gt;来进行设置过滤了</p>\n<p>springmvc只需要管控制器Controller就可以了，所以在springmvc的配置文件中配置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">context:component-scan</span> <span class=\"attr\">base-package</span>=<span class=\"string\">&quot;com.zhanghe.study.springmvc&quot;</span> <span class=\"attr\">use-default-filters</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">context:include-filter</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;annotation&quot;</span> <span class=\"attr\">expression</span>=<span class=\"string\">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>而spring的配置文件中只需要相应的排除掉springmvc扫描的</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">context:component-scan</span> <span class=\"attr\">base-package</span>=<span class=\"string\">&quot;com.zhanghe.study.springmvc&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">context:exclude-filter</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;annotation&quot;</span> <span class=\"attr\">expression</span>=<span class=\"string\">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"容器关系\"><a href=\"#容器关系\" class=\"headerlink\" title=\"容器关系\"></a>容器关系</h3><p>springmvc容器是spring容器的子容器，springmvc容器可以访问spring容器中的bean，反之则不行</p>\n<h3 id=\"获取spring容器上下文\"><a href=\"#获取spring容器上下文\" class=\"headerlink\" title=\"获取spring容器上下文\"></a>获取spring容器上下文</h3><p>在项目启动的时候，监听器中会在web应用环境初始化的时候将spring的上下文内容存在应用上下文中</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">servletContext.setAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class=\"keyword\">this</span>.context);</span><br></pre></td></tr></table></figure>\n\n<p>所以在取出来时只需要获取到应用上下文</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">req.getServletContext()</span><br></pre></td></tr></table></figure>\n\n<p>然后取出来即可</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">context.getAttribute(WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE)</span><br></pre></td></tr></table></figure>\n\n","categories":["springmvc"],"tags":["springmvc"]},{"title":"拦截器","url":"/2021/%E6%A1%86%E6%9E%B6/springmvc/%E6%8B%A6%E6%88%AA%E5%99%A8/","content":"<h2 id=\"springmvc拦截器\"><a href=\"#springmvc拦截器\" class=\"headerlink\" title=\"springmvc拦截器\"></a>springmvc拦截器</h2><h3 id=\"拦截器的使用\"><a href=\"#拦截器的使用\" class=\"headerlink\" title=\"拦截器的使用\"></a>拦截器的使用</h3><p>在springmvc中使用拦截器，对请求进行拦截处理首先需要实现HandlerInterceptor接口，然后重写该接口中的三个方法</p>\n<p>也可以继承HandlerInterceptorAdapter类来重写某个方法</p>\n<blockquote>\n<p>注意：拦截器是springmvc提供的功能，过滤器是javaee中提供的原生功能，过滤器在DispatcherServlet之前执行，拦截器在DispatcherServlet之后执行</p>\n</blockquote>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">HandlerInterceptor</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 目标方法之前调用</span></span><br><span class=\"line\"><span class=\"comment\">     * 如果返回值为false，则直接返回，不会调用目标方法</span></span><br><span class=\"line\"><span class=\"comment\">     * 如果返回值为true，则继续调用后续拦截器或者目标方法</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * 作用：权限、日志</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">preHandle</span><span class=\"params\">(HttpServletRequest var1, HttpServletResponse var2, Object var3)</span> <span class=\"keyword\">throws</span> Exception</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 调用目标方法之后执行</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * 作用：修改请求域中的属性做修改</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">postHandle</span><span class=\"params\">(HttpServletRequest var1, HttpServletResponse var2, Object var3, ModelAndView var4)</span> <span class=\"keyword\">throws</span> Exception</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 渲染视图之后调用</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * 作用：释放资源</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">afterCompletion</span><span class=\"params\">(HttpServletRequest var1, HttpServletResponse var2, Object var3, Exception var4)</span> <span class=\"keyword\">throws</span> Exception</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>然后在配置文件中配置所编写的拦截器</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:interceptors</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mvc:interceptor</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mvc:mapping</span> <span class=\"attr\">path</span>=<span class=\"string\">&quot;/**&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.springmvc.interceptor.TestInterceptor&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">mvc:interceptor</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mvc:interceptors</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"拦截器执行顺序\"><a href=\"#拦截器执行顺序\" class=\"headerlink\" title=\"拦截器执行顺序\"></a>拦截器执行顺序</h3><p>对于preHandler方法，是按照拦截器配置的顺序执行的</p>\n<p>而对于postHadler方法和afterCompletion方法，是按照拦截器配置的反序执行</p>\n","categories":["springmvc"],"tags":["springmvc"]},{"title":"数据绑定","url":"/2021/%E6%A1%86%E6%9E%B6/springmvc/%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A/","content":"<h2 id=\"数据绑定\"><a href=\"#数据绑定\" class=\"headerlink\" title=\"数据绑定\"></a>数据绑定</h2><h3 id=\"数据绑定流程\"><a href=\"#数据绑定流程\" class=\"headerlink\" title=\"数据绑定流程\"></a>数据绑定流程</h3><ul>\n<li>springmvc框架将ServletRequest对象及目标方法的入参实例传递给WebDataBinderFactory实例，以创建DataBinder实例对象</li>\n<li>DataBinder调用装配在springmvc上下文中的ConversionService组件进行数据类型转换、数据格式化工作。将Servlet中的请求信息填充到入参对象中</li>\n<li>调用Vaildator组件对已经绑定了请求消息的入参对象进行数据合法性检验，并最终生成数据绑定结果BindingData对象</li>\n<li>springmvc抽取BindingResult中的入参对象和校验错误对象，将他们赋给处理方法的响应入参</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"自定义类型转换器\"><a href=\"#自定义类型转换器\" class=\"headerlink\" title=\"自定义类型转换器\"></a>自定义类型转换器</h3><p>可通过ConversionServiceFactoryBean的converters属性注册自定义的类型转换器</p>\n<p>可以使用三种方式实现自定义类型转换器</p>\n<ul>\n<li><p>实现Converter&lt;S, T&gt;接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Converter</span>&lt;<span class=\"title\">S</span>, <span class=\"title\">T</span>&gt; </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 将S类型转为T类型</span></span><br><span class=\"line\">    <span class=\"function\">T <span class=\"title\">convert</span><span class=\"params\">(S var1)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li></li>\n<li></li>\n</ul>\n<h4 id=\"实现Converter-lt-S-T-gt-接口\"><a href=\"#实现Converter-lt-S-T-gt-接口\" class=\"headerlink\" title=\"实现Converter&lt;S, T&gt;接口\"></a>实现Converter&lt;S, T&gt;接口</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UserConverter</span> <span class=\"keyword\">implements</span> <span class=\"title\">Converter</span>&lt;<span class=\"title\">String</span>, <span class=\"title\">User</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> User <span class=\"title\">convert</span><span class=\"params\">(String s)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 规则为每个字段使用:分隔,如果字段为null，将null拼入串中(规则可以与前端定  这里就举个例子)</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(s != <span class=\"keyword\">null</span> &amp;&amp; !<span class=\"string\">&quot;&quot;</span>.equals(s))&#123;</span><br><span class=\"line\">            String[] values = s.split(<span class=\"string\">&quot;:&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(values != <span class=\"keyword\">null</span> &amp;&amp; values.length &gt; <span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">                User user = <span class=\"keyword\">new</span> User();</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(<span class=\"string\">&quot;null&quot;</span>.equals(values[<span class=\"number\">0</span>]))&#123;</span><br><span class=\"line\">                    user.setId(<span class=\"number\">0</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    user.setId(Integer.parseInt(values[<span class=\"number\">0</span>]));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span>(<span class=\"string\">&quot;null&quot;</span>.equals(values[<span class=\"number\">1</span>]))&#123;</span><br><span class=\"line\">                    user.setName(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    user.setName(values[<span class=\"number\">1</span>]);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> user;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 配置自定义类型转换器 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">bean</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;conversionService&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.springframework.context.support.ConversionServiceFactoryBean&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;converters&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">ref</span> <span class=\"attr\">bean</span>=<span class=\"string\">&quot;userConverter&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">list</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">bean</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mvc:annotation-driven</span> <span class=\"attr\">conversion-service</span>=<span class=\"string\">&quot;conversionService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@RequestMapping(&quot;/testConverter&quot;)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">testConverter</span><span class=\"params\">(User user)</span></span>&#123;</span><br><span class=\"line\">    System.out.println(user);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">&quot;hello&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":["springmvc"],"tags":["springmvc"]},{"title":"OGNL","url":"/2020/%E6%A1%86%E6%9E%B6/struts/OGNL/","content":"<h2 id=\"OGNL\"><a href=\"#OGNL\" class=\"headerlink\" title=\"OGNL\"></a>OGNL</h2><h3 id=\"值栈\"><a href=\"#值栈\" class=\"headerlink\" title=\"值栈\"></a>值栈</h3><p>ValueStack(值栈)：贯穿了整个Action生命周期(每个Action类的对象实例都有一个ValueStack对象)，保存了当前Action对象和其他相关对象，Struts框架将ValueStack对象保存在”struts.valueStack”的请求属性中</p>\n","categories":["struts"],"tags":["struts2"]},{"title":"result-types介绍","url":"/2020/%E6%A1%86%E6%9E%B6/struts/result-types%E4%BB%8B%E7%BB%8D/","content":"<h2 id=\"result-types介绍\"><a href=\"#result-types介绍\" class=\"headerlink\" title=\"result-types介绍\"></a>result-types介绍</h2><p>在配置struts.xml文件中，需要配置一个一个的action，而result是action的子节点，action节点中有name和type两个属性</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;helloworld&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">        result  结果，表示action执行之后可能返回的一个结果，一个action节点可能会有多个result子节点，使用name进行区分</span></span><br><span class=\"line\"><span class=\"comment\">        name：标识一个result，默认为success</span></span><br><span class=\"line\"><span class=\"comment\">        type: 结果类型  默认dispatcher</span></span><br><span class=\"line\"><span class=\"comment\">            &lt;result-types&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;chain&quot; class=&quot;com.opensymphony.xwork2.ActionChainResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;dispatcher&quot; class=&quot;org.apache.struts2.result.ServletDispatcherResult&quot; default=&quot;true&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;freemarker&quot; class=&quot;org.apache.struts2.views.freemarker.FreemarkerResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;httpheader&quot; class=&quot;org.apache.struts2.result.HttpHeaderResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;redirect&quot; class=&quot;org.apache.struts2.result.ServletRedirectResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;redirectAction&quot; class=&quot;org.apache.struts2.result.ServletActionRedirectResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;stream&quot; class=&quot;org.apache.struts2.result.StreamResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;velocity&quot; class=&quot;org.apache.struts2.result.VelocityResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;xslt&quot; class=&quot;org.apache.struts2.views.xslt.XSLTResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;plainText&quot; class=&quot;org.apache.struts2.result.PlainTextResult&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                &lt;result-type name=&quot;postback&quot; class=&quot;org.apache.struts2.result.PostbackResult&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">            &lt;/result-types&gt;</span></span><br><span class=\"line\"><span class=\"comment\">     --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">result</span>&gt;</span>/pages/helloworld.html<span class=\"tag\">&lt;/<span class=\"name\">result</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">action</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>result的type在struts-default.xml的result-types节点中进行定义的</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">result-types</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;chain&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.opensymphony.xwork2.ActionChainResult&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;dispatcher&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.struts2.result.ServletDispatcherResult&quot;</span> <span class=\"attr\">default</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;freemarker&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.struts2.views.freemarker.FreemarkerResult&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;httpheader&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.struts2.result.HttpHeaderResult&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;redirect&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.struts2.result.ServletRedirectResult&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;redirectAction&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.struts2.result.ServletActionRedirectResult&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;stream&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.struts2.result.StreamResult&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;velocity&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.struts2.result.VelocityResult&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;xslt&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.struts2.views.xslt.XSLTResult&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;plainText&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.struts2.result.PlainTextResult&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">result-type</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;postback&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;org.apache.struts2.result.PostbackResult&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">result-types</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>常用的有</p>\n<ul>\n<li>dispatcher(默认)  转发(不能转发到action)</li>\n<li>redirect 重定向(也可以重定向到action)</li>\n<li>redirectAction  重定向到action</li>\n<li>chain 转发到action</li>\n</ul>\n","categories":["struts"],"tags":["struts2"]},{"title":"struts2工作流程","url":"/2020/%E6%A1%86%E6%9E%B6/struts/struts2%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B/","content":"<h2 id=\"Struts2工作流程\"><a href=\"#Struts2工作流程\" class=\"headerlink\" title=\"Struts2工作流程\"></a>Struts2工作流程</h2><ul>\n<li>struts2根据请求匹配相应的配置，得到使用哪些拦截器，Action类和返回结果的信息</li>\n<li>请求通过一系列的拦截器为请求提供各种预处理和切面处理</li>\n<li>调用Action-产生一个新的Action实例，并提供请求所调用的处理逻辑的方法。</li>\n<li>调用相应的Result-通过匹配处理Action方法之后的返回值，获取相应的Result类，生成并调用它的实例</li>\n<li>请求再次经过一系列拦截器返回</li>\n</ul>\n","categories":["struts"],"tags":["struts2"]},{"title":"struts2第一个示例","url":"/2020/%E6%A1%86%E6%9E%B6/struts/struts2%E7%AC%AC%E4%B8%80%E4%B8%AA%E7%A4%BA%E4%BE%8B/","content":"<h2 id=\"Struts2第一个示例\"><a href=\"#Struts2第一个示例\" class=\"headerlink\" title=\"Struts2第一个示例\"></a>Struts2第一个示例</h2><p>首先，导入struts核心包</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.struts<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>struts2-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.5.22<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>web.xml配置struts2拦截器</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 配置struts2的拦截器 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>struts2<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter<span class=\"tag\">&lt;/<span class=\"name\">filter-class</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">filter</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">filter-mapping</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">filter-name</span>&gt;</span>struts2<span class=\"tag\">&lt;/<span class=\"name\">filter-name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">url-pattern</span>&gt;</span>/*<span class=\"tag\">&lt;/<span class=\"name\">url-pattern</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>struts.xml中配置action</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"meta-keyword\">struts</span> <span class=\"meta-keyword\">PUBLIC</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;-//Apache Software Foundation//DTD Struts Configuration 2.0//EN&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">        <span class=\"meta-string\">&quot;http://struts.apache.org/dtds/struts-2.5.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">struts</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">        package 是struts的模块</span></span><br><span class=\"line\"><span class=\"comment\">        name  用于其他包应用当前包</span></span><br><span class=\"line\"><span class=\"comment\">        namespace  默认/  访问路径</span></span><br><span class=\"line\"><span class=\"comment\">        extends  继承的包，可以继承其中的所有的配置  通常继承struts-default</span></span><br><span class=\"line\"><span class=\"comment\">     --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--struts-default是在struts-core中的struts-default.xml中配置的package --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">package</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;helloWorld&quot;</span> <span class=\"attr\">namespace</span>=<span class=\"string\">&quot;/userAction&quot;</span> <span class=\"attr\">extends</span>=<span class=\"string\">&quot;struts-default&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 配置action   一个请求就是一个action</span></span><br><span class=\"line\"><span class=\"comment\">            name  对应请求名字</span></span><br><span class=\"line\"><span class=\"comment\">            class  默认值为  com.opensymphony.xwork2.ActionSupport</span></span><br><span class=\"line\"><span class=\"comment\">            method  默认值为 execute</span></span><br><span class=\"line\"><span class=\"comment\">                public String execute() throws Exception &#123;</span></span><br><span class=\"line\"><span class=\"comment\">                    return &quot;success&quot;;</span></span><br><span class=\"line\"><span class=\"comment\">                &#125;</span></span><br><span class=\"line\"><span class=\"comment\">            result  结果</span></span><br><span class=\"line\"><span class=\"comment\">        --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;helloworld&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">                result  结果，表示action执行之后可能返回的一个结果，一个action节点可能会有多个result子节点，使用name进行区分</span></span><br><span class=\"line\"><span class=\"comment\">                name：标识一个result，默认为success</span></span><br><span class=\"line\"><span class=\"comment\">                type: 结果类型  默认dispatcher</span></span><br><span class=\"line\"><span class=\"comment\">                    &lt;result-types&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;chain&quot; class=&quot;com.opensymphony.xwork2.ActionChainResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;dispatcher&quot; class=&quot;org.apache.struts2.result.ServletDispatcherResult&quot; default=&quot;true&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;freemarker&quot; class=&quot;org.apache.struts2.views.freemarker.FreemarkerResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;httpheader&quot; class=&quot;org.apache.struts2.result.HttpHeaderResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;redirect&quot; class=&quot;org.apache.struts2.result.ServletRedirectResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;redirectAction&quot; class=&quot;org.apache.struts2.result.ServletActionRedirectResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;stream&quot; class=&quot;org.apache.struts2.result.StreamResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;velocity&quot; class=&quot;org.apache.struts2.result.VelocityResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;xslt&quot; class=&quot;org.apache.struts2.views.xslt.XSLTResult&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;plainText&quot; class=&quot;org.apache.struts2.result.PlainTextResult&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                        &lt;result-type name=&quot;postback&quot; class=&quot;org.apache.struts2.result.PostbackResult&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">                    &lt;/result-types&gt;</span></span><br><span class=\"line\"><span class=\"comment\">             --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">result</span>&gt;</span>/pages/helloworld.html<span class=\"tag\">&lt;/<span class=\"name\">result</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">action</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;test&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.action.UserAction&quot;</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;test&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">result</span>&gt;</span>/pages/helloworld.html<span class=\"tag\">&lt;/<span class=\"name\">result</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">action</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">package</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">struts</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>创建Action类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * Action类：能够处理Struts2请求的类</span></span><br><span class=\"line\"><span class=\"comment\"> *  - 属性的名字必须遵守javabean属性名的命名规则</span></span><br><span class=\"line\"><span class=\"comment\"> *  - 必须有一个不带参的构造器 由于反射(action元素中的class属性会反射构造器生成对象)</span></span><br><span class=\"line\"><span class=\"comment\"> *  - 至少有一个供struts在执行这个action时调用的方法</span></span><br><span class=\"line\"><span class=\"comment\"> *  - 同一个Action类可以有多个action方法</span></span><br><span class=\"line\"><span class=\"comment\"> *  - Struts2会为每一个HTTP请求创建一个Action实例，Action不是单例的，线程安全</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> zh</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@date</span> 2020/12/21 14:51</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UserAction</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> User user;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> User <span class=\"title\">getUser</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> user;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setUser</span><span class=\"params\">(User user)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.user = user;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">test</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        System.out.println(user.getName());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;success&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>访问</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">http:&#x2F;&#x2F;localhost:8080&#x2F;struts&#x2F;userAction&#x2F;test.action?user.name&#x3D;张三</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["struts"],"tags":["struts2"]},{"title":"struts2访问web资源","url":"/2020/%E6%A1%86%E6%9E%B6/struts/%E8%AE%BF%E9%97%AEweb%E8%B5%84%E6%BA%90/","content":"<h2 id=\"Struts2访问web资源\"><a href=\"#Struts2访问web资源\" class=\"headerlink\" title=\"Struts2访问web资源\"></a>Struts2访问web资源</h2><p>有两种方式</p>\n<ul>\n<li>和Servlet Api解耦的方式  只能访问有限的Servlet Api对象(读取请求参数，读取域对象属性，使用session等)<ul>\n<li>使用ActionContext</li>\n<li>实现XxxAware</li>\n</ul>\n</li>\n<li>和Servlet Api耦合的方式，可以使用更多的Servlet Api对象，且可以调用原生方法<ul>\n<li>使用ServletActionContext</li>\n<li>实现ServletXxxAware接口</li>\n</ul>\n</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"解耦的方式\"><a href=\"#解耦的方式\" class=\"headerlink\" title=\"解耦的方式\"></a>解耦的方式</h3><h4 id=\"使用ActionContext\"><a href=\"#使用ActionContext\" class=\"headerlink\" title=\"使用ActionContext\"></a>使用ActionContext</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">ActionContext actionContext = ActionContext.getContext();</span><br><span class=\"line\"><span class=\"comment\">// 获取application对应的map</span></span><br><span class=\"line\">Map&lt;String,Object&gt; application = actionContext.getApplication();</span><br><span class=\"line\"><span class=\"comment\">// 获取seesion对应的map</span></span><br><span class=\"line\">Map&lt;String,Object&gt; session = actionContext.getSession();</span><br><span class=\"line\"><span class=\"comment\">// 获取request对应的map</span></span><br><span class=\"line\">Map&lt;String,Object&gt; request = (Map&lt;String, Object&gt;) actionContext.get(<span class=\"string\">&quot;reuqest&quot;</span>);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用XxxAware\"><a href=\"#使用XxxAware\" class=\"headerlink\" title=\"使用XxxAware\"></a>使用XxxAware</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestAwareAction</span> <span class=\"keyword\">implements</span> <span class=\"title\">ApplicationAware</span>, <span class=\"title\">SessionAware</span>, <span class=\"title\">RequestAware</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String,Object&gt; application;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String,Object&gt; session;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;String,Object&gt; request;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setApplication</span><span class=\"params\">(Map&lt;String, Object&gt; application)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.application = application;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setRequest</span><span class=\"params\">(Map&lt;String, Object&gt; request)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.request = request;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setSession</span><span class=\"params\">(Map&lt;String, Object&gt; session)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.session = session;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"耦合的方式\"><a href=\"#耦合的方式\" class=\"headerlink\" title=\"耦合的方式\"></a>耦合的方式</h3><h4 id=\"使用ServletActionContext\"><a href=\"#使用ServletActionContext\" class=\"headerlink\" title=\"使用ServletActionContext\"></a>使用ServletActionContext</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">HttpSession session = ServletActionContext.getRequest().getSession();</span><br><span class=\"line\"></span><br><span class=\"line\">HttpServletRequest request = ServletActionContext.getRequest();</span><br><span class=\"line\"></span><br><span class=\"line\">HttpServletResponse response = ServletActionContext.getResponse();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用ServletXxxAware\"><a href=\"#使用ServletXxxAware\" class=\"headerlink\" title=\"使用ServletXxxAware\"></a>使用ServletXxxAware</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestServletAwareAction</span> <span class=\"keyword\">implements</span> <span class=\"title\">ServletRequestAware</span>, <span class=\"title\">ServletResponseAware</span>, <span class=\"title\">ServletContextAware</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> HttpServletResponse httpServletResponse;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> HttpServletRequest httpServletRequest;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">private</span> ServletContext servletContext;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setServletRequest</span><span class=\"params\">(HttpServletRequest httpServletRequest)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.httpServletRequest = httpServletRequest;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setServletResponse</span><span class=\"params\">(HttpServletResponse httpServletResponse)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.httpServletResponse = httpServletResponse;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setServletContext</span><span class=\"params\">(ServletContext servletContext)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.servletContext = servletContext;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["struts"],"tags":["struts2"]},{"title":"JMS","url":"/2020/%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86/JMS/JMS/","content":"<h2 id=\"JMS\"><a href=\"#JMS\" class=\"headerlink\" title=\"JMS\"></a>JMS</h2><p>Java消息服务(JMS)定义了java中一组创建、发送、接收和读取消息的应用程序接口</p>\n<p>消息系统是用来为各个应用程序提供可靠的异步通信服务。解耦合性，发送方的请求发送到消息系统，再由消息系统转发给接收方。</p>\n<p>JMS支持两种消息类型PTP和Pub/Sub。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"JMS编程模型\"><a href=\"#JMS编程模型\" class=\"headerlink\" title=\"JMS编程模型\"></a>JMS编程模型</h3><p>一个基本的JMS程序主要由6部分构成</p>\n<ul>\n<li>系统管理对象(连接构造器，目标对象) Administered Objects</li>\n<li>连接对象(Connection)</li>\n<li>会话对象(Session)</li>\n<li>消息生产者(Message Producer)</li>\n<li>消息消费者(Message Consumer)</li>\n<li>消息对象(Message)</li>\n</ul>\n<h4 id=\"系统连接对象\"><a href=\"#系统连接对象\" class=\"headerlink\" title=\"系统连接对象\"></a>系统连接对象</h4><p>系统连接对象有两部分，连接构造器和目标对象。</p>\n<h5 id=\"连接构造器\"><a href=\"#连接构造器\" class=\"headerlink\" title=\"连接构造器\"></a>连接构造器</h5><p>连接构造器是客户端创建连接的对象，所有的连接构造器都是QueueConnectionFactory或TopicConnectionFactory接口的实例</p>\n<h5 id=\"目标对象\"><a href=\"#目标对象\" class=\"headerlink\" title=\"目标对象\"></a>目标对象</h5><p>目标对象是一个对象，客户程序用它指明客户端产生消息的目的地和消费消息的源头。PTP中为队列(queue)，pub/sub中为主题(topic)</p>\n<h4 id=\"连接对象\"><a href=\"#连接对象\" class=\"headerlink\" title=\"连接对象\"></a>连接对象</h4><p>连接对象封装了与JMS消息服务器的虚拟连接。一个连接对象包含了在客户端和服务端一个后台程序之间的打开的TCP/IP连接。</p>\n<p>获取到QueueConnectionFactory或TopicConnectionFactory之后，使用createConnection来创建连接</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">connectionFactory.createConnection()</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"会话对象\"><a href=\"#会话对象\" class=\"headerlink\" title=\"会话对象\"></a>会话对象</h4><p>会话对象是单线程上下文，可以用来创建消息生产者、消息消费者和消息。</p>\n<p>获取到Connection之后使用createQueueSession或createTopicSession来创建</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 第一个参数为是否支持事务处理，第二个参数表示是否自动确认消息</span></span><br><span class=\"line\">connection.createQueueSession(<span class=\"keyword\">false</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class=\"line\">connection.createTopicSession(<span class=\"keyword\">false</span>,Session.AUTO_ACKNOWLEDGE)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"消息生产者\"><a href=\"#消息生产者\" class=\"headerlink\" title=\"消息生产者\"></a>消息生产者</h4><p>消息生产者有会话对象创建，并发送消息到目标对象(queue或topic)，需要实现MessageProducer接口</p>\n<h4 id=\"消息消费者\"><a href=\"#消息消费者\" class=\"headerlink\" title=\"消息消费者\"></a>消息消费者</h4><p>消息消费者由会话对象创建，用来接收发送到目标对象的消息，需要实现MessageConsumer接口</p>\n<h4 id=\"消息监听者\"><a href=\"#消息监听者\" class=\"headerlink\" title=\"消息监听者\"></a>消息监听者</h4><p>消息监听者是异步消息事件的处理者，实现了MessageListener接口，该接口只有一个方法onMessage</p>\n<h4 id=\"消息\"><a href=\"#消息\" class=\"headerlink\" title=\"消息\"></a>消息</h4><p>消息主要由消息头，属性，消息体组成</p>\n<h3 id=\"PTP\"><a href=\"#PTP\" class=\"headerlink\" title=\"PTP\"></a>PTP</h3><p>PTP是点对点传输消息，建立在消息队列的基础上。每个客户端对应一个消息队列，客户端发送消息到对方的消息队列中，从自己的消息队列读取消息。</p>\n<h3 id=\"Pub-Sub\"><a href=\"#Pub-Sub\" class=\"headerlink\" title=\"Pub/Sub\"></a>Pub/Sub</h3><p>Pub/Sub将消息定位到某个层次结构栏目的节点上。必须保证某个节点的所有发布者(Publisher)发布的信息准确无误地发送大这个节点的所有消息订阅者(Subscriber)</p>\n","categories":["JMS"],"tags":["JMS"]},{"title":"MapReduce","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/hadoop/%E5%88%86/MapReduce/","content":"<h2 id=\"MapReduce\"><a href=\"#MapReduce\" class=\"headerlink\" title=\"MapReduce\"></a>MapReduce</h2><p>MapReduce是Hadoop中的计算部分，将计算分为了两个阶段：Map和Reduce</p>\n<ul>\n<li>Map阶段任务拆分并行处理输入数据</li>\n<li>Reduce阶段对Map结果进行汇总</li>\n</ul>\n<a id=\"more\"></a>","categories":["hadoop"],"tags":["hadoop"]},{"title":"HDFS","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/hadoop/%E5%88%86/HDFS/","content":"<h2 id=\"HDFS\"><a href=\"#HDFS\" class=\"headerlink\" title=\"HDFS\"></a>HDFS</h2><p>HDFS是Hadoop的数据存储部分，采用了主从（Master/Slave）结构模型，一个HDFS集群是由一个NameNode(nn)和若干个DataNode(dn)以及Secondary NameNode(2nn)组成的。其中NameNode作为主服务器，管理文件系统的命名空间和客户端对文件的访问操作；集群中的DataNode管理存储的数据。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"结构\"><a href=\"#结构\" class=\"headerlink\" title=\"结构\"></a>结构</h3><h4 id=\"NameNode\"><a href=\"#NameNode\" class=\"headerlink\" title=\"NameNode\"></a>NameNode</h4><p>NameNode是用来存储文件的元数据，如文件名，文件目录，文件属性，以及每个文件的块列表和块所在的DataNode</p>\n<h4 id=\"DataNode\"><a href=\"#DataNode\" class=\"headerlink\" title=\"DataNode\"></a>DataNode</h4><p>DataNode是在本地文件系统存储文件块数据，以及块数据的检验和</p>\n<h4 id=\"Secondary-NameNode\"><a href=\"#Secondary-NameNode\" class=\"headerlink\" title=\"Secondary NameNode\"></a>Secondary NameNode</h4><p>Secondary NameNode用来监控HDFS状态的辅助后台程序，每隔一段时间获取HDFS元数据的快照</p>\n","categories":["hadoop"],"tags":["hadoop"]},{"title":"Yarn","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/hadoop/%E5%88%86/Yarn/","content":"<h2 id=\"Yarn\"><a href=\"#Yarn\" class=\"headerlink\" title=\"Yarn\"></a>Yarn</h2><p>Yarn是Hadoop的资源调度部分，作用主要是进行资源调度，所以内部存在了一个ResourceManager(RM)来进行资源的管理</p>\n<a id=\"more\"></a>\n\n<h3 id=\"结构\"><a href=\"#结构\" class=\"headerlink\" title=\"结构\"></a>结构</h3><h4 id=\"ResourceManager-RM\"><a href=\"#ResourceManager-RM\" class=\"headerlink\" title=\"ResourceManager(RM)\"></a>ResourceManager(RM)</h4><p>主要是用来进行处理客户端请求、监控NodeManager、启动或监控ApplicationMaster、资源的分配与调度</p>\n<h4 id=\"NodeManager-NM\"><a href=\"#NodeManager-NM\" class=\"headerlink\" title=\"NodeManager(NM)\"></a>NodeManager(NM)</h4><p>主要作用是管理单个节点上的资源、处理来自ResourceManager的命令、处理来自ApplicationMaster的命令</p>\n<h4 id=\"ApplicationMaster-AM\"><a href=\"#ApplicationMaster-AM\" class=\"headerlink\" title=\"ApplicationMaster(AM)\"></a>ApplicationMaster(AM)</h4><p>主要作用是负责数据的切分、为应用程序申请资源并分配给内部的任务、任务的监控与容错</p>\n<h4 id=\"Container\"><a href=\"#Container\" class=\"headerlink\" title=\"Container\"></a>Container</h4><p>是Yarn中资源抽象，封装了某个节点上的多维度资源，如内存、CPU/磁盘、网络等</p>\n","categories":["hadoop"],"tags":["hadoop"]},{"title":"三种运行模式","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/hadoop/%E5%88%86/%E4%B8%89%E7%A7%8D%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F/","content":"<h2 id=\"三种运行模式\"><a href=\"#三种运行模式\" class=\"headerlink\" title=\"三种运行模式\"></a>三种运行模式</h2><p>hadoop分为三种运行模式，分别为单机模式、伪分布式模式和完全分布式模式</p>\n<a id=\"more\"></a>\n\n<p>需要调整hadoop-env.sh文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置JAVA_HOME(设置为自己的JAVA_HOME位置)</span></span><br><span class=\"line\">export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_261.jdk/Contents/Home</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"单机模式-Standalone\"><a href=\"#单机模式-Standalone\" class=\"headerlink\" title=\"单机模式(Standalone)\"></a>单机模式(Standalone)</h3><p>默认情况下为单机模式可以用来开发和调试</p>\n<p>不需要对配置文件进行修改，使用的是本地的文件系统，Hadoop不会启动NameNode、DataNode、JobTracker、TaskTracker等守护线程，Map()和Reduce()任务作为同一个进程的不同部分来执行</p>\n<h4 id=\"wordcount示例\"><a href=\"#wordcount示例\" class=\"headerlink\" title=\"wordcount示例\"></a>wordcount示例</h4><p>使用wordcount例子来演示一下hadoop，**<em>注意不需要改任何的配置文件**</em></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> hadoop-mapreduce-examples-3.3.0.jar该jar包为hadoop的一些示例代码  wordcount表示调用的是该jar包下的WordCount主类 wcinput为输入目录 wcoutput为输出目录</span></span><br><span class=\"line\">./hadoop jar /usr/local/Cellar/hadoop/3.3.0/libexec/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.3.0.jar wordcount wcinput wcoutput</span><br></pre></td></tr></table></figure>\n\n<p>输入目录中的文件内容</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"code\"><pre><span class=\"line\">hadoop</span><br><span class=\"line\">hadoop</span><br><span class=\"line\">yarn</span><br><span class=\"line\">mapreduce</span><br><span class=\"line\">hadoop</span><br><span class=\"line\">hdfs  hdfs</span><br><span class=\"line\">hdfs  mapreduce</span><br><span class=\"line\">hdfs</span><br></pre></td></tr></table></figure>\n\n<p>输出结果</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"code\"><pre><span class=\"line\">hadoop    3</span><br><span class=\"line\">hdfs    4</span><br><span class=\"line\">mapreduce    2</span><br><span class=\"line\">yarn    1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"伪分布式模式-Pseudo-Distributed\"><a href=\"#伪分布式模式-Pseudo-Distributed\" class=\"headerlink\" title=\"伪分布式模式(Pseudo-Distributed)\"></a>伪分布式模式(Pseudo-Distributed)</h3><p>Hadoop在本地机器模拟一个集群，需要修改core-site.xml(作用于全部进程及客户端)、hdfs-site.xml(配置HDFS集群的工作属性)、mapred-site.xml(配置MapReduce集群的属性)</p>\n<h4 id=\"hdfs配置测试\"><a href=\"#hdfs配置测试\" class=\"headerlink\" title=\"hdfs配置测试\"></a>hdfs配置测试</h4><h5 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h5><p>core-site.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">          <span class=\"comment\">&lt;!-- hdfs的NameNode地址 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>fs.defaultFS<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>hdfs://localhost:9000<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>hdfs-site.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">          <span class=\"comment\">&lt;!-- 默认是3，取决于集群中的机器 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>dfs.replication<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h5><p>第一次启动的时候需要格式化，之后就不要格式化了(<strong>格式化之后所有的数据就没了</strong>)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">./hdfs namenode -format</span><br></pre></td></tr></table></figure>\n\n<p><font color=\"red\"><strong>注意：在format过程中 要注意不要频繁地reformat  namnode（格式化命令为  hdfs namenode -format）的ID信息。format过程中选择N（否）就是了。因为在每次hdfs namenode -format时都会为NameNode生成namespaceID，在hadoop.tmp.dir目录下的dataNode还是保留上次的namespaceID，因为namespaceID不一致，导致DataNode无法启动</strong><font></font></font></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 启动namenodes和datanodes</span></span><br><span class=\"line\">sbin/start-dfs.sh</span><br></pre></td></tr></table></figure>\n\n<p>启动完之后使用jps来查看是否存在NameNode和DataNode</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">jps</span><br></pre></td></tr></table></figure>\n\n<p>访问localhost:9870可以查看hdfs的web页面</p>\n<blockquote>\n<p>如果是3.X以下的对应的端口是50070</p>\n</blockquote>\n<p>操作hdfs</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 在hdfs中创建目录</span></span><br><span class=\"line\">bin/hdfs dfs -mkdir /test/wordcount</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 将本地文件上传到hdfs中  </span></span><br><span class=\"line\">bin/hdfs dfs -put bin/wcinput /test/wordcount</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"wordcount示例-1\"><a href=\"#wordcount示例-1\" class=\"headerlink\" title=\"wordcount示例\"></a>wordcount示例</h5><p>再次操作一下wordcount的例子</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> hadoop-mapreduce-examples-3.3.0.jar该jar包为hadoop的一些示例代码  wordcount表示调用的是该jar包下的WordCount主类 /<span class=\"built_in\">test</span>/wordcount/wcinput为输入目录(代表的是在hdfs上的目录位置) /<span class=\"built_in\">test</span>/wordcount/wcoutput为输出目录(代表的是在hdfs上的目录位置)</span></span><br><span class=\"line\">bin/hadoop jar /usr/local/Cellar/hadoop/3.3.0/libexec/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.3.0.jar wordcount /test/wordcount/wcinput /test/wordcount/wcoutput</span><br></pre></td></tr></table></figure>\n\n<p>此时在/test/wordcount/wcoutput目录下就会有这次执行的结果</p>\n<h4 id=\"yarn配置测试\"><a href=\"#yarn配置测试\" class=\"headerlink\" title=\"yarn配置测试\"></a>yarn配置测试</h4><p>yarn要在hdfs配置启动好的基础上进行配置</p>\n<h5 id=\"配置文件-1\"><a href=\"#配置文件-1\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h5><p>mapred-site.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 指定在哪运行计算，默认是local --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>mapreduce.framework.name<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>yarn<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>mapreduce.application.classpath<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>$HADOOP_MAPRED_HOME/share/hadoop/mapreduce/*:$HADOOP_MAPRED_HOME/share/hadoop/mapreduce/lib/*<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>yarn-site.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- Reducer获取数据的方式 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>yarn.nodemanager.aux-services<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>mapreduce_shuffle<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>yarn.nodemanager.env-whitelist<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>JAVA_HOME,HADOOP_COMMON_HOME,HADOOP_HDFS_HOME,HADOOP_CONF_DIR,CLASSPATH_PREPEND_DISTCACHE,HADOOP_YARN_HOME,HADOOP_MAPRED_HOME<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"启动-1\"><a href=\"#启动-1\" class=\"headerlink\" title=\"启动\"></a>启动</h5><blockquote>\n<p>注意：要在hdfs启动的基础上进行启动</p>\n</blockquote>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">sbin/start-yarn.sh</span><br></pre></td></tr></table></figure>\n\n<p>启动之后使用jps查看，需要存在NodeManager和ResourceManager</p>\n<p>可以使用localhost:8088来查看ResourceManager的web页面</p>\n<h5 id=\"wordcount示例-2\"><a href=\"#wordcount示例-2\" class=\"headerlink\" title=\"wordcount示例\"></a>wordcount示例</h5><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">bin/hadoop jar /usr/local/Cellar/hadoop/3.3.0/libexec/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.3.0.jar wordcount /test/wordcount/wcinput /test/wordcount/yarn_wcoutput</span><br></pre></td></tr></table></figure>\n\n<p>此时在/test/wordcount/yarn_wcoutput目录下就会有这次执行的结果</p>\n<h3 id=\"完全分布式集群模式-Full-Distributed\"><a href=\"#完全分布式集群模式-Full-Distributed\" class=\"headerlink\" title=\"完全分布式集群模式(Full-Distributed)\"></a>完全分布式集群模式(Full-Distributed)</h3><p>Hadoop运行在一个集群上，各主机间设置SSH免密码登录，把各从节点生辰的公钥添加到主节点的信任列表，修改core-site.xml、hdfs-site.xml、maperd-site.xml，指定NameNode和JobTraker的位置和端口，设置文件的副本等参数</p>\n","categories":["hadoop"],"tags":["hadoop"]},{"title":"历史服务器","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/hadoop/%E5%88%86/%E5%8E%86%E5%8F%B2%E6%9C%8D%E5%8A%A1%E5%99%A8/","content":"<h2 id=\"历史服务器\"><a href=\"#历史服务器\" class=\"headerlink\" title=\"历史服务器\"></a>历史服务器</h2><p>在资源管理ResourceManager的web页面中有一个History，默认该链接无法访问</p>\n<img src=\"/images/大数据/hadoop/历史服务器.png\" alt=\"历史服务器\" style=\"zoom:50%;\">\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">bin/mapred --daemon start historyserver</span><br></pre></td></tr></table></figure>\n\n<p>使用jps可以发现多了一个JobHistoryServer进程</p>\n<a id=\"more\"></a>\n\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><table>\n<thead>\n<tr>\n<th>属性名</th>\n<th>属性值</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>mapreduce.jobhistory.webapp.address</td>\n<td>MapReduce JobHistory Server Web UI <em>host:port</em></td>\n<td>Default port is 19888.</td>\n</tr>\n<tr>\n<td>mapreduce.jobhistory.intermediate-done-dir</td>\n<td>/mr-history/tmp</td>\n<td>Directory where history files are written by MapReduce jobs.</td>\n</tr>\n<tr>\n<td>mapreduce.jobhistory.done-dir</td>\n<td>/mr-history/done</td>\n<td>Directory where history files are managed by the MR JobHistory Server.</td>\n</tr>\n<tr>\n<td>mapreduce.jobhistory.address</td>\n<td>MapReduce JobHistory Server <em>host:port</em></td>\n<td>Default port is 10020.</td>\n</tr>\n</tbody></table>\n","categories":["hadoop"],"tags":["hadoop"]},{"title":"日志聚集","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/hadoop/%E5%88%86/%E6%97%A5%E5%BF%97%E8%81%9A%E9%9B%86/","content":"<h2 id=\"日志聚集\"><a href=\"#日志聚集\" class=\"headerlink\" title=\"日志聚集\"></a>日志聚集</h2><p>日志聚集功能默认是关闭的，需要在yarn-site.xml中配置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 开启日志聚集  默认false --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>yarn.log-aggregation-enable<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>true<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 保留时间  默认-1即不保留 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>yarn.log-aggregation.retain-seconds<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>3600<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>该配置对于ResourceManager 和 NodeManager生效，所以这两个需要重启(即yarn重启)</p>\n","categories":["hadoop"],"tags":["hadoop"]},{"title":"hadoop版本","url":"/2021/%E5%A4%A7%E6%95%B0%E6%8D%AE/hadoop/%E6%80%BB%E5%BC%80/hadoop%E7%89%88%E6%9C%AC/","content":"<h2 id=\"Hadoop版本\"><a href=\"#Hadoop版本\" class=\"headerlink\" title=\"Hadoop版本\"></a>Hadoop版本</h2><h3 id=\"hadoop1-x版本\"><a href=\"#hadoop1-x版本\" class=\"headerlink\" title=\"hadoop1.x版本\"></a>hadoop1.x版本</h3><p>由三部分组成</p>\n<a id=\"more\"></a>\n\n<ul>\n<li>Common(辅助工具)</li>\n<li>HDFS(数据存储)</li>\n<li>MapReduce(计算和资源调度)</li>\n</ul>\n<h3 id=\"hadoop2-x版本\"><a href=\"#hadoop2-x版本\" class=\"headerlink\" title=\"hadoop2.x版本\"></a>hadoop2.x版本</h3><p>由四部分组成</p>\n<ul>\n<li>Common(辅助工具)</li>\n<li>HDFS(数据存储)</li>\n<li><strong>Yarn(资源调度)</strong></li>\n<li>MapReduce(计算)</li>\n</ul>\n","categories":["hadoop"],"tags":["hadoop"]},{"title":"hadoop简介","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/hadoop/%E6%80%BB%E5%BC%80/hadoop%E7%AE%80%E4%BB%8B/","content":"<h2 id=\"Hadoop简介\"><a href=\"#Hadoop简介\" class=\"headerlink\" title=\"Hadoop简介\"></a>Hadoop简介</h2><p>Hadoop是一个由Apache基金会所开发的分布式系统基础架构。用户可以在不了解分布式底层细节的情况下，开发分布式程序。充分利用集群的威力进行高速运算和存储。Hadoop实现了一个分布式文件系统（Hadoop Distributed File System），</p>\n<a id=\"more\"></a>其中一个组件是HDFS。HDFS有高容错性的特点，并且设计用来部署在低廉的（low-cost）硬件上；而且它提供高吞吐量（high throughput）来访问应用程序的数据，适合那些有着超大数据集（large data set）的应用程序。HDFS放宽了（relax）POSIX的要求，可以以流的形式访问（streaming access）文件系统中的数据。Hadoop的框架最核心的设计就是：HDFS和MapReduce。HDFS为海量的数据提供了存储，而MapReduce则为海量的数据提供了计算 。\n\n<p>Hadoop 由许多元素构成。其最底部是 Hadoop Distributed File System（HDFS），它存储 Hadoop 集群中所有存储节点上的文件。HDFS的上一层是MapReduce 引擎，该引擎由 JobTrackers 和 TaskTrackers 组成。通过对Hadoop分布式计算平台最核心的分布式文件系统HDFS、MapReduce处理过程，以及数据仓库工具Hive和分布式数据库Hbase的介绍，基本涵盖了Hadoop分布式平台的所有技术核心。</p>\n<h3 id=\"发行版本\"><a href=\"#发行版本\" class=\"headerlink\" title=\"发行版本\"></a>发行版本</h3><p>Hadoop有三大发行版本：Apache、Cloudera、Hortonworks</p>\n<ul>\n<li>Apache  最基础的版本  apache版</li>\n<li>Cloudera  企业中使用最多的版本(收费) cdh版</li>\n<li>Hortonworks  文档较好</li>\n</ul>\n<h3 id=\"优势\"><a href=\"#优势\" class=\"headerlink\" title=\"优势\"></a>优势</h3><ul>\n<li>高可用   Hadoop底层维护了多个数据副本，即使某个计算元素或者存储出现故障，也不会导致数据的丢失</li>\n<li>高扩展  在集群间分配任务数据，可方便的扩展数以千计的节点</li>\n<li>高效性  Hadoop并行工作，加快任务处理速度</li>\n<li>高容错性  可以自动将失败的任务重新分配</li>\n</ul>\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p>配置文件在hadoop下/etc目录下，有几个重要的配置文件</p>\n<h4 id=\"core-site-xml\"><a href=\"#core-site-xml\" class=\"headerlink\" title=\"core-site.xml\"></a>core-site.xml</h4><p>这是hadoop的核心配置文件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- Put site-specific property overrides in this file. --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- fs.defaultFS用于配置NameNode节点的URI，协议、主机或IP、端口 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>fs.defaultFS<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>hdfs://localhost:9000<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- hadoop.tmp.dir文件系统依赖的基础配置，如果在hdfs-site.xml中不配置NameNode节点和DataNode节点的数据存放位置时，默认放在该目录下 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>hadoop.tmp.dir<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>/opt/data/hadoop/tmp<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"hdfs-site-xml\"><a href=\"#hdfs-site-xml\" class=\"headerlink\" title=\"hdfs-site.xml\"></a>hdfs-site.xml</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 数据备份数 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>dfs.replication<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>1<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- NameNode节点文件数据存储路径 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>dfs.name.dir<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>/opt/data/hadoop/namenode<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- DataNode节点文件数据存储路径--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>dfs.data.dir<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>/opt/data/hadoop/datanode<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"mapred-site-xml\"><a href=\"#mapred-site-xml\" class=\"headerlink\" title=\"mapred-site.xml\"></a>mapred-site.xml</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- Put site-specific property overrides in this file. --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">configuration</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 配置jobTracker的主机名或者ip、端口   还可以配置TaskTracker--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>mapred.job.tracker<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">value</span>&gt;</span>localhost:9001<span class=\"tag\">&lt;/<span class=\"name\">value</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">property</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 初始化namenode</span></span><br><span class=\"line\">hdfs namenode -format</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 启动hadoop（会启动 SecondaryNameNode、NameNode、NodeManager、ResourceManager、DataNode服务）  这个要去start-all.sh所在目录去执行  否则会报错 原因未知</span></span><br><span class=\"line\">./start-all.sh</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 验证  创建文件</span></span><br><span class=\"line\">hdfs dfs -mkdir /test</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看文件</span></span><br><span class=\"line\">hdfs dfs -ls /</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n","categories":["hadoop"],"tags":["hadoop"]},{"title":"hadoop问题集锦","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/hadoop/%E9%97%AE%E9%A2%98/hadoop%E9%97%AE%E9%A2%98%E9%9B%86%E9%94%A6/","content":"<h2 id=\"Hadoop问题集锦\"><a href=\"#Hadoop问题集锦\" class=\"headerlink\" title=\"Hadoop问题集锦\"></a>Hadoop问题集锦</h2><h3 id=\"在使用flume将数据存储到hdfs时出现错误\"><a href=\"#在使用flume将数据存储到hdfs时出现错误\" class=\"headerlink\" title=\"在使用flume将数据存储到hdfs时出现错误\"></a>在使用flume将数据存储到hdfs时出现错误</h3><p>[SinkRunner-PollingRunner-DefaultSinkProcessor] (org.apache.flume.sink.hdfs.HDFSEventSink.process:459)  - process failed<br>java.lang.NoSuchMethodError: com.google.common.base.Preconditions.checkArgument(ZLjava/lang/String;Ljava/lang/Object;)V</p>\n<a id=\"more\"></a>\n\n<p>这个问题是由于flume和hadoop的guava的版本不一致导致的，看一下两个的版本，将低版本的删掉，统一使用高版本的</p>\n<h3 id=\"hdfs写文件失败\"><a href=\"#hdfs写文件失败\" class=\"headerlink\" title=\"hdfs写文件失败\"></a>hdfs写文件失败</h3><p>could only be written to 0 of the 1 minReplication nodes. There are 0 datanode(s) running and 0 node(s) are excluded in this operation.</p>\n<p>这个问题可能是由于dataNode节点没起来，可以使用jps看一下是否有dataNode的进程</p>\n","categories":["hadoop"],"tags":["hadoop"]},{"title":"log4j2与kafka集成","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E5%BA%94%E7%94%A8/log4j2%E4%B8%8Ekafka/","content":"<h2 id=\"log4j2与kafka集成\"><a href=\"#log4j2与kafka集成\" class=\"headerlink\" title=\"log4j2与kafka集成\"></a>log4j2与kafka集成</h2><p>在很多时候大家都会在程序中记录日志，程序可以通过Log4j2直接将日志同步到kafka</p>\n<a id=\"more\"></a>\n\n<h3 id=\"pom依赖\"><a href=\"#pom依赖\" class=\"headerlink\" title=\"pom依赖\"></a>pom依赖</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.kafka<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>kafka-clients<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.6.0<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.logging.log4j<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>log4j-core<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.11.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"Log4j2配置\"><a href=\"#Log4j2配置\" class=\"headerlink\" title=\"Log4j2配置\"></a>Log4j2配置</h3><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Configuration</span> <span class=\"attr\">status</span> =<span class=\"string\">&quot;info&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Appenders</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 控制台打印 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Console</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;STDOUT&quot;</span> <span class=\"attr\">target</span>=<span class=\"string\">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %4level %t - %m%n&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Console</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 输入到kafka中 --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Kafka</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;kafkaLog&quot;</span> <span class=\"attr\">topic</span>=<span class=\"string\">&quot;topic_request_log&quot;</span> <span class=\"attr\">ignoreExceptions</span>=<span class=\"string\">&quot;false&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">PatternLayout</span> <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %4level %t - %m%n&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">Property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;bootstrap.servers&quot;</span>&gt;</span>localhost:9092<span class=\"tag\">&lt;/<span class=\"name\">Property</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Kafka</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Appenders</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Loggers</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Root</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;info&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">AppenderRef</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;STDOUT&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">AppenderRef</span> <span class=\"attr\">ref</span>=<span class=\"string\">&quot;kafkaLog&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Root</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Logger</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;org.apache.kafka&quot;</span> <span class=\"attr\">level</span>=<span class=\"string\">&quot;INFO&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">Logger</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Loggers</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"程序示例\"><a href=\"#程序示例\" class=\"headerlink\" title=\"程序示例\"></a>程序示例</h3><p>一个简单的小示例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Log2Kafka</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Logger LOGGER = LogManager.getLogger(<span class=\"string\">&quot;APP&quot;</span>);</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args )</span> </span>&#123;</span><br><span class=\"line\">        LOGGER.info(<span class=\"string\">&quot;测试日志&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"kafka存储结果\"><a href=\"#kafka存储结果\" class=\"headerlink\" title=\"kafka存储结果\"></a>kafka存储结果</h3><p>可以使用DumpLogSegments工具类查看消息内容</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">kafka-run-class kafka.tools.DumpLogSegments --files /usr/<span class=\"built_in\">local</span>/var/lib/kafka-logs/topic_request_log-0/00000000000000000000.log --<span class=\"built_in\">print</span>-data-log</span></span><br><span class=\"line\">Dumping /usr/local/var/lib/kafka-logs/topic_request_log-0/00000000000000000000.log</span><br><span class=\"line\">Starting offset: 0</span><br><span class=\"line\">baseOffset: 0 lastOffset: 0 count: 1 baseSequence: -1 lastSequence: -1 producerId: -1 producerEpoch: -1 partitionLeaderEpoch: 0 isTransactional: false isControl: false position: 0 CreateTime: 1603250280109 size: 117 magic: 2 compresscodec: NONE crc: 2500714151 isvalid: true</span><br><span class=\"line\">| offset: 0 CreateTime: 1603250280109 keysize: -1 valuesize: 49 sequence: -1 headerKeys: [] payload: 2020-10-21 11:17:59.640 INFO main - 测试日志</span><br></pre></td></tr></table></figure>\n\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka分区","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%93%8D%E4%BD%9C/kafka%E5%88%86%E5%8C%BA/","content":"<h2 id=\"分区操作\"><a href=\"#分区操作\" class=\"headerlink\" title=\"分区操作\"></a>分区操作</h2><h3 id=\"分区Leader平衡\"><a href=\"#分区Leader平衡\" class=\"headerlink\" title=\"分区Leader平衡\"></a>分区Leader平衡</h3><p>当创建一个主题时，该主题的分区及副本会被均匀的分配到kafka集群的相应节点上，这样优先副本也在集群中均匀分布。当一个主题创建后优先副本会作为分区的Leader副本，Leader负责所有的读写操作。<a id=\"more\"></a>当Leader节点发生故障时，就会从Follower节点中选出新的Leader，这样可能会导致集群负载不均衡，当原Leader节点恢复后再次加入集群也不会主动成为Leader副本。kafka提供了两种方式重新选择优先副本作为分区Leader的方法，使得集群负载重新达到平衡。</p>\n<ul>\n<li><p>自动平衡  在代理节点启动时，设置auto.leader.rebalance.enable=true，默认为true，控制器在故障转移操作时会启动一个定时任务，每个${leader.imbalance.check.interval.secords}秒(默认5min)触发一次分区分配均衡操作，且只有在代理的不均衡的百分比达到${leader.imbalance.er.broker.percentage}(该值默认为10，即不均衡比例达到10%)以上才会真正执行分区重新分配操作。若配置为false，失效前是Leader副本，节点恢复后只是一个Follower副本</p>\n</li>\n<li><p>手动平衡  kafka提供一个对分区Leader重新平衡的工具脚本kafka-preferred-replica-election.sh，该工具将优先副本选举为Leader，从而重新让集群分区达到平衡。</p>\n</li>\n</ul>\n<p>在运行期间kafka集群整个宕机了，然后重启了一个节点之后，此时所有的Leader副本都在该节点下，可以使用手动平衡来重新分配</p>\n<p>首先先写一个分配的json</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;partitions&quot;</span>:[</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>:<span class=\"string\">&quot;test-kafka-cluster&quot;</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;partition&quot;</span>:<span class=\"number\">0</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>:<span class=\"string\">&quot;test-kafka-cluster&quot;</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;partition&quot;</span>:<span class=\"number\">1</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>:<span class=\"string\">&quot;test-kafka-cluster&quot;</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;partition&quot;</span>:<span class=\"number\">2</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>:<span class=\"string\">&quot;test-kafka-cluster&quot;</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;partition&quot;</span>:<span class=\"number\">3</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>:<span class=\"string\">&quot;test-kafka-cluster&quot;</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;partition&quot;</span>:<span class=\"number\">4</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 对该主题进行Leader平衡  <span class=\"built_in\">path</span>-to-json-file即为上述json的文件路径</span><br><span class=\"line\">&gt;kafka-preferred-replica-election --bootstrap-server localhost:<span class=\"number\">9091</span>,localhost:<span class=\"number\">9092</span>,localhost:<span class=\"number\">9093</span> --<span class=\"built_in\">path</span>-to-json-file ../../config/<span class=\"number\">111</span>.json</span><br></pre></td></tr></table></figure>\n\n<p>对于某一个节点挂掉的情况，只需要对该分区进行重新分配即可，在json中只需要写该分区编号就可以了</p>\n<h4 id=\"脚本\"><a href=\"#脚本\" class=\"headerlink\" title=\"脚本\"></a>脚本</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh kafka.admin.PreferredReplicaLeaderElectionCommand &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"分区迁移\"><a href=\"#分区迁移\" class=\"headerlink\" title=\"分区迁移\"></a>分区迁移</h3><p>kafka-reassign-partitions.sh脚本，在集群扩容、节点下线等场景时对分区迁移操作</p>\n<p>当下线一个节点前，需要将该节点的分区副本迁移到其他可用节点上，kafka并不会自动进行分区副本迁移，如果不进行手动重新分配，就会导致某些主题数据丢失和不可用的情况。在新增节点时，也只有新创建的主题才会分配到这些节点上，而之前主题的分区并不会自动分配到新加入的节点</p>\n<h4 id=\"脚本-1\"><a href=\"#脚本-1\" class=\"headerlink\" title=\"脚本\"></a>脚本</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh kafka.admin.ReassignPartitionsCommand &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"节点下线\"><a href=\"#节点下线\" class=\"headerlink\" title=\"节点下线\"></a>节点下线</h4><p>若需要将brokerId为2的节点下线，在下线前先通过kafka-reassign-partitions.sh脚本将该分区迁移到其他节点上</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">#重新分配之前</span><br><span class=\"line\">&gt;kafka-topics --zookeeper localhost:<span class=\"number\">2181</span> --describe --topic test-replication</span><br><span class=\"line\"><span class=\"function\">Topic:<span class=\"title\">test</span>-<span class=\"title\">replication</span>  <span class=\"title\">PartitionCount</span>:5        <span class=\"title\">ReplicationFactor</span>:2     <span class=\"title\">Configs</span>:</span></span><br><span class=\"line\"><span class=\"function\">   <span class=\"title\">Topic</span>: <span class=\"title\">test</span>-<span class=\"title\">replication</span> <span class=\"title\">Partition</span>: 0    <span class=\"title\">Leader</span>: 2       <span class=\"title\">Replicas</span>: 2,0   <span class=\"title\">Isr</span>: 2,0</span></span><br><span class=\"line\"><span class=\"function\">   <span class=\"title\">Topic</span>: <span class=\"title\">test</span>-<span class=\"title\">replication</span> <span class=\"title\">Partition</span>: 1    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 0,1   <span class=\"title\">Isr</span>: 0,1</span></span><br><span class=\"line\"><span class=\"function\">   <span class=\"title\">Topic</span>: <span class=\"title\">test</span>-<span class=\"title\">replication</span> <span class=\"title\">Partition</span>: 2    <span class=\"title\">Leader</span>: 1       <span class=\"title\">Replicas</span>: 1,2   <span class=\"title\">Isr</span>: 1,2</span></span><br><span class=\"line\"><span class=\"function\">   <span class=\"title\">Topic</span>: <span class=\"title\">test</span>-<span class=\"title\">replication</span> <span class=\"title\">Partition</span>: 3    <span class=\"title\">Leader</span>: 2       <span class=\"title\">Replicas</span>: 2,1   <span class=\"title\">Isr</span>: 2,1</span></span><br><span class=\"line\"><span class=\"function\">   <span class=\"title\">Topic</span>: <span class=\"title\">test</span>-<span class=\"title\">replication</span> <span class=\"title\">Partition</span>: 4    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 0,2   <span class=\"title\">Isr</span>: 0,2</span></span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li><p>生成分区分配方案   首先创建一个文件，以json字符串指定要进行分区重分配的主题。</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;topics&quot;</span>:[</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>:<span class=\"string\">&quot;test-replication&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">&quot;version&quot;</span>: <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\"># broker-list 指定分区可迁移的broke列表，由于<span class=\"number\">2</span>要下线，需要将该节点的分区迁移到<span class=\"number\">1</span>/<span class=\"number\">0</span>上</span><br><span class=\"line\"># generate 表示表示生成一个分区副本分配方案</span><br><span class=\"line\">&gt;kafka-reassign-partitions --zookeeper localhost:<span class=\"number\">2181</span> --topics-to-<span class=\"built_in\">move</span>-json-file  ../../config/<span class=\"number\">123</span>.json --broker-list &quot;<span class=\"number\">1</span>,<span class=\"number\">0</span>&quot; --generate</span><br><span class=\"line\"># 该命令原理为：从zookeeper中读取主题元数据信息及指定的有效代理，根据分区副本分配算法重新计算指定主题的分区副本分配方案</span><br></pre></td></tr></table></figure>\n\n<p>该命令执行输出信息包含两部分，一部分是当前分区分配信息，一部分是根据指定的代理列表生成的分区分配方案</p>\n</li>\n<li><p>生成分区副本分配方案</p>\n</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;version&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;partitions&quot;</span>: [&#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">0</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;replicas&quot;</span>: [<span class=\"number\">0</span>, <span class=\"number\">1</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;log_dirs&quot;</span>: [<span class=\"string\">&quot;any&quot;</span>, <span class=\"string\">&quot;any&quot;</span>]</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">3</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;replicas&quot;</span>: [<span class=\"number\">1</span>, <span class=\"number\">0</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;log_dirs&quot;</span>: [<span class=\"string\">&quot;any&quot;</span>, <span class=\"string\">&quot;any&quot;</span>]</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">2</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;replicas&quot;</span>: [<span class=\"number\">0</span>, <span class=\"number\">1</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;log_dirs&quot;</span>: [<span class=\"string\">&quot;any&quot;</span>, <span class=\"string\">&quot;any&quot;</span>]</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">4</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;replicas&quot;</span>: [<span class=\"number\">0</span>, <span class=\"number\">1</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;log_dirs&quot;</span>: [<span class=\"string\">&quot;any&quot;</span>, <span class=\"string\">&quot;any&quot;</span>]</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;replicas&quot;</span>: [<span class=\"number\">1</span>, <span class=\"number\">0</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;log_dirs&quot;</span>: [<span class=\"string\">&quot;any&quot;</span>, <span class=\"string\">&quot;any&quot;</span>]</span><br><span class=\"line\">    &#125;]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>执行分区迁移</li>\n</ul>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-reassign-partitions --zookeeper localhost:<span class=\"number\">2181</span> --reassignment-json-file  ../../config/<span class=\"number\">124</span>.json --execute</span><br></pre></td></tr></table></figure>\n\n<p>  分区迁移的原理是在目标节点上创建分区目录，然后复制原分区数据到目标节点，最后删除原节点数据</p>\n<ul>\n<li>查看分区进度</li>\n</ul>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-reassign-partitions --zookeeper localhost:<span class=\"number\">2181</span> --reassignment-json-file  ../../config/<span class=\"number\">124</span>.json --<span class=\"built_in\">verify</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">#重新分配之后</span><br><span class=\"line\">&gt;kafka-topics --zookeeper localhost:<span class=\"number\">2181</span> --describe --topic test-replication</span><br><span class=\"line\"><span class=\"function\">Topic:<span class=\"title\">test</span>-<span class=\"title\">replication</span>  <span class=\"title\">PartitionCount</span>:5        <span class=\"title\">ReplicationFactor</span>:2     <span class=\"title\">Configs</span>:</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">Topic</span>: <span class=\"title\">test</span>-<span class=\"title\">replication</span> <span class=\"title\">Partition</span>: 0    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 0,1   <span class=\"title\">Isr</span>: 0,1</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">Topic</span>: <span class=\"title\">test</span>-<span class=\"title\">replication</span> <span class=\"title\">Partition</span>: 1    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 1,0   <span class=\"title\">Isr</span>: 0,1</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">Topic</span>: <span class=\"title\">test</span>-<span class=\"title\">replication</span> <span class=\"title\">Partition</span>: 2    <span class=\"title\">Leader</span>: 1       <span class=\"title\">Replicas</span>: 0,1   <span class=\"title\">Isr</span>: 1,0</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">Topic</span>: <span class=\"title\">test</span>-<span class=\"title\">replication</span> <span class=\"title\">Partition</span>: 3    <span class=\"title\">Leader</span>: 1       <span class=\"title\">Replicas</span>: 1,0   <span class=\"title\">Isr</span>: 1,0</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">Topic</span>: <span class=\"title\">test</span>-<span class=\"title\">replication</span> <span class=\"title\">Partition</span>: 4    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 0,1   <span class=\"title\">Isr</span>: 0,1</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"集群扩容\"><a href=\"#集群扩容\" class=\"headerlink\" title=\"集群扩容\"></a>集群扩容</h4><p>与上述分区迁移相同的操作，只是由之前的减少节点，变成增加节点</p>\n<p>生成分区副本方案</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;version&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;partitions&quot;</span>: [&#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">0</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;replicas&quot;</span>: [<span class=\"number\">2</span>, <span class=\"number\">1</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;log_dirs&quot;</span>: [<span class=\"string\">&quot;any&quot;</span>, <span class=\"string\">&quot;any&quot;</span>]</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">3</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;replicas&quot;</span>: [<span class=\"number\">2</span>, <span class=\"number\">0</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;log_dirs&quot;</span>: [<span class=\"string\">&quot;any&quot;</span>, <span class=\"string\">&quot;any&quot;</span>]</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">2</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;replicas&quot;</span>: [<span class=\"number\">1</span>, <span class=\"number\">0</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;log_dirs&quot;</span>: [<span class=\"string\">&quot;any&quot;</span>, <span class=\"string\">&quot;any&quot;</span>]</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">4</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;replicas&quot;</span>: [<span class=\"number\">0</span>, <span class=\"number\">1</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;log_dirs&quot;</span>: [<span class=\"string\">&quot;any&quot;</span>, <span class=\"string\">&quot;any&quot;</span>]</span><br><span class=\"line\">    &#125;, &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">1</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;replicas&quot;</span>: [<span class=\"number\">0</span>, <span class=\"number\">2</span>],</span><br><span class=\"line\">        <span class=\"attr\">&quot;log_dirs&quot;</span>: [<span class=\"string\">&quot;any&quot;</span>, <span class=\"string\">&quot;any&quot;</span>]</span><br><span class=\"line\">    &#125;]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>分区迁移时复制限流有两种方法</p>\n<ul>\n<li>通过动态修改配置     </li>\n</ul>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">#设置数据复制被限流的副本列表</span><br><span class=\"line\">&gt;kafka-configs --zookeeper localhost:<span class=\"number\">2181</span> --entity-<span class=\"built_in\">type</span> topics --entity-name test-replication --alter --add-config leader.replication.throttled.replicas=[<span class=\"number\">0</span>:<span class=\"number\">0</span>,<span class=\"number\">1</span>:<span class=\"number\">1</span>,<span class=\"number\">2</span>:<span class=\"number\">2</span>],follower.replication.throttled.replicas=[<span class=\"number\">0</span>:<span class=\"number\">0</span>,<span class=\"number\">1</span>:<span class=\"number\">1</span>,<span class=\"number\">2</span>:<span class=\"number\">2</span>]</span><br><span class=\"line\">#设置节点<span class=\"number\">2</span>的复制速率</span><br><span class=\"line\">&gt;kafka-configs --zookeeper localhost:<span class=\"number\">2181</span> --entity-<span class=\"built_in\">type</span> brokers --entity-name <span class=\"number\">2</span> --alter --add-config follower.replication.throttled.rate=<span class=\"number\">1024</span>,leader.replication.throttled.rate=<span class=\"number\">1024</span></span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li>通过kafka-reassign-partitions脚本支持的throttle参数设置</li>\n</ul>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">#使用throttle参数设置限流值</span><br><span class=\"line\">&gt;kafka-reassign-partitions --zookeeper localhost:<span class=\"number\">2181</span> --reassignment-json-file  ../../config/<span class=\"number\">124</span>.json --execute --throttle <span class=\"number\">1024</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"增加副本\"><a href=\"#增加副本\" class=\"headerlink\" title=\"增加副本\"></a>增加副本</h4><p>增加副本是分区迁移的一个特例，本质也是分区副本的重分配</p>\n<p>分配方案自己确定，只是要保证各副本均匀分配在所有的节点即可</p>\n<p>将原本的两个副本改为三个副本，</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;version&quot;</span>: <span class=\"number\">1</span>, </span><br><span class=\"line\">    <span class=\"attr\">&quot;partitions&quot;</span>: [</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>, </span><br><span class=\"line\">            <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">0</span>, </span><br><span class=\"line\">            <span class=\"attr\">&quot;replicas&quot;</span>: [</span><br><span class=\"line\">                <span class=\"number\">0</span>, </span><br><span class=\"line\">                <span class=\"number\">1</span>, </span><br><span class=\"line\">                <span class=\"number\">2</span></span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>, </span><br><span class=\"line\">            <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">1</span>, </span><br><span class=\"line\">            <span class=\"attr\">&quot;replicas&quot;</span>: [</span><br><span class=\"line\">                <span class=\"number\">1</span>, </span><br><span class=\"line\">                <span class=\"number\">2</span>, </span><br><span class=\"line\">                <span class=\"number\">0</span></span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>, </span><br><span class=\"line\">            <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">2</span>, </span><br><span class=\"line\">            <span class=\"attr\">&quot;replicas&quot;</span>: [</span><br><span class=\"line\">                <span class=\"number\">2</span>, </span><br><span class=\"line\">                <span class=\"number\">0</span>, </span><br><span class=\"line\">                <span class=\"number\">1</span></span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>, </span><br><span class=\"line\">            <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">3</span>, </span><br><span class=\"line\">            <span class=\"attr\">&quot;replicas&quot;</span>: [</span><br><span class=\"line\">                <span class=\"number\">0</span>, </span><br><span class=\"line\">                <span class=\"number\">1</span>, </span><br><span class=\"line\">                <span class=\"number\">2</span></span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;topic&quot;</span>: <span class=\"string\">&quot;test-replication&quot;</span>, </span><br><span class=\"line\">            <span class=\"attr\">&quot;partition&quot;</span>: <span class=\"number\">4</span>, </span><br><span class=\"line\">            <span class=\"attr\">&quot;replicas&quot;</span>: [</span><br><span class=\"line\">                <span class=\"number\">1</span>, </span><br><span class=\"line\">                <span class=\"number\">2</span>, </span><br><span class=\"line\">                <span class=\"number\">0</span></span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>执行分区副本重分配即可</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;</span><span class=\"bash\">kafka-reassign-partitions --zookeeper localhost:2181 --reassignment-json-file  ../../config/125.json --execute</span></span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka主题","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%93%8D%E4%BD%9C/kafka%E4%B8%BB%E9%A2%98/","content":"<h2 id=\"kafka主题\"><a href=\"#kafka主题\" class=\"headerlink\" title=\"kafka主题\"></a>kafka主题</h2><p>  kafka提供了一个kafka-topics.sh用于对主题的相关操作，如创建主题、删除主题、修改主题分区数和副本分配以及修改主题级别的配置信息，查看主题信息等操作。指令包括–list、–describe、–create、–alter和–delete。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"主题脚本\"><a href=\"#主题脚本\" class=\"headerlink\" title=\"主题脚本\"></a>主题脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh kafka.admin.TopicCommand &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"主题源码\"><a href=\"#主题源码\" class=\"headerlink\" title=\"主题源码\"></a>主题源码</h3><p>创建主题包括两个阶段，第一阶段是客户端将主题元数据写入zookeeper，称为客户端创建主题；第二阶段是控制器负责管理主题的创建，称为服务端创建主题。</p>\n<p>无论是使用Api还是命令行来创建主题，底层都是客户端通过调用TopicCommand来进行创建的</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">main</span></span>(args: <span class=\"type\">Array</span>[<span class=\"type\">String</span>]): <span class=\"type\">Unit</span> = &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">val</span> opts = <span class=\"keyword\">new</span> <span class=\"type\">TopicCommandOptions</span>(args)</span><br><span class=\"line\">    opts.checkArgs()</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// 如果使用的是zookeeper参数创建的  则使用ZookeeperTopicService</span></span><br><span class=\"line\">    <span class=\"keyword\">val</span> topicService = <span class=\"keyword\">if</span> (opts.zkConnect.isDefined)</span><br><span class=\"line\">      <span class=\"type\">ZookeeperTopicService</span>(opts.zkConnect)</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">          <span class=\"comment\">// 否则使用AdminClientTopicService  </span></span><br><span class=\"line\">      <span class=\"type\">AdminClientTopicService</span>(opts.commandConfig, opts.bootstrapServer)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> exitCode = <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 创建操作</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (opts.hasCreateOption)</span><br><span class=\"line\">        topicService.createTopic(opts)</span><br><span class=\"line\">      <span class=\"comment\">// 修改操作</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (opts.hasAlterOption)</span><br><span class=\"line\">        topicService.alterTopic(opts)</span><br><span class=\"line\">      <span class=\"comment\">// list列表操作</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (opts.hasListOption)</span><br><span class=\"line\">        topicService.listTopics(opts)</span><br><span class=\"line\">      <span class=\"comment\">// 详情操作</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (opts.hasDescribeOption)</span><br><span class=\"line\">        topicService.describeTopic(opts)</span><br><span class=\"line\">      <span class=\"comment\">// 删除操作</span></span><br><span class=\"line\">      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (opts.hasDeleteOption)</span><br><span class=\"line\">        topicService.deleteTopic(opts)</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> e: <span class=\"type\">Throwable</span> =&gt;</span><br><span class=\"line\">        println(<span class=\"string\">&quot;Error while executing topic command : &quot;</span> + e.getMessage)</span><br><span class=\"line\">        error(<span class=\"type\">Utils</span>.stackTrace(e))</span><br><span class=\"line\">        exitCode = <span class=\"number\">1</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">      topicService.close()</span><br><span class=\"line\">      <span class=\"type\">Exit</span>.exit(exitCode)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"kafka主题命令\"><a href=\"#kafka主题命令\" class=\"headerlink\" title=\"kafka主题命令\"></a>kafka主题命令</h3><h4 id=\"创建主题\"><a href=\"#创建主题\" class=\"headerlink\" title=\"创建主题\"></a>创建主题</h4><ul>\n<li><p>如果设置了auto.create.topics.enabled=true(默认为true)，当生产者向一个未创建的主题发送消息时，就会自动创建一个拥有${num.partitions}个分区和${default.replication.factor}个副本的主题</p>\n</li>\n<li><p>手动创建主题，使用kafka-topics.sh脚本</p>\n</li>\n</ul>\n<p>创建kafka-action主题 (3个分区  1个副本[由于我只有一个brokers] )</p>\n<ul>\n<li>zookeeper参数  必传，zookeeper连接地址，已过期</li>\n<li>bootstrap-server  必传，替换原本的zookeeper参数，连接kafka地址</li>\n<li>partitions参数  必传，用于设置主题分区，通过分区分配策略，将一个主题的消息分散到多个分区并分别保存到不同的代理上，提高消息处理的吞吐量。kafka消费者和生产者可以采用多线程并行对主题消息进行处理，而每个线程处理的是一个分区的数据，因此分区实际上是kafka并行处理的基本单位。</li>\n<li>replication-factor参数  必传，设置主题副本数，副本会被分不在不同的集群节点上，副本数不能超过节点数，3个节点的kafka集群最多只能有3个副本</li>\n<li>config参数  可选，用来覆盖主题级别的默认配置</li>\n</ul>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-topics --create --bootstrap-server localhost:<span class=\"number\">9092</span> --partitions <span class=\"number\">3</span> --replication-factor <span class=\"number\">1</span> --topic kafka-action</span><br><span class=\"line\">#创建成功</span><br><span class=\"line\">Created topic kafka-action.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<pre><code>创建好之后，logs文件夹里就会出现kafka-action-0、kafka-action-1、kafka-action-2三个分区的文件夹</code></pre>\n<p>  之后去zookeeper客户端查看信息</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">ls /brokers/topics/kafka-action/partitions</span><br><span class=\"line\">[<span class=\"number\">0</span>, <span class=\"number\">1</span>, <span class=\"number\">2</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">get /brokers/topics/kafka-action</span><br><span class=\"line\">&#123;&quot;version&quot;:<span class=\"number\">1</span>,&quot;partitions&quot;:&#123;&quot;<span class=\"number\">2</span>&quot;:[<span class=\"number\">0</span>],&quot;<span class=\"number\">1</span>&quot;:[<span class=\"number\">0</span>],&quot;<span class=\"number\">0</span>&quot;:[<span class=\"number\">0</span>]&#125;&#125;</span><br><span class=\"line\">cZxid = <span class=\"number\">0</span>x36</span><br><span class=\"line\">ctime = Tue May <span class=\"number\">12</span> <span class=\"number\">14</span>:<span class=\"number\">32</span>:<span class=\"number\">07</span> CST <span class=\"number\">2020</span></span><br><span class=\"line\">mZxid = <span class=\"number\">0</span>x36</span><br><span class=\"line\">mtime = Tue May <span class=\"number\">12</span> <span class=\"number\">14</span>:<span class=\"number\">32</span>:<span class=\"number\">07</span> CST <span class=\"number\">2020</span></span><br><span class=\"line\">pZxid = <span class=\"number\">0</span>x38</span><br><span class=\"line\">cversion = <span class=\"number\">1</span></span><br><span class=\"line\">dataVersion = <span class=\"number\">0</span></span><br><span class=\"line\">aclVersion = <span class=\"number\">0</span></span><br><span class=\"line\">ephemeralOwner = <span class=\"number\">0</span>x0</span><br><span class=\"line\">dataLength = <span class=\"number\">52</span></span><br><span class=\"line\">numChildren = <span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"删除主题\"><a href=\"#删除主题\" class=\"headerlink\" title=\"删除主题\"></a>删除主题</h4><p>删除主题的两种方式</p>\n<ul>\n<li><p>手动删除各节点${log.dir}目录下该主题文件夹，同时登录zookeeper客户端删除待删除主题对应的节点，主题保存在/brokers/topics和/config/topics目录下</p>\n</li>\n<li><p>执行kafka-topics脚本删除，如果要彻底删除需要配置delete.topic.enable=true(默认false)，否则并未真正删除，而是在zookeeper的/admin/delete_topics目录下创建一个与待删除主题同名的节点，将该主题标记为删除状态</p>\n</li>\n</ul>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-topics --delete --bootstrap-server localhost:<span class=\"number\">9092</span> --topic kafka-action</span><br><span class=\"line\"></span><br><span class=\"line\">Topic kafka-action is marked <span class=\"keyword\">for</span> deletion.</span><br><span class=\"line\"><span class=\"function\">Note: <span class=\"title\">This</span> <span class=\"title\">will</span> <span class=\"title\">have</span> <span class=\"title\">no</span> <span class=\"title\">impact</span> <span class=\"title\">if</span> <span class=\"title\">delete.topic.enable</span> <span class=\"title\">is</span> <span class=\"title\">not</span> <span class=\"title\">set</span> <span class=\"title\">to</span> <span class=\"title\">true</span>.</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查看主题\"><a href=\"#查看主题\" class=\"headerlink\" title=\"查看主题\"></a>查看主题</h4><p>kafka提供了list和describe命令查看主题信息，list列出所有主题名，describe查看所有主题或者某个特定主题的信息</p>\n<p><strong>查看所有主题</strong></p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-topics --list --bootstrap-server localhost:<span class=\"number\">9092</span></span><br><span class=\"line\">kafka-test</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看详细信息</strong></p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-topics --describe --bootstrap-server localhost:<span class=\"number\">9092</span></span><br><span class=\"line\"><span class=\"function\">Topic:<span class=\"title\">kafka</span>-<span class=\"title\">test</span>        <span class=\"title\">PartitionCount</span>:3        <span class=\"title\">ReplicationFactor</span>:1     <span class=\"title\">Configs</span>:</span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"title\">Topic</span>: <span class=\"title\">kafka</span>-<span class=\"title\">test</span>       <span class=\"title\">Partition</span>: 0    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 0     <span class=\"title\">Isr</span>: 0</span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"title\">Topic</span>: <span class=\"title\">kafka</span>-<span class=\"title\">test</span>       <span class=\"title\">Partition</span>: 1    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 0     <span class=\"title\">Isr</span>: 0</span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"title\">Topic</span>: <span class=\"title\">kafka</span>-<span class=\"title\">test</span>       <span class=\"title\">Partition</span>: 2    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 0     <span class=\"title\">Isr</span>: 0</span></span><br><span class=\"line\"><span class=\"function\">        </span></span><br><span class=\"line\"><span class=\"function\">&gt;<span class=\"title\">kafka</span>-<span class=\"title\">topics</span> --<span class=\"title\">describe</span> --<span class=\"title\">zookeeper</span> <span class=\"title\">bootstrap</span>-<span class=\"title\">server</span>:9092 --<span class=\"title\">topic</span> <span class=\"title\">kafka</span>-<span class=\"title\">test</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">Topic:kafka</span>-<span class=\"title\">test</span>        <span class=\"title\">PartitionCount</span>:3        <span class=\"title\">ReplicationFactor</span>:1     <span class=\"title\">Configs</span>:</span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"title\">Topic</span>: <span class=\"title\">kafka</span>-<span class=\"title\">test</span>       <span class=\"title\">Partition</span>: 0    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 0     <span class=\"title\">Isr</span>: 0</span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"title\">Topic</span>: <span class=\"title\">kafka</span>-<span class=\"title\">test</span>       <span class=\"title\">Partition</span>: 1    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 0     <span class=\"title\">Isr</span>: 0</span></span><br><span class=\"line\"><span class=\"function\">        <span class=\"title\">Topic</span>: <span class=\"title\">kafka</span>-<span class=\"title\">test</span>       <span class=\"title\">Partition</span>: 2    <span class=\"title\">Leader</span>: 0       <span class=\"title\">Replicas</span>: 0     <span class=\"title\">Isr</span>: 0</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>查看正在同步的主题</strong></p>\n<p>通过describe与under-replicated-partitions命令组合使用，可以查看处于”under replicated”状态的分区，处于该状态的主题可能正在进行同步操作。</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-topics --describe --bootstrap-server localhost:<span class=\"number\">9092</span> --under-replicated-partitions</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看没有Leader的分区</strong></p>\n<p>通过describe与unavailable-partitions命令组合使用，可以查看没有leader副本的主题。</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-topics --describe --bootstrap-server localhost:<span class=\"number\">9092</span> --unavailable-partitions</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看主题覆盖的配置</strong></p>\n<p>通过describe和topics-with-overrides命令组合使用，可以查看主题覆盖了哪些配置。</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-topics --describe --bootstrap-server localhost:<span class=\"number\">9092</span> --topics-with-overrides</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改主题\"><a href=\"#修改主题\" class=\"headerlink\" title=\"修改主题\"></a>修改主题</h4><p>创建一个主题后，可以通过alter命令对主题进行修改，包括修改主题级别的配置、增加主题分区、修改副本分配方案、修改主题offset等</p>\n<p><strong>修改主题级别配置</strong></p>\n<p>可以使用alter和config参数组合来修改或者增加新的配置以覆盖相应配置原来的值，或者alter和delete-config来删除相应配置使其恢复默认值</p>\n<p>alter修改配置已被废除，现在使用kafka-configs脚本(后续介绍)</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-topics --alter --bootstrap-server localhost:<span class=\"number\">9092</span> --topic kafka-test --config max.message.bytes=<span class=\"number\">204800</span></span><br><span class=\"line\"><span class=\"function\">WARNING: <span class=\"title\">Altering</span> <span class=\"title\">topic</span> <span class=\"title\">configuration</span> <span class=\"title\">from</span> <span class=\"title\">this</span> <span class=\"title\">script</span> <span class=\"title\">has</span> <span class=\"title\">been</span> <span class=\"title\">deprecated</span> <span class=\"title\">and</span> <span class=\"title\">may</span> <span class=\"title\">be</span> <span class=\"title\">removed</span> <span class=\"title\">in</span> <span class=\"title\">future</span> <span class=\"title\">releases</span>.</span></span><br><span class=\"line\"><span class=\"function\">         <span class=\"title\">Going</span> <span class=\"title\">forward</span>, <span class=\"title\">please</span> <span class=\"title\">use</span> <span class=\"title\">kafka</span>-<span class=\"title\">configs.sh</span> <span class=\"title\">for</span> <span class=\"title\">this</span> <span class=\"title\">functionality</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">Updated</span> <span class=\"title\">config</span> <span class=\"title\">for</span> <span class=\"title\">topic</span> <span class=\"title\">kafka</span>-<span class=\"title\">test</span>.</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>增加分区</strong></p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-topics --alter --bootstrap-server localhost:<span class=\"number\">9092</span> --topic kafka-test --partitions <span class=\"number\">5</span></span><br></pre></td></tr></table></figure>\n\n<h2 id><a href=\"#\" class=\"headerlink\" title></a></h2>","categories":["kafka"],"tags":["kafka"]},{"title":"kafka安全机制","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%93%8D%E4%BD%9C/kafka%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6/","content":"<h2 id=\"安全机制\"><a href=\"#安全机制\" class=\"headerlink\" title=\"安全机制\"></a>安全机制</h2><p>kafka有身份认证和权限控制两种安全机制</p>\n<a id=\"more\"></a>\n\n<h3 id=\"身份认证\"><a href=\"#身份认证\" class=\"headerlink\" title=\"身份认证\"></a>身份认证</h3><p>身份认证是指客户端与服务端连接进行身份认证，包括客户端与kafka代理之间的连接认证、代理之间的连接认证、代理与zookeeper之间的连接认证。目前支持SSL、SASL/GSSAPI、SASL/PLAIN、SASL/SCRAM-SHA-256 和SASL/SCRAM-SHA-512、SASL/OAUTHBEARER</p>\n<h4 id=\"使用SASL-PLAIN进行身份认证\"><a href=\"#使用SASL-PLAIN进行身份认证\" class=\"headerlink\" title=\"使用SASL/PLAIN进行身份认证\"></a>使用SASL/PLAIN进行身份认证</h4><ul>\n<li><p>修改server.properties，开启SASL认证配置</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#配置SASL端口</span></span><br><span class=\"line\"><span class=\"attr\">listeners</span>=<span class=\"string\">SASL_PLAINTEXT://localhost:9092</span></span><br><span class=\"line\"><span class=\"comment\">#设置代理之间的通信协议</span></span><br><span class=\"line\"><span class=\"meta\">security.inter.broker.protocol</span>=<span class=\"string\">SASL_PLAINTEXT</span></span><br><span class=\"line\"><span class=\"comment\">#启用SASL机制</span></span><br><span class=\"line\"><span class=\"meta\">sasl.enabled.mechanisms</span>=<span class=\"string\">PLAIN</span></span><br><span class=\"line\"><span class=\"comment\">#配置SASL机制</span></span><br><span class=\"line\"><span class=\"meta\">sasl.mechanism.inter.broker.protocol</span>=<span class=\"string\">PLAIN</span></span><br><span class=\"line\"><span class=\"comment\">#超级管理员</span></span><br><span class=\"line\"><span class=\"meta\">super.users</span>=<span class=\"string\">User:admin</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改zookeeper.properties，开启sasl认证</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">authProvider.1</span>=<span class=\"string\">org.apache.zookeeper.server.auth.SASLAuthenticationProvider</span></span><br><span class=\"line\"><span class=\"attr\">requireClientAuthScheme</span>=<span class=\"string\">sasl</span></span><br><span class=\"line\"><span class=\"attr\">jaasLoginRenew</span>=<span class=\"string\">3600000</span></span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n<ul>\n<li><p>创建zookeeper的JAAS文件，创建”kafka_zk_jaas.conf”</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">Server &#123; #zookeeper服务端的配置</span><br><span class=\"line\">    org.apache.kafka.common.security.plain.PlainLoginModule required</span><br><span class=\"line\">    username&#x3D;&quot;admin&quot;</span><br><span class=\"line\">    password&#x3D;&quot;admin&quot;</span><br><span class=\"line\">    user_admin&#x3D;&quot;admin&quot;;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>在每个zookeeper中设置JVM参数   -Djava.security.auth.login.config=kafka_zk_jaas.conf文件所在的位置，在zookeeper-server-start.sh中添加</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">export KAFKA_OPTS=&quot;-Djava.security.auth.login.config=/usr/local/etc/kafka/kafka_zk_jaas.conf&quot;</span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n<ul>\n<li><p>创建服务端JAAS文件，配置PLAIN。创建一个服务端java验证与授权的JAAS文件”kafka_server_jaas.conf”，在文件中指定认证机制，并配置连接代理的用户名和密码。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">KafkaServer &#123; #KafkaServer用于指定服务端登录配置</span><br><span class=\"line\">    org.apache.kafka.common.security.plain.PlainLoginModule required #指定采用PLAIN机制</span><br><span class=\"line\">    username&#x3D;&quot;admin&quot; #使用username和password指定该代理与集群其他代理初始化连接的用户名和密码</span><br><span class=\"line\">    password&#x3D;&quot;admin&quot;</span><br><span class=\"line\">    user_admin&#x3D;&quot;admin&quot; #以&quot;user_&quot;为前缀后接用户名方式创建连接代理的用户名和密码  用户名为admin密码为admin</span><br><span class=\"line\">    user_morton&#x3D;&quot;kafka&quot;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">Client &#123; #kafka连接zookeeper的配置</span><br><span class=\"line\">    org.apache.kafka.common.security.plain.PlainLoginModule required #指定采用PLAIN机制</span><br><span class=\"line\">    username&#x3D;&quot;admin&quot; #使用username和password指定该代理与集群其他代理初始化连接的用户名和密码</span><br><span class=\"line\">    password&#x3D;&quot;admin&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在每个broker中设置JVM参数   -Djava.security.auth.login.config=kafka_server_jaas.conf文件所在的位置（这个可以在kafka-server-start.sh中修改）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">export KAFKA_OPTS=&quot;-Djava.security.auth.login.config=/usr/local/etc/kafka/kafka_server_jaas.conf&quot;</span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n<ul>\n<li><p>创建和配置客户端JAAS文件。”kafka_client_jaas.conf”在文件中指定客户端消费者和生产者连接KafkaServer的认证机制</p>\n<p>这里使用的用户最好不要使用初始化连接的用户名和密码</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">KafkaClient &#123; #KafkaClient用于指定客户端连接kafka服务端登录配置</span><br><span class=\"line\">    org.apache.kafka.common.security.plain.PlainLoginModule required</span><br><span class=\"line\">    username&#x3D;&quot;admin&quot;</span><br><span class=\"line\">    password&#x3D;&quot;admin&quot;;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<p>在启动生产者或者消费者时，在kafka-console-producer.sh和kafka-console-consumer.sh中设置JVM参数-Djava.security.auth.login.config=kafka_server_jaas.conf文件所在的位置</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">export KAFKA_OPTS=&quot;-Djava.security.auth.login.config=/usr/local/etc/kafka/kafka_client_jaas.conf&quot;</span><br></pre></td></tr></table></figure>\n\n<p>启动生产者  要带上–producer-property security.protocol=SASL_PLAINTEXT –producer-property sasl.mechanism=PLAIN配置，否则连接不上服务端</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-console-producer --bootstrap-server localhost:9092 --topic acls-test --producer-property security.protocol=SASL_PLAINTEXT --producer-property sasl.mechanism=PLAIN</span><br></pre></td></tr></table></figure>\n\n<p>也可以在producer.properties配置文件中添加配置</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">security.protocol</span>=<span class=\"string\">SASL_PLAINTEXT</span></span><br><span class=\"line\"><span class=\"meta\">sasl.mechanism</span>=<span class=\"string\">PLAIN</span></span><br></pre></td></tr></table></figure>\n\n<p>此时在使用producer的时候指定配置文件即可</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-console-producer --bootstrap-server localhost:9092 --topic acls-test --producer.config /usr/local/etc/kafka/producer.propertie</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h3 id=\"权限控制\"><a href=\"#权限控制\" class=\"headerlink\" title=\"权限控制\"></a>权限控制</h3><p>权限控制是指对客户端的读写操作进行权限控制，包括对于消息或kafka集群操作权限控制。权限控制是可插拔的，并且支持与外部的授权服务进行集成，kafka自带了简单的授权实现类SimpleAclAuthorizer，可以在server.properties文件配置authorizer.class.name指定，如设置authorizer.class.name=kafka.security.auth.SimpleAclAuthorizer</p>\n<h4 id=\"权限说明\"><a href=\"#权限说明\" class=\"headerlink\" title=\"权限说明\"></a>权限说明</h4><ul>\n<li><p>READ  读操作权限，如消费者消费主题的权限，消费组管理时读取相关元信息权限等</p>\n</li>\n<li><p>WRITE  写操作权限，如生产者向主题写消息的权限</p>\n</li>\n<li><p>DELETE  删除主题操作的权限</p>\n</li>\n<li><p>CREATE  创建主题操作的权限</p>\n</li>\n<li><p>ALTER  修改主题及配置操作的权限</p>\n</li>\n<li><p>DESCRIBE  获取主题元数据信息的权限</p>\n</li>\n<li><p>ClusterAction  集群元数据操作权限，如更新集群元数据操作、关闭控制器、停止副本等</p>\n</li>\n<li><p>ALL  所有权限</p>\n</li>\n</ul>\n<p>kafka将权限控制列表ACL存储在zookeeper中，添加权限控制之后，会在zookeeper中创建两个节点：即存储ACL信息的kafka-acl节点自己存储ACL变更信息的kafka-acl-changes节点</p>\n<p>Kafka-acls.sh脚本支持查询(list)、添加(add)、移除(remove)这3类权限控制的操作</p>\n<h4 id=\"启用ACL权限控制\"><a href=\"#启用ACL权限控制\" class=\"headerlink\" title=\"启用ACL权限控制\"></a>启用ACL权限控制</h4><p>需要在server.properties中添加权限控制实现类配置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">authorizer.class.name&#x3D;kafka.security.auth.SimpleAclAuthorizer</span><br></pre></td></tr></table></figure>\n\n<p>使用了该认证之后，生产者消费者都将无法连接，因为在开启权限后，默认条件下除了超级用户之外，所有用户都没有授予任何权限，可以在server.properties中调整</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">allow.everyone.if.no.acl.found</span>=<span class=\"string\">true</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"权限操作\"><a href=\"#权限操作\" class=\"headerlink\" title=\"权限操作\"></a>权限操作</h4><ul>\n<li><p>查询权限</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-acls --authorizer-properties zookeeper.connect=localhost:2181 --list</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>增加权限</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-acls --authorizer-properties zookeeper.connect=localhost:2181 --add --allow-principal User:morton --producer  --topic acls-test</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">输出内容</span></span><br><span class=\"line\">Adding ACLs for resource `ResourcePattern(resourceType=TOPIC, name=acls-test, patternType=LITERAL)`: </span><br><span class=\"line\">     (principal=User:morton, host=*, operation=DESCRIBE, permissionType=ALLOW)</span><br><span class=\"line\">    (principal=User:morton, host=*, operation=WRITE, permissionType=ALLOW)</span><br><span class=\"line\">    (principal=User:morton, host=*, operation=CREATE, permissionType=ALLOW) </span><br><span class=\"line\"></span><br><span class=\"line\">Current ACLs for resource `ResourcePattern(resourceType=TOPIC, name=acls-test, patternType=LITERAL)`: </span><br><span class=\"line\">     (principal=User:morton, host=*, operation=DESCRIBE, permissionType=ALLOW)</span><br><span class=\"line\">    (principal=User:morton, host=*, operation=WRITE, permissionType=ALLOW)</span><br><span class=\"line\">    (principal=User:morton, host=*, operation=CREATE, permissionType=ALLOW)</span><br></pre></td></tr></table></figure>\n\n<p>可以使用–operation参数指定添加具体的权限</p>\n<p>Describe/DescribeConfigs/Alter/IdempotentWrite/Read/Delete/Create/ClusterAction/All/Write/AlterConfigs </p>\n</li>\n<li><p>删除权限</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-acls --authorizer-properties zookeeper.connect=localhost:2181 --remove --topic acls-test</span><br></pre></td></tr></table></figure>\n\n<p>可以使用–operation参数指定删除具体的权限</p>\n</li>\n</ul>\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka连接器","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%93%8D%E4%BD%9C/kafka%E8%BF%9E%E6%8E%A5%E5%99%A8/","content":"<h2 id=\"连接器\"><a href=\"#连接器\" class=\"headerlink\" title=\"连接器\"></a>连接器</h2><p>kafka自带了对连接器应用的脚本，用于将数据从外部系统导入到kafka或从kafka中导出到外部系统。kafka连接器有独立模式和分布式模式两种工作模式。kafka自带脚本connect-standalone.sh和connect-distributed.sh分别对应kafka连接器的两种工作模式。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"独立模式\"><a href=\"#独立模式\" class=\"headerlink\" title=\"独立模式\"></a>独立模式</h3><p>kafka自带脚本connect-standalone.sh用于以独立模式启动kafka连接器。通过该脚本将文件中的数据导入到kafka以及将kafka中的数据导出到文件。</p>\n<h4 id=\"脚本\"><a href=\"#脚本\" class=\"headerlink\" title=\"脚本\"></a>脚本</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">if [ $# -lt 1 ];</span><br><span class=\"line\">then</span><br><span class=\"line\">        echo &quot;USAGE: $0 [-daemon] connect-standalone.properties&quot;</span><br><span class=\"line\">        exit 1</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">base_dir=$(dirname $0)</span><br><span class=\"line\"></span><br><span class=\"line\">if [ &quot;x$KAFKA_LOG4J_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">    export KAFKA_LOG4J_OPTS=&quot;-Dlog4j.configuration=file:$base_dir/../config/connect-log4j.properties&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">  export KAFKA_HEAP_OPTS=&quot;-Xms256M -Xmx2G&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">EXTRA_ARGS=$&#123;EXTRA_ARGS-&#x27;-name connectStandalone&#x27;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">COMMAND=$1</span><br><span class=\"line\">case $COMMAND in</span><br><span class=\"line\">  -daemon)</span><br><span class=\"line\">    EXTRA_ARGS=&quot;-daemon &quot;$EXTRA_ARGS</span><br><span class=\"line\">    shift</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">  *)</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">esac</span><br><span class=\"line\"></span><br><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh $EXTRA_ARGS org.apache.kafka.connect.cli.ConnectStandalone &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行该脚本时需要指定两个配置文件，一个是worker运行时相关配置的配置文件，称为WorkConfig，在该文件中指定与kafka建立连接的配置(bootstrap.servers)、数据格式转化类(key.converter/value.converter)、保存偏移量的文件路径(offset.storage.file.filename)、提交偏移量的频率(offset.flush.interval.ms)等。另一个是指定source连接器或是sink连接器配置的文件，可同时指定多个连接器配置，每个连接器配置文件对应一个连接器，因此要保证连接器名称全局唯一，连接器名通过name属性指定。</p>\n<p>connect-standalone.properties</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">bootstrap.servers</span>=<span class=\"string\">localhost:9092</span></span><br><span class=\"line\"><span class=\"meta\">key.converter</span>=<span class=\"string\">org.apache.kafka.connect.json.JsonConverter</span></span><br><span class=\"line\"><span class=\"meta\">value.converter</span>=<span class=\"string\">org.apache.kafka.connect.json.JsonConverter</span></span><br><span class=\"line\"><span class=\"meta\">key.converter.schemas.enable</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"meta\">value.converter.schemas.enable</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"meta\">offset.storage.file.filename</span>=<span class=\"string\">/tmp/connect.offsets</span></span><br><span class=\"line\"><span class=\"meta\">offset.flush.interval.ms</span>=<span class=\"string\">10000</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"Source连接器\"><a href=\"#Source连接器\" class=\"headerlink\" title=\"Source连接器\"></a>Source连接器</h4><p>Source连接器用于将外部数据导入到kafka相应主题中。kafka自带的connect-file-source.properties文件配置了一个读取文件的Source连接器</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name</span>=<span class=\"string\">local-file-source  # 连接器名称</span></span><br><span class=\"line\"><span class=\"meta\">connector.class</span>=<span class=\"string\">FileStreamSource #Source连接器执行类</span></span><br><span class=\"line\"><span class=\"meta\">tasks.max</span>=<span class=\"string\">1 # SourceTask数量</span></span><br><span class=\"line\"><span class=\"attr\">file</span>=<span class=\"string\">test.txt #该连接器数据源文件</span></span><br><span class=\"line\"><span class=\"attr\">topic</span>=<span class=\"string\">test-connect #数据导入的目标主题</span></span><br></pre></td></tr></table></figure>\n\n<p>该连接器运行一个task，执行将test.txt文件中的数据导入到一个名为”test-connect”的主题中</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">connect-standalone.sh ../config/connect-standalone.properties ../config/connect-file-source.properties</span><br></pre></td></tr></table></figure>\n\n<p>连接器启动后会在logs目录下创建一个connectStandalone.out日志文件，记录连接器运行时相关的日志。</p>\n<p>Source连接器是通过多个SourceTask共享一个KafkaProducer将数据发送到kafka，在Source连接器启动时，会加载ProduceConfig相关的配置信息。可以在connect-standalone.properties文件中通过”producer.”前缀来指定生产者级别的配置</p>\n<h4 id=\"Sink连接器\"><a href=\"#Sink连接器\" class=\"headerlink\" title=\"Sink连接器\"></a>Sink连接器</h4><p>kafka使用配置connect-file-sink.properties导出数据</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">name</span>=<span class=\"string\">local-file-sink #连接器名称</span></span><br><span class=\"line\"><span class=\"meta\">connector.class</span>=<span class=\"string\">FileStreamSink #Sink连接器执行类</span></span><br><span class=\"line\"><span class=\"meta\">tasks.max</span>=<span class=\"string\">1 #SinkTask数量</span></span><br><span class=\"line\"><span class=\"attr\">file</span>=<span class=\"string\">test-sink.txt #数据导出后输出的目标文件路径</span></span><br><span class=\"line\"><span class=\"attr\">topics</span>=<span class=\"string\">test-connect #导出数据源对应的主题名称，可指定多个主题</span></span><br></pre></td></tr></table></figure>\n\n<p>启动Sink连接器</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">connect-standalone.sh ../config/connect-standalone.properties ../config/connect-file-sink.properties</span><br></pre></td></tr></table></figure>\n\n<p>Sink连接器是通过KafkaConsumer从指定的主题消费消息，会加载ConsumerConfig的配置信息。在启动Sink连接器时可以在connect-standalone.properties中以”consumer.”为前缀来指定Consumer级别的配置。FileStreamSink默认是以Sink连接器名作为group.id的，且不同的连接要求名称全局唯一</p>\n<p>可以同时启动多个Sink连接器</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">connect-standalone.sh ../config/connect-standalone.properties ../config/connect-file-sink.properties ../config/connect-file-sink2.properties</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"连接器接口\"><a href=\"#连接器接口\" class=\"headerlink\" title=\"连接器接口\"></a>连接器接口</h3><p>kafka提供了一套基于rest风格的API接口来管理连接器，默认端口为8083，可以在WorkConfig配置文件中修改rest.port</p>\n<ul>\n<li><p>GET  /  查看kafka版本信息</p>\n</li>\n<li><p>GET /connectors  查看当前活跃的连接器列表</p>\n</li>\n<li><p>POST /connectors  根据指定配置，创建一个新的连接器</p>\n</li>\n<li><p>GET /connectors/{connector}  查看指定连接器的信息</p>\n</li>\n<li><p>GET /connectors/{connector}/config  查看指定连接器的配置信息</p>\n</li>\n<li><p>PUT /connectors/{connector}/config  修改指定连接器的配置</p>\n</li>\n<li><p>GET /connectors/{connector}/status  查看指定连接器的状态</p>\n</li>\n<li><p>POST /connectors/{connector}/restart  重启指定连接器</p>\n</li>\n<li><p>PUT /connectors/{connector}/pause  暂停指定连接器</p>\n</li>\n<li><p>PUT /connectors/{connector}/resume  恢复所指定的被暂停的连接器</p>\n</li>\n<li><p>GET /connectors/{connector}/tasks  查看指定连接器正在运行的task</p>\n</li>\n<li><p>POST /connectors/{connector}/tasks  修改task配置，即覆盖现有task，只支持分布式模式</p>\n</li>\n<li><p>GET /connectors/{connector}/tasks/{task}/status  查看指定连接器指定task的状态</p>\n</li>\n<li><p>POST /connectors/{connector}/tasks/{task}/restart  重启指定连接器指定task</p>\n</li>\n<li><p>DELETE /connectors/{connector}  删除指定连接器</p>\n</li>\n<li><p>GET /connector-plugins  查看已配置的连接器，显示连接器实例类完整路径</p>\n</li>\n<li><p>PUT /{connectorType}/config/validate  验证指定的配置，返回各配置</p>\n</li>\n</ul>\n<p>{connector}指待查看的连接器名</p>\n<p>{task}指待查看的Task的taskId</p>\n<p>{connectorType}指连接器配置文件中connector.class指定的值</p>\n<p>访问时需要加请求头 User-Agent  kafka-connect</p>\n<h3 id=\"分布式模式\"><a href=\"#分布式模式\" class=\"headerlink\" title=\"分布式模式\"></a>分布式模式</h3><p>使用connect-distributed脚本用于分布式模式进行连接器，该脚本只需指定workConfig类型的配置文件即可，不支持在启动时通过加载连接器配置文件创建一个连接器，而只能通过访问上述接口来创建连接器</p>\n<h4 id=\"脚本-1\"><a href=\"#脚本-1\" class=\"headerlink\" title=\"脚本\"></a>脚本</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">if [ $# -lt 1 ];</span><br><span class=\"line\">then</span><br><span class=\"line\">        echo &quot;USAGE: $0 [-daemon] connect-distributed.properties&quot;</span><br><span class=\"line\">        exit 1</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">base_dir=$(dirname $0)</span><br><span class=\"line\"></span><br><span class=\"line\">if [ &quot;x$KAFKA_LOG4J_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">    export KAFKA_LOG4J_OPTS=&quot;-Dlog4j.configuration=file:$base_dir/../config/connect-log4j.properties&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">  export KAFKA_HEAP_OPTS=&quot;-Xms256M -Xmx2G&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">EXTRA_ARGS=$&#123;EXTRA_ARGS-&#x27;-name connectDistributed&#x27;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">COMMAND=$1</span><br><span class=\"line\">case $COMMAND in</span><br><span class=\"line\">  -daemon)</span><br><span class=\"line\">    EXTRA_ARGS=&quot;-daemon &quot;$EXTRA_ARGS</span><br><span class=\"line\">    shift</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">  *)</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">esac</span><br><span class=\"line\"></span><br><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh $EXTRA_ARGS org.apache.kafka.connect.cli.ConnectDistributed &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"workConfig配置\"><a href=\"#workConfig配置\" class=\"headerlink\" title=\"workConfig配置\"></a>workConfig配置</h4><p>connect-distributed.properties</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">bootstrap.servers</span>=<span class=\"string\">localhost:9092</span></span><br><span class=\"line\"><span class=\"comment\">#连接器Cluster的唯一标识</span></span><br><span class=\"line\"><span class=\"meta\">group.id</span>=<span class=\"string\">connect-cluster</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">key.converter</span>=<span class=\"string\">org.apache.kafka.connect.json.JsonConverter</span></span><br><span class=\"line\"><span class=\"meta\">value.converter</span>=<span class=\"string\">org.apache.kafka.connect.json.JsonConverter</span></span><br><span class=\"line\"><span class=\"meta\">key.converter.schemas.enable</span>=<span class=\"string\">true</span></span><br><span class=\"line\"><span class=\"meta\">value.converter.schemas.enable</span>=<span class=\"string\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#用于存储Source连接器读取数据对应偏移量的主题，与存储消费者提交偏移量的内部主题作用相同，建议手动创建</span></span><br><span class=\"line\"><span class=\"meta\">offset.storage.topic</span>=<span class=\"string\">connect-offsets</span></span><br><span class=\"line\"><span class=\"meta\">offset.storage.replication.factor</span>=<span class=\"string\">1</span></span><br><span class=\"line\"><span class=\"comment\">#offset.storage.partitions=25</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#用于存储连接器相关配置信息的主题，包括创建连接的配置信息以及连接的task信息。要指定该主题拥有一个分区和多个副本，需要手动创建</span></span><br><span class=\"line\"><span class=\"meta\">config.storage.topic</span>=<span class=\"string\">connect-configs</span></span><br><span class=\"line\"><span class=\"meta\">config.storage.replication.factor</span>=<span class=\"string\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 用于存储连接器每个task状态的主题，需要手动创建</span></span><br><span class=\"line\"><span class=\"meta\">status.storage.topic</span>=<span class=\"string\">connect-status</span></span><br><span class=\"line\"><span class=\"meta\">status.storage.replication.factor</span>=<span class=\"string\">1</span></span><br><span class=\"line\"><span class=\"comment\">#status.storage.partitions=5</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 连接器task提交偏移量的时间间隔</span></span><br><span class=\"line\"><span class=\"meta\">offset.flush.interval.ms</span>=<span class=\"string\">10000</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"分布式模式启动\"><a href=\"#分布式模式启动\" class=\"headerlink\" title=\"分布式模式启动\"></a>分布式模式启动</h4><ul>\n<li><p>首先需要创建配置文件中对应的三个主题</p>\n</li>\n<li><p>启动分布式模式</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">connect-distributed.sh ../config/connect-distributed.properties</span><br></pre></td></tr></table></figure>\n\n<p>在连接器启动时会加载ProducerConfig以及ConsumerConfig中定义的配置项，所以在配置文件中可以设置以”producer.”为前缀的生产者级别配置以及以”consumer.”为前缀的消费者级别配置</p>\n</li>\n<li><p>创建一个FileStreamSource连接器</p>\n<p>使用rest请求创建连接器</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;name&quot;</span>:<span class=\"string\">&quot;test-source&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;config&quot;</span>:&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;topic&quot;</span>:<span class=\"string\">&quot;connect-distributed&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;connector.class&quot;</span>:<span class=\"string\">&quot;FileStreamSource&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;key.converter&quot;</span>:<span class=\"string\">&quot;org.apache.kafka.connect.storage.StringConverter&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;value.converter&quot;</span>:<span class=\"string\">&quot;org.apache.kafka.connect.storage.StringConverter&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;converter.internal.key.converter&quot;</span>:<span class=\"string\">&quot;org.apache.kafka.connect.storage.StringConverter&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;converter.internal.value.converter&quot;</span>:<span class=\"string\">&quot;org.apache.kafka.connect.storage.StringConverter&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;file&quot;</span>:<span class=\"string\">&quot;/tmp/input/connection-distributed.txt&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>创建一个FileStreamSink连接器</p>\n<p>使用rest请求创建连接器</p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;name&quot;</span>:<span class=\"string\">&quot;test-sink&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;config&quot;</span>:&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;topic&quot;</span>:<span class=\"string\">&quot;connect-distributed&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;connector.class&quot;</span>:<span class=\"string\">&quot;FileStreamSink&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;key.converter&quot;</span>:<span class=\"string\">&quot;org.apache.kafka.connect.storage.StringConverter&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;value.converter&quot;</span>:<span class=\"string\">&quot;org.apache.kafka.connect.storage.StringConverter&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;converter.internal.key.converter&quot;</span>:<span class=\"string\">&quot;org.apache.kafka.connect.storage.StringConverter&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;converter.internal.value.converter&quot;</span>:<span class=\"string\">&quot;org.apache.kafka.connect.storage.StringConverter&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;file&quot;</span>:<span class=\"string\">&quot;/tmp/output/connection-distributed.txt&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka配置","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%93%8D%E4%BD%9C/kafka%E9%85%8D%E7%BD%AE/","content":"<h2 id=\"配置管理\"><a href=\"#配置管理\" class=\"headerlink\" title=\"配置管理\"></a>配置管理</h2><p>kafka-configs脚本管理配置，支持修改(alter)和查看(describe)配置两个基本操作</p>\n<a id=\"more\"></a>\n\n<p>对于配置类型entity-type包含topics、clients、users、brokers</p>\n<ul>\n<li>topics 指定主题名称</li>\n<li>clients  指定客户端id</li>\n<li>users  设置了用户权限控制的用户名</li>\n<li>brokers  对应kafka代理的broke.id值</li>\n</ul>\n<p>对于这些配置存储在zookeeper中，写在zookeeper的 /config/<entity-type>/<entity-name>节点中，由于配置存储在zookeeper中，所以zookeeper参数是必传的</entity-name></entity-type></p>\n<ul>\n<li><p>若是修改类型的操作（alter）</p>\n<ul>\n<li><p>将相应配置写入/config/<entity-type>/<entity-name>节点中，在zookeeper中使用get /config/<entity-type>/<entity-name> 命令查看</entity-name></entity-type></entity-name></entity-type></p>\n</li>\n<li><p>在/config/changes/节点下创建一个以config_change_为前缀，之后连接按序递增的10位数字   通过get /config/changes/config_change_seqNo命令查看该节点信息</p>\n</li>\n</ul>\n</li>\n<li><p>若是查看类型操作（describe），则从/config/<entity-type>/<entity-name>节点的元数据信息中获取config对应的配置</entity-name></entity-type></p>\n</li>\n</ul>\n<h3 id=\"脚本\"><a href=\"#脚本\" class=\"headerlink\" title=\"脚本\"></a>脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh kafka.admin.ConfigCommand &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"配置命令\"><a href=\"#配置命令\" class=\"headerlink\" title=\"配置命令\"></a>配置命令</h3><h4 id=\"主题级别配置\"><a href=\"#主题级别配置\" class=\"headerlink\" title=\"主题级别配置\"></a>主题级别配置</h4><figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">#查看主题配置</span><br><span class=\"line\">&gt;kafka-configs --zookeeper localhost:<span class=\"number\">2181</span> --describe --entity-<span class=\"built_in\">type</span> topics --entity-name kafka-test</span><br><span class=\"line\">Configs <span class=\"keyword\">for</span> topic &#x27;kafka-test&#x27; are max.message.bytes=<span class=\"number\">204800</span></span><br><span class=\"line\"></span><br><span class=\"line\">#修改/添加主题配置   如果多个配置使用逗号隔开</span><br><span class=\"line\">&gt;kafka-configs --zookeeper localhost:<span class=\"number\">2181</span> --entity-<span class=\"built_in\">type</span> topics --entity-name kafka-test --alter --add-config max.message.bytes=<span class=\"number\">102400</span></span><br><span class=\"line\"></span><br><span class=\"line\">#删除主题配置  多个配置用逗号隔开</span><br><span class=\"line\">&gt;kafka-configs --zookeeper localhost:<span class=\"number\">2181</span> --entity-<span class=\"built_in\">type</span> topics --entity-name kafka-test --alter --delete-config max.message.bytes</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"代理级别配置\"><a href=\"#代理级别配置\" class=\"headerlink\" title=\"代理级别配置\"></a>代理级别配置</h4><p>提供了对于副本传输流量控制的配置，在分区迁移时很有用，通过对复制流量合理的控制，可以实现数据间的平滑迁移。</p>\n<ul>\n<li><p>follower.replication.throttled.rate    设置Follower复制的速率，单位B/s</p>\n</li>\n<li><p>leader.replication.throttled.rate   设置Leader节点传输速率，单位B/s</p>\n</li>\n</ul>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">#修改/新增配置</span><br><span class=\"line\">&gt;kafka-configs --zookeeper localhost:<span class=\"number\">2181</span> --entity-<span class=\"built_in\">type</span> brokers --entity-name <span class=\"number\">0</span> --alter --add-config follower.replication.throttled.rate=<span class=\"number\">10485760</span>,leader.replication.throttled.rate=<span class=\"number\">10485760</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"客户端-用户级别配置\"><a href=\"#客户端-用户级别配置\" class=\"headerlink\" title=\"客户端/用户级别配置\"></a>客户端/用户级别配置</h4><p>仅支持配置生产者每秒最多写入消息的字符数(producer_byte_rate)以及消费者每秒拉取消息的字节数(consumer_byte_rate)，称为流控设置</p>\n<h5 id=\"为用户添加流控\"><a href=\"#为用户添加流控\" class=\"headerlink\" title=\"为用户添加流控\"></a>为用户添加流控</h5><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">为用户mm配置生产者和消费者流量控制  在zookeeper的/config/users路径下创建mm节点，并将相应的限流信息存储到该节点中</span></span><br><span class=\"line\">kafka-configs --zookeeper localhost:2181 --alter --add-config &#x27;producer_byte_rate=1024,consumer_byte_rate=2048&#x27;  --entity-type users --entity-name mm </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看用户的流控信息</span></span><br><span class=\"line\">kafka-configs --zookeeper localhost:2181 --describe --entity-type users</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"为客户端添加流控\"><a href=\"#为客户端添加流控\" class=\"headerlink\" title=\"为客户端添加流控\"></a>为客户端添加流控</h5><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">为客户端acl配置生产者和消费者流量控制  在zookeeper的/config/clients路径下创建节点，并将相应的限流信息存储到该节点中</span></span><br><span class=\"line\">kafka-configs --zookeeper localhost:2181 --alter --add-config &#x27;producer_byte_rate=1024,consumer_byte_rate=2048&#x27;  --entity-type clients --entity-name acl </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查看客户端的流控信息</span></span><br><span class=\"line\">kafka-configs --zookeeper localhost:2181 --describe --entity-type clients</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"为特定用户的客户端添加流控\"><a href=\"#为特定用户的客户端添加流控\" class=\"headerlink\" title=\"为特定用户的客户端添加流控\"></a>为特定用户的客户端添加流控</h5><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">同时指定用户和客户端</span></span><br><span class=\"line\">kafka-configs --zookeeper localhost:2181 --alter --add-config &#x27;producer_byte_rate=1024,consumer_byte_rate=2048&#x27; --entity-type users --entity-name mm  --entity-type clients --entity-name acl </span><br></pre></td></tr></table></figure>\n\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka镜像操作","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%93%8D%E4%BD%9C/kafka%E9%95%9C%E5%83%8F%E6%93%8D%E4%BD%9C/","content":"<h2 id=\"镜像操作\"><a href=\"#镜像操作\" class=\"headerlink\" title=\"镜像操作\"></a>镜像操作</h2><p>kafka提供镜像操作，将一个集群的数据同步到另一个集群，本质是创建一个消费者，从源集群中待迁移的主题消费数据，然后创建一个生产者，将消费者从源集群中拉取的数据写入目标集群。</p>\n<a id=\"more\"></a>\n\n<p>使用kafka-mirror-maker.sh进行操作</p>\n<h3 id=\"脚本\"><a href=\"#脚本\" class=\"headerlink\" title=\"脚本\"></a>脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh kafka.tools.MirrorMaker &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"操作\"><a href=\"#操作\" class=\"headerlink\" title=\"操作\"></a>操作</h3><ul>\n<li><p>在源集群中分别创建消费者和生产者启动的配置文件</p>\n<p>生产者配置文件</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">bootstrap.servers</span>=<span class=\"string\">localhost:9091 #目标集群的代理地址列表</span></span><br></pre></td></tr></table></figure>\n\n<p>消费者配置文件</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">bootstrap.servers</span>=<span class=\"string\">localhost:9092 #源集群的代理地址列表</span></span><br><span class=\"line\"><span class=\"meta\">group.id</span>=<span class=\"string\">mirror</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>执行镜像工具（可以指定同步某个主题的数据  whitelist）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-mirror-maker --consumer.config ../config/consumer.properties --producer.config ../config/producer.properties --whitelist test-mirror</span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka之副本管理器","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%9C%8D%E5%8A%A1%E7%AB%AF/kafka%E4%B9%8B%E5%89%AF%E6%9C%AC%E7%AE%A1%E7%90%86%E5%99%A8/","content":"<h2 id=\"副本管理器\"><a href=\"#副本管理器\" class=\"headerlink\" title=\"副本管理器\"></a>副本管理器</h2><a id=\"more\"></a>","categories":["kafka"],"tags":["kafka"]},{"title":"kafka之协调器","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%9C%8D%E5%8A%A1%E7%AB%AF/kafka%E4%B9%8B%E5%8D%8F%E8%B0%83%E5%99%A8/","content":"<h2 id=\"协调器\"><a href=\"#协调器\" class=\"headerlink\" title=\"协调器\"></a>协调器</h2><p>kafka有消费者协调器、组协调器和任务管理协调器</p>\n<a id=\"more\"></a>\n\n<h3 id=\"消费者协调器\"><a href=\"#消费者协调器\" class=\"headerlink\" title=\"消费者协调器\"></a>消费者协调器</h3><p>负责同一个消费组下各消费者与服务端组协调器之间的通信，向组协调器提交加入消费组、离开消费组以及提交消费偏移量等请求</p>\n<h3 id=\"组协调器\"><a href=\"#组协调器\" class=\"headerlink\" title=\"组协调器\"></a>组协调器</h3><p>用于管理部分消费组和该消费组下各消费者的消费量，负责对组内消费者提交的相关请求进行处理</p>\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka之控制器","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%9C%8D%E5%8A%A1%E7%AB%AF/kafka%E4%B9%8B%E6%8E%A7%E5%88%B6%E5%99%A8/","content":"<h2 id=\"控制器\"><a href=\"#控制器\" class=\"headerlink\" title=\"控制器\"></a>控制器</h2><ul>\n<li><p>controller_epoch:用于记录控制器发生变更次数，即记录当前控制器是第几代控制器，初始值为0，每选出一个新的控制器该字段加一，每个控制器发送请求都会带上这个字段，<a id=\"more\"></a>如果请求的controller_epoch小于内存中的controller_epoch，责任无这个请求是已过期的控制器发送的请求，此请求无效。若该值大于内存中的controller_epoch的值，说明已经有新的控制器当选了。通过该值来保证集群控制器的唯一性，进而保证相关操作的一致性。该字段可以使用zookeeper执行get/controller_epoch查看</p>\n</li>\n<li><p>zkVersion：类似于数据库的乐观锁，用于更新zookeeper路径下相应元数据信息</p>\n</li>\n<li><p>leader_epoch:分区Leader更新次数。controller_epoch是相对代理而言的，而leader_epoch是相对分区来说的，由于各请求到达顺序不同，控制器通过controller_epoch和leader_epoch来确定具体执行哪个命令操作</p>\n</li>\n<li><p>已分配副本(assigned replica):每个分区的所有副本集合被称为已分配副本(AR)</p>\n</li>\n<li><p>LeaderAndIsr:kafka将Leader对应的brokeId和ISR列表封装为一个LeaderAndIsr类</p>\n</li>\n<li><p>优先副本(preferred replica):在AR中，第一个副本称为优先副本。理想情况下，优先副本应该是该分区的Leader，kafka要确保所有主题的优先副本在kafka集群中均衡分布，这样就保证了所有分区的Leader均衡分布。保证Leader在集群中均衡分布很重要，因为所有的读写请求都由分区Leader副本处理，如果Leader过于集中，就会造成集群负载不均衡。为了保证优先副本的均衡分布，kafka提供了5种分区选举器(PartitionLeaderSelector)，当分区数发生变化或是分区Leader宕机时就会通过分区选举器及时选出分区新的Leader</p>\n</li>\n</ul>\n<p>在启动kafka集群时，每一个代理都会实例化并启动一个KafkaController，并将该代理的brokerId注册到zookeeper的相应节点中。kafka集群中各代理会根据选举及只选出其中一个代理作为Leader，即Leader控制器。当控制器发生宕机后其他代理再次竞选出新的控制器。控制器负责主题的创建与删除、分区和副本的管理以及代理故障转移处理等。当一个代理被选举称为控制器时，该代理对应的KafkaController就会注册(Register)控制器相应的操作权限，同时标记自己是Leader。当代理不再是控制器时，就要注销掉(DeRegist)相应的权限。</p>\n<p>这些功能的入口是在kafka核心core工程下的kafka.controller.KafkaController类</p>\n<h3 id=\"控制器初始化\"><a href=\"#控制器初始化\" class=\"headerlink\" title=\"控制器初始化\"></a>控制器初始化</h3><p>每个代理在启动时都会实例化并启动一个KafkaController。初始化过程如下</p>\n<ul>\n<li><p>创建ControllerContext实例对象，用于缓存控制器各种处理操作所需要的数据结构(epoch、zkVersion、代理列表、主题列表、各主题对应的分区和副本的AR列表等)</p>\n</li>\n<li><p>实例化用于维护和管理分区状态的状态机PartitionStateMachine。kafka分区有四种状态</p>\n<ul>\n<li><p>NewPartition状态值0，分区被创建后为0，该状态下已得到副本分配，但还没有Leader和ISR信息</p>\n</li>\n<li><p>OnlinePartition状态值1，分区的Leader被选举出来后为1</p>\n</li>\n<li><p>OfflinePratition状态值2， 分区Leader成功选举出来之后，Leader的代理仍处于宕机状态，则该分区转为离线状态</p>\n</li>\n<li><p>NonExistentPartition状态值3，分区可能还没有创建，也可能是曾经创建过但是被删除了</p>\n</li>\n</ul>\n<p>分区状态机会注册两个监听器(<strong>//TODO不过后续版本主题不存储在zookeeper了，处理逻辑变了</strong>)</p>\n<ul>\n<li>TopicChangeListener用于监听/brokers/topics路径下子节点变化，当创建一个主题时，会在该路径下创建一个与该主题相同名称的子节点。主题发生变化时会触发该监听器，handleChildChange()方法会更新ControllerContext中维护的主题列表信息以及各主题对应分区的AR信息</li>\n<li>DeleteTopicsListener用于监听/admin/delete_topics子节点的变更，当删除一个主题时，会在该路径下创建一个与待删除主体名称相同的子节点，发生变化时触发该监听器，该监听器中的handleChildChange()方法会将待删除的主题从/brokers/topic路径下移除，并将该主题加入到TopicDeletionManager维护的记录待删除主题队列中，交给TopicDeletionManager执行删除</li>\n</ul>\n</li>\n<li><p>实例化一个对副本状态管理的状态机ReplicaStateMachine,kafka定义了7种状态</p>\n<ul>\n<li><p>NewRelica状态值为1，新创建的副本状态，该状态的副本只能接收成为Follower副本的转换请求</p>\n</li>\n<li><p>OnlineReplica状态值为2，副本被启动或者已是分区AR的一部分时，该副本处于在线状态，该状态下的副本可以接受Leader或Follower的转换请求</p>\n</li>\n<li><p>OfflineReplica状态值为3，副本所在代理已宕机，则该副本被设置为离线状态，表示该副本将要从ISR中下线</p>\n</li>\n<li><p>ReplicaDeletionStarted状态值为4，对处于离线状态的副本进行删除操作时，先将副本状态标记为此状态，表示正在进行删除离线副本的操作</p>\n</li>\n<li><p>ReplicaDeletionSucessful状态值为5，删除副本成功，删除请求没有错误码应答</p>\n</li>\n<li><p>ReplicaDeletionInelgible状态值为6，副本删除失败</p>\n</li>\n<li><p>NonExistentReplica状态值为7，副本删除成功</p>\n</li>\n</ul>\n<p>在副本状态机内有一个BrokerChangeListen监听器，监听zookeeper的brokers/ids/路径下各代理对应的brokeId节点的变化</p>\n</li>\n<li><p>创建用于将当前代理选举为控制器的ZookeeperLeaderElector选举器对象，有两个回调函数</p>\n<ul>\n<li><p>完成控制器相应初始化操作的onControllerFailover()方法</p>\n</li>\n<li><p>当新的控制器当选时让先前的控制器注销控制器权限的onControllerResignation()方法</p>\n</li>\n</ul>\n<p>kafka控制器的选举策略是在zookeeper的/controller路径下创建临时节点，并注册一个LeaderChangeListener，通过该监听器监听该临时节点，当临时节点信息发生变更时，触发监听器。</p>\n</li>\n<li><p>创建一个独立定时任务KafkaScheduler，用于控制器进行平衡操作，生命周期只有在代理成为Leader控制器期间有效</p>\n</li>\n<li><p>声明一个对主题操作管理的TopicDeletionManager对象。</p>\n</li>\n<li><p>创建一个用于在分区状态发生变化时为分区选举出Leader副本的分区选举器PartitionLeaderSelector，kafka提供了5种分区选举器</p>\n<ul>\n<li><p>OfflinePartitionLeaderSelector:分区状态机宕机、新创建一个分区或是将一个分区状态由NewPartition状态、OfflinePartition状态转换到OnlinePartition状态会使用该选举器。该选举器的策略是首先判断是否有存活的ISR，若ISR中至少有一个存活的代理，则从ISR列表中选第一个存活的代理作为Leader，存活的ISR作为新的ISR；否则，若配置项unclean.leader.election.enable为true，则表示允许从不在ISR列表中的副本选举Leader，同时AR中若有存活的副本，则从AR列表中选第一个代理作为Leader，存活的AR作为新的ISR。</p>\n</li>\n<li><p>ReassignedPartitionLeaderSelector:当分区进行重分配时会调用该选举器。该选举器的选举策略是从AR列表中找出存活的副本列表，若有存活的副本则去存活副本列表中的第一个副本作为Leader，将当前ISR作为新的ISR，将AR作为接受LeaderAndIsr请求的副本集合。</p>\n</li>\n<li><p>PreferredReplicaPartitionLeaderSelector:该选举器直接将优先副本设置为分区的Leader。</p>\n</li>\n<li><p>ControllerdShutdownLeaderSelector:该选举器将从ISR中剔除已关闭的节点，将剔除后的ISR作为新的ISR，同时从新的ISR中选举第一个作为Leader副本。将AR中剔除已关闭节点的副本节点作为接受LeaderAndIsr请求的副本集合</p>\n</li>\n<li><p>NoOpLeaderSelector:该选举器只返回当前分区的Leader和ISR</p>\n</li>\n</ul>\n</li>\n<li><p>实例化ControllerBrokerRequestBatch，用来记录和缓存分区状态机以及副本状态机中handleStateChange()方法中产生的request，控制器将这些request交给ControllerBrokerRequestBatch.sendRequestsToBrokers()方法批量发送出去，交由KafkaApis调用相应的handle方法进行处理</p>\n</li>\n<li><p>实例化3个监听器，用于监听分区重分配的PartitionsReassignedListener，用于监听当分区变化时触发的PreferredReplicaPartitionLeaderSelector选举器将优先副本选举为Leader的PerferredReplicaElectionListener、用于监听当ISR发生变化时将ISR变化通知给Zookeeper进行更新操作，同时向所有的代理节点发送元数据修改请求的IsrChangeNotificationListener</p>\n</li>\n</ul>\n<h3 id=\"控制器选举过程\"><a href=\"#控制器选举过程\" class=\"headerlink\" title=\"控制器选举过程\"></a>控制器选举过程</h3><p>每个代理启动时都会创建一个KafkaController实例，当kafkaController启动后就会从所有代理中选择一个代理作为Leader，称为Leader选举。除了在启动时选举外，当控制器所在代理发生故障或zookeeper通过心跳机制感知控制器与自己的连接Session已过期时，也会再次进行选举。</p>\n<p>ZookeeperLeaderElector这个类负责控制器选举(0.11版本，之后换了)，ZookeeperLeaderElector启动时首先注册一个LeaderChangeListener，负责监听zookeeper的/controller节点数据变化，该节点存储了当前Leader的brokerId，数据格式为json。当该节点数据发生变化时，比较当前代理的brokeId与当前Leader的brokeId是否相同，若不同，表示当前代理已不是Leader，则回调onControllerResignnation退位，注销Leader的权限，表示当前代理状态设置为RunningAsBroker，同时将代理的leader_epoch和zkVersion设置为0.当该节点数据被删除时，若当前代理是Leader，则先退位，然后再触发选举，否则直接触发选举</p>\n<p>控制器选举算法入口为ZooKeeperLeaderElector.select()方法</p>\n<p>每个代理先从zookeeper的/controller节点获取Leader信息，解析当前Leader的leaderId，若leaderId等于-1，表示还没有成功选举出Leader，则该代理将封装有自己brokeId的信息请求zookeeper将该数据写入/controller节点。如果leaderId不为-1，则表示已有代理抢先成为了Leader，则停止选举。若写入代理信息成功，则当前代理即为所选出的Leader。</p>\n<p>在抢占写/controller节点时若发生非ZkNodeExistsException异常，则会将leaderId设置为-1，同时删除存储在/controller节点的元数据信息，以便让请求最先到达zookeeper的代理成为Leader，由于删除了/controller节点将会触发LeaderChangeListener.handleDataDelete()方法，就会重新选举Leader。同时/controller节点数据变化，会触发LeaderChangeListener.handleDataChange()方法，其他代理通过当前的leaderId与自己的brokerId比较，若在节点数据发生前自己是Leader，现在leaderId与自己的brokeId不同,则自己退位,回调onControllerResignation函数</p>\n<h3 id=\"故障转移\"><a href=\"#故障转移\" class=\"headerlink\" title=\"故障转移\"></a>故障转移</h3><p>触发控制器进行选举的3种情况：一是控制器启动的时候，二是当控制器发生故障转移的时候，三是当心跳检测超时的时候</p>\n<p>控制器故障转移的本质是控制权的转移，重新选出新的控制器。还是ZookeeperLeaderElector对象的两个回调方法</p>\n<ul>\n<li>onControllerFailover()当选为控制器时注册相应权限<ul>\n<li>从zookeeper的/controller_epoch路径读取当前控制器的轮值次数，并更新到ControllerContext中</li>\n<li>将控制器轮值数加一，并尝试更新/controller_epoch中记录的次数值，若更新失败表示当前控制器已经被其他控制器替代</li>\n<li>注册分区管理相关的监听器。用于监听zookeeper下的/admin/reassign_partitions节点引发分区重分配操作的PartitionsReassignedListener；用于监听zookeeper的/isr_change_notification节点用于处理分区ISR发生变化的IsrChangeNotificationListener；用于监听/admin/preferred_replica_election节点将优先副本选为分区Leader操作的PreferredReplicaElectionListner</li>\n<li>注册主题管理的监听器。</li>\n<li>注册代理变化处理的监听器</li>\n<li>初始化ControllerContext，当一个代理称为控制器后，原控制器所持有的ControllerContext会被重新赋值</li>\n<li>启动分区状态机和副本状态机</li>\n<li>从ControllerContext中读取所有主题，为每个主题添加用于监听分区变化的PartitionModificationsListener</li>\n<li>检测当前是否有分区需要触发分区重分配操作</li>\n<li>检测当前是否又需要将优先副本选举为Leader的分区</li>\n<li>向kafka集群中所有存活的代理发送更新元数据请求</li>\n<li>根据auto.leader.reblance.enable配置决定是否创建用于分区平衡的定时任务。</li>\n<li>启动TopicDeletionManager组件</li>\n</ul>\n</li>\n<li>onControllerResignation()不再是控制器时注销权限的<ul>\n<li>取消该控制器在zookeeper中注册的用于对分区及副本变化感知的监听器的监听</li>\n<li>关闭删除主题操作的TopicDeletionManager组件，并关闭分区平衡的定时任务</li>\n<li>在获取ControllerContext维护的重入锁的条件下取消对ISR变化的监听，关闭分区状态机和副本状态机，关闭控制器与其他代理之间进行通信的ControllerChannelManager</li>\n<li>将ControllerContext中用于记录控制器轮值次数以及轮值数对应的epochZkVersion字段置零，并将当前代理状态设置为RunningAsBroker</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"代理上下线\"><a href=\"#代理上下线\" class=\"headerlink\" title=\"代理上下线\"></a>代理上下线</h3><p>代理上下线操作BrokerChangeListener进行处理</p>\n<ul>\n<li><p>代理上线</p>\n<p>代理上线时，在代理启动时会向Zookeeper的/broker/ids节点下注册该代理的brokerId，此时会被副本状态机在Zookeeper所注册的BrokerChangeListener监听器监听到该节点信息的变化，通过zookeeper中记录的信息以及ControllerContext缓存的节点信息，计算出新上线的节点集合，对新上线的代理节点调用ControllerChangeManager.addBroker()方法完成新上线代理网络层相关初始化处理。然后调用KafkaController.onBrokerStartup()方法进行处理</p>\n<ul>\n<li>向集群当前所有代理发送UpdateMetadataRequest请求，使得代理知道有新的代理加入</li>\n<li>查找被分配到新上线节点的副本集合，通过副本状态机对副本状态进行相应变迁处理，将这些副本变成OnlineReplica，并通过分区状态机对分区状态为NewPartition和OfflinePartition的分区进行处理，将其状态转至OnlinePartition状态，并触发一次分区Leader选举，以确认新增的代理是否为Leader</li>\n<li>轮询被分配到新上线代理的副本，进行分区副本操作</li>\n<li>恢复由于新代理上线而被暂停的删除主题操作线程</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"代理下线\"><a href=\"#代理下线\" class=\"headerlink\" title=\"代理下线\"></a>代理下线</h3><p>代理下线时，该代理在zookeeper的brokers/ids节点中注册的与该代理对应的节点将被删除，BrokerChangeListener的handleChildChange()方法被触发</p>\n<ul>\n<li>查找下线节点集合</li>\n<li>轮询下线节点，调用ControllerChannelManager.removeBroker()方法，关闭每个下线节点的网络连接，清空下线节点的消息队列，关闭下线节点发送Request请求的线程</li>\n<li>最后调用KafkaController的onBrokerFailure()方法进行处理<ul>\n<li>查找Leader副本下线节点上的分区，将这些分区状态设置为OfflinePartition,并处理相应状态变迁，调用分区状态机的triggerOnlinePartitionStateChange()方法将处于分区选举器为分区选出Leader，并将Leader和ISR信息写入到zookeeper中，同时发送UpdateMatadataRequest请求更新元数据信息</li>\n<li>查找所有下线节点上的副本集合，将该集合分成两部分，一部分是待删除主题副本，将这些副本状态转换为ReplicaDeletionInteligible，标记副本对应的主题暂时不可被删除。另一部分为当前处于正常使用的主题的副本，将副本状态由OnlineReplica转化为OfflineReplica，将该副本节点从分区ISR中删除，并发送StopReplicaRequest请求，停止该副本从Leader副本同步消息的操作，发送LeaderAndIsrRequest请求，该分区Leader副本和Follower副本根据角色不同分别进行相应处理，同时发送UpdateMatadataRequest请求，更新当前所有存活代理的缓存的元数据信息</li>\n<li>若分区Leader副本分配在下线节点上的所有分区状态转换操作执行完成，则向集群所有存活的代理发送更新元数据的UpdateMetadataRequest请求，执行元数据更新操作</li>\n</ul>\n</li>\n</ul>\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka之日志管理器","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%9C%8D%E5%8A%A1%E7%AB%AF/kafka%E4%B9%8B%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E5%99%A8/","content":"<h2 id=\"日志管理器\"><a href=\"#日志管理器\" class=\"headerlink\" title=\"日志管理器\"></a>日志管理器</h2><p>日志管理器是kafka用来管理所有日志的，负责管理日志的创建与删除、日志检索、日志加载和恢复、检查点及日志文件刷写磁盘以及日志清理等</p>\n<a id=\"more\"></a>\n\n<h3 id=\"kafka日志结构\"><a href=\"#kafka日志结构\" class=\"headerlink\" title=\"kafka日志结构\"></a>kafka日志结构</h3><p>kafka的消息是以主题为基本单位进行组织的，各个主题之间相互独立。每个主题在逻辑上又由一个或多个分区构成，分区数可以在创建主题的时候指定，也可以在主题创建后修改。每个分区可以有一个或多个副本，从副本中选出一个副本作为Leader，Leader负责与客户端进行读写操作，其他副本作为Follower。生产者将消息发送到Leader副本的代理节点，而Follower副本从Leader副本同步数据。</p>\n<p>在存储结构上分区的每个副本在逻辑上对应一个Log对象，每个Log又划分为多个LogSegment，每个LogSegment包括一个日志文件和两个索引文件，其中两个索引文件分别为偏移量索引文件和时间戳索引文件。</p>\n<p>在存储结构上每个分区副本对应一个目录，每个分区副本由一个或多个日志段(LogSegment)组成。每个日志段在物理结构上对应一个以.index后缀的偏移量索引文件、一个以.timeindex后缀的时间戳索引文件和一个以.log结尾的日志文件</p>\n<ul>\n<li><p>log.segment.bytes   日志文件的大小(默认1073741824   1G)</p>\n</li>\n<li><p>log.index.interval.bytes   索引文件跨度   默认4K</p>\n</li>\n</ul>\n<h4 id=\"日志文件\"><a href=\"#日志文件\" class=\"headerlink\" title=\"日志文件\"></a>日志文件</h4><p>可以使用命令来查看消息内容</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kafka-run-class.sh kafka.tools.DumpLogSegments --files 日志文件路径 --<span class=\"built_in\">print</span>-data-log</span><br></pre></td></tr></table></figure>\n\n<p>payload为消息体的实际内容</p>\n<h4 id=\"偏移量索引文件\"><a href=\"#偏移量索引文件\" class=\"headerlink\" title=\"偏移量索引文件\"></a>偏移量索引文件</h4><p>偏移量索引文件存储了若干个索引条目，索引条目用来将逻辑偏移量映射成消息在数据文件中的物理位置，每个索引条目由offset和position组成，offset表示与之对应的数据文件中某条消息的offset，position为与之对应的数据文件中某条消息的position。</p>\n<p>并不是每条消息都有索引，而是采用了稀疏索引的方式，每隔一定字节的数据建立一条索引。</p>\n<p>通过索引文件，我们就能够根据指定的偏移量快速定位到消息物理位置。首先根据指定的偏移量，通过二分查找，查询出该偏移量对应消息所在的日志文件和索引文件，然后在索引文件中通过二分查找，查找值小于等于指定偏移量的最大偏移量，最后从查找出的最大偏移量处开始顺序扫描日志文件，直至在日志文件中查询到偏移量于指定偏移量相等的数据</p>\n<h4 id=\"时间戳索引文件\"><a href=\"#时间戳索引文件\" class=\"headerlink\" title=\"时间戳索引文件\"></a>时间戳索引文件</h4><p>该索引文件与之对应的日志文件文件名相同，后缀为.timeindex，该索引文件包括一个8字节的时间戳字段和一个四字节的偏移量字段，时间戳记录的是该日志段目前为止最大的时间戳，偏移量则记录的是插入新的索引条目时，当前消息的偏移量</p>\n<p>时间戳索引文件中的时间戳对应的类型可以是消息创建时间，也可以是消息写入数据文件的时间，也采用了稀疏存储的方式</p>\n<h3 id=\"日志清理\"><a href=\"#日志清理\" class=\"headerlink\" title=\"日志清理\"></a>日志清理</h3><ul>\n<li>log.retention.check.interval.ms   每隔多久检查一次是否进行日志删除</li>\n<li>log.retention.hours/log.retention.minutes/log.retention.ms    日志保留时长，默认为168小时，即7天</li>\n<li>log.retention.bytes   基于日志大小来进行删除</li>\n</ul>\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka之网络通信","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%9C%8D%E5%8A%A1%E7%AB%AF/kafka%E4%B9%8B%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/","content":"<h2 id=\"网络通信\"><a href=\"#网络通信\" class=\"headerlink\" title=\"网络通信\"></a>网络通信</h2><p>kafkaServer启动时，初始化启动了一个SocketServer服务，用于接受客户端的连接、处理客户端请求、发送响应等，同时创建一个KafkaRequestHandlerPool用于管理KafkaRequestHandler。<a id=\"more\"></a>SocketServer是基于Java NIO实现的网络通信组件，线程模型为：一个Acceptor线程负责接收客户端所有的连接；{num.network.threads}个Processor线程，每个Processor有多个Selector，负责从每个连接中读取请求；{num.io.threads}个Handler线程处理请求，并将产生的请求返回给Processor线程。Handler是由KafkaRequestHandlerPool管理，在Processor和Handler之间通过RequestChannel来缓冲请求，每个Handler从RequestChannel.requestQueue接受RequestChannel.Request，并把Request交由KafkaApis的handle()方法处理，经处理后把对应的Response存进RequestChannel.responseQueues队列</p>\n<h3 id=\"Acceptor\"><a href=\"#Acceptor\" class=\"headerlink\" title=\"Acceptor\"></a>Acceptor</h3><p>监听并接受客户端的请求，建立和客户端的数据传输通道ServerSocketChannel，然后为客户端制定一个Processor</p>\n<h3 id=\"Processor\"><a href=\"#Processor\" class=\"headerlink\" title=\"Processor\"></a>Processor</h3><p>用于从客户端读取请求数据和将相应的响应结果返回给客户端。</p>\n<h3 id=\"RequestChannel\"><a href=\"#RequestChannel\" class=\"headerlink\" title=\"RequestChannel\"></a>RequestChannel</h3><p>为了给Processor线程与Handler线程之间通信提供数据缓冲，是通信过程中Request与Response缓存的通道，是Processor与Handler线程交换数据的地方。</p>\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka监控","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%9C%8D%E5%8A%A1%E7%AB%AF/kafka%E7%9B%91%E6%8E%A7/","content":"<h2 id=\"kafka监控\"><a href=\"#kafka监控\" class=\"headerlink\" title=\"kafka监控\"></a>kafka监控</h2><p>kafka使用Yammer Metrics进行内部状态的监控，用来收集报告KafkaServer端和客户端的metrics信息,可以将信息通过JMX、控制台、CSV、日志等形式发布出来。kafka默认通过JMX来报告metrics信息，可以通过JConsole或者Visual VM来查看metrics信息</p>\n<a id=\"more\"></a>\n\n<p>在kafka-run-calss.sh命令中指定JMX端口，JMX_PORT</p>\n<p>在启动kafka的时候可以增加JMX_PORT</p>\n","categories":["kafka"],"tags":["kafka"]},{"title":"MySQL事务","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E4%BA%8B%E5%8A%A1/","content":"<h2 id=\"MySQL事务\"><a href=\"#MySQL事务\" class=\"headerlink\" title=\"MySQL事务\"></a>MySQL事务</h2><p>事务：一个或一组SQL语句组成的一个执行单元，要么全部成功，要么全部失败。</p>\n<p>注：mysql中只有innodb支持事务</p>\n<a id=\"more\"></a>\n\n<h3 id=\"事务的ACID特性\"><a href=\"#事务的ACID特性\" class=\"headerlink\" title=\"事务的ACID特性\"></a>事务的ACID特性</h3><ul>\n<li>原子性(Atomicity)  指事务是一个不可分割的工作单位，事务中的操作要么都发生，要么都不发生</li>\n<li>一致性(Consistency)  指事务必须使数据库从一个一致性状态变成另一个一致性状态</li>\n<li>隔离性(Isolation) 指一个事务的执行不能被另一个事务干扰</li>\n<li>持久性(Durability) 指事务一旦被提交，对数据库中数据的改变是永久性的</li>\n</ul>\n<h3 id=\"事务的创建\"><a href=\"#事务的创建\" class=\"headerlink\" title=\"事务的创建\"></a>事务的创建</h3><p>默认情况下mysql的事务是自动提交的</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">show variables like &#39;%autocommit%&#39;;</span><br><span class=\"line\"></span><br><span class=\"line\">+---------------+-------+</span><br><span class=\"line\">| Variable_name | Value |</span><br><span class=\"line\">+---------------+-------+</span><br><span class=\"line\">| autocommit    | ON    |</span><br><span class=\"line\">+---------------+-------+</span><br><span class=\"line\"></span><br><span class=\"line\">#需要手动的禁用一下事务自动提交</span><br><span class=\"line\">set autocommit &#x3D; 0;</span><br><span class=\"line\">+---------------+-------+</span><br><span class=\"line\">| Variable_name | Value |</span><br><span class=\"line\">+---------------+-------+</span><br><span class=\"line\">| autocommit    | OFF   |</span><br><span class=\"line\">+---------------+-------+</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"事务的隔离级别\"><a href=\"#事务的隔离级别\" class=\"headerlink\" title=\"事务的隔离级别\"></a>事务的隔离级别</h3><h4 id=\"查看数据库的隔离级别\"><a href=\"#查看数据库的隔离级别\" class=\"headerlink\" title=\"查看数据库的隔离级别\"></a>查看数据库的隔离级别</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#mysql8中查看隔离级别</span><br><span class=\"line\">select @@transaction_isolation;</span><br><span class=\"line\"></span><br><span class=\"line\">+-------------------------+</span><br><span class=\"line\">| @@transaction_isolation |</span><br><span class=\"line\">+-------------------------+</span><br><span class=\"line\">| REPEATABLE-READ         |</span><br><span class=\"line\">+-------------------------+</span><br><span class=\"line\"></span><br><span class=\"line\">#mysql8之前查看隔离级别</span><br><span class=\"line\">select @@tx_isolation;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改数据库的隔离级别\"><a href=\"#修改数据库的隔离级别\" class=\"headerlink\" title=\"修改数据库的隔离级别\"></a>修改数据库的隔离级别</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#修改全局隔离级别</span><br><span class=\"line\">set global transaction isolation level read committed;</span><br><span class=\"line\">#修改会话隔离级别</span><br><span class=\"line\">set session transaction isolation level read committed;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"事务并发出现的问题\"><a href=\"#事务并发出现的问题\" class=\"headerlink\" title=\"事务并发出现的问题\"></a>事务并发出现的问题</h4><ul>\n<li>脏读  对于两个事务T1,T2，T1读取了已经被T2更新但还没有被提交的字段之后，若T2回滚，T1读取到的内容就是临时无效的</li>\n<li>不可重复读  对于两个事务T1,T2，T1读取了一个字段，T2更新了该字段，之后T1再次读取同一个字段，值就不同了(描述的是修改操作)</li>\n<li>幻读  对于两个事务T1,T2，T1从一个表中读取了一个字段，然后T2在该表中插入了一些新的行，T1再次读取同一个表，就会多出几行（描述的是插入操作）</li>\n</ul>\n<p>脏读和幻读相似，脏读属于修改操作，幻读属于插入操作</p>\n<h4 id=\"隔离级别\"><a href=\"#隔离级别\" class=\"headerlink\" title=\"隔离级别\"></a>隔离级别</h4><ul>\n<li>READ UNCOMMITED(读未提交的数据)  允许事务读取未被其他事务提交的变更，脏读、不可重复读、幻读问题都存在</li>\n<li>READ COMMITED(读已提交的数据)  只允许事务读取已被其他事务提交的数据，可以避免脏读，但是不可重复读和幻读仍存在</li>\n<li>REPEATABLE READ(可重复读)  确保事务可以多次从一个字段中读取相同的值，在这个事务持续期间，禁止其他事务对这个字段进行更新，可以避免脏读和不可重复读，但幻读仍存在(Mysql默认的事务隔离级别)</li>\n<li>SERIALIZABLE(串行化) 确保事务可以从一个表中读取相同的行，在这个事务持续期间，禁止其他事务对该表执行插入、更新和删除操作，所有并发问题都可以避免，但是性能低下</li>\n</ul>\n<h4 id=\"测试各个隔离级别\"><a href=\"#测试各个隔离级别\" class=\"headerlink\" title=\"测试各个隔离级别\"></a>测试各个隔离级别</h4><p>开启两个mysql连接，为mysql1和mysql2</p>\n<p>原始数据为</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select * from users;</span><br><span class=\"line\"> +----+---------+</span><br><span class=\"line\">| id | u_name  |</span><br><span class=\"line\">+----+---------+</span><br><span class=\"line\">|  2 | 张三    |</span><br><span class=\"line\">|  3 | 张三0   |</span><br><span class=\"line\">|  4 | 张三1   |</span><br><span class=\"line\">|  5 | 张三2   |</span><br><span class=\"line\">+----+---------+</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"测试READ-UNCOMMITTED\"><a href=\"#测试READ-UNCOMMITTED\" class=\"headerlink\" title=\"测试READ UNCOMMITTED\"></a>测试READ UNCOMMITTED</h5><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"> #首先设置mysql1和mysql2隔离级别为read uncommited</span><br><span class=\"line\"> set session transaction isolation level read uncommitted;</span><br><span class=\"line\"> #禁用mysql1 mysql2的自动提交</span><br><span class=\"line\"> set autocommit &#x3D; 0;</span><br><span class=\"line\"> </span><br><span class=\"line\"> update users set u_name&#x3D;&#39;李四&#39; where id &#x3D; 3;#①  mysql1修改数据但未提交</span><br><span class=\"line\"> select * from users where id &#x3D;3;#② mysql1 查询数据 为李四</span><br><span class=\"line\"> select * from users where id &#x3D;3;#③ mysql2 查询数据 也为李四 查询到了mysql1中未提交的数据 出现了脏读</span><br><span class=\"line\"> </span><br><span class=\"line\">insert into users (u_name) values (&#39;刘亦菲&#39;);#④mysql1 插入数据但未提交</span><br><span class=\"line\">select * from users where u_name &#x3D; &#39;刘亦菲&#39;;#⑤mysql1 查询到该数据</span><br><span class=\"line\">select * from users where u_name &#x3D; &#39;刘亦菲&#39;;#⑥mysql2 查询到该数据  出现了幻读</span><br><span class=\"line\"></span><br><span class=\"line\">rollback;#⑦mysql1 回滚之前的操作  此时mysql2在查询发现之前查询到的数据都变了 出现了不可重复读</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"测试read-commited\"><a href=\"#测试read-commited\" class=\"headerlink\" title=\"测试read commited\"></a>测试read commited</h5><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#首先设置mysql1和mysql2隔离级别为read commited</span><br><span class=\"line\"> set session transaction isolation level read committed;</span><br><span class=\"line\"> #禁用mysql1 mysql2的自动提交</span><br><span class=\"line\"> set autocommit &#x3D; 0;</span><br><span class=\"line\"> </span><br><span class=\"line\"> update users set u_name&#x3D;&#39;李四&#39; where id &#x3D; 3;#①  mysql1修改数据但未提交</span><br><span class=\"line\"> select * from users where id &#x3D;3;#② mysql1 查询数据 为李四</span><br><span class=\"line\"> select * from users where id &#x3D;3;#③ mysql2 查询数据 为张三0 没有出现脏读</span><br><span class=\"line\"> </span><br><span class=\"line\">insert into users (u_name) values (&#39;刘亦菲&#39;);#④mysql1 插入数据但未提交</span><br><span class=\"line\">select * from users where u_name &#x3D; &#39;刘亦菲&#39;;#⑤mysql1 查询到该数据</span><br><span class=\"line\">select * from users where u_name &#x3D; &#39;刘亦菲&#39;;#⑥mysql2 没有查询到该数据</span><br><span class=\"line\"></span><br><span class=\"line\">commit;#⑦mysql1 提交之前的操作  此时mysql2在查询发现之前查询到的数据都变了 出现了不可重复读</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"测试read-commited-1\"><a href=\"#测试read-commited-1\" class=\"headerlink\" title=\"测试read commited\"></a>测试read commited</h5><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#首先设置mysql1和mysql2隔离级别为read commited</span><br><span class=\"line\"> set session transaction isolation level read committed;</span><br><span class=\"line\"> #禁用mysql1 mysql2的自动提交</span><br><span class=\"line\"> set autocommit &#x3D; 0;</span><br><span class=\"line\"> </span><br><span class=\"line\"> update users set u_name&#x3D;&#39;李四&#39; where id &#x3D; 3;#①  mysql1修改数据但未提交</span><br><span class=\"line\"> select * from users where id &#x3D;3;#② mysql1 查询数据 为李四</span><br><span class=\"line\"> select * from users where id &#x3D;3;#③ mysql2 查询数据 为张三0 没有出现脏读</span><br><span class=\"line\"> </span><br><span class=\"line\">insert into users (u_name) values (&#39;刘亦菲&#39;);#④mysql1 插入数据但未提交</span><br><span class=\"line\">select * from users where u_name &#x3D; &#39;刘亦菲&#39;;#⑤mysql1 查询到该数据</span><br><span class=\"line\">select * from users where u_name &#x3D; &#39;刘亦菲&#39;;#⑥mysql2 没有查询到该数据</span><br><span class=\"line\"></span><br><span class=\"line\">commit;#⑦mysql1 提交之前的操作  此时mysql2在查询发现之前查询到的数据都变了 出现了不可重复读</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"测试repeatable-read\"><a href=\"#测试repeatable-read\" class=\"headerlink\" title=\"测试repeatable read\"></a>测试repeatable read</h5><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#首先设置mysql1和mysql2隔离级别为repeatable read</span><br><span class=\"line\"> set session transaction isolation level repeatable read;</span><br><span class=\"line\"> #禁用mysql1 mysql2的自动提交</span><br><span class=\"line\"> set autocommit &#x3D; 0;</span><br><span class=\"line\"> </span><br><span class=\"line\"> update users set u_name&#x3D;&#39;李四&#39; where id &#x3D; 3;#①  mysql1修改数据但未提交</span><br><span class=\"line\"> select * from users where id &#x3D;3;#② mysql1 查询数据 为李四</span><br><span class=\"line\"> select * from users where id &#x3D;3;#③ mysql2 查询数据 为张三0 没有出现脏读</span><br><span class=\"line\"> </span><br><span class=\"line\">insert into users (u_name) values (&#39;刘亦菲&#39;);#④mysql1 插入数据但未提交</span><br><span class=\"line\">select * from users where u_name &#x3D; &#39;刘亦菲&#39;;#⑤mysql1 查询到该数据</span><br><span class=\"line\">select * from users where u_name &#x3D; &#39;刘亦菲&#39;;#⑥mysql2 没有查询到该数据</span><br><span class=\"line\"></span><br><span class=\"line\">commit;#⑦mysql1 提交之前的操作  此时mysql2还是没有数据</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"保存点savepoint\"><a href=\"#保存点savepoint\" class=\"headerlink\" title=\"保存点savepoint\"></a>保存点savepoint</h3><p>在一个事务中可以设置保存点，和rollback搭配使用</p>\n<h4 id=\"测试保存点\"><a href=\"#测试保存点\" class=\"headerlink\" title=\"测试保存点\"></a>测试保存点</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select * from users;</span><br><span class=\"line\"></span><br><span class=\"line\">+------+-----------+</span><br><span class=\"line\">| id   | u_name    |</span><br><span class=\"line\">+------+-----------+</span><br><span class=\"line\">|    2 | 张三      |</span><br><span class=\"line\">|    3 | 李四      |</span><br><span class=\"line\">|    4 | 张三1     |</span><br><span class=\"line\">|    5 | 张三2     |</span><br><span class=\"line\">| 1006 | 刘亦菲    |</span><br><span class=\"line\">+------+-----------+</span><br><span class=\"line\"></span><br><span class=\"line\">delete from users where id &#x3D; 4;</span><br><span class=\"line\">savepoint a;#设置保存点</span><br><span class=\"line\">delete from users where id &#x3D; 1006;</span><br><span class=\"line\">rollback to a;#回滚到保存点的位置</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">select * from users;</span><br><span class=\"line\"></span><br><span class=\"line\">+------+-----------+</span><br><span class=\"line\">| id   | u_name    |</span><br><span class=\"line\">+------+-----------+</span><br><span class=\"line\">|    2 | 张三      |</span><br><span class=\"line\">|    3 | 李四      |</span><br><span class=\"line\">|    5 | 张三2     |</span><br><span class=\"line\">| 1006 | 刘亦菲    |</span><br><span class=\"line\">+------+-----------+</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL函数","url":"/2020/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E5%87%BD%E6%95%B0/","content":"<h2 id=\"MySQL函数\"><a href=\"#MySQL函数\" class=\"headerlink\" title=\"MySQL函数\"></a>MySQL函数</h2><h3 id=\"字符函数\"><a href=\"#字符函数\" class=\"headerlink\" title=\"字符函数\"></a>字符函数</h3><h4 id=\"length字节个数\"><a href=\"#length字节个数\" class=\"headerlink\" title=\"length字节个数\"></a>length字节个数</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select length(&#39;john&#39;);</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h4 id=\"concat拼接字符串\"><a href=\"#concat拼接字符串\" class=\"headerlink\" title=\"concat拼接字符串\"></a>concat拼接字符串</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select concat(&#39;I&#39;,&#39; &#39;,&#39;like&#39;,&#39; &#39;,&#39;mysql&#39;);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"upper-lower大小写转换\"><a href=\"#upper-lower大小写转换\" class=\"headerlink\" title=\"upper/lower大小写转换\"></a>upper/lower大小写转换</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select upper(&#39;mysql&#39;);</span><br><span class=\"line\">select lower(&#39;MySQL&#39;);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"substr-substring字符串截取\"><a href=\"#substr-substring字符串截取\" class=\"headerlink\" title=\"substr/substring字符串截取\"></a>substr/substring字符串截取</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#从第几个字符开始截取，注意：索引从1开始</span><br><span class=\"line\">select substr(&#39;I like MySQL&#39;,8);</span><br><span class=\"line\">#从第几个字符开始截取，截取几个字符</span><br><span class=\"line\">select substr(&#39;I like MySQL&#39;,8,2);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"instr子串在字符串中的起始索引\"><a href=\"#instr子串在字符串中的起始索引\" class=\"headerlink\" title=\"instr子串在字符串中的起始索引\"></a>instr子串在字符串中的起始索引</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select instr(&#39;I like MySQL&#39;,&#39;MySQL&#39;);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"trim去掉前后空格\"><a href=\"#trim去掉前后空格\" class=\"headerlink\" title=\"trim去掉前后空格\"></a>trim去掉前后空格</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select trim(&#39; My SQL &#39;);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"lpad用指定字符进行左填充达到指定长度\"><a href=\"#lpad用指定字符进行左填充达到指定长度\" class=\"headerlink\" title=\"lpad用指定字符进行左填充达到指定长度\"></a>lpad用指定字符进行左填充达到指定长度</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select lpad(&#39;MySQL&#39;,8,&#39;*&#39;);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"rpad用指定字符进行右填充达到指定长度\"><a href=\"#rpad用指定字符进行右填充达到指定长度\" class=\"headerlink\" title=\"rpad用指定字符进行右填充达到指定长度\"></a>rpad用指定字符进行右填充达到指定长度</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select rpad(&#39;MySQL&#39;,8,&#39;*&#39;);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"replace替换\"><a href=\"#replace替换\" class=\"headerlink\" title=\"replace替换\"></a>replace替换</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select replace(&#39;aabb&#39;,&#39;bb&#39;,&#39;cc&#39;);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"数学函数\"><a href=\"#数学函数\" class=\"headerlink\" title=\"数学函数\"></a>数学函数</h3><h4 id=\"round四舍五入\"><a href=\"#round四舍五入\" class=\"headerlink\" title=\"round四舍五入\"></a>round四舍五入</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select round(1.4);</span><br><span class=\"line\">#小数点后保留几位</span><br><span class=\"line\">select round(1.567,2);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"ceil向上取整\"><a href=\"#ceil向上取整\" class=\"headerlink\" title=\"ceil向上取整\"></a>ceil向上取整</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select ceil(1.2);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"floor向下取整\"><a href=\"#floor向下取整\" class=\"headerlink\" title=\"floor向下取整\"></a>floor向下取整</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select floor(1.2);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"truncate截断-小数点后保留几位\"><a href=\"#truncate截断-小数点后保留几位\" class=\"headerlink\" title=\"truncate截断(小数点后保留几位)\"></a>truncate截断(小数点后保留几位)</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select truncate(1.61,2);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"mod取模\"><a href=\"#mod取模\" class=\"headerlink\" title=\"mod取模\"></a>mod取模</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select mod(10,3);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"日期函数\"><a href=\"#日期函数\" class=\"headerlink\" title=\"日期函数\"></a>日期函数</h3><h4 id=\"now返回当前系统时间\"><a href=\"#now返回当前系统时间\" class=\"headerlink\" title=\"now返回当前系统时间\"></a>now返回当前系统时间</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select now();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"curdate返回当前系统日期，不包含时间\"><a href=\"#curdate返回当前系统日期，不包含时间\" class=\"headerlink\" title=\"curdate返回当前系统日期，不包含时间\"></a>curdate返回当前系统日期，不包含时间</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select curdate();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"curtime返回当前系统时间\"><a href=\"#curtime返回当前系统时间\" class=\"headerlink\" title=\"curtime返回当前系统时间\"></a>curtime返回当前系统时间</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select curtime();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"获取指定的部分\"><a href=\"#获取指定的部分\" class=\"headerlink\" title=\"获取指定的部分\"></a>获取指定的部分</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select year(&#39;2020-10-10&#39;);</span><br><span class=\"line\">select month(&#39;2020-10-10&#39;);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"str-to-date-将日期格式的字符转换成指定格式的日期\"><a href=\"#str-to-date-将日期格式的字符转换成指定格式的日期\" class=\"headerlink\" title=\"str_to_date 将日期格式的字符转换成指定格式的日期\"></a>str_to_date 将日期格式的字符转换成指定格式的日期</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select str_to_date(&#39;2020年10月12&#39;,&#39;%Y年%m月%d&#39;);</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"date-format将日期转换为字符\"><a href=\"#date-format将日期转换为字符\" class=\"headerlink\" title=\"date_format将日期转换为字符\"></a>date_format将日期转换为字符</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select date_format(&#39;2020&#x2F;10&#x2F;12&#39;,&#39;%Y-%m-%d&#39;);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"流程控制\"><a href=\"#流程控制\" class=\"headerlink\" title=\"流程控制\"></a>流程控制</h3><p>流程控制结构分为顺序结构、分支结构、循环结构</p>\n<h4 id=\"顺序结构\"><a href=\"#顺序结构\" class=\"headerlink\" title=\"顺序结构\"></a>顺序结构</h4><p>从上往下依次执行</p>\n<h4 id=\"分支结构\"><a href=\"#分支结构\" class=\"headerlink\" title=\"分支结构\"></a>分支结构</h4><p>从两条或多条分支选择一条执行</p>\n<h5 id=\"if函数-if-else效果\"><a href=\"#if函数-if-else效果\" class=\"headerlink\" title=\"if函数  if-else效果\"></a>if函数  if-else效果</h5><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#语法 if(表达式1,表达式2,表达式3)  表达式1成立，则执行表达式2，否则执行表达式3</span><br><span class=\"line\">select if(6&lt;3,&#39;小于&#39;,&#39;大于&#39;);</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"case函数\"><a href=\"#case函数\" class=\"headerlink\" title=\"case函数\"></a>case函数</h5><h6 id=\"相当于switch-case\"><a href=\"#相当于switch-case\" class=\"headerlink\" title=\"相当于switch-case\"></a>相当于switch-case</h6><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#语法</span><br><span class=\"line\">case 表达式|变量|字段</span><br><span class=\"line\">  when 要判断的值  then 结果</span><br><span class=\"line\">  when 要判断的值  then 结果</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  else result</span><br><span class=\"line\">end</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"相当于多重if语句\"><a href=\"#相当于多重if语句\" class=\"headerlink\" title=\"相当于多重if语句\"></a>相当于多重if语句</h6><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#语法</span><br><span class=\"line\">case</span><br><span class=\"line\">  when 要判断的条件  then 结果</span><br><span class=\"line\">  when 要判断的条件  then 结果</span><br><span class=\"line\">  ...</span><br><span class=\"line\">  else result</span><br><span class=\"line\">end</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"if结构\"><a href=\"#if结构\" class=\"headerlink\" title=\"if结构\"></a>if结构</h6><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#语法</span><br><span class=\"line\">if 条件1 then 语句1;</span><br><span class=\"line\">elseif 条件2 then 语句2;</span><br><span class=\"line\">else 语句;</span><br><span class=\"line\">end if;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"循环结构\"><a href=\"#循环结构\" class=\"headerlink\" title=\"循环结构\"></a>循环结构</h4><p>在满足一定的条件下，重复执行一段代码</p>\n<p>循环控制</p>\n<ul>\n<li>iterate  类似于continue</li>\n<li>leave 类似于break</li>\n</ul>\n<h5 id=\"while结构\"><a href=\"#while结构\" class=\"headerlink\" title=\"while结构\"></a>while结构</h5><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">【标签:】while 循环条件 do</span><br><span class=\"line\">    循环体</span><br><span class=\"line\">end while 【标签】;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"loop结构\"><a href=\"#loop结构\" class=\"headerlink\" title=\"loop结构\"></a>loop结构</h5><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">【标签:】loop</span><br><span class=\"line\">    循环体</span><br><span class=\"line\">end loop 【标签】;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"repeat结构\"><a href=\"#repeat结构\" class=\"headerlink\" title=\"repeat结构\"></a>repeat结构</h5><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">【标签:】 repeat </span><br><span class=\"line\">    循环体</span><br><span class=\"line\">until 捷顺循环的条件</span><br><span class=\"line\">end repeat 【标签】;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"聚合函数\"><a href=\"#聚合函数\" class=\"headerlink\" title=\"聚合函数\"></a>聚合函数</h3><h4 id=\"求和\"><a href=\"#求和\" class=\"headerlink\" title=\"求和\"></a>求和</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select sum(salary) from employees;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"平均值\"><a href=\"#平均值\" class=\"headerlink\" title=\"平均值\"></a>平均值</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select avg(salary) from employees;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"最大值\"><a href=\"#最大值\" class=\"headerlink\" title=\"最大值\"></a>最大值</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select max(salary) from employees;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"最小值\"><a href=\"#最小值\" class=\"headerlink\" title=\"最小值\"></a>最小值</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select min(salary) from employees;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"个数\"><a href=\"#个数\" class=\"headerlink\" title=\"个数\"></a>个数</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select count(id) from users;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL变量","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E5%8F%98%E9%87%8F/","content":"<h2 id=\"MySQL变量\"><a href=\"#MySQL变量\" class=\"headerlink\" title=\"MySQL变量\"></a>MySQL变量</h2><p>MySQL变量分为系统变量和自定义变量</p>\n<h3 id=\"系统变量\"><a href=\"#系统变量\" class=\"headerlink\" title=\"系统变量\"></a>系统变量</h3><p>系统变量有全局变量和会话变量</p>\n<a id=\"more\"></a>\n\n<h4 id=\"查看系统变量\"><a href=\"#查看系统变量\" class=\"headerlink\" title=\"查看系统变量\"></a>查看系统变量</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#查看全局系统变量</span><br><span class=\"line\">show global variables;</span><br><span class=\"line\">#根据条件查询全局系统变量</span><br><span class=\"line\">show global variables like &#39;%%&#39;;</span><br><span class=\"line\">#查询某个全局系统变量</span><br><span class=\"line\">select @@global.变量名</span><br><span class=\"line\"></span><br><span class=\"line\">#查看会话系统变量</span><br><span class=\"line\">show 【session】 variables;</span><br><span class=\"line\">#根据条件查询会话系统变量</span><br><span class=\"line\">show 【session】 variables like &#39;%%&#39;;</span><br><span class=\"line\">#查询某个会话系统变量</span><br><span class=\"line\">select @@【session.】变量名</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"设置系统变量\"><a href=\"#设置系统变量\" class=\"headerlink\" title=\"设置系统变量\"></a>设置系统变量</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#方式一</span><br><span class=\"line\">set global 变量名 &#x3D; 值</span><br><span class=\"line\">#方式二</span><br><span class=\"line\">set @@global.变量名 &#x3D; 值</span><br><span class=\"line\">set @@【session.】变量名 &#x3D; 值</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"自定义变量\"><a href=\"#自定义变量\" class=\"headerlink\" title=\"自定义变量\"></a>自定义变量</h3><p>自定义变量的步骤：声明、赋值、使用</p>\n<p>自定义变量分为用户变量和局部变量</p>\n<h4 id=\"用户变量\"><a href=\"#用户变量\" class=\"headerlink\" title=\"用户变量\"></a>用户变量</h4><p>用户变量针对于当前会话有效，用户变量在声明时必须进行初始化</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#用户变量声明初始化方式</span><br><span class=\"line\">#方式一</span><br><span class=\"line\">set @用户变量名 &#x3D; 值;</span><br><span class=\"line\">#方式二</span><br><span class=\"line\">set @用户变量名:&#x3D;值</span><br><span class=\"line\">#方式三</span><br><span class=\"line\">select @用户变量名:&#x3D;值;</span><br><span class=\"line\"></span><br><span class=\"line\">#查看用户变量</span><br><span class=\"line\">select @用户变量名;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"局部变量\"><a href=\"#局部变量\" class=\"headerlink\" title=\"局部变量\"></a>局部变量</h4><p>仅在定义该局部变量的begin end中有效</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#①声明 在begin end中第一句话声明</span><br><span class=\"line\">declare 变量名 类型;</span><br><span class=\"line\">#声明并赋默认值</span><br><span class=\"line\">declare 变量名 类型 default 默认值;</span><br><span class=\"line\"></span><br><span class=\"line\">#②赋值</span><br><span class=\"line\">#方式一</span><br><span class=\"line\">set 局部变量名 &#x3D; 值;</span><br><span class=\"line\">#方式二</span><br><span class=\"line\">set 局部变量名:&#x3D;值</span><br><span class=\"line\">#方式三</span><br><span class=\"line\">select @局部变量名:&#x3D;值;</span><br><span class=\"line\"></span><br><span class=\"line\">#③查看</span><br><span class=\"line\">select 局部变量名;</span><br></pre></td></tr></table></figure>\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL存储过程","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B/","content":"<h2 id=\"MySQL存储过程\"><a href=\"#MySQL存储过程\" class=\"headerlink\" title=\"MySQL存储过程\"></a>MySQL存储过程</h2><p>存储过程是一组预先编译好的SQL语句的集合</p>\n<p>好处：</p>\n<ul>\n<li>提高了代码的重用性</li>\n<li>简化操作</li>\n<li>减少了编译次数并且减少了和数据库连接次数，提高效率</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"创建存储过程\"><a href=\"#创建存储过程\" class=\"headerlink\" title=\"创建存储过程\"></a>创建存储过程</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#语法  参数列表包含三部分  参数模式 参数名 参数类型 如 IN name varchar(20)</span><br><span class=\"line\"># 如果begin end中只有一条语句，begin end可以省略</span><br><span class=\"line\"># 存储过程体的每个SQL语句结尾都要使用分号，所以需要使用delimiter重新设置结束标记</span><br><span class=\"line\">create procedure 存储过程名(参数列表)</span><br><span class=\"line\">begin</span><br><span class=\"line\">    存储过程体</span><br><span class=\"line\">end</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"参数模式\"><a href=\"#参数模式\" class=\"headerlink\" title=\"参数模式\"></a>参数模式</h4><ul>\n<li>IN  该参数可以作为输入，需要调用方传入</li>\n<li>OUT 该参数可以作为输出，作为返回值</li>\n<li>INOUT  该参数既可以作为输入，也可以作为输出</li>\n</ul>\n<h3 id=\"执行存储过程\"><a href=\"#执行存储过程\" class=\"headerlink\" title=\"执行存储过程\"></a>执行存储过程</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">call 存储过程名(参数列表)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除存储过程\"><a href=\"#删除存储过程\" class=\"headerlink\" title=\"删除存储过程\"></a>删除存储过程</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">drop procedure 存储过程名</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看存储过程信息\"><a href=\"#查看存储过程信息\" class=\"headerlink\" title=\"查看存储过程信息\"></a>查看存储过程信息</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">show create procedure 存储过程名;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">delimiter $ #更改结束符</span><br><span class=\"line\">create procedure mypro(IN stu_id int, #入参 学生id</span><br><span class=\"line\">                       out stu_name varchar(20), #返参 学生名</span><br><span class=\"line\">                       out class_name varchar(20), #返参 班级名</span><br><span class=\"line\">                       inout a int) #测试inout</span><br><span class=\"line\">begin </span><br><span class=\"line\">    select s.name,c.name into stu_name,class_name  #将查到的学生名和班级名赋值给返参stu_name,class_name  stu_name,class_name处于用户变量</span><br><span class=\"line\">    from student s </span><br><span class=\"line\">    join class c on s.classid &#x3D; c.id</span><br><span class=\"line\">    where s.id &#x3D; stu_id;  #根据学生id查询学生名和班级名</span><br><span class=\"line\">    set a &#x3D; a * 2; #给inout参数赋值 a是用户变量</span><br><span class=\"line\">end $</span><br><span class=\"line\">delimiter ; #结束符改回来</span><br><span class=\"line\"></span><br><span class=\"line\">set @m&#x3D;10; #设置变量</span><br><span class=\"line\">call mypro(1,@stu_name,@class_name,@m);</span><br><span class=\"line\"></span><br><span class=\"line\">select @stu_name,@class_name,@m; #查询结果</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL安装","url":"/2020/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E5%AE%89%E8%A3%85/","content":"<h2 id=\"MySQL在MAC下安装\"><a href=\"#MySQL在MAC下安装\" class=\"headerlink\" title=\"MySQL在MAC下安装\"></a>MySQL在MAC下安装</h2><p>下载</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">brew install mysql</span><br></pre></td></tr></table></figure>\n\n<p>mysql.server 在support-files下 </p>\n<a id=\"more\"></a>\n\n<p>启动服务</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql.server start</span><br></pre></td></tr></table></figure>\n\n<p>默认情况下没有密码，直接就可以使用root登录</p>\n<p>设置安全认证</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql_secure_installation</span><br></pre></td></tr></table></figure>\n\n<p>停止服务</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql.server stop</span><br></pre></td></tr></table></figure>\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL常用命令","url":"/2020/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"MySQL常用命令\"><a href=\"#MySQL常用命令\" class=\"headerlink\" title=\"MySQL常用命令\"></a>MySQL常用命令</h2><p><strong>查看数据库</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">show databases;</span><br></pre></td></tr></table></figure>\n\n<p><strong>选择数据库</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 注意： test是数据库的名称</span><br><span class=\"line\">use test;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p><strong>查看当前数据库内的表</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">show tables;</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看其他数据库的表</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># test是数据库名</span><br><span class=\"line\">show tables from test;</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看表结构</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 注意：user是表名</span><br><span class=\"line\">desc user;</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看MySQL版本</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select version();</span><br></pre></td></tr></table></figure>\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL忘记密码","url":"/2020/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81/","content":"<h2 id=\"MySQL忘记密码\"><a href=\"#MySQL忘记密码\" class=\"headerlink\" title=\"MySQL忘记密码\"></a>MySQL忘记密码</h2><p>今天在写jdbc时很悲催的发现自己的MySQL密码忘记了，没有办法了，重新设置一下密码吧。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">先关闭mysql服务</span></span><br><span class=\"line\">mysql.server stop</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 跳过权限检验  在使用该命令的时候要确保mysql服务是关闭的，不然是无法正常执行的</span></span><br><span class=\"line\">mysqld --skip-grant-tables</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 然后就可以进mysql了</span></span><br><span class=\"line\">mysql</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 先看一下密码的策略   </span></span><br><span class=\"line\">SHOW VARIABLES LIKE &#x27;validate_password%&#x27;; </span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">我使用的是mysql8  初始的密码策略要求的比较高  所以我要调整一下  </span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置密码强度</span></span><br><span class=\"line\">set global validate_password.policy=LOW;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置密码长度</span></span><br><span class=\"line\">set global validate_password.length=6;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 刷新系统权限相关表</span></span><br><span class=\"line\">FLUSH PRIVILEGES;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置新的密码</span></span><br><span class=\"line\">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;123456&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 完事之后记得把mysqld --skip-grant-tables进程杀死</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"密码策略的字段说明\"><a href=\"#密码策略的字段说明\" class=\"headerlink\" title=\"密码策略的字段说明\"></a>密码策略的字段说明</h3><ul>\n<li><p>validate_password.length  固定密码的总长度；</p>\n</li>\n<li><p>validate_password.dictionary_file 指定密码验证的文件路径；</p>\n</li>\n<li><p>validate_password_mixed_case_count  整个密码中至少要包含大/小写字母的总个数；</p>\n</li>\n<li><p>validate_password.number_count  整个密码中至少要包含阿拉伯数字的个数；</p>\n</li>\n<li><p>validate_password.policy 指定密码的强度验证等级，默认为 MEDIUM；</p>\n<p>0/LOW：只验证长度；</p>\n<p>1/MEDIUM：验证长度、数字、大小写、特殊字符；</p>\n<p>2/STRONG：验证长度、数字、大小写、特殊字符、字典文件；</p>\n</li>\n<li><p>validate_password.special_char_count 整个密码中至少要包含特殊字符的个数；</p>\n</li>\n</ul>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL注释","url":"/2020/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E6%B3%A8%E9%87%8A/","content":"<h2 id=\"MySQL注释\"><a href=\"#MySQL注释\" class=\"headerlink\" title=\"MySQL注释\"></a>MySQL注释</h2><p>单行注释： #注释文字</p>\n<p>单行注释：– 注释文字</p>\n<p>多行注释：/* 注释文字 */</p>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL约束","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E7%BA%A6%E6%9D%9F/","content":"<h2 id=\"MySQL约束\"><a href=\"#MySQL约束\" class=\"headerlink\" title=\"MySQL约束\"></a>MySQL约束</h2><p>数据库有六大约束，分别为</p>\n<a id=\"more\"></a>\n\n<ul>\n<li>NOT NULL  非空约束，用于保证这个字段不能为空</li>\n<li>DEFAULT  默认约束，用于保证该字段有默认值</li>\n<li>PRIMARY KEY 主键约束，用于保证该字段可以唯一表示该行记录，唯一且非空</li>\n<li>UNIQUE   唯一约束，用于保证该字段的唯一性，可以为空</li>\n<li>CHECK   检查约束(MySQL不支持该约束)</li>\n<li>FOREIGN KEY 外键约束，用于限制两个表的关系，用于保证该字段必须来自于主表关联列的值(在从表中添加外键约束，用于引用主表中某列的值)</li>\n</ul>\n<p>示例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">create table class( </span><br><span class=\"line\">  id int primary key, #主键约束</span><br><span class=\"line\">  name varchar(20) not null #非空约束</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">create table student(</span><br><span class=\"line\">    id int,</span><br><span class=\"line\">  name varchar(20) not null,</span><br><span class=\"line\">  classid int,</span><br><span class=\"line\">  sex int not null,</span><br><span class=\"line\">  brith date,</span><br><span class=\"line\">  constraint pk primary key(id), #主键约束</span><br><span class=\"line\">  constraint fk_student_class foreign key(classid) references class(id) #外键</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL自定义函数","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0/","content":"<h2 id=\"MySQL自定义函数\"><a href=\"#MySQL自定义函数\" class=\"headerlink\" title=\"MySQL自定义函数\"></a>MySQL自定义函数</h2><p>函数与存储过程类似，也是一组预先编译好的SQL语句的集合，但是存储过程可以有0个或多个返回，函数就只能有一个返回</p>\n<a id=\"more\"></a>\n\n<h3 id=\"创建函数\"><a href=\"#创建函数\" class=\"headerlink\" title=\"创建函数\"></a>创建函数</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#语法 参数列表包含两部分 参数名和参数类型</span><br><span class=\"line\">#函数体必须有return语句 且每个sql语句后要以;结尾 所以需要使用delimiter来重新设置结束标记</span><br><span class=\"line\">#函数体中只有一句话时可以省略begin end</span><br><span class=\"line\">create function 函数名(参数列表) returns 返回值类型</span><br><span class=\"line\">begin</span><br><span class=\"line\">    函数体</span><br><span class=\"line\">end</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"执行函数\"><a href=\"#执行函数\" class=\"headerlink\" title=\"执行函数\"></a>执行函数</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">select 函数名(参数列表)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看函数\"><a href=\"#查看函数\" class=\"headerlink\" title=\"查看函数\"></a>查看函数</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">show create function 函数名;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除函数\"><a href=\"#删除函数\" class=\"headerlink\" title=\"删除函数\"></a>删除函数</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">drop function 函数名;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">delimiter $</span><br><span class=\"line\"></span><br><span class=\"line\">create function myfunc(class_name varchar(20)) returns int</span><br><span class=\"line\">begin </span><br><span class=\"line\">    declare c int default 0; #设置局部变量，作为返回值</span><br><span class=\"line\">    select count(s.id) into c # 将查询结果赋给局部变量</span><br><span class=\"line\">  from class c</span><br><span class=\"line\">  join student s on c.id &#x3D; s.classid</span><br><span class=\"line\">  where c.name &#x3D; class_name;</span><br><span class=\"line\">  return c; #返回</span><br><span class=\"line\">end $</span><br><span class=\"line\"></span><br><span class=\"line\">delimiter ;</span><br><span class=\"line\">select myfunc(&#39;计算机一班&#39;);#函数调用</span><br></pre></td></tr></table></figure>\n\n<p>特别提醒一下：我在创建函数的时候出错了</p>\n<p>ERROR 1418 (HY000): This function has none of DETERMINISTIC, NO SQL, or READS SQL DATA in its declaration and binary logging is enabled (you <em>might</em> want to use the less safe log_bin_trust_function_creators variable)</p>\n<p>需要设置一下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">set global log_bin_trust_function_creators&#x3D;TRUE;</span><br></pre></td></tr></table></figure>\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL视图","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQL%E8%A7%86%E5%9B%BE/","content":"<h2 id=\"MySQL视图\"><a href=\"#MySQL视图\" class=\"headerlink\" title=\"MySQL视图\"></a>MySQL视图</h2><h3 id=\"视图的概念\"><a href=\"#视图的概念\" class=\"headerlink\" title=\"视图的概念\"></a>视图的概念</h3><p>视图是一种虚拟存在的表，行和列的数据来自于定义的视图的查询中使用的表，并且是在使用视图中动态生成的，只保存sql逻辑，不保存数据</p>\n<a id=\"more\"></a>\n\n<h3 id=\"应用场景\"><a href=\"#应用场景\" class=\"headerlink\" title=\"应用场景\"></a>应用场景</h3><ul>\n<li>多个地方使用同样的查询结果</li>\n<li>该查询结果使用的sql语句较为复杂</li>\n</ul>\n<h3 id=\"视图\"><a href=\"#视图\" class=\"headerlink\" title=\"视图\"></a>视图</h3><h4 id=\"创建视图\"><a href=\"#创建视图\" class=\"headerlink\" title=\"创建视图\"></a>创建视图</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#语法结构</span><br><span class=\"line\">create view 视图名</span><br><span class=\"line\">as 查询语句</span><br><span class=\"line\"></span><br><span class=\"line\">create view my_view as select s.name as student_name,c.name as class_name from student s join class c on s.classid &#x3D; c.id;</span><br><span class=\"line\"></span><br><span class=\"line\">#查看视图  此时视图里只有两个字段</span><br><span class=\"line\">desc my_view;</span><br><span class=\"line\">+--------------+-------------+------+-----+---------+-------+</span><br><span class=\"line\">| Field        | Type        | Null | Key | Default | Extra |</span><br><span class=\"line\">+--------------+-------------+------+-----+---------+-------+</span><br><span class=\"line\">| student_name | varchar(20) | NO   |     | NULL    |       |</span><br><span class=\"line\">| class_name   | varchar(20) | NO   |     | NULL    |       |</span><br><span class=\"line\">+--------------+-------------+------+-----+---------+-------+</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用视图查询\"><a href=\"#使用视图查询\" class=\"headerlink\" title=\"使用视图查询\"></a>使用视图查询</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#注意：查询时只可以使用视图中的字段进行查询</span><br><span class=\"line\">select * from  my_view where student_name &#x3D; &#39;张三&#39;;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"修改视图\"><a href=\"#修改视图\" class=\"headerlink\" title=\"修改视图\"></a>修改视图</h4><p>有两种方式修改视图</p>\n<p>方式一：有则修改，没有则创建</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">create or replace view 视图名</span><br><span class=\"line\">as 查询语句</span><br></pre></td></tr></table></figure>\n\n<p>方式二：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">alter view 视图名 as 查询语句</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"删除视图\"><a href=\"#删除视图\" class=\"headerlink\" title=\"删除视图\"></a>删除视图</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">drop view 视图名,视图名,...</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"视图中数据更新\"><a href=\"#视图中数据更新\" class=\"headerlink\" title=\"视图中数据更新\"></a>视图中数据更新</h4><p>在使用简单地查询语句作为视图时，可以对视图进行增删改操作，<strong>而且对视图的操作也会同样使数据表完成相应的变化</strong></p>\n<p>但是包含以下特点的视图不允许更新</p>\n<ul>\n<li>分组函数、distinct、group by、having、union、union all</li>\n<li>常量视图</li>\n<li>select中包含子查询</li>\n<li>join语句（可以update但是不可以insert和delete）</li>\n<li>数据来自于一个不可更新的视图</li>\n<li>Where 子句的子查询引用了from子句中的表</li>\n</ul>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"like语法","url":"/2020/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/like%E8%AF%AD%E5%8F%A5/","content":"<p>like与通配符搭配使用进行模糊查询</p>\n<p><strong>通配符</strong></p>\n<ul>\n<li>%  表示任意多个字符</li>\n<li>_   表示任意单个字符</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#用户名中包含a的</span><br><span class=\"line\">select * from user where name like &#39;%a%&#39;</span><br><span class=\"line\">#用户名中第二个字符为a的</span><br><span class=\"line\">select * from user where name like &#39;_a%&#39;</span><br><span class=\"line\">#用户名中第二个字符为_的(需要使用转义字符)</span><br><span class=\"line\">select * from user where name like &#39;_\\_%&#39;</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"修改表","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E4%BF%AE%E6%94%B9%E8%A1%A8/","content":"<h2 id=\"修改表\"><a href=\"#修改表\" class=\"headerlink\" title=\"修改表\"></a>修改表</h2><p>修改MySQL的表结构</p>\n<h3 id=\"修改表的列名\"><a href=\"#修改表的列名\" class=\"headerlink\" title=\"修改表的列名\"></a>修改表的列名</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#alter table 表名 change column 所要修改的列名 所要改成的名称 类型; </span><br><span class=\"line\">alter table user change column name u_name varchar(20);</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"修改列的类型和约束\"><a href=\"#修改列的类型和约束\" class=\"headerlink\" title=\"修改列的类型和约束\"></a>修改列的类型和约束</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#alter table 表名 modify column 所要修改的列名 所要改成的类型;</span><br><span class=\"line\">alter table user modify column  u_name char(20);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"添加新列\"><a href=\"#添加新列\" class=\"headerlink\" title=\"添加新列\"></a>添加新列</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#alter table 表名 add column 所要增加的列名 类型;</span><br><span class=\"line\">alter table user add column age int;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除列\"><a href=\"#删除列\" class=\"headerlink\" title=\"删除列\"></a>删除列</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#alter table 表名 drop column 所要删除的列名;</span><br><span class=\"line\">alter table user drop column age;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"修改表名\"><a href=\"#修改表名\" class=\"headerlink\" title=\"修改表名\"></a>修改表名</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#alter table 表名 rename to 新的表名;</span><br><span class=\"line\">alter table user rename to users;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除表\"><a href=\"#删除表\" class=\"headerlink\" title=\"删除表\"></a>删除表</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">drop table users;</span><br></pre></td></tr></table></figure>\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"关系分类","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E5%85%B3%E7%B3%BB%E5%88%86%E7%B1%BB/","content":"<h2 id=\"关系分类\"><a href=\"#关系分类\" class=\"headerlink\" title=\"关系分类\"></a>关系分类</h2><p>SQL区分为三类关系</p>\n<ul>\n<li>表     在数据库中存储，可以对其进行增删改查</li>\n<li>视图  通过计算定义的关系，并不在数据库中存储，只在需要的使用进行构造</li>\n<li>临时表  在执行查询或更新时由SQL程序临时构造的，处理结束后就会删除</li>\n</ul>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"删除数据","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE/","content":"<h2 id=\"删除数据\"><a href=\"#删除数据\" class=\"headerlink\" title=\"删除数据\"></a>删除数据</h2><p>MySQL删除数据的方式有两种，一种为delete，一种为truncate</p>\n<h3 id=\"delete删除数据\"><a href=\"#delete删除数据\" class=\"headerlink\" title=\"delete删除数据\"></a>delete删除数据</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">delete from table 表名 where 条件</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"truncate删除数据\"><a href=\"#truncate删除数据\" class=\"headerlink\" title=\"truncate删除数据\"></a>truncate删除数据</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">truncate table 表名;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"两者的区别\"><a href=\"#两者的区别\" class=\"headerlink\" title=\"两者的区别\"></a>两者的区别</h3><ul>\n<li>delete可以加where条件进行删除，truncate不可以，只能删除全表数据</li>\n<li>delete删除不会删除自增长字段，再次新增字段时从断点继续自增，truncate删除数据之后自增长字段从1开始</li>\n<li>delete删除会返回删除的条数，truncate删除不会返回</li>\n<li>delete删除可以回滚，truncate删除不可以回滚</li>\n<li>delete删除可以触发trigger，truncate不会</li>\n<li>truncate比delete速度快，因为delete每删除一条数据需要在事务日志中为删除的每行数据进行记录，而truncate则通过释放数据页来删除数据，且只在事务日志中记录页的释放</li>\n</ul>\n<blockquote>\n<p>注意：删除数据时使用delete即可，尤其是没有数据备份的情况下</p>\n</blockquote>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"intset实现","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/intset%E5%AE%9E%E7%8E%B0/","content":"<h2 id=\"intset实现\"><a href=\"#intset实现\" class=\"headerlink\" title=\"intset实现\"></a>intset实现</h2><p>inset是set集合的底层实现之一，当set中只有整数值元素且元素数量不多时使用</p>\n<figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">intset</span> &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 编码方式</span></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> encoding;</span><br><span class=\"line\">      <span class=\"comment\">// 元素数量</span></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> length;</span><br><span class=\"line\">      <span class=\"comment\">// 保存元素的数组</span></span><br><span class=\"line\">    <span class=\"keyword\">int8_t</span> contents[];</span><br><span class=\"line\">&#125; intset;</span><br></pre></td></tr></table></figure>\n\n","categories":["redis"],"tags":["redis"]},{"title":"redis主从复制","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/","content":"<h2 id=\"redis主从复制\"><a href=\"#redis主从复制\" class=\"headerlink\" title=\"redis主从复制\"></a>redis主从复制</h2><blockquote>\n<p>注意：我使用的版本是6.0.10，不同版本可能略有差别</p>\n</blockquote>\n<p>虽然redis有持久化的功能可以保证redis服务重启不会丢失数据，但是如果redis服务器的硬盘损坏就会导致数据丢失，，使用主从复制来避免这种单点故障。</p>\n<p>主机数据更新后根据配置和策略自动同步到备机的master/slave机制，master以写为主，slave以读为主</p>\n<h3 id=\"原理\"><a href=\"#原理\" class=\"headerlink\" title=\"原理\"></a>原理</h3><p>主要是使用PSYNC命令来实现</p>\n<p>PSYNC命令具有完整重同步和部分重同步两种模式</p>\n<ul>\n<li>完整重同步用于处理初次复制的情况：slave启动成功连接到master后会发送一个psync命令，master接到命令后会启动后台创建并发送RDB文件，完成后将命令发送给slave</li>\n<li>部分重同步用于处理断线后重复制的情况：在断线后重连，slave向master发送psync命令，master将断线之后的写命令发送给slave</li>\n</ul>\n<a id=\"more\"></a>\n\n<p>那么如何知道slave和master之间只差了这几个命令呢？</p>\n<p>是因为master和slave在复制的时候都维护了一个复制偏移量，而master在复制积压缓冲区中会保存一部分最近传播的写命令，为每个字节来记录相应的复制偏移量，可以根据复制偏移量来找到对应的字节，当然，如果复制积压缓冲区中没有这个偏移量了，那么就只能进行全量复制了</p>\n<blockquote>\n<p>redis默认的复制积压缓冲区为1mb，可以修改配置中repl-backlog-size 来进行调整</p>\n</blockquote>\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p>配主不配从，配置slave即可，使得slave时刻盯住主机</p>\n<p>在这里由于我只有一台电脑，所以只能用三个配置文件来启动三个redis服务了，带有配置文件的启动服务</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis-server redis79.conf</span><br></pre></td></tr></table></figure>\n\n<p>以及使用端口启动客户端</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis-cli -p 6379</span><br></pre></td></tr></table></figure>\n\n<p>启动之后就可以配置从机了</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">replicaof 127.0.0.1 6379</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>在5.0之后使用replicaof，5.0之前使用slaveof      不过当前slaveof还没有失效</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 可以配置最少有多少个从节点  主节点才可以写</span><br><span class=\"line\"># min-replicas-to-write 3</span><br><span class=\"line\"># min-replicas-max-lag 10</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"一主两仆\"><a href=\"#一主两仆\" class=\"headerlink\" title=\"一主两仆\"></a>一主两仆</h4><pre class=\"mermaid\">graph TD\nmaster79-->slave80\nmaster79-->slave81</pre>\n\n\n\n<p>看一下执行命令之前的配置变化(使用info replication来查看)</p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#之前</span></span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\"><span class=\"attr\">role</span>:<span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">connected_slaves</span>:<span class=\"string\">0</span></span><br><span class=\"line\"><span class=\"attr\">master_replid</span>:<span class=\"string\">96519fc9dab0e66f4d1e8513f519b68622f4af9e</span></span><br><span class=\"line\"><span class=\"attr\">master_replid2</span>:<span class=\"string\">0000000000000000000000000000000000000000</span></span><br><span class=\"line\"><span class=\"attr\">master_repl_offset</span>:<span class=\"string\">0</span></span><br><span class=\"line\"><span class=\"attr\">second_repl_offset</span>:<span class=\"string\">-1</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_active</span>:<span class=\"string\">0</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_size</span>:<span class=\"string\">1048576</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_first_byte_offset</span>:<span class=\"string\">0</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_histlen</span>:<span class=\"string\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#之后</span></span><br><span class=\"line\"><span class=\"comment\">#主机</span></span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\"><span class=\"attr\">role</span>:<span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"attr\">connected_slaves</span>:<span class=\"string\">2</span></span><br><span class=\"line\"><span class=\"attr\">slave0</span>:<span class=\"string\">ip=127.0.0.1,port=6380,state=online,offset=2646,lag=1</span></span><br><span class=\"line\"><span class=\"attr\">slave1</span>:<span class=\"string\">ip=127.0.0.1,port=6381,state=online,offset=2646,lag=1</span></span><br><span class=\"line\"><span class=\"attr\">master_replid</span>:<span class=\"string\">63b39507da5e42ce5e1b4d931f4e743c91bb92cd</span></span><br><span class=\"line\"><span class=\"attr\">master_replid2</span>:<span class=\"string\">0000000000000000000000000000000000000000</span></span><br><span class=\"line\"><span class=\"attr\">master_repl_offset</span>:<span class=\"string\">2646</span></span><br><span class=\"line\"><span class=\"attr\">second_repl_offset</span>:<span class=\"string\">-1</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_active</span>:<span class=\"string\">1</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_size</span>:<span class=\"string\">1048576</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_first_byte_offset</span>:<span class=\"string\">1</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_histlen</span>:<span class=\"string\">2646</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#从机</span></span><br><span class=\"line\"><span class=\"comment\"># Replication</span></span><br><span class=\"line\"><span class=\"attr\">role</span>:<span class=\"string\">slave</span></span><br><span class=\"line\"><span class=\"attr\">master_host</span>:<span class=\"string\">127.0.0.1</span></span><br><span class=\"line\"><span class=\"attr\">master_port</span>:<span class=\"string\">6379</span></span><br><span class=\"line\"><span class=\"attr\">master_link_status</span>:<span class=\"string\">up</span></span><br><span class=\"line\"><span class=\"attr\">master_last_io_seconds_ago</span>:<span class=\"string\">9</span></span><br><span class=\"line\"><span class=\"attr\">master_sync_in_progress</span>:<span class=\"string\">0</span></span><br><span class=\"line\"><span class=\"attr\">slave_repl_offset</span>:<span class=\"string\">42</span></span><br><span class=\"line\"><span class=\"attr\">slave_priority</span>:<span class=\"string\">100</span></span><br><span class=\"line\"><span class=\"attr\">slave_read_only</span>:<span class=\"string\">1</span></span><br><span class=\"line\"><span class=\"attr\">connected_slaves</span>:<span class=\"string\">0</span></span><br><span class=\"line\"><span class=\"attr\">master_replid</span>:<span class=\"string\">63b39507da5e42ce5e1b4d931f4e743c91bb92cd</span></span><br><span class=\"line\"><span class=\"attr\">master_replid2</span>:<span class=\"string\">0000000000000000000000000000000000000000</span></span><br><span class=\"line\"><span class=\"attr\">master_repl_offset</span>:<span class=\"string\">42</span></span><br><span class=\"line\"><span class=\"attr\">second_repl_offset</span>:<span class=\"string\">-1</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_active</span>:<span class=\"string\">1</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_size</span>:<span class=\"string\">1048576</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_first_byte_offset</span>:<span class=\"string\">43</span></span><br><span class=\"line\"><span class=\"attr\">repl_backlog_histlen</span>:<span class=\"string\">0</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>重点：</p>\n<ul>\n<li>从机会将主机的所有数据进行备份</li>\n<li>从机只能读，不能写(error) READONLY You can’t write against a read only replica.</li>\n<li>主机挂了之后，从机身份不变(master_link_status变成down)，直到主机回来，主机回来之后还是主机</li>\n<li>从机挂了之后需要重新执行从属命令replicaof 127.0.0.1 6379(如果是直接在配置文件中配置的从属关系则不需要)</li>\n</ul>\n</blockquote>\n<p>可以使用命令来将从库变成主库</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">replicaof no one</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>在5.0之后使用replicaof，5.0之前使用slaveof      不过当前slaveof还没有失效</p>\n</blockquote>\n<h4 id=\"薪火相传\"><a href=\"#薪火相传\" class=\"headerlink\" title=\"薪火相传\"></a>薪火相传</h4><p>由于一主两仆机制会导致主机挂掉之后整个redis就挂掉的问题，所以为了去中心化，有了薪火相传机制，上一个slave可能是下一个slave的master，slave同样可以接收其他的slave的连接和请求，可以有效地减轻master的写压力</p>\n<pre class=\"mermaid\">graph LR\nmaster79-->slave80-->slave81</pre>\n\n<p>这里slave80对于slave81是主机，对于master79是从机</p>\n<blockquote>\n<p>该机制可能会存在延迟</p>\n</blockquote>\n<h4 id=\"哨兵模式\"><a href=\"#哨兵模式\" class=\"headerlink\" title=\"哨兵模式\"></a>哨兵模式</h4><p>由于一主两从的主库挂掉之后，需要人工的去干预从库反客为主，再进行更改主从配置，而哨兵模式通过监听主库是否挂掉，从库根据投票来决定自动将从库切换为主库</p>\n<p>配置redis-sentinel.conf配置文件</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#哨兵监控 6379  当6379挂了之后从库进行投票，票数超过1即可成为主库，配置文件会自动修改为新选举的主库ip和port</span><br><span class=\"line\">sentinel monitor mymaster 127.0.0.1 6379 1</span><br></pre></td></tr></table></figure>\n\n<p>哨兵启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis-sentinel redis-sentinel.conf</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>当主库挂掉之后，从库进行重新选举出新的主库，原来的主库回来之后，只会成为从库，不会变成双主库</p>\n</blockquote>\n<h5 id=\"哨兵的功能\"><a href=\"#哨兵的功能\" class=\"headerlink\" title=\"哨兵的功能\"></a>哨兵的功能</h5><p>哨兵节点不同于数据节点，不存储数据，且仅支持部分命令</p>\n<ul>\n<li>监控   哨兵检查主节点和从节点是否正常运作</li>\n<li>自动故障转移  主节点不能正常工作时，哨兵开始自动故障转移操作，将失效主节点的其中一个从节点升级为新的主节点，并让其他从节点复制新的主节点</li>\n<li>配置提供者   客户端在初始化时，通过连接哨兵来获得当时redis服务的主节点地址</li>\n<li>通知  将故障转移结果发送给客户端</li>\n</ul>\n<h5 id=\"选举新的主服务器\"><a href=\"#选举新的主服务器\" class=\"headerlink\" title=\"选举新的主服务器\"></a>选举新的主服务器</h5><p>sentinel会将所有的从服务器保存到一个列表中，然后进行筛选</p>\n<ul>\n<li>首先会删除掉下线的从服务器</li>\n<li>然后删除掉最近五秒内没有回复过sentinel的info命令的从服务器</li>\n<li>删除掉与主服务连接断开超过down-after-milliseconds * 10 毫秒的从服务器(down-after-milliseconds表示判断主服务器下线所需的时间)</li>\n<li>根据从服务器优先级进行排序，如果有多个最高优先级的从服务器，则选出偏移量最大的</li>\n<li>如果存在多个最高优先级、复制偏移量最大的从服务器，则按照id进行排序，选出id最小的</li>\n</ul>\n<blockquote>\n<p>sentinel是不会监控从服务器的，所以如果从服务器挂掉之后，sentinel是不会对其进行故障转移的</p>\n</blockquote>\n<h3 id=\"作用\"><a href=\"#作用\" class=\"headerlink\" title=\"作用\"></a>作用</h3><ul>\n<li>读写分离</li>\n<li>灾备</li>\n</ul>\n","categories":["redis"],"tags":["redis"]},{"title":"redis事务","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E4%BA%8B%E5%8A%A1/","content":"<h2 id=\"redis事务\"><a href=\"#redis事务\" class=\"headerlink\" title=\"redis事务\"></a>redis事务</h2><blockquote>\n<p>注意：我使用的版本是6.0.10，不同版本可能略有差别</p>\n</blockquote>\n<p>redis可以一次执行多条命令，一个事务中所有命令都会序列化，按顺序的串行化执行而不会被其他命令插入</p>\n<h3 id=\"事务的常用命令\"><a href=\"#事务的常用命令\" class=\"headerlink\" title=\"事务的常用命令\"></a>事务的常用命令</h3><ul>\n<li>multi  标记一个事务块的开始</li>\n<li>exec  执行事务块的命令</li>\n<li>discard  取消事务，丢弃事务块的命令</li>\n<li>watch key [key …]  监视key，如果在事务执行之前，这个key被其他命令所改动，则事务中断</li>\n<li>unwatch  取消监视所有key</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"事务的执行\"><a href=\"#事务的执行\" class=\"headerlink\" title=\"事务的执行\"></a>事务的执行</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">标注事务的开始</span></span><br><span class=\"line\">MULTI</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">在事务内部的操作全是入队，不会真正执行</span></span><br><span class=\"line\">set tran1 v1</span><br><span class=\"line\">QUEUED</span><br><span class=\"line\">set tran2 v2</span><br><span class=\"line\">QUEUED</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">执行</span></span><br><span class=\"line\">exec</span><br><span class=\"line\">1) OK</span><br><span class=\"line\">2) OK</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>redis的事务没有隔离级别的概念，并且不会保证原子性</p>\n</blockquote>\n<h3 id=\"watch监视\"><a href=\"#watch监视\" class=\"headerlink\" title=\"watch监视\"></a>watch监视</h3><p>watch指令类似于乐观锁，在事务开始之前使用，如果在watch之后有任何所监视的key发生变化，exec指令所执行的事务将会被放弃</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设值</span></span><br><span class=\"line\">set balance 100</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">监视</span></span><br><span class=\"line\">watch balance</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">修改</span></span><br><span class=\"line\">set balance 200</span><br><span class=\"line\">OK</span><br><span class=\"line\">get balance</span><br><span class=\"line\">&quot;200&quot;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">开启事务</span></span><br><span class=\"line\">MULTI </span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">修改入队</span></span><br><span class=\"line\">DECRBY balance 10</span><br><span class=\"line\">QUEUED</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">执行失败</span></span><br><span class=\"line\">exec</span><br><span class=\"line\">(nil)</span><br><span class=\"line\">get balance</span><br><span class=\"line\">&quot;200&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>redis只能保证事务中的操作顺序执行，但是如果事务中有一条命令失败了，并不会回滚其他命令</p>\n</blockquote>\n","categories":["redis"],"tags":["redis"]},{"title":"redis优点","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E4%BC%98%E7%82%B9/","content":"<h2 id=\"redis优点\"><a href=\"#redis优点\" class=\"headerlink\" title=\"redis优点\"></a>redis优点</h2><p>redis为什么会那么快</p>\n<ul>\n<li>内存操作</li>\n<li>单线程，避免了频繁的上下文切换</li>\n<li>采用了非阻塞I/O多路复用机制(提供了select、epoll、kqueue等函数)</li>\n</ul>\n","categories":["redis"],"tags":["redis"]},{"title":"redis基本命令","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"redis基本命令\"><a href=\"#redis基本命令\" class=\"headerlink\" title=\"redis基本命令\"></a>redis基本命令</h2><blockquote>\n<p>注意：我使用的版本是6.0.10，不同版本可能略有差别</p>\n</blockquote>\n<p>redis服务和客户端都启动之后，就可以进行存取操作了</p>\n<h3 id=\"测试连接\"><a href=\"#测试连接\" class=\"headerlink\" title=\"测试连接\"></a>测试连接</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">ping</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"基本存取\"><a href=\"#基本存取\" class=\"headerlink\" title=\"基本存取\"></a>基本存取</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">set k1 hello</span><br><span class=\"line\">----------------</span><br><span class=\"line\">OK</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">get k1</span><br><span class=\"line\">----------------</span><br><span class=\"line\">&quot;hello&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"切换数据库\"><a href=\"#切换数据库\" class=\"headerlink\" title=\"切换数据库\"></a>切换数据库</h3><p>redis默认存在16个数据库，默认使用的是0，可以使用select index来切换数据库(索引从0开始)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">select 2</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"清除数据\"><a href=\"#清除数据\" class=\"headerlink\" title=\"清除数据\"></a>清除数据</h3><p><strong>根据key删除</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">del k2</span><br></pre></td></tr></table></figure>\n\n<p><strong>清除当前库的数据</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">flushdb</span><br></pre></td></tr></table></figure>\n\n<p><strong>清除所有库的数据</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">flushall</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"key操作\"><a href=\"#key操作\" class=\"headerlink\" title=\"key操作\"></a>key操作</h3><p><strong>判断key是否存在</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">EXISTS k1</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看当前数据库的key的数量</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">dbsize</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看所有的key</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">keys *</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>在生产环境最好不要使用keys命令，该命令为O(N)，数据量大的情况下会导致redis阻塞其他操作，而且一次性返回所有的keys，对内存的消耗也很大，建议使用scan命令来操作</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">scan cursor [MATCH pattern] [COUNT count] [TYPE <span class=\"built_in\">type</span>]</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> cursor表示游标</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> MATCH pattern 查询key的条件，可以做模糊查询</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> COUNT count  返回的条数</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> TYPE <span class=\"built_in\">type</span> 查询对应类型的key(string/list/<span class=\"built_in\">set</span>/<span class=\"built_in\">hash</span>/zset)</span></span><br></pre></td></tr></table></figure>\n\n\n</blockquote>\n<p><strong>移动key到其他库</strong></p>\n<p>这里将key移动到其他库，当前库该key值就没有了</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">move k1 2</span><br></pre></td></tr></table></figure>\n\n<p><strong>设置过期时间</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">单位为秒</span></span><br><span class=\"line\">expire k2 100</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">单位毫秒</span></span><br><span class=\"line\">pexpire k3 100</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>也可以在set值的时候设置过期时间</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">ex单位秒</span></span><br><span class=\"line\">set k2 v2 ex 20</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">px单位秒</span></span><br><span class=\"line\">set k3 v3 px 30</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看过期时间</strong></p>\n<p>查看还有多少秒过期，-1表示永不过期，-2表示已过期</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">ttl k2</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看该key的值类型</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 返回的是值得类型 如string/list/<span class=\"built_in\">set</span>/<span class=\"built_in\">hash</span>/zset</span></span><br><span class=\"line\">type k2</span><br></pre></td></tr></table></figure>\n\n<p><strong>随机返回一个key</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">randomkey</span><br></pre></td></tr></table></figure>\n\n<p><strong>重命名key</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">rename key newkey</span></span><br><span class=\"line\">rename k1 key1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"获取服务器信息\"><a href=\"#获取服务器信息\" class=\"headerlink\" title=\"获取服务器信息\"></a>获取服务器信息</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 返回服务器的基本信息以及配置信息</span></span><br><span class=\"line\">info</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 获取服务器所有配置  可以将*换成具体的配置名称来获取具体的配置</span></span><br><span class=\"line\">config get *</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"监控\"><a href=\"#监控\" class=\"headerlink\" title=\"监控\"></a>监控</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 监控服务器收到的请求</span></span><br><span class=\"line\">monitor</span><br></pre></td></tr></table></figure>\n\n","categories":["redis"],"tags":["redis"]},{"title":"redis安装","url":"/2020/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E5%AE%89%E8%A3%85/","content":"<h2 id=\"redis安装\"><a href=\"#redis安装\" class=\"headerlink\" title=\"redis安装\"></a>redis安装</h2><p>mac下安装redis还是很简单的(其实mac下安装什么软件都挺简单的，brew啥都有)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">brew install redis</span><br></pre></td></tr></table></figure>\n\n<p>之后就是漫长的等待，下了好久，终于下载完了</p>\n<p>启动服务端</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis-server</span><br></pre></td></tr></table></figure>\n\n<p>启动客户端</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis-cli</span><br></pre></td></tr></table></figure>\n\n<p>齐活</p>\n<blockquote>\n<p>可能使用brew安装之后你不知道东西都下载到哪了(我刚下载完就不知道去哪里找redis.conf文件)</p>\n<p>可以使用 brew list redis来查看</p>\n</blockquote>\n","categories":["redis"],"tags":["redis"]},{"title":"redis性能优化","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/","content":"<h2 id=\"redis性能优化\"><a href=\"#redis性能优化\" class=\"headerlink\" title=\"redis性能优化\"></a>redis性能优化</h2><p>redis提供了一个性能测试工具redis-benchmark，可以使用redis-benchmark命令来了解redis的性能</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis-benchmark -q -c 50</span><br><span class=\"line\"></span><br><span class=\"line\">---------------------</span><br><span class=\"line\">-q 表示简化输出结果</span><br><span class=\"line\">-c 50 表示有五十个客户端</span><br></pre></td></tr></table></figure>\n\n<p>运行结果展示了一些常用redis命令在1秒内可以执行的次数</p>\n","categories":["redis"],"tags":["redis"]},{"title":"redis持久化","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E6%8C%81%E4%B9%85%E5%8C%96/","content":"<h2 id=\"redis持久化\"><a href=\"#redis持久化\" class=\"headerlink\" title=\"redis持久化\"></a>redis持久化</h2><p>redis持久化有两种方式RBD和AOF</p>\n<blockquote>\n<p>注意：我使用的版本是6.0.10，不同版本可能略有差别</p>\n</blockquote>\n<h3 id=\"RDB\"><a href=\"#RDB\" class=\"headerlink\" title=\"RDB\"></a>RDB</h3><p>RDB是指Redis DataBase，在指定的时间间隔内，将内存中数据的快照写入到磁盘中，恢复时将快照读取到内存。</p>\n<p>rdb文件时一个经过压缩的二进制文件</p>\n<p>redis会单独创建(fork)一个子线程来进行持久化，会先将数据写入到临时文件，持久化结束之后，将临时文件替换上次持久化好的文件(保存在dump.rdb文件中)，RDB方式比AOF更加高效，但是可能会丢失最后一次持久化的数据</p>\n<blockquote>\n<p>在这里fork的线程是根据当前线程fork的，包含了当前线程的所有数据、变量等</p>\n</blockquote>\n<a id=\"more\"></a>\n\n<p>关于RDB的配置是在redis.conf中的快照(SNAPSHOTTING)模块中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#</span><br><span class=\"line\"># Save the DB on disk:</span><br><span class=\"line\">#</span><br><span class=\"line\">#   save &lt;seconds&gt; &lt;changes&gt;</span><br><span class=\"line\">#</span><br><span class=\"line\"># 保存触发条件</span><br><span class=\"line\">save 900 1</span><br><span class=\"line\">save 300 10</span><br><span class=\"line\">save 60 10000</span><br><span class=\"line\"></span><br><span class=\"line\">#后台保存出错，停止写入</span><br><span class=\"line\">stop-writes-on-bgsave-error yes</span><br><span class=\"line\"></span><br><span class=\"line\">#使用LZF压缩算法压缩</span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\"></span><br><span class=\"line\">#存储快照后，redis使用CRC64算法进行数据检验，会增加性能损耗</span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\"></span><br><span class=\"line\">#持久化文件的名称</span><br><span class=\"line\"># The filename where to dump the DB</span><br><span class=\"line\">dbfilename dump.rdb</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">rdb-del-sync-files no</span><br><span class=\"line\"></span><br><span class=\"line\"># 持久化文件的目录</span><br><span class=\"line\">dir &#x2F;usr&#x2F;local&#x2F;var&#x2F;db&#x2F;redis&#x2F;</span><br></pre></td></tr></table></figure>\n\n<p>rdb文件会存储在执行redis-cli的当前目录下的dump.rdb文件中，默认触发条件是</p>\n<blockquote>\n<p>save 900 1  #15分钟内修改了1次<br>save 300 10  #5分钟内修改了10次<br>save 60 10000   #1分钟内修改了10000次</p>\n<blockquote>\n<p>当达到条件时会触发bgsave命令</p>\n</blockquote>\n</blockquote>\n<p>也可以使用save或者bgsave命令来直接立即备份。</p>\n<blockquote>\n<p>save命令是由主线程来做的，其他操作都会阻塞，直到rdb文件创建完毕</p>\n<p>bgsave是后台线程做的，其他操作可以正常执行</p>\n</blockquote>\n<p>可以使用命令来检测rdb文件是否存在问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis-check-rdb</span><br></pre></td></tr></table></figure>\n\n\n\n<p>重启之后会直接加载本目录下的dump.rdb文件</p>\n<h4 id=\"bgsave命令\"><a href=\"#bgsave命令\" class=\"headerlink\" title=\"bgsave命令\"></a>bgsave命令</h4><p>bgsave命令在执行时，服务器处理save、bgsave、bgrewriteaof这三个命令会与平时不同</p>\n<ul>\n<li>save命令不可执行，避免父子进程同时执行rdbsave，防止产生竞争条件</li>\n<li>bgsave命令不可执行，防止两个bgsave产生竞争条件</li>\n<li>如果此时bgsave正在执行，bgrewriteaof会被延迟到bgsave执行完之后执行；如果bgrewriteaof正在执行，则bgsave命令会被拒绝，  为了防止两个子进程同时执行造成大量的磁盘写入操作</li>\n</ul>\n<h4 id=\"优点\"><a href=\"#优点\" class=\"headerlink\" title=\"优点\"></a>优点</h4><ul>\n<li>适合大规模的数据恢复</li>\n<li>对数据完整性和一致性要求不高</li>\n</ul>\n<h4 id=\"缺点\"><a href=\"#缺点\" class=\"headerlink\" title=\"缺点\"></a>缺点</h4><ul>\n<li>由于是每隔一段时间去备份的，如果redis意外挂掉的话，可能会丢失最后一次快照的所有修改</li>\n<li>fork的时候，内存中的数据被克隆一份，会有2倍的性能损耗</li>\n</ul>\n<h4 id=\"停止RDB持久化的方式\"><a href=\"#停止RDB持久化的方式\" class=\"headerlink\" title=\"停止RDB持久化的方式\"></a>停止RDB持久化的方式</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis-cli config set save &quot;&quot;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>在进行rdb持久化是将内存数据完整的写入磁盘，并不是使用增量的方式，如果数据量大的话可能会有大量的磁盘IO操作</p>\n</blockquote>\n<h3 id=\"AOF\"><a href=\"#AOF\" class=\"headerlink\" title=\"AOF\"></a>AOF</h3><p>AOF是指Append Only File，以日志的形式记录写操作，只许追加文件内容，不许修改，redis启动时会读取该文件来根据日志文件内容重新将写指令执行一次以完成数据恢复(日志文件名称为appendonly.aof)</p>\n<p>默认该方式没有开启</p>\n<p>关于AOF的配置是在redis.conf中的APPEND ONLY MODE模块中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">############################## APPEND ONLY MODE ###############################</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 默认使用的是RDB，所以aof默认是关掉的</span><br><span class=\"line\"># 如果AOF和RDB并存的话，优先加载AOF</span><br><span class=\"line\">appendonly no</span><br><span class=\"line\"></span><br><span class=\"line\"># The name of the append only file (default: &quot;appendonly.aof&quot;)</span><br><span class=\"line\"># 持久化文件名称</span><br><span class=\"line\">appendfilename &quot;appendonly.aof&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 同步写入日志文件 有三个策略 always、everysec、no</span><br><span class=\"line\"># appendfsync always</span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"># appendfsync no</span><br><span class=\"line\"></span><br><span class=\"line\">#重写时是否同步追加日志文件</span><br><span class=\"line\">no-appendfsync-on-rewrite no</span><br><span class=\"line\"></span><br><span class=\"line\">#重写触发机制  比上次rewrite的aof文件大小扩增一倍且重写的最小大小为64m</span><br><span class=\"line\">auto-aof-rewrite-percentage 100</span><br><span class=\"line\">auto-aof-rewrite-min-size 64mb</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">aof-load-truncated yes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">aof-use-rdb-preamble yes</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果aof文件中存在一些错误的指令(由于网络原因等问题导致命令没有写完)，可以使用命令进行修复aof文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis-check-aof --fix</span><br></pre></td></tr></table></figure>\n\n\n</blockquote>\n<p>aof比rdb具有更好的持久化性，在使用aof持久化方式时，redis会将每一个收到的写命令通过write函数追加到文件中，在redis重启时会将aof文件中的命令重新执行一遍</p>\n<h4 id=\"AOF实现\"><a href=\"#AOF实现\" class=\"headerlink\" title=\"AOF实现\"></a>AOF实现</h4><p>AOF持久化方式打开之后，服务器执行写命令会写在缓冲区的末尾(server.c中的redisServer中有一个aof_buf字段来作为缓冲区)，serverCron函数会定时将aof_buf缓冲区中的数据写入到文件</p>\n<h4 id=\"重写机制\"><a href=\"#重写机制\" class=\"headerlink\" title=\"重写机制\"></a>重写机制</h4><p>由于AOF采用的是日志追加，可能会导致日志文件越来越大，为了避免此情况，增加了重写机制，当AOF文件超过所设定的阈值之后，redis会启动AOF文件的压缩，只保留可以恢复数据的最小指令集，可以使用命令bgrewriteaof来执行</p>\n<blockquote>\n<p>redis在进行重写时会占用大量的cpu和内存资源</p>\n</blockquote>\n<blockquote>\n<p>no-appendfsync-on-rewrite no   这个配置是指是否在每次fsync的时候都进行重写，但是这样会造成大量的磁盘IO，还有可能会造成对写操作的阻塞，所以一般该值不推荐修改为yes</p>\n</blockquote>\n<p>重写步骤：</p>\n<ul>\n<li>redis调用fork，创建一个子进程</li>\n<li>子进程根据内存中的数据库快照，往临时文件中写入命令</li>\n<li>父进程在处理client的时候，除了将写命令写入原来的aof文件中，还需要同时将写命令缓存起来(aof_rewrite_buf_blocks)，写入原来的aof文件中是为了保证如果子进程重写失败不会出问题</li>\n<li>当子进程把快照内容写完之后通知父进程，父进程将缓存的写命令写入临时文件</li>\n<li>父进程将临时文件替换老的aof文件，之后收到的命令也将写入新的aof文件中</li>\n</ul>\n<blockquote>\n</blockquote>\n<h4 id=\"优点-1\"><a href=\"#优点-1\" class=\"headerlink\" title=\"优点\"></a>优点</h4><p>写入日志的策略分为always、everysec、no</p>\n<h4 id=\"缺点-1\"><a href=\"#缺点-1\" class=\"headerlink\" title=\"缺点\"></a>缺点</h4><p>aof文件远大于rdb文件，恢复速度慢</p>\n<blockquote>\n<p>由于aof方式比rdb方式的更新频率高，所以如果开启了aof，那么在启动时会优先使用aof文件来还原数据库状态</p>\n</blockquote>\n<h3 id=\"混合模式\"><a href=\"#混合模式\" class=\"headerlink\" title=\"混合模式\"></a>混合模式</h3><p>在redis4.0之后出现了rdb和aof混合模式，而且默认开模式是开启的</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">aof-use-rdb-preamble yes</span><br></pre></td></tr></table></figure>\n\n<p>开启后，AOF在重写时会直接读取RDB中的内容<br>运行过程：<br>通过bgrwriteaof完成，不同的是当开启混合持久化后，子进程会把内存中的数据以RDB的方式写入aof中，把重写缓冲区中的增量命令以AOF方式写入到文件，将含有RDB格式和AOF格式的AOF数据覆盖旧的AOF文件<br>新的AOF文件中，一部分数据来自RDB文件，一部分来自Redis运行过程时的增量数据</p>\n<h3 id=\"定时任务\"><a href=\"#定时任务\" class=\"headerlink\" title=\"定时任务\"></a>定时任务</h3><p>在server.c中的serverCron函数是redis的一个定时任务，该函数处理了很多定时处理的命令。可以在配置文件中配置hz的值来配置每秒执行多少次，默认是10，即1秒执行10次，表示100ms一次</p>\n<figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/* This is our timer interrupt, called server.hz times per second.</span></span><br><span class=\"line\"><span class=\"comment\"> * Here is where we do a number of things that need to be done asynchronously.</span></span><br><span class=\"line\"><span class=\"comment\"> * For instance:</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * - Active expired keys collection (it is also performed in a lazy way on</span></span><br><span class=\"line\"><span class=\"comment\"> *   lookup).</span></span><br><span class=\"line\"><span class=\"comment\"> * - Software watchdog.</span></span><br><span class=\"line\"><span class=\"comment\"> * - Update some statistic.</span></span><br><span class=\"line\"><span class=\"comment\"> * - Incremental rehashing of the DBs hash tables.</span></span><br><span class=\"line\"><span class=\"comment\"> * - Triggering BGSAVE / AOF rewrite, and handling of terminated children.</span></span><br><span class=\"line\"><span class=\"comment\"> * - Clients timeout of different kinds.</span></span><br><span class=\"line\"><span class=\"comment\"> * - Replication reconnection.</span></span><br><span class=\"line\"><span class=\"comment\"> * - Many more...</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * Everything directly called here will be called server.hz times per second,</span></span><br><span class=\"line\"><span class=\"comment\"> * so in order to throttle execution of things we want to do less frequently</span></span><br><span class=\"line\"><span class=\"comment\"> * a macro is used: run_with_period(milliseconds) &#123; .... &#125;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br></pre></td></tr></table></figure>\n\n","categories":["redis"],"tags":["redis"]},{"title":"redis缓存穿透和缓存雪崩问题","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E5%92%8C%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98/","content":"<h2 id=\"redis缓存穿透和缓存雪崩问题\"><a href=\"#redis缓存穿透和缓存雪崩问题\" class=\"headerlink\" title=\"redis缓存穿透和缓存雪崩问题\"></a>redis缓存穿透和缓存雪崩问题</h2><h3 id=\"缓存穿透\"><a href=\"#缓存穿透\" class=\"headerlink\" title=\"缓存穿透\"></a>缓存穿透</h3><p>请求缓存中不存在的数据，导致所有的请求都到数据库中去查询，导致数据库压力过大</p>\n<p>解决：</p>\n<ul>\n<li><p>利用互斥锁，缓存中没有，先获取锁，再去请求数据库，没有获取到锁的，先等待在进行重试</p>\n</li>\n<li><p>利用布隆过滤器，内部维护一系列合法有效的key进行拦截，如果不合法直接返回</p>\n</li>\n</ul>\n<a id=\"more\"></a>\n\n<h3 id=\"缓存雪崩\"><a href=\"#缓存雪崩\" class=\"headerlink\" title=\"缓存雪崩\"></a>缓存雪崩</h3><p>缓存同一时间大量失效，导致大量请求直接访问数据库，从而导致数据库压力倍增</p>\n<ul>\n<li>在设置缓存时间时，加上一个随机值，避免集体失效[无法解决热点数据问题(同一时刻访问同一条数据)]</li>\n<li>双缓存，缓存1中设置过期时间，缓存2中在启动时加载，进行缓存预热，先访问缓存1，如果有值则返回；缓存1没有值，则访问缓存2，返回数据，并启动异步更新线程来同时更新缓存1和缓存2的数据</li>\n<li>加锁来限制访问数据库，双重检查，减少数据库访问次数</li>\n</ul>\n","categories":["redis"],"tags":["redis"]},{"title":"redis解析命令","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E8%A7%A3%E6%9E%90%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"redis解析命令\"><a href=\"#redis解析命令\" class=\"headerlink\" title=\"redis解析命令\"></a>redis解析命令</h2><p>以string的set命令为例</p>\n<figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setCommand</span><span class=\"params\">(client *c)</span> </span>&#123;</span><br><span class=\"line\">    robj *expire = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> unit = UNIT_SECONDS;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> flags = OBJ_NO_FLAGS;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (parseExtendedStringArgumentsOrReply(c,&amp;flags,&amp;unit,&amp;expire,COMMAND_SET) != C_OK) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    c-&gt;argv[<span class=\"number\">2</span>] = tryObjectEncoding(c-&gt;argv[<span class=\"number\">2</span>]);</span><br><span class=\"line\">    setGenericCommand(c,flags,c-&gt;argv[<span class=\"number\">1</span>],c-&gt;argv[<span class=\"number\">2</span>],expire,unit,<span class=\"literal\">NULL</span>,<span class=\"literal\">NULL</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>根据命令可以看出，传入的是一个client对象</p>\n<h3 id=\"client对象\"><a href=\"#client对象\" class=\"headerlink\" title=\"client对象\"></a>client对象</h3><figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">client</span> &#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">uint64_t</span> id;            <span class=\"comment\">/* Client incremental unique ID. */</span></span><br><span class=\"line\">    connection *conn;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> resp;               <span class=\"comment\">/* RESP protocol version. Can be 2 or 3. */</span></span><br><span class=\"line\">    redisDb *db;            <span class=\"comment\">/* Pointer to currently SELECTed DB. */</span></span><br><span class=\"line\">    <span class=\"comment\">// 客户端名称</span></span><br><span class=\"line\">      robj *name;             <span class=\"comment\">/* As set by CLIENT SETNAME. */</span></span><br><span class=\"line\">      <span class=\"comment\">// 查询缓存</span></span><br><span class=\"line\">    sds querybuf;           <span class=\"comment\">/* Buffer we use to accumulate client queries. */</span></span><br><span class=\"line\">    <span class=\"keyword\">size_t</span> qb_pos;          <span class=\"comment\">/* The position we have read in querybuf. */</span></span><br><span class=\"line\">    sds pending_querybuf;   <span class=\"comment\">/* If this client is flagged as master, this buffer</span></span><br><span class=\"line\"><span class=\"comment\">                               represents the yet not applied portion of the</span></span><br><span class=\"line\"><span class=\"comment\">                               replication stream that we are receiving from</span></span><br><span class=\"line\"><span class=\"comment\">                               the master. */</span></span><br><span class=\"line\">    <span class=\"keyword\">size_t</span> querybuf_peak;   <span class=\"comment\">/* Recent (100ms or more) peak of querybuf size. */</span></span><br><span class=\"line\">      <span class=\"comment\">// 参数个数</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> argc;               <span class=\"comment\">/* Num of arguments of current command. */</span></span><br><span class=\"line\">      <span class=\"comment\">// 命令参数</span></span><br><span class=\"line\">    robj **argv;            <span class=\"comment\">/* Arguments of current command. */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> original_argc;      <span class=\"comment\">/* Num of arguments of original command if arguments were rewritten. */</span></span><br><span class=\"line\">    robj **original_argv;   <span class=\"comment\">/* Arguments of original command if arguments were rewritten. */</span></span><br><span class=\"line\">    <span class=\"keyword\">size_t</span> argv_len_sum;    <span class=\"comment\">/* Sum of lengths of objects in argv list. */</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">redisCommand</span> *<span class=\"title\">cmd</span>, *<span class=\"title\">lastcmd</span>;</span>  <span class=\"comment\">/* Last command executed. */</span></span><br><span class=\"line\">    user *user;             <span class=\"comment\">/* User associated with this connection. If the</span></span><br><span class=\"line\"><span class=\"comment\">                               user is set to NULL the connection can do</span></span><br><span class=\"line\"><span class=\"comment\">                               anything (admin). */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> reqtype;            <span class=\"comment\">/* Request protocol type: PROTO_REQ_* */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> multibulklen;       <span class=\"comment\">/* Number of multi bulk arguments left to read. */</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> bulklen;           <span class=\"comment\">/* Length of bulk argument in multi bulk request. */</span></span><br><span class=\"line\">    <span class=\"built_in\">list</span> *reply;            <span class=\"comment\">/* List of reply objects to send to the client. */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> reply_bytes; <span class=\"comment\">/* Tot bytes of objects in reply list. */</span></span><br><span class=\"line\">    <span class=\"keyword\">size_t</span> sentlen;         <span class=\"comment\">/* Amount of bytes already sent in the current</span></span><br><span class=\"line\"><span class=\"comment\">                               buffer or object being sent. */</span></span><br><span class=\"line\">    <span class=\"keyword\">time_t</span> ctime;           <span class=\"comment\">/* Client creation time. */</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> duration;          <span class=\"comment\">/* Current command duration. Used for measuring latency of blocking/non-blocking cmds */</span></span><br><span class=\"line\">    <span class=\"keyword\">time_t</span> lastinteraction; <span class=\"comment\">/* Time of the last interaction, used for timeout */</span></span><br><span class=\"line\">    <span class=\"keyword\">time_t</span> obuf_soft_limit_reached_time;</span><br><span class=\"line\">      <span class=\"comment\">// 标识</span></span><br><span class=\"line\">    <span class=\"keyword\">uint64_t</span> flags;         <span class=\"comment\">/* Client flags: CLIENT_* macros. */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> authenticated;      <span class=\"comment\">/* Needed when the default user requires auth. */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> replstate;          <span class=\"comment\">/* Replication state if this is a slave. */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> repl_put_online_on_ack; <span class=\"comment\">/* Install slave write handler on first ACK. */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> repldbfd;           <span class=\"comment\">/* Replication DB file descriptor. */</span></span><br><span class=\"line\">    <span class=\"keyword\">off_t</span> repldboff;        <span class=\"comment\">/* Replication DB file offset. */</span></span><br><span class=\"line\">    <span class=\"keyword\">off_t</span> repldbsize;       <span class=\"comment\">/* Replication DB file size. */</span></span><br><span class=\"line\">    sds replpreamble;       <span class=\"comment\">/* Replication DB preamble. */</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> read_reploff; <span class=\"comment\">/* Read replication offset if this is a master. */</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> reploff;      <span class=\"comment\">/* Applied replication offset if this is a master. */</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> repl_ack_off; <span class=\"comment\">/* Replication ack offset, if this is a slave. */</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> repl_ack_time;<span class=\"comment\">/* Replication ack time, if this is a slave. */</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> psync_initial_offset; <span class=\"comment\">/* FULLRESYNC reply offset other slaves</span></span><br><span class=\"line\"><span class=\"comment\">                                       copying this slave output buffer</span></span><br><span class=\"line\"><span class=\"comment\">                                       should use. */</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> replid[CONFIG_RUN_ID_SIZE+<span class=\"number\">1</span>]; <span class=\"comment\">/* Master replication ID (if master). */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> slave_listening_port; <span class=\"comment\">/* As configured with: REPLCONF listening-port */</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> *slave_addr;       <span class=\"comment\">/* Optionally given by REPLCONF ip-address */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> slave_capa;         <span class=\"comment\">/* Slave capabilities: SLAVE_CAPA_* bitwise OR. */</span></span><br><span class=\"line\">    multiState mstate;      <span class=\"comment\">/* MULTI/EXEC state */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> btype;              <span class=\"comment\">/* Type of blocking op if CLIENT_BLOCKED. */</span></span><br><span class=\"line\">    blockingState bpop;     <span class=\"comment\">/* blocking state */</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> <span class=\"keyword\">long</span> woff;         <span class=\"comment\">/* Last write global replication offset. */</span></span><br><span class=\"line\">    <span class=\"built_in\">list</span> *watched_keys;     <span class=\"comment\">/* Keys WATCHED for MULTI/EXEC CAS */</span></span><br><span class=\"line\">    dict *pubsub_channels;  <span class=\"comment\">/* channels a client is interested in (SUBSCRIBE) */</span></span><br><span class=\"line\">    <span class=\"built_in\">list</span> *pubsub_patterns;  <span class=\"comment\">/* patterns a client is interested in (SUBSCRIBE) */</span></span><br><span class=\"line\">    sds peerid;             <span class=\"comment\">/* Cached peer ID. */</span></span><br><span class=\"line\">    sds sockname;           <span class=\"comment\">/* Cached connection target address. */</span></span><br><span class=\"line\">    listNode *client_list_node; <span class=\"comment\">/* list node in client list */</span></span><br><span class=\"line\">    listNode *paused_list_node; <span class=\"comment\">/* list node within the pause list */</span></span><br><span class=\"line\">    RedisModuleUserChangedFunc auth_callback; <span class=\"comment\">/* Module callback to execute</span></span><br><span class=\"line\"><span class=\"comment\">                                               * when the authenticated user</span></span><br><span class=\"line\"><span class=\"comment\">                                               * changes. */</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> *auth_callback_privdata; <span class=\"comment\">/* Private data that is passed when the auth</span></span><br><span class=\"line\"><span class=\"comment\">                                   * changed callback is executed. Opaque for</span></span><br><span class=\"line\"><span class=\"comment\">                                   * Redis Core. */</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> *auth_module;      <span class=\"comment\">/* The module that owns the callback, which is used</span></span><br><span class=\"line\"><span class=\"comment\">                             * to disconnect the client if the module is</span></span><br><span class=\"line\"><span class=\"comment\">                             * unloaded for cleanup. Opaque for Redis Core.*/</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* If this client is in tracking mode and this field is non zero,</span></span><br><span class=\"line\"><span class=\"comment\">     * invalidation messages for keys fetched by this client will be send to</span></span><br><span class=\"line\"><span class=\"comment\">     * the specified client ID. */</span></span><br><span class=\"line\">    <span class=\"keyword\">uint64_t</span> client_tracking_redirection;</span><br><span class=\"line\">    rax *client_tracking_prefixes; <span class=\"comment\">/* A dictionary of prefixes we are already</span></span><br><span class=\"line\"><span class=\"comment\">                                      subscribed to in BCAST mode, in the</span></span><br><span class=\"line\"><span class=\"comment\">                                      context of client side caching. */</span></span><br><span class=\"line\">    <span class=\"comment\">/* In clientsCronTrackClientsMemUsage() we track the memory usage of</span></span><br><span class=\"line\"><span class=\"comment\">     * each client and add it to the sum of all the clients of a given type,</span></span><br><span class=\"line\"><span class=\"comment\">     * however we need to remember what was the old contribution of each</span></span><br><span class=\"line\"><span class=\"comment\">     * client, and in which categoty the client was, in order to remove it</span></span><br><span class=\"line\"><span class=\"comment\">     * before adding it the new value. */</span></span><br><span class=\"line\">    <span class=\"keyword\">uint64_t</span> client_cron_last_memory_usage;</span><br><span class=\"line\">    <span class=\"keyword\">int</span>      client_cron_last_memory_type;</span><br><span class=\"line\">    <span class=\"comment\">/* Response buffer */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> bufpos;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[PROTO_REPLY_CHUNK_BYTES];</span><br><span class=\"line\">&#125; client;</span><br></pre></td></tr></table></figure>\n\n<p>其实最主要的是argv和argc，argv表示参数的值，argc表示参数的数量</p>\n<p>如：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">set key value</span><br></pre></td></tr></table></figure>\n\n<p>此时argc为3，argv[0]为set，argv[1]为key，argv[2]为value，然后命令执行器根据argv[0]来找到对应的实现函数</p>\n","categories":["redis"],"tags":["redis"]},{"title":"redis过期删除","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E8%BF%87%E6%9C%9F%E5%88%A0%E9%99%A4/","content":"<h2 id=\"redis过期删除\"><a href=\"#redis过期删除\" class=\"headerlink\" title=\"redis过期删除\"></a>redis过期删除</h2><p>redis的键可以设置过期时间，但是并不是每个键一到过期时间就会立即删除，redis不可能给每个设置过期时间的key上添加一个定时器来监视是否过期，CPU根本承受不了如此多的定时线程</p>\n<blockquote>\n<p>注意：我使用的版本是6.0.10，不同版本可能略有差别</p>\n</blockquote>\n<p>redis采用的策略是定期删除+惰性删除</p>\n<blockquote>\n<p>定期删除是指每个一段时间去检查是否有过期的key，如果有则删除</p>\n<p>惰性删除是指在获取key的时候检查一下这个key是否过期</p>\n</blockquote>\n<a id=\"more\"></a>\n\n<p>定期删除的配置是hz(默认是10，即每秒十次扫描)</p>\n<p>首先客户端在尝试访问某个key的时候，redis会检查是否过期，如果过期则删除，但是有些key是不会被访问到的，redis的定期删除则会进行扫描并删除过期的key</p>\n<ol>\n<li>从过期字典里随机抽取20个key</li>\n<li>删除这20个key中已经过期的key</li>\n<li>如果过期的比例超过25%，则重复步骤一</li>\n</ol>\n<blockquote>\n<p>过期的key过多会导致循环抽取删除，为防止过度循环，增加了扫描的上限，默认不超过25ms</p>\n<p>应该避免同一时刻大量key同时过期</p>\n</blockquote>\n<p>在主从结构中，从服务器就算读取到过期键也不会删除，只有接收到主服务器发来的del命令之后才会删除</p>\n<h3 id=\"淘汰机制\"><a href=\"#淘汰机制\" class=\"headerlink\" title=\"淘汰机制\"></a>淘汰机制</h3><p>配置最大内存的大小</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">maxmemory 100mb</span><br></pre></td></tr></table></figure>\n\n<p>也可以通过命令进行修改</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6380&gt; config set maxmemory 50mb</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6380&gt; config get maxmemory</span><br><span class=\"line\">1) &quot;maxmemory&quot;</span><br><span class=\"line\">2) &quot;52428800&quot;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>由于使用定期删除+惰性删除机制，但是也可能很多过期的没有被删除掉导致内存不足的情况，所以redis存在淘汰机制</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#设置了过期时间的键，选取最近最少使用的键抛弃（Least Recently Used）</span><br><span class=\"line\"># volatile-lru -&gt; Evict using approximated LRU, only keys with an expire set.</span><br><span class=\"line\">#对于所有的键，选取最近最少使用的键抛弃（Least Recently Used）</span><br><span class=\"line\"># allkeys-lru -&gt; Evict any key using approximated LRU.</span><br><span class=\"line\">#设置了过期时间的键，选取最少频率使用的键抛弃（Least Frequently Used）</span><br><span class=\"line\"># volatile-lfu -&gt; Evict using approximated LFU, only keys with an expire set.</span><br><span class=\"line\">#对于所有的键，选取最少频率使用的键抛弃（Least Frequently Used）</span><br><span class=\"line\"># allkeys-lfu -&gt; Evict any key using approximated LFU.</span><br><span class=\"line\">#对于设置过期时间的键，随机选取键抛弃</span><br><span class=\"line\"># volatile-random -&gt; Remove a random key having an expire set.</span><br><span class=\"line\">#对于所有的键，随机选取键抛弃</span><br><span class=\"line\"># allkeys-random -&gt; Remove a random key, any key.</span><br><span class=\"line\">#抛弃最近要过期的键</span><br><span class=\"line\"># volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span><br><span class=\"line\">#默认策略，不淘汰，如果内存已满，写操作返回错误</span><br><span class=\"line\"># noeviction -&gt; Don&#39;t evict anything, just return an error on write operations.</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>在使用volatile-lfu、volatile-random、volatile-ttl时，如果没有key可以淘汰，则与noeviction一样在写操作时返回错误</p>\n</blockquote>\n<p>获取当前的内存策略</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">config get maxmemory-policy</span><br></pre></td></tr></table></figure>\n\n<p>可以在配置文件修改</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">maxmemory-policy noeviction</span><br></pre></td></tr></table></figure>\n\n<p>也可以使用命令设置</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">config set maxmemory-policy noeviction</span><br></pre></td></tr></table></figure>\n\n\n\n<p>在进行LRU/LFU/TTL淘汰策略时，并不是那么准确，可以通过采样率来进行设置其准确度，默认是5，当设置为10的时候就非常接近真正的LRU算法了，但是会消耗更多的CPU，5已经是足够好的结果了</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">maxmemory-samples 5</span><br></pre></td></tr></table></figure>\n\n","categories":["redis"],"tags":["redis"]},{"title":"redis集群","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E9%9B%86%E7%BE%A4/","content":"<h2 id=\"redis集群\"><a href=\"#redis集群\" class=\"headerlink\" title=\"redis集群\"></a>redis集群</h2><blockquote>\n<p>注意：我使用的版本是6.0.10，不同版本可能略有差别</p>\n</blockquote>\n<p>redis集群的出现解决了redis在分布式方面的需求(3.0版本出现)，而且解决了原本的哨兵模式sentinel无法解决从节点下线的问题。</p>\n<p>redis-cluster使用虚拟槽的方式来进行分片，把所有的节点映射到0-16383槽点上，cluster负责维护节点到哈希槽之间的关系，当需要在redis集群中存放键值对时，redis先对key使用crc16算法算出一个结果，然后对16384取余，redis会根据节点数量将哈希槽映射到不同的节点上</p>\n<a id=\"more\"></a>\n\n\n\n<h3 id=\"为什么采用虚拟槽的方式\"><a href=\"#为什么采用虚拟槽的方式\" class=\"headerlink\" title=\"为什么采用虚拟槽的方式\"></a>为什么采用虚拟槽的方式</h3><p>数据分片的路由策略一般有三种：取模、一致性hash、虚拟槽</p>\n<h4 id=\"取模\"><a href=\"#取模\" class=\"headerlink\" title=\"取模\"></a>取模</h4><p>取模是根据元素对节点数取模获得的</p>\n<p>但是存在问题就是如果增加或减少节点时，数据的路由会发生变化，没有什么可扩展性</p>\n<h4 id=\"一致性hash\"><a href=\"#一致性hash\" class=\"headerlink\" title=\"一致性hash\"></a>一致性hash</h4><p>一致性hash是对2^32^ 取模，将Hash值空间组成虚拟的圆环，整个圆环按照顺时针方向依次排列，之后将每个服务器进行hash运算，确定服务器在hash环上的地址，确定了服务器地址后，对数据同样使用hash算法，将数据定位到服务器上，如果定位的位置没有服务器，从顺时针寻找，找到的第一台服务器即为该数据最终的服务器位置</p>\n<p>但是存在的问题是很难保证客户端的请求平均分配在各个节点，不能很好地负载均衡，在服务器很少的时候，容易出现服务器节点分布不均</p>\n<h4 id=\"虚拟槽\"><a href=\"#虚拟槽\" class=\"headerlink\" title=\"虚拟槽\"></a>虚拟槽</h4><p>虚拟槽是根据某个散列函数得到槽位，找到对应的节点</p>\n<h3 id=\"集群配置\"><a href=\"#集群配置\" class=\"headerlink\" title=\"集群配置\"></a>集群配置</h3><p>修改redis.conf来设置集群参数</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">cluster-enabled yes</span><br><span class=\"line\">cluster-config-file nodes-6380.conf</span><br></pre></td></tr></table></figure>\n\n<p>在使用客户端连接时</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">-c 表示集群连接  如果不使用集群连接，无法访问到集群内的数据</span></span><br><span class=\"line\">redis-cli -c -p 6379</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 可以使用redis-cli来分配槽点</span></span><br><span class=\"line\">redis-cli -p 6381 cluster addslots &#123;10923..16383&#125;</span><br></pre></td></tr></table></figure>\n\n<p>查看集群节点</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cluster nodes</span><br><span class=\"line\">------------------------</span><br><span class=\"line\">57702920ad1a9849cb61ff6b83f9aba97effee9e :6379@16379 myself,master - 0 0 0 connected 12458</span><br></pre></td></tr></table></figure>\n\n<p>此时只有一个节点，所以集群节点只有一个</p>\n<p>然后将6380和6381加入到集群中</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; cluster meet 127.0.0.1 6380</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; cluster meet 127.0.0.1 6381</span><br><span class=\"line\">OK</span><br><span class=\"line\"></span><br><span class=\"line\">127.0.0.1:6379&gt; cluster nodes</span><br><span class=\"line\">85f3b3d55caa4699abaa916b1a7a800b06226b18 127.0.0.1:6380@16380 slave 57702920ad1a9849cb61ff6b83f9aba97effee9e 0 1614926896368 1 connected</span><br><span class=\"line\">d49e7bc9e01c4f0b687c46d964ef6cdccf90fff2 127.0.0.1:6381@16381 slave 57702920ad1a9849cb61ff6b83f9aba97effee9e 0 1614926895337 1 connected</span><br><span class=\"line\">57702920ad1a9849cb61ff6b83f9aba97effee9e 127.0.0.1:6379@16379 myself,master - 0 1614926895000 1 connected 12458</span><br></pre></td></tr></table></figure>\n\n<p>查看集群信息</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">127.0.0.1:6379&gt; cluster info</span><br><span class=\"line\">--------------------------------------</span><br><span class=\"line\">cluster_state:ok</span><br><span class=\"line\">cluster_slots_assigned:16384</span><br><span class=\"line\">cluster_slots_ok:16384</span><br><span class=\"line\">cluster_slots_pfail:0</span><br><span class=\"line\">cluster_slots_fail:0</span><br><span class=\"line\">cluster_known_nodes:4</span><br><span class=\"line\">cluster_size:3</span><br><span class=\"line\">cluster_current_epoch:2</span><br><span class=\"line\">cluster_my_epoch:2</span><br><span class=\"line\">cluster_stats_messages_ping_sent:331</span><br><span class=\"line\">cluster_stats_messages_pong_sent:299</span><br><span class=\"line\">cluster_stats_messages_fail_sent:1</span><br><span class=\"line\">cluster_stats_messages_sent:631</span><br><span class=\"line\">cluster_stats_messages_ping_received:298</span><br><span class=\"line\">cluster_stats_messages_pong_received:330</span><br><span class=\"line\">cluster_stats_messages_meet_received:1</span><br><span class=\"line\">cluster_stats_messages_fail_received:1</span><br><span class=\"line\">cluster_stats_messages_update_received:90</span><br><span class=\"line\">cluster_stats_messages_received:720</span><br></pre></td></tr></table></figure>\n\n<p>也使用命令来自己分配槽点</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cluster addslots [slot ...]</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>集群中所有master参与投票，如果半数以上的master节点与其中一个master节点通信超过cluster-node-timeout，则认为该master节点挂掉</p>\n</blockquote>\n<p>也可以为集群中的主节点配置从节点</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cluster replicate f82552a7942609ee90e5201d563804c065588847</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果需要重新构建集群关系的话，需要删除每个节点的node.conf和rdb文件，否则集群搭建不成功</p>\n</blockquote>\n<h3 id=\"集群不可用情况\"><a href=\"#集群不可用情况\" class=\"headerlink\" title=\"集群不可用情况\"></a>集群不可用情况</h3><ul>\n<li>如果集群任意master挂掉，且当前master没有slave，则集群进入fail状态</li>\n<li>如果集群超过半数的master挂掉，不管有没有slave，集群进入fail状态</li>\n</ul>\n<h3 id=\"集群支持高级特性\"><a href=\"#集群支持高级特性\" class=\"headerlink\" title=\"集群支持高级特性\"></a>集群支持高级特性</h3><p>如果要在集群上使用事务、LUA脚本等功能，必须保证所操作的key在同一个槽点中，可以使用hash tags来确保在同一个槽点中，如下面所示的格式，redis会根据{}中提供的字符来进行hash操作寻找多对应的槽点</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;person.did&#125;person:did</span><br></pre></td></tr></table></figure>\n\n","categories":["redis"],"tags":["redis"]},{"title":"skiplist实现","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/skiplist%E5%AE%9E%E7%8E%B0/","content":"<h2 id=\"skiplist实现\"><a href=\"#skiplist实现\" class=\"headerlink\" title=\"skiplist实现\"></a>skiplist实现</h2><p>skiplist跳跃表，是一种有序数据结构，通过在每个节点中维持多个指向其他节点的指针，来达到快速访问节点的目的，redis使用skiplist作为zsort的底层实现之一</p>\n<p>结构很像树形结构</p>\n<figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplistNode</span> &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 对象</span></span><br><span class=\"line\">    sds ele;</span><br><span class=\"line\">      <span class=\"comment\">// 分值</span></span><br><span class=\"line\">    <span class=\"keyword\">double</span> score;</span><br><span class=\"line\">      <span class=\"comment\">// 后退指针，从表尾向表头方向的访问及诶按</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplistNode</span> *<span class=\"title\">backward</span>;</span></span><br><span class=\"line\">      <span class=\"comment\">// 层  数组中可以包含多个元素，每个元素都包含一个指向其他节点的指针</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplistLevel</span> &#123;</span></span><br><span class=\"line\">          <span class=\"comment\">// 前进指针，从表头向表尾方向访问节点</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplistNode</span> *<span class=\"title\">forward</span>;</span></span><br><span class=\"line\">          <span class=\"comment\">// 跨度，记录两个节点间的距离，跨度值是两个节点score的差值</span></span><br><span class=\"line\">        <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> span;</span><br><span class=\"line\">    &#125; level[];</span><br><span class=\"line\">&#125; zskiplistNode;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplist</span> &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 头尾节点</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">zskiplistNode</span> *<span class=\"title\">header</span>, *<span class=\"title\">tail</span>;</span></span><br><span class=\"line\">      <span class=\"comment\">// 跳跃表的长度</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> length;</span><br><span class=\"line\">      <span class=\"comment\">// 记录目前跳跃表的深度(表头节点的层数不计算在内)</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> level;</span><br><span class=\"line\">&#125; zskiplist;</span><br></pre></td></tr></table></figure>\n\n","categories":["redis"],"tags":["redis"]},{"title":"ziplist实现","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/ziplist%E5%AE%9E%E7%8E%B0/","content":"<h2 id=\"ziplist实现\"><a href=\"#ziplist实现\" class=\"headerlink\" title=\"ziplist实现\"></a>ziplist实现</h2><blockquote>\n<p>注意：我使用的版本是6.0.10，不同版本可能略有差别</p>\n</blockquote>\n<p>ziplist又叫做压缩列表，使用一段连续的内存来存储数据的数据结构，redis为了节约内存而开发的</p>\n<h3 id=\"ziplist结构\"><a href=\"#ziplist结构\" class=\"headerlink\" title=\"ziplist结构\"></a>ziplist结构</h3><p>&lt;zlbytes&gt; &lt;zltail&gt; &lt;zllen&gt; &lt;entry&gt; &lt;entry&gt; … &lt;entry&gt; &lt;zlend&gt;</p>\n<ul>\n<li>zlbytes   32位，4个字节  ziplist总字节数</li>\n<li>zltail  32位，4个字节   压缩列表表尾距离起始位置有多少字节</li>\n<li>zllen  16位，2个字节  记录压缩列表节点数量，由于是16位，最大值为65535，超过的话需要遍历整个ziplist才可以知道</li>\n<li>entry  存储的值</li>\n<li>zlend  8位，1个字节  表示ziplist结尾的特殊值</li>\n</ul>\n<a id=\"more\"></a>\n\n<p>entry的结构</p>\n<p>&lt;prevlen&gt; &lt;encoding&gt; &lt;entry-data&gt;</p>\n<ul>\n<li>prevlen  上一个节点的长度，可以和当前的地址进行指针运算，找到上一个节点的起始地址</li>\n<li>encoding  编码及长度</li>\n<li>entry-data  字符串类型的值</li>\n</ul>\n<p>由于这个特殊的结构构造，所以压缩列表可以很快的从表尾向表头遍历操作</p>\n<ul>\n<li>根据zltail可以直接获取到表尾节点</li>\n<li>指针指向表尾节点起始地址的指针，根据prevlen可以直接获取到前一个节点的起始地址的指针</li>\n<li>一直向前一个节点遍历，一直到头节点</li>\n</ul>\n<h3 id=\"使用ziplist的数据类型\"><a href=\"#使用ziplist的数据类型\" class=\"headerlink\" title=\"使用ziplist的数据类型\"></a>使用ziplist的数据类型</h3><p>redis中hash、list、zset使用了ziplist结构存储，但是存在了一些条件</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">hash-max-ziplist-entries 512</span><br><span class=\"line\">hash-max-ziplist-value 64</span><br><span class=\"line\"></span><br><span class=\"line\"># -5: max size: 64 Kb  &lt;-- not recommended for normal workloads</span><br><span class=\"line\"># -4: max size: 32 Kb  &lt;-- not recommended</span><br><span class=\"line\"># -3: max size: 16 Kb  &lt;-- probably not recommended</span><br><span class=\"line\"># -2: max size: 8 Kb   &lt;-- good</span><br><span class=\"line\"># -1: max size: 4 Kb   &lt;-- good</span><br><span class=\"line\">list-max-ziplist-size -2</span><br><span class=\"line\"></span><br><span class=\"line\">zset-max-ziplist-entries 128</span><br><span class=\"line\">zset-max-ziplist-value 64</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>ziplist会比hash、list、zset中使用的底层结构节省内存，存储越小的数据，使用ziplist来进行数据压缩可以得到更好的压缩率，但是会造成额外的内存碎片率</p>\n</blockquote>\n","categories":["redis"],"tags":["redis"]},{"title":"mybatis详细执行过程","url":"/2021/%E6%A1%86%E6%9E%B6/mybatis/%E6%80%BB%E7%BB%93/mybatis%E8%AF%A6%E7%BB%86%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/","content":"<h2 id=\"mybatis详细执行过程\"><a href=\"#mybatis详细执行过程\" class=\"headerlink\" title=\"mybatis详细执行过程\"></a>mybatis详细执行过程</h2><p>下面结合源码来分析一下mybatis的详细执行过程，mybatis的源码在流行的框架中写的还是比较简单且清晰的，可以作为研究框架源码的一个敲门砖，以此来建立一下研究源码的信心。</p>\n<ul>\n<li><p><input disabled type=\"checkbox\">  待整理</p>\n<a id=\"more\"></a>\n\n</li>\n</ul>\n<p>总结：</p>\n<ul>\n<li>根据配置文件(全局配置文件和映射文件)来初始化生成Configuration对象</li>\n<li>创建一个DefaultSqlSession对象，包含有Configuration以及Executor(根据配置文件中的defaultExecutorType来创建对应的Executor)</li>\n<li>DefaultSqlSession.getMapper()，拿到Mapper接口对应的MapperProxy(jdk动态代理)</li>\n<li>MapperProxy里面有DefaultSqlSession</li>\n<li>执行增删改查方法：<ul>\n<li>调用DefaultSqlSession的增删改查方法(里面使用的是Executor的对应方法)</li>\n<li>会创建一个StatementHandler对象，ParameterHandler对象和ResultSetHandler对象</li>\n<li>调用StatementHandler的预编译参数以及ParameterHandler对象参数设置,在调用增删改查方法</li>\n<li>使用ResultSetHandler封装结果</li>\n</ul>\n</li>\n</ul>\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis之DataSource","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B9%8BDataSource/","content":"<h2 id=\"DataSource数据源\"><a href=\"#DataSource数据源\" class=\"headerlink\" title=\"DataSource数据源\"></a>DataSource数据源</h2><p>所有的数据源组件都实现了javax.sql.DataSource接口，Mybatis实现了两个接口实现，分别为PooledDataSource和UnpooledDataSource</p>\n<a id=\"more\"></a>\n\n<h3 id=\"UnpooledDataSource\"><a href=\"#UnpooledDataSource\" class=\"headerlink\" title=\"UnpooledDataSource\"></a>UnpooledDataSource</h3><p>每次通过UnpooledDataSource.getConnection()方法获取数据库连接时都会创建一个新连接。</p>\n<p>在UnpooledDataSource加载时首先会通过以下代码将已经在DriverManger中注册的JDBC驱动复制一份存到registeredDrivers中</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        Enumeration drivers = DriverManager.getDrivers();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(drivers.hasMoreElements()) &#123;</span><br><span class=\"line\">            Driver driver = (Driver)drivers.nextElement();</span><br><span class=\"line\">            registeredDrivers.put(driver.getClass().getName(), driver);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>在使用getConnection()方法以及所有重载时都会调用doGetConnection()方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> Connection <span class=\"title\">doGetConnection</span><span class=\"params\">(Properties properties)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">              <span class=\"comment\">// 初始化数据库驱动</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.initializeDriver();</span><br><span class=\"line\">        Connection connection = DriverManager.getConnection(<span class=\"keyword\">this</span>.url, properties);</span><br><span class=\"line\">              <span class=\"comment\">// 配置数据库连接的autoCommit和隔离级别</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.configureConnection(connection);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> connection;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>initializeDriver()负责数据库驱动的初始化，会创建指定的Driver驱动对象，并将其注册到DriverManager中以及registeredDrivers中。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">initializeDriver</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">              <span class=\"comment\">// 驱动是否已经注册</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!registeredDrivers.containsKey(<span class=\"keyword\">this</span>.driver)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                Class driverType;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.driverClassLoader != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                      <span class=\"comment\">// 这个大家应该都很熟悉  Class.forName(driverName)  之前jdbc都是这么写的</span></span><br><span class=\"line\">                    driverType = Class.forName(<span class=\"keyword\">this</span>.driver, <span class=\"keyword\">true</span>, <span class=\"keyword\">this</span>.driverClassLoader);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    driverType = Resources.classForName(<span class=\"keyword\">this</span>.driver);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                Driver driverInstance = (Driver)driverType.getDeclaredConstructor().newInstance();</span><br><span class=\"line\">                  <span class=\"comment\">//注册驱动 UnpooledDataSource.DriverProxy是内部类，Driver的静态代理类</span></span><br><span class=\"line\">                DriverManager.registerDriver(<span class=\"keyword\">new</span> UnpooledDataSource.DriverProxy(driverInstance));</span><br><span class=\"line\">                registeredDrivers.put(<span class=\"keyword\">this</span>.driver, driverInstance);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception var3) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> SQLException(<span class=\"string\">&quot;Error setting driver on UnpooledDataSource. Cause: &quot;</span> + var3);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>注册驱动这一步可能大家都不知道为什么会有这么一步，因为之前使用JDBC连接的时候只使用过DriverManager.getConnection获取连接，没有使用过DriverManager.registerDriver，而且可以正常使用驱动连接数据库获取数据，在这里给大家普及一下数据库的驱动</p>\n<p>以Mysql驱动为例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.mysql.jdbc;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.sql.DriverManager;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.sql.SQLException;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Driver</span> <span class=\"keyword\">extends</span> <span class=\"title\">NonRegisteringDriver</span> <span class=\"keyword\">implements</span> <span class=\"title\">java</span>.<span class=\"title\">sql</span>.<span class=\"title\">Driver</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Driver</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 看到这个驱动类里的代码大家是不是就明白为什么之前不需要去手动注册驱动了吧</span></span><br><span class=\"line\">            DriverManager.registerDriver(<span class=\"keyword\">new</span> Driver());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SQLException var1) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(<span class=\"string\">&quot;Can&#x27;t register driver!&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果还是没明白，就看下述代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 这行代码就会去加载com.mysql.jdbc.Driver,这个类中的静态块在类加载时会执行，就会注册到DriverManager中</span></span><br><span class=\"line\">Class.forName(<span class=\"string\">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">Connection connection = DriverManager.getConnection(<span class=\"string\">&quot;jdbc:mysql://localhost:3306/jdbc_demo&quot;</span>,<span class=\"string\">&quot;root&quot;</span>,<span class=\"string\">&quot;root&quot;</span>);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"PooledDataSource\"><a href=\"#PooledDataSource\" class=\"headerlink\" title=\"PooledDataSource\"></a>PooledDataSource</h3><p>数据库连接的创建是非常耗时的，数据库能够建立的连接数也是有限的，向上述UnpooledDataSource中这种每次都会创建连接的方式是存在弊端的，所以很多系统都是使用数据库连接池。</p>\n<p>数据库连接池的好处</p>\n<ul>\n<li><p>可以实现数据库连接的重用</p>\n</li>\n<li><p>提高响应速度</p>\n</li>\n<li><p>防止数据库连接过多造成数据库假死</p>\n</li>\n<li><p>避免数据库连接泄露</p>\n</li>\n</ul>\n<h4 id=\"数据库连接池\"><a href=\"#数据库连接池\" class=\"headerlink\" title=\"数据库连接池\"></a>数据库连接池</h4><p>数据库连接池在初始化时，会创建一定数量的数据库连接并添加到连接池中备用。当程序需要使用数据库连接时，从池中请求连接；当程序不再使用该连接时，会将其返回到池中缓存，等待下次使用，而不是直接关闭。数据库连接池可以设置连接总数上限以及空闲连接数上限，如果连接池创建的总连接数已达到上限，且都已被占用，则后续请求连接的线程会进入阻塞队列等待，直到有线程释放可用连接。如果连接池中空闲连接数较多，达到其上限，则后续返回的空闲连接不会放到池中，而是直接关闭，这样可以减少系统维护多余数据库连接的开销。</p>\n<h4 id=\"PooledDataSource-1\"><a href=\"#PooledDataSource-1\" class=\"headerlink\" title=\"PooledDataSource\"></a>PooledDataSource</h4><p>在使用PooledDataSource.getConnection的时候会调用popConnection方法，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Connection <span class=\"title\">getConnection</span><span class=\"params\">(String username, String password)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.popConnection(username, password).getProxyConnection();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>在popConnection中操作的是PooledConnection，PooledConnection中封装了真正的数据库连接对象以及其代理对象(使用JDK动态代理产生的)</p>\n<p>在PooledDataSource中有一个特别重要的属性</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> PoolState state = <span class=\"keyword\">new</span> PoolState(<span class=\"keyword\">this</span>);</span><br></pre></td></tr></table></figure>\n\n<p>PoolState是用来管理PooledConnection对象状态的组件，使用idleConnections和activeConnections两个集合来管理连接</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 空闲状态的连接</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> List&lt;PooledConnection&gt; idleConnections = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\"><span class=\"comment\">// 活跃状态的连接</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> List&lt;PooledConnection&gt; activeConnections = <span class=\"keyword\">new</span> ArrayList();</span><br></pre></td></tr></table></figure>\n\n<p>PoolState还有一些是定义了一系列用来统计的字段</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 请求数据库次数</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> requestCount = <span class=\"number\">0L</span>;</span><br><span class=\"line\"><span class=\"comment\">// 获取连接的累积时间</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> accumulatedRequestTime = <span class=\"number\">0L</span>;</span><br><span class=\"line\"><span class=\"comment\">// checkoutTime表示从取出连接到归还连接的时长</span></span><br><span class=\"line\"><span class=\"comment\">// 所有连接的累积的checkoutTime时长</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> accumulatedCheckoutTime = <span class=\"number\">0L</span>;</span><br><span class=\"line\"><span class=\"comment\">// 超时的连接个数</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> claimedOverdueConnectionCount = <span class=\"number\">0L</span>;</span><br><span class=\"line\"><span class=\"comment\">// 累积超时时间</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> accumulatedCheckoutTimeOfOverdueConnections = <span class=\"number\">0L</span>;</span><br><span class=\"line\"><span class=\"comment\">// 累积等待时间</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> accumulatedWaitTime = <span class=\"number\">0L</span>;</span><br><span class=\"line\"><span class=\"comment\">// 等待次数</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> hadToWaitCount = <span class=\"number\">0L</span>;</span><br><span class=\"line\"><span class=\"comment\">// 无效连接数</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> badConnectionCount = <span class=\"number\">0L</span>;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>PooledConnection是实现了InvocationHandler接口，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        String methodName = method.getName();</span><br><span class=\"line\">              <span class=\"comment\">//对close对象进行代理，调用pushConnection方法，会放回到连接池中，而不是真正的关闭</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"string\">&quot;close&quot;</span>.equals(methodName)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.dataSource.pushConnection(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!Object.class.equals(method.getDeclaringClass())) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.checkConnection();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> method.invoke(<span class=\"keyword\">this</span>.realConnection, args);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable var6) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> ExceptionUtil.unwrapThrowable(var6);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis之ParameterHandler","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B9%8BParameterHandler/","content":"<h2 id=\"ParameterHandler参数处理\"><a href=\"#ParameterHandler参数处理\" class=\"headerlink\" title=\"ParameterHandler参数处理\"></a>ParameterHandler参数处理</h2><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ParameterHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\">Object <span class=\"title\">getParameterObject</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">        <span class=\"comment\">// 负责调用PreparedStatement.set*方法为SQL绑定实参</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setParameters</span><span class=\"params\">(PreparedStatement var1)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"DefaultParameterHandler\"><a href=\"#DefaultParameterHandler\" class=\"headerlink\" title=\"DefaultParameterHandler\"></a>DefaultParameterHandler</h3><p>mybatis只为ParameterHandler提供了一个唯一的实现类DefaultParameterHandler</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DefaultParameterHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">ParameterHandler</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 管理mybatis中全部的TypeHandler对象</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TypeHandlerRegistry typeHandlerRegistry;</span><br><span class=\"line\">      <span class=\"comment\">// 记录SQL节点相应的配置信息</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MappedStatement mappedStatement;</span><br><span class=\"line\">      <span class=\"comment\">// 用户传入的实参对象</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Object parameterObject;</span><br><span class=\"line\">      <span class=\"comment\">// 记录对应参数的名称和相关属性</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> BoundSql boundSql;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Configuration configuration;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DefaultParameterHandler</span><span class=\"params\">(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.mappedStatement = mappedStatement;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.configuration = mappedStatement.getConfiguration();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.typeHandlerRegistry = mappedStatement.getConfiguration().getTypeHandlerRegistry();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.parameterObject = parameterObject;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.boundSql = boundSql;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getParameterObject</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.parameterObject;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setParameters</span><span class=\"params\">(PreparedStatement ps)</span> </span>&#123;</span><br><span class=\"line\">        ErrorContext.instance().activity(<span class=\"string\">&quot;setting parameters&quot;</span>).object(<span class=\"keyword\">this</span>.mappedStatement.getParameterMap().getId());</span><br><span class=\"line\">          <span class=\"comment\">// 去除sql中的参数列表</span></span><br><span class=\"line\">        List&lt;ParameterMapping&gt; parameterMappings = <span class=\"keyword\">this</span>.boundSql.getParameterMappings();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (parameterMappings != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; parameterMappings.size(); ++i) &#123;</span><br><span class=\"line\">                ParameterMapping parameterMapping = (ParameterMapping)parameterMappings.get(i);</span><br><span class=\"line\">                  <span class=\"comment\">// 过滤存储过程的输出参数</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;</span><br><span class=\"line\">                      <span class=\"comment\">// 获取参数名称</span></span><br><span class=\"line\">                    String propertyName = parameterMapping.getProperty();</span><br><span class=\"line\">                    Object value;</span><br><span class=\"line\">                      <span class=\"comment\">// 获取对应实参值</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class=\"line\">                        value = <span class=\"keyword\">this</span>.boundSql.getAdditionalParameter(propertyName);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.parameterObject == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        value = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.typeHandlerRegistry.hasTypeHandler(<span class=\"keyword\">this</span>.parameterObject.getClass())) &#123;</span><br><span class=\"line\">                        value = <span class=\"keyword\">this</span>.parameterObject;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        MetaObject metaObject = <span class=\"keyword\">this</span>.configuration.newMetaObject(<span class=\"keyword\">this</span>.parameterObject);</span><br><span class=\"line\">                        value = metaObject.getValue(propertyName);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    TypeHandler typeHandler = parameterMapping.getTypeHandler();</span><br><span class=\"line\">                    JdbcType jdbcType = parameterMapping.getJdbcType();</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (value == <span class=\"keyword\">null</span> &amp;&amp; jdbcType == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        jdbcType = <span class=\"keyword\">this</span>.configuration.getJdbcTypeForNull();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                          <span class=\"comment\">// 该方法会调用PreparedStatement.set*方法为SQL语句绑定相应的实参</span></span><br><span class=\"line\">                        typeHandler.setParameter(ps, i + <span class=\"number\">1</span>, value, jdbcType);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (SQLException | TypeException var10) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> TypeException(<span class=\"string\">&quot;Could not set parameters for mapping: &quot;</span> + parameterMapping + <span class=\"string\">&quot;. Cause: &quot;</span> + var10, var10);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis之SqlSession","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B9%8BSqlSession/","content":"<p>SqlSession是mybatis的核心接口，SqlSessionFactory负责创建SqlSession对象，包含多个openSession()方法的重载。<br>在SqlSession中定义了常用的数据库操作以及事务操作，接口定义如下</p>\n<a id=\"more\"></a>\n\n<h3 id=\"SqlSession\"><a href=\"#SqlSession\" class=\"headerlink\" title=\"SqlSession\"></a>SqlSession</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">SqlSession</span> <span class=\"keyword\">extends</span> <span class=\"title\">Closeable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 参数为sql语句，返回查询的结果对象</span></span><br><span class=\"line\">  &lt;T&gt; <span class=\"function\">T <span class=\"title\">selectOne</span><span class=\"params\">(String statement)</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 第二个参数为实参对象</span></span><br><span class=\"line\">  &lt;T&gt; <span class=\"function\">T <span class=\"title\">selectOne</span><span class=\"params\">(String statement, Object parameter)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">selectList</span><span class=\"params\">(String statement)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">selectList</span><span class=\"params\">(String statement, Object parameter)</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 第三个参数为查询结果集的范围</span></span><br><span class=\"line\">  &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">selectList</span><span class=\"params\">(String statement, Object parameter, RowBounds rowBounds)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;K, V&gt; <span class=\"function\">Map&lt;K, V&gt; <span class=\"title\">selectMap</span><span class=\"params\">(String statement, String mapKey)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;K, V&gt; <span class=\"function\">Map&lt;K, V&gt; <span class=\"title\">selectMap</span><span class=\"params\">(String statement, Object parameter, String mapKey)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;K, V&gt; <span class=\"function\">Map&lt;K, V&gt; <span class=\"title\">selectMap</span><span class=\"params\">(String statement, Object parameter, String mapKey, RowBounds rowBounds)</span></span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">//返回值是游标对象</span></span><br><span class=\"line\">  &lt;T&gt; <span class=\"function\">Cursor&lt;T&gt; <span class=\"title\">selectCursor</span><span class=\"params\">(String statement)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;T&gt; <span class=\"function\">Cursor&lt;T&gt; <span class=\"title\">selectCursor</span><span class=\"params\">(String statement, Object parameter)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;T&gt; <span class=\"function\">Cursor&lt;T&gt; <span class=\"title\">selectCursor</span><span class=\"params\">(String statement, Object parameter, RowBounds rowBounds)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 查询结果对象将由此指定的ResultHandler对象处理</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">select</span><span class=\"params\">(String statement, Object parameter, ResultHandler handler)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">select</span><span class=\"params\">(String statement, ResultHandler handler)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">select</span><span class=\"params\">(String statement, Object parameter, RowBounds rowBounds, ResultHandler handler)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">insert</span><span class=\"params\">(String statement)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">insert</span><span class=\"params\">(String statement, Object parameter)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(String statement)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(String statement, Object parameter)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">delete</span><span class=\"params\">(String statement)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">delete</span><span class=\"params\">(String statement, Object parameter)</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 提交事务</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">commit</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">commit</span><span class=\"params\">(<span class=\"keyword\">boolean</span> force)</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 回滚事务</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">rollback</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">rollback</span><span class=\"params\">(<span class=\"keyword\">boolean</span> force)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 将请求刷新到数据库</span></span><br><span class=\"line\">  <span class=\"function\">List&lt;BatchResult&gt; <span class=\"title\">flushStatements</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 关闭当前session</span></span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">close</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 清空缓存</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">clearCache</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 获取Configuration对象</span></span><br><span class=\"line\">  <span class=\"function\">Configuration <span class=\"title\">getConfiguration</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 获取type对应的Mapper对象</span></span><br><span class=\"line\">  &lt;T&gt; <span class=\"function\">T <span class=\"title\">getMapper</span><span class=\"params\">(Class&lt;T&gt; type)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// 获取该SqlSession对应的数据库连接</span></span><br><span class=\"line\">  <span class=\"function\">Connection <span class=\"title\">getConnection</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>MyBatis为SqlSession提供了默认实现，DefaultSqlSession类，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Configuration配置对象</span></span><br><span class=\"line\"> <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Configuration configuration;</span><br><span class=\"line\">     <span class=\"comment\">// 底层依赖的Executor对象</span></span><br><span class=\"line\"> <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Executor executor;</span><br><span class=\"line\"><span class=\"comment\">// 是否自动提交事务</span></span><br><span class=\"line\"> <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> autoCommit;</span><br><span class=\"line\">     <span class=\"comment\">// 当前缓存中是否存在脏数据</span></span><br><span class=\"line\"> <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> dirty;</span><br><span class=\"line\">     <span class=\"comment\">// 防止用户忘记关闭已打开的游标，cursorList收集由该SqlSession对象生成的游标对象，在DefaultSqlSession.close()方法统一关闭</span></span><br><span class=\"line\"> <span class=\"keyword\">private</span> List&lt;Cursor&lt;?&gt;&gt; cursorList;</span><br></pre></td></tr></table></figure>\n<p>所有的数据库相关操作全部封装到了Executor接口实现中，DefaultSqlSession类中查询方法的调用关系如下图</p>\n<img src=\"/images/mybatis/mybatis之SqlSession DefaultSqlSession方法调用关系.png\" style=\"zoom:50%;\">\n查询最终都是调用Executor.query(MappedStatement, Object, RowBounds, ResultHandler)方法实现数据库查询操作的  \n对返回对象进行调整  \nselectOne()方法从结果集中获取第一个元素返回  \nselectMap()方法将List集合转为Map集合返回  \nselect()方法将结果对象集合交由用户指定的ResultHandler对象处理，且没有返回值  \nselectList()方法直接将集合返回  \n\n<p>DefaultSqlSession中的insert()、update()、delete()方法最后通过调用DefaultSqlSession.update(String,Object)方法，然后调用Executor.update(MappedStatement, Object)方法完成数据库的修改操作。</p>\n<h3 id=\"DefaultSqlSessionFactory\"><a href=\"#DefaultSqlSessionFactory\" class=\"headerlink\" title=\"DefaultSqlSessionFactory\"></a>DefaultSqlSessionFactory</h3><p>DefaultSqlSessionFactory实现了SqlSessionFactory接口，提供了两种创建DefaultSqlSession的方式</p>\n<h4 id=\"方式一\"><a href=\"#方式一\" class=\"headerlink\" title=\"方式一\"></a>方式一</h4><p>通过数据源获取数据库连接，并创建Executor对象以及DefaultSqlSession对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> SqlSession <span class=\"title\">openSessionFromDataSource</span><span class=\"params\">(ExecutorType execType, TransactionIsolationLevel level, <span class=\"keyword\">boolean</span> autoCommit)</span> </span>&#123;</span><br><span class=\"line\">    Transaction tx = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    DefaultSqlSession var8;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 获取mybatis-config.xml的配置中的Environment对象</span></span><br><span class=\"line\">        Environment environment = <span class=\"keyword\">this</span>.configuration.getEnvironment();</span><br><span class=\"line\">          <span class=\"comment\">// 获取TransactionFactory</span></span><br><span class=\"line\">        TransactionFactory transactionFactory = <span class=\"keyword\">this</span>.getTransactionFactoryFromEnvironment(environment);</span><br><span class=\"line\">        <span class=\"comment\">// 创建Transaction</span></span><br><span class=\"line\">          tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class=\"line\">        Executor executor = <span class=\"keyword\">this</span>.configuration.newExecutor(tx, execType);</span><br><span class=\"line\">        var8 = <span class=\"keyword\">new</span> DefaultSqlSession(<span class=\"keyword\">this</span>.configuration, executor, autoCommit);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception var12) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.closeTransaction(tx);</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> ExceptionFactory.wrapException(<span class=\"string\">&quot;Error opening session.  Cause: &quot;</span> + var12, var12);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        ErrorContext.instance().reset();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> var8;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"方式二\"><a href=\"#方式二\" class=\"headerlink\" title=\"方式二\"></a>方式二</h4><p>用户提供数据库连接，根据数据库连接创建Executor对象以及DefaultSqlSession对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> SqlSession <span class=\"title\">openSessionFromConnection</span><span class=\"params\">(ExecutorType execType, Connection connection)</span> </span>&#123;</span><br><span class=\"line\">    DefaultSqlSession var8;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> autoCommit;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            autoCommit = connection.getAutoCommit();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SQLException var13) &#123;</span><br><span class=\"line\">            autoCommit = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Environment environment = <span class=\"keyword\">this</span>.configuration.getEnvironment();</span><br><span class=\"line\">        TransactionFactory transactionFactory = <span class=\"keyword\">this</span>.getTransactionFactoryFromEnvironment(environment);</span><br><span class=\"line\">        Transaction tx = transactionFactory.newTransaction(connection);</span><br><span class=\"line\">        Executor executor = <span class=\"keyword\">this</span>.configuration.newExecutor(tx, execType);</span><br><span class=\"line\">        var8 = <span class=\"keyword\">new</span> DefaultSqlSession(<span class=\"keyword\">this</span>.configuration, executor, autoCommit);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception var14) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> ExceptionFactory.wrapException(<span class=\"string\">&quot;Error opening session.  Cause: &quot;</span> + var14, var14);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        ErrorContext.instance().reset();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> var8;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"SqlSessionManager\"><a href=\"#SqlSessionManager\" class=\"headerlink\" title=\"SqlSessionManager\"></a>SqlSessionManager</h3><p>SqlSessionManager同时实现了SqlSessionFactory和SqlSession接口，也提供了SqlSessionFactory创建SqlSession对象以及SqlSession操作数据库的功能。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> SqlSessionFactory sqlSessionFactory;</span><br><span class=\"line\"><span class=\"comment\">// localSqlSession中记录的sqlSession对象的代理对象，SqlSessionManager初始化时会使用JDK动态代理的方式创建</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> SqlSession sqlSessionProxy;</span><br><span class=\"line\"><span class=\"comment\">// 记录当前一个与当前线程绑定的SqlSession对象</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ThreadLocal&lt;SqlSession&gt; localSqlSession = <span class=\"keyword\">new</span> ThreadLocal();</span><br></pre></td></tr></table></figure>\n\n<p>SqlSessionManager与DefaultSqlSessionFactory主要不同点是SqlSessionManager提供了两种模式：第一种模式和DefaultSqlSessionFactory的行为相同，同一个线程每次通过SqlSessionManager对象访问数据库时，都会创建新的DefaultSession对象完成数据库操作</p>\n<p>第二种模式是SqlSessionManager通过localSqlSession这个ThreadLocal变量，记录当前线程绑定的SqlSession对象，供当前线程循环使用，从而避免在同一个线程多次创建SqlSession对象带来的性能损失.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 通过构造函数可以看出，sqlSessionProxy是代理类，会执行SqlSessionManager.SqlSessionInterceptor中的方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">SqlSessionManager</span><span class=\"params\">(SqlSessionFactory sqlSessionFactory)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.sqlSessionFactory = sqlSessionFactory;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.sqlSessionProxy = (SqlSession)Proxy.newProxyInstance(SqlSessionFactory.class.getClassLoader(), <span class=\"keyword\">new</span> Class[]&#123;SqlSession.class&#125;, <span class=\"keyword\">new</span> SqlSessionManager.SqlSessionInterceptor());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SqlSessionInterceptor</span> <span class=\"keyword\">implements</span> <span class=\"title\">InvocationHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SqlSessionInterceptor</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        SqlSession sqlSession = (SqlSession)SqlSessionManager.<span class=\"keyword\">this</span>.localSqlSession.get();</span><br><span class=\"line\">          <span class=\"comment\">// 会使用第二种模式</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sqlSession != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> method.invoke(sqlSession, args);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable var19) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> ExceptionUtil.unwrapThrowable(var19);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;<span class=\"comment\">// 第一种模式</span></span><br><span class=\"line\">            SqlSession autoSqlSession = SqlSessionManager.<span class=\"keyword\">this</span>.openSession();</span><br><span class=\"line\">            Throwable var6 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            Object var8;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    Object result = method.invoke(autoSqlSession, args);</span><br><span class=\"line\">                    autoSqlSession.commit();</span><br><span class=\"line\">                    var8 = result;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Throwable var20) &#123;</span><br><span class=\"line\">                    autoSqlSession.rollback();</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> ExceptionUtil.unwrapThrowable(var20);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable var21) &#123;</span><br><span class=\"line\">                var6 = var21;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> var21;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (autoSqlSession != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (var6 != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                            autoSqlSession.close();</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">catch</span> (Throwable var18) &#123;</span><br><span class=\"line\">                            var6.addSuppressed(var18);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        autoSqlSession.close();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> var8;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis之Sql绑定","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B9%8BSql%E7%BB%91%E5%AE%9A/","content":"<h2 id=\"Sql绑定\"><a href=\"#Sql绑定\" class=\"headerlink\" title=\"Sql绑定\"></a>Sql绑定</h2><p>在mybatis中定义一个接口，然后在mapper.xml文件中编写一个sql语句，在执行该接口中方法的时候就会执行该sql语句，这是怎么做到的呢。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">UserMapper</span></span>&#123;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> User <span class=\"title\">getUser</span><span class=\"params\">(<span class=\"keyword\">int</span> i)</span></span>;<span class=\"comment\">// 在mapper.xml中写一个&lt;select&gt;标签，id为getUser</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"MapperRegistry\"><a href=\"#MapperRegistry\" class=\"headerlink\" title=\"MapperRegistry\"></a>MapperRegistry</h3><p>MapperRegistry类是Mapper接口及其对应的代理对象工厂的注册中心。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 全局配置</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Configuration config;</span><br><span class=\"line\"><span class=\"comment\">// 记录Mapper接口和代理工厂之间的关系</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class=\"keyword\">new</span> HashMap();</span><br></pre></td></tr></table></figure>\n\n<p>在mybatis初始化时读取配置文件以及Mapper接口的注解信息，调用MapperRegistry.addMapper()方法填充knownMappers。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> &lt;T&gt; <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">addMapper</span><span class=\"params\">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (type.isInterface()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasMapper(type)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BindingException(<span class=\"string\">&quot;Type &quot;</span> + type + <span class=\"string\">&quot; is already known to the MapperRegistry.&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">boolean</span> loadCompleted = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.knownMappers.put(type, <span class=\"keyword\">new</span> MapperProxyFactory(type));</span><br><span class=\"line\">                MapperAnnotationBuilder parser = <span class=\"keyword\">new</span> MapperAnnotationBuilder(<span class=\"keyword\">this</span>.config, type);</span><br><span class=\"line\">                parser.parse();</span><br><span class=\"line\">                loadCompleted = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!loadCompleted) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.knownMappers.remove(type);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>在需要执行某个SQL时，会先调用MapperRegistry.getMapper()方法获取实现Mapper接口的代理对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> &lt;T&gt; <span class=\"function\">T <span class=\"title\">getMapper</span><span class=\"params\">(Class&lt;T&gt; type, SqlSession sqlSession)</span> </span>&#123;</span><br><span class=\"line\">        MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory)<span class=\"keyword\">this</span>.knownMappers.get(type);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (mapperProxyFactory == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BindingException(<span class=\"string\">&quot;Type &quot;</span> + type + <span class=\"string\">&quot; is not known to the MapperRegistry.&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> mapperProxyFactory.newInstance(sqlSession);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception var5) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BindingException(<span class=\"string\">&quot;Error getting mapper instance. Cause: &quot;</span> + var5, var5);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"MapperProxyFactory\"><a href=\"#MapperProxyFactory\" class=\"headerlink\" title=\"MapperProxyFactory\"></a>MapperProxyFactory</h3><p>MapperProxyFactory负责创建代理对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 接口</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Class&lt;T&gt; mapperInterface;</span><br><span class=\"line\"><span class=\"comment\">// 缓存，key为mapperInterface接口中某方法所对应的Method对象，value是对应的代理</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;Method, MapperMethodInvoker&gt; methodCache = <span class=\"keyword\">new</span> ConcurrentHashMap();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        Method privateLookupIn;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">//java8的MethodHandles中没有privateLookupIn方法  privateLookupInMethod会是null</span></span><br><span class=\"line\">            privateLookupIn = MethodHandles.class.getMethod(&quot;privateLookupIn&quot;, Class.class, Lookup.class);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class=\"line\">            privateLookupIn = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        privateLookupInMethod = privateLookupIn;</span><br><span class=\"line\">        Constructor&lt;Lookup&gt; lookup = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (privateLookupInMethod == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                lookup = Lookup.class.getDeclaredConstructor(Class.class, Integer.TYPE);</span><br><span class=\"line\">                lookup.setAccessible(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException var3) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">&quot;There is neither &#x27;privateLookupIn(Class, Lookup)&#x27; nor &#x27;Lookup(Class, int)&#x27; method in java.lang.invoke.MethodHandles.&quot;</span>, var3);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception var4) &#123;</span><br><span class=\"line\">                lookup = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        lookupConstructor = lookup;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> T <span class=\"title\">newInstance</span><span class=\"params\">(MapperProxy&lt;T&gt; mapperProxy)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> Proxy.newProxyInstance(<span class=\"keyword\">this</span>.mapperInterface.getClassLoader(), <span class=\"keyword\">new</span> Class[]&#123;<span class=\"keyword\">this</span>.mapperInterface&#125;, mapperProxy);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> T <span class=\"title\">newInstance</span><span class=\"params\">(SqlSession sqlSession)</span> </span>&#123;</span><br><span class=\"line\">  MapperProxy&lt;T&gt; mapperProxy = <span class=\"keyword\">new</span> MapperProxy(sqlSession, <span class=\"keyword\">this</span>.mapperInterface, <span class=\"keyword\">this</span>.methodCache);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.newInstance(mapperProxy);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"MethodProxy\"><a href=\"#MethodProxy\" class=\"headerlink\" title=\"MethodProxy\"></a>MethodProxy</h3><p>实现了InvocationHandler接口，是接口的代理类，主要看invoke()方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Object.class.equals(method.getDeclaringClass()) ? method.invoke(<span class=\"keyword\">this</span>, args) : <span class=\"keyword\">this</span>.cachedInvoker(method).invoke(proxy, method, args, <span class=\"keyword\">this</span>.sqlSession);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Throwable var5) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> ExceptionUtil.unwrapThrowable(var5);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>invoke方法会调用cachedInvoker()方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> MapperProxy.<span class=\"function\">MapperMethodInvoker <span class=\"title\">cachedInvoker</span><span class=\"params\">(Method method)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            MapperProxy.MapperMethodInvoker invoker = (MapperProxy.MapperMethodInvoker)<span class=\"keyword\">this</span>.methodCache.get(method);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> invoker != <span class=\"keyword\">null</span> ? invoker : (MapperProxy.MapperMethodInvoker)<span class=\"keyword\">this</span>.methodCache.computeIfAbsent(method, (m) -&gt; &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 默认方法(Java8之后出的默认方法)</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (m.isDefault()) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> privateLookupInMethod == <span class=\"keyword\">null</span> ? <span class=\"keyword\">new</span> MapperProxy.DefaultMethodInvoker(<span class=\"keyword\">this</span>.getMethodHandleJava8(method)) : <span class=\"keyword\">new</span> MapperProxy.DefaultMethodInvoker(<span class=\"keyword\">this</span>.getMethodHandleJava9(method));</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">catch</span> (InstantiationException | InvocationTargetException | NoSuchMethodException | IllegalAccessException var4) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> RuntimeException(var4);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; </span><br><span class=\"line\">              <span class=\"comment\">// 普通的接口方法</span></span><br><span class=\"line\">              <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> MapperProxy.PlainMethodInvoker(<span class=\"keyword\">new</span> MapperMethod(<span class=\"keyword\">this</span>.mapperInterface, method, <span class=\"keyword\">this</span>.sqlSession.getConfiguration()));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (RuntimeException var4) &#123;</span><br><span class=\"line\">            Throwable cause = var4.getCause();</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> (Throwable)(cause == <span class=\"keyword\">null</span> ? var4 : cause);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>在这里只看执行普通方法的情况，所以需要看一下MapperProxy中的静态内部类PlainMethodInvoker</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//PlainMethodInvoker只是对于MethodHandle进行了一下包装，真正使用的还是MethodHandle对象</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PlainMethodInvoker</span> <span class=\"keyword\">implements</span> <span class=\"title\">MapperProxy</span>.<span class=\"title\">MapperMethodInvoker</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MapperMethod mapperMethod;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PlainMethodInvoker</span><span class=\"params\">(MapperMethod mapperMethod)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.mapperMethod = mapperMethod;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object proxy, Method method, Object[] args, SqlSession sqlSession)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.mapperMethod.execute(sqlSession, args);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"MapperMethod\"><a href=\"#MapperMethod\" class=\"headerlink\" title=\"MapperMethod\"></a>MapperMethod</h3><p>MapperMethod中封装了Mapper接口对应的方法的信息，以及对应SQL语句的信息</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 记录了SQL语句的名称和类型</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MapperMethod.SqlCommand command;</span><br><span class=\"line\"><span class=\"comment\">// 记录了Mapper接口中对应方法的相关信息</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MapperMethod.MethodSignature method;</span><br></pre></td></tr></table></figure>\n\n<p>SqlCommandType记录了SQL语句的类型</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">enum</span> SqlCommandType &#123;</span><br><span class=\"line\">    UNKNOWN,</span><br><span class=\"line\">    INSERT,</span><br><span class=\"line\">    UPDATE,</span><br><span class=\"line\">    DELETE,</span><br><span class=\"line\">    SELECT,</span><br><span class=\"line\">    FLUSH;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">SqlCommandType</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>根据PlainMethodInvoker中invoke方法发现，调用的是MapperMethodexecute方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">execute</span><span class=\"params\">(SqlSession sqlSession, Object[] args)</span> </span>&#123;</span><br><span class=\"line\">        Object result;</span><br><span class=\"line\">        Object param;</span><br><span class=\"line\">              <span class=\"comment\">// 根据SQL类型调用不同的sqlsession的方法</span></span><br><span class=\"line\">        <span class=\"keyword\">switch</span>(<span class=\"keyword\">this</span>.command.getType()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> INSERT:</span><br><span class=\"line\">            <span class=\"comment\">// 使用ParamNameResolver处理参数列表，将实参与指定参数名对应起来</span></span><br><span class=\"line\">            param = <span class=\"keyword\">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class=\"line\">            <span class=\"comment\">// rowCountResult会根据method字段记录的方法的返回值类型对结果进行转换</span></span><br><span class=\"line\">            result = <span class=\"keyword\">this</span>.rowCountResult(sqlSession.insert(<span class=\"keyword\">this</span>.command.getName(), param));</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> UPDATE:</span><br><span class=\"line\">            param = <span class=\"keyword\">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class=\"line\">            result = <span class=\"keyword\">this</span>.rowCountResult(sqlSession.update(<span class=\"keyword\">this</span>.command.getName(), param));</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> DELETE:</span><br><span class=\"line\">            param = <span class=\"keyword\">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class=\"line\">            result = <span class=\"keyword\">this</span>.rowCountResult(sqlSession.delete(<span class=\"keyword\">this</span>.command.getName(), param));</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> SELECT:</span><br><span class=\"line\">            <span class=\"comment\">// 处理返回值为void且ResultSet通过ResultHandler处理的方法</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.method.returnsVoid() &amp;&amp; <span class=\"keyword\">this</span>.method.hasResultHandler()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.executeWithResultHandler(sqlSession, args);</span><br><span class=\"line\">                result = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            &#125; </span><br><span class=\"line\">            <span class=\"comment\">// 处理返回值为集合的方法</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.method.returnsMany()) &#123;</span><br><span class=\"line\">                result = <span class=\"keyword\">this</span>.executeForMany(sqlSession, args);</span><br><span class=\"line\">            &#125; </span><br><span class=\"line\">            <span class=\"comment\">// 处理返回值为map的方法</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.method.returnsMap()) &#123;</span><br><span class=\"line\">                result = <span class=\"keyword\">this</span>.executeForMap(sqlSession, args);</span><br><span class=\"line\">            &#125; </span><br><span class=\"line\">            <span class=\"comment\">// 处理返回值为Cursor的方法</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.method.returnsCursor()) &#123;</span><br><span class=\"line\">                result = <span class=\"keyword\">this</span>.executeForCursor(sqlSession, args);</span><br><span class=\"line\">            &#125; </span><br><span class=\"line\">            <span class=\"comment\">// 处理返回值为单一对象的方法</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                param = <span class=\"keyword\">this</span>.method.convertArgsToSqlCommandParam(args);</span><br><span class=\"line\">                result = sqlSession.selectOne(<span class=\"keyword\">this</span>.command.getName(), param);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.method.returnsOptional() &amp;&amp; (result == <span class=\"keyword\">null</span> || !<span class=\"keyword\">this</span>.method.getReturnType().equals(result.getClass()))) &#123;</span><br><span class=\"line\">                    result = Optional.ofNullable(result);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> FLUSH:</span><br><span class=\"line\">            result = sqlSession.flushStatements();</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BindingException(<span class=\"string\">&quot;Unknown execution method for: &quot;</span> + <span class=\"keyword\">this</span>.command.getName());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (result == <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.method.getReturnType().isPrimitive() &amp;&amp; !<span class=\"keyword\">this</span>.method.returnsVoid()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BindingException(<span class=\"string\">&quot;Mapper method &#x27;&quot;</span> + <span class=\"keyword\">this</span>.command.getName() + <span class=\"string\">&quot; attempted to return null from a method with a primitive return type (&quot;</span> + <span class=\"keyword\">this</span>.method.getReturnType() + <span class=\"string\">&quot;).&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis之别名设置","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B9%8B%E5%88%AB%E5%90%8D%E8%AE%BE%E7%BD%AE/","content":"<h2 id=\"别名设置\"><a href=\"#别名设置\" class=\"headerlink\" title=\"别名设置\"></a>别名设置</h2><p>在写SQL语句或者在写结果集时，会遇到表名、列名、类的全名太长的情况，Mybatis专门提供了一个标签来设置别名<typeAliases></typeAliases></p>\n<a id=\"more\"></a>\n\n<p>示例：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">typeAliases</span>&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- 批量为实体类添加别名  指定包名 Mybatis之后会自动为该包下的类设置别名 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">package</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;com.example.mybatis&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 设置别名之前使用实体类的示例 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;baseResult&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.example.mybatis.User&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">association</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;role&quot;</span> <span class=\"attr\">javaType</span>=<span class=\"string\">&quot;com.example.mybatis.Role&quot;</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">association</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 设置别名之后使用实体类的示例 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">resultMap</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;baseResult1&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;user&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">association</span> <span class=\"attr\">property</span>=<span class=\"string\">&quot;role&quot;</span> <span class=\"attr\">javaType</span>=<span class=\"string\">&quot;role&quot;</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">association</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">resultMap</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p> 当然别名也可以单个设置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">typeAliases</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">typeAlias</span> <span class=\"attr\">alias</span>=<span class=\"string\">&quot;user&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.example.mybatis.User&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">typeAlias</span> <span class=\"attr\">alias</span>=<span class=\"string\">&quot;role&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.example.mybatis.Role&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>也可以使用注解进行配置别名</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Alias(&quot;user&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">User</span></span>&#123;</span><br><span class=\"line\">  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"TypeAliasRegistry\"><a href=\"#TypeAliasRegistry\" class=\"headerlink\" title=\"TypeAliasRegistry\"></a>TypeAliasRegistry</h3><p>上面讲述了别名的用处以及配置，Mybatis怎么管理的别名呢？</p>\n<p>使用的TypeAliasRegistry来进行注册和管理的</p>\n<p>首先对于一些基本的类型，Mybatis已经默认设置了别名了</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TypeAliasRegistry</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;string&quot;</span>, String.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;byte&quot;</span>, Byte.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;long&quot;</span>, Long.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;short&quot;</span>, Short.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;int&quot;</span>, Integer.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;integer&quot;</span>, Integer.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;double&quot;</span>, Double.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;float&quot;</span>, Float.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;boolean&quot;</span>, Boolean.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;byte[]&quot;</span>, Byte[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;long[]&quot;</span>, Long[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;short[]&quot;</span>, Short[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;int[]&quot;</span>, Integer[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;integer[]&quot;</span>, Integer[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;double[]&quot;</span>, Double[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;float[]&quot;</span>, Float[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;boolean[]&quot;</span>, Boolean[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_byte&quot;</span>, Byte.TYPE);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_long&quot;</span>, Long.TYPE);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_short&quot;</span>, Short.TYPE);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_int&quot;</span>, Integer.TYPE);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_integer&quot;</span>, Integer.TYPE);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_double&quot;</span>, Double.TYPE);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_float&quot;</span>, Float.TYPE);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_boolean&quot;</span>, Boolean.TYPE);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_byte[]&quot;</span>, <span class=\"keyword\">byte</span>[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_long[]&quot;</span>, <span class=\"keyword\">long</span>[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_short[]&quot;</span>, <span class=\"keyword\">short</span>[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_int[]&quot;</span>, <span class=\"keyword\">int</span>[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_integer[]&quot;</span>, <span class=\"keyword\">int</span>[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_double[]&quot;</span>, <span class=\"keyword\">double</span>[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_float[]&quot;</span>, <span class=\"keyword\">float</span>[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;_boolean[]&quot;</span>, <span class=\"keyword\">boolean</span>[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;date&quot;</span>, Date.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;decimal&quot;</span>, BigDecimal.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;bigdecimal&quot;</span>, BigDecimal.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;biginteger&quot;</span>, BigInteger.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;object&quot;</span>, Object.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;date[]&quot;</span>, Date[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;decimal[]&quot;</span>, BigDecimal[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;bigdecimal[]&quot;</span>, BigDecimal[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;biginteger[]&quot;</span>, BigInteger[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;object[]&quot;</span>, Object[].class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;map&quot;</span>, Map.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;hashmap&quot;</span>, HashMap.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;list&quot;</span>, List.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;arraylist&quot;</span>, ArrayList.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;collection&quot;</span>, Collection.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;iterator&quot;</span>, Iterator.class);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerAlias(<span class=\"string\">&quot;ResultSet&quot;</span>, ResultSet.class);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>TypeAliasRegistry中包含了对别名的注册和解析</p>\n<h4 id=\"别名注册\"><a href=\"#别名注册\" class=\"headerlink\" title=\"别名注册\"></a>别名注册</h4><p>对于别名注册的方法为registerAliases,有几个重载方法</p>\n<p><strong>注意：在注册的时候，其实存到map中的key全都是小写的</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//整个包进行别名设置  会扫描包下的所有类</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">registerAliases</span><span class=\"params\">(String packageName)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.registerAliases(packageName, Object.class);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//整个包进行别名设置  会扫描包下的所有类</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">registerAliases</span><span class=\"params\">(String packageName, Class&lt;?&gt; superType)</span> </span>&#123;</span><br><span class=\"line\">  ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = <span class=\"keyword\">new</span> ResolverUtil();</span><br><span class=\"line\">  <span class=\"comment\">// 查找指定包下的superType类型的类</span></span><br><span class=\"line\">  resolverUtil.find(<span class=\"keyword\">new</span> IsA(superType), packageName);</span><br><span class=\"line\">  Set&lt;Class&lt;? extends Class&lt;?&gt;&gt;&gt; typeSet = resolverUtil.getClasses();</span><br><span class=\"line\">  Iterator var5 = typeSet.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">while</span>(var5.hasNext()) &#123;</span><br><span class=\"line\">    Class&lt;?&gt; type = (Class)var5.next();</span><br><span class=\"line\">    <span class=\"comment\">// 过滤掉内部类、接口和抽象类</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !type.isMemberClass()) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.registerAlias(type);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 使用@Alias注解设置别名的方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">registerAlias</span><span class=\"params\">(Class&lt;?&gt; type)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 根据代码可以看到，在不给出确定的别名时，mybatis给的默认别名都是类名</span></span><br><span class=\"line\">  String alias = type.getSimpleName();</span><br><span class=\"line\">  Alias aliasAnnotation = (Alias)type.getAnnotation(Alias.class);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (aliasAnnotation != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    alias = aliasAnnotation.value();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.registerAlias(alias, type);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">registerAlias</span><span class=\"params\">(String alias, Class&lt;?&gt; value)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (alias == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> TypeException(<span class=\"string\">&quot;The parameter alias cannot be null&quot;</span>);</span><br><span class=\"line\">  &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 别名转换为小写</span></span><br><span class=\"line\">    String key = alias.toLowerCase(Locale.ENGLISH);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.typeAliases.containsKey(key) &amp;&amp; <span class=\"keyword\">this</span>.typeAliases.get(key) != <span class=\"keyword\">null</span> &amp;&amp; !((Class)<span class=\"keyword\">this</span>.typeAliases.get(key)).equals(value)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> TypeException(<span class=\"string\">&quot;The alias &#x27;&quot;</span> + alias + <span class=\"string\">&quot;&#x27; is already mapped to the value &#x27;&quot;</span> + ((Class)<span class=\"keyword\">this</span>.typeAliases.get(key)).getName() + <span class=\"string\">&quot;&#x27;.&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.typeAliases.put(key, value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">registerAlias</span><span class=\"params\">(String alias, String value)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.registerAlias(alias, Resources.classForName(value));</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException var4) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> TypeException(<span class=\"string\">&quot;Error registering type alias &quot;</span> + alias + <span class=\"string\">&quot; for &quot;</span> + value + <span class=\"string\">&quot;. Cause: &quot;</span> + var4, var4);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"别名解析\"><a href=\"#别名解析\" class=\"headerlink\" title=\"别名解析\"></a>别名解析</h4><p>别名解析的方法为resolveAlias</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> &lt;T&gt; <span class=\"function\">Class&lt;T&gt; <span class=\"title\">resolveAlias</span><span class=\"params\">(String string)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (string == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 这个对照着别名注册时  也是将key值设定为小写的</span></span><br><span class=\"line\">                String key = string.toLowerCase(Locale.ENGLISH);</span><br><span class=\"line\">                Class value;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.typeAliases.containsKey(key)) &#123;</span><br><span class=\"line\">                    value = (Class)<span class=\"keyword\">this</span>.typeAliases.get(key);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    value = Resources.classForName(string);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException var4) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> TypeException(<span class=\"string\">&quot;Could not resolve type alias &#x27;&quot;</span> + string + <span class=\"string\">&quot;&#x27;.  Cause: &quot;</span> + var4, var4);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis之类型转换","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B9%8B%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2/","content":"<h2 id=\"类型转换\"><a href=\"#类型转换\" class=\"headerlink\" title=\"类型转换\"></a>类型转换</h2><p>JDBC的数据类型和Java的数据类型不完全对应，所以在PreparedStatement为SQL语句绑定参数时，需要从Java类型转成JDBC类型，从结果集获取到数据要把JDBC的类型转换成Java的类型，mybatis使用的是TypeHandler类型处理器来完成这两种转换的。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"TypeHandler\"><a href=\"#TypeHandler\" class=\"headerlink\" title=\"TypeHandler\"></a>TypeHandler</h3><p>Mybatis中所有的类型转换器都实现了TypeHandler接口，该接口中定义了四个方法，分为两类setParameter和getResult</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">TypeHandler</span>&lt;<span class=\"title\">T</span>&gt; </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 通过PreparedStatement为SQL语句绑定参数时，会将数据由Java类型转换为JdbcType类型</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setParameter</span><span class=\"params\">(PreparedStatement var1, <span class=\"keyword\">int</span> var2, T var3, JdbcType var4)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 从ResultSet中获取时调用该方法，会将数据由JdbcType类型转换为Java类型</span></span><br><span class=\"line\">    <span class=\"function\">T <span class=\"title\">getResult</span><span class=\"params\">(ResultSet var1, String var2)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">T <span class=\"title\">getResult</span><span class=\"params\">(ResultSet var1, <span class=\"keyword\">int</span> var2)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">T <span class=\"title\">getResult</span><span class=\"params\">(CallableStatement var1, <span class=\"keyword\">int</span> var2)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Mybatis提供了BaseTypeHandler抽象类，在实现自定义的TypeHandler时，只需要去继承BaseTypeHandler即可，该抽象类实现了TypeHandler接口，继承了TypeReference抽象类。</p>\n<p>BaseTypeHandler已经实现了setParameter和getResult方法，需要实现以下四个方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">void</span> <span class=\"title\">setNonNullParameter</span><span class=\"params\">(PreparedStatement var1, <span class=\"keyword\">int</span> var2, T var3, JdbcType var4)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> T <span class=\"title\">getNullableResult</span><span class=\"params\">(ResultSet var1, String var2)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> T <span class=\"title\">getNullableResult</span><span class=\"params\">(ResultSet var1, <span class=\"keyword\">int</span> var2)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> T <span class=\"title\">getNullableResult</span><span class=\"params\">(CallableStatement var1, <span class=\"keyword\">int</span> var2)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br></pre></td></tr></table></figure>\n\n<p>以DateTypeHandler为例，看一下实现</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DateTypeHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseTypeHandler</span>&lt;<span class=\"title\">Date</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DateTypeHandler</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setNonNullParameter</span><span class=\"params\">(PreparedStatement ps, <span class=\"keyword\">int</span> i, Date parameter, JdbcType jdbcType)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        ps.setTimestamp(i, <span class=\"keyword\">new</span> Timestamp(parameter.getTime()));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Date <span class=\"title\">getNullableResult</span><span class=\"params\">(ResultSet rs, String columnName)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Timestamp sqlTimestamp = rs.getTimestamp(columnName);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> sqlTimestamp != <span class=\"keyword\">null</span> ? <span class=\"keyword\">new</span> Date(sqlTimestamp.getTime()) : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Date <span class=\"title\">getNullableResult</span><span class=\"params\">(ResultSet rs, <span class=\"keyword\">int</span> columnIndex)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Timestamp sqlTimestamp = rs.getTimestamp(columnIndex);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> sqlTimestamp != <span class=\"keyword\">null</span> ? <span class=\"keyword\">new</span> Date(sqlTimestamp.getTime()) : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Date <span class=\"title\">getNullableResult</span><span class=\"params\">(CallableStatement cs, <span class=\"keyword\">int</span> columnIndex)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Timestamp sqlTimestamp = cs.getTimestamp(columnIndex);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> sqlTimestamp != <span class=\"keyword\">null</span> ? <span class=\"keyword\">new</span> Date(sqlTimestamp.getTime()) : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"TypeHandlerRegistry\"><a href=\"#TypeHandlerRegistry\" class=\"headerlink\" title=\"TypeHandlerRegistry\"></a>TypeHandlerRegistry</h3><p>Mybatis使用TypeHandlerRegistry来管理TypeHandler接口实现，在Mybatis初始化过程中，将TypeHandler接口实现注册到TypeHandlerRegistry中。</p>\n<p>在mybatis-config.xml可以配置<typeHandlers>标签加上自定义的标签</typeHandlers></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- mybatis-config.xml --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">typeHandlers</span>&gt;</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 如果配置package的时候，mybatis会去配置的package扫描TypeHandler --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">package</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">package</span>&gt;</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- 这个应该会走TypeHandlerRegistry的register(TypeHandler&lt;T&gt; typeHandler)方法  大概流程是先去找该类有没有配置MappedTypes注解,如果配置了就会去找该注解中配置的javaType   当然如果没有配置的话，且你的自定义TypeHandler继承了TypeReference  就会指定javaType为这类所对应的泛型 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">typeHandler</span> <span class=\"attr\">handler</span>=<span class=\"string\">&quot;org.mybatis.example.ExampleTypeHandler&quot;</span>/&gt;</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- javaType 配置java类型，例如String, 如果配上javaType, 那么指定的typeHandler就只作用于指定的类型  注解使用MappedTypes来指定javaType--&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">typeHandler</span> <span class=\"attr\">javaType</span>=<span class=\"string\">&quot;&quot;</span> <span class=\"attr\">handler</span>=<span class=\"string\">&quot;org.mybatis.example.ExampleTypeHandler&quot;</span>/&gt;</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- jdbcType 配置数据库基本数据类型，例如varchar, 如果配上jdbcType, 那么指定的typeHandler就只作用于指定的类型  注解使用MappedJdbcTypes来指定所对应的 jdbcType--&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">typeHandler</span> <span class=\"attr\">jdbcType</span>=<span class=\"string\">&quot;&quot;</span> <span class=\"attr\">handler</span>=<span class=\"string\">&quot;org.mybatis.example.ExampleTypeHandler&quot;</span>/&gt;</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">typeHandler</span> <span class=\"attr\">javaType</span>=<span class=\"string\">&quot;&quot;</span> <span class=\"attr\">jdbcType</span>=<span class=\"string\">&quot;&quot;</span> <span class=\"attr\">handler</span>=<span class=\"string\">&quot;org.mybatis.example.ExampleTypeHandler&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">typeHandlers</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis拦截器","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E6%8B%A6%E6%88%AA%E5%99%A8/","content":"<h2 id=\"mybatis拦截器\"><a href=\"#mybatis拦截器\" class=\"headerlink\" title=\"mybatis拦截器\"></a>mybatis拦截器</h2><p>mybatis允许用户自定义拦截器对SQL语句执行过程中的某一个点进行拦截。默认mybatis允许拦截Executor中的方法、ParameterHandler的方法、ResultSetHandler的方法以及StatementHandler中的方法</p>\n<a id=\"more\"></a>\n\n<ul>\n<li><p>Executor中的update()、query()、flushStatements()、commit()、rollback()、getTransaction()、close()、isClose()方法</p>\n</li>\n<li><p>ParameterHandler中的getParameterObject()、setParameters()方法</p>\n</li>\n<li><p>ResultSetHandler中的handlerResultSets()、handlerOutputParameters()方法</p>\n</li>\n<li><p>StatementHandler中的prepare()、parameterize()、batch()、update()、query()方法</p>\n</li>\n</ul>\n<p>mybatis使用拦截器需要实现Interceptor接口</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Interceptor</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 执行拦截逻辑的方法</span></span><br><span class=\"line\">    <span class=\"function\">Object <span class=\"title\">intercept</span><span class=\"params\">(Invocation var1)</span> <span class=\"keyword\">throws</span> Throwable</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 包装目标对象，为目标对象创建代理对象</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">default</span> Object <span class=\"title\">plugin</span><span class=\"params\">(Object target)</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 使用当前拦截器来包装目标对象</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> Plugin.wrap(target, <span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 根据配置初始化Interceptor对象</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">default</span> <span class=\"keyword\">void</span> <span class=\"title\">setProperties</span><span class=\"params\">(Properties properties)</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>用户自定义的拦截器除了继承Interceptor接口，还需要使用@Intercepts和@Signature注解进行标识</p>\n<p>@Intercepts注解中指定了一个@Signature注解列表</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> Intercepts &#123;</span><br><span class=\"line\">    Signature[] value();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>每个@Signature注解中标识了该插件需要拦截的方法信息</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;&#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> Signature &#123;</span><br><span class=\"line\">      <span class=\"comment\">//拦截的类型</span></span><br><span class=\"line\">    Class&lt;?&gt; type();</span><br><span class=\"line\">        <span class=\"comment\">//拦截的方法</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">method</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">        <span class=\"comment\">//被拦截方法的参数列表</span></span><br><span class=\"line\">    Class&lt;?&gt;[] args();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"restTemplate解析401异常失败","url":"/2020/%E6%A1%86%E6%9E%B6/spring/restTemplate/restTemplate%E8%A7%A3%E6%9E%90401%E5%BC%82%E5%B8%B8%E5%A4%B1%E8%B4%A5/","content":"<h2 id=\"restTemplate解析401异常失败\"><a href=\"#restTemplate解析401异常失败\" class=\"headerlink\" title=\"restTemplate解析401异常失败\"></a>restTemplate解析401异常失败</h2><p>如果使用restTemplate默认构造器的话，在进行错误解析的时候，使用</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (response.getStatusCode().isError()) &#123; <span class=\"comment\">// 4XX或者5XX</span></span><br><span class=\"line\">        InputStream inputStream = response.getBody();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 此时这个response是SimpleClientHttpResponse</span></span><br><span class=\"line\"><span class=\"comment\">// 此方法为SimpleClientHttpResponse的getBody()方法</span></span><br><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> InputStream <span class=\"title\">getBody</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 在这一行取出的errorStream是null  这个connection使用的是private final HttpURLConnection connection;</span></span><br><span class=\"line\">        InputStream errorStream = <span class=\"keyword\">this</span>.connection.getErrorStream();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.responseStream = (errorStream != <span class=\"keyword\">null</span> ? errorStream : <span class=\"keyword\">this</span>.connection.getInputStream());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.responseStream;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>这时候需要在创建restTemplate的时候更改requestFactory，使用HttpComponentsClientHttpRequestFactory</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">RestTemplate restTemplate = <span class=\"keyword\">new</span> RestTemplate(<span class=\"keyword\">new</span> HttpComponentsClientHttpRequestFactory());</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n","categories":["restTemplate"],"tags":["restTemplate"]},{"title":"MySQL主从复制","url":"/2020/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/","content":"<h2 id=\"MySQL主从复制\"><a href=\"#MySQL主从复制\" class=\"headerlink\" title=\"MySQL主从复制\"></a>MySQL主从复制</h2><p>MySQL支持单向、异步复制，复制过程中一个服务器充当主服务器，另外一个或多个其它服务器充当从服务器。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"基本原理\"><a href=\"#基本原理\" class=\"headerlink\" title=\"基本原理\"></a>基本原理</h3><p>MySQL复制是基于主服务器在二进制日志中跟踪所有对数据库的更改。因此，要进行复制，必须在主服务器上启用二进制日志。每个从服务器从主服务器接收主服务器已经记录到日志中的数据。</p>\n<p>当一个从服务器连接主服务器时，它通知主服务器从服务器日志上读取最后一次成功更新的位置。从服务器接收那时起发生的任何更新，并在本机上执行相同的更新。然后封锁并等待主服务器通知新的更新。从服务器执行备份并不干扰主服务器，灾备份过程中主服务器可以继续处理更新。</p>\n<h3 id=\"过程\"><a href=\"#过程\" class=\"headerlink\" title=\"过程\"></a>过程</h3><ul>\n<li>master将改变记录到bin log中，这些记录过程叫做二进制日志事件，binary log events</li>\n<li>slave将master的bin log拷贝到它的中继日志(relay log)</li>\n<li>slave重做中继日志中的事件，将改变应用到自己的数据库中，MySQL的复制是异步且串行化的</li>\n</ul>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL体系结构","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/MySQL%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/","content":"<h2 id=\"MySQL体系结构\"><a href=\"#MySQL体系结构\" class=\"headerlink\" title=\"MySQL体系结构\"></a>MySQL体系结构</h2><p>MySQL总体结构分为四层</p>\n<p><img src=\"/images/MySQL/%E6%80%BB%E4%BD%93%E7%BB%93%E6%9E%84.png\" alt=\"总体结构\"></p>\n<a id=\"more\"></a> \n\n<figure class=\"highlight routeros\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.Connectors</span><br><span class=\"line\">指的是不同语言中与SQL的交互。</span><br><span class=\"line\">2.Management Serveices &amp; Utilities：</span><br><span class=\"line\">系统管理和控制工具</span><br><span class=\"line\">3.<span class=\"built_in\"> Connection </span>Pool: 连接池</span><br><span class=\"line\"></span><br><span class=\"line\"> 管理缓冲用户连接，线程处理等需要缓存的需求。 </span><br><span class=\"line\"></span><br><span class=\"line\"> 负责监听对 MySQL<span class=\"built_in\"> Server </span>的各种请求，接收连接请求，转发所有连接请求到线程管理模块。每一个连接上 MySQL<span class=\"built_in\"> Server </span>的客户端请求都会被分配（或创建）一个连接线程为其单独服务。而连接线程的主要工作就是负责 MySQL<span class=\"built_in\"> Server </span>与客户端的通信，</span><br><span class=\"line\"></span><br><span class=\"line\"> 接受客户端的命令请求，传递<span class=\"built_in\"> Server </span>端的结果信息等。线程管理模块则负责管理维护这些连接线程。包括线程的创建，线程的 cache 等。</span><br><span class=\"line\">4.SQL Interface: SQL接口。</span><br><span class=\"line\">接受用户的SQL命令，并且返回用户需要查询的结果。比如select <span class=\"keyword\">from</span>就是调用SQL Interface。</span><br><span class=\"line\">5 Parser: 解析器。</span><br><span class=\"line\">SQL命令传递到解析器的时候会被解析器验证和解析。解析器是由Lex和YACC实现的，是一个很长的脚本。</span><br><span class=\"line\"></span><br><span class=\"line\">在 MySQL中我们习惯将所有<span class=\"built_in\"> Client </span>端发送给<span class=\"built_in\"> Server </span>端的命令都称为 query ，在 MySQL<span class=\"built_in\"> Server </span>里面，连接线程接收到客户端的一个 Query 后，会直接将该 query 传递给专门负责将各种 Query 进行分类然后转发给各个对应的处理模块。</span><br><span class=\"line\">主要功能：</span><br><span class=\"line\">a . 将SQL语句进行语义和语法的分析，分解成数据结构，然后按照不同的操作类型进行分类，然后做出针对性的转发到后续步骤，以后SQL语句的传递和处理就是基于这个结构的。</span><br><span class=\"line\">b.  如果在分解构成中遇到错误，那么就说明这个sql语句是不合理的</span><br><span class=\"line\">6 Optimizer: 查询优化器。</span><br><span class=\"line\">SQL语句在查询之前会使用查询优化器对查询进行优化。就是优化客户端请求的 query（sql语句） ，根据客户端请求的 query 语句，和数据库中的一些统计信息，在一系列算法的基础上进行分析，得出一个最优的策略，告诉后面的程序如何取得这个 query 语句的结果</span><br><span class=\"line\"></span><br><span class=\"line\">他使用的是“选取-投影-联接”策略进行查询。</span><br><span class=\"line\">       用一个例子就可以理解： select uid,name <span class=\"keyword\">from</span><span class=\"built_in\"> user </span>where gender = 1;</span><br><span class=\"line\">       这个select 查询先根据where 语句进行选取，而不是先将表全部查询出来以后再进行gender过滤</span><br><span class=\"line\">       这个select查询先根据uid和name进行属性投影，而不是将属性全部取出以后再进行过滤</span><br><span class=\"line\">       将这两个查询条件联接起来生成最终查询结果</span><br><span class=\"line\">7 Cache和Buffer： 查询缓存。</span><br><span class=\"line\"></span><br><span class=\"line\">他的主要功能是将客户端提交 给MySQL 的 Select 类 query 请求的返回结果集 cache 到内存中，与该 query 的一个 hash 值 做</span><br><span class=\"line\">一个对应。该 Query 所取数据的基表发生任何数据的变化之后， MySQL 会自动使该 query 的Cache 失效。在读写比例非常高的应用系统中， Query Cache 对性能的提高是非常显著的。当然它对内存的消耗也是非常大的。</span><br><span class=\"line\">如果查询缓存有命中的查询结果，查询语句就可以直接去查询缓存中取数据。这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key缓存，权限缓存等</span><br><span class=\"line\">8 、存储引擎接口</span><br><span class=\"line\">存储引擎接口模块可以说是 MySQL 数据库中最有特色的一点了。目前各种数据库产品中，基本上只有 MySQL 可以实现其底层数据存储引擎的插件式管理。这个模块实际上只是 一个抽象类，但正是因为它成功地将各种数据处理高度抽象化，才成就了今天 MySQL 可插拔存储引擎的特色。</span><br><span class=\"line\">     从图2还可以看出，MySQL区别于其他数据库的最重要的特点就是其插件式的表存储引擎。MySQL插件式的存储引擎架构提供了一系列标准的管理和服务支持，这些标准与存储引擎本身无关，</span><br><span class=\"line\">　　　可能是每个数据库系统本身都必需的，如SQL分析器和优化器等，而存储引擎是底层物理结构的实现，每个存储引擎开发者都可以按照自己的意愿来进行开发。</span><br><span class=\"line\">注意：存储引擎是基于表的，而不是数据库。</span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li>连接层</li>\n<li>服务层</li>\n<li>存储引擎层</li>\n<li>存储层</li>\n</ul>\n<p><img src=\"/images/MySQL/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84%E5%9B%BE.png\" alt=\"体系结构图\"></p>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL的数据文件","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/MySQL%E7%9A%84%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6/","content":"<h2 id=\"MySQL的数据文件\"><a href=\"#MySQL的数据文件\" class=\"headerlink\" title=\"MySQL的数据文件\"></a>MySQL的数据文件</h2><p>mysql的数据都存放在datadir所指的位置，其中包含了mysql中创建的数据库，数据库中包含了表结构(frm文件)、表数据(myd文件)、表索引(myi文件)</p>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL存储引擎","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/MySQL%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/","content":"<h2 id=\"MySQL存储引擎\"><a href=\"#MySQL存储引擎\" class=\"headerlink\" title=\"MySQL存储引擎\"></a>MySQL存储引擎</h2><p>MySQL虽然有很多存储引擎，但是使用最多的还是Innodb和MyISAM这两种存储引擎</p>\n<p>所以先看一下这两种搜索引擎的区别</p>\n<table>\n<thead>\n<tr>\n<th>对比</th>\n<th>MyISAM</th>\n<th>Innodb</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>主外键</td>\n<td>不支持</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>事务</td>\n<td>不支持</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>行表锁</td>\n<td>表锁，不适合高并发</td>\n<td>行锁，适合高并发</td>\n</tr>\n<tr>\n<td>缓存</td>\n<td>只缓存索引，不缓存数据</td>\n<td>既缓存索引，又缓存数据，对内存要求较高</td>\n</tr>\n<tr>\n<td>表空间</td>\n<td>小</td>\n<td>大</td>\n</tr>\n<tr>\n<td>关注点</td>\n<td>性能</td>\n<td>事务</td>\n</tr>\n</tbody></table>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL索引","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/MySQL%E7%B4%A2%E5%BC%95/","content":"<h2 id=\"MySQL索引\"><a href=\"#MySQL索引\" class=\"headerlink\" title=\"MySQL索引\"></a>MySQL索引</h2><p>索引就是用来帮助mysql快速查找数据的数据结构，这种数据结构以某种方式指向数据，以此种数据结构的基础上实现高级的查找算法，就可以快速的查找数据</p>\n<blockquote>\n<p>MySQL默认使用的是B树索引</p>\n</blockquote>\n<a id=\"more\"></a>\n\n<h3 id=\"索引分类\"><a href=\"#索引分类\" class=\"headerlink\" title=\"索引分类\"></a>索引分类</h3><ul>\n<li>单值索引    一个索引只包含单个列</li>\n<li>唯一索引   索引列的值必须唯一，可以为空值</li>\n<li>复合索引   一个索引包含多个列</li>\n</ul>\n<h3 id=\"索引语法\"><a href=\"#索引语法\" class=\"headerlink\" title=\"索引语法\"></a>索引语法</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">// 创建索引</span><br><span class=\"line\"><span class=\"keyword\">create</span> [<span class=\"keyword\">unique</span>] <span class=\"keyword\">index</span> 索引名 <span class=\"keyword\">on</span> 表名(列名);</span><br><span class=\"line\"><span class=\"keyword\">alter</span> 表名 <span class=\"keyword\">add</span> [<span class=\"keyword\">unique</span>] <span class=\"keyword\">index</span> 索引名 <span class=\"keyword\">on</span> 列名;</span><br><span class=\"line\">// 删除索引</span><br><span class=\"line\"><span class=\"keyword\">drop</span> <span class=\"keyword\">index</span> 索引名 <span class=\"keyword\">on</span> 表名;</span><br><span class=\"line\">// 查看索引</span><br><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">index</span> <span class=\"keyword\">from</span> 表名;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"索引结构\"><a href=\"#索引结构\" class=\"headerlink\" title=\"索引结构\"></a>索引结构</h3><p>MySQL有四种结构的索引，分别为BTREE索引、hash索引、full-text全文索引、R-Tree索引</p>\n<h4 id=\"BTREE索引\"><a href=\"#BTREE索引\" class=\"headerlink\" title=\"BTREE索引\"></a>BTREE索引</h4><h3 id=\"索引的条件\"><a href=\"#索引的条件\" class=\"headerlink\" title=\"索引的条件\"></a>索引的条件</h3><h4 id=\"什么时候适合创建索引\"><a href=\"#什么时候适合创建索引\" class=\"headerlink\" title=\"什么时候适合创建索引\"></a>什么时候适合创建索引</h4><ul>\n<li>主键自动创建主键索引</li>\n<li>频繁作为查询条件的字段适合创建索引</li>\n<li>外键关系创建索引</li>\n<li>用来排序的字段创建索引可以提高排序速度</li>\n<li>查询中统计或分组的字段可以用索引来提升速度</li>\n</ul>\n<h4 id=\"什么时候不适合创建索引\"><a href=\"#什么时候不适合创建索引\" class=\"headerlink\" title=\"什么时候不适合创建索引\"></a>什么时候不适合创建索引</h4><ul>\n<li>频繁更新的字段不适合创建索引</li>\n<li>不会用来做查询条件的字段不适合创建索引</li>\n<li>表记录少不需要创建索引</li>\n<li>字段值为常数且大多重复平均分配的列不需要创建索引</li>\n</ul>\n<h3 id=\"索引失效\"><a href=\"#索引失效\" class=\"headerlink\" title=\"索引失效\"></a>索引失效</h3><ul>\n<li><p>建立复合索引，在查询时要复合最佳前缀法则，即按照建立的复合索引顺序进行查询，否则会造成索引失效</p>\n<p><img src=\"/images/MySQL/%E7%B4%A2%E5%BC%95/%E5%A4%8D%E5%90%88%E7%B4%A2%E5%BC%95.png\" alt=\"复合索引\"></p>\n<p>在使用该索引查询时，要按照顺序，如果查询条件中没有使用class_id则该索引不会生效，而且在使用class_id时最好不好跳过name直接使用age条件</p>\n</li>\n<li><p>在索引列上进行计算、函数、自动或手动类型抓换也会造成索引失效</p>\n</li>\n<li><p>使用范围查询匹配右边列会导致索引失效</p>\n<p><img src=\"/images/MySQL/%E7%B4%A2%E5%BC%95/%E8%8C%83%E5%9B%B4%E6%9F%A5%E6%89%BE.png\" alt=\"范围查找\"></p>\n<p>class_id使用大于进行范围匹配，使得class_id的索引变成了排序而非检索，使得name的索引失效</p>\n</li>\n<li><p>尽量使用覆盖索引</p>\n</li>\n<li><p>使用!=或者&lt;&gt;会导致索引失效，全表扫描</p>\n<p><img src=\"/images/MySQL/%E7%B4%A2%E5%BC%95/%E4%B8%8D%E7%AD%89%E4%BA%8E.png\" alt=\"不等于\"></p>\n</li>\n<li><p>使用is null 或者is not null会导致索引失效</p>\n</li>\n<li><p>like以%前缀开头会导致索引失效（如果一定要用%%来进行匹配，可以使用覆盖索引）</p>\n<p><img src=\"/images/MySQL/%E7%B4%A2%E5%BC%95/like%E6%9F%A5%E8%AF%A2.png\" alt=\"like查询\"></p>\n<blockquote>\n<p>注意：如果%在右边，该复合索引中使用like的字段后的索引列也可以生效</p>\n<p><img src=\"/images/MySQL/%E7%B4%A2%E5%BC%95/like%E5%8F%B3%E6%A8%A1%E7%B3%8A.png\" alt=\"like右模糊\"></p>\n<p>此时age索引列也生效了</p>\n</blockquote>\n</li>\n<li><p>字符串不加单引号索引会失效</p>\n<p><img src=\"/images/MySQL/%E7%B4%A2%E5%BC%95/%E7%B1%BB%E5%9E%8B%E8%BD%AC%E5%8C%96.png\" alt=\"类型转化\"></p>\n</li>\n<li><p>使用or连接条件会导致索引失效</p>\n<p><img src=\"/images/MySQL/%E7%B4%A2%E5%BC%95/or%E8%BF%9E%E6%8E%A5.png\" alt=\"or连接\"></p>\n</li>\n</ul>\n<h3 id=\"优缺点\"><a href=\"#优缺点\" class=\"headerlink\" title=\"优缺点\"></a>优缺点</h3><h4 id=\"优点\"><a href=\"#优点\" class=\"headerlink\" title=\"优点\"></a>优点</h4><ul>\n<li>提高了检索效率，降低了数据库的IO成本</li>\n<li>降低了数据排序的成本，降低了CPU消耗</li>\n</ul>\n<h4 id=\"缺点\"><a href=\"#缺点\" class=\"headerlink\" title=\"缺点\"></a>缺点</h4><ul>\n<li>索引保存了主键和索引字段，并指向实体表记录，所以索引列是占用磁盘空间的</li>\n<li>索引虽然提高了查询速度，但是会降低更新表的速度，在进行增删改的时候，不仅要对数据进行修改，还是对索引文件进行修改</li>\n</ul>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"MySQL锁机制","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/MySQL%E9%94%81%E6%9C%BA%E5%88%B6/","content":"<h2 id=\"MySQL锁机制\"><a href=\"#MySQL锁机制\" class=\"headerlink\" title=\"MySQL锁机制\"></a>MySQL锁机制</h2><p>MySQL包含表锁、行锁和页锁</p>\n<h3 id=\"表锁-偏读\"><a href=\"#表锁-偏读\" class=\"headerlink\" title=\"表锁(偏读)\"></a>表锁(偏读)</h3><p>表锁偏向于MyISAM存储引擎，开销小，加锁快；无死锁；锁的粒度大，并发小</p>\n<a id=\"more\"></a>\n\n<p><strong>为表加锁</strong></p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 为user表加上读锁，good表加上写锁</span></span><br><span class=\"line\"><span class=\"keyword\">lock</span> <span class=\"keyword\">table</span> <span class=\"keyword\">user</span> <span class=\"keyword\">read</span>,good write;</span><br></pre></td></tr></table></figure>\n\n<p><strong>解锁</strong></p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">unlock</span> <span class=\"keyword\">tables</span>;</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看当前哪些表在使用中</strong></p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">open</span> <span class=\"keyword\">tables</span>;</span><br><span class=\"line\">+<span class=\"comment\">--------------------+------------------------------------------------------+--------+-------------+</span></span><br><span class=\"line\">| Database           | Table                                                | In_use | Name_locked |</span><br></pre></td></tr></table></figure>\n\n<p><strong>分析表锁定</strong></p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"> <span class=\"keyword\">show</span> <span class=\"keyword\">status</span> <span class=\"keyword\">like</span> <span class=\"string\">&#x27;table_lock%&#x27;</span>;</span><br><span class=\"line\">+<span class=\"comment\">-----------------------+-------+</span></span><br><span class=\"line\">| Variable_name         | Value |</span><br><span class=\"line\">+<span class=\"comment\">-----------------------+-------+</span></span><br><span class=\"line\">| Table_locks_immediate | 122   |</span><br><span class=\"line\">| Table_locks_waited    | 0     |</span><br><span class=\"line\">+<span class=\"comment\">-----------------------+-------+</span></span><br><span class=\"line\"></span><br><span class=\"line\">Table_locks_immediate  产生表级锁的次数</span><br><span class=\"line\">Table_locks_waited  出现由于表级锁导致等待的次数</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"读锁\"><a href=\"#读锁\" class=\"headerlink\" title=\"读锁\"></a>读锁</h4><p>如果在整张表上加了读锁，当前会话不可以修改该表数据，不可以查询/修改其他表数据，只能读取该表数据；其他会话可以查询该表数据，可以查询/修改其他表数据，但是如果修改该表数据，会进行阻塞，直到解锁为止</p>\n<h4 id=\"写锁\"><a href=\"#写锁\" class=\"headerlink\" title=\"写锁\"></a>写锁</h4><p>如果在整张表加了写锁，当前会话可以查询/修改该表数据，但是不可以对其他表进行操作；其他会话在对该表进行查询/修改时会进行阻塞，直到解锁为止，可以查询/修改其他表</p>\n<h3 id=\"行锁-偏写\"><a href=\"#行锁-偏写\" class=\"headerlink\" title=\"行锁(偏写)\"></a>行锁(偏写)</h3><p>偏向于Innodb存储引擎，开销大，加锁慢；会出现死锁；锁粒度小，并发高</p>\n<p><strong>分析行锁</strong></p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">status</span> <span class=\"keyword\">like</span> <span class=\"string\">&#x27;innodb_row_lock%&#x27;</span>;</span><br><span class=\"line\">+<span class=\"comment\">-------------------------------+-------+</span></span><br><span class=\"line\">| Variable_name                 | Value |</span><br><span class=\"line\">+<span class=\"comment\">-------------------------------+-------+</span></span><br><span class=\"line\">| Innodb_row_lock_current_waits | 0     |</span><br><span class=\"line\">| Innodb_row_lock_time          | 0     |</span><br><span class=\"line\">| Innodb_row_lock_time_avg      | 0     |</span><br><span class=\"line\">| Innodb_row_lock_time_max      | 0     |</span><br><span class=\"line\">| Innodb_row_lock_waits         | 0     |</span><br><span class=\"line\">+<span class=\"comment\">-------------------------------+-------+</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Innodb_row_lock_current_waits  当前正在等待锁定的数量</span><br><span class=\"line\">Innodb_row_lock_time      锁定的总时间总时间长度</span><br><span class=\"line\">Innodb_row_lock_time_avg  每次等待所花平均长度</span><br><span class=\"line\">Innodb_row_lock_time_max  等待的最长时间</span><br><span class=\"line\">Innodb_row_lock_waits     等待的次数</span><br></pre></td></tr></table></figure>\n\n\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"SQL优化","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/SQL%E4%BC%98%E5%8C%96/","content":"<h2 id=\"SQL优化\"><a href=\"#SQL优化\" class=\"headerlink\" title=\"SQL优化\"></a>SQL优化</h2><p>SQL的优化并不是一开始就进行优化的，而是需要先进行观察的，所以SQL优化的步骤应该是这样的</p>\n<h3 id=\"步骤\"><a href=\"#步骤\" class=\"headerlink\" title=\"步骤\"></a>步骤</h3><ul>\n<li>慢查询的开启与捕获</li>\n<li>explain+慢SQL分析</li>\n<li>show profile查询SQL在MySQL服务器里的执行细节和生命周期情况</li>\n<li>进行MySQL的参数调整优化</li>\n</ul>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"in和exists的取舍","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/in%E5%92%8Cexists%E7%9A%84%E5%8F%96%E8%88%8D/","content":"<h2 id=\"in和exists的取舍\"><a href=\"#in和exists的取舍\" class=\"headerlink\" title=\"in和exists的取舍\"></a>in和exists的取舍</h2><p>之前说过要小表驱动大表，即先遍历小表再遍历大表，接下来看一下in和exists的区别</p>\n<h3 id=\"in\"><a href=\"#in\" class=\"headerlink\" title=\"in\"></a>in</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> A <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> <span class=\"keyword\">in</span> (<span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> B)</span><br><span class=\"line\"></span><br><span class=\"line\">等价于==</span><br><span class=\"line\">先遍历表B <span class=\"keyword\">select</span> <span class=\"keyword\">id</span> <span class=\"keyword\">from</span> B</span><br><span class=\"line\">再遍历表A <span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> A <span class=\"keyword\">where</span> A.id = B.id</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"exists\"><a href=\"#exists\" class=\"headerlink\" title=\"exists\"></a>exists</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> A <span class=\"keyword\">where</span> <span class=\"keyword\">id</span> <span class=\"keyword\">exists</span> (<span class=\"keyword\">select</span> <span class=\"number\">1</span> <span class=\"keyword\">from</span> A.id = B.id)</span><br><span class=\"line\"></span><br><span class=\"line\">等价于</span><br><span class=\"line\">先遍历表A  <span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> A</span><br><span class=\"line\">再遍历表B  <span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> B <span class=\"keyword\">where</span> A.id = B.id</span><br></pre></td></tr></table></figure>\n\n<p>将主查询数据放到子查询中做验证，根据验证结果来确定主查询结果的去留</p>\n<h3 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h3><p>根据执行顺序也就得知了什么时候该用in什么时候该用exists了</p>\n<p>即</p>\n<p>当表A数据集大于表B数据集时，使用in；当表B数据集大于表A数据集时，用exists</p>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"show profile调优","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/show%20profile%E8%B0%83%E4%BC%98/","content":"<h2 id=\"show-profile调优\"><a href=\"#show-profile调优\" class=\"headerlink\" title=\"show profile调优\"></a>show profile调优</h2><p>show profile是mysql提供的可以用来分析当前会话中语句执行的资源消耗情况，可以用于SQL调优的测量</p>\n<p>默认情况下是关闭的</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like &#x27;%profiling%&#x27;;</span><br><span class=\"line\">+<span class=\"comment\">------------------------+-------+</span></span><br><span class=\"line\">| Variable_name          | Value |</span><br><span class=\"line\">+<span class=\"comment\">------------------------+-------+</span></span><br><span class=\"line\">| have_profiling         | YES   |</span><br><span class=\"line\">| profiling              | OFF   |</span><br><span class=\"line\">| profiling_history_size | 15    |</span><br><span class=\"line\">+<span class=\"comment\">------------------------+-------+</span></span><br><span class=\"line\"></span><br><span class=\"line\">have_profiling  表示当前mysql版本支持<span class=\"keyword\">show</span> profile功能</span><br><span class=\"line\">profiling  表示当前功能是否开启</span><br><span class=\"line\">profiling_history_size  表示可以保留的历史数量(<span class=\"keyword\">sql</span>条数)</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>开启show profile</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">set</span> profiling = <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n\n<p>查看历史sql记录</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- 由于上边的配置是15，所以最多显示最近15条记录</span></span><br><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">profiles</span>;</span><br></pre></td></tr></table></figure>\n\n<p>根据query_id来分析该条sql的性能问题</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> profile cpu,<span class=\"keyword\">block</span> io <span class=\"keyword\">for</span> <span class=\"keyword\">query</span> <span class=\"number\">18</span>;</span><br><span class=\"line\">+<span class=\"comment\">----------------------+----------+----------+------------+--------------+---------------+</span></span><br><span class=\"line\">| Status               | Duration | CPU_user | CPU_system | Block_ops_in | Block_ops_out |</span><br><span class=\"line\">+<span class=\"comment\">----------------------+----------+----------+------------+--------------+---------------+</span></span><br><span class=\"line\">| starting             | 0.000084 | 0.000067 |   0.000013 |            0 |             0 |</span><br><span class=\"line\">| checking permissions | 0.000014 | 0.000008 |   0.000005 |            0 |             0 |</span><br><span class=\"line\">| Opening tables       | 0.000039 | 0.000036 |   0.000003 |            0 |             0 |</span><br><span class=\"line\">| init                 | 0.000017 | 0.000015 |   0.000002 |            0 |             0 |</span><br><span class=\"line\">| System <span class=\"keyword\">lock</span>          | <span class=\"number\">0.000009</span> | <span class=\"number\">0.000008</span> |   <span class=\"number\">0.000001</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">| optimizing           | <span class=\"number\">0.000004</span> | <span class=\"number\">0.000003</span> |   <span class=\"number\">0.000001</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">| <span class=\"keyword\">statistics</span>           | <span class=\"number\">0.000011</span> | <span class=\"number\">0.000010</span> |   <span class=\"number\">0.000001</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">| preparing            | <span class=\"number\">0.000009</span> | <span class=\"number\">0.000008</span> |   <span class=\"number\">0.000001</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">| executing            | <span class=\"number\">0.000003</span> | <span class=\"number\">0.000002</span> |   <span class=\"number\">0.000001</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">| Sending <span class=\"keyword\">data</span>         | <span class=\"number\">0.000039</span> | <span class=\"number\">0.000037</span> |   <span class=\"number\">0.000001</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">| <span class=\"keyword\">end</span>                  | <span class=\"number\">0.000004</span> | <span class=\"number\">0.000003</span> |   <span class=\"number\">0.000002</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">| <span class=\"keyword\">query</span> <span class=\"keyword\">end</span>            | <span class=\"number\">0.000007</span> | <span class=\"number\">0.000006</span> |   <span class=\"number\">0.000001</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">| closing <span class=\"keyword\">tables</span>       | <span class=\"number\">0.000008</span> | <span class=\"number\">0.000007</span> |   <span class=\"number\">0.000001</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">| freeing items        | <span class=\"number\">0.000016</span> | <span class=\"number\">0.000007</span> |   <span class=\"number\">0.000009</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">| cleaning up          | <span class=\"number\">0.000015</span> | <span class=\"number\">0.000013</span> |   <span class=\"number\">0.000001</span> |            <span class=\"number\">0</span> |             <span class=\"number\">0</span> |</span><br><span class=\"line\">+<span class=\"comment\">----------------------+----------+----------+------------+--------------+---------------+</span></span><br></pre></td></tr></table></figure>\n\n<p>该查询展示出了这条sql完整的执行生命周期</p>\n<blockquote>\n<p>可以查询的类型有</p>\n<ul>\n<li>all   显示所有开销</li>\n<li>block io 显示块io开销</li>\n<li>cpu  显示cpu开销</li>\n<li>context switches  上下文切换开销</li>\n<li>ipc  发送和接收相关开销</li>\n<li>memory  内存开销</li>\n<li>page faults   页面错误相关开销</li>\n<li>source  显示Source_function、Source_file、Source_line相关开销</li>\n<li>swaps   交换次数相关开销</li>\n</ul>\n</blockquote>\n<p><strong>如何判断哪些是出现问题的？</strong></p>\n<p>如果在执行过程中存在以下情况，则需要进行优化</p>\n<ul>\n<li>converting HEAP to MyISAM  查询结果太大，内存不够用了，开始使用磁盘</li>\n<li>create tmp table  创建临时表</li>\n<li>Copying to tmp table on disk 将内存中的临时表复制到磁盘</li>\n<li>locked </li>\n</ul>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"优化建议","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE/","content":"<h2 id=\"优化建议\"><a href=\"#优化建议\" class=\"headerlink\" title=\"优化建议\"></a>优化建议</h2><h3 id=\"join语句优化\"><a href=\"#join语句优化\" class=\"headerlink\" title=\"join语句优化\"></a>join语句优化</h3><ul>\n<li>使用小表驱动大表，减少join语句的nestedLoop的循环总数</li>\n<li>优先优化内层循环</li>\n<li>保证join语句中被驱动表上的join条件已被索引</li>\n</ul>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"慢查询日志","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97/","content":"<h2 id=\"慢查询日志\"><a href=\"#慢查询日志\" class=\"headerlink\" title=\"慢查询日志\"></a>慢查询日志</h2><p>MySQL的慢查询日志是用来记录MySQL响应时间超过阈值的语句，即为超过long_query_time值得sql语句</p>\n<p>默认没有开启慢查询(如果开启慢查询会导致性能降低)</p>\n<p>查看是否开启慢查询</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">variables</span> <span class=\"keyword\">like</span> <span class=\"string\">&#x27;%slow_query_log%&#x27;</span>;</span><br></pre></td></tr></table></figure>\n\n<p>开启慢查询</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#只对当前数据库生效，如果重启则失效</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> <span class=\"keyword\">global</span> slow_query_log = <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n\n<p>如果需要永久生效，在需要在my.cnf配置文件中配置</p>\n<p>在[mysqld]下添加slow_query_log和slow_query_log_file参数，然后重启服务器即可</p>\n<a id=\"more\"></a>\n\n<p>查询慢查询阈值</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">variables</span> <span class=\"keyword\">like</span> <span class=\"string\">&#x27;%long_query_time%&#x27;</span>;</span><br></pre></td></tr></table></figure>\n\n<p>查看有多少条慢查询</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">global</span> <span class=\"keyword\">status</span>  <span class=\"keyword\">like</span> <span class=\"string\">&#x27;%Slow_queries%&#x27;</span>;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"日志分析工具\"><a href=\"#日志分析工具\" class=\"headerlink\" title=\"日志分析工具\"></a>日志分析工具</h3><p>可以使用mysqldumpslow来进行日志分析</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysqldumpslow [ OPTS... ] [ LOGS... ] </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">-----------------------------</span></span><br><span class=\"line\">参数</span><br><span class=\"line\">-s  按照何种方式排序</span><br><span class=\"line\">            c  访问次数</span><br><span class=\"line\">            l  锁定时间</span><br><span class=\"line\">            r  返回记录</span><br><span class=\"line\">            t  查询时间</span><br><span class=\"line\">            al 平均锁定时间</span><br><span class=\"line\">            ar 平均返回记录数</span><br><span class=\"line\">            at 平均查询时间</span><br><span class=\"line\">-t  返回前面多少条的数据</span><br><span class=\"line\">-g  正则</span><br></pre></td></tr></table></figure>\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"执行计划","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/","content":"<h2 id=\"执行计划\"><a href=\"#执行计划\" class=\"headerlink\" title=\"执行计划\"></a>执行计划</h2><p>如果不知道执行计划，那就不可能进行SQL优化，那么执行计划是什么呢？</p>\n<p>使用explain关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理你的SQL的，进而分析性能瓶颈</p>\n<p>用起来其实很简单，使用explain + sql语句即可</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">explain</span> <span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> <span class=\"keyword\">user</span>;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<p>重点是如何分析结果</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |</span><br></pre></td></tr></table></figure>\n\n<p>这写就是所打印出来的字段，接下里就一个个地分析一下是什么意思</p>\n<h3 id=\"id字段\"><a href=\"#id字段\" class=\"headerlink\" title=\"id字段\"></a>id字段</h3><p>表示的含义：select查询的序号，表示查询中执行select子句或者操作表的顺序</p>\n<p>id有三种情况</p>\n<p><strong>第一种情况：id相同</strong></p>\n<p><img src=\"/images/MySQL/%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/id%E7%9B%B8%E5%90%8C.png\" alt=\"id相同\"></p>\n<p>id相同的情况下，是按照table的顺序从上到下开始操作的</p>\n<p><strong>第二种情况：id不同</strong></p>\n<p><img src=\"/images/MySQL/%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/id%E4%B8%8D%E5%90%8C.png\" alt=\"id不同\"></p>\n<p>id不同的情况下，**<em>id越大优先级越高，id大的先被执行**</em></p>\n<p><strong>第三种情况：id相同和不同</strong></p>\n<p><img src=\"/images/MySQL/%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92/id%E7%9B%B8%E5%90%8C%E4%B8%8D%E5%90%8C.png\" alt=\"id相同不同\"></p>\n<p>先执行id大的，id相同的顺序执行 </p>\n<h3 id=\"select-type字段\"><a href=\"#select-type字段\" class=\"headerlink\" title=\"select_type字段\"></a>select_type字段</h3><p>该字段来表示查询类型，用于区分普通查询、联合查询、子查询等复杂查询常用的有六种</p>\n<ul>\n<li>SIMPLE          简单查询，不包含子查询和联合查询</li>\n<li>PRIMARY        如果包含子查询，该类型表示最外层查询</li>\n<li>SUBQUERY    如果包含子查询，该类型表示内层查询</li>\n<li>DERIVED        如果在from列表中包含了子查询会被标记为DERIVED，mysql会递归执行这些子查询，并将结果放在临时表中</li>\n<li>UNION           联合查询如果用来关联两个select的话为UNION，如果UNION包含在from子句中，则外层select为DERIVED</li>\n<li>UNION RESULT   从UNION表获取结果的select</li>\n</ul>\n<h3 id=\"table字段\"><a href=\"#table字段\" class=\"headerlink\" title=\"table字段\"></a>table字段</h3><p>显示数据是哪张表的</p>\n<h3 id=\"type字段\"><a href=\"#type字段\" class=\"headerlink\" title=\"type字段\"></a>type字段</h3><p>检索的类型</p>\n<p>从最好到最差依次为</p>\n<p>system&gt;const&gt;eq_ref&gt;ref&gt;range&gt;index&gt;ALL</p>\n<blockquote>\n<p>至少要达到range级别，最好能是ref</p>\n</blockquote>\n<ul>\n<li>system  表中只有一行数据</li>\n<li>const 通过一次索引就可以找到(如使用主键查询或unique索引)</li>\n<li>eq_ref   唯一性索引扫描，对于每个索引键，表中只有一条与之匹配(如使用主键或者unique索引)</li>\n<li>ref        非唯一性索引扫描，匹配返回某个单独值得所有行</li>\n<li>range   检索指定范围的数据，使用索引，where语句中使用between…and、in、&lt;、&gt;等</li>\n<li>index   full index scan，全索引扫描，与all相比，index只遍历索引树</li>\n<li>all    全表扫描</li>\n</ul>\n<h3 id=\"possible-keys字段\"><a href=\"#possible-keys字段\" class=\"headerlink\" title=\"possible_keys字段\"></a>possible_keys字段</h3><p>查询使用的条件可能涉及到多个字段，所对应的多个索引，但是实际不一定会使用到所列出来的索引</p>\n<h3 id=\"key字段\"><a href=\"#key字段\" class=\"headerlink\" title=\"key字段\"></a>key字段</h3><p>查询实际使用到的索引</p>\n<h3 id=\"key-len字段\"><a href=\"#key-len字段\" class=\"headerlink\" title=\"key_len字段\"></a>key_len字段</h3><p>索引中使用的字节数，在不损失精度的情况下，长度越短越好(为索引值的最大可能长度，并非索引实际长度，是根据表结构计算得出，而非数据)</p>\n<h3 id=\"ref字段\"><a href=\"#ref字段\" class=\"headerlink\" title=\"ref字段\"></a>ref字段</h3><p>显示索引的哪一列被使用了</p>\n<h3 id=\"rows字段\"><a href=\"#rows字段\" class=\"headerlink\" title=\"rows字段\"></a>rows字段</h3><p>估算出找到需要的数据需要读取的行数</p>\n<h3 id=\"extra字段\"><a href=\"#extra字段\" class=\"headerlink\" title=\"extra字段\"></a>extra字段</h3><p>表示一些额外信息</p>\n<ul>\n<li>using filesort   文件排序，mysql无法利用索引来完成的排序，则使用文件排序(出现此种情况，最好进行优化)</li>\n<li>using temporary  使用了临时表保存中间结果，常见于排序和分组查询(出现此种情况，尽快优化，速度极慢)，使用group by分组查询时，最好按照索引顺序来进行分组</li>\n<li>using index  表示相应的select行使用了覆盖索引(覆盖索引为查询结果为索引列，不必读取数据行)，防止访问数据行，速度提升</li>\n<li>using where  表示使用索引进行检索</li>\n<li>using join buffer  使用join缓存</li>\n<li>impossible where   where条件总是false，无法查到数据</li>\n</ul>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"排序优化","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/%E6%8E%92%E5%BA%8F%E4%BC%98%E5%8C%96/","content":"<h2 id=\"排序优化\"><a href=\"#排序优化\" class=\"headerlink\" title=\"排序优化\"></a>排序优化</h2><p>对于order by关键字进行优化前，首先大家要先知道索引不仅用于检索还用于排序</p>\n<p>MySQL支持两种方式的排序，index和filesort，index效率高，可以根据索引本身来完成排序，filesort效率较低</p>\n<blockquote>\n<p>最好在进行explain进行分析时不要出现filesort</p>\n</blockquote>\n<h3 id=\"使用index的条件\"><a href=\"#使用index的条件\" class=\"headerlink\" title=\"使用index的条件\"></a>使用index的条件</h3><ul>\n<li>order by 语句使用索引最左前列</li>\n<li>使用where 子句和order by子句组合满足索引最左前列</li>\n</ul>\n<blockquote>\n<p>如果使用多字段排序，需要保证排序方向一致，要么就全是ASC要么就全是DESC</p>\n</blockquote>\n<a id=\"more\"></a>\n\n<h3 id=\"使用filesort\"><a href=\"#使用filesort\" class=\"headerlink\" title=\"使用filesort\"></a>使用filesort</h3><p>如果逼不得已使用filesort，MySQL中filesort有两种算法，双路排序和单路排序</p>\n<h4 id=\"双路排序\"><a href=\"#双路排序\" class=\"headerlink\" title=\"双路排序\"></a>双路排序</h4><p>4.1之前使用的是双路排序，即需要扫描两次磁盘，读取行指针和order by列，对他们进行排序，然后扫描已经排好序的列表，按照列表中的值重新从列表中读取对应的数据输出</p>\n<h4 id=\"单路排序\"><a href=\"#单路排序\" class=\"headerlink\" title=\"单路排序\"></a>单路排序</h4><p>4.1之后出现单路排序，从磁盘中查询所有列，按照order by列在buffer进行排序，然后扫描排序后的列表进行输出</p>\n<p>使用单路排序需要保证buffer足够大，因为要把数据放到内存，如果buffer不够大，会导致单路排序变成多路排序</p>\n<blockquote>\n<p>这个buffer在配置文件中为sort_buffer_size配置</p>\n</blockquote>\n<p>当query的字段大小总和小于max_length_for_sort_data且字段中不包含text或者blob类型时，会使用单路排序</p>\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"查看MySql操作日志","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/%E8%BF%9B%E9%98%B6/%E6%9F%A5%E7%9C%8BMySql%E6%93%8D%E4%BD%9C%E6%97%A5%E5%BF%97/","content":"<h2 id=\"查看MySql操作日志\"><a href=\"#查看MySql操作日志\" class=\"headerlink\" title=\"查看MySql操作日志\"></a>查看MySql操作日志</h2><p>今天在排查问题的时候发现数据对不上，怀疑是有些数据被人误删了，那如何知道是否该数据被人删除了呢</p>\n<p>先看一下日志是否开始了</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">variables</span> <span class=\"keyword\">like</span> <span class=\"string\">&#x27;log_bin&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>发现是ON，开启了</p>\n<p>看一下当前记录在哪个日志中了</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">show</span> <span class=\"keyword\">master</span> <span class=\"keyword\">status</span></span><br></pre></td></tr></table></figure>\n\n<p>找到文件位置之后查看日志</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysqlbinlog mysql-bin.000329</span><br></pre></td></tr></table></figure>\n\n","categories":["MySQL"],"tags":["MySQL"]},{"title":"HashMap详解","url":"/2020/java%E5%9F%BA%E7%A1%80/%E9%9B%86%E5%90%88/HashMap%E8%AF%A6%E8%A7%A3/","content":"<h2 id=\"HashMap详解\"><a href=\"#HashMap详解\" class=\"headerlink\" title=\"HashMap详解\"></a>HashMap详解</h2><h3 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h3><p>HashMap是在项目中使用的最多的Map，实现了Map接口，继承AbstractMap。基于哈希表的Map接口实现，不包含重复的键，一个键对应一个值，在HashMap存储的时候会将key、value作为一个整体Entry进行存储。</p>\n<p>HashMap中会根据hash算法来计算key所对应的存储位置。</p>\n<a id=\"more\"></a>\n\n<h3 id=\"继承关系\"><a href=\"#继承关系\" class=\"headerlink\" title=\"继承关系\"></a>继承关系</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">HashMap</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; <span class=\"keyword\">extends</span> <span class=\"title\">AbstractMap</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt;</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"keyword\">implements</span> <span class=\"title\">Map</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt;, <span class=\"title\">Cloneable</span>, <span class=\"title\">Serializable</span></span></span><br></pre></td></tr></table></figure>\n\n<img src=\"/images/java基础/HashMap/HashMap.png\" alt=\"HashMap\" style=\"zoom:33%;\">\n\n<h3 id=\"数据结构\"><a href=\"#数据结构\" class=\"headerlink\" title=\"数据结构\"></a>数据结构</h3><p><strong>数组+链表+红黑树</strong></p>\n<p>默认采用数组+链表的方式存储元素，当元素出现哈希冲突时，HashMap使用链地址法来解决hash冲突，会存储在该位置的链表中。当链表中元素个数超过8个时，会尝试将链表转为红黑树存储。但是在转换前，会判断一次当前数组的长度，当数组长度大于64时才会处理，否则进行扩容操作</p>\n<h3 id=\"源码解析\"><a href=\"#源码解析\" class=\"headerlink\" title=\"源码解析\"></a>源码解析</h3><h4 id=\"重要参数\"><a href=\"#重要参数\" class=\"headerlink\" title=\"重要参数\"></a>重要参数</h4><p>初始大小和加载因子</p>\n<ul>\n<li><p>初始大小用来规定哈希表数组的长度</p>\n</li>\n<li><p>加载因子用来表示哈希表元素的填满程度，加载因子越大哈希表的空间利用率越高，但是哈希冲突的几率也会越大</p>\n</li>\n</ul>\n<h4 id=\"静态常量\"><a href=\"#静态常量\" class=\"headerlink\" title=\"静态常量\"></a>静态常量</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 默认初始容量16，必须为2的次幂</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> DEFAULT_INITIAL_CAPACITY = <span class=\"number\">1</span> &lt;&lt; <span class=\"number\">4</span>; <span class=\"comment\">// aka 16</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 最大容量  最大为1&lt;&lt;30 即2^30</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> MAXIMUM_CAPACITY = <span class=\"number\">1</span> &lt;&lt; <span class=\"number\">30</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 默认加载因子  0.75</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">float</span> DEFAULT_LOAD_FACTOR = <span class=\"number\">0.75f</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* hash冲突链表节点个数大于8时，会转化为红黑树</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> TREEIFY_THRESHOLD = <span class=\"number\">8</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* hash冲突时，当红黑树存储中节点少于6时,则转化为单链表存储</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> UNTREEIFY_THRESHOLD = <span class=\"number\">6</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 链表转为红黑树的最小表容量，如果没有达到该容量，将进行扩容</span></span><br><span class=\"line\"><span class=\"comment\">* 该值设置至小为4*TREEIFY_THRESHOLD</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> MIN_TREEIFY_CAPACITY = <span class=\"number\">64</span>;</span><br></pre></td></tr></table></figure>\n\n<p><strong><em>为什么容量一定要是2次幂</em></strong></p>\n<p>在计算数组下标时使用的是(n - 1) &amp; hash来计算的，当n为2次幂时，n-1的低位将全是1，哈希值进行与操作时保证低位不变，最终得到的index结果，完全取决于key的hashCode的最后几位，从而保证分布均匀，效果等同于取模，且性能比取模高。</p>\n<h4 id=\"Node\"><a href=\"#Node\" class=\"headerlink\" title=\"Node\"></a>Node</h4><p>HashMap中的元素都存储在Node数组中，看一下Node的结构</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Node</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; <span class=\"keyword\">implements</span> <span class=\"title\">Map</span>.<span class=\"title\">Entry</span>&lt;<span class=\"title\">K</span>,<span class=\"title\">V</span>&gt; </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 该Node节点的hash值</span></span><br><span class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> hash;</span><br><span class=\"line\">    <span class=\"keyword\">final</span> K key;</span><br><span class=\"line\">    V value;</span><br><span class=\"line\">      <span class=\"comment\">// 链表的下一个节点</span></span><br><span class=\"line\">    Node&lt;K,V&gt; next;</span><br><span class=\"line\"></span><br><span class=\"line\">    Node(<span class=\"keyword\">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.hash = hash;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.key = key;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.value = value;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.next = next;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> K <span class=\"title\">getKey</span><span class=\"params\">()</span>        </span>&#123; <span class=\"keyword\">return</span> key; &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> V <span class=\"title\">getValue</span><span class=\"params\">()</span>      </span>&#123; <span class=\"keyword\">return</span> value; &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> String <span class=\"title\">toString</span><span class=\"params\">()</span> </span>&#123; <span class=\"keyword\">return</span> key + <span class=\"string\">&quot;=&quot;</span> + value; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Objects.hashCode(key) ^ Objects.hashCode(value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> V <span class=\"title\">setValue</span><span class=\"params\">(V newValue)</span> </span>&#123;</span><br><span class=\"line\">        V oldValue = value;</span><br><span class=\"line\">        value = newValue;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (o == <span class=\"keyword\">this</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (o <span class=\"keyword\">instanceof</span> Map.Entry) &#123;</span><br><span class=\"line\">            Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;)o;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (Objects.equals(key, e.getKey()) &amp;&amp;</span><br><span class=\"line\">                Objects.equals(value, e.getValue()))</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<img src=\"/images/java基础/HashMap/Node.png\" alt=\"Node\" style=\"zoom:50%;\">\n\n<p>如果是链表，则使用的是Node存储(单向链表)；如果是红黑树，则使用的是TreeNode</p>\n<h4 id=\"构造函数\"><a href=\"#构造函数\" class=\"headerlink\" title=\"构造函数\"></a>构造函数</h4><h5 id=\"无参构造函数\"><a href=\"#无参构造函数\" class=\"headerlink\" title=\"无参构造函数\"></a>无参构造函数</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HashMap</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class=\"comment\">// all other fields defaulted</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"指定初始容量\"><a href=\"#指定初始容量\" class=\"headerlink\" title=\"指定初始容量\"></a>指定初始容量</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HashMap</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"指定初始容量和加载因子\"><a href=\"#指定初始容量和加载因子\" class=\"headerlink\" title=\"指定初始容量和加载因子\"></a>指定初始容量和加载因子</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HashMap</span><span class=\"params\">(<span class=\"keyword\">int</span> initialCapacity, <span class=\"keyword\">float</span> loadFactor)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (initialCapacity &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Illegal initial capacity: &quot;</span> +</span><br><span class=\"line\">                                       initialCapacity);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class=\"line\">    initialCapacity = MAXIMUM_CAPACITY;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loadFactor &lt;= <span class=\"number\">0</span> || Float.isNaN(loadFactor))</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Illegal load factor: &quot;</span> +</span><br><span class=\"line\">                                       loadFactor);</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.loadFactor = loadFactor;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 返回大于等于cap最小的2的幂</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">tableSizeFor</span><span class=\"params\">(<span class=\"keyword\">int</span> cap)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> n = cap - <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"comment\">// 右移一位，在进行按位或 保证了除最高位之外全是1</span></span><br><span class=\"line\">  n |= n &gt;&gt;&gt; <span class=\"number\">1</span>;</span><br><span class=\"line\">  n |= n &gt;&gt;&gt; <span class=\"number\">2</span>;</span><br><span class=\"line\">  n |= n &gt;&gt;&gt; <span class=\"number\">4</span>;</span><br><span class=\"line\">  n |= n &gt;&gt;&gt; <span class=\"number\">8</span>;</span><br><span class=\"line\">  n |= n &gt;&gt;&gt; <span class=\"number\">16</span>;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (n &lt; <span class=\"number\">0</span>) ? <span class=\"number\">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"传入map\"><a href=\"#传入map\" class=\"headerlink\" title=\"传入map\"></a>传入map</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">HashMap</span><span class=\"params\">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class=\"line\">  putMapEntries(m, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"方法分析\"><a href=\"#方法分析\" class=\"headerlink\" title=\"方法分析\"></a>方法分析</h4><h5 id=\"put方法添加元素\"><a href=\"#put方法添加元素\" class=\"headerlink\" title=\"put方法添加元素\"></a>put方法添加元素</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">put</span><span class=\"params\">(K key, V value)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> putVal(hash(key), key, value, <span class=\"keyword\">false</span>, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* 将key的hash值进行高16位和低16位异或操作，增加低16位的随机性，减少哈希冲突</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> <span class=\"title\">hash</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> h;</span><br><span class=\"line\">  <span class=\"comment\">// 右移16位是为了使得hash值得高位参与运算</span></span><br><span class=\"line\">  <span class=\"comment\">// 在计算索引位置时，使用的是(n - 1) &amp; hash 而对于数组来说一般情况下数组长度不会超过2^16，这样就会导致hash值只有低位在使用，而高位不会参与运算，所以使用hash值来右移16位，使得高十六位也参与到运算</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> (key == <span class=\"keyword\">null</span>) ? <span class=\"number\">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class=\"number\">16</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> V <span class=\"title\">putVal</span><span class=\"params\">(<span class=\"keyword\">int</span> hash, K key, V value, <span class=\"keyword\">boolean</span> onlyIfAbsent,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                   <span class=\"keyword\">boolean</span> evict)</span> </span>&#123;</span><br><span class=\"line\">  Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class=\"keyword\">int</span> n, i;</span><br><span class=\"line\">  <span class=\"comment\">// 第一次添加元素table为null，resize()进行数组初始化</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((tab = table) == <span class=\"keyword\">null</span> || (n = tab.length) == <span class=\"number\">0</span>)</span><br><span class=\"line\">    n = (tab = resize()).length;</span><br><span class=\"line\">  <span class=\"comment\">// 使用(n-1)&amp;hash找到下标位置，如果当前没有元素，则创建Node对象，放到数组该位置</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((p = tab[i = (n - <span class=\"number\">1</span>) &amp; hash]) == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">    tab[i] = newNode(hash, key, value, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">  <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 数组该位置已有值，hash冲突</span></span><br><span class=\"line\">    Node&lt;K,V&gt; e; K k;</span><br><span class=\"line\">    <span class=\"comment\">// 哈希值与key值都相同，则进行value值替代</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (p.hash == hash &amp;&amp;</span><br><span class=\"line\">        ((k = p.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">      e = p;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (p <span class=\"keyword\">instanceof</span> TreeNode) <span class=\"comment\">// hash值相等，但是key不相等，且为红黑树</span></span><br><span class=\"line\">      e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class=\"keyword\">this</span>, tab, hash, key, value);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// hash值相等，但是key不等，且为链表</span></span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> binCount = <span class=\"number\">0</span>; ; ++binCount) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((e = p.next) == <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// 追加到链表末尾</span></span><br><span class=\"line\">          p.next = newNode(hash, key, value, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class=\"number\">1</span>) <span class=\"comment\">// -1 for 1st  是否超过阈值，超过则进行链表转红黑树   表示添加之后的长度和TREEIFY_THRESHOLD进行比较</span></span><br><span class=\"line\">            treeifyBin(tab, hash);</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">            ((k = e.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        p = e;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (e != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// existing mapping for key</span></span><br><span class=\"line\">      V oldValue = e.value;  <span class=\"comment\">// 进行</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!onlyIfAbsent || oldValue == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        e.value = value;</span><br><span class=\"line\">      afterNodeAccess(e);</span><br><span class=\"line\">      <span class=\"keyword\">return</span> oldValue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ++modCount;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (++size &gt; threshold) <span class=\"comment\">// 元素个数大于新增阈值，进行resize()扩容</span></span><br><span class=\"line\">    resize();</span><br><span class=\"line\">  afterNodeInsertion(evict);</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"扩容\"><a href=\"#扩容\" class=\"headerlink\" title=\"扩容\"></a><strong><em>扩容</em></strong></h6><p>当hashMap中的容量达到阈值时，就会开始扩容操作</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class=\"line\">  Node&lt;K,V&gt;[] oldTab = table;<span class=\"comment\">// 当前的数组</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> oldCap = (oldTab == <span class=\"keyword\">null</span>) ? <span class=\"number\">0</span> : oldTab.length;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> oldThr = threshold;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> newCap, newThr = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (oldCap &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123; <span class=\"comment\">// 当前长度超过了最大容量，新增阈值为Integer.MAX_VALUE</span></span><br><span class=\"line\">      threshold = Integer.MAX_VALUE;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> oldTab;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((newCap = oldCap &lt;&lt; <span class=\"number\">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class=\"line\">             oldCap &gt;= DEFAULT_INITIAL_CAPACITY) <span class=\"comment\">// 容量扩容为2倍且当新容量小于最大容量，原来的容量大于默认初始容量时，阈值扩容为2倍</span></span><br><span class=\"line\">      newThr = oldThr &lt;&lt; <span class=\"number\">1</span>; <span class=\"comment\">// double threshold</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (oldThr &gt; <span class=\"number\">0</span>) <span class=\"comment\">// 此时oldCap&lt;=0,指定了阈值，将阈值赋给容量 initial capacity was placed in threshold</span></span><br><span class=\"line\">    newCap = oldThr;</span><br><span class=\"line\">  <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 没有指定阈值，容量为初始阈值，阈值为初始阈值*加载因子              // zero initial threshold signifies using defaults</span></span><br><span class=\"line\">    newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class=\"line\">    newThr = (<span class=\"keyword\">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (newThr == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// 按照给定的初始容量计算阈值</span></span><br><span class=\"line\">    <span class=\"keyword\">float</span> ft = (<span class=\"keyword\">float</span>)newCap * loadFactor;</span><br><span class=\"line\">    newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class=\"keyword\">float</span>)MAXIMUM_CAPACITY ?</span><br><span class=\"line\">              (<span class=\"keyword\">int</span>)ft : Integer.MAX_VALUE);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  threshold = newThr;</span><br><span class=\"line\">  <span class=\"meta\">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class=\"line\">  Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class=\"keyword\">new</span> Node[newCap];<span class=\"comment\">// 扩容后的数组</span></span><br><span class=\"line\">  table = newTab;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (oldTab != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// 将原数组的数据放入到新数组中</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> j = <span class=\"number\">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class=\"line\">      Node&lt;K,V&gt; e;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ((e = oldTab[j]) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        oldTab[j] = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e.next == <span class=\"keyword\">null</span>) <span class=\"comment\">// 无后继节点，直接放入新数组计算的位置中</span></span><br><span class=\"line\">          newTab[e.hash &amp; (newCap - <span class=\"number\">1</span>)] = e;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> TreeNode) <span class=\"comment\">// 为红黑树节点，进行拆分</span></span><br><span class=\"line\">          ((TreeNode&lt;K,V&gt;)e).split(<span class=\"keyword\">this</span>, newTab, j, oldCap);</span><br><span class=\"line\">        <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// preserve order 有后继节点，且为链表</span></span><br><span class=\"line\">          Node&lt;K,V&gt; loHead = <span class=\"keyword\">null</span>, loTail = <span class=\"keyword\">null</span>; <span class=\"comment\">// 保存在原索引的链表中</span></span><br><span class=\"line\">          Node&lt;K,V&gt; hiHead = <span class=\"keyword\">null</span>, hiTail = <span class=\"keyword\">null</span>; <span class=\"comment\">// 保存在新索引的链表中 </span></span><br><span class=\"line\">          Node&lt;K,V&gt; next;</span><br><span class=\"line\">          <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">            next = e.next;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> ((e.hash &amp; oldCap) == <span class=\"number\">0</span>) &#123; <span class=\"comment\">// 哈希值和原数组容量进行&amp;操作，为0，则放入原数组的索引位置</span></span><br><span class=\"line\">              <span class=\"keyword\">if</span> (loTail == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                loHead = e;</span><br><span class=\"line\">              <span class=\"keyword\">else</span></span><br><span class=\"line\">                loTail.next = e;</span><br><span class=\"line\">              loTail = e;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 非0则放入原数组索引位置+原数组长度的新位置</span></span><br><span class=\"line\">              <span class=\"keyword\">if</span> (hiTail == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                hiHead = e;</span><br><span class=\"line\">              <span class=\"keyword\">else</span></span><br><span class=\"line\">                hiTail.next = e;</span><br><span class=\"line\">              hiTail = e;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125; <span class=\"keyword\">while</span> ((e = next) != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (loTail != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            loTail.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            newTab[j] = loHead;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (hiTail != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            hiTail.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            newTab[j + oldCap] = hiHead;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> newTab;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"红黑树转换\"><a href=\"#红黑树转换\" class=\"headerlink\" title=\"红黑树转换\"></a><strong><em>红黑树转换</em></strong></h6><p>将单向链表转为双向链表，再遍历双向链表转为红黑树</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">treeifyBin</span><span class=\"params\">(Node&lt;K,V&gt;[] tab, <span class=\"keyword\">int</span> hash)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> n, index; Node&lt;K,V&gt; e;</span><br><span class=\"line\">    <span class=\"comment\">// 判断是否容量到达红黑树转换的最小容量</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (tab == <span class=\"keyword\">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class=\"line\">        resize();</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((e = tab[index = (n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        TreeNode&lt;K,V&gt; hd = <span class=\"keyword\">null</span>, tl = <span class=\"keyword\">null</span>; <span class=\"comment\">// hd指向首节点，tl指向尾结点</span></span><br><span class=\"line\">        <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">            TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span class=\"keyword\">null</span>); <span class=\"comment\">// 将链表转为红黑树</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (tl == <span class=\"keyword\">null</span>) <span class=\"comment\">// 如果尾结点为null，说明还没有首节点</span></span><br><span class=\"line\">                hd = p; <span class=\"comment\">// 当前节点为首节点</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 尾结点不为null，构造一个双向链表，将当前节点追加到双向链表的末尾</span></span><br><span class=\"line\">                p.prev = tl;</span><br><span class=\"line\">                tl.next = p;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            tl = p;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">          <span class=\"comment\">// 将原本的单链表转化为一个节点类型为TreeNode的双向链表</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((tab[index] = hd) != <span class=\"keyword\">null</span>) <span class=\"comment\">// 把转换后的双向链表，替换数组原来位置上的单向链表</span></span><br><span class=\"line\">            hd.treeify(tab); <span class=\"comment\">// 将当前双向链表树形化</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>双向链表转为红黑树</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">treeify</span><span class=\"params\">(Node&lt;K,V&gt;[] tab)</span> </span>&#123;</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; root = <span class=\"keyword\">null</span>; <span class=\"comment\">//定义红黑树根节点</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (TreeNode&lt;K,V&gt; x = <span class=\"keyword\">this</span>, next; x != <span class=\"keyword\">null</span>; x = next) &#123; <span class=\"comment\">// 从TreeNode双向链表的头节点开始遍历</span></span><br><span class=\"line\">    next = (TreeNode&lt;K,V&gt;)x.next;</span><br><span class=\"line\">    x.left = x.right = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (root == <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// 不存在根节点</span></span><br><span class=\"line\">      x.parent = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">      x.red = <span class=\"keyword\">false</span>; <span class=\"comment\">// 红黑树根节点为黑色</span></span><br><span class=\"line\">      root = x; <span class=\"comment\">// 当前元素设为根节点</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 存在根节点</span></span><br><span class=\"line\">      K k = x.key;</span><br><span class=\"line\">      <span class=\"keyword\">int</span> h = x.hash;</span><br><span class=\"line\">      Class&lt;?&gt; kc = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (TreeNode&lt;K,V&gt; p = root;;) &#123; <span class=\"comment\">//遍历红黑树</span></span><br><span class=\"line\">        <span class=\"keyword\">int</span> dir, ph;</span><br><span class=\"line\">        K pk = p.key;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((ph = p.hash) &gt; h) <span class=\"comment\">// 当前红黑树节点p的hash值大于双向链表节点x的哈希值</span></span><br><span class=\"line\">          dir = -<span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ph &lt; h) <span class=\"comment\">// 当前红黑树节点p的hash值小于双向链表节点x的哈希值</span></span><br><span class=\"line\">          dir = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((kc == <span class=\"keyword\">null</span> &amp;&amp;</span><br><span class=\"line\">                  (kc = comparableClassFor(k)) == <span class=\"keyword\">null</span>) ||</span><br><span class=\"line\">                 (dir = compareComparables(kc, k, pk)) == <span class=\"number\">0</span>) <span class=\"comment\">// 两者相等，使用比较器比较</span></span><br><span class=\"line\">          dir = tieBreakOrder(k, pk);</span><br><span class=\"line\"></span><br><span class=\"line\">        TreeNode&lt;K,V&gt; xp = p;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ((p = (dir &lt;= <span class=\"number\">0</span>) ? p.left : p.right) == <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// 当前红黑树p为叶子节点</span></span><br><span class=\"line\">          x.parent = xp;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (dir &lt;= <span class=\"number\">0</span>) <span class=\"comment\">// 根据dir的值，确认是p的左节点还是右节点</span></span><br><span class=\"line\">            xp.left = x;</span><br><span class=\"line\">          <span class=\"keyword\">else</span></span><br><span class=\"line\">            xp.right = x;</span><br><span class=\"line\">          root = balanceInsertion(root, x); <span class=\"comment\">// 进行平衡调整</span></span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// 将TreeNode双向链表转换为红黑树之后，将根节点作为数组的当前位置</span></span><br><span class=\"line\">  moveRootToFront(tab, root);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>将红黑树的根节点移动到数组的索引所在位置</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> &lt;K,V&gt; <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">moveRootToFront</span><span class=\"params\">(Node&lt;K,V&gt;[] tab, TreeNode&lt;K,V&gt; root)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">int</span> n;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (root != <span class=\"keyword\">null</span> &amp;&amp; tab != <span class=\"keyword\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> index = (n - <span class=\"number\">1</span>) &amp; root.hash;</span><br><span class=\"line\">    TreeNode&lt;K,V&gt; first = (TreeNode&lt;K,V&gt;)tab[index]; <span class=\"comment\">// 数组当前索引的元素</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (root != first) &#123; <span class=\"comment\">// 根节点不是当前元素</span></span><br><span class=\"line\">      Node&lt;K,V&gt; rn;</span><br><span class=\"line\">      tab[index] = root; <span class=\"comment\">// 将根节点设置为当前索引的元素</span></span><br><span class=\"line\">      TreeNode&lt;K,V&gt; rp = root.prev;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ((rn = root.next) != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        ((TreeNode&lt;K,V&gt;)rn).prev = rp;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (rp != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        rp.next = rn;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (first != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        first.prev = root;</span><br><span class=\"line\">      root.next = first;</span><br><span class=\"line\">      root.prev = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">assert</span> <span class=\"title\">checkInvariants</span><span class=\"params\">(root)</span></span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"红黑树插入\"><a href=\"#红黑树插入\" class=\"headerlink\" title=\"红黑树插入\"></a><strong><em>红黑树插入</em></strong></h6><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> TreeNode&lt;K,V&gt; <span class=\"title\">putTreeVal</span><span class=\"params\">(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                       <span class=\"keyword\">int</span> h, K k, V v)</span> </span>&#123;</span><br><span class=\"line\">  Class&lt;?&gt; kc = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">boolean</span> searched = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; root = (parent != <span class=\"keyword\">null</span>) ? root() : <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> dir, ph; K pk;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((ph = p.hash) &gt; h)</span><br><span class=\"line\">      dir = -<span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (ph &lt; h)</span><br><span class=\"line\">      dir = <span class=\"number\">1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((pk = p.key) == k || (k != <span class=\"keyword\">null</span> &amp;&amp; k.equals(pk)))</span><br><span class=\"line\">      <span class=\"keyword\">return</span> p;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> ((kc == <span class=\"keyword\">null</span> &amp;&amp;</span><br><span class=\"line\">              (kc = comparableClassFor(k)) == <span class=\"keyword\">null</span>) ||</span><br><span class=\"line\">             (dir = compareComparables(kc, k, pk)) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!searched) &#123;</span><br><span class=\"line\">        TreeNode&lt;K,V&gt; q, ch;</span><br><span class=\"line\">        searched = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (((ch = p.left) != <span class=\"keyword\">null</span> &amp;&amp;</span><br><span class=\"line\">             (q = ch.find(h, k, kc)) != <span class=\"keyword\">null</span>) ||</span><br><span class=\"line\">            ((ch = p.right) != <span class=\"keyword\">null</span> &amp;&amp;</span><br><span class=\"line\">             (q = ch.find(h, k, kc)) != <span class=\"keyword\">null</span>))</span><br><span class=\"line\">          <span class=\"keyword\">return</span> q;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      dir = tieBreakOrder(k, pk);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    TreeNode&lt;K,V&gt; xp = p;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((p = (dir &lt;= <span class=\"number\">0</span>) ? p.left : p.right) == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      Node&lt;K,V&gt; xpn = xp.next;</span><br><span class=\"line\">      TreeNode&lt;K,V&gt; x = map.newTreeNode(h, k, v, xpn);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (dir &lt;= <span class=\"number\">0</span>)</span><br><span class=\"line\">        xp.left = x;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        xp.right = x;</span><br><span class=\"line\">      xp.next = x;</span><br><span class=\"line\">      x.parent = x.prev = xp;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (xpn != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        ((TreeNode&lt;K,V&gt;)xpn).prev = x;</span><br><span class=\"line\">      moveRootToFront(tab, balanceInsertion(root, x));</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"红黑树拆分\"><a href=\"#红黑树拆分\" class=\"headerlink\" title=\"红黑树拆分\"></a><strong><em>红黑树拆分</em></strong></h6><p>在进行扩容操作时，会重新计算索引位置，拆分之后的红黑树需要判断个数，从而决定做去树化还是树化</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">split</span><span class=\"params\">(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab, <span class=\"keyword\">int</span> index, <span class=\"keyword\">int</span> bit)</span> </span>&#123;</span><br><span class=\"line\">  TreeNode&lt;K,V&gt; b = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">  <span class=\"comment\">// Relink into lo and hi lists, preserving order</span></span><br><span class=\"line\">  TreeNode&lt;K,V&gt; loHead = <span class=\"keyword\">null</span>, loTail = <span class=\"keyword\">null</span>; <span class=\"comment\">// 保存在原索引的红黑树</span></span><br><span class=\"line\">  TreeNode&lt;K,V&gt; hiHead = <span class=\"keyword\">null</span>, hiTail = <span class=\"keyword\">null</span>; <span class=\"comment\">// 保存在新索引的红黑树</span></span><br><span class=\"line\">  <span class=\"keyword\">int</span> lc = <span class=\"number\">0</span>, hc = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (TreeNode&lt;K,V&gt; e = b, next; e != <span class=\"keyword\">null</span>; e = next) &#123; <span class=\"comment\">// 与链表操作基本一致</span></span><br><span class=\"line\">    next = (TreeNode&lt;K,V&gt;)e.next;</span><br><span class=\"line\">    e.next = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((e.hash &amp; bit) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ((e.prev = loTail) == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        loHead = e;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        loTail.next = e;</span><br><span class=\"line\">      loTail = e;</span><br><span class=\"line\">      ++lc;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> ((e.prev = hiTail) == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        hiHead = e;</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        hiTail.next = e;</span><br><span class=\"line\">      hiTail = e;</span><br><span class=\"line\">      ++hc;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (loHead != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// 原索引位置</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (lc &lt;= UNTREEIFY_THRESHOLD)</span><br><span class=\"line\">      tab[index] = loHead.untreeify(map);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      tab[index] = loHead;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (hiHead != <span class=\"keyword\">null</span>) <span class=\"comment\">// (else is already treeified)</span></span><br><span class=\"line\">        loHead.treeify(tab);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (hiHead != <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// 新索引位置</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (hc &lt;= UNTREEIFY_THRESHOLD) <span class=\"comment\">// 红黑树节点小于去树化阈值，进行去树化操作</span></span><br><span class=\"line\">      tab[index + bit] = hiHead.untreeify(map);</span><br><span class=\"line\">    <span class=\"keyword\">else</span> &#123; <span class=\"comment\">// 大于去树化阈值，进行树化操作</span></span><br><span class=\"line\">      tab[index + bit] = hiHead;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (loHead != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">        hiHead.treeify(tab);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"去树化操作\"><a href=\"#去树化操作\" class=\"headerlink\" title=\"去树化操作\"></a><strong>去树化操作</strong></h6><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> Node&lt;K,V&gt; <span class=\"title\">untreeify</span><span class=\"params\">(HashMap&lt;K,V&gt; map)</span> </span>&#123;</span><br><span class=\"line\">  Node&lt;K,V&gt; hd = <span class=\"keyword\">null</span>, tl = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (Node&lt;K,V&gt; q = <span class=\"keyword\">this</span>; q != <span class=\"keyword\">null</span>; q = q.next) &#123;</span><br><span class=\"line\">    Node&lt;K,V&gt; p = map.replacementNode(q, <span class=\"keyword\">null</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (tl == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">      hd = p;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      tl.next = p;</span><br><span class=\"line\">    tl = p;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> hd;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>put操作的大致步骤如下：</p>\n<ul>\n<li>对key进行hash操作，找到索引位置，如果此时索引位置为null，直接插入</li>\n<li>如果此时索引位置不为null，说明出现了hash冲突，使用equals()比较key的值，如果存在与该key相同的值，则替换value</li>\n<li>如果不存在与该key相同的值，且此时存储结构为链表，则插入链表尾部，如果链表长度超过8个且数组长度大于64时，进行链表转红黑树</li>\n<li>当数组中数据达到阈值，则需要进行扩容，扩容时需要进行去树化</li>\n</ul>\n<h5 id=\"get方法获取元素\"><a href=\"#get方法获取元素\" class=\"headerlink\" title=\"get方法获取元素\"></a>get方法获取元素</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> V <span class=\"title\">get</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">    Node&lt;K,V&gt; e;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (e = getNode(hash(key), key)) == <span class=\"keyword\">null</span> ? <span class=\"keyword\">null</span> : e.value;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">// hash为key的hash值</span></span><br><span class=\"line\"><span class=\"comment\">// key为所要查找的key对象</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">final</span> Node&lt;K,V&gt; <span class=\"title\">getNode</span><span class=\"params\">(<span class=\"keyword\">int</span> hash, Object key)</span> </span>&#123;</span><br><span class=\"line\">  Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class=\"keyword\">int</span> n; K k;</span><br><span class=\"line\">  <span class=\"comment\">// 数组不为null且该索引位置的头节点不为null</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> ((tab = table) != <span class=\"keyword\">null</span> &amp;&amp; (n = tab.length) &gt; <span class=\"number\">0</span> &amp;&amp;</span><br><span class=\"line\">      (first = tab[(n - <span class=\"number\">1</span>) &amp; hash]) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 先检查头节点是否匹配，若匹配直接返回</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (first.hash == hash &amp;&amp; <span class=\"comment\">// always check first node</span></span><br><span class=\"line\">        ((k = first.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">      <span class=\"keyword\">return</span> first;</span><br><span class=\"line\">    <span class=\"comment\">// 头节点不匹配，且有后继节点</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((e = first.next) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// 红黑树</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (first <span class=\"keyword\">instanceof</span> TreeNode)</span><br><span class=\"line\">        <span class=\"comment\">// 红黑树查找</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class=\"line\">      <span class=\"comment\">// 链表</span></span><br><span class=\"line\">      <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e.hash == hash &amp;&amp;</span><br><span class=\"line\">            ((k = e.key) == key || (key != <span class=\"keyword\">null</span> &amp;&amp; key.equals(k))))</span><br><span class=\"line\">          <span class=\"keyword\">return</span> e;</span><br><span class=\"line\">      &#125; <span class=\"keyword\">while</span> ((e = e.next) != <span class=\"keyword\">null</span>);<span class=\"comment\">// 进行遍历匹配</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"高并发问题\"><a href=\"#高并发问题\" class=\"headerlink\" title=\"高并发问题\"></a>高并发问题</h3><p>由于HashMap不是线程安全的，在高并发的情况下会出现问题，在插入时可能会出现问题</p>\n<p>假如HashMap到达了扩容的临界点，此时有两个线程在同一时刻对HashMap进行put操作，两个线程都会进行扩容可能会形成链表环，使得下一次读操作出现死循环。</p>\n","categories":["java基础"],"tags":["java基础"]},{"title":"kafka API操作","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%20API%E4%BD%BF%E7%94%A8/","content":"<p>kafka提供了4类核心API</p>\n<a id=\"more\"></a>\n\n<ul>\n<li><p>Producer API    生产消息相关接口，自定义生产者、自定义分区分配</p>\n</li>\n<li><p>Consumer API  消费消息相关接口，创建消费者、消费偏移量管理</p>\n</li>\n<li><p>Streams API     构建流处理程序的接口</p>\n</li>\n<li><p>Connect API     kafka和外部系统进行数据流连接的连接器，实现将数据导入到kafka或从kafka中导出到外部系统。</p>\n</li>\n</ul>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dependencies</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">groupId</span>&gt;</span>org.apache.kafka<span class=\"tag\">&lt;/<span class=\"name\">groupId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">artifactId</span>&gt;</span>kafka-clients<span class=\"tag\">&lt;/<span class=\"name\">artifactId</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">version</span>&gt;</span>2.3.1<span class=\"tag\">&lt;/<span class=\"name\">version</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dependency</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"主题\"><a href=\"#主题\" class=\"headerlink\" title=\"主题\"></a>主题</h2><h3 id=\"主题创建\"><a href=\"#主题创建\" class=\"headerlink\" title=\"主题创建\"></a>主题创建</h3><p>新版本的kafka使用AdminClient代替了之前的ZkUtils类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">createTopic</span><span class=\"params\">(String topic)</span></span>&#123;</span><br><span class=\"line\">        AdminClient adminClient;</span><br><span class=\"line\">        Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">        properties.put(CommonClientConfigs.BOOTSTRAP_SERVERS_CONFIG,<span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">        adminClient = AdminClient.create(properties);</span><br><span class=\"line\">        <span class=\"comment\">// 主题 分区 副本</span></span><br><span class=\"line\">        NewTopic newTopic = <span class=\"keyword\">new</span> NewTopic(topic,<span class=\"number\">5</span>,(<span class=\"keyword\">short</span>)<span class=\"number\">1</span>);</span><br><span class=\"line\">        CreateTopicsResult result = adminClient.createTopics(Collections.singletonList(newTopic));</span><br><span class=\"line\">        <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">            result.all().get();</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;创建成功&quot;</span>);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;创建失败&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            adminClient.close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"主题查询\"><a href=\"#主题查询\" class=\"headerlink\" title=\"主题查询\"></a>主题查询</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 创建client</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> AdminClient <span class=\"title\">createAdmin</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        AdminClient adminClient;</span><br><span class=\"line\">        Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">        properties.put(CommonClientConfigs.BOOTSTRAP_SERVERS_CONFIG, <span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">        adminClient = AdminClient.create(properties);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> adminClient;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 列出主题</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">listTopic</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class=\"line\">        AdminClient adminClient = createAdmin();</span><br><span class=\"line\">        ListTopicsResult listTopicsResult = adminClient.listTopics();</span><br><span class=\"line\">        Set&lt;String&gt; topicNameSet = listTopicsResult.names().get();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;----------列出主题-----------&quot;</span>);</span><br><span class=\"line\">        topicNameSet.forEach(System.out::println);</span><br><span class=\"line\">        adminClient.close();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"主题详细信息\"><a href=\"#主题详细信息\" class=\"headerlink\" title=\"主题详细信息\"></a>主题详细信息</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 主题详细信息</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@param</span> topic</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> ExecutionException</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@throws</span> InterruptedException</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">descTopic</span><span class=\"params\">(String topic)</span> <span class=\"keyword\">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class=\"line\">        AdminClient adminClient = createAdmin();</span><br><span class=\"line\">        DescribeTopicsResult describeTopicsResult = adminClient.describeTopics(Collections.singletonList(topic));</span><br><span class=\"line\">        TopicDescription topicDescription = describeTopicsResult.all().get().get(topic);</span><br><span class=\"line\">        System.out.println(topicDescription);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"修改主题配置\"><a href=\"#修改主题配置\" class=\"headerlink\" title=\"修改主题配置\"></a>修改主题配置</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * 修改主题配置</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * <span class=\"doctag\">@param</span> topic</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">updateTopic</span><span class=\"params\">(String topic)</span> <span class=\"keyword\">throws</span> ExecutionException, InterruptedException </span>&#123;</span><br><span class=\"line\">      AdminClient adminClient = createAdmin();</span><br><span class=\"line\">      ConfigEntry configEntry = <span class=\"keyword\">new</span> ConfigEntry(TopicConfig.MAX_MESSAGE_BYTES_CONFIG, <span class=\"string\">&quot;102400&quot;</span>);</span><br><span class=\"line\">      AlterConfigOp alterConfigOp = <span class=\"keyword\">new</span> AlterConfigOp(configEntry, AlterConfigOp.OpType.SET);</span><br><span class=\"line\">      ConfigResource configResource = <span class=\"keyword\">new</span> ConfigResource(ConfigResource.Type.TOPIC, topic);</span><br><span class=\"line\">      Map&lt;ConfigResource, Collection&lt;AlterConfigOp&gt;&gt; configs = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">      configs.put(configResource,Collections.singletonList(alterConfigOp));</span><br><span class=\"line\">      AlterConfigsResult alterConfigsResult = adminClient.incrementalAlterConfigs(configs);</span><br><span class=\"line\">      alterConfigsResult.all().get();</span><br><span class=\"line\">      adminClient.close();</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"删除主题\"><a href=\"#删除主题\" class=\"headerlink\" title=\"删除主题\"></a>删除主题</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * 删除主题</span></span><br><span class=\"line\"><span class=\"comment\">    * <span class=\"doctag\">@param</span> topic</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">deleteTopic</span><span class=\"params\">(String topic)</span></span>&#123;</span><br><span class=\"line\">       AdminClient adminClient = createAdmin();</span><br><span class=\"line\">       adminClient.deleteTopics(Collections.singletonList(topic));</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"新增分区\"><a href=\"#新增分区\" class=\"headerlink\" title=\"新增分区\"></a>新增分区</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 增加分区</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> topic</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@param</span> num</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">addPartitions</span><span class=\"params\">(String topic, <span class=\"keyword\">int</span> num)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 增加分区数  num为分区总数</span></span><br><span class=\"line\">    NewPartitions newPartitions = NewPartitions.increaseTo(num);</span><br><span class=\"line\">    AdminClient adminClient = createAdmin();</span><br><span class=\"line\">    Map&lt;String, NewPartitions&gt; config = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">    config.put(topic, newPartitions);</span><br><span class=\"line\">    adminClient.createPartitions(config);</span><br><span class=\"line\">    adminClient.close();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"生产者\"><a href=\"#生产者\" class=\"headerlink\" title=\"生产者\"></a>生产者</h2><p>实现kafka生产者的一般步骤</p>\n<ul>\n<li><p>创建Properties对象，设置生产者级别配置，必须包含的3个配置</p>\n<ul>\n<li><p>bootstrap-server：配置kafka地址</p>\n</li>\n<li><p>key.serializer：配置用于序列化key的类</p>\n</li>\n<li><p>value.serializer：配置用于序列化实际数据的类</p>\n</li>\n</ul>\n</li>\n<li><p>根据Properties对象实例化一个KafkaProducer对象</p>\n</li>\n<li><p>实例化ProducerRecord对象，每条消息对应ProducerRecord对象</p>\n</li>\n<li><p>调用KafkaProducer发送消息的方法将ProducerRecord发送到kafka，有两种方法send(ProducerRecord)，send(ProducerRecord,Callback)。  KafkaProducer默认是异步发送，会将消息缓存到消息缓冲区中，当消息在消息缓冲区中累计到一定数量之后作为一个RecordBatch发送。生产者发送消息分为两个阶段：第一阶段是将消息发送到消息缓冲区；第二阶段是一个Sender线程负责将缓冲区的消息发送到kafka，执行真正的I/O操作，在第一阶段执行完会返回一个Feature对象，根据对Feature对象处理方式不同，分为两种发送方式</p>\n<ul>\n<li><p>异步方式： 使用异步方式如果希望知道消息发送成功与否，在回调函数Callback中进行相应处理</p>\n</li>\n<li><p>同步方式： 通过调用send方法返回的Feature对象的get()方法以阻塞式获取执行结果，即等待Sender线程处理的最终结果</p>\n</li>\n</ul>\n</li>\n<li><p>关闭KafkaProducer，释放连接资源</p>\n</li>\n</ul>\n<h3 id=\"单线程生产者\"><a href=\"#单线程生产者\" class=\"headerlink\" title=\"单线程生产者\"></a>单线程生产者</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 设置生产消息的总数</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> MSG_SIZE = <span class=\"number\">10</span>;</span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 主题名称</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_NAME = <span class=\"string\">&quot;test-topic&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> KafkaProducer&lt;String, String&gt; producer;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">        Properties properties = initConfig();</span><br><span class=\"line\">        producer = <span class=\"keyword\">new</span> KafkaProducer&lt;String, String&gt;(properties);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * 初始化kafka配置</span></span><br><span class=\"line\"><span class=\"comment\">     *</span></span><br><span class=\"line\"><span class=\"comment\">     * <span class=\"doctag\">@return</span></span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Properties <span class=\"title\">initConfig</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br><span class=\"line\">        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> properties;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"同步方式\"><a href=\"#同步方式\" class=\"headerlink\" title=\"同步方式\"></a>同步方式</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">ProducerRecord&lt;String, String&gt; record = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> num = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; MSG_SIZE; i++) &#123;</span><br><span class=\"line\">        record = <span class=\"keyword\">new</span> ProducerRecord&lt;&gt;(TOPIC_NAME,<span class=\"string\">&quot;消息key&quot;</span>+i,<span class=\"string\">&quot;消息体&quot;</span>+i);</span><br><span class=\"line\">        producer.send(record).get();</span><br><span class=\"line\">        Thread.sleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">       e.printStackTrace();</span><br><span class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">       producer.close();</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"异步方式\"><a href=\"#异步方式\" class=\"headerlink\" title=\"异步方式\"></a>异步方式</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">ProducerRecord&lt;String, String&gt; record = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">   <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">       <span class=\"keyword\">int</span> num = <span class=\"number\">0</span>;</span><br><span class=\"line\">       <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; MSG_SIZE; i++) &#123;</span><br><span class=\"line\">           record = <span class=\"keyword\">new</span> ProducerRecord&lt;&gt;(TOPIC_NAME,<span class=\"string\">&quot;callback消息key&quot;</span>+i,<span class=\"string\">&quot;callback消息体&quot;</span>+i);</span><br><span class=\"line\">           producer.send(record, <span class=\"keyword\">new</span> Callback() &#123;</span><br><span class=\"line\">               <span class=\"meta\">@Override</span></span><br><span class=\"line\">               <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCompletion</span><span class=\"params\">(RecordMetadata metadata, Exception exception)</span> </span>&#123;</span><br><span class=\"line\">                   <span class=\"keyword\">if</span>(exception != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                       System.out.println(<span class=\"string\">&quot;出现异常&quot;</span>);</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">                   <span class=\"keyword\">if</span>(metadata != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                       System.out.printf(<span class=\"string\">&quot;offset:%s,partition:%s&quot;</span>,metadata.offset(),metadata.partition());</span><br><span class=\"line\">                       System.out.println();</span><br><span class=\"line\">                   &#125;</span><br><span class=\"line\">               &#125;</span><br><span class=\"line\">           &#125;);</span><br><span class=\"line\">           Thread.sleep(<span class=\"number\">1000</span>);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">       e.printStackTrace();</span><br><span class=\"line\">   &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">       producer.close();</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"多线程生产者\"><a href=\"#多线程生产者\" class=\"headerlink\" title=\"多线程生产者\"></a>多线程生产者</h3><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ProducerThread</span> <span class=\"keyword\">implements</span> <span class=\"title\">Runnable</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> KafkaProducer&lt;String, String&gt; producer = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ProducerRecord&lt;String, String&gt; record = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ProducerThread</span><span class=\"params\">(KafkaProducer&lt;String, String&gt; producer, ProducerRecord&lt;String, String&gt; record)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.producer = producer;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.record = record;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        producer.send(record, <span class=\"keyword\">new</span> Callback() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onCompletion</span><span class=\"params\">(RecordMetadata metadata, Exception exception)</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (exception != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;出现异常&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (metadata != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    System.out.printf(<span class=\"string\">&quot;offset:%s,partition:%s&quot;</span>, metadata.offset(), metadata.partition());</span><br><span class=\"line\">                    System.out.println();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 执行方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        ProducerRecord&lt;String, String&gt; record = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        ExecutorService executorService = Executors.newFixedThreadPool(<span class=\"number\">4</span>);</span><br><span class=\"line\">        <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; MSG_SIZE; i++) &#123;</span><br><span class=\"line\">                record = <span class=\"keyword\">new</span> ProducerRecord&lt;&gt;(TOPIC_NAME,<span class=\"string\">&quot;多线程callback消息key&quot;</span>+i,<span class=\"string\">&quot;多线程callback消息体&quot;</span>+i);</span><br><span class=\"line\">                executorService.submit(<span class=\"keyword\">new</span> ProducerThread(producer,record));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e)&#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;kakfa发送出现异常&quot;</span>+e.getMessage());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            producer.close();</span><br><span class=\"line\">            executorService.shutdown();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"消费者\"><a href=\"#消费者\" class=\"headerlink\" title=\"消费者\"></a>消费者</h2><p>消费者创建需要指定连接的kafka的bootstrap-server属性、消息key反序列化类的key.deserializer属性、消息value反序列化类的value.deserializer属性、是否自动提交偏移量enable.auto.commit属性、消费者组group.id</p>\n<p>如果不指定消费偏移量提交方式的话，默认是1s自动提交偏移量，使用auto.commit.interval.ms参数设置偏移量提交的时间间隔</p>\n<h3 id=\"订阅主题\"><a href=\"#订阅主题\" class=\"headerlink\" title=\"订阅主题\"></a>订阅主题</h3><p>kafka提供了四种订阅主题的方式</p>\n<ul>\n<li><p>subscribe(Collection<String> topics)</String></p>\n</li>\n<li><p>subscribe(Collection<String> topics, ConsumerRebalanceListener listener)  订阅主题时指定一个监听器，用于在消费者发生平衡操作时回调进行相应的业务处理   ConsumerRebalanceListener接口，当消费者发生平衡操作时，可以在该接口的相应方法中完成必要的应用程序逻辑处理，如提交偏移量操作，有两个回调方法：</String></p>\n<ul>\n<li>一个是在消费者平衡操作前、消费者停止拉取消息之后被调用的onPartitionsRevoked(Collection<TopicPartition> partitions)，在该方法中可以提交偏移量操作以避免数据重复消费</TopicPartition></li>\n<li>一个是在平衡之后，消费者开始拉取消息之前被调用的onPartitionsAssigned(Collection<TopicPartition> partitions)方法，在该方法中保证各消费者回滚到正确的偏移量，即重置各消费者偏移量</TopicPartition></li>\n</ul>\n</li>\n<li><p>subscribe(Pattern pattern)</p>\n</li>\n<li><p>subscribe(Pattern pattern, ConsumerRebalanceListener listener)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> KafkaConsumer&lt;String, String&gt; consumer;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_NAME = <span class=\"string\">&quot;test-topic&quot;</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> TIME = <span class=\"number\">1000L</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    Properties properties = initConfig();</span><br><span class=\"line\">    consumer = <span class=\"keyword\">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Properties <span class=\"title\">initConfig</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">    properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.CLIENT_ID_CONFIG, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class=\"line\">    properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class=\"line\">    <span class=\"comment\">// 设置偏移量自动提交</span></span><br><span class=\"line\">    properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 设置偏移量提交时间间隔</span></span><br><span class=\"line\">    properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, <span class=\"number\">1000</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> properties;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 订阅主题</span></span><br><span class=\"line\">    consumer.subscribe(Collections.singletonList(TOPIC_NAME), <span class=\"keyword\">new</span> ConsumerRebalanceListener() &#123;</span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPartitionsRevoked</span><span class=\"params\">(Collection&lt;TopicPartition&gt; partitions)</span> </span>&#123;</span><br><span class=\"line\">            consumer.commitSync();<span class=\"comment\">//提交偏移量</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onPartitionsAssigned</span><span class=\"params\">(Collection&lt;TopicPartition&gt; partitions)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">long</span> committedOffset = -<span class=\"number\">1</span>;</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (TopicPartition partition : partitions) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// 获取该分区已消费的偏移量</span></span><br><span class=\"line\">                committedOffset = consumer.committed(partition).offset();</span><br><span class=\"line\">                <span class=\"comment\">// 重置偏移量到上一次提交的偏移量下一个位置处开始消费</span></span><br><span class=\"line\">                consumer.seek(partition, committedOffset + <span class=\"number\">1</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">        ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofMillis(TIME));</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (ConsumerRecord&lt;String,String&gt; record : consumerRecords) &#123;</span><br><span class=\"line\">            System.out.printf(<span class=\"string\">&quot;partition = %d,offset = %d,key = %s,value = %s%n&quot;</span>, record.partition(), record.offset(), record.key(), record.value());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n<p><strong>订阅指定分区</strong></p>\n<p>使用consumer.assign(Collection<TopicPartition> partitions)订阅指定分区</TopicPartition></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> KafkaConsumer&lt;String, String&gt; consumer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_NAME = <span class=\"string\">&quot;test-topic&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> TIME = <span class=\"number\">1000L</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    Properties properties = initConfig();</span><br><span class=\"line\">    consumer = <span class=\"keyword\">new</span> KafkaConsumer&lt;&gt;(properties);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Properties <span class=\"title\">initConfig</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">    properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.CLIENT_ID_CONFIG, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class=\"line\">    properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class=\"line\">    <span class=\"comment\">// 设置偏移量自动提交</span></span><br><span class=\"line\">    properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 设置偏移量提交时间间隔</span></span><br><span class=\"line\">    properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, <span class=\"number\">1000</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> properties;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    consumer.assign(Collections.singletonList(<span class=\"keyword\">new</span> TopicPartition(TOPIC_NAME,<span class=\"number\">0</span>)));</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>)&#123;</span><br><span class=\"line\">        ConsumerRecords&lt;String,String&gt; consumerRecords = consumer.poll(Duration.ofMillis(<span class=\"number\">1000L</span>));</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (ConsumerRecord&lt;String,String&gt; record: consumerRecords) &#123;</span><br><span class=\"line\">            System.out.printf(<span class=\"string\">&quot;partition = %d,offset = %d,key = %s,value = %s%n&quot;</span>, record.partition(), record.offset(), record.key(), record.value());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>消费偏移量管理</strong></p>\n<p>kafka消费者API提供了两种方法用于查询消费偏移量的操作</p>\n<ul>\n<li><p>committed(TopicPartition partition)方法，该方法返回一个OffsetAndMetadata对象，通过OffsetAndMetadata对象可获取指定分区已提交的偏移量</p>\n</li>\n<li><p>position(TopicPartition partition)方法，返回下一次拉取位置</p>\n</li>\n</ul>\n<p>kafka提供了重置消费者偏移量的方法</p>\n<ul>\n<li><p>seek(TopicPartition partition, long offset)方法用于将消费起始位置重置到指定的偏移量位置</p>\n</li>\n<li><p>seekToBeginning(Collection<TopicPartition> partitions)方法指定从消息起始位置开始消费，对应偏移量重置策略auto.offset.reset=earliest</TopicPartition></p>\n</li>\n<li><p>seekToEnd(Collection<TopicPartition> partitions)方法指定从最新消息对应的消息开始消费，要等新的消息写入后才进行拉取，对应偏移量重置策略auto.offset.reset=latest</TopicPartition></p>\n</li>\n</ul>\n<p>消费者消费位移确定有自动提交与手动提交两种策略。创建消费者对象的时候，参数enable.auto.commit设定，true表示自动提交，默认是自动提交。自动提交策略由消费者协调器(ConsumerCoordinator)每隔${auto.commit.interval.ms}毫秒执行一次偏移量的提交。手动提交需要由客户端自己控制偏移量的提交</p>\n<ul>\n<li><p>自动提交</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> KafkaConsumer&lt;String, String&gt; consumer;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_NAME = <span class=\"string\">&quot;test-topic&quot;</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> TIME = <span class=\"number\">1000L</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    Properties properties = initConfig();</span><br><span class=\"line\">    consumer = <span class=\"keyword\">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Properties <span class=\"title\">initConfig</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">    properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.CLIENT_ID_CONFIG, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class=\"line\">    properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class=\"line\">    <span class=\"comment\">// 设置偏移量自动提交</span></span><br><span class=\"line\">    properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">    <span class=\"comment\">// 设置偏移量提交时间间隔</span></span><br><span class=\"line\">    properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, <span class=\"number\">1000</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> properties;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    consumer.subscribe(Collections.singletonList(TOPIC_NAME));</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">        ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofMillis(TIME));</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (ConsumerRecord&lt;String,String&gt; record : consumerRecords) &#123;</span><br><span class=\"line\">            System.out.printf(<span class=\"string\">&quot;partition = %d,offset = %d,key = %s,value = %s%n&quot;</span>, record.partition(), record.offset(), record.key(), record.value());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n<ul>\n<li><p>手动提交   提供了同步提交(commitSync)和异步提交(commitAsync)两种提交方式。同步提交失败时一直尝试提交，直到遇到无法重试的情况下才会结束，同时同步方式下消费者线程在拉取消息的时候会被阻塞，直到偏移量提交操作成功或者在提交过程出现错误。  异步方式下消费者线程不会被阻塞，可能在提交偏移量操作的结果还未返回时就开始下一次的拉取操作，在提交失败时也不会尝试提交</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> KafkaConsumer&lt;String, String&gt; consumer;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_NAME = <span class=\"string\">&quot;test-topic&quot;</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> TIME = <span class=\"number\">1000L</span>;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"keyword\">static</span> &#123;</span><br><span class=\"line\">    Properties properties = initConfig();</span><br><span class=\"line\">    consumer = <span class=\"keyword\">new</span> KafkaConsumer&lt;String, String&gt;(properties);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Properties <span class=\"title\">initConfig</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">    properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.CLIENT_ID_CONFIG, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,<span class=\"string\">&quot;earliest&quot;</span>);</span><br><span class=\"line\">    properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class=\"line\">    properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class=\"line\">    <span class=\"comment\">// 设置偏移量手动提交</span></span><br><span class=\"line\">    properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> properties;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">    consumer.subscribe(Collections.singletonList(TOPIC_NAME));</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">        ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofMillis(TIME));</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (ConsumerRecord&lt;String, String&gt; record : consumerRecords) &#123;</span><br><span class=\"line\">            System.out.printf(<span class=\"string\">&quot;partition = %d,offset = %d,key = %s,value = %s%n&quot;</span>, record.partition(), record.offset(), record.key(), record.value());</span><br><span class=\"line\">            consumer.commitAsync((offsets, exception) -&gt; &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(exception == <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;提交成功&quot;</span>);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    System.out.println(<span class=\"string\">&quot;发生异常&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n<p><strong>消费速度控制</strong></p>\n<p>使用pause(Collection<TopicPartition> partitions)和resume(Collection<TopicPartition> partitions)，分别用来暂停某些分区在拉取操作时返回数据给客户端和恢</TopicPartition></TopicPartition></p>\n<p>复某些分区向客户端返回数据操作</p>\n<p><strong>多线程消费者</strong></p>\n<p>KafkaConsumer为非线程安全的，多线程需要处理好线程同步。常见的实现方式是每个线程各自实例化一个KafkaConsumer对象。将分区作为消费者线程的最小划分单位。(消费者数大于分区数时就会有部分消费者一直处于空闲状态，若多个消费者消费同一分区时需要考虑偏移量提交处理的问题)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConsumerThread</span> <span class=\"keyword\">extends</span> <span class=\"title\">Thread</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> KafkaConsumer&lt;String, String&gt; consumer;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ConsumerThread</span><span class=\"params\">(Properties config, String topic)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.consumer = <span class=\"keyword\">new</span> KafkaConsumer&lt;String, String&gt;(config);</span><br><span class=\"line\">        consumer.subscribe(Collections.singletonList(topic));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">                ConsumerRecords&lt;String, String&gt; consumerRecords = consumer.poll(Duration.ofMillis(<span class=\"number\">1000L</span>));</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (ConsumerRecord&lt;String, String&gt; record : consumerRecords) &#123;</span><br><span class=\"line\">                    System.out.printf(<span class=\"string\">&quot;threadId=%s,partition=%d,offset%d,key=%s,value=%s%n&quot;</span>, Thread.currentThread().getId(), record.partition(), record.offset(), record.key(), record.value());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e)&#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            consumer.close();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestThead</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String TOPIC_NAME = <span class=\"string\">&quot;test-topic&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Properties <span class=\"title\">initConfig</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class=\"string\">&quot;localhost:9092&quot;</span>);</span><br><span class=\"line\">        properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">        properties.put(ConsumerConfig.CLIENT_ID_CONFIG, <span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class=\"line\">        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class=\"line\">        <span class=\"comment\">// 设置偏移量自动提交</span></span><br><span class=\"line\">        properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 设置偏移量提交时间间隔</span></span><br><span class=\"line\">        properties.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, <span class=\"number\">1000</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> properties;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//假设该主题有六个分区，则开启六个线程</span></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"number\">6</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">new</span> ConsumerThread(initConfig(), TOPIC_NAME).start();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"与spring结合\"><a href=\"#与spring结合\" class=\"headerlink\" title=\"与spring结合\"></a>与spring结合</h2><p>spring-kafka是通过监听模式消费消息的。定义了一个消息监听者容器接口MessageListerContainer，有两个实现类KafkaMessageListenerContainer和ConcurrentMessageListenerContainer，分别表示单线程容器和多线程并发容器。</p>\n<p>多线程并发容器是根据用户指定的并发数来创建多个单线程容器。称为线程容器，是由于消费者线程是交由消息监听者容器来管理，然而监听者容器并不是直接管理消费者线程，而是管理消费者工厂。</p>\n<p>提供了一个MessageListener接口，实现该接口，重写onMessage方法即可。</p>\n","categories":["kafka"],"tags":["kafka"]},{"title":"tomcat之Catalina","url":"/2020/%E6%9C%8D%E5%8A%A1%E5%99%A8/tomcat/tomcat%E4%B9%8BCatalina/","content":"<h2 id=\"Catalina\"><a href=\"#Catalina\" class=\"headerlink\" title=\"Catalina\"></a>Catalina</h2><p>在Tomcat4.0版本，将Servlet容器重新命名为Catalina。</p>\n<p>catalina包含Tomcat所有容器组件，通过松耦合的方式集成Coyote，以及完成按照请求协议进行数据读写，同时还包括启动入口和Shell程序。</p>\n<a id=\"more\"></a>\n\n<img src=\"/images/tomcat/catalina.png\" style=\"zoom:50%;\">\n\n<p>Tomcat本质上是一款Servlet容器，Catalina是Tomcat的核心，其他模块均为Catalina提供支撑。通过Coyote模块提供链接通信，Jasper模块提供JSP引擎，Naming提供JNDI服务，Juli提供日志服务。</p>\n<h3 id=\"Digester\"><a href=\"#Digester\" class=\"headerlink\" title=\"Digester\"></a>Digester</h3><p>Catalina使用Digester解析XML(server.xml)配置文件并创建应用服务器。</p>\n<p>Digester是一款将XML转换为java对象的事件驱动型工具，是对SAX的高层次封装。</p>\n<h3 id=\"创建Server\"><a href=\"#创建Server\" class=\"headerlink\" title=\"创建Server\"></a>创建Server</h3><h4 id=\"Server解析\"><a href=\"#Server解析\" class=\"headerlink\" title=\"Server解析\"></a>Server解析</h4><p>解析server.xml文件，文件示例</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">  Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class=\"line\"><span class=\"comment\">  contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class=\"line\"><span class=\"comment\">  this work for additional information regarding copyright ownership.</span></span><br><span class=\"line\"><span class=\"comment\">  The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class=\"line\"><span class=\"comment\">  (the &quot;License&quot;); you may not use this file except in compliance with</span></span><br><span class=\"line\"><span class=\"comment\">  the License.  You may obtain a copy of the License at</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class=\"line\"><span class=\"comment\"></span></span><br><span class=\"line\"><span class=\"comment\">  Unless required by applicable law or agreed to in writing, software</span></span><br><span class=\"line\"><span class=\"comment\">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class=\"line\"><span class=\"comment\">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class=\"line\"><span class=\"comment\">  See the License for the specific language governing permissions and</span></span><br><span class=\"line\"><span class=\"comment\">  limitations under the License.</span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- <span class=\"doctag\">Note:</span>  A &quot;Server&quot; is not itself a &quot;Container&quot;, so you may not</span></span><br><span class=\"line\"><span class=\"comment\">     define subcomponents such as &quot;Valves&quot; at this level.</span></span><br><span class=\"line\"><span class=\"comment\">     Documentation at /docs/config/server.html</span></span><br><span class=\"line\"><span class=\"comment\"> --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Server</span> <span class=\"attr\">port</span>=<span class=\"string\">&quot;8005&quot;</span> <span class=\"attr\">shutdown</span>=<span class=\"string\">&quot;SHUTDOWN&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.startup.VersionLoggerListener&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- Security listener. Documentation at /docs/config/listeners.html</span></span><br><span class=\"line\"><span class=\"comment\">  &lt;Listener className=&quot;org.apache.catalina.security.SecurityListener&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  --&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!--APR library loader. Documentation at /docs/apr.html --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> <span class=\"attr\">SSLEngine</span>=<span class=\"string\">&quot;on&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- Prevent memory leaks due to use of particular java/javax APIs--&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- Global JNDI resources</span></span><br><span class=\"line\"><span class=\"comment\">       Documentation at /docs/jndi-resources-howto.html</span></span><br><span class=\"line\"><span class=\"comment\">  --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">GlobalNamingResources</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- Editable user database that can also be used by</span></span><br><span class=\"line\"><span class=\"comment\">         UserDatabaseRealm to authenticate users</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Resource</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;UserDatabase&quot;</span> <span class=\"attr\">auth</span>=<span class=\"string\">&quot;Container&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">type</span>=<span class=\"string\">&quot;org.apache.catalina.UserDatabase&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">description</span>=<span class=\"string\">&quot;User database that can be updated and saved&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">factory</span>=<span class=\"string\">&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">pathname</span>=<span class=\"string\">&quot;conf/tomcat-users.xml&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">GlobalNamingResources</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- A &quot;Service&quot; is a collection of one or more &quot;Connectors&quot; that share</span></span><br><span class=\"line\"><span class=\"comment\">       a single &quot;Container&quot; <span class=\"doctag\">Note:</span>  A &quot;Service&quot; is not itself a &quot;Container&quot;,</span></span><br><span class=\"line\"><span class=\"comment\">       so you may not define subcomponents such as &quot;Valves&quot; at this level.</span></span><br><span class=\"line\"><span class=\"comment\">       Documentation at /docs/config/service.html</span></span><br><span class=\"line\"><span class=\"comment\">   --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Service</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;Catalina&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--The connectors can use a shared executor, you can define one or more named thread pools--&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Executor name=&quot;tomcatThreadPool&quot; namePrefix=&quot;catalina-exec-&quot;</span></span><br><span class=\"line\"><span class=\"comment\">        maxThreads=&quot;150&quot; minSpareThreads=&quot;4&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- A &quot;Connector&quot; represents an endpoint by which requests are received</span></span><br><span class=\"line\"><span class=\"comment\">         and responses are returned. Documentation at :</span></span><br><span class=\"line\"><span class=\"comment\">         Java HTTP Connector: /docs/config/http.html</span></span><br><span class=\"line\"><span class=\"comment\">         Java AJP  Connector: /docs/config/ajp.html</span></span><br><span class=\"line\"><span class=\"comment\">         APR (HTTP/AJP) Connector: /docs/apr.html</span></span><br><span class=\"line\"><span class=\"comment\">         Define a non-SSL/TLS HTTP/1.1 Connector on port 8080</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">&quot;8080&quot;</span> <span class=\"attr\">protocol</span>=<span class=\"string\">&quot;HTTP/1.1&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">connectionTimeout</span>=<span class=\"string\">&quot;20000&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">redirectPort</span>=<span class=\"string\">&quot;8443&quot;</span> <span class=\"attr\">URIEncoding</span>=<span class=\"string\">&quot;UTF-8&quot;</span> <span class=\"attr\">relaxedPathChars</span>=<span class=\"string\">&quot;|&#123;&#125;[],%&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">relaxedQueryChars</span>=<span class=\"string\">&quot;|&#123;&#125;[],%&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- A &quot;Connector&quot; using the shared thread pool--&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Connector executor=&quot;tomcatThreadPool&quot;</span></span><br><span class=\"line\"><span class=\"comment\">               port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span></span><br><span class=\"line\"><span class=\"comment\">               connectionTimeout=&quot;20000&quot;</span></span><br><span class=\"line\"><span class=\"comment\">               redirectPort=&quot;8443&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- Define an SSL/TLS HTTP/1.1 Connector on port 8443</span></span><br><span class=\"line\"><span class=\"comment\">         This connector uses the NIO implementation. The default</span></span><br><span class=\"line\"><span class=\"comment\">         SSLImplementation will depend on the presence of the APR/native</span></span><br><span class=\"line\"><span class=\"comment\">         library and the useOpenSSL attribute of the</span></span><br><span class=\"line\"><span class=\"comment\">         AprLifecycleListener.</span></span><br><span class=\"line\"><span class=\"comment\">         Either JSSE or OpenSSL style configuration may be used regardless of</span></span><br><span class=\"line\"><span class=\"comment\">         the SSLImplementation selected. JSSE style configuration is used below.</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Connector port=&quot;8443&quot; protocol=&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span></span><br><span class=\"line\"><span class=\"comment\">               maxThreads=&quot;150&quot; SSLEnabled=&quot;true&quot;&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;SSLHostConfig&gt;</span></span><br><span class=\"line\"><span class=\"comment\">            &lt;Certificate certificateKeystoreFile=&quot;conf/localhost-rsa.jks&quot;</span></span><br><span class=\"line\"><span class=\"comment\">                         type=&quot;RSA&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;/SSLHostConfig&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    &lt;/Connector&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- Define an SSL/TLS HTTP/1.1 Connector on port 8443 with HTTP/2</span></span><br><span class=\"line\"><span class=\"comment\">         This connector uses the APR/native implementation which always uses</span></span><br><span class=\"line\"><span class=\"comment\">         OpenSSL for TLS.</span></span><br><span class=\"line\"><span class=\"comment\">         Either JSSE or OpenSSL style configuration may be used. OpenSSL style</span></span><br><span class=\"line\"><span class=\"comment\">         configuration is used below.</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Connector port=&quot;8443&quot; protocol=&quot;org.apache.coyote.http11.Http11AprProtocol&quot;</span></span><br><span class=\"line\"><span class=\"comment\">               maxThreads=&quot;150&quot; SSLEnabled=&quot;true&quot; &gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;UpgradeProtocol className=&quot;org.apache.coyote.http2.Http2Protocol&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;SSLHostConfig&gt;</span></span><br><span class=\"line\"><span class=\"comment\">            &lt;Certificate certificateKeyFile=&quot;conf/localhost-rsa-key.pem&quot;</span></span><br><span class=\"line\"><span class=\"comment\">                         certificateFile=&quot;conf/localhost-rsa-cert.pem&quot;</span></span><br><span class=\"line\"><span class=\"comment\">                         certificateChainFile=&quot;conf/localhost-rsa-chain.pem&quot;</span></span><br><span class=\"line\"><span class=\"comment\">                         type=&quot;RSA&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;/SSLHostConfig&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    &lt;/Connector&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Connector protocol=&quot;AJP/1.3&quot;</span></span><br><span class=\"line\"><span class=\"comment\">               address=&quot;::1&quot;</span></span><br><span class=\"line\"><span class=\"comment\">               port=&quot;8009&quot;</span></span><br><span class=\"line\"><span class=\"comment\">               redirectPort=&quot;8443&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- An Engine represents the entry point (within Catalina) that processes</span></span><br><span class=\"line\"><span class=\"comment\">         every request.  The Engine implementation for Tomcat stand alone</span></span><br><span class=\"line\"><span class=\"comment\">         analyzes the HTTP headers included with the request, and passes them</span></span><br><span class=\"line\"><span class=\"comment\">         on to the appropriate Host (virtual host).</span></span><br><span class=\"line\"><span class=\"comment\">         Documentation at /docs/config/engine.html --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- You should set jvmRoute to support load-balancing via AJP ie :</span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot; jvmRoute=&quot;jvm1&quot;&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Engine</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;Catalina&quot;</span> <span class=\"attr\">defaultHost</span>=<span class=\"string\">&quot;localhost&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">&lt;!--For clustering, please take a look at documentation at:</span></span><br><span class=\"line\"><span class=\"comment\">          /docs/cluster-howto.html  (simple how to)</span></span><br><span class=\"line\"><span class=\"comment\">          /docs/config/cluster.html (reference documentation) --&gt;</span></span><br><span class=\"line\">      <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">      &lt;Cluster className=&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">      --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">&lt;!-- Use the LockOutRealm to prevent attempts to guess user passwords</span></span><br><span class=\"line\"><span class=\"comment\">           via a brute-force attack --&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Realm</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- This Realm uses the UserDatabase configured in the global JNDI</span></span><br><span class=\"line\"><span class=\"comment\">             resources under the key &quot;UserDatabase&quot;.  Any edits</span></span><br><span class=\"line\"><span class=\"comment\">             that are performed against this UserDatabase are immediately</span></span><br><span class=\"line\"><span class=\"comment\">             available for use by the Realm.  --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Realm</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">resourceName</span>=<span class=\"string\">&quot;UserDatabase&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">Realm</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">Host</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;localhost&quot;</span>  <span class=\"attr\">appBase</span>=<span class=\"string\">&quot;webapps&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">            <span class=\"attr\">unpackWARs</span>=<span class=\"string\">&quot;true&quot;</span> <span class=\"attr\">autoDeploy</span>=<span class=\"string\">&quot;true&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- SingleSignOn valve, share authentication between web applications</span></span><br><span class=\"line\"><span class=\"comment\">             Documentation at: /docs/config/valve.html --&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">        &lt;Valve className=&quot;org.apache.catalina.authenticator.SingleSignOn&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">        --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- Access log processes all example.</span></span><br><span class=\"line\"><span class=\"comment\">             Documentation at: /docs/config/valve.html</span></span><br><span class=\"line\"><span class=\"comment\">             <span class=\"doctag\">Note:</span> The pattern used is equivalent to using pattern=&quot;common&quot; --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">Valve</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class=\"attr\">directory</span>=<span class=\"string\">&quot;logs&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">prefix</span>=<span class=\"string\">&quot;localhost_access_log&quot;</span> <span class=\"attr\">suffix</span>=<span class=\"string\">&quot;.txt&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">pattern</span>=<span class=\"string\">&quot;%h %l %u %t <span class=\"symbol\">&amp;quot;</span>%r<span class=\"symbol\">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">Host</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">Engine</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">Service</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Server</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<p>Catalina.createStartDigester</p>\n<ul>\n<li><p>创建Server实例<br></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Server的默认实现类org.apache.catalina.core.StandardServer,可以使用className指定自己的实现类</span></span><br><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.catalina.core.StandardServer&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setServer&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Server&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>创建全局J2EE企业命名上下文<br></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server/GlobalNamingResources&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.catalina.deploy.NamingResourcesImpl&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server/GlobalNamingResources&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/GlobalNamingResources&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setGlobalNamingResources&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.deploy.NamingResourcesImpl&quot;</span>);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">GlobalNamingResources</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- Editable user database that can also be used by</span></span><br><span class=\"line\"><span class=\"comment\">         UserDatabaseRealm to authenticate users</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">Resource</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;UserDatabase&quot;</span> <span class=\"attr\">auth</span>=<span class=\"string\">&quot;Container&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">type</span>=<span class=\"string\">&quot;org.apache.catalina.UserDatabase&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">description</span>=<span class=\"string\">&quot;User database that can be updated and saved&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">factory</span>=<span class=\"string\">&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">              <span class=\"attr\">pathname</span>=<span class=\"string\">&quot;conf/tomcat-users.xml&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">GlobalNamingResources</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Server添加生命周期监听器<br></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server/Listener&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server/Listener&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Listener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addLifecycleListener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.LifecycleListener&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 在Server初始化之前打印操作系统、JVM以及服务器的版本信息 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.startup.VersionLoggerListener&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- Security listener. Documentation at /docs/config/listeners.html</span></span><br><span class=\"line\"><span class=\"comment\">  &lt;Listener className=&quot;org.apache.catalina.security.SecurityListener&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">  --&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!--APR library loader. Documentation at /docs/apr.html --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 在Server初始化之前加载ARP库，并于Server停止之后销毁 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.core.AprLifecycleListener&quot;</span> <span class=\"attr\">SSLEngine</span>=<span class=\"string\">&quot;on&quot;</span> /&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- Prevent memory leaks due to use of particular java/javax APIs--&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 在Server初始化之前调用，以解决单例对象创建导致的JVM内存泄露问题以及锁文件问题  --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 在Server启动时，将JNDI资源注册为MBean进行管理 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 用于在Context停止时重建Executor池中的线程，避免导致内存泄漏 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">Listener</span> <span class=\"attr\">className</span>=<span class=\"string\">&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>构造Service实例<br></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Service的默认实现类org.apache.catalina.core.StandardService,可以使用className指定自己的实现类</span></span><br><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server/Service&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.catalina.core.StandardService&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server/Service&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Service&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addService&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Service&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Service添加生命周期监听器<br>默认情况下，Service下没有指定监听器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server/Service/Listener&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server/Service/Listener&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Service/Listener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addLifecycleListener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.LifecycleListener&quot;</span>);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>为Service添加Executor<br>Catalina共享Executor的级别为Service。Catalina默认情况下未配置Executor，即不共享</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 默认实现为org.apache.catalina.core.StandardThreadExecutor</span></span><br><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server/Service/Executor&quot;</span>,</span><br><span class=\"line\">                 <span class=\"string\">&quot;org.apache.catalina.core.StandardThreadExecutor&quot;</span>,</span><br><span class=\"line\">                 <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server/Service/Executor&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Service/Executor&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addExecutor&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Executor&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Service添加Connector<br></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addRule(<span class=\"string\">&quot;Server/Service/Connector&quot;</span>,</span><br><span class=\"line\">                 <span class=\"keyword\">new</span> ConnectorCreateRule());</span><br><span class=\"line\">digester.addRule(<span class=\"string\">&quot;Server/Service/Connector&quot;</span>,</span><br><span class=\"line\">                 <span class=\"keyword\">new</span> SetAllPropertiesRule(<span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;executor&quot;</span>, <span class=\"string\">&quot;sslImplementationName&quot;</span>&#125;));</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Service/Connector&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addConnector&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.connector.Connector&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Connector</span> <span class=\"attr\">port</span>=<span class=\"string\">&quot;8080&quot;</span> <span class=\"attr\">protocol</span>=<span class=\"string\">&quot;HTTP/1.1&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">connectionTimeout</span>=<span class=\"string\">&quot;20000&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">               <span class=\"attr\">redirectPort</span>=<span class=\"string\">&quot;8443&quot;</span> <span class=\"attr\">URIEncoding</span>=<span class=\"string\">&quot;UTF-8&quot;</span> <span class=\"attr\">relaxedPathChars</span>=<span class=\"string\">&quot;|&#123;&#125;[],%&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">relaxedQueryChars</span>=<span class=\"string\">&quot;|&#123;&#125;[],%&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Connector添加虚拟主机SSL配置<br></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.tomcat.util.net.SSLHostConfig&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;addSslHostConfig&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;org.apache.tomcat.util.net.SSLHostConfig&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">digester.addRule(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig/Certificate&quot;</span>,</span><br><span class=\"line\">                 <span class=\"keyword\">new</span> CertificateCreateRule());</span><br><span class=\"line\">digester.addRule(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig/Certificate&quot;</span>,</span><br><span class=\"line\">                 <span class=\"keyword\">new</span> SetAllPropertiesRule(<span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;type&quot;</span>&#125;));</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig/Certificate&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addCertificate&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.tomcat.util.net.SSLHostConfigCertificate&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.tomcat.util.net.openssl.OpenSSLConf&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setOpenSslConf&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.tomcat.util.net.openssl.OpenSSLConf&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf/OpenSSLConfCmd&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.tomcat.util.net.openssl.OpenSSLConfCmd&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf/OpenSSLConfCmd&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Service/Connector/SSLHostConfig/OpenSSLConf/OpenSSLConfCmd&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addCmd&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.tomcat.util.net.openssl.OpenSSLConfCmd&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Connector添加生命周期监听器<br></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server/Service/Connector/Listener&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server/Service/Connector/Listener&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Service/Connector/Listener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addLifecycleListener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.LifecycleListener&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Connector添加升级协议<br></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(<span class=\"string\">&quot;Server/Service/Connector/UpgradeProtocol&quot;</span>,</span><br><span class=\"line\">                                  <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                                  <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(<span class=\"string\">&quot;Server/Service/Connector/UpgradeProtocol&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(<span class=\"string\">&quot;Server/Service/Connector/UpgradeProtocol&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addUpgradeProtocol&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.coyote.UpgradeProtocol&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>添加子元素解析规则</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addRuleSet(<span class=\"keyword\">new</span> NamingRuleSet(<span class=\"string\">&quot;Server/GlobalNamingResources/&quot;</span>));</span><br><span class=\"line\">digester.addRuleSet(<span class=\"keyword\">new</span> EngineRuleSet(<span class=\"string\">&quot;Server/Service/&quot;</span>));</span><br><span class=\"line\">digester.addRuleSet(<span class=\"keyword\">new</span> HostRuleSet(<span class=\"string\">&quot;Server/Service/Engine/&quot;</span>));</span><br><span class=\"line\">digester.addRuleSet(<span class=\"keyword\">new</span> ContextRuleSet(<span class=\"string\">&quot;Server/Service/Engine/Host/&quot;</span>));</span><br><span class=\"line\">addClusterRuleSet(digester, <span class=\"string\">&quot;Server/Service/Engine/Host/Cluster/&quot;</span>);</span><br><span class=\"line\">digester.addRuleSet(<span class=\"keyword\">new</span> NamingRuleSet(<span class=\"string\">&quot;Server/Service/Engine/Host/Context/&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// When the &#x27;engine&#x27; is found, set the parentClassLoader.</span></span><br><span class=\"line\">digester.addRule(<span class=\"string\">&quot;Server/Service/Engine&quot;</span>,</span><br><span class=\"line\">                 <span class=\"keyword\">new</span> SetParentClassLoaderRule(parentClassLoader));</span><br><span class=\"line\">addClusterRuleSet(digester, <span class=\"string\">&quot;Server/Service/Engine/Cluster/&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"Engine的解析\"><a href=\"#Engine的解析\" class=\"headerlink\" title=\"Engine的解析\"></a>Engine的解析</h4><p>EngineRuleSet类中包含了Engine的解析过程</p>\n<ul>\n<li><p>创建Engine实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//Catalina默认实现org.apache.catalina.core.StandardEngine</span></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Engine&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.catalina.core.StandardEngine&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Engine&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">//为Engine添加生命周期监听器EngineConfig,用于打印启动和停止日志，默认的监听器，不是由server.xml配置</span></span><br><span class=\"line\">digester.addRule(prefix + <span class=\"string\">&quot;Engine&quot;</span>,</span><br><span class=\"line\">                 <span class=\"keyword\">new</span> LifecycleListenerRule</span><br><span class=\"line\">                 (<span class=\"string\">&quot;org.apache.catalina.startup.EngineConfig&quot;</span>,</span><br><span class=\"line\">                  <span class=\"string\">&quot;engineConfigClass&quot;</span>));</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Engine&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setContainer&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Engine&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Engine添加集群配置</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Engine/Cluster&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Engine/Cluster&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Engine/Cluster&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setCluster&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Cluster&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Engine添加生命周期监听器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 由server.xml配置</span></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Engine/Listener&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Engine/Listener&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Engine/Listener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addLifecycleListener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.LifecycleListener&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Engine添加安全配置</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addRuleSet(<span class=\"keyword\">new</span> RealmRuleSet(prefix + <span class=\"string\">&quot;Engine/&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Engine/Valve&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Engine/Valve&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Engine/Valve&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addValve&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Valve&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"Host的解析\"><a href=\"#Host的解析\" class=\"headerlink\" title=\"Host的解析\"></a>Host的解析</h4><p>HostRuleSet中包含了Host的解析</p>\n<ul>\n<li><p>创建Host实例</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//catalina默认实现为org.apache.catalina.core.StandardHost</span></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Host&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.catalina.core.StandardHost&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Host&quot;</span>);</span><br><span class=\"line\">digester.addRule(prefix + <span class=\"string\">&quot;Host&quot;</span>,</span><br><span class=\"line\">                 <span class=\"keyword\">new</span> CopyParentClassLoaderRule());</span><br><span class=\"line\"><span class=\"comment\">//添加生命周期，默认添加，不是由server.xml控制的</span></span><br><span class=\"line\">digester.addRule(prefix + <span class=\"string\">&quot;Host&quot;</span>,</span><br><span class=\"line\">                 <span class=\"keyword\">new</span> LifecycleListenerRule</span><br><span class=\"line\">                 (<span class=\"string\">&quot;org.apache.catalina.startup.HostConfig&quot;</span>,</span><br><span class=\"line\">                  <span class=\"string\">&quot;hostConfigClass&quot;</span>));</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Host&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addChild&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Container&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 设置别名</span></span><br><span class=\"line\">digester.addCallMethod(prefix + <span class=\"string\">&quot;Host/Alias&quot;</span>,</span><br><span class=\"line\">                       <span class=\"string\">&quot;addAlias&quot;</span>, <span class=\"number\">0</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Host添加集群</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Host/Cluster&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Host/Cluster&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Host/Cluster&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setCluster&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Cluster&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Host添加生命周期</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Host/Listener&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Host/Listener&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Host/Listener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addLifecycleListener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.LifecycleListener&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Host添加安全配置</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addRuleSet(<span class=\"keyword\">new</span> RealmRuleSet(prefix + <span class=\"string\">&quot;Host/&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Host/Valve&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Host/Valve&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Host/Valve&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addValve&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Valve&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h4 id=\"Context的解析\"><a href=\"#Context的解析\" class=\"headerlink\" title=\"Context的解析\"></a>Context的解析</h4><p>ContextRuleSet类中包含Context的解析</p>\n<p>Catalina中Context配置并非来源于一处，此处仅介绍server.xm中的配置，大多数情况下，不需要再server.xml中配置Context，而是由HostConfig自动扫描部署目录，以context.xml文件为基础进行解析创建。</p>\n<ul>\n<li><p>Context实例化</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//使用server.xml创建时，create为true；通过HostConfig创建时create为false</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (create) &#123;</span><br><span class=\"line\">    digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;org.apache.catalina.core.StandardContext&quot;</span>, <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">    digester.addSetProperties(prefix + <span class=\"string\">&quot;Context&quot;</span>);</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    digester.addRule(prefix + <span class=\"string\">&quot;Context&quot;</span>, <span class=\"keyword\">new</span> SetContextPropertiesRule());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (create) &#123;</span><br><span class=\"line\">    digester.addRule(prefix + <span class=\"string\">&quot;Context&quot;</span>,</span><br><span class=\"line\">                     <span class=\"keyword\">new</span> LifecycleListenerRule</span><br><span class=\"line\">                         (<span class=\"string\">&quot;org.apache.catalina.startup.ContextConfig&quot;</span>,</span><br><span class=\"line\">                          <span class=\"string\">&quot;configClass&quot;</span>));</span><br><span class=\"line\">    digester.addSetNext(prefix + <span class=\"string\">&quot;Context&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;addChild&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;org.apache.catalina.Container&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Context添加生命周期监听器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Listener&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Listener&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Listener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addLifecycleListener&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.LifecycleListener&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Context指定类加载器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//默认为org.apache.catalina.loader.WebappLoader</span></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Loader&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.loader.WebappLoader&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Loader&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Loader&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setLoader&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Loader&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>位Context添加会话管理器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 默认为org.apache.catalina.session.StandardManager</span></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Manager&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.catalina.session.StandardManager&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Manager&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Manager&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setManager&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Manager&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">// 指定会话存储方式</span></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Manager/Store&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Manager/Store&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Manager/Store&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setStore&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Store&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">//指定会话标识生成器</span></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Manager/SessionIdGenerator&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.catalina.util.StandardSessionIdGenerator&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Manager/SessionIdGenerator&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Manager/SessionIdGenerator&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setSessionIdGenerator&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.SessionIdGenerator&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Context添加初始化参数</p>\n<p>可以在context.xml文件中添加初始化参数，已实现所有Web应用中的复用，而不必每个Web应用重复配置</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Parameter&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.tomcat.util.descriptor.web.ApplicationParameter&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Parameter&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Parameter&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addApplicationParameter&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.tomcat.util.descriptor.web.ApplicationParameter&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Context添加安全配置以及Web资源配置</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addRuleSet(<span class=\"keyword\">new</span> RealmRuleSet(prefix + <span class=\"string\">&quot;Context/&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Resources&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.catalina.webresources.StandardRoot&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Resources&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Resources&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setResources&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.WebResourceRoot&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Resources/PreResources&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Resources/PreResources&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Resources/PreResources&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addPreResources&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.WebResourceSet&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Resources/JarResources&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Resources/JarResources&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Resources/JarResources&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addJarResources&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.WebResourceSet&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Resources/PostResources&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Resources/PostResources&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Resources/PostResources&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addPostResources&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.WebResourceSet&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Context添加资源链接</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//用于J2EE命名服务</span></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/ResourceLink&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;org.apache.tomcat.util.descriptor.web.ContextResourceLink&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/ResourceLink&quot;</span>);</span><br><span class=\"line\">digester.addRule(prefix + <span class=\"string\">&quot;Context/ResourceLink&quot;</span>,</span><br><span class=\"line\">        <span class=\"keyword\">new</span> SetNextNamingRule(<span class=\"string\">&quot;addResourceLink&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;org.apache.tomcat.util.descriptor.web.ContextResourceLink&quot;</span>));</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Context添加拦截器Value</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/Valve&quot;</span>,</span><br><span class=\"line\">                         <span class=\"keyword\">null</span>, <span class=\"comment\">// MUST be specified in the element</span></span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/Valve&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/Valve&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;addValve&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.catalina.Valve&quot;</span>);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为Context添加守护资源配置</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- context.xml --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">Context</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- Default set of monitored resources. If one of these changes, the    --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- web application will be reloaded.                                   --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">WatchedResource</span>&gt;</span>WEB-INF/web.xml<span class=\"tag\">&lt;/<span class=\"name\">WatchedResource</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">WatchedResource</span>&gt;</span>$&#123;catalina.base&#125;/conf/web.xml<span class=\"tag\">&lt;/<span class=\"name\">WatchedResource</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- Uncomment this to disable session persistence across Tomcat restarts --&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!--</span></span><br><span class=\"line\"><span class=\"comment\">    &lt;Manager pathname=&quot;&quot; /&gt;</span></span><br><span class=\"line\"><span class=\"comment\">    --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n\n</li>\n</ul>\n  <figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//WatchedResource标签用于为Context添加监视器，当这些资源发生变更时，Web应用将会被重新加载，默认为WEB-INF/web.xml</span></span><br><span class=\"line\">digester.addCallMethod(prefix + <span class=\"string\">&quot;Context/WatchedResource&quot;</span>,</span><br><span class=\"line\">                       <span class=\"string\">&quot;addWatchedResource&quot;</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"comment\">//WrapperLifecycle标签用于为Context添加一个生命周期监听器，此类的实例并非添加到Context上，而是添加到Context包含的Wrapper上</span></span><br><span class=\"line\">digester.addCallMethod(prefix + <span class=\"string\">&quot;Context/WrapperLifecycle&quot;</span>,</span><br><span class=\"line\">                       <span class=\"string\">&quot;addWrapperLifecycle&quot;</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"comment\">//WrapperListener标签用于为Context添加一个容器监听类，添加到Wrapper上</span></span><br><span class=\"line\">digester.addCallMethod(prefix + <span class=\"string\">&quot;Context/WrapperListener&quot;</span>,</span><br><span class=\"line\">                       <span class=\"string\">&quot;addWrapperListener&quot;</span>, <span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"comment\">//JarScanner标签用于为Context添加一个Jar扫描器</span></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/JarScanner&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.tomcat.util.scan.StandardJarScanner&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/JarScanner&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/JarScanner&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setJarScanner&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.tomcat.JarScanner&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">//JarScanFilter为JarScanner指定一个过滤器</span></span><br><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/JarScanner/JarScanFilter&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.tomcat.util.scan.StandardJarScanFilter&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/JarScanner/JarScanFilter&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/JarScanner/JarScanFilter&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setJarScanFilter&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.tomcat.JarScanFilter&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>为Context添加Cookie处理器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">digester.addObjectCreate(prefix + <span class=\"string\">&quot;Context/CookieProcessor&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;org.apache.tomcat.util.http.Rfc6265CookieProcessor&quot;</span>,</span><br><span class=\"line\">                         <span class=\"string\">&quot;className&quot;</span>);</span><br><span class=\"line\">digester.addSetProperties(prefix + <span class=\"string\">&quot;Context/CookieProcessor&quot;</span>);</span><br><span class=\"line\">digester.addSetNext(prefix + <span class=\"string\">&quot;Context/CookieProcessor&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;setCookieProcessor&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;org.apache.tomcat.util.http.CookieProcessor&quot;</span>);</span><br></pre></td></tr></table></figure></li>\n</ul>\n","categories":["tomcat"],"tags":["tomcat"]},{"title":"mybatis全局配置文件","url":"/2021/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E5%85%A8%E5%B1%80%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/","content":"<h2 id=\"Mybatis全局配置文件\"><a href=\"#Mybatis全局配置文件\" class=\"headerlink\" title=\"Mybatis全局配置文件\"></a>Mybatis全局配置文件</h2><h3 id=\"配置properties\"><a href=\"#配置properties\" class=\"headerlink\" title=\"配置properties\"></a>配置properties</h3><p>可以在全局配置文件中配置properties标签来进行外部配置</p>\n<p>设置属性的方式有三种</p>\n<ul>\n<li><p>在properties的属性节点resource或url所指定的资源文件中配置</p>\n</li>\n<li><p>在properties的子节点property中配置</p>\n</li>\n<li><p>在构建SqlSessionFactory时通过方法传入参数</p>\n</li>\n</ul>\n<a id=\"more\"></a>\n\n<h4 id=\"外部配置文件引入\"><a href=\"#外部配置文件引入\" class=\"headerlink\" title=\"外部配置文件引入\"></a>外部配置文件引入</h4><figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">jdbc.driver</span>=<span class=\"string\">com.mysql.jdbc.Driver</span></span><br><span class=\"line\"><span class=\"meta\">jdbc.url</span>=<span class=\"string\">jdbc:mysql://localhost:3306/test</span></span><br><span class=\"line\"><span class=\"meta\">jdbc.username</span>=<span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"meta\">jdbc.password</span>=<span class=\"string\">123456</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 使用 properties来引入外部配置文件内容--&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- resource  引入类路径下的资源</span></span><br><span class=\"line\"><span class=\"comment\">     url  引入网路或磁盘路径下的资源</span></span><br><span class=\"line\"><span class=\"comment\"> --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">properties</span> <span class=\"attr\">resource</span>=<span class=\"string\">&quot;jdbc.properties&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 数据库配置 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">environments</span> <span class=\"attr\">default</span>=<span class=\"string\">&quot;development&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">environment</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;development&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">transactionManager</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dataSource</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;POOLED&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;driver&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;url&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dataSource</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">environment</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">environments</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"property子节点配置\"><a href=\"#property子节点配置\" class=\"headerlink\" title=\"property子节点配置\"></a>property子节点配置</h4><figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 也可以使用property子节点来进行配置 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">properties</span> <span class=\"attr\">resource</span>=<span class=\"string\">&quot;jdbc.properties&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;jdbc.password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123456&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 启用默认值特性 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;org.apache.ibatis.parsing.PropertyParser.enable-default-value&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 修改默认值的分隔符 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;org.apache.ibatis.parsing.PropertyParser.default-value-separator&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;?:&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">properties</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 数据库配置 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">environments</span> <span class=\"attr\">default</span>=<span class=\"string\">&quot;development&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">environment</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;development&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">transactionManager</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dataSource</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;POOLED&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;driver&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;url&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!-- 可以使用:来为占位符设置默认值，如果没有读取到该属性的值，会使用该默认值</span></span><br><span class=\"line\"><span class=\"comment\">             该特性默认关闭，需要配置        &lt;property name=&quot;org.apache.ibatis.parsing.PropertyParser.enable-default-value&quot; value=&quot;true&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">             如果开启该特性，默认使用:分隔</span></span><br><span class=\"line\"><span class=\"comment\">             可以使用         &lt;property name=&quot;org.apache.ibatis.parsing.PropertyParser.default-value-separator&quot; value=&quot;?:&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">             来修改默认分隔符</span></span><br><span class=\"line\"><span class=\"comment\">             --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.password?:123456&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dataSource</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">environment</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">environments</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"实例化时方法传参\"><a href=\"#实例化时方法传参\" class=\"headerlink\" title=\"实例化时方法传参\"></a>实例化时方法传参</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> SqlSessionFactory <span class=\"title\">createFactory</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 获取到mybatis-config.xml配置文件，进而构建SqlSessionFactory</span></span><br><span class=\"line\">    InputStream is = Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class=\"string\">&quot;mybatis-config.xml&quot;</span>);</span><br><span class=\"line\">    Properties props = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">    props.put(<span class=\"string\">&quot;jdbc.password&quot;</span>,<span class=\"string\">&quot;123456&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> SqlSessionFactoryBuilder().build(is,props);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"三种方式的顺序\"><a href=\"#三种方式的顺序\" class=\"headerlink\" title=\"三种方式的顺序\"></a>三种方式的顺序</h4><ul>\n<li>首先读取property子节点中指定的属性</li>\n<li>再读取使用resources或url引入的外部配置文件中属性，并覆盖之前的同名属性</li>\n<li>最后读取作为方法传递的参数，并覆盖之前的同名属性</li>\n</ul>\n<h3 id=\"配置settings\"><a href=\"#配置settings\" class=\"headerlink\" title=\"配置settings\"></a>配置settings</h3><p>进行mybatis的自定义设置</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">设置名</th>\n<th align=\"left\">描述</th>\n<th align=\"left\">有效值</th>\n<th align=\"left\">默认值</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">cacheEnabled</td>\n<td align=\"left\">全局性地开启或关闭所有映射器配置文件中已配置的任何缓存。</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">true</td>\n</tr>\n<tr>\n<td align=\"left\">lazyLoadingEnabled</td>\n<td align=\"left\">延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。 特定关联关系中可通过设置 <code>fetchType</code> 属性来覆盖该项的开关状态。</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">false</td>\n</tr>\n<tr>\n<td align=\"left\">aggressiveLazyLoading</td>\n<td align=\"left\">开启时，任一方法的调用都会加载该对象的所有延迟加载属性。 否则，每个延迟加载属性会按需加载（参考 <code>lazyLoadTriggerMethods</code>)。</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">false （在 3.4.1 及之前的版本中默认为 true）</td>\n</tr>\n<tr>\n<td align=\"left\">multipleResultSetsEnabled</td>\n<td align=\"left\">是否允许单个语句返回多结果集（需要数据库驱动支持）。</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">true</td>\n</tr>\n<tr>\n<td align=\"left\">useColumnLabel</td>\n<td align=\"left\">使用列标签代替列名。实际表现依赖于数据库驱动，具体可参考数据库驱动的相关文档，或通过对比测试来观察。</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">true</td>\n</tr>\n<tr>\n<td align=\"left\">useGeneratedKeys</td>\n<td align=\"left\">允许 JDBC 支持自动生成主键，需要数据库驱动支持。如果设置为 true，将强制使用自动生成主键。尽管一些数据库驱动不支持此特性，但仍可正常工作（如 Derby）。</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">False</td>\n</tr>\n<tr>\n<td align=\"left\">autoMappingBehavior</td>\n<td align=\"left\">指定 MyBatis 应如何自动映射列到字段或属性。 NONE 表示关闭自动映射；PARTIAL 只会自动映射没有定义嵌套结果映射的字段。 FULL 会自动映射任何复杂的结果集（无论是否嵌套）。</td>\n<td align=\"left\">NONE, PARTIAL, FULL</td>\n<td align=\"left\">PARTIAL</td>\n</tr>\n<tr>\n<td align=\"left\">autoMappingUnknownColumnBehavior</td>\n<td align=\"left\">指定发现自动映射目标未知列（或未知属性类型）的行为。<code>NONE</code>: 不做任何反应<code>WARNING</code>: 输出警告日志（<code>&#39;org.apache.ibatis.session.AutoMappingUnknownColumnBehavior&#39;</code> 的日志等级必须设置为 <code>WARN</code>）<code>FAILING</code>: 映射失败 (抛出 <code>SqlSessionException</code>)</td>\n<td align=\"left\">NONE, WARNING, FAILING</td>\n<td align=\"left\">NONE</td>\n</tr>\n<tr>\n<td align=\"left\">defaultExecutorType</td>\n<td align=\"left\">配置默认的执行器。SIMPLE 就是普通的执行器；REUSE 执行器会重用预处理语句（PreparedStatement）； BATCH 执行器不仅重用语句还会执行批量更新。</td>\n<td align=\"left\">SIMPLE REUSE BATCH</td>\n<td align=\"left\">SIMPLE</td>\n</tr>\n<tr>\n<td align=\"left\">defaultStatementTimeout</td>\n<td align=\"left\">设置超时时间，它决定数据库驱动等待数据库响应的秒数。</td>\n<td align=\"left\">任意正整数</td>\n<td align=\"left\">未设置 (null)</td>\n</tr>\n<tr>\n<td align=\"left\">defaultFetchSize</td>\n<td align=\"left\">为驱动的结果集获取数量（fetchSize）设置一个建议值。此参数只可以在查询设置中被覆盖。</td>\n<td align=\"left\">任意正整数</td>\n<td align=\"left\">未设置 (null)</td>\n</tr>\n<tr>\n<td align=\"left\">defaultResultSetType</td>\n<td align=\"left\">指定语句默认的滚动策略。（新增于 3.5.2）</td>\n<td align=\"left\">FORWARD_ONLY | SCROLL_SENSITIVE | SCROLL_INSENSITIVE | DEFAULT（等同于未设置）</td>\n<td align=\"left\">未设置 (null)</td>\n</tr>\n<tr>\n<td align=\"left\">safeRowBoundsEnabled</td>\n<td align=\"left\">是否允许在嵌套语句中使用分页（RowBounds）。如果允许使用则设置为 false。</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">False</td>\n</tr>\n<tr>\n<td align=\"left\">safeResultHandlerEnabled</td>\n<td align=\"left\">是否允许在嵌套语句中使用结果处理器（ResultHandler）。如果允许使用则设置为 false。</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">True</td>\n</tr>\n<tr>\n<td align=\"left\">mapUnderscoreToCamelCase</td>\n<td align=\"left\">是否开启驼峰命名自动映射，即从经典数据库列名 A_COLUMN 映射到经典 Java 属性名 aColumn。</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">False</td>\n</tr>\n<tr>\n<td align=\"left\">localCacheScope</td>\n<td align=\"left\">MyBatis 利用本地缓存机制（Local Cache）防止循环引用和加速重复的嵌套查询。 默认值为 SESSION，会缓存一个会话中执行的所有查询。 若设置值为 STATEMENT，本地缓存将仅用于执行语句，对相同 SqlSession 的不同查询将不会进行缓存。</td>\n<td align=\"left\">SESSION | STATEMENT</td>\n<td align=\"left\">SESSION</td>\n</tr>\n<tr>\n<td align=\"left\">jdbcTypeForNull</td>\n<td align=\"left\">当没有为参数指定特定的 JDBC 类型时，空值的默认 JDBC 类型。 某些数据库驱动需要指定列的 JDBC 类型，多数情况直接用一般类型即可，比如 NULL、VARCHAR 或 OTHER。</td>\n<td align=\"left\">JdbcType 常量，常用值：NULL、VARCHAR 或 OTHER。</td>\n<td align=\"left\">OTHER</td>\n</tr>\n<tr>\n<td align=\"left\">lazyLoadTriggerMethods</td>\n<td align=\"left\">指定对象的哪些方法触发一次延迟加载。</td>\n<td align=\"left\">用逗号分隔的方法列表。</td>\n<td align=\"left\">equals,clone,hashCode,toString</td>\n</tr>\n<tr>\n<td align=\"left\">defaultScriptingLanguage</td>\n<td align=\"left\">指定动态 SQL 生成使用的默认脚本语言。</td>\n<td align=\"left\">一个类型别名或全限定类名。</td>\n<td align=\"left\">org.apache.ibatis.scripting.xmltags.XMLLanguageDriver</td>\n</tr>\n<tr>\n<td align=\"left\">defaultEnumTypeHandler</td>\n<td align=\"left\">指定 Enum 使用的默认 <code>TypeHandler</code> 。（新增于 3.4.5）</td>\n<td align=\"left\">一个类型别名或全限定类名。</td>\n<td align=\"left\">org.apache.ibatis.type.EnumTypeHandler</td>\n</tr>\n<tr>\n<td align=\"left\">callSettersOnNulls</td>\n<td align=\"left\">指定当结果集中值为 null 的时候是否调用映射对象的 setter（map 对象时为 put）方法，这在依赖于 Map.keySet() 或 null 值进行初始化时比较有用。注意基本类型（int、boolean 等）是不能设置成 null 的。</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">false</td>\n</tr>\n<tr>\n<td align=\"left\">returnInstanceForEmptyRow</td>\n<td align=\"left\">当返回行的所有列都是空时，MyBatis默认返回 <code>null</code>。 当开启这个设置时，MyBatis会返回一个空实例。 请注意，它也适用于嵌套的结果集（如集合或关联）。（新增于 3.4.2）</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">false</td>\n</tr>\n<tr>\n<td align=\"left\">logPrefix</td>\n<td align=\"left\">指定 MyBatis 增加到日志名称的前缀。</td>\n<td align=\"left\">任何字符串</td>\n<td align=\"left\">未设置</td>\n</tr>\n<tr>\n<td align=\"left\">logImpl</td>\n<td align=\"left\">指定 MyBatis 所用日志的具体实现，未指定时将自动查找。</td>\n<td align=\"left\">SLF4J | LOG4J | LOG4J2 | JDK_LOGGING | COMMONS_LOGGING | STDOUT_LOGGING | NO_LOGGING</td>\n<td align=\"left\">未设置</td>\n</tr>\n<tr>\n<td align=\"left\">proxyFactory</td>\n<td align=\"left\">指定 Mybatis 创建可延迟加载对象所用到的代理工具。</td>\n<td align=\"left\">CGLIB | JAVASSIST</td>\n<td align=\"left\">JAVASSIST （MyBatis 3.3 以上）</td>\n</tr>\n<tr>\n<td align=\"left\">vfsImpl</td>\n<td align=\"left\">指定 VFS 的实现</td>\n<td align=\"left\">自定义 VFS 的实现的类全限定名，以逗号分隔。</td>\n<td align=\"left\">未设置</td>\n</tr>\n<tr>\n<td align=\"left\">useActualParamName</td>\n<td align=\"left\">允许使用方法签名中的名称作为语句参数名称。 为了使用该特性，你的项目必须采用 Java 8 编译，并且加上 <code>-parameters</code> 选项。（新增于 3.4.1）</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">true</td>\n</tr>\n<tr>\n<td align=\"left\">configurationFactory</td>\n<td align=\"left\">指定一个提供 <code>Configuration</code> 实例的类。 这个被返回的 Configuration 实例用来加载被反序列化对象的延迟加载属性值。 这个类必须包含一个签名为<code>static Configuration getConfiguration()</code> 的方法。（新增于 3.2.3）</td>\n<td align=\"left\">一个类型别名或完全限定类名。</td>\n<td align=\"left\">未设置</td>\n</tr>\n<tr>\n<td align=\"left\">shrinkWhitespacesInSql</td>\n<td align=\"left\">从SQL中删除多余的空格字符。请注意，这也会影响SQL中的文字字符串。 (新增于 3.5.5)</td>\n<td align=\"left\">true | false</td>\n<td align=\"left\">false</td>\n</tr>\n<tr>\n<td align=\"left\">defaultSqlProviderType</td>\n<td align=\"left\">Specifies an sql provider class that holds provider method (Since 3.5.6). This class apply to the <code>type</code>(or <code>value</code>) attribute on sql provider annotation(e.g. <code>@SelectProvider</code>), when these attribute was omitted.</td>\n<td align=\"left\">A type alias or fully qualified class name</td>\n<td align=\"left\">Not set</td>\n</tr>\n</tbody></table>\n<h3 id=\"配置typeAliases类型别名\"><a href=\"#配置typeAliases类型别名\" class=\"headerlink\" title=\"配置typeAliases类型别名\"></a>配置typeAliases类型别名</h3><p>类型别名可以为java类型设置别名，之后使用全类名时可以使用别名</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">typeAliases</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- typeAlias为某个类起别名 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">typeAlias</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model.User&quot;</span> <span class=\"attr\">alias</span>=<span class=\"string\">&quot;User&quot;</span>/&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 为某个包下所有类批量起别名</span></span><br><span class=\"line\"><span class=\"comment\">        默认值为类名首字母小写</span></span><br><span class=\"line\"><span class=\"comment\">     --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">package</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.model&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>也可以在类上使用@Alias注解来设置该类的别名</p>\n<h3 id=\"配置类型处理器typeHandlers\"><a href=\"#配置类型处理器typeHandlers\" class=\"headerlink\" title=\"配置类型处理器typeHandlers\"></a>配置类型处理器typeHandlers</h3><p>数据库类型和java类型进行转换</p>\n<p>实现 org.apache.ibatis.type.TypeHandler 接口， 或继承 org.apache.ibatis.type.BaseTypeHandler， 并且可以将它映射到一个 JDBC 类型</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@MappedJdbcTypes(JdbcType.VARCHAR)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExampleTypeHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseTypeHandler</span>&lt;<span class=\"title\">String</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setNonNullParameter</span><span class=\"params\">(PreparedStatement ps, <span class=\"keyword\">int</span> i, String parameter, JdbcType jdbcType)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    ps.setString(i, parameter);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getNullableResult</span><span class=\"params\">(ResultSet rs, String columnName)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> rs.getString(columnName);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getNullableResult</span><span class=\"params\">(ResultSet rs, <span class=\"keyword\">int</span> columnIndex)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> rs.getString(columnIndex);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getNullableResult</span><span class=\"params\">(CallableStatement cs, <span class=\"keyword\">int</span> columnIndex)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> cs.getString(columnIndex);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">typeHandlers</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">typeHandler</span> <span class=\"attr\">handler</span>=<span class=\"string\">&quot;org.mybatis.example.ExampleTypeHandler&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">typeHandlers</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置插件plugins\"><a href=\"#配置插件plugins\" class=\"headerlink\" title=\"配置插件plugins\"></a>配置插件plugins</h3><p>mybatis可以使用插件来在映射语句执行过程中的某一点进行拦截调用，包括</p>\n<ul>\n<li>Executor (update、query、flushStatements、commit、rollback、getTransaction、close、isClose)</li>\n<li>ParameterHandler (getParameterObject、setParameters)</li>\n<li>ResultSetHandler (handleResultSets、handleOutputParameters)</li>\n<li>StatementHandler (prepare、parameterize、batch、update、query)</li>\n</ul>\n<p>需要实现Interceptor接口，并指定想要拦截的方法签名来使用插件</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">Intercepts(&#123;<span class=\"meta\">@Signature(</span></span><br><span class=\"line\"><span class=\"meta\">  type= Executor.class,</span></span><br><span class=\"line\"><span class=\"meta\">  method = &quot;update&quot;,</span></span><br><span class=\"line\"><span class=\"meta\">  args = &#123;MappedStatement.class,Object.class&#125;)</span>&#125;)</span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExamplePlugin</span> <span class=\"keyword\">implements</span> <span class=\"title\">Interceptor</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> Properties properties = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">intercept</span><span class=\"params\">(Invocation invocation)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// implement pre processing if need</span></span><br><span class=\"line\">    Object returnObject = invocation.proceed();</span><br><span class=\"line\">    <span class=\"comment\">// implement post processing if need</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> returnObject;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setProperties</span><span class=\"params\">(Properties properties)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.properties = properties;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plugins</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">plugin</span> <span class=\"attr\">interceptor</span>=<span class=\"string\">&quot;org.mybatis.example.ExamplePlugin&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;someProperty&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;100&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">plugin</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意：如果有多个插件拦截相同方法的时候，会按照配置的先后顺序来进行包装代理，在执行时会执行最外层的插件，也就是逆向执行</p>\n</blockquote>\n<h3 id=\"配置环境environments\"><a href=\"#配置环境environments\" class=\"headerlink\" title=\"配置环境environments\"></a>配置环境environments</h3><p>mybatis可以配置多个环境，可以连接多个数据库，但是每个SqlSessionFactory实例只可以选择一种环境</p>\n<p>在构建sqlSessionFactory的时候可以指定选择创建哪个环境</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">SqlSessionFactory factory = <span class=\"keyword\">new</span> SqlSessionFactoryBuilder().build(reader, environment);</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 环境 default表示默认使用环境  --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">environments</span> <span class=\"attr\">default</span>=<span class=\"string\">&quot;development&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">environment</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;development&quot;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 事务管理器有两种类型</span></span><br><span class=\"line\"><span class=\"comment\">            1、JDBC  该配置直接使用了JDBC的提交和回滚，依赖从数据源获得的连接来管理事务作用域</span></span><br><span class=\"line\"><span class=\"comment\">            2、MANAGED 使用容器来管理事务的整个生命周期(spring会使用自带的管理器，不需要配置mybatis的事务管理器)</span></span><br><span class=\"line\"><span class=\"comment\">         --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">transactionManager</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"comment\">&lt;!-- 数据源有三种类型</span></span><br><span class=\"line\"><span class=\"comment\">            1、UNPOOLED  每次请求时打开和关闭连接</span></span><br><span class=\"line\"><span class=\"comment\">                额外属性  - defaultTransactionIsolationLevel  默认的连接事务隔离级别</span></span><br><span class=\"line\"><span class=\"comment\">                         - defaultNetworkTimeout  等待数据库操作完成的默认网络超时时间</span></span><br><span class=\"line\"><span class=\"comment\">            2、POOLED  利用连接池的概念将JDBC连接对象组织起来，避免了创建新的连接实例</span></span><br><span class=\"line\"><span class=\"comment\">                额外属性</span></span><br><span class=\"line\"><span class=\"comment\">                    - poolMaximumActiveConnections 在任意时间可存在的活动连接数，默认10</span></span><br><span class=\"line\"><span class=\"comment\">                    - poolMaximumIdleConnections  任意时间可能存在的空闲连接数</span></span><br><span class=\"line\"><span class=\"comment\">                    - poolMaximumCheckoutTime  在被强制返回之前，池中连接被检出时间，默认20000毫秒</span></span><br><span class=\"line\"><span class=\"comment\">                    - poolTimeToWait  如果获取连接花费了很长的时间，连接池会打印状态日志并重新尝试获取一个连接，默认20000毫秒</span></span><br><span class=\"line\"><span class=\"comment\">                    - poolMaximumLocalBadConnectionTolerance  如果一个线程获取到一个坏的连接，数据源允许这个线程尝试重新获取一个新的连接，</span></span><br><span class=\"line\"><span class=\"comment\">                                                              尝试次数不应该超过poolMaximumIdleConnections与poolMaximumLocalBadConnectionTolerance之和，默认为3</span></span><br><span class=\"line\"><span class=\"comment\">                    - poolPingQuery  发送到数据库的侦测查询，用来检验连接是否正常工作   默认 NO PING QUERY SET</span></span><br><span class=\"line\"><span class=\"comment\">                    - poolPingEnabled  是否启用侦测查询  默认false</span></span><br><span class=\"line\"><span class=\"comment\">                    - poolPingConnectionsNotUsedFor  配置poolPingQuery的频率(可以设置为和数据库连接超时时间一样，避免不必要的侦测)  默认0</span></span><br><span class=\"line\"><span class=\"comment\">            3、JNDI  在外部配置数据源，然后一个JNDI上下文数据源引用</span></span><br><span class=\"line\"><span class=\"comment\">                额外属性</span></span><br><span class=\"line\"><span class=\"comment\">                    - initial_context  用来在InitialContext中寻找上下文</span></span><br><span class=\"line\"><span class=\"comment\">                    - data_source  引用数据源实例的上下文路径</span></span><br><span class=\"line\"><span class=\"comment\">         --&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dataSource</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;POOLED&quot;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;driver&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;url&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;username&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"comment\">&lt;!-- 可以使用:来为占位符设置默认值，如果没有读取到该属性的值，会使用该默认值</span></span><br><span class=\"line\"><span class=\"comment\">             该特性默认关闭，需要配置        &lt;property name=&quot;org.apache.ibatis.parsing.PropertyParser.enable-default-value&quot; value=&quot;true&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">             如果开启该特性，默认使用:分隔</span></span><br><span class=\"line\"><span class=\"comment\">             可以使用         &lt;property name=&quot;org.apache.ibatis.parsing.PropertyParser.default-value-separator&quot; value=&quot;?:&quot;/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">             来修改默认分隔符</span></span><br><span class=\"line\"><span class=\"comment\">             --&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;$&#123;jdbc.password?:123456&#125;&quot;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">dataSource</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">environment</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>也可以实现org.apache.ibatis.datasource.DataSourceFactory接口来自定义数据源实现，然后进行配置<dataSource type=\"全类名\"></dataSource></p>\n</blockquote>\n<h3 id=\"配置数据库厂商标识-databaseIdProvider\"><a href=\"#配置数据库厂商标识-databaseIdProvider\" class=\"headerlink\" title=\"配置数据库厂商标识 databaseIdProvider\"></a>配置数据库厂商标识 databaseIdProvider</h3><p>mybatis可以根据不同的数据库厂商执行不同的语句，基于映射语句中的databaseId属性。mybatis会加载带有匹配当前数据库databaseId属性个所有不带databaseId属性的语句。如果同时找到带有databaseId的不带databaseId的相同语句，后者会被舍弃</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 数据库厂商标识 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">databaseIdProvider</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;DB_VENDOR&quot;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"comment\">&lt;!-- name为使用DatabaseMetaData#getDatabaseProductName()返回的厂商名称</span></span><br><span class=\"line\"><span class=\"comment\">             value为所设置的别名,使用databaseId时使用别名即可 --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;MySQL&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;mysql&quot;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">property</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;Oracle&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;oracle&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">databaseIdProvider</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>在mapper.xml中可以配置不同数据库的sql语句</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 查询数据的方法 --&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- mysql --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUser&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;User&quot;</span> <span class=\"attr\">databaseId</span>=<span class=\"string\">&quot;mysql&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from users where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- oracle --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">select</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;selectUser&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;User&quot;</span> <span class=\"attr\">databaseId</span>=<span class=\"string\">&quot;oracle&quot;</span>&gt;</span></span><br><span class=\"line\">    select * from users where id = #&#123;id&#125;</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">select</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>可以实现org.apache.ibatis.mapping.DatabaseIdProvider接口自定义DatabaseIdProvider</p>\n</blockquote>\n<h3 id=\"配置映射器mappers\"><a href=\"#配置映射器mappers\" class=\"headerlink\" title=\"配置映射器mappers\"></a>配置映射器mappers</h3><p>将写好的sql映射文件(mapper.xml)注册到全局配置文件中</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- mapper配置 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">mappers</span>&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- resource  引入类路径下的资源  --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mapper</span> <span class=\"attr\">resource</span>=<span class=\"string\">&quot;mapper/UserMapper.xml&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- url  引入网络或者磁盘路径下的sql映射文件 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mapper</span> <span class=\"attr\">url</span>=<span class=\"string\">&quot;&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- class  基于注解的方式，注册类文件 --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">mapper</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.mapper.UserMapper&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">&lt;!-- 批量注册 注册整个包下的--&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">package</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;com.zhanghe.study.mybatis.mapper&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure>","categories":["mybatis"],"tags":["mybatis"]},{"title":"kafka启动和关闭","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%93%8D%E4%BD%9C/kafka%E5%90%AF%E5%8A%A8%E5%92%8C%E5%85%B3%E9%97%AD/","content":"<h2 id=\"kafka启动\"><a href=\"#kafka启动\" class=\"headerlink\" title=\"kafka启动\"></a>kafka启动</h2><p>kafka依赖于zookeeper，在启动kafka之前需要先启动zookeeper，kafka中包含有zookeeper启动脚本，为防止kafka与zookeeper版本问题，使用kafka中自带的zookeeper。</p>\n<a id=\"more\"></a>\n\n<p>我使用的是windows版本的   所以跳转到了bin/windows目录下</p>\n<h3 id=\"zookeeper启动\"><a href=\"#zookeeper启动\" class=\"headerlink\" title=\"zookeeper启动\"></a>zookeeper启动</h3><h4 id=\"zookeeper-properties配置\"><a href=\"#zookeeper-properties配置\" class=\"headerlink\" title=\"zookeeper.properties配置\"></a>zookeeper.properties配置</h4><figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 存储快照文件的目录，默认情况下事务日志也会存储在该目录 默认值为/tmp/zookeeper</span></span><br><span class=\"line\"><span class=\"attr\">dataDir</span>=<span class=\"string\">E:\\\\zookeeper\\\\data</span></span><br><span class=\"line\"><span class=\"comment\"># 事务日志输出目录 默认值为/tmp/zookeeper</span></span><br><span class=\"line\"><span class=\"attr\">dataLogDir</span>=<span class=\"string\">E:\\\\zookeeper\\\\logs</span></span><br><span class=\"line\"><span class=\"comment\"># zookeeper的一个时间单元  默认2000ms</span></span><br><span class=\"line\"><span class=\"comment\"># tickTime=</span></span><br><span class=\"line\"><span class=\"comment\"># LF初始通信时限  连接时间 集群中的follower服务器(F)与leader服务器(L)之间初始连接时能容忍的最多心跳数（tickTime的数量），</span></span><br><span class=\"line\"><span class=\"comment\"># 超过则认为该Follower连接失败 默认值为10</span></span><br><span class=\"line\"><span class=\"comment\"># initLimit=</span></span><br><span class=\"line\"><span class=\"comment\"># LF同步通信时限 Leader与Follower之间通信请求和应答的时间长度。</span></span><br><span class=\"line\"><span class=\"comment\"># 如果 follower 在设置的时间内不能与leader 进行通信，那么此 follower 将被丢弃</span></span><br><span class=\"line\"><span class=\"comment\"># syncLimit=</span></span><br><span class=\"line\"><span class=\"comment\"># the port at which the clients will connect</span></span><br><span class=\"line\"><span class=\"attr\">clientPort</span>=<span class=\"string\">2181</span></span><br><span class=\"line\"><span class=\"comment\"># disable the per-ip limit on the number of connections since this is a non-production config</span></span><br><span class=\"line\"><span class=\"attr\">maxClientCnxns</span>=<span class=\"string\">0</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"启动zookeeper\"><a href=\"#启动zookeeper\" class=\"headerlink\" title=\"启动zookeeper\"></a>启动zookeeper</h4><figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;zookeeper-server-<span class=\"built_in\">start</span> ../../config/zookeeper.properties</span><br></pre></td></tr></table></figure>\n\n<p>有一点需要注意的是，如果kafka或zookeeper的目录文件夹名包含空格，或导致在执行命令的时候出现问题，所以最好是放到没有空格的文件夹目录下</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">系统找不到指定的路径。</span><br><span class=\"line\">命令语法不正确。</span><br><span class=\"line\">错误: 找不到或无法加载主类 Files\\kafka_2.<span class=\"number\">11</span>-<span class=\"number\">2</span>.<span class=\"number\">2</span>.<span class=\"number\">0</span>.logs</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"启动kafka\"><a href=\"#启动kafka\" class=\"headerlink\" title=\"启动kafka\"></a>启动kafka</h3><figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-server-<span class=\"built_in\">start</span> ../../config/server.properties</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"启动脚本\"><a href=\"#启动脚本\" class=\"headerlink\" title=\"启动脚本\"></a>启动脚本</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">if [ $# -lt 1 ];</span><br><span class=\"line\">then</span><br><span class=\"line\"><span class=\"meta\">    #</span><span class=\"bash\"> 必须指定server.properties  可以使用-daemon来使程序以守护进程的方式后台运行  还可以使用--override property=value覆盖默认配置</span></span><br><span class=\"line\">    echo &quot;USAGE: $0 [-daemon] server.properties [--override property=value]*&quot;</span><br><span class=\"line\">    exit 1</span><br><span class=\"line\">fi</span><br><span class=\"line\">base_dir=$(dirname $0)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 日志文件</span></span><br><span class=\"line\">if [ &quot;x$KAFKA_LOG4J_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">    export KAFKA_LOG4J_OPTS=&quot;-Dlog4j.configuration=file:$base_dir/../config/log4j.properties&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> JVM内存</span></span><br><span class=\"line\">if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">    export KAFKA_HEAP_OPTS=&quot;-Xmx1G -Xms1G&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">EXTRA_ARGS=$&#123;EXTRA_ARGS-&#x27;-name kafkaServer -loggc&#x27;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">COMMAND=$1</span><br><span class=\"line\">case $COMMAND in</span><br><span class=\"line\">  -daemon)</span><br><span class=\"line\">    EXTRA_ARGS=&quot;-daemon &quot;$EXTRA_ARGS</span><br><span class=\"line\">    shift</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">  *)</span><br><span class=\"line\">    ;;</span><br><span class=\"line\">esac</span><br><span class=\"line\"></span><br><span class=\"line\">exec $base_dir/kafka-run-class.sh $EXTRA_ARGS kafka.Kafka &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<p>该脚本也就是执行kafka.Kafka类的main方法</p>\n<h4 id=\"kafka启动源码分析\"><a href=\"#kafka启动源码分析\" class=\"headerlink\" title=\"kafka启动源码分析\"></a>kafka启动源码分析</h4><figure class=\"highlight scala\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">main</span></span>(args: <span class=\"type\">Array</span>[<span class=\"type\">String</span>]): <span class=\"type\">Unit</span> = &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">val</span> serverProps = getPropsFromArgs(args)</span><br><span class=\"line\">      <span class=\"keyword\">val</span> kafkaServerStartable = <span class=\"type\">KafkaServerStartable</span>.fromProps(serverProps)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"type\">OperatingSystem</span>.<span class=\"type\">IS_WINDOWS</span> &amp;&amp; !<span class=\"type\">Java</span>.isIbmJdk)</span><br><span class=\"line\">          <span class=\"keyword\">new</span> <span class=\"type\">LoggingSignalHandler</span>().register()</span><br><span class=\"line\">      &#125; <span class=\"keyword\">catch</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> e: <span class=\"type\">ReflectiveOperationException</span> =&gt;</span><br><span class=\"line\">          warn(<span class=\"string\">&quot;Failed to register optional signal handler that logs a message when the process is terminated &quot;</span> +</span><br><span class=\"line\">            <span class=\"string\">s&quot;by a signal. Reason for registration failure is: <span class=\"subst\">$e</span>&quot;</span>, e)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// attach shutdown handler to catch terminating signals as well as normal termination</span></span><br><span class=\"line\">      <span class=\"type\">Runtime</span>.getRuntime().addShutdownHook(<span class=\"keyword\">new</span> <span class=\"type\">Thread</span>(<span class=\"string\">&quot;kafka-shutdown-hook&quot;</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">run</span></span>(): <span class=\"type\">Unit</span> = kafkaServerStartable.shutdown()</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\">            <span class=\"comment\">// 启动</span></span><br><span class=\"line\">      kafkaServerStartable.startup()</span><br><span class=\"line\">      kafkaServerStartable.awaitShutdown()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">catch</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> e: <span class=\"type\">Throwable</span> =&gt;</span><br><span class=\"line\">        fatal(<span class=\"string\">&quot;Exiting Kafka due to fatal exception&quot;</span>, e)</span><br><span class=\"line\">        <span class=\"type\">Exit</span>.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"type\">Exit</span>.exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p>在Kafka的main中调用kafkaServerStartable.startup()方法进行启动</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">startup</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> server.startup()</span><br><span class=\"line\">    <span class=\"keyword\">catch</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> _: <span class=\"type\">Throwable</span> =&gt;</span><br><span class=\"line\">        <span class=\"comment\">// KafkaServer.startup() calls shutdown() in case of exceptions, so we invoke `exit` to set the status code</span></span><br><span class=\"line\">        fatal(<span class=\"string\">&quot;Exiting Kafka.&quot;</span>)</span><br><span class=\"line\">        <span class=\"type\">Exit</span>.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<p>在KafkaServerStartable的startup方法调用server.startup()，这个server是KafkaServer的实例，所以真正执行的是KafkaServer的startup()方法，完成一系列组件的初始化</p>\n<figure class=\"highlight md\"><table><tr><td class=\"code\"><pre><span class=\"line\">代理状态图</span><br><span class=\"line\"><span class=\"bullet\">*</span>                +-----------+</span><br><span class=\"line\"><span class=\"bullet\">*</span>                |Not Running|</span><br><span class=\"line\"><span class=\"bullet\">*</span>                +-----+-----+</span><br><span class=\"line\"><span class=\"bullet\">*</span>                      |</span><br><span class=\"line\"><span class=\"bullet\">*</span>                      v</span><br><span class=\"line\"><span class=\"bullet\">*</span>                +-----+-----+</span><br><span class=\"line\"><span class=\"bullet\">*</span>                |Starting   +--+</span><br><span class=\"line\"><span class=\"bullet\">*</span>                +-----+-----+  | +----+------------+</span><br><span class=\"line\"><span class=\"bullet\">*</span>                      |        +&gt;+RecoveringFrom   |</span><br><span class=\"line\"><span class=\"bullet\">*</span>                      v          |UncleanShutdown  |</span><br><span class=\"line\"><span class=\"bullet\">*</span>               +-------+-------+ +-------+---------+</span><br><span class=\"line\"><span class=\"bullet\">*</span>               |RunningAsBroker|            |</span><br><span class=\"line\"><span class=\"bullet\">*</span>               +-------+-------+<span class=\"xml\"><span class=\"tag\">&lt;<span class=\"name\">-----------+</span></span></span></span><br><span class=\"line\"><span class=\"xml\">*                       |</span></span><br><span class=\"line\"><span class=\"xml\">*                       v</span></span><br><span class=\"line\"><span class=\"xml\">*                +-----+------------+</span></span><br><span class=\"line\"><span class=\"xml\">*                |PendingControlled |</span></span><br><span class=\"line\"><span class=\"xml\">*                |Shutdown          |</span></span><br><span class=\"line\"><span class=\"xml\">*                +-----+------------+</span></span><br><span class=\"line\"><span class=\"xml\">*                      |</span></span><br><span class=\"line\"><span class=\"xml\">*                      v</span></span><br><span class=\"line\"><span class=\"xml\">*               +-----+----------+</span></span><br><span class=\"line\"><span class=\"xml\">*               |BrokerShutting  |</span></span><br><span class=\"line\"><span class=\"xml\">*               |Down            |</span></span><br><span class=\"line\"><span class=\"xml\">*               +-----+----------+</span></span><br><span class=\"line\"><span class=\"xml\">*                     |</span></span><br><span class=\"line\"><span class=\"xml\">*                     v</span></span><br><span class=\"line\"><span class=\"xml\">*               +-----+-----+</span></span><br><span class=\"line\"><span class=\"xml\">*               |Not Running|</span></span><br><span class=\"line\"><span class=\"xml\">*               +-----------+</span></span><br><span class=\"line\"><span class=\"xml\">*</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight scala\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">startup</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      info(<span class=\"string\">&quot;starting&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (isShuttingDown.get)</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"type\">IllegalStateException</span>(<span class=\"string\">&quot;Kafka server is still shutting down, cannot re-start!&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (startupComplete.get)</span><br><span class=\"line\">        <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">val</span> canStartup = isStartingUp.compareAndSet(<span class=\"literal\">false</span>, <span class=\"literal\">true</span>)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (canStartup) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 设置代理的状态变迁</span></span><br><span class=\"line\">        <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">        * 代理状态</span></span><br><span class=\"line\"><span class=\"comment\">        * NotRunning  状态值0  代理未启动</span></span><br><span class=\"line\"><span class=\"comment\">        * Starting    状态值1  代理正在启动</span></span><br><span class=\"line\"><span class=\"comment\">        * RecoveringFromUncleanShutdown   状态值2  代理非正常关闭，在$&#123;log.dir&#125;配置的每个路径下存在.kafka_cleanshutdown文件</span></span><br><span class=\"line\"><span class=\"comment\">        * RunningAsBroker  状态值3  代理已正常启动</span></span><br><span class=\"line\"><span class=\"comment\">        * PendingControlledShutdown  状态值6  kafkaController被关闭</span></span><br><span class=\"line\"><span class=\"comment\">        * BrokerShuttingDown  状态值7  代理正在准备关闭</span></span><br><span class=\"line\"><span class=\"comment\">        */</span></span><br><span class=\"line\">        brokerState.newState(<span class=\"type\">Starting</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* setup zookeeper */</span></span><br><span class=\"line\">        <span class=\"comment\">// 创建zookeeper的连接，并创建下列存储元数据的目录节点</span></span><br><span class=\"line\">        <span class=\"comment\">//ConsumerPathZNode.path, /consumers    // old consumer path</span></span><br><span class=\"line\">            <span class=\"comment\">//BrokerIdsZNode.path,  /brokers/ids</span></span><br><span class=\"line\">            <span class=\"comment\">//TopicsZNode.path,  /brokers/topics</span></span><br><span class=\"line\">            <span class=\"comment\">//ConfigEntityChangeNotificationZNode.path,  /config/changes</span></span><br><span class=\"line\">            <span class=\"comment\">//DeleteTopicsZNode.path,  /admin/delete_topics</span></span><br><span class=\"line\">            <span class=\"comment\">//BrokerSequenceIdZNode.path,  /brokers/seqid</span></span><br><span class=\"line\">            <span class=\"comment\">//IsrChangeNotificationZNode.path,  /isr_change_notification</span></span><br><span class=\"line\">            <span class=\"comment\">//ProducerIdBlockZNode.path,   /latest_producer_id_block</span></span><br><span class=\"line\">            <span class=\"comment\">//LogDirEventNotificationZNode.path  /log_dir_event_notification</span></span><br><span class=\"line\">        initZkClient(time)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Get or create cluster_id */</span></span><br><span class=\"line\">        _clusterId = getOrGenerateClusterId(zkClient)</span><br><span class=\"line\">        info(<span class=\"string\">s&quot;Cluster ID = <span class=\"subst\">$clusterId</span>&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* generate brokerId */</span></span><br><span class=\"line\">        <span class=\"keyword\">val</span> (brokerId, initialOfflineDirs) = getBrokerIdAndOfflineDirs</span><br><span class=\"line\">        config.brokerId = brokerId</span><br><span class=\"line\">        logContext = <span class=\"keyword\">new</span> <span class=\"type\">LogContext</span>(<span class=\"string\">s&quot;[KafkaServer id=<span class=\"subst\">$&#123;config.brokerId&#125;</span>] &quot;</span>)</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.logIdent = logContext.logPrefix</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// initialize dynamic broker configs from ZooKeeper. Any updates made after this will be</span></span><br><span class=\"line\">        <span class=\"comment\">// applied after DynamicConfigManager starts.</span></span><br><span class=\"line\">        config.dynamicConfig.initialize(zkClient)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* start scheduler */</span></span><br><span class=\"line\">        <span class=\"comment\">// 启动任务调度器  基于ScheduledThreadPoolExecutor实现的，在kafkaServer启动时回构造一个线程总数为$&#123;background.threads&#125;的线程池，该配置项默认为10，负责副本管理及日志管理调度</span></span><br><span class=\"line\">        kafkaScheduler = <span class=\"keyword\">new</span> <span class=\"type\">KafkaScheduler</span>(config.backgroundThreads)</span><br><span class=\"line\">        kafkaScheduler.startup()</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* create and configure metrics */</span></span><br><span class=\"line\">        <span class=\"comment\">// 注册Kafka的metrics信息,在KafkaServer启动时将一些动态的JMX Beans进行注册，以便于对Kafka进行跟踪监控</span></span><br><span class=\"line\">        <span class=\"keyword\">val</span> reporters = <span class=\"keyword\">new</span> util.<span class=\"type\">ArrayList</span>[<span class=\"type\">MetricsReporter</span>]</span><br><span class=\"line\">        reporters.add(<span class=\"keyword\">new</span> <span class=\"type\">JmxReporter</span>(jmxPrefix))</span><br><span class=\"line\">        <span class=\"keyword\">val</span> metricConfig = <span class=\"type\">KafkaServer</span>.metricConfig(config)</span><br><span class=\"line\">        metrics = <span class=\"keyword\">new</span> <span class=\"type\">Metrics</span>(metricConfig, reporters, time, <span class=\"literal\">true</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* register broker metrics */</span></span><br><span class=\"line\">        _brokerTopicStats = <span class=\"keyword\">new</span> <span class=\"type\">BrokerTopicStats</span></span><br><span class=\"line\">                </span><br><span class=\"line\">        <span class=\"comment\">// 用于限流的QuotaManagers</span></span><br><span class=\"line\">        quotaManagers = <span class=\"type\">QuotaFactory</span>.instantiate(config, metrics, time, threadNamePrefix.getOrElse(<span class=\"string\">&quot;&quot;</span>))</span><br><span class=\"line\">        notifyClusterListeners(kafkaMetricsReporters ++ metrics.reporters.asScala)</span><br><span class=\"line\"></span><br><span class=\"line\">        logDirFailureChannel = <span class=\"keyword\">new</span> <span class=\"type\">LogDirFailureChannel</span>(config.logDirs.size)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* start log manager */</span></span><br><span class=\"line\">        <span class=\"comment\">// 实例化并启动日志管理器  LogManager</span></span><br><span class=\"line\">        logManager = <span class=\"type\">LogManager</span>(config, initialOfflineDirs, zkClient, brokerState, kafkaScheduler, time, brokerTopicStats, logDirFailureChannel)</span><br><span class=\"line\">        logManager.startup()</span><br><span class=\"line\"></span><br><span class=\"line\">        metadataCache = <span class=\"keyword\">new</span> <span class=\"type\">MetadataCache</span>(config.brokerId)</span><br><span class=\"line\">        <span class=\"comment\">// Enable delegation token cache for all SCRAM mechanisms to simplify dynamic update.</span></span><br><span class=\"line\">        <span class=\"comment\">// This keeps the cache up-to-date if new SCRAM mechanisms are enabled dynamically.</span></span><br><span class=\"line\">        tokenCache = <span class=\"keyword\">new</span> <span class=\"type\">DelegationTokenCache</span>(<span class=\"type\">ScramMechanism</span>.mechanismNames)</span><br><span class=\"line\">        credentialProvider = <span class=\"keyword\">new</span> <span class=\"type\">CredentialProvider</span>(<span class=\"type\">ScramMechanism</span>.mechanismNames, tokenCache)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Create and start the socket server acceptor threads so that the bound port is known.</span></span><br><span class=\"line\">        <span class=\"comment\">// Delay starting processors until the end of the initialization sequence to ensure</span></span><br><span class=\"line\">        <span class=\"comment\">// that credentials have been loaded before processing authentications.</span></span><br><span class=\"line\">        <span class=\"comment\">// 实例化并启动SocketServer服务</span></span><br><span class=\"line\">        socketServer = <span class=\"keyword\">new</span> <span class=\"type\">SocketServer</span>(config, metrics, time, credentialProvider)</span><br><span class=\"line\">        socketServer.startup(startupProcessors = <span class=\"literal\">false</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* start replica manager */</span></span><br><span class=\"line\">        <span class=\"comment\">// 实例化并启动副本管理器ReplicaManager 负责管理分区副本</span></span><br><span class=\"line\">        replicaManager = createReplicaManager(isShuttingDown)</span><br><span class=\"line\">        replicaManager.startup()</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">val</span> brokerInfo = createBrokerInfo</span><br><span class=\"line\">        <span class=\"keyword\">val</span> brokerEpoch = zkClient.registerBroker(brokerInfo)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Now that the broker id is successfully registered, checkpoint it</span></span><br><span class=\"line\">        checkpointBrokerId(config.brokerId)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* start token manager */</span></span><br><span class=\"line\">        tokenManager = <span class=\"keyword\">new</span> <span class=\"type\">DelegationTokenManager</span>(config, tokenCache, time , zkClient)</span><br><span class=\"line\">        tokenManager.startup()</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* start kafka controller */</span></span><br><span class=\"line\">        <span class=\"comment\">// 实例化并启动控制器KafkaController   每个代理对应一个KafkaController实例，在实例化时同时实例化分区状态机、副本状态机和控制器选举器</span></span><br><span class=\"line\">        kafkaController = <span class=\"keyword\">new</span> <span class=\"type\">KafkaController</span>(config, zkClient, time, metrics, brokerInfo, brokerEpoch, tokenManager, threadNamePrefix)</span><br><span class=\"line\">        kafkaController.startup()</span><br><span class=\"line\"></span><br><span class=\"line\">        adminManager = <span class=\"keyword\">new</span> <span class=\"type\">AdminManager</span>(config, metrics, metadataCache, zkClient)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* start group coordinator */</span></span><br><span class=\"line\">        <span class=\"comment\">// Hardcode Time.SYSTEM for now as some Streams tests fail otherwise, it would be good to fix the underlying issue</span></span><br><span class=\"line\">        <span class=\"comment\">// 实例化并启动组协调器GroupCoordinator  kafka会从代理中选出一个组协调器，对消费者进行管理，当消费者或者订阅的分区发生变化时进行平衡操作</span></span><br><span class=\"line\">        groupCoordinator = <span class=\"type\">GroupCoordinator</span>(config, zkClient, replicaManager, <span class=\"type\">Time</span>.<span class=\"type\">SYSTEM</span>)</span><br><span class=\"line\">        groupCoordinator.startup()</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* start transaction coordinator, with a separate background thread scheduler for transaction expiration and log loading */</span></span><br><span class=\"line\">        <span class=\"comment\">// Hardcode Time.SYSTEM for now as some Streams tests fail otherwise, it would be good to fix the underlying issue</span></span><br><span class=\"line\">        transactionCoordinator = <span class=\"type\">TransactionCoordinator</span>(config, replicaManager, <span class=\"keyword\">new</span> <span class=\"type\">KafkaScheduler</span>(threads = <span class=\"number\">1</span>, threadNamePrefix = <span class=\"string\">&quot;transaction-log-manager-&quot;</span>), zkClient, metrics, metadataCache, <span class=\"type\">Time</span>.<span class=\"type\">SYSTEM</span>)</span><br><span class=\"line\">        transactionCoordinator.startup()</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Get the authorizer and initialize it if one is specified.*/</span></span><br><span class=\"line\">        <span class=\"comment\">// 权限认证组件</span></span><br><span class=\"line\">        authorizer = <span class=\"type\">Option</span>(config.authorizerClassName).filter(_.nonEmpty).map &#123; authorizerClassName =&gt;</span><br><span class=\"line\">          <span class=\"keyword\">val</span> authZ = <span class=\"type\">CoreUtils</span>.createObject[<span class=\"type\">Authorizer</span>](authorizerClassName)</span><br><span class=\"line\">          authZ.configure(config.originals())</span><br><span class=\"line\">          authZ</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">val</span> fetchManager = <span class=\"keyword\">new</span> <span class=\"type\">FetchManager</span>(<span class=\"type\">Time</span>.<span class=\"type\">SYSTEM</span>,</span><br><span class=\"line\">          <span class=\"keyword\">new</span> <span class=\"type\">FetchSessionCache</span>(config.maxIncrementalFetchSessionCacheSlots,</span><br><span class=\"line\">            <span class=\"type\">KafkaServer</span>.<span class=\"type\">MIN_INCREMENTAL_FETCH_SESSION_EVICTION_MS</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* start processing requests */</span></span><br><span class=\"line\">        dataPlaneRequestProcessor = <span class=\"keyword\">new</span> <span class=\"type\">KafkaApis</span>(socketServer.dataPlaneRequestChannel, replicaManager, adminManager, groupCoordinator, transactionCoordinator,</span><br><span class=\"line\">          kafkaController, zkClient, config.brokerId, config, metadataCache, metrics, authorizer, quotaManagers,</span><br><span class=\"line\">          fetchManager, brokerTopicStats, clusterId, time, tokenManager)</span><br><span class=\"line\">                </span><br><span class=\"line\">        <span class=\"comment\">// Handler线程池  创建$&#123;num.io.threads&#125;个KafkaRequestHandler</span></span><br><span class=\"line\">        dataPlaneRequestHandlerPool = <span class=\"keyword\">new</span> <span class=\"type\">KafkaRequestHandlerPool</span>(config.brokerId, socketServer.dataPlaneRequestChannel, dataPlaneRequestProcessor, time,</span><br><span class=\"line\">          config.numIoThreads, <span class=\"string\">s&quot;<span class=\"subst\">$&#123;SocketServer.DataPlaneMetricPrefix&#125;</span>RequestHandlerAvgIdlePercent&quot;</span>, <span class=\"type\">SocketServer</span>.<span class=\"type\">DataPlaneThreadPrefix</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        socketServer.controlPlaneRequestChannelOpt.foreach &#123; controlPlaneRequestChannel =&gt;</span><br><span class=\"line\">          controlPlaneRequestProcessor = <span class=\"keyword\">new</span> <span class=\"type\">KafkaApis</span>(controlPlaneRequestChannel, replicaManager, adminManager, groupCoordinator, transactionCoordinator,</span><br><span class=\"line\">            kafkaController, zkClient, config.brokerId, config, metadataCache, metrics, authorizer, quotaManagers,</span><br><span class=\"line\">            fetchManager, brokerTopicStats, clusterId, time, tokenManager)</span><br><span class=\"line\"></span><br><span class=\"line\">          controlPlaneRequestHandlerPool = <span class=\"keyword\">new</span> <span class=\"type\">KafkaRequestHandlerPool</span>(config.brokerId, socketServer.controlPlaneRequestChannelOpt.get, controlPlaneRequestProcessor, time,</span><br><span class=\"line\">            <span class=\"number\">1</span>, <span class=\"string\">s&quot;<span class=\"subst\">$&#123;SocketServer.ControlPlaneMetricPrefix&#125;</span>RequestHandlerAvgIdlePercent&quot;</span>, <span class=\"type\">SocketServer</span>.<span class=\"type\">ControlPlaneThreadPrefix</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"type\">Mx4jLoader</span>.maybeLoad()</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* Add all reconfigurables for config change notification before starting config handlers */</span></span><br><span class=\"line\">        config.dynamicConfig.addReconfigurables(<span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/* start dynamic config manager */</span></span><br><span class=\"line\">        dynamicConfigHandlers = <span class=\"type\">Map</span>[<span class=\"type\">String</span>, <span class=\"type\">ConfigHandler</span>](<span class=\"type\">ConfigType</span>.<span class=\"type\">Topic</span> -&gt; <span class=\"keyword\">new</span> <span class=\"type\">TopicConfigHandler</span>(logManager, config, quotaManagers, kafkaController),</span><br><span class=\"line\">                                                           <span class=\"type\">ConfigType</span>.<span class=\"type\">Client</span> -&gt; <span class=\"keyword\">new</span> <span class=\"type\">ClientIdConfigHandler</span>(quotaManagers),</span><br><span class=\"line\">                                                           <span class=\"type\">ConfigType</span>.<span class=\"type\">User</span> -&gt; <span class=\"keyword\">new</span> <span class=\"type\">UserConfigHandler</span>(quotaManagers, credentialProvider),</span><br><span class=\"line\">                                                           <span class=\"type\">ConfigType</span>.<span class=\"type\">Broker</span> -&gt; <span class=\"keyword\">new</span> <span class=\"type\">BrokerConfigHandler</span>(config, quotaManagers))</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Create the config manager. start listening to notifications</span></span><br><span class=\"line\">        <span class=\"comment\">// 实例化动态配置管理器  注册监听zookeeper的/config路径下各子节点的信息</span></span><br><span class=\"line\">        dynamicConfigManager = <span class=\"keyword\">new</span> <span class=\"type\">DynamicConfigManager</span>(zkClient, dynamicConfigHandlers)</span><br><span class=\"line\">        dynamicConfigManager.startup()</span><br><span class=\"line\"></span><br><span class=\"line\">        socketServer.startDataPlaneProcessors()</span><br><span class=\"line\">        socketServer.startControlPlaneProcessor()</span><br><span class=\"line\">        <span class=\"comment\">// 当前代理的状态设置为RunningAsBroker</span></span><br><span class=\"line\">        brokerState.newState(<span class=\"type\">RunningAsBroker</span>)</span><br><span class=\"line\">        shutdownLatch = <span class=\"keyword\">new</span> <span class=\"type\">CountDownLatch</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">        startupComplete.set(<span class=\"literal\">true</span>)</span><br><span class=\"line\">        isStartingUp.set(<span class=\"literal\">false</span>)</span><br><span class=\"line\">        <span class=\"type\">AppInfoParser</span>.registerAppInfo(jmxPrefix, config.brokerId.toString, metrics)</span><br><span class=\"line\">        info(<span class=\"string\">&quot;started&quot;</span>)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">catch</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> e: <span class=\"type\">Throwable</span> =&gt;</span><br><span class=\"line\">        fatal(<span class=\"string\">&quot;Fatal error during KafkaServer startup. Prepare to shutdown&quot;</span>, e)</span><br><span class=\"line\">        isStartingUp.set(<span class=\"literal\">false</span>)</span><br><span class=\"line\">        shutdown()</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> e</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"日志配置\"><a href=\"#日志配置\" class=\"headerlink\" title=\"日志配置\"></a>日志配置</h4><p>日志的配置文件是config/log4j.properties</p>\n<p>日志规划：</p>\n<ul>\n<li><p>controller.log： KafkaController运行时日志</p>\n</li>\n<li><p>kafka-authorizer.log：kafka权限认证相关操作</p>\n</li>\n<li><p>kafka-request.log：kafka相应网络请求日志</p>\n</li>\n<li><p>kafka-Server-gc.log：kafka运行过程，进行gc操作时的日志</p>\n</li>\n<li><p>log-cleaner.log：kafka日志清理操作相关统计信息</p>\n</li>\n<li><p>server.log：kafkaServer运行日志</p>\n</li>\n<li><p>state-change.log：kafka分区角色切换等状态转换日志</p>\n</li>\n</ul>\n<h4 id=\"查看信息\"><a href=\"#查看信息\" class=\"headerlink\" title=\"查看信息\"></a>查看信息</h4><p>查看当前zookeeper信息  进入zookeeper客户端</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;zookeeper-shell localhost:<span class=\"number\">2181</span></span><br></pre></td></tr></table></figure>\n\n<p>查看brokers信息</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">ls /brokers/ids</span><br><span class=\"line\">// 由于当前我只开了一个kafka，所以有一个</span><br><span class=\"line\">[<span class=\"number\">0</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">get /controller</span><br><span class=\"line\">&#123;&quot;version&quot;:<span class=\"number\">1</span>,&quot;brokerid&quot;:<span class=\"number\">0</span>,&quot;timestamp&quot;:&quot;<span class=\"number\">1589255159885</span>&quot;&#125;</span><br><span class=\"line\">cZxid = <span class=\"number\">0</span>x2e</span><br><span class=\"line\">ctime = Tue May <span class=\"number\">12</span> <span class=\"number\">11</span>:<span class=\"number\">45</span>:<span class=\"number\">59</span> CST <span class=\"number\">2020</span></span><br><span class=\"line\">mZxid = <span class=\"number\">0</span>x2e</span><br><span class=\"line\">mtime = Tue May <span class=\"number\">12</span> <span class=\"number\">11</span>:<span class=\"number\">45</span>:<span class=\"number\">59</span> CST <span class=\"number\">2020</span></span><br><span class=\"line\">pZxid = <span class=\"number\">0</span>x2e</span><br><span class=\"line\">cversion = <span class=\"number\">0</span></span><br><span class=\"line\">dataVersion = <span class=\"number\">0</span></span><br><span class=\"line\">aclVersion = <span class=\"number\">0</span></span><br><span class=\"line\">ephemeralOwner = <span class=\"number\">0</span>x1001506f5890002</span><br><span class=\"line\">dataLength = <span class=\"number\">54</span></span><br><span class=\"line\">numChildren = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">get /brokers/ids/<span class=\"number\">0</span></span><br><span class=\"line\">&#123;&quot;listener_security_protocol_map&quot;:&#123;&quot;PLAINTEXT&quot;:&quot;PLAINTEXT&quot;&#125;,&quot;endpoints&quot;:[&quot;PLAINTEXT://localhost:<span class=\"number\">9092</span>&quot;],&quot;jmx_port&quot;:-<span class=\"number\">1</span>,&quot;host&quot;:&quot;localhost&quot;,&quot;timestamp&quot;:&quot;<span class=\"number\">1589255159581</span>&quot;,&quot;port&quot;:<span class=\"number\">9092</span>,&quot;version&quot;:<span class=\"number\">4</span>&#125;</span><br><span class=\"line\">cZxid = <span class=\"number\">0</span>x2d</span><br><span class=\"line\">ctime = Tue May <span class=\"number\">12</span> <span class=\"number\">11</span>:<span class=\"number\">45</span>:<span class=\"number\">59</span> CST <span class=\"number\">2020</span></span><br><span class=\"line\">mZxid = <span class=\"number\">0</span>x2d</span><br><span class=\"line\">mtime = Tue May <span class=\"number\">12</span> <span class=\"number\">11</span>:<span class=\"number\">45</span>:<span class=\"number\">59</span> CST <span class=\"number\">2020</span></span><br><span class=\"line\">pZxid = <span class=\"number\">0</span>x2d</span><br><span class=\"line\">cversion = <span class=\"number\">0</span></span><br><span class=\"line\">dataVersion = <span class=\"number\">1</span></span><br><span class=\"line\">aclVersion = <span class=\"number\">0</span></span><br><span class=\"line\">ephemeralOwner = <span class=\"number\">0</span>x1001506f5890002</span><br><span class=\"line\">dataLength = <span class=\"number\">188</span></span><br><span class=\"line\">numChildren = <span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"kafka关闭\"><a href=\"#kafka关闭\" class=\"headerlink\" title=\"kafka关闭\"></a>kafka关闭</h2><figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-server-stop</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"关闭脚本\"><a href=\"#关闭脚本\" class=\"headerlink\" title=\"关闭脚本\"></a>关闭脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">SIGNAL=$&#123;SIGNAL:-TERM&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 查找进程名为kafka的进程PID</span></span><br><span class=\"line\">if [[ $(uname -s) == &quot;OS/390&quot; ]]; then</span><br><span class=\"line\">    if [ -z $JOBNAME ]; then</span><br><span class=\"line\">        JOBNAME=&quot;KAFKSTRT&quot;</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    PIDS=$(ps -A -o pid,jobname,comm | grep -i $JOBNAME | grep java | grep -v grep | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class=\"line\">else</span><br><span class=\"line\">    PIDS=$(ps ax | grep -i &#x27;kafka\\.Kafka&#x27; | grep java | grep -v grep | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">if [ -z &quot;$PIDS&quot; ]; then</span><br><span class=\"line\">  echo &quot;No kafka server to stop&quot;</span><br><span class=\"line\">  exit 1</span><br><span class=\"line\">else</span><br><span class=\"line\">  kill -s $SIGNAL $PIDS</span><br><span class=\"line\">fi</span><br></pre></td></tr></table></figure>\n\n<h3 id><a href=\"#\" class=\"headerlink\" title></a></h3>","categories":["kafka"],"tags":["kafka"]},{"title":"kafka消费者","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%93%8D%E4%BD%9C/kafka%E6%B6%88%E8%B4%B9%E8%80%85/","content":"<h2 id=\"消费者\"><a href=\"#消费者\" class=\"headerlink\" title=\"消费者\"></a>消费者</h2><p>kafka的消费者以pull的方式获取消息，同时采用了消费者组的模式，每个消费者都属于某个消费者组。在创建消费者时，若不指定消费者的groupId，则该消费者属于默认消费者组</p>\n<a id=\"more\"></a>\n\n<p>对于同一条消息而言，只能被同组下的某一个消费者消费，但不同的消费者组的消费者能消费同一条消息，可以通过消费者组来实现消息的单播和广播。</p>\n<p>kafka提供kafka-console-consumer脚本实现用户在终端模拟消费者消费消息。</p>\n<h3 id=\"脚本\"><a href=\"#脚本\" class=\"headerlink\" title=\"脚本\"></a>脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">    export KAFKA_HEAP_OPTS=&quot;-Xmx512M&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh kafka.tools.ConsoleConsumer &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"消费者命令\"><a href=\"#消费者命令\" class=\"headerlink\" title=\"消费者命令\"></a>消费者命令</h3><figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">#表示从 latest 位移位置开始消费该主题的所有分区消息，即仅消费正在写入的消息。</span><br><span class=\"line\">&gt;kafka-console-consumer --bootstrap-server localhost:<span class=\"number\">9092</span> --topic kafka-test</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#从开始位置消费,表示从指定主题中有效的起始位移位置开始消费所有分区的消息</span><br><span class=\"line\">&gt;kafka-console-consumer --bootstrap-server localhost:<span class=\"number\">9092</span> --topic kafka-test --from-beginning</span><br><span class=\"line\"></span><br><span class=\"line\">#消费出的消息结果将打印出消息体的 key 和 value</span><br><span class=\"line\">&gt;kafka-console-consumer --bootstrap-server localhost:<span class=\"number\">9092</span> --topic kafka-test --property <span class=\"built_in\">print</span>.key=true --from-beginning</span><br></pre></td></tr></table></figure>\n\n<p>参数说明</p>\n<ul>\n<li>bootstrap-server  </li>\n<li>topic  消费的主题</li>\n<li>whitelist   正则表达式，指定要包含以供使用的主题白名单</li>\n<li>partition  指定分区，除非指定-offset  否则从分区结束(lastest)开始消费</li>\n<li>offset  执行消费的起始offset位置    默认lastest      lastest  earliest  <offset></offset></li>\n<li>consumer-property    将用户定义的属性以key=value的形式传给使用者</li>\n<li>consumer.config    消费者配置文件，consumer-property 优先级高于该配置</li>\n<li>formatter    格式化kafka消息以供显示的类的名称  默认kafka.tools.DefaultMessageFormatter     可选kafka.tools.DefaultMessageFormatter   kafka.tools.LoggingMessageFormatter<br>kafka.tools.NoOpMessageFormatter    kafka.tools.ChecksumMessageFormatter</li>\n<li>property  初始化消息格式化程序的属性    print.timestamp=true|false  print.key=true|false<br>print.value=true|false  key.separator=&lt;key.separator&gt;  line.separator=&lt;line.separator&gt;<br>key.deserializer=&lt;key.deserializer&gt;  value.deserializer=&lt;value.deserializer&gt;</li>\n<li>from-beginning   从存在的最早消息开始，而不是从最新消息开始</li>\n<li>max-messages    消费的最大数据量，若不指定，则持续消费下去</li>\n<li>timeout-ms   在指定时间间隔内没有消息可用时退出</li>\n<li>skip-message    处理消息时出错，跳过该消息而不是暂停</li>\n<li>key-deserializer</li>\n<li>value-deserializer</li>\n<li>enable-systest-events    除记录消费者外，还记录消费者的生命周期</li>\n<li>isolation-level  设置为read_committed以过滤掉未提交的事务性消息    设置为read_uncommitted以读取所有消息，默认值read_uncommitted</li>\n<li>group  指定消费者组</li>\n<li>blacklist   要从消费中排除的主题黑名单</li>\n<li>cvs-reporter-enabled   如果设置，将启用csv metrics报告器</li>\n<li>delete-consumer-offsets   如果指定，启动时删除zookeeper中的消费者信息</li>\n<li>metrics-dir  输出csv度量值</li>\n<li>zookeeper    （旧版时使用）相当于bootstrap-server</li>\n</ul>\n<p>当使用新版本时，消费者不在依赖于zookeeper，当启动一个消费者时，不向zookeeper注册，而是由消费组协调器(GroupCoordinator)统一管理。消费者已消费的消息的偏移量提交后会保存到名为”__consumer_offsets”的内部主题中。</p>\n<p>通过计算消费组名的hashcode值与内部主题分区总数(默认是50个分区)取模来确定消费者偏移量存储的分区。</p>\n<h4 id=\"查看消费情况\"><a href=\"#查看消费情况\" class=\"headerlink\" title=\"查看消费情况\"></a>查看消费情况</h4><p>describe  查看某个消费者组当前的消费情况</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">#查看消费者组名</span><br><span class=\"line\">&gt;kafka-consumer-groups --bootstrap-server localhost:<span class=\"number\">9092</span> --list</span><br><span class=\"line\"></span><br><span class=\"line\">#查看每个分区的偏移量</span><br><span class=\"line\">&gt;kafka-consumer-groups --bootstrap-server localhost:<span class=\"number\">9092</span> --describe --group test1</span><br><span class=\"line\">TOPIC      PARTITION   CURRENT-OFFSET  LOG-END-OFFSET      LAG       CONSUMER-ID     HOST   CLIENT-ID</span><br><span class=\"line\">kafka-test      <span class=\"number\">3</span>          <span class=\"number\">200003</span>          <span class=\"number\">200003</span>          <span class=\"number\">0</span>               -               -               -</span><br><span class=\"line\">kafka-test      <span class=\"number\">4</span>          <span class=\"number\">200004</span>          <span class=\"number\">200004</span>          <span class=\"number\">0</span>               -               -               -</span><br><span class=\"line\">kafka-test      <span class=\"number\">1</span>          <span class=\"number\">200003</span>          <span class=\"number\">200003</span>          <span class=\"number\">0</span>               -               -               -</span><br><span class=\"line\">kafka-test      <span class=\"number\">0</span>          <span class=\"number\">200002</span>          <span class=\"number\">200002</span>          <span class=\"number\">0</span>               -               -               -</span><br><span class=\"line\">kafka-test      <span class=\"number\">2</span>          <span class=\"number\">200002</span>          <span class=\"number\">200002</span>          <span class=\"number\">0</span>               -               -               -</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"消费多主题\"><a href=\"#消费多主题\" class=\"headerlink\" title=\"消费多主题\"></a>消费多主题</h4><p>kafka消费者的topic参数不支持同时指定多个主题，但是脚本中有另一个参数whitelist，该参数可以指定多个主题</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">#同时消费多个主题</span><br><span class=\"line\">&gt;kafka-console-consumer --bootstrap-server localhost:<span class=\"number\">9092</span> --whitelist &quot;kafka-test|kafka-action&quot;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"消费者性能测试工具\"><a href=\"#消费者性能测试工具\" class=\"headerlink\" title=\"消费者性能测试工具\"></a>消费者性能测试工具</h3><p>使用kafka-consumer-perf-test脚本</p>\n<h4 id=\"脚本-1\"><a href=\"#脚本-1\" class=\"headerlink\" title=\"脚本\"></a>脚本</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">    export KAFKA_HEAP_OPTS=&quot;-Xmx512M&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh kafka.tools.ConsumerPerformance &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"命令\"><a href=\"#命令\" class=\"headerlink\" title=\"命令\"></a>命令</h4><figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-consumer-perf-test --broker-list localhost:<span class=\"number\">9092</span> --threads <span class=\"number\">5</span> --messages <span class=\"number\">10000</span> num-fetch-threads <span class=\"number\">5</span> --topic kafka-action</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"消费者源码\"><a href=\"#消费者源码\" class=\"headerlink\" title=\"消费者源码\"></a>消费者源码</h3><p>KafkaCunsumer实现了Consume接口</p>\n<h4 id=\"方法列表\"><a href=\"#方法列表\" class=\"headerlink\" title=\"方法列表\"></a>方法列表</h4><ul>\n<li>subscribe  订阅主题</li>\n<li>assign   订阅主题的分区</li>\n<li>poll  拉取消息</li>\n<li>seek/seekToBeginning/seekToEnd  指定消费位置</li>\n<li>commitSync/commitAsync  以同步/异步方式提交偏移量</li>\n<li>assignment  获取分区分配关系</li>\n<li>position  获取下一次消费消息位置</li>\n<li>pause/resume   对分区控制</li>\n</ul>\n<h4 id=\"配置说明\"><a href=\"#配置说明\" class=\"headerlink\" title=\"配置说明\"></a>配置说明</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">CONFIG = (<span class=\"keyword\">new</span> ConfigDef()).define(<span class=\"string\">&quot;bootstrap.servers&quot;</span>, Type.LIST, Collections.emptyList(), <span class=\"keyword\">new</span> NonNullValidator(), Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;group.id&quot;</span>, Type.STRING, <span class=\"string\">&quot;&quot;</span>, Importance.HIGH, <span class=\"string\">&quot;消费组id&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;session.timeout.ms&quot;</span>, Type.INT, <span class=\"number\">10000</span>, Importance.HIGH, <span class=\"string\">&quot;组协调器没有收到消费者发来的心跳请求，则协调器会将该消费者从消费组中移除&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;heartbeat.interval.ms&quot;</span>, Type.INT, <span class=\"number\">3000</span>, Importance.HIGH, <span class=\"string\">&quot;发送心跳请求的时间间隔&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;partition.assignment.strategy&quot;</span>, Type.LIST, Collections.singletonList(RangeAssignor.class), <span class=\"keyword\">new</span> NonNullValidator(), Importance.MEDIUM, <span class=\"string\">&quot;分区分配策略&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;metadata.max.age.ms&quot;</span>, Type.LONG, <span class=\"number\">300000</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.LOW, <span class=\"string\">&quot;每隔多长时间强制更新元数据&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;enable.auto.commit&quot;</span>, Type.BOOLEAN, <span class=\"keyword\">true</span>, Importance.MEDIUM, <span class=\"string\">&quot;是否开启自动提交消费偏移量&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;auto.commit.interval.ms&quot;</span>, Type.INT, <span class=\"number\">5000</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.LOW, <span class=\"string\">&quot;自动提交消费偏移量的时间间隔&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;client.id&quot;</span>, Type.STRING, <span class=\"string\">&quot;&quot;</span>, Importance.LOW, <span class=\"string\">&quot;客户端id&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;max.partition.fetch.bytes&quot;</span>, Type.INT, <span class=\"number\">1048576</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;send.buffer.bytes&quot;</span>, Type.INT, <span class=\"number\">131072</span>, Range.atLeast(-<span class=\"number\">1</span>), Importance.MEDIUM, <span class=\"string\">&quot;Socket发送消息缓冲区大小&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;receive.buffer.bytes&quot;</span>, Type.INT, <span class=\"number\">65536</span>, Range.atLeast(-<span class=\"number\">1</span>), Importance.MEDIUM, <span class=\"string\">&quot;Socket接收消息缓冲区大小&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;fetch.min.bytes&quot;</span>, Type.INT, <span class=\"number\">1</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.HIGH, <span class=\"string\">&quot;一次拉取操作等待消息的最小字节数&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;fetch.max.bytes&quot;</span>, Type.INT, <span class=\"number\">52428800</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.MEDIUM, <span class=\"string\">&quot;一次拉取操作等待消息的最大字节数&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;fetch.max.wait.ms&quot;</span>, Type.INT, <span class=\"number\">500</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.LOW, <span class=\"string\">&quot;客户端等待请求的最长等待时间&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;reconnect.backoff.ms&quot;</span>, Type.LONG, <span class=\"number\">50L</span>, Range.atLeast(<span class=\"number\">0L</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;reconnect.backoff.max.ms&quot;</span>, Type.LONG, <span class=\"number\">1000L</span>, Range.atLeast(<span class=\"number\">0L</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;retry.backoff.ms&quot;</span>, Type.LONG, <span class=\"number\">100L</span>, Range.atLeast(<span class=\"number\">0L</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;auto.offset.reset&quot;</span>, Type.STRING, <span class=\"string\">&quot;latest&quot;</span>, ValidString.in(<span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;latest&quot;</span>, <span class=\"string\">&quot;earliest&quot;</span>, <span class=\"string\">&quot;none&quot;</span>&#125;), Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;check.crcs&quot;</span>, Type.BOOLEAN, <span class=\"keyword\">true</span>, Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;metrics.sample.window.ms&quot;</span>, Type.LONG, <span class=\"number\">30000</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;metrics.num.samples&quot;</span>, Type.INT, <span class=\"number\">2</span>, Range.atLeast(<span class=\"number\">1</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;metrics.recording.level&quot;</span>, Type.STRING, RecordingLevel.INFO.toString(), ValidString.in(<span class=\"keyword\">new</span> String[]&#123;RecordingLevel.INFO.toString(), RecordingLevel.DEBUG.toString()&#125;), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;metric.reporters&quot;</span>, Type.LIST, Collections.emptyList(), <span class=\"keyword\">new</span> NonNullValidator(), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;key.deserializer&quot;</span>, Type.CLASS, Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;value.deserializer&quot;</span>, Type.CLASS, Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;request.timeout.ms&quot;</span>, Type.INT, <span class=\"number\">30000</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.MEDIUM, <span class=\"string\">&quot;客户端发送请求后等待回应的超时时间&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;default.api.timeout.ms&quot;</span>, Type.INT, <span class=\"number\">60000</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;connections.max.idle.ms&quot;</span>, Type.LONG, <span class=\"number\">540000</span>, Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;interceptor.classes&quot;</span>, Type.LIST, Collections.emptyList(), <span class=\"keyword\">new</span> NonNullValidator(), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;max.poll.records&quot;</span>, Type.INT, <span class=\"number\">500</span>, Range.atLeast(<span class=\"number\">1</span>), Importance.MEDIUM, <span class=\"string\">&quot;一次拉取消息的最大数量&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;max.poll.interval.ms&quot;</span>, Type.INT, <span class=\"number\">300000</span>, Range.atLeast(<span class=\"number\">1</span>), Importance.MEDIUM, <span class=\"string\">&quot;拉取消息线程最长空闲时间，若超过这个时间还没有发起poll操作，则消费组认为该消费者已经离开了消费组&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;exclude.internal.topics&quot;</span>, Type.BOOLEAN, <span class=\"keyword\">true</span>, Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .defineInternal(<span class=\"string\">&quot;internal.leave.group.on.close&quot;</span>, Type.BOOLEAN, <span class=\"keyword\">true</span>, Importance.LOW)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;isolation.level&quot;</span>, Type.STRING, DEFAULT_ISOLATION_LEVEL, ValidString.in(<span class=\"keyword\">new</span> String[]&#123;IsolationLevel.READ_COMMITTED.toString().toLowerCase(Locale.ROOT), IsolationLevel.READ_UNCOMMITTED.toString().toLowerCase(Locale.ROOT)&#125;), Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;security.protocol&quot;</span>, Type.STRING, <span class=\"string\">&quot;PLAINTEXT&quot;</span>, Importance.MEDIUM, CommonClientConfigs.SECURITY_PROTOCOL_DOC).withClientSslSupport().withClientSaslSupport();</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"消费者初始化\"><a href=\"#消费者初始化\" class=\"headerlink\" title=\"消费者初始化\"></a>消费者初始化</h4><p>KafkaConsumer是非线程安全的。有一个acquire()方法用来检测每个方法的调用是不是只有一个线程在操作</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">acquire</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">long</span> threadId = Thread.currentThread().getId();</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (threadId != currentThread.get() &amp;&amp; !currentThread.compareAndSet(NO_CURRENT_THREAD, threadId))</span><br><span class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ConcurrentModificationException(<span class=\"string\">&quot;KafkaConsumer is not safe for multi-threaded access&quot;</span>);</span><br><span class=\"line\">  refcount.incrementAndGet();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">release</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (refcount.decrementAndGet() == <span class=\"number\">0</span>)</span><br><span class=\"line\">    currentThread.set(NO_CURRENT_THREAD);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 客户端没有指定client.id时，使用该变量自增</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> AtomicInteger CONSUMER_CLIENT_ID_SEQUENCE = <span class=\"keyword\">new</span> AtomicInteger(<span class=\"number\">1</span>);</span><br><span class=\"line\"><span class=\"comment\">// 记录当前操作消费者的线程id，起始值为-1，若该值为-1表示目前还没有线程操作该消费者，在acquire()方法中检测</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AtomicLong currentThread = <span class=\"keyword\">new</span> AtomicLong(NO_CURRENT_THREAD);</span><br><span class=\"line\"><span class=\"comment\">// 记录当前操作消费者的线程数，初始值为0，acquire()方法中加一，release方法中减一，并将currentThread重置为-1</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AtomicInteger refcount = <span class=\"keyword\">new</span> AtomicInteger(<span class=\"number\">0</span>);</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"消费订阅\"><a href=\"#消费订阅\" class=\"headerlink\" title=\"消费订阅\"></a>消费订阅</h3><p>kafkaConsumer提供了两种订阅消息的方法，一种使用subscribe()方法指定消息对应的主题，支持正则；另一种使用assign()方法指定分区。这两种订阅方式互斥，只能选择一种订阅方式。</p>\n<h4 id=\"主题订阅-subscribe方法\"><a href=\"#主题订阅-subscribe方法\" class=\"headerlink\" title=\"主题订阅(subscribe方法)\"></a>主题订阅(subscribe方法)</h4><p>该订阅方式由同一个消费者组的Leader消费者根据各消费者都支持的分区分配策略为消费者分配分区，可以指定ConsumerRebalanceListener进行平衡操作回调</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">subscribe</span><span class=\"params\">(Collection&lt;String&gt; topics)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">this</span>.subscribe((Collection)topics, <span class=\"keyword\">new</span> NoOpConsumerRebalanceListener());</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">subscribe</span><span class=\"params\">(Collection&lt;String&gt; topics, ConsumerRebalanceListener listener)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 调用acquire方法检测是否并发操作</span></span><br><span class=\"line\">  <span class=\"keyword\">this</span>.acquireAndEnsureOpen();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (topics == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Topic collection to subscribe to cannot be null&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (topics.isEmpty()) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      Iterator var3 = topics.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">      String topic;</span><br><span class=\"line\">      <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!var3.hasNext()) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.throwIfNoAssignorsConfigured();</span><br><span class=\"line\">          <span class=\"keyword\">this</span>.log.debug(<span class=\"string\">&quot;Subscribed to topic(s): &#123;&#125;&quot;</span>, Utils.join(topics, <span class=\"string\">&quot;, &quot;</span>));</span><br><span class=\"line\">          <span class=\"comment\">// 将订阅的主题列表保存到subscriptions</span></span><br><span class=\"line\">          <span class=\"keyword\">this</span>.subscriptions.subscribe(<span class=\"keyword\">new</span> HashSet(topics), listener);</span><br><span class=\"line\">          <span class=\"comment\">// 更新metadata中主题的过期时间</span></span><br><span class=\"line\">          <span class=\"keyword\">this</span>.metadata.setTopics(<span class=\"keyword\">this</span>.subscriptions.groupSubscription());</span><br><span class=\"line\">          <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        topic = (String)var3.next();</span><br><span class=\"line\">      &#125; <span class=\"keyword\">while</span>(topic != <span class=\"keyword\">null</span> &amp;&amp; !topic.trim().isEmpty());</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Topic collection to subscribe to cannot contain null or empty topic&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 重置</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.release();</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"分区订阅-assign方法\"><a href=\"#分区订阅-assign方法\" class=\"headerlink\" title=\"分区订阅(assign方法)\"></a>分区订阅(assign方法)</h4><p>该订阅方式客户端直接指定了消费者与分区的对应关系</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">assign</span><span class=\"params\">(Collection&lt;TopicPartition&gt; partitions)</span> </span>&#123;</span><br><span class=\"line\">              <span class=\"comment\">// 检测并发</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.acquireAndEnsureOpen();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (partitions == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Topic partition collection to assign to cannot be null&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (partitions.isEmpty()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.unsubscribe();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                Set&lt;String&gt; topics = <span class=\"keyword\">new</span> HashSet();</span><br><span class=\"line\">                Iterator var3 = partitions.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">while</span>(<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (var3.hasNext()) &#123;</span><br><span class=\"line\">                        TopicPartition tp = (TopicPartition)var3.next();</span><br><span class=\"line\">                        String topic = tp != <span class=\"keyword\">null</span> ? tp.topic() : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (topic != <span class=\"keyword\">null</span> &amp;&amp; !topic.trim().isEmpty()) &#123;</span><br><span class=\"line\">                            topics.add(topic);</span><br><span class=\"line\">                            <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalArgumentException(<span class=\"string\">&quot;Topic partitions to assign to cannot have null or empty topic&quot;</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                                        <span class=\"comment\">// 提交消费偏移量，保证同一个消费者组下的消费者对分区的消费偏移量已提交，防止重复消费</span></span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.coordinator.maybeAutoCommitOffsetsAsync(<span class=\"keyword\">this</span>.time.milliseconds());</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.log.debug(<span class=\"string\">&quot;Subscribed to partition(s): &#123;&#125;&quot;</span>, Utils.join(partitions, <span class=\"string\">&quot;, &quot;</span>));</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.subscriptions.assignFromUser(<span class=\"keyword\">new</span> HashSet(partitions));</span><br><span class=\"line\">                      <span class=\"comment\">// 更新metadata的主题过期时间</span></span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.metadata.setTopics(topics);</span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.release();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"消费消息\"><a href=\"#消费消息\" class=\"headerlink\" title=\"消费消息\"></a>消费消息</h3><p>KafkaConsumer提供了一个poll方法来拉取消息，通过Fetcher类来完成消息的拉取及更新消费偏移量</p>\n<h4 id=\"Fetcher\"><a href=\"#Fetcher\" class=\"headerlink\" title=\"Fetcher\"></a>Fetcher</h4><p>Fetcher主要功能就是负责构造拉取消息的FetchRequest请求，然后通过ConsumerNetworkClient发送该请求，最后对返回结果进行处理并更新缓存中记录的消费位置</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Fetcher</span>&lt;<span class=\"title\">K</span>, <span class=\"title\">V</span>&gt; <span class=\"keyword\">implements</span> <span class=\"title\">SubscriptionState</span>.<span class=\"title\">Listener</span>, <span class=\"title\">Closeable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Logger log;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> LogContext logContext;</span><br><span class=\"line\">      <span class=\"comment\">// 用于向kafka节点发送请求</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ConsumerNetworkClient client;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Time time;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> minBytes;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxBytes;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxWaitMs;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> fetchSize;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> retryBackoffMs;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> requestTimeoutMs;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> maxPollRecords;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> checkCrcs;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Metadata metadata;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> FetchManagerMetrics sensors;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> SubscriptionState subscriptions;</span><br><span class=\"line\">      <span class=\"comment\">// 用于保存FetchResponse原始结果</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ConcurrentLinkedQueue&lt;CompletedFetch&gt; completedFetches;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> BufferSupplier decompressionBufferSupplier = BufferSupplier.create();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Deserializer&lt;K&gt; keyDeserializer;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Deserializer&lt;V&gt; valueDeserializer;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> IsolationLevel isolationLevel;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;Integer, FetchSessionHandler&gt; sessionHandlers;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AtomicReference&lt;RuntimeException&gt; cachedListOffsetsException = <span class=\"keyword\">new</span> AtomicReference&lt;&gt;();</span><br><span class=\"line\">        <span class=\"comment\">// 用于保存从completedFetches中解析后的结果</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> PartitionRecords nextInLineRecords = <span class=\"keyword\">null</span>;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"拉取消息\"><a href=\"#拉取消息\" class=\"headerlink\" title=\"拉取消息\"></a>拉取消息</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> ConsumerRecords&lt;K, V&gt; <span class=\"title\">poll</span><span class=\"params\">(<span class=\"keyword\">final</span> Timer timer, <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> includeMetadataInTimeout)</span> </span>&#123;</span><br><span class=\"line\">        acquireAndEnsureOpen();</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.subscriptions.hasNoSubscriptionOrUserAssignment()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">&quot;Consumer is not subscribed to any topics or assigned any partitions&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// poll for new data until the timeout expires</span></span><br><span class=\"line\">            <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">                client.maybeTriggerWakeup();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (includeMetadataInTimeout) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!updateAssignmentMetadataIfNeeded(timer)) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> ConsumerRecords.empty();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">while</span> (!updateAssignmentMetadataIfNeeded(time.timer(Long.MAX_VALUE))) &#123;</span><br><span class=\"line\">                        log.warn(<span class=\"string\">&quot;Still waiting for metadata&quot;</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">final</span> Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; records = pollForFetches(timer);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!records.isEmpty()) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// before returning the fetched records, we can send off the next round of fetches</span></span><br><span class=\"line\">                    <span class=\"comment\">// and avoid block waiting for their responses to enable pipelining while the user</span></span><br><span class=\"line\">                    <span class=\"comment\">// is handling the fetched records.</span></span><br><span class=\"line\">                    <span class=\"comment\">//</span></span><br><span class=\"line\">                    <span class=\"comment\">// <span class=\"doctag\">NOTE:</span> since the consumed position has already been updated, we must not allow</span></span><br><span class=\"line\">                    <span class=\"comment\">// wakeups or any other errors to be triggered prior to returning the fetched records.</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (fetcher.sendFetches() &gt; <span class=\"number\">0</span> || client.hasPendingRequests()) &#123;</span><br><span class=\"line\">                        client.pollNoWakeup();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.interceptors.onConsume(<span class=\"keyword\">new</span> ConsumerRecords&lt;&gt;(records));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">while</span> (timer.notExpired());</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> ConsumerRecords.empty();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            release();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; pollForFetches(Timer timer) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">long</span> pollTimeout = coordinator == <span class=\"keyword\">null</span> ? timer.remainingMs() :</span><br><span class=\"line\">                Math.min(coordinator.timeToNextPoll(timer.currentTimeMs()), timer.remainingMs());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// if data is available already, return it immediately</span></span><br><span class=\"line\">              <span class=\"comment\">// 从completedFetches中取数据，第一次进来肯定没有数据，此时返回空的map</span></span><br><span class=\"line\">        <span class=\"keyword\">final</span> Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; records = fetcher.fetchedRecords();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!records.isEmpty()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> records;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// send any new fetches (won&#x27;t resend pending fetches)</span></span><br><span class=\"line\">              <span class=\"comment\">// 构造请求并调用client.send发送请求</span></span><br><span class=\"line\">        fetcher.sendFetches();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// We do not want to be stuck blocking in poll if we are missing some positions</span></span><br><span class=\"line\">        <span class=\"comment\">// since the offset lookup may be backing off after a failure</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// <span class=\"doctag\">NOTE:</span> the use of cachedSubscriptionHashAllFetchPositions means we MUST call</span></span><br><span class=\"line\">        <span class=\"comment\">// updateAssignmentMetadataIfNeeded before this method.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!cachedSubscriptionHashAllFetchPositions &amp;&amp; pollTimeout &gt; retryBackoffMs) &#123;</span><br><span class=\"line\">            pollTimeout = retryBackoffMs;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Timer pollTimer = time.timer(pollTimeout);</span><br><span class=\"line\">              <span class=\"comment\">// 阻塞等待服务端返回结果</span></span><br><span class=\"line\">        client.poll(pollTimer, () -&gt; &#123;</span><br><span class=\"line\">            <span class=\"comment\">// since a fetch might be completed by the background thread, we need this poll condition</span></span><br><span class=\"line\">            <span class=\"comment\">// to ensure that we do not block unnecessarily in poll()</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> !fetcher.hasCompletedFetches();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        timer.update(pollTimer.currentTimeMs());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// after the long poll, we should check whether the group needs to rebalance</span></span><br><span class=\"line\">        <span class=\"comment\">// prior to returning data so that the group can stabilize faster</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (coordinator != <span class=\"keyword\">null</span> &amp;&amp; coordinator.rejoinNeededOrPending()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Collections.emptyMap();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> fetcher.fetchedRecords();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"偏移量提交\"><a href=\"#偏移量提交\" class=\"headerlink\" title=\"偏移量提交\"></a>偏移量提交</h4><p>kafka将偏移量存储在内部主题”_consumer_offsets”中，内部主题配置了compact策略，保证了该主题总保留各分区被消费的最新偏移量，而且控制了该主题的日志容量。通过该消费社对应的消费者组与该主题分区总数取模的方式确定消费偏移量提交的分区</p>\n<p>(Math.abs(${group.id}.hashcode() % ${offsets.topic.num.partitions}))</p>\n<h5 id=\"手动提交\"><a href=\"#手动提交\" class=\"headerlink\" title=\"手动提交\"></a>手动提交</h5><p>enable.auto.commit设置为false，kafka提供了同步提交commitSync()和异步提交commitAsync()供客户端提交偏移量。分别调用的是ConsumerCoordinator的commitOffsetsSync方法和commitOffsetsAsync方法。</p>\n<p>通过消费者协调器ConsumerCoordinator发送OffsetCommitRequest请求，服务器组协调器GroupCoordinator进行处理，最终将消费者偏移量追加到kafka内部主题中</p>\n<p>同步提交时，消费者在提交请求响应结果返回前会一直被阻塞，在成功提交后才会进行下一次拉取消息操作；异步提交不阻塞，当提交发生异常时有可能发生重复消费</p>\n<h5 id=\"自动提交\"><a href=\"#自动提交\" class=\"headerlink\" title=\"自动提交\"></a>自动提交</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">maybeAutoCommitOffsetsAsync</span><span class=\"params\">(<span class=\"keyword\">long</span> now)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (autoCommitEnabled) &#123;</span><br><span class=\"line\">            nextAutoCommitTimer.update(now);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (nextAutoCommitTimer.isExpired()) &#123;</span><br><span class=\"line\">                nextAutoCommitTimer.reset(autoCommitIntervalMs);</span><br><span class=\"line\">                doAutoCommitOffsetsAsync();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p>检测时间是否超过了${auto.commit.interval.ms}，如果超过了则提交偏移量</p>\n<p>在以下操作时检测是否提交偏移量</p>\n<ul>\n<li>通过kafkaConsumer.assign()订阅分区。</li>\n<li>kafkaConsumer.poll()拉取消息，即在Coordinator.poll方法处理时会进行消费者偏移量提交检测</li>\n<li>消费者进行平衡操作前，即在ConsumerCoordinator.onJoinPrepare()方法处理时会进行消费偏移量提交检测</li>\n<li>ConsumerCoordinator关闭操作</li>\n</ul>\n<h4 id=\"心跳检测\"><a href=\"#心跳检测\" class=\"headerlink\" title=\"心跳检测\"></a>心跳检测</h4><p>kafkaConsumer启动后会定期向服务端组协调器GroupCoordinator发送心跳检测HeartbeatRequest请求，通过心跳检测通信双方相互感知对方是否存在并进行相应处理。核心为HeartbeatThread线程，该线程为ConsumerCoordinator父类AbstractCoordinator中的内部类</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                log.debug(<span class=\"string\">&quot;Heartbeat thread started&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">while</span> (<span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">synchronized</span> (AbstractCoordinator.<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (closed)</span><br><span class=\"line\">                            <span class=\"keyword\">return</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (!enabled) &#123;</span><br><span class=\"line\">                            AbstractCoordinator.<span class=\"keyword\">this</span>.wait();</span><br><span class=\"line\">                            <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (state != MemberState.STABLE) &#123;</span><br><span class=\"line\">                            <span class=\"comment\">// the group is not stable (perhaps because we left the group or because the coordinator</span></span><br><span class=\"line\">                            <span class=\"comment\">// kicked us out), so disable heartbeats and wait for the main thread to rejoin.</span></span><br><span class=\"line\">                            disable();</span><br><span class=\"line\">                            <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        client.pollNoWakeup();</span><br><span class=\"line\">                        <span class=\"keyword\">long</span> now = time.milliseconds();</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (coordinatorUnknown()) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (findCoordinatorFuture != <span class=\"keyword\">null</span> || lookupCoordinator().failed())</span><br><span class=\"line\">                                <span class=\"comment\">// the immediate future check ensures that we backoff properly in the case that no</span></span><br><span class=\"line\">                                <span class=\"comment\">// brokers are available to connect to.</span></span><br><span class=\"line\">                                AbstractCoordinator.<span class=\"keyword\">this</span>.wait(retryBackoffMs);</span><br><span class=\"line\">                        &#125; </span><br><span class=\"line\">                      <span class=\"comment\">// 会话超时时间sessionTimeout是否过期，过期表明HeartbeatRequest发送后没有收到响应，认为GroupCoordinator不可达</span></span><br><span class=\"line\">                      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (heartbeat.sessionTimeoutExpired(now)) &#123;</span><br><span class=\"line\">                            <span class=\"comment\">// the session timeout has expired without seeing a successful heartbeat, so we should</span></span><br><span class=\"line\">                            <span class=\"comment\">// probably make sure the coordinator is still healthy.</span></span><br><span class=\"line\">                            markCoordinatorUnknown();</span><br><span class=\"line\">                        &#125; </span><br><span class=\"line\">                      <span class=\"comment\">// 距离上次poll操作时间是否大于最大空闲时间max.poll.interval.ms，超过的话认为消费者已离开消费者组</span></span><br><span class=\"line\">                      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (heartbeat.pollTimeoutExpired(now)) &#123;</span><br><span class=\"line\">                            <span class=\"comment\">// the poll timeout has expired, which means that the foreground thread has stalled</span></span><br><span class=\"line\">                            <span class=\"comment\">// in between calls to poll(), so we explicitly leave the group.</span></span><br><span class=\"line\">                            log.warn(<span class=\"string\">&quot;This member will leave the group because consumer poll timeout has expired. This &quot;</span> +</span><br><span class=\"line\">                                    <span class=\"string\">&quot;means the time between subsequent calls to poll() was longer than the configured &quot;</span> +</span><br><span class=\"line\">                                    <span class=\"string\">&quot;max.poll.interval.ms, which typically implies that the poll loop is spending too &quot;</span> +</span><br><span class=\"line\">                                    <span class=\"string\">&quot;much time processing messages. You can address this either by increasing &quot;</span> +</span><br><span class=\"line\">                                    <span class=\"string\">&quot;max.poll.interval.ms or by reducing the maximum size of batches returned in poll() &quot;</span> +</span><br><span class=\"line\">                                    <span class=\"string\">&quot;with max.poll.records.&quot;</span>);</span><br><span class=\"line\">                                <span class=\"comment\">//发送LeaveGroupRequest请求，准备进行消费者平衡操作</span></span><br><span class=\"line\">                            maybeLeaveGroup();</span><br><span class=\"line\">                        &#125; </span><br><span class=\"line\">                      <span class=\"comment\">// 还未到发送心跳检测时间</span></span><br><span class=\"line\">                      <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!heartbeat.shouldHeartbeat(now)) &#123;</span><br><span class=\"line\">                            <span class=\"comment\">// poll again after waiting for the retry backoff in case the heartbeat failed or the</span></span><br><span class=\"line\">                            <span class=\"comment\">// coordinator disconnected</span></span><br><span class=\"line\">                                <span class=\"comment\">// 继续等待</span></span><br><span class=\"line\">                            AbstractCoordinator.<span class=\"keyword\">this</span>.wait(retryBackoffMs);</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            heartbeat.sentHeartbeat(now);</span><br><span class=\"line\">                                                        <span class=\"comment\">// 发送心跳检测</span></span><br><span class=\"line\">                            sendHeartbeatRequest().addListener(<span class=\"keyword\">new</span> RequestFutureListener&lt;Void&gt;() &#123;</span><br><span class=\"line\">                                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                                <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onSuccess</span><span class=\"params\">(Void value)</span> </span>&#123;</span><br><span class=\"line\">                                    <span class=\"keyword\">synchronized</span> (AbstractCoordinator.<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">                                        heartbeat.receiveHeartbeat();</span><br><span class=\"line\">                                    &#125;</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                                <span class=\"meta\">@Override</span></span><br><span class=\"line\">                                <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onFailure</span><span class=\"params\">(RuntimeException e)</span> </span>&#123;</span><br><span class=\"line\">                                    <span class=\"keyword\">synchronized</span> (AbstractCoordinator.<span class=\"keyword\">this</span>) &#123;</span><br><span class=\"line\">                                        <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> RebalanceInProgressException) &#123;</span><br><span class=\"line\">                                            <span class=\"comment\">// it is valid to continue heartbeating while the group is rebalancing. This</span></span><br><span class=\"line\">                                            <span class=\"comment\">// ensures that the coordinator keeps the member in the group for as long</span></span><br><span class=\"line\">                                            <span class=\"comment\">// as the duration of the rebalance timeout. If we stop sending heartbeats,</span></span><br><span class=\"line\">                                            <span class=\"comment\">// however, then the session timeout may expire before we can rejoin.</span></span><br><span class=\"line\">                                            heartbeat.receiveHeartbeat();</span><br><span class=\"line\">                                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                                            heartbeat.failHeartbeat();</span><br><span class=\"line\"></span><br><span class=\"line\">                                            <span class=\"comment\">// wake up the thread if it&#x27;s sleeping to reschedule the heartbeat</span></span><br><span class=\"line\">                                            AbstractCoordinator.<span class=\"keyword\">this</span>.notify();</span><br><span class=\"line\">                                        &#125;</span><br><span class=\"line\">                                    &#125;</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (AuthenticationException e) &#123;</span><br><span class=\"line\">                log.error(<span class=\"string\">&quot;An authentication error occurred in the heartbeat thread&quot;</span>, e);</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.failed.set(e);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (GroupAuthorizationException e) &#123;</span><br><span class=\"line\">                log.error(<span class=\"string\">&quot;A group authorization error occurred in the heartbeat thread&quot;</span>, e);</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.failed.set(e);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InterruptedException | InterruptException e) &#123;</span><br><span class=\"line\">                Thread.interrupted();</span><br><span class=\"line\">                log.error(<span class=\"string\">&quot;Unexpected interrupt received in heartbeat thread&quot;</span>, e);</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.failed.set(<span class=\"keyword\">new</span> RuntimeException(e));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">                log.error(<span class=\"string\">&quot;Heartbeat thread failed due to unexpected error&quot;</span>, e);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e <span class=\"keyword\">instanceof</span> RuntimeException)</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.failed.set((RuntimeException) e);</span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.failed.set(<span class=\"keyword\">new</span> RuntimeException(e));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                log.debug(<span class=\"string\">&quot;Heartbeat thread has closed&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"消费者平衡\"><a href=\"#消费者平衡\" class=\"headerlink\" title=\"消费者平衡\"></a>消费者平衡</h4><p>消费者平衡是指消费者重新加入消费组并重新分配分区给消费者的过程。</p>\n<p>以下情况会引起消费者平衡操作</p>\n<ul>\n<li>新的消费者加入消费组</li>\n<li>当前消费者从消费组退出</li>\n<li>消费者取消对某个主题的订阅</li>\n<li>订阅主题的分区增加</li>\n<li>代理宕机新的协调器当选</li>\n<li>当消费者在${session.timeout.ms}毫秒还没有发送心跳请求，组协调器认为消费者已退出</li>\n</ul>\n","categories":["kafka"],"tags":["kafka"]},{"title":"kafka之延迟操作组件","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%9C%8D%E5%8A%A1%E7%AB%AF/kafka%E4%B9%8B%E5%BB%B6%E8%BF%9F%E6%93%8D%E4%BD%9C%E7%BB%84%E4%BB%B6/","content":"<h2 id=\"延迟操作组件\"><a href=\"#延迟操作组件\" class=\"headerlink\" title=\"延迟操作组件\"></a>延迟操作组件</h2><p>该组件可以辅助kafka其他组件完成相应的功能</p>\n<a id=\"more\"></a>\n\n<h3 id=\"DelayedOperation\"><a href=\"#DelayedOperation\" class=\"headerlink\" title=\"DelayedOperation\"></a>DelayedOperation</h3><p>kafka将一些不立即执行而要等待满足一定条件才触发完成的操作成为延迟操作，并将这类操作定义为一个抽象类DelaydOperation，DelayedOperation是一个基于事件启动有失效时间的TimerTask，TimerTask实现了Runnable接口，维护了一个TimerTaskEntry对象，TimerTaskEntry绑定了一个TimerTask，TimerTaskEntry被添加到TimerTaskList中，TimerTaskList是一个环形双向链表，按失效时间排序。</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DelayedOperation</span>(<span class=\"params\">override val delayMs: <span class=\"type\">Long</span>,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">    lockOpt: <span class=\"type\">Option</span>[<span class=\"type\">Lock</span>] = <span class=\"type\">None</span></span>) <span class=\"keyword\">extends</span> <span class=\"title\">TimerTask</span> <span class=\"keyword\">with</span> <span class=\"title\">Logging</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 控制某个延迟操作</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> completed = <span class=\"keyword\">new</span> <span class=\"type\">AtomicBoolean</span>(<span class=\"literal\">false</span>)</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> tryCompletePending = <span class=\"keyword\">new</span> <span class=\"type\">AtomicBoolean</span>(<span class=\"literal\">false</span>)</span><br><span class=\"line\">  <span class=\"comment\">// Visible for testing</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span>[server] <span class=\"keyword\">val</span> lock: <span class=\"type\">Lock</span> = lockOpt.getOrElse(<span class=\"keyword\">new</span> <span class=\"type\">ReentrantLock</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">   * 在条件满足时，检测延迟任务是否未被执行。若未被执行，则先调用canel方法解除该延迟操作与TimerTaskEntry的绑定，将该延迟操作从TimerTaskList链表中移除，然后调用onComplete()方法让延迟操作执行完成</span></span><br><span class=\"line\"><span class=\"comment\">   * Force completing the delayed operation, if not already completed.</span></span><br><span class=\"line\"><span class=\"comment\">   * This function can be triggered when</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * 1. The operation has been verified to be completable inside tryComplete()</span></span><br><span class=\"line\"><span class=\"comment\">   * 2. The operation has expired and hence needs to be completed right now</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * Return true iff the operation is completed by the caller: note that</span></span><br><span class=\"line\"><span class=\"comment\">   * concurrent threads can try to complete the same operation, but only</span></span><br><span class=\"line\"><span class=\"comment\">   * the first thread will succeed in completing the operation and return</span></span><br><span class=\"line\"><span class=\"comment\">   * true, others will still return false</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">forceComplete</span></span>(): <span class=\"type\">Boolean</span> = &#123;</span><br><span class=\"line\">    <span class=\"comment\">//CAS原子性操作，保证onComplete只会被调用一次</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (completed.compareAndSet(<span class=\"literal\">false</span>, <span class=\"literal\">true</span>)) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// cancel the timeout timer</span></span><br><span class=\"line\">      cancel()</span><br><span class=\"line\">      onComplete()</span><br><span class=\"line\">      <span class=\"literal\">true</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"literal\">false</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Check if the delayed operation is already completed</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">isCompleted</span></span>: <span class=\"type\">Boolean</span> = completed.get()</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * 由子类来实现当延迟操作已到达失效时间的逻辑处理</span></span><br><span class=\"line\"><span class=\"comment\">   * kafka通过SystemTimer来定期检测请求是否超时。SystemTimer是kafka实现的底层基于层级时间轮和DelayQueue定时器，维护了一个newFixedThreadPool线程池</span></span><br><span class=\"line\"><span class=\"comment\">   * Call-back to execute when a delayed operation gets expired and hence forced to complete.</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">onExpiration</span></span>(): <span class=\"type\">Unit</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * 由子类实现，实际业务逻辑</span></span><br><span class=\"line\"><span class=\"comment\">   * Process for completing an operation; This function needs to be defined</span></span><br><span class=\"line\"><span class=\"comment\">   * in subclasses and will be called exactly once in forceComplete()</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">onComplete</span></span>(): <span class=\"type\">Unit</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * 由子类实现，负责检测执行条件是否满足，若满足条件，则调用forceComplete()方法完成延迟操作</span></span><br><span class=\"line\"><span class=\"comment\">   * Try to complete the delayed operation by first checking if the operation</span></span><br><span class=\"line\"><span class=\"comment\">   * can be completed by now. If yes execute the completion logic by calling</span></span><br><span class=\"line\"><span class=\"comment\">   * forceComplete() and return true iff forceComplete returns true; otherwise return false</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * This function needs to be defined in subclasses</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">tryComplete</span></span>(): <span class=\"type\">Boolean</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Thread-safe variant of tryComplete() that attempts completion only if the lock can be acquired</span></span><br><span class=\"line\"><span class=\"comment\">   * without blocking.</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * If threadA acquires the lock and performs the check for completion before completion criteria is met</span></span><br><span class=\"line\"><span class=\"comment\">   * and threadB satisfies the completion criteria, but fails to acquire the lock because threadA has not</span></span><br><span class=\"line\"><span class=\"comment\">   * yet released the lock, we need to ensure that completion is attempted again without blocking threadA</span></span><br><span class=\"line\"><span class=\"comment\">   * or threadB. `tryCompletePending` is set by threadB when it fails to acquire the lock and at least one</span></span><br><span class=\"line\"><span class=\"comment\">   * of threadA or threadB will attempt completion of the operation if this flag is set. This ensures that</span></span><br><span class=\"line\"><span class=\"comment\">   * every invocation of `maybeTryComplete` is followed by at least one invocation of `tryComplete` until</span></span><br><span class=\"line\"><span class=\"comment\">   * the operation is actually completed.</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span>[server] <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">maybeTryComplete</span></span>(): <span class=\"type\">Boolean</span> = &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> retry = <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> done = <span class=\"literal\">false</span></span><br><span class=\"line\">    do &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (lock.tryLock()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          tryCompletePending.set(<span class=\"literal\">false</span>)</span><br><span class=\"line\">          done = tryComplete()</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">          lock.unlock()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// While we were holding the lock, another thread may have invoked `maybeTryComplete` and set</span></span><br><span class=\"line\">        <span class=\"comment\">// `tryCompletePending`. In this case we should retry.</span></span><br><span class=\"line\">        retry = tryCompletePending.get()</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Another thread is holding the lock. If `tryCompletePending` is already set and this thread failed to</span></span><br><span class=\"line\">        <span class=\"comment\">// acquire the lock, then the thread that is holding the lock is guaranteed to see the flag and retry.</span></span><br><span class=\"line\">        <span class=\"comment\">// Otherwise, we should set the flag and retry on this thread since the thread holding the lock may have</span></span><br><span class=\"line\">        <span class=\"comment\">// released the lock and returned by the time the flag is set.</span></span><br><span class=\"line\">        retry = !tryCompletePending.getAndSet(<span class=\"literal\">true</span>)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">while</span> (!isCompleted &amp;&amp; retry)</span><br><span class=\"line\">    done</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">   * run() method defines a task that is executed on timeout</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">run</span></span>(): <span class=\"type\">Unit</span> = &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (forceComplete())</span><br><span class=\"line\">      onExpiration()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">object</span> <span class=\"title\">DelayedOperationPurgatory</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> <span class=\"type\">Shards</span> = <span class=\"number\">512</span> <span class=\"comment\">// Shard the watcher list to reduce lock contention</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">apply</span></span>[<span class=\"type\">T</span> &lt;: <span class=\"type\">DelayedOperation</span>](purgatoryName: <span class=\"type\">String</span>,</span><br><span class=\"line\">                                   brokerId: <span class=\"type\">Int</span> = <span class=\"number\">0</span>,</span><br><span class=\"line\">                                   purgeInterval: <span class=\"type\">Int</span> = <span class=\"number\">1000</span>,</span><br><span class=\"line\">                                   reaperEnabled: <span class=\"type\">Boolean</span> = <span class=\"literal\">true</span>,</span><br><span class=\"line\">                                   timerEnabled: <span class=\"type\">Boolean</span> = <span class=\"literal\">true</span>): <span class=\"type\">DelayedOperationPurgatory</span>[<span class=\"type\">T</span>] = &#123;</span><br><span class=\"line\">    <span class=\"keyword\">val</span> timer = <span class=\"keyword\">new</span> <span class=\"type\">SystemTimer</span>(purgatoryName)</span><br><span class=\"line\">    <span class=\"keyword\">new</span> <span class=\"type\">DelayedOperationPurgatory</span>[<span class=\"type\">T</span>](purgatoryName, timer, brokerId, purgeInterval, reaperEnabled, timerEnabled)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"DelayedOperationPurgatory\"><a href=\"#DelayedOperationPurgatory\" class=\"headerlink\" title=\"DelayedOperationPurgatory\"></a>DelayedOperationPurgatory</h3><p>DelayedOperationPurgatory是一个对DelayedOperation管理的辅助类，以泛型的形式将一个DelayedOperation添加到其内部维护的Pool[Any,Watchers]类型的watchesForKey对象中，同时将DelayedOperation添加到SystemTimer中</p>\n<p>Watchers是DelayedOperationPurgatory的内部类，底层是ConcurrentLinkedQueue，ConcurrentLinkedQueue类型的operations属性，保存DelayedOperation</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * A helper purgatory class for bookkeeping delayed operations with a timeout, and expiring timed out operations.</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">final</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DelayedOperationPurgatory</span>[<span class=\"type\">T</span> &lt;: <span class=\"type\">DelayedOperation</span>](<span class=\"params\">purgatoryName: <span class=\"type\">String</span>,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                                                             timeoutTimer: <span class=\"type\">Timer</span>,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                                                             brokerId: <span class=\"type\">Int</span> = 0,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                                                             purgeInterval: <span class=\"type\">Int</span> = 1000,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                                                             reaperEnabled: <span class=\"type\">Boolean</span> = true,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                                                             timerEnabled: <span class=\"type\">Boolean</span> = true</span>)</span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"keyword\">extends</span> <span class=\"title\">Logging</span> <span class=\"keyword\">with</span> <span class=\"title\">KafkaMetricsGroup</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">/* a list of operation watching keys */</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WatcherList</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">val</span> watchersByKey = <span class=\"keyword\">new</span> <span class=\"type\">Pool</span>[<span class=\"type\">Any</span>, <span class=\"type\">Watchers</span>](<span class=\"type\">Some</span>((key: <span class=\"type\">Any</span>) =&gt; <span class=\"keyword\">new</span> <span class=\"type\">Watchers</span>(key)))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">val</span> watchersLock = <span class=\"keyword\">new</span> <span class=\"type\">ReentrantLock</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">     * Return all the current watcher lists,</span></span><br><span class=\"line\"><span class=\"comment\">     * note that the returned watchers may be removed from the list by other threads</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">allWatchers</span> </span>= &#123;</span><br><span class=\"line\">      watchersByKey.values</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> watcherLists = <span class=\"type\">Array</span>.fill[<span class=\"type\">WatcherList</span>](<span class=\"type\">DelayedOperationPurgatory</span>.<span class=\"type\">Shards</span>)(<span class=\"keyword\">new</span> <span class=\"type\">WatcherList</span>)</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">watcherList</span></span>(key: <span class=\"type\">Any</span>): <span class=\"type\">WatcherList</span> = &#123;</span><br><span class=\"line\">    watcherLists(<span class=\"type\">Math</span>.abs(key.hashCode() % watcherLists.length))</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// the number of estimated total operations in the purgatory</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span>[<span class=\"keyword\">this</span>] <span class=\"keyword\">val</span> estimatedTotalOperations = <span class=\"keyword\">new</span> <span class=\"type\">AtomicInteger</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/* background thread expiring operations that have timed out */</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> expirationReaper = <span class=\"keyword\">new</span> <span class=\"type\">ExpiredOperationReaper</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> metricsTags = <span class=\"type\">Map</span>(<span class=\"string\">&quot;delayedOperation&quot;</span> -&gt; purgatoryName)</span><br><span class=\"line\"></span><br><span class=\"line\">  newGauge(</span><br><span class=\"line\">    <span class=\"string\">&quot;PurgatorySize&quot;</span>,</span><br><span class=\"line\">    <span class=\"keyword\">new</span> <span class=\"type\">Gauge</span>[<span class=\"type\">Int</span>] &#123;</span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">value</span></span>: <span class=\"type\">Int</span> = watched</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    metricsTags</span><br><span class=\"line\">  )</span><br><span class=\"line\"></span><br><span class=\"line\">  newGauge(</span><br><span class=\"line\">    <span class=\"string\">&quot;NumDelayedOperations&quot;</span>,</span><br><span class=\"line\">    <span class=\"keyword\">new</span> <span class=\"type\">Gauge</span>[<span class=\"type\">Int</span>] &#123;</span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">value</span></span>: <span class=\"type\">Int</span> = delayed</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    metricsTags</span><br><span class=\"line\">  )</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (reaperEnabled)</span><br><span class=\"line\">    expirationReaper.start()</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Check if the operation can be completed, if not watch it based on the given watch keys</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * Note that a delayed operation can be watched on multiple keys. It is possible that</span></span><br><span class=\"line\"><span class=\"comment\">   * an operation is completed after it has been added to the watch list for some, but</span></span><br><span class=\"line\"><span class=\"comment\">   * not all of the keys. In this case, the operation is considered completed and won&#x27;t</span></span><br><span class=\"line\"><span class=\"comment\">   * be added to the watch list of the remaining keys. The expiration reaper thread will</span></span><br><span class=\"line\"><span class=\"comment\">   * remove this operation from any watcher list in which the operation exists.</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * @param operation the delayed operation to be checked</span></span><br><span class=\"line\"><span class=\"comment\">   * @param watchKeys keys for bookkeeping the operation</span></span><br><span class=\"line\"><span class=\"comment\">   * @return true iff the delayed operations can be completed by the caller</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">tryCompleteElseWatch</span></span>(operation: <span class=\"type\">T</span>, watchKeys: <span class=\"type\">Seq</span>[<span class=\"type\">Any</span>]): <span class=\"type\">Boolean</span> = &#123;</span><br><span class=\"line\">    assert(watchKeys.nonEmpty, <span class=\"string\">&quot;The watch key list can&#x27;t be empty&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// The cost of tryComplete() is typically proportional to the number of keys. Calling</span></span><br><span class=\"line\">    <span class=\"comment\">// tryComplete() for each key is going to be expensive if there are many keys. Instead,</span></span><br><span class=\"line\">    <span class=\"comment\">// we do the check in the following way. Call tryComplete(). If the operation is not completed,</span></span><br><span class=\"line\">    <span class=\"comment\">// we just add the operation to all keys. Then we call tryComplete() again. At this time, if</span></span><br><span class=\"line\">    <span class=\"comment\">// the operation is still not completed, we are guaranteed that it won&#x27;t miss any future triggering</span></span><br><span class=\"line\">    <span class=\"comment\">// event since the operation is already on the watcher list for all keys. This does mean that</span></span><br><span class=\"line\">    <span class=\"comment\">// if the operation is completed (by another thread) between the two tryComplete() calls, the</span></span><br><span class=\"line\">    <span class=\"comment\">// operation is unnecessarily added for watch. However, this is a less severe issue since the</span></span><br><span class=\"line\">    <span class=\"comment\">// expire reaper will clean it up periodically.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// At this point the only thread that can attempt this operation is this current thread</span></span><br><span class=\"line\">    <span class=\"comment\">// Hence it is safe to tryComplete() without a lock</span></span><br><span class=\"line\">    <span class=\"comment\">//检测是否完成</span></span><br><span class=\"line\">    <span class=\"keyword\">var</span> isCompletedByMe = operation.tryComplete()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isCompletedByMe)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">var</span> watchCreated = <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(key &lt;- watchKeys) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// If the operation is already completed, stop adding it to the rest of the watcher list.</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (operation.isCompleted)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      watchForOperation(key, operation)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (!watchCreated) &#123;</span><br><span class=\"line\">        watchCreated = <span class=\"literal\">true</span></span><br><span class=\"line\">        estimatedTotalOperations.incrementAndGet()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    isCompletedByMe = operation.maybeTryComplete()</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (isCompletedByMe)</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// if it cannot be completed by now and hence is watched, add to the expire queue also</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!operation.isCompleted) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (timerEnabled)</span><br><span class=\"line\">        timeoutTimer.add(operation)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (operation.isCompleted) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// cancel the timer task</span></span><br><span class=\"line\">        operation.cancel()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"literal\">false</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Check if some delayed operations can be completed with the given watch key,</span></span><br><span class=\"line\"><span class=\"comment\">   * and if yes complete them.</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * @return the number of completed operations during this process</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">checkAndComplete</span></span>(key: <span class=\"type\">Any</span>): <span class=\"type\">Int</span> = &#123;</span><br><span class=\"line\">    <span class=\"keyword\">val</span> wl = watcherList(key)</span><br><span class=\"line\">    <span class=\"keyword\">val</span> watchers = inLock(wl.watchersLock) &#123; wl.watchersByKey.get(key) &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(watchers == <span class=\"literal\">null</span>)</span><br><span class=\"line\">      <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      watchers.tryCompleteWatched()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Return the total size of watch lists the purgatory. Since an operation may be watched</span></span><br><span class=\"line\"><span class=\"comment\">   * on multiple lists, and some of its watched entries may still be in the watch lists</span></span><br><span class=\"line\"><span class=\"comment\">   * even when it has been completed, this number may be larger than the number of real operations watched</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">watched</span></span>: <span class=\"type\">Int</span> = &#123;</span><br><span class=\"line\">    watcherLists.foldLeft(<span class=\"number\">0</span>) &#123; <span class=\"keyword\">case</span> (sum, watcherList) =&gt; sum + watcherList.allWatchers.map(_.countWatched).sum &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Return the number of delayed operations in the expiry queue</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">delayed</span></span>: <span class=\"type\">Int</span> = timeoutTimer.size</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">    * Cancel watching on any delayed operations for the given key. Note the operation will not be completed</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">cancelForKey</span></span>(key: <span class=\"type\">Any</span>): <span class=\"type\">List</span>[<span class=\"type\">T</span>] = &#123;</span><br><span class=\"line\">    <span class=\"keyword\">val</span> wl = watcherList(key)</span><br><span class=\"line\">    inLock(wl.watchersLock) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">val</span> watchers = wl.watchersByKey.remove(key)</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (watchers != <span class=\"literal\">null</span>)</span><br><span class=\"line\">        watchers.cancel()</span><br><span class=\"line\">      <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"type\">Nil</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">   * Return the watch list of the given key, note that we need to</span></span><br><span class=\"line\"><span class=\"comment\">   * grab the removeWatchersLock to avoid the operation being added to a removed watcher list</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">watchForOperation</span></span>(key: <span class=\"type\">Any</span>, operation: <span class=\"type\">T</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">val</span> wl = watcherList(key)</span><br><span class=\"line\">    inLock(wl.watchersLock) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">val</span> watcher = wl.watchersByKey.getAndMaybePut(key)</span><br><span class=\"line\">      watcher.watch(operation)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">   * Remove the key from watcher lists if its list is empty</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">removeKeyIfEmpty</span></span>(key: <span class=\"type\">Any</span>, watchers: <span class=\"type\">Watchers</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">val</span> wl = watcherList(key)</span><br><span class=\"line\">    inLock(wl.watchersLock) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// if the current key is no longer correlated to the watchers to remove, skip</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (wl.watchersByKey.get(key) != watchers)</span><br><span class=\"line\">        <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (watchers != <span class=\"literal\">null</span> &amp;&amp; watchers.isEmpty) &#123;</span><br><span class=\"line\">        wl.watchersByKey.remove(key)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Shutdown the expire reaper thread</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">shutdown</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (reaperEnabled)</span><br><span class=\"line\">      expirationReaper.shutdown()</span><br><span class=\"line\">    timeoutTimer.shutdown()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * A linked list of watched delayed operations based on some key</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Watchers</span>(<span class=\"params\">val key: <span class=\"type\">Any</span></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span>[<span class=\"keyword\">this</span>] <span class=\"keyword\">val</span> operations = <span class=\"keyword\">new</span> <span class=\"type\">ConcurrentLinkedQueue</span>[<span class=\"type\">T</span>]()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// count the current number of watched operations. This is O(n), so use isEmpty() if possible</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">countWatched</span></span>: <span class=\"type\">Int</span> = operations.size</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">isEmpty</span></span>: <span class=\"type\">Boolean</span> = operations.isEmpty</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// add the element to watch</span></span><br><span class=\"line\">    <span class=\"comment\">// 将DelayedOperation添加到operations集合中</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">watch</span></span>(t: <span class=\"type\">T</span>) &#123;</span><br><span class=\"line\">      operations.add(t)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// traverse the list and try to complete some watched elements</span></span><br><span class=\"line\">    <span class=\"comment\">// 迭代operations集合中的DelayedOperation,通过isCompleted检测是否已经执行完成</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">tryCompleteWatched</span></span>(): <span class=\"type\">Int</span> = &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> completed = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">val</span> iter = operations.iterator()</span><br><span class=\"line\">      <span class=\"keyword\">while</span> (iter.hasNext) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">val</span> curr = iter.next()</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (curr.isCompleted) &#123; <span class=\"comment\">// 执行完成</span></span><br><span class=\"line\">          <span class=\"comment\">// another thread has completed this operation, just remove it</span></span><br><span class=\"line\">          <span class=\"comment\">// 移除</span></span><br><span class=\"line\">          iter.remove()</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (curr.maybeTryComplete()) &#123;<span class=\"comment\">//尝试执行完成，如果执行完成，则移除</span></span><br><span class=\"line\">          iter.remove()</span><br><span class=\"line\">          completed += <span class=\"number\">1</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">            <span class=\"comment\">// 为空，表示全部完成  将该watchers从pool中移除</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (operations.isEmpty)</span><br><span class=\"line\">        removeKeyIfEmpty(key, <span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">      completed</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">cancel</span></span>(): <span class=\"type\">List</span>[<span class=\"type\">T</span>] = &#123;</span><br><span class=\"line\">      <span class=\"keyword\">val</span> iter = operations.iterator()</span><br><span class=\"line\">      <span class=\"keyword\">val</span> cancelled = <span class=\"keyword\">new</span> <span class=\"type\">ListBuffer</span>[<span class=\"type\">T</span>]()</span><br><span class=\"line\">      <span class=\"keyword\">while</span> (iter.hasNext) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">val</span> curr = iter.next()</span><br><span class=\"line\">        curr.cancel()</span><br><span class=\"line\">        iter.remove()</span><br><span class=\"line\">        cancelled += curr</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      cancelled.toList</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// traverse the list and purge elements that are already completed by others</span></span><br><span class=\"line\">    <span class=\"comment\">//与tryCompleteWatched基本相同，只是不会尝试对未完成的DelayedOperation执行完成</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">purgeCompleted</span></span>(): <span class=\"type\">Int</span> = &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> purged = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">val</span> iter = operations.iterator()</span><br><span class=\"line\">      <span class=\"keyword\">while</span> (iter.hasNext) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">val</span> curr = iter.next()</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (curr.isCompleted) &#123;</span><br><span class=\"line\">          iter.remove()</span><br><span class=\"line\">          purged += <span class=\"number\">1</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (operations.isEmpty)</span><br><span class=\"line\">        removeKeyIfEmpty(key, <span class=\"keyword\">this</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">      purged</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">advanceClock</span></span>(timeoutMs: <span class=\"type\">Long</span>) &#123;</span><br><span class=\"line\">    timeoutTimer.advanceClock(timeoutMs)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Trigger a purge if the number of completed but still being watched operations is larger than</span></span><br><span class=\"line\">    <span class=\"comment\">// the purge threshold. That number is computed by the difference btw the estimated total number of</span></span><br><span class=\"line\">    <span class=\"comment\">// operations and the number of pending delayed operations.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (estimatedTotalOperations.get - delayed &gt; purgeInterval) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// now set estimatedTotalOperations to delayed (the number of pending operations) since we are going to</span></span><br><span class=\"line\">      <span class=\"comment\">// clean up watchers. Note that, if more operations are completed during the clean up, we may end up with</span></span><br><span class=\"line\">      <span class=\"comment\">// a little overestimated total number of operations.</span></span><br><span class=\"line\">      estimatedTotalOperations.getAndSet(delayed)</span><br><span class=\"line\">      debug(<span class=\"string\">&quot;Begin purging watch lists&quot;</span>)</span><br><span class=\"line\">      <span class=\"keyword\">val</span> purged = watcherLists.foldLeft(<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> (sum, watcherList) =&gt; sum + watcherList.allWatchers.map(_.purgeCompleted()).sum</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      debug(<span class=\"string\">&quot;Purged %d elements from watch lists.&quot;</span>.format(purged))</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * A background reaper to expire delayed operations that have timed out</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExpiredOperationReaper</span> <span class=\"keyword\">extends</span> <span class=\"title\">ShutdownableThread</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">    &quot;<span class=\"type\">ExpirationReaper</span>-%d-%s&quot;.format(brokerId, purgatoryName</span>),</span></span><br><span class=\"line\"><span class=\"class\">    <span class=\"title\">false</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">doWork</span></span>() &#123;</span><br><span class=\"line\">      advanceClock(<span class=\"number\">200</span>L)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"DelayedProduce\"><a href=\"#DelayedProduce\" class=\"headerlink\" title=\"DelayedProduce\"></a>DelayedProduce</h3><p>这个类时为了协助ReplicaManager完成延迟操作的，ReplicaManager的主要功能是负责将生产者发送的消息写入Leader副本、管理Follower副本与Leader副本之间同步以及副本角色之间的转换，在消息写入Leader副本的时候需要DelayedProduce协助</p>\n<p>在ReplicaManager.appendRecords()方法中当ProduceRequest的acks为-1时，会创建一个DelayedProduce对象。</p>\n<p>当生产者调用KafkaProducer.send()方法后，KafkaApis.handleProduceRequest()方法会调用ReplicaManager.appendRecords()方法将消息追加到相应分区的Leader副本中。</p>\n<p>ProduceRequest的acks为-1时，意味着生产者需要等待该分区的所有副本都与Leader副本同步完成之后才会进行下一条消息的发送。DelayedOperation的作用就是控制在各分区各Follower副本和Leader副本同步完成后再向生产者应答</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * A delayed produce operation that can be created by the replica manager and watched</span></span><br><span class=\"line\"><span class=\"comment\"> * in the produce operation purgatory</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DelayedProduce</span>(<span class=\"params\">delayMs: <span class=\"type\">Long</span>, // 延迟时间</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                     produceMetadata: <span class=\"type\">ProduceMetadata</span>,//记录了本次<span class=\"type\">ProduceRequest</span>的ack信息以及对应分区对消息追加处理结果信息</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                     replicaManager: <span class=\"type\">ReplicaManager</span>,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                     responseCallback: <span class=\"type\">Map</span>[<span class=\"type\">TopicPartition</span>, <span class=\"type\">PartitionResponse</span>] =&gt; <span class=\"type\">Unit</span>,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                     lockOpt: <span class=\"type\">Option</span>[<span class=\"type\">Lock</span>] = <span class=\"type\">None</span></span>)</span></span><br><span class=\"line\"><span class=\"class\">  <span class=\"keyword\">extends</span> <span class=\"title\">DelayedOperation</span>(<span class=\"params\">delayMs, lockOpt</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// first update the acks pending variable according to the error code</span></span><br><span class=\"line\">  produceMetadata.produceStatus.foreach &#123; <span class=\"keyword\">case</span> (topicPartition, status) =&gt;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (status.responseStatus.error == <span class=\"type\">Errors</span>.<span class=\"type\">NONE</span>) &#123;</span><br><span class=\"line\">      <span class=\"comment\">// Timeout error state will be cleared when required acks are received</span></span><br><span class=\"line\">      status.acksPending = <span class=\"literal\">true</span></span><br><span class=\"line\">      status.responseStatus.error = <span class=\"type\">Errors</span>.<span class=\"type\">REQUEST_TIMED_OUT</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      status.acksPending = <span class=\"literal\">false</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    trace(<span class=\"string\">s&quot;Initial partition status for <span class=\"subst\">$topicPartition</span> is <span class=\"subst\">$status</span>&quot;</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * The delayed produce operation can be completed if every partition</span></span><br><span class=\"line\"><span class=\"comment\">   * it produces to is satisfied by one of the following:</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * Case A: This broker is no longer the leader: set an error in response</span></span><br><span class=\"line\"><span class=\"comment\">   * Case B: This broker is the leader:</span></span><br><span class=\"line\"><span class=\"comment\">   *   B.1 - If there was a local error thrown while checking if at least requiredAcks</span></span><br><span class=\"line\"><span class=\"comment\">   *         replicas have caught up to this operation: set an error in response</span></span><br><span class=\"line\"><span class=\"comment\">   *   B.2 - Otherwise, set the response with no error.</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">tryComplete</span></span>(): <span class=\"type\">Boolean</span> = &#123;</span><br><span class=\"line\">    <span class=\"comment\">// check for each partition if it still has pending acks</span></span><br><span class=\"line\">    produceMetadata.produceStatus.foreach &#123; <span class=\"keyword\">case</span> (topicPartition, status) =&gt;</span><br><span class=\"line\">      trace(<span class=\"string\">s&quot;Checking produce satisfaction for <span class=\"subst\">$topicPartition</span>, current status <span class=\"subst\">$status</span>&quot;</span>)</span><br><span class=\"line\">      <span class=\"comment\">// skip those partitions that have already been satisfied</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (status.acksPending) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">val</span> (hasEnough, error) = replicaManager.getPartition(topicPartition) <span class=\"keyword\">match</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">case</span> <span class=\"type\">Some</span>(partition) =&gt;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (partition eq <span class=\"type\">ReplicaManager</span>.<span class=\"type\">OfflinePartition</span>)</span><br><span class=\"line\">              (<span class=\"literal\">false</span>, <span class=\"type\">Errors</span>.<span class=\"type\">KAFKA_STORAGE_ERROR</span>)</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">              partition.checkEnoughReplicasReachOffset(status.requiredOffset)</span><br><span class=\"line\">          <span class=\"keyword\">case</span> <span class=\"type\">None</span> =&gt;</span><br><span class=\"line\">            <span class=\"comment\">// Case A</span></span><br><span class=\"line\">            (<span class=\"literal\">false</span>, <span class=\"type\">Errors</span>.<span class=\"type\">UNKNOWN_TOPIC_OR_PARTITION</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// Case B.1 || B.2</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (error != <span class=\"type\">Errors</span>.<span class=\"type\">NONE</span> || hasEnough) &#123;</span><br><span class=\"line\">          status.acksPending = <span class=\"literal\">false</span></span><br><span class=\"line\">          status.responseStatus.error = error</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// check if every partition has satisfied at least one of case A or B</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!produceMetadata.produceStatus.values.exists(_.acksPending))</span><br><span class=\"line\">      forceComplete()</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"literal\">false</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">onExpiration</span></span>() &#123;</span><br><span class=\"line\">    produceMetadata.produceStatus.foreach &#123; <span class=\"keyword\">case</span> (topicPartition, status) =&gt;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (status.acksPending) &#123;</span><br><span class=\"line\">        debug(<span class=\"string\">s&quot;Expiring produce request for partition <span class=\"subst\">$topicPartition</span> with status <span class=\"subst\">$status</span>&quot;</span>)</span><br><span class=\"line\">        <span class=\"type\">DelayedProduceMetrics</span>.recordExpiration(topicPartition)</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * 回调responseCallback</span></span><br><span class=\"line\"><span class=\"comment\">   * Upon completion, return the current response status along with the error code per partition</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">onComplete</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">val</span> responseStatus = produceMetadata.produceStatus.mapValues(status =&gt; status.responseStatus)</span><br><span class=\"line\">    responseCallback(responseStatus)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">object</span> <span class=\"title\">DelayedProduceMetrics</span> <span class=\"keyword\">extends</span> <span class=\"title\">KafkaMetricsGroup</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> aggregateExpirationMeter = newMeter(<span class=\"string\">&quot;ExpiresPerSec&quot;</span>, <span class=\"string\">&quot;requests&quot;</span>, <span class=\"type\">TimeUnit</span>.<span class=\"type\">SECONDS</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> partitionExpirationMeterFactory = (key: <span class=\"type\">TopicPartition</span>) =&gt;</span><br><span class=\"line\">    newMeter(<span class=\"string\">&quot;ExpiresPerSec&quot;</span>,</span><br><span class=\"line\">             <span class=\"string\">&quot;requests&quot;</span>,</span><br><span class=\"line\">             <span class=\"type\">TimeUnit</span>.<span class=\"type\">SECONDS</span>,</span><br><span class=\"line\">             tags = <span class=\"type\">Map</span>(<span class=\"string\">&quot;topic&quot;</span> -&gt; key.topic, <span class=\"string\">&quot;partition&quot;</span> -&gt; key.partition.toString))</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">val</span> partitionExpirationMeters = <span class=\"keyword\">new</span> <span class=\"type\">Pool</span>[<span class=\"type\">TopicPartition</span>, <span class=\"type\">Meter</span>](valueFactory = <span class=\"type\">Some</span>(partitionExpirationMeterFactory))</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">recordExpiration</span></span>(partition: <span class=\"type\">TopicPartition</span>) &#123;</span><br><span class=\"line\">    aggregateExpirationMeter.mark()</span><br><span class=\"line\">    partitionExpirationMeters.getAndMaybePut(partition).mark()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"DelayedFetch\"><a href=\"#DelayedFetch\" class=\"headerlink\" title=\"DelayedFetch\"></a>DelayedFetch</h3><p>在FetchRequest处理时进行延迟操作</p>\n<p>在kafka中只有消费者或是Follower副本会发起FetchRequest请求。FecthRequest是由KafkaApis.handleFetchRequest()方法处理的，该方法中会调用ReplicaManager.fetchMessages()方法从相应分区的Leader副本拉取消息，在ReplicaManager.fetchMessages()方法中会创建DelayedFetch延迟操作</p>\n<p>在拉取数据时之所以需要延迟操作，是为了让本次拉取消息获取到足够的数据。</p>\n<figure class=\"highlight scala\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DelayedFetch</span>(<span class=\"params\">delayMs: <span class=\"type\">Long</span>,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                   fetchMetadata: <span class=\"type\">FetchMetadata</span>,//包含了制定本次拉取操作获取数据的最小及最大字节数字段、是否只从<span class=\"type\">Leader</span>副本读取以及只读<span class=\"type\">HW</span>之前的数据的标志字段、一个用来标识是消费者还是<span class=\"type\">Follower</span>副本的replicaId字段、用来记录本次从每个分区拉取结果的fetchPartitionsStatus字段</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                   replicaManager: <span class=\"type\">ReplicaManager</span>,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                   quota: <span class=\"type\">ReplicaQuota</span>,</span></span></span><br><span class=\"line\"><span class=\"class\"><span class=\"params\">                   responseCallback: <span class=\"type\">Seq</span>[(<span class=\"type\">TopicPartition</span>, <span class=\"type\">FetchPartitionData</span></span>)] <span class=\"title\">=&gt;</span> <span class=\"title\">Unit</span>)</span></span><br><span class=\"line\"><span class=\"class\">  <span class=\"keyword\">extends</span> <span class=\"title\">DelayedOperation</span>(<span class=\"params\">delayMs</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * The operation can be completed if:</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * Case A: This broker is no longer the leader for some partitions it tries to fetch</span></span><br><span class=\"line\"><span class=\"comment\">   * Case B: This broker does not know of some partitions it tries to fetch</span></span><br><span class=\"line\"><span class=\"comment\">   * Case C: The fetch offset locates not on the last segment of the log</span></span><br><span class=\"line\"><span class=\"comment\">   * Case D: The accumulated bytes from all the fetching partitions exceeds the minimum bytes</span></span><br><span class=\"line\"><span class=\"comment\">   * Case E: The partition is in an offline log directory on this broker</span></span><br><span class=\"line\"><span class=\"comment\">   * Case F: This broker is the leader, but the requested epoch is now fenced</span></span><br><span class=\"line\"><span class=\"comment\">   *</span></span><br><span class=\"line\"><span class=\"comment\">   * Upon completion, should return whatever data is available for each valid partition</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">tryComplete</span></span>(): <span class=\"type\">Boolean</span> = &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> accumulatedSize = <span class=\"number\">0</span></span><br><span class=\"line\">    fetchMetadata.fetchPartitionStatus.foreach &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> (topicPartition, fetchStatus) =&gt;</span><br><span class=\"line\">        <span class=\"keyword\">val</span> fetchOffset = fetchStatus.startOffsetMetadata</span><br><span class=\"line\">        <span class=\"keyword\">val</span> fetchLeaderEpoch = fetchStatus.fetchInfo.currentLeaderEpoch</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (fetchOffset != <span class=\"type\">LogOffsetMetadata</span>.<span class=\"type\">UnknownOffsetMetadata</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">val</span> partition = replicaManager.getPartitionOrException(topicPartition,</span><br><span class=\"line\">              expectLeader = fetchMetadata.fetchOnlyLeader)</span><br><span class=\"line\">            <span class=\"keyword\">val</span> offsetSnapshot = partition.fetchOffsetSnapshot(fetchLeaderEpoch, fetchMetadata.fetchOnlyLeader)</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">val</span> endOffset = fetchMetadata.fetchIsolation <span class=\"keyword\">match</span> &#123;</span><br><span class=\"line\">              <span class=\"keyword\">case</span> <span class=\"type\">FetchLogEnd</span> =&gt; offsetSnapshot.logEndOffset</span><br><span class=\"line\">              <span class=\"keyword\">case</span> <span class=\"type\">FetchHighWatermark</span> =&gt; offsetSnapshot.highWatermark</span><br><span class=\"line\">              <span class=\"keyword\">case</span> <span class=\"type\">FetchTxnCommitted</span> =&gt; offsetSnapshot.lastStableOffset</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// Go directly to the check for Case D if the message offsets are the same. If the log segment</span></span><br><span class=\"line\">            <span class=\"comment\">// has just rolled, then the high watermark offset will remain the same but be on the old segment,</span></span><br><span class=\"line\">            <span class=\"comment\">// which would incorrectly be seen as an instance of Case C.</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (endOffset.messageOffset != fetchOffset.messageOffset) &#123;</span><br><span class=\"line\">              <span class=\"keyword\">if</span> (endOffset.onOlderSegment(fetchOffset)) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Case C, this can happen when the new fetch operation is on a truncated leader</span></span><br><span class=\"line\">                debug(<span class=\"string\">s&quot;Satisfying fetch <span class=\"subst\">$fetchMetadata</span> since it is fetching later segments of partition <span class=\"subst\">$topicPartition</span>.&quot;</span>)</span><br><span class=\"line\">                <span class=\"keyword\">return</span> forceComplete()</span><br><span class=\"line\">              &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (fetchOffset.onOlderSegment(endOffset)) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Case C, this can happen when the fetch operation is falling behind the current segment</span></span><br><span class=\"line\">                <span class=\"comment\">// or the partition has just rolled a new segment</span></span><br><span class=\"line\">                debug(<span class=\"string\">s&quot;Satisfying fetch <span class=\"subst\">$fetchMetadata</span> immediately since it is fetching older segments.&quot;</span>)</span><br><span class=\"line\">                <span class=\"comment\">// We will not force complete the fetch request if a replica should be throttled.</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!replicaManager.shouldLeaderThrottle(quota, topicPartition, fetchMetadata.replicaId))</span><br><span class=\"line\">                  <span class=\"keyword\">return</span> forceComplete()</span><br><span class=\"line\">              &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (fetchOffset.messageOffset &lt; endOffset.messageOffset) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// we take the partition fetch size as upper bound when accumulating the bytes (skip if a throttled partition)</span></span><br><span class=\"line\">                <span class=\"keyword\">val</span> bytesAvailable = math.min(endOffset.positionDiff(fetchOffset), fetchStatus.fetchInfo.maxBytes)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!replicaManager.shouldLeaderThrottle(quota, topicPartition, fetchMetadata.replicaId))</span><br><span class=\"line\">                  accumulatedSize += bytesAvailable</span><br><span class=\"line\">              &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> &#123;</span><br><span class=\"line\">          <span class=\"keyword\">case</span> _: <span class=\"type\">KafkaStorageException</span> =&gt; <span class=\"comment\">// Case E</span></span><br><span class=\"line\">            debug(<span class=\"string\">s&quot;Partition <span class=\"subst\">$topicPartition</span> is in an offline log directory, satisfy <span class=\"subst\">$fetchMetadata</span> immediately&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> forceComplete()</span><br><span class=\"line\">          <span class=\"keyword\">case</span> _: <span class=\"type\">UnknownTopicOrPartitionException</span> =&gt; <span class=\"comment\">// Case B</span></span><br><span class=\"line\">            debug(<span class=\"string\">s&quot;Broker no longer knows of partition <span class=\"subst\">$topicPartition</span>, satisfy <span class=\"subst\">$fetchMetadata</span> immediately&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> forceComplete()</span><br><span class=\"line\">          <span class=\"keyword\">case</span> _: <span class=\"type\">FencedLeaderEpochException</span> =&gt; <span class=\"comment\">// Case F</span></span><br><span class=\"line\">            debug(<span class=\"string\">s&quot;Broker is the leader of partition <span class=\"subst\">$topicPartition</span>, but the requested epoch &quot;</span> +</span><br><span class=\"line\">              <span class=\"string\">s&quot;<span class=\"subst\">$fetchLeaderEpoch</span> is fenced by the latest leader epoch, satisfy <span class=\"subst\">$fetchMetadata</span> immediately&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> forceComplete()</span><br><span class=\"line\">          </span><br><span class=\"line\">          <span class=\"keyword\">case</span> _: <span class=\"type\">NotLeaderForPartitionException</span> =&gt;  <span class=\"comment\">// Case A</span></span><br><span class=\"line\">            debug(<span class=\"string\">&quot;Broker is no longer the leader of %s, satisfy %s immediately&quot;</span>.format(topicPartition, fetchMetadata))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> forceComplete()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// Case D</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (accumulatedSize &gt;= fetchMetadata.fetchMinBytes)</span><br><span class=\"line\">       forceComplete()</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"literal\">false</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">onExpiration</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (fetchMetadata.isFromFollower)</span><br><span class=\"line\">      <span class=\"type\">DelayedFetchMetrics</span>.followerExpiredRequestMeter.mark()</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">      <span class=\"type\">DelayedFetchMetrics</span>.consumerExpiredRequestMeter.mark()</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">   * Upon completion, read whatever data is available and pass to the complete callback</span></span><br><span class=\"line\"><span class=\"comment\">   */</span></span><br><span class=\"line\">  <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">onComplete</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">val</span> logReadResults = replicaManager.readFromLocalLog(</span><br><span class=\"line\">      replicaId = fetchMetadata.replicaId,</span><br><span class=\"line\">      fetchOnlyFromLeader = fetchMetadata.fetchOnlyLeader,</span><br><span class=\"line\">      fetchIsolation = fetchMetadata.fetchIsolation,</span><br><span class=\"line\">      fetchMaxBytes = fetchMetadata.fetchMaxBytes,</span><br><span class=\"line\">      hardMaxBytesLimit = fetchMetadata.hardMaxBytesLimit,</span><br><span class=\"line\">      readPartitionInfo = fetchMetadata.fetchPartitionStatus.map &#123; <span class=\"keyword\">case</span> (tp, status) =&gt; tp -&gt; status.fetchInfo &#125;,</span><br><span class=\"line\">      quota = quota)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">val</span> fetchPartitionData = logReadResults.map &#123; <span class=\"keyword\">case</span> (tp, result) =&gt;</span><br><span class=\"line\">      tp -&gt; <span class=\"type\">FetchPartitionData</span>(result.error, result.highWatermark, result.leaderLogStartOffset, result.info.records,</span><br><span class=\"line\">        result.lastStableOffset, result.info.abortedTransactions)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    responseCallback(fetchPartitionData)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>满足以下条件之一则表示可完成延迟操作执行</p>\n<ul>\n<li><p>拉取消息的分区不存在</p>\n</li>\n<li><p>Leader副本发生了迁移，当前代理不再是Leader副本</p>\n</li>\n<li><p>日志段发生了切割，请求拉取的消息偏移量已不在活跃段内，同时Leader副本没有处在限流处理的状态</p>\n</li>\n<li><p>累积拉取的消息数已超过了最小字节数限制</p>\n</li>\n</ul>\n<h3 id=\"DelayedJoin\"><a href=\"#DelayedJoin\" class=\"headerlink\" title=\"DelayedJoin\"></a>DelayedJoin</h3><p>DelayedJoin是协助组协调器在消费组准备平衡操作时进行相应的处理。当消费者组的状态转换为PreparingRebalance时，准备进行平衡操作，在组协调器的prepareRebalance()方法中会创建一个DelayedJoin对象，并交由DelayedOperationPurgatory负责监视管理</p>\n<p>在消费者组进行平衡操作时之所以需要DelayedJoin处理，是为了让组协调器等待当前消费组下所有的消费者都请求加入消费组，即发起了JoinGourpRequest请求。每次组协调器处理完JoinGroupRequest时都会检测DelayedJoin是否满足完成执行的条件</p>\n<p>只有当所有消费者均已申请加入消费组才算是满足了执行条件</p>\n<h3 id=\"DelayedHeartbeat\"><a href=\"#DelayedHeartbeat\" class=\"headerlink\" title=\"DelayedHeartbeat\"></a>DelayedHeartbeat</h3><p>用于协助消费者与组协调器心跳检测相关的延迟操作</p>\n<h3 id=\"DelayedCreateTopics\"><a href=\"#DelayedCreateTopics\" class=\"headerlink\" title=\"DelayedCreateTopics\"></a>DelayedCreateTopics</h3><p>在创建主题时，需要为主题的每个分区分配到Leader之后，才调用回调函数将创建主题结果返回给客户端</p>\n","categories":["kafka"],"tags":["kafka"]},{"title":"redis数据结构","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/","content":"<h2 id=\"redis数据结构\"><a href=\"#redis数据结构\" class=\"headerlink\" title=\"redis数据结构\"></a>redis数据结构</h2><p>redis全名(Remote Dictionary Server)，即远程字典服务</p>\n<p>redis的值的数据结构类型有String、List、Set、Hash、zset(sorted set，有序集合)、Bitmaps(位图)、HyperLogLogs</p>\n<blockquote>\n<p>注意：我使用的版本是6.0.10，不同版本可能略有差别</p>\n</blockquote>\n<p>redis中key的最大长度为512M</p>\n<h3 id=\"对象\"><a href=\"#对象\" class=\"headerlink\" title=\"对象\"></a>对象</h3><figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">redisObject</span> &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 对象的类型</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> type:<span class=\"number\">4</span>;</span><br><span class=\"line\">      <span class=\"comment\">// 编码</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> encoding:<span class=\"number\">4</span>;</span><br><span class=\"line\">      <span class=\"comment\">// 记录最后一次被访问的时间</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> lru:LRU_BITS; <span class=\"comment\">/* LRU time (relative to global lru_clock) or</span></span><br><span class=\"line\"><span class=\"comment\">                            * LFU data (least significant 8 bits frequency</span></span><br><span class=\"line\"><span class=\"comment\">    // 引用计数                        * and most significant 16 bits access time). */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> refcount;</span><br><span class=\"line\">      <span class=\"comment\">// 指向底层实现的指针</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> *ptr;</span><br><span class=\"line\">&#125; robj;</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h4 id=\"类型总览\"><a href=\"#类型总览\" class=\"headerlink\" title=\"类型总览\"></a>类型总览</h4><p>redis中的数据类型，即为redisObject的type属性</p>\n<figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// string</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_STRING 0    <span class=\"comment\">/* String object. */</span></span></span><br><span class=\"line\"><span class=\"comment\">// list</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_LIST 1      <span class=\"comment\">/* List object. */</span></span></span><br><span class=\"line\"><span class=\"comment\">// set</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_SET 2       <span class=\"comment\">/* Set object. */</span></span></span><br><span class=\"line\"><span class=\"comment\">//zset</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ZSET 3      <span class=\"comment\">/* Sorted set object. */</span></span></span><br><span class=\"line\"><span class=\"comment\">//hash</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_HASH 4      <span class=\"comment\">/* Hash object. */</span></span></span><br><span class=\"line\"><span class=\"comment\">// module</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_MODULE 5    <span class=\"comment\">/* Module object. */</span></span></span><br><span class=\"line\"><span class=\"comment\">// stream</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_STREAM 6    <span class=\"comment\">/* Stream object. */</span></span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">可以使用<span class=\"built_in\">type</span>命令来查看该键所对应值的类型</span></span><br><span class=\"line\">type key</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"redis的编码分类\"><a href=\"#redis的编码分类\" class=\"headerlink\" title=\"redis的编码分类\"></a>redis的编码分类</h4><p>对应于redisObject的ecoding属性，encoding是决定对象底层实现数据结构的</p>\n<figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 简单动态字符串  raw</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_RAW 0     <span class=\"comment\">/* Raw representation */</span></span></span><br><span class=\"line\"><span class=\"comment\">// long类型的整数 int</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_INT 1     <span class=\"comment\">/* Encoded as integer */</span></span></span><br><span class=\"line\"><span class=\"comment\">// 哈希表  hashtable</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_HT 2      <span class=\"comment\">/* Encoded as hash table */</span></span></span><br><span class=\"line\"><span class=\"comment\">// 压缩  不再使用</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_ZIPMAP 3  <span class=\"comment\">/* Encoded as zipmap */</span></span></span><br><span class=\"line\"><span class=\"comment\">// 双向链表  不再使用该结构</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_LINKEDLIST 4 <span class=\"comment\">/* No longer used: old list encoding. */</span></span></span><br><span class=\"line\"><span class=\"comment\">// 压缩列表  ziplist</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_ZIPLIST 5 <span class=\"comment\">/* Encoded as ziplist */</span></span></span><br><span class=\"line\"><span class=\"comment\">// 整数集合  intset</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_INTSET 6  <span class=\"comment\">/* Encoded as intset */</span></span></span><br><span class=\"line\"><span class=\"comment\">// 跳表  skiplist</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_SKIPLIST 7  <span class=\"comment\">/* Encoded as skiplist */</span></span></span><br><span class=\"line\"><span class=\"comment\">// embstr编码的简单动态字符串  embstr</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_EMBSTR 8  <span class=\"comment\">/* Embedded sds string encoding */</span></span></span><br><span class=\"line\"><span class=\"comment\">// 快表  quicklist</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_QUICKLIST 9 <span class=\"comment\">/* Encoded as linked list of ziplists */</span></span></span><br><span class=\"line\"><span class=\"comment\">// 流  stream</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> OBJ_ENCODING_STREAM 10 <span class=\"comment\">/* Encoded as a radix tree of listpacks */</span></span></span><br></pre></td></tr></table></figure>\n\n<p>可以使用命令   </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">object encoding key</span><br></pre></td></tr></table></figure>\n\n<p>来查看该key使用的是哪种编码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">6379</span>&gt; <span class=\"built_in\">set</span> test_int <span class=\"number\">1</span></span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">6379</span>&gt; object encoding test_int</span><br><span class=\"line\"><span class=\"string\">&quot;int&quot;</span></span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">6379</span>&gt; <span class=\"built_in\">set</span> test_raw zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">6379</span>&gt; <span class=\"built_in\">strlen</span> test_raw</span><br><span class=\"line\">(integer) <span class=\"number\">44</span></span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">6379</span>&gt; object encoding test_raw</span><br><span class=\"line\"><span class=\"string\">&quot;embstr&quot;</span></span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">6379</span>&gt; <span class=\"built_in\">set</span> test_raw zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz</span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">6379</span>&gt; object encoding test_raw</span><br><span class=\"line\"><span class=\"string\">&quot;raw&quot;</span></span><br><span class=\"line\"><span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span>:<span class=\"number\">6379</span>&gt; <span class=\"built_in\">strlen</span> test_raw</span><br><span class=\"line\">(integer) <span class=\"number\">45</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"String类型\"><a href=\"#String类型\" class=\"headerlink\" title=\"String类型\"></a>String类型</h3><p>string类型属于单值单value，是一个可变的字节数组，就像StringBuilder似的，可以追加、获取长度、截取等操作</p>\n<blockquote>\n<p>扩容：当字符串长度小于1M时，扩容是现有空间进行加倍；当字符串长度超过1M，扩容只会多扩1M的空间。且字符串最长为512M</p>\n</blockquote>\n<h4 id=\"源码结构\"><a href=\"#源码结构\" class=\"headerlink\" title=\"源码结构\"></a>源码结构</h4><figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> __<span class=\"title\">attribute__</span> ((__<span class=\"title\">packed__</span>)) <span class=\"title\">sdshdr5</span> &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 存储了字符串的类型和长度，3位存类型，5位存长度</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> flags; <span class=\"comment\">/* 3 lsb of type, and 5 msb of string length */</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> __<span class=\"title\">attribute__</span> ((__<span class=\"title\">packed__</span>)) <span class=\"title\">sdshdr8</span> &#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">uint8_t</span> len; <span class=\"comment\">/* used */</span></span><br><span class=\"line\">    <span class=\"keyword\">uint8_t</span> alloc; <span class=\"comment\">/* excluding the header and null terminator */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> flags; <span class=\"comment\">/* 3 lsb of type, 5 unused bits */</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> __<span class=\"title\">attribute__</span> ((__<span class=\"title\">packed__</span>)) <span class=\"title\">sdshdr16</span> &#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">uint16_t</span> len; <span class=\"comment\">/* used */</span></span><br><span class=\"line\">    <span class=\"keyword\">uint16_t</span> alloc; <span class=\"comment\">/* excluding the header and null terminator */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> flags; <span class=\"comment\">/* 3 lsb of type, 5 unused bits */</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> __<span class=\"title\">attribute__</span> ((__<span class=\"title\">packed__</span>)) <span class=\"title\">sdshdr32</span> &#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> len; <span class=\"comment\">/* used */</span></span><br><span class=\"line\">    <span class=\"keyword\">uint32_t</span> alloc; <span class=\"comment\">/* excluding the header and null terminator */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> flags; <span class=\"comment\">/* 3 lsb of type, 5 unused bits */</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[];</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">struct</span> __<span class=\"title\">attribute__</span> ((__<span class=\"title\">packed__</span>)) <span class=\"title\">sdshdr64</span> &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">// 字符串长度</span></span><br><span class=\"line\">    <span class=\"keyword\">uint64_t</span> len; <span class=\"comment\">/* used */</span></span><br><span class=\"line\">      <span class=\"comment\">// 内存分配</span></span><br><span class=\"line\">    <span class=\"keyword\">uint64_t</span> alloc; <span class=\"comment\">/* excluding the header and null terminator */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> flags; <span class=\"comment\">/* 3 lsb of type, 5 unused bits */</span></span><br><span class=\"line\">      <span class=\"comment\">// 字节数组</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[];</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"编码格式\"><a href=\"#编码格式\" class=\"headerlink\" title=\"编码格式\"></a>编码格式</h4><table>\n<thead>\n<tr>\n<th>编码</th>\n<th>对象</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OBJ_ENCODING_INT</td>\n<td>使用整数值实现的字符串对象</td>\n</tr>\n<tr>\n<td>OBJ_ENCODING_EMBSTR</td>\n<td>使用embstr编码的简单动态字符串实现的字符串对象</td>\n</tr>\n<tr>\n<td>OBJ_ENCODING_RAW</td>\n<td>使用简单动态字符串实现的字符串对象</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>string有三种编码格式</p>\n<ul>\n<li><p>int   整数值</p>\n</li>\n<li><p>embstr  用于存储短字符串的编码方式，字符串长度小于44字节使用，数据保存在一块连续的内存里</p>\n</li>\n<li><p>raw  字符串值长度大于44字节使用</p>\n</li>\n</ul>\n</blockquote>\n<h4 id=\"embstr和raw两种编码的区别\"><a href=\"#embstr和raw两种编码的区别\" class=\"headerlink\" title=\"embstr和raw两种编码的区别\"></a>embstr和raw两种编码的区别</h4><p>embstr编码用于保存短字符串，与raw编码一样，都是使用redisObject结构和sdshdr结构来表示字符串对象,但是raw编码会调用两次内存分配函数来分别创建redisObject结构和sdshdr结构，而embstr编码则通过调用一次内存分配函数来分配一块连续的内存空间，空间中依次包含redisObject和sdshdr两个结构</p>\n<h4 id=\"操作命令\"><a href=\"#操作命令\" class=\"headerlink\" title=\"操作命令\"></a>操作命令</h4><p><strong>值拼接</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">给key对应的value进行拼接，返回的是拼接之后的字符长度</span></span><br><span class=\"line\">append k1 qwe</span><br><span class=\"line\">(integer) 5</span><br></pre></td></tr></table></figure>\n\n<p><strong>值长度</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">strlen k1</span><br></pre></td></tr></table></figure>\n\n<p> <strong>数字运算操作</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">加一</span></span><br><span class=\"line\">INCR k2</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">减一</span></span><br><span class=\"line\">DECR k2</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">加3</span></span><br><span class=\"line\">INCRBY k2 3</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">减2</span></span><br><span class=\"line\">DECRBY k2 2</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意：这几个命令只能对数字进行操作，范围是Long.MIN~Long.MAX</p>\n</blockquote>\n<p><strong>获取值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">get k1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">只获取该key所对应value的部分字符</span></span><br><span class=\"line\">getrange k1 0 2</span><br></pre></td></tr></table></figure>\n\n<p><strong>设置值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> setrange覆盖部分值  其中0为从下标为0的字符开始替换</span></span><br><span class=\"line\">setrange k1 0 zx</span><br><span class=\"line\">(integer) 5</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置值时设置过期时间</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">setex key seconds value</span></span><br><span class=\"line\">setex k3 20 b</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">如果key不存在设置值,防止覆盖(<span class=\"built_in\">set</span> <span class=\"keyword\">if</span> not exists)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">setnx key value</span></span><br><span class=\"line\">setnx k1 1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 设置key的值，并返回key的旧值</span></span><br><span class=\"line\">getset k1 vv1</span><br></pre></td></tr></table></figure>\n\n<p><strong>多值操作</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">同时<span class=\"built_in\">set</span>多个键值</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">mset key value [key value ...]</span></span><br><span class=\"line\">mset k4 v4 k5 v5</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">同时获取多个键的值</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">mget key  [key ...]</span></span><br><span class=\"line\">mget k4 k5 </span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">同时<span class=\"built_in\">set</span>多个键值(全部不存在时才会设置值)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">msetnx key value [key value ...]</span></span><br><span class=\"line\">msetnx k6 v6 k7 k8</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"List类型\"><a href=\"#List类型\" class=\"headerlink\" title=\"List类型\"></a>List类型</h3><p>List属于单值多value，链表用的是双向链表结构</p>\n<p>list支持pop、push来操作头部和尾部，既可以用做栈也可以用做队列</p>\n<h4 id=\"源码结构-1\"><a href=\"#源码结构-1\" class=\"headerlink\" title=\"源码结构\"></a>源码结构</h4><figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">listNode</span> &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 前驱节点</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">listNode</span> *<span class=\"title\">prev</span>;</span></span><br><span class=\"line\">      <span class=\"comment\">// 后继节点</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">listNode</span> *<span class=\"title\">next</span>;</span></span><br><span class=\"line\">      <span class=\"comment\">// 值</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> *value;</span><br><span class=\"line\">&#125; listNode;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">list</span> &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 头节点</span></span><br><span class=\"line\">    listNode *head;</span><br><span class=\"line\">      <span class=\"comment\">// 尾结点</span></span><br><span class=\"line\">    listNode *tail;</span><br><span class=\"line\">      <span class=\"comment\">// 节点值复制函数</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> *(*dup)(<span class=\"keyword\">void</span> *ptr);</span><br><span class=\"line\">      <span class=\"comment\">// 节点值释放函数</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> (*<span class=\"built_in\">free</span>)(<span class=\"keyword\">void</span> *ptr);</span><br><span class=\"line\">      <span class=\"comment\">// 节点值对比函数</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> (*match)(<span class=\"keyword\">void</span> *ptr, <span class=\"keyword\">void</span> *key);</span><br><span class=\"line\">      <span class=\"comment\">// 链表中包含的节点数量</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> len;</span><br><span class=\"line\">&#125; <span class=\"built_in\">list</span>;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这个结构不知道还用不用，因为看源码来说在创建list的时候创建的是quicklist</p>\n</blockquote>\n<p>quicklist结构</p>\n<figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">quicklist</span> &#123;</span></span><br><span class=\"line\">    quicklistNode *head;</span><br><span class=\"line\">    quicklistNode *tail;</span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> count;        <span class=\"comment\">/* total count of all entries in all ziplists */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> len;          <span class=\"comment\">/* number of quicklistNodes */</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> fill : QL_FILL_BITS;              <span class=\"comment\">/* fill factor for individual nodes */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> compress : QL_COMP_BITS; <span class=\"comment\">/* depth of end nodes not to compress;0=off */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> bookmark_count: QL_BM_BITS;</span><br><span class=\"line\">    quicklistBookmark bookmarks[];</span><br><span class=\"line\">&#125; quicklist;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">quicklistNode</span> &#123;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">quicklistNode</span> *<span class=\"title\">prev</span>;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">quicklistNode</span> *<span class=\"title\">next</span>;</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">char</span> *zl;</span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> sz;             <span class=\"comment\">/* ziplist size in bytes */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> count : <span class=\"number\">16</span>;     <span class=\"comment\">/* count of items in ziplist */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> encoding : <span class=\"number\">2</span>;   <span class=\"comment\">/* RAW==1 or LZF==2 */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> container : <span class=\"number\">2</span>;  <span class=\"comment\">/* NONE==1 or ZIPLIST==2 */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> recompress : <span class=\"number\">1</span>; <span class=\"comment\">/* was this node previous compressed? */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> attempted_compress : <span class=\"number\">1</span>; <span class=\"comment\">/* node can&#x27;t compress; too small */</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">int</span> extra : <span class=\"number\">10</span>; <span class=\"comment\">/* more bits to steal for future usage */</span></span><br><span class=\"line\">&#125; quicklistNode;</span><br></pre></td></tr></table></figure>\n\n<p>而对于quicklist编码的定义是</p>\n<figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\">OBJ_ENCODING_QUICKLIST <span class=\"number\">9</span> <span class=\"comment\">/* Encoded as linked list of ziplists */</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>看代码像是存到quicklist中，然后又使用ziplist压缩的，毕竟不是专业的c语言开发，看的并不是那么明白</p>\n</blockquote>\n<h4 id=\"操作命令-1\"><a href=\"#操作命令-1\" class=\"headerlink\" title=\"操作命令\"></a>操作命令</h4><p><strong>设置值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">lpush(指从左边进 左进右出  就想是栈一样)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">lpush key element [element ...]</span></span><br><span class=\"line\">lpush list1 1 2 3 4 5</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">取值</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">lrange key start end   (负下标表示的是从后往前，如-1表示倒数第一)</span></span><br><span class=\"line\">lrange list1 0 -1</span><br><span class=\"line\">1) &quot;5&quot;</span><br><span class=\"line\">2) &quot;4&quot;</span><br><span class=\"line\">3) &quot;3&quot;</span><br><span class=\"line\">4) &quot;2&quot;</span><br><span class=\"line\">5) &quot;1&quot;</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">rpush(指从右边进 右进左出  就想是栈一样)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">rpush key element [element ...]</span></span><br><span class=\"line\">rpush list2 1 2 3 4 5</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">给某个索引位置赋值</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">lset key index element</span></span><br><span class=\"line\">lset list1 0 q</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">在某个元素之前或之后插入一个元素</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">linsert key before|after pivot element</span></span><br><span class=\"line\">linsert list1 before q zz</span><br></pre></td></tr></table></figure>\n\n<p><strong>取值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">弹出栈顶元素(从左边开始弹出，弹出之后，list中就不存在该元素了)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">lpop key </span></span><br><span class=\"line\">lpop list1</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">弹出栈顶元素(从右边开始弹出，弹出之后，list中就不存在该元素了)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">rpop key </span></span><br><span class=\"line\">rpop list1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">按照索引位置取值</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">lindex key index</span></span><br><span class=\"line\">lindex list1 0</span><br></pre></td></tr></table></figure>\n\n<p><strong>列表长度</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">llen list1</span><br></pre></td></tr></table></figure>\n\n<p><strong>删除值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">删除几个某个元素</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">lrem key count element</span></span><br><span class=\"line\">lrem list1 1 2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">截取指定范围的值赋给key(范围是索引)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">ltrim key start stop</span></span><br><span class=\"line\">ltrim list1 0 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 从头部删除元素  出栈</span></span><br><span class=\"line\">lpop list1</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 从尾部删除元素</span></span><br><span class=\"line\">rpop list1</span><br></pre></td></tr></table></figure>\n\n<p><strong>出栈入栈</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">从源列表右出栈压入左目标列表</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">rpoplpush <span class=\"built_in\">source</span> dest</span></span><br><span class=\"line\">rpoplpush list2 list1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Set类型\"><a href=\"#Set类型\" class=\"headerlink\" title=\"Set类型\"></a>Set类型</h3><p>set类型是单值多value，与List的区别在于不可重复，类似于HashSet，通过hash table实现的</p>\n<p>set除了基本的增删改查操作之外，还可以使用集合来取并集、交集、差集，可以用来实现好友推荐等功能</p>\n<h4 id=\"编码格式-1\"><a href=\"#编码格式-1\" class=\"headerlink\" title=\"编码格式\"></a>编码格式</h4><table>\n<thead>\n<tr>\n<th>编码</th>\n<th>对象</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OBJ_ENCODING_INTSET</td>\n<td>使用整数集合实现的集合对象</td>\n</tr>\n<tr>\n<td>OBJ_ENCODING_HT</td>\n<td>使用的hash table</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>set有两种编码格式</p>\n<ul>\n<li>intset   保存的元素全都是整数，且元素数量不超过512</li>\n<li>hash table  保存的不是整数</li>\n</ul>\n</blockquote>\n<figure class=\"highlight dsconfig\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#根据该配置项来进行编码转换的</span></span><br><span class=\"line\"><span class=\"built_in\">set-max-intset-entries</span> <span class=\"string\">512</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"操作命令-2\"><a href=\"#操作命令-2\" class=\"headerlink\" title=\"操作命令\"></a>操作命令</h4><p><strong>设置值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置值</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">sadd key member [member ...]</span></span><br><span class=\"line\">sadd set1 vv vc vb vv</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong>取值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">取值</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">smembers key</span></span><br><span class=\"line\">smembers set1</span><br><span class=\"line\">1) &quot;vc&quot;</span><br><span class=\"line\">2) &quot;vb&quot;</span><br><span class=\"line\">3) &quot;vv&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">判断该元素是否在<span class=\"built_in\">set</span>中</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">sismember key member</span></span><br><span class=\"line\">sismember set1 vv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">获取随机的元素(count表示获取的数量，默认为1)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">srandmember key [count]</span></span><br><span class=\"line\">srandmember set1 2</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看集合元素个数</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">scard key</span></span><br><span class=\"line\">scard set1</span><br></pre></td></tr></table></figure>\n\n<p><strong>删除</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">srem key member</span></span><br><span class=\"line\">srem set1 vb</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">随机出栈(默认数量为1)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">spop key [count]</span></span><br><span class=\"line\">spop set1</span><br></pre></td></tr></table></figure>\n\n<p><strong>随机抽取</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">随机从集合中抽取2个(默认1个)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">srandmember key [count]</span></span><br><span class=\"line\">srandmember set1 2</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">将源集合中的值移至目标集合</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">smove <span class=\"built_in\">source</span> dest member</span></span><br><span class=\"line\">smove set1 set2 5</span><br></pre></td></tr></table></figure>\n\n<p><strong>差集  交集  并集</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">差集 返回的是其他key与第一个key的差集</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">sdiff key [key ...]</span></span><br><span class=\"line\">sdiff set1 set2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">交集</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">sinter key [key ...]</span></span><br><span class=\"line\">sinter set1 set2</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">并集</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">sunion key [key ...]</span></span><br><span class=\"line\">sunion set1 set2</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Hash类型\"><a href=\"#Hash类型\" class=\"headerlink\" title=\"Hash类型\"></a>Hash类型</h3><p>value是键值对，相当于HashMap，对于hash碰撞也是采用的HashMap的处理方式，数组+链表</p>\n<p>更适合存储对象，将一个对象存储在hash类型中会占用更少的内存，且可以更方便的存取整个对象</p>\n<h4 id=\"编码格式-2\"><a href=\"#编码格式-2\" class=\"headerlink\" title=\"编码格式\"></a>编码格式</h4><table>\n<thead>\n<tr>\n<th>编码</th>\n<th>对象</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OBJ_ENCODING_ZIPLIST</td>\n<td>使用ziplist</td>\n</tr>\n<tr>\n<td>OBJ_ENCODING_HT</td>\n<td>使用的hash table</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>set有两种编码格式</p>\n<ul>\n<li>ziplist   一开始存储使用的ziplist，但是当满足一定条件时会转换为hash table</li>\n<li>hash table  </li>\n</ul>\n</blockquote>\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#根据该配置项来进行编码转换的</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">512</span></span><br><span class=\"line\">hash-<span class=\"built_in\">max</span>-ziplist-<span class=\"built_in\">value</span> <span class=\"number\">64</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"源码结构-2\"><a href=\"#源码结构-2\" class=\"headerlink\" title=\"源码结构\"></a>源码结构</h4><figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dictht</span> &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 哈希表数组</span></span><br><span class=\"line\">    dictEntry **table;</span><br><span class=\"line\">      <span class=\"comment\">// 哈希表大小</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> size;</span><br><span class=\"line\">      <span class=\"comment\">// 哈希表大小掩码，用于计算索引值</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> sizemask;</span><br><span class=\"line\">      <span class=\"comment\">// 哈希表已有节点数量</span></span><br><span class=\"line\">    <span class=\"keyword\">unsigned</span> <span class=\"keyword\">long</span> used;</span><br><span class=\"line\">&#125; dictht;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dictEntry</span> &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 键</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> *key;</span><br><span class=\"line\">      <span class=\"comment\">// 值</span></span><br><span class=\"line\">    <span class=\"keyword\">union</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">void</span> *val;</span><br><span class=\"line\">        <span class=\"keyword\">uint64_t</span> u64;</span><br><span class=\"line\">        <span class=\"keyword\">int64_t</span> s64;</span><br><span class=\"line\">        <span class=\"keyword\">double</span> d;</span><br><span class=\"line\">    &#125; v;</span><br><span class=\"line\">      <span class=\"comment\">// 下一个哈希节点，链表</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dictEntry</span> *<span class=\"title\">next</span>;</span></span><br><span class=\"line\">&#125; dictEntry;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">dict</span> &#123;</span></span><br><span class=\"line\">      <span class=\"comment\">// 类型</span></span><br><span class=\"line\">    dictType *type;</span><br><span class=\"line\">      <span class=\"comment\">// 私有数据</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> *privdata;</span><br><span class=\"line\">      <span class=\"comment\">// 哈希表</span></span><br><span class=\"line\">      <span class=\"comment\">// ht[0]:用来存放真是的数据</span></span><br><span class=\"line\">      <span class=\"comment\">// ht[1]:用于扩容</span></span><br><span class=\"line\">    dictht ht[<span class=\"number\">2</span>];</span><br><span class=\"line\">      <span class=\"comment\">//rehash 如果为-1表示没有进行rehash</span></span><br><span class=\"line\">    <span class=\"keyword\">long</span> rehashidx; <span class=\"comment\">/* rehashing not in progress if rehashidx == -1 */</span></span><br><span class=\"line\">    <span class=\"keyword\">int16_t</span> pauserehash; <span class=\"comment\">/* If &gt;0 rehashing is paused (&lt;0 indicates coding error) */</span></span><br><span class=\"line\">&#125; dict;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>redis哈希冲突将新节点添加在链表的表头</p>\n</blockquote>\n<h4 id=\"操作命令-3\"><a href=\"#操作命令-3\" class=\"headerlink\" title=\"操作命令\"></a>操作命令</h4><p><strong>设置值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">Redis4.0之后可以设置多个值，与hmset功能相同</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hset key field value [field value ...]</span></span><br><span class=\"line\">hset user id 123</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置多个字段</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hmset key field value [field value ...]</span></span><br><span class=\"line\">hmset user name zhangsan age 18</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">不存在则设置值</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hsetnx key field value</span></span><br><span class=\"line\">hsetnx user id 12</span><br></pre></td></tr></table></figure>\n\n<p><strong>获取值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hget key field</span></span><br><span class=\"line\">hget user id</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">获取多个字段的值</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hmget key field [field ...]</span></span><br><span class=\"line\">hmget user id name sex age</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">可以获取该key所对应的map</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hgetall key</span></span><br><span class=\"line\">hgetall user</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">获取key对应的map有几个字段</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hlen key</span></span><br><span class=\"line\">hlen user</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">判断该key的某个字段是否存在</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hexists key field</span></span><br><span class=\"line\">hexists user id</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">获取该key下所有的字段</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hkeys key</span></span><br><span class=\"line\">hkeys user</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">获取该key下所有的字段值</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hvals key </span></span><br><span class=\"line\">hvals user</span><br></pre></td></tr></table></figure>\n\n<p><strong>删除字段值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">支持删除多个</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">hdel key field [field ...]</span></span><br><span class=\"line\">hdel user age</span><br></pre></td></tr></table></figure>\n\n<p><strong>数值操作</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 加2</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> hincrby key field increment</span></span><br><span class=\"line\">hincrby user id 2</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"Zset类型\"><a href=\"#Zset类型\" class=\"headerlink\" title=\"Zset类型\"></a>Zset类型</h3><p>zset是sorted set，即有序的集合，在set的基础上加了一个score，类似于TreeSet，使用score来进行排序，也可以根据score的范围来获取元素的列表</p>\n<p>原本set值为k1 v1 k2 v2，而zset是k1 score1 v1 k2 score2 v2</p>\n<blockquote>\n<p>底层使用的是hash和跳表，hash用来关联value和score，保证value的唯一性，同时通过value可以获取到score。跳表的作用在于给value排序以及根据score的范围来获取元素列表</p>\n</blockquote>\n<h4 id=\"编码格式-3\"><a href=\"#编码格式-3\" class=\"headerlink\" title=\"编码格式\"></a>编码格式</h4><table>\n<thead>\n<tr>\n<th>编码</th>\n<th>对象</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OBJ_ENCODING_ZIPLIST</td>\n<td>使用ziplist</td>\n</tr>\n<tr>\n<td>OBJ_ENCODING_SKIPLIST</td>\n<td>使用的skiplist</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>zset有两种编码格式</p>\n<ul>\n<li>ziplist   满足条件使用ziplist，否则使用skiplist</li>\n<li>skiplist </li>\n</ul>\n</blockquote>\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#根据该配置项来进行编码转换的</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-entries <span class=\"number\">128</span></span><br><span class=\"line\">zset-<span class=\"built_in\">max</span>-ziplist-<span class=\"built_in\">value</span> <span class=\"number\">64</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"操作命令-4\"><a href=\"#操作命令-4\" class=\"headerlink\" title=\"操作命令\"></a>操作命令</h4><p><strong>设置值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">zadd key score member [score member ...]</span></span><br><span class=\"line\">zadd zset1 1 q 2 w</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>取值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">WITHSCORES表示查询结果是否带着score</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">zrange key start stop [WITHSCORES]</span></span><br><span class=\"line\">zrange zset1 0 -1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">根据score范围查询</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">zrangebyscore key min max [WITHSCORES] [LIMIT offset count]</span></span><br><span class=\"line\">zrangebyscore zset2 0 1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">根据score的范围来计数</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">zcount key min max</span></span><br><span class=\"line\"> zcount zset2 0 10</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta\"> #</span><span class=\"bash\">根据值来获取下标(根据score从小到大来排的序)</span></span><br><span class=\"line\"><span class=\"meta\"> #</span><span class=\"bash\">zrank key member</span></span><br><span class=\"line\"> zrank zset2 d</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta\"> #</span><span class=\"bash\">根据值来获取下标(根据score从大到小来排的序)</span></span><br><span class=\"line\"><span class=\"meta\"> #</span><span class=\"bash\">zrevrank key member</span></span><br><span class=\"line\"> zrevrank zset2 d</span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta\"> #</span><span class=\"bash\">根据值来获取score</span></span><br><span class=\"line\"><span class=\"meta\"> #</span><span class=\"bash\">zscore key member</span></span><br><span class=\"line\"> zscore zset2 c</span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n\n<p><strong>查看集合元素个数</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">该key的元素个数</span></span><br><span class=\"line\">zcard zset2</span><br></pre></td></tr></table></figure>\n\n<p><strong>删除</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">zrem key member</span></span><br><span class=\"line\">zrem zset2 s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 根据下标区间来删除(根据score从小到大来排的序)</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">zremrangebyrank key start stop</span></span><br><span class=\"line\">zremrangebyrank zset1 5 8</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 根据score区间来删除</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> zremrangebyscore key min max</span></span><br><span class=\"line\">zremrangebyscore zset1 7 10</span><br></pre></td></tr></table></figure>\n\n<p><strong>数值操作</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 如果key中存在该元素，则该元素的score增加increment，否则新增该元素</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> zincrby key increment member</span></span><br><span class=\"line\">zincrby zset1 2 b</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Bitmap类型\"><a href=\"#Bitmap类型\" class=\"headerlink\" title=\"Bitmap类型\"></a>Bitmap类型</h3><p>位图不是一个真实的数据类型，是定义在字符串类型之上的面向位操作的集合。位图的最大优势在于节省空间</p>\n<p><strong>设置值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">setbit key offset value</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> value只能是0或者1</span></span><br><span class=\"line\">setbit bittest 10 1</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>取值</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">getbit key offset</span></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 如果offset超出范围的话返回0</span></span><br><span class=\"line\">getbit bittest 10</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"HyperLogLogs类型\"><a href=\"#HyperLogLogs类型\" class=\"headerlink\" title=\"HyperLogLogs类型\"></a>HyperLogLogs类型</h3><h3 id=\"各个类型的应用\"><a href=\"#各个类型的应用\" class=\"headerlink\" title=\"各个类型的应用\"></a>各个类型的应用</h3><ul>\n<li>String: 缓存、限流、计数器、分布式锁、分布式Session</li>\n<li>List:  队列</li>\n<li>Set:  点赞、标签</li>\n<li>Hash:  存储对象</li>\n<li>Zset:  排行榜</li>\n</ul>\n","categories":["redis"],"tags":["redis"]},{"title":"redis配置","url":"/2021/%E6%95%B0%E6%8D%AE%E5%BA%93/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/redis/redis%E9%85%8D%E7%BD%AE/","content":"<h2 id=\"redis配置\"><a href=\"#redis配置\" class=\"headerlink\" title=\"redis配置\"></a>redis配置</h2><blockquote>\n<p>注意：我使用的版本是6.0.10，不同版本可能略有差别</p>\n</blockquote>\n<p>redis的配置主要集中在redis.conf文件中，接下来就来看一下redis.conf中包含了哪些内容</p>\n<h3 id=\"INCLUDES模块\"><a href=\"#INCLUDES模块\" class=\"headerlink\" title=\"INCLUDES模块\"></a>INCLUDES模块</h3><p>该模块下可以使用include来包含其他的redis配置文件，将其他配置文件引入进来</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\"># include &#x2F;path&#x2F;to&#x2F;local.conf</span><br><span class=\"line\"># include &#x2F;path&#x2F;to&#x2F;other.conf</span><br></pre></td></tr></table></figure>\n\n<a id=\"more\"></a>\n\n<h3 id=\"GENERAL模块\"><a href=\"#GENERAL模块\" class=\"headerlink\" title=\"GENERAL模块\"></a>GENERAL模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">#是否为守护线程 默认为no 如果需要在后台运行，改为yes</span><br><span class=\"line\">daemonize no</span><br><span class=\"line\"></span><br><span class=\"line\">supervised no</span><br><span class=\"line\"></span><br><span class=\"line\">#pid文件，运行多个redis时，指定不同的的pid文件和端口</span><br><span class=\"line\">pidfile &#x2F;var&#x2F;run&#x2F;redis_6379.pid</span><br><span class=\"line\"></span><br><span class=\"line\"># 日志级别  有四个级别</span><br><span class=\"line\"># debug   verbose  notice  warning</span><br><span class=\"line\">loglevel notice</span><br><span class=\"line\"></span><br><span class=\"line\">#日志文件 如果为空，控制台输出</span><br><span class=\"line\">logfile &quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#系统日志是否打开</span><br><span class=\"line\"># syslog-enabled no</span><br><span class=\"line\"></span><br><span class=\"line\">#如果系统日志打开 日志标识为redis</span><br><span class=\"line\"># syslog-ident redis</span><br><span class=\"line\"></span><br><span class=\"line\">#指定syslog设备</span><br><span class=\"line\"># syslog-facility local0</span><br><span class=\"line\"></span><br><span class=\"line\">#数据库个数，可以使用 select &lt;dbid&gt;来切换数据库，默认使用的数据库是0</span><br><span class=\"line\">databases 16</span><br><span class=\"line\"></span><br><span class=\"line\">always-show-logo yes</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"MODULES模块\"><a href=\"#MODULES模块\" class=\"headerlink\" title=\"MODULES模块\"></a>MODULES模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################## MODULES #####################################</span><br><span class=\"line\"></span><br><span class=\"line\"># Load modules at startup. If the server is not able to load modules</span><br><span class=\"line\"># it will abort. It is possible to use multiple loadmodule directives.</span><br><span class=\"line\">#</span><br><span class=\"line\"># loadmodule &#x2F;path&#x2F;to&#x2F;my_module.so</span><br><span class=\"line\"># loadmodule &#x2F;path&#x2F;to&#x2F;other_module.so</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"NETWORK模块\"><a href=\"#NETWORK模块\" class=\"headerlink\" title=\"NETWORK模块\"></a>NETWORK模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################## NETWORK #####################################</span><br><span class=\"line\"></span><br><span class=\"line\">#指定redis只接收来自于该ip地址的请求，如果不设置，将接收所有请求</span><br><span class=\"line\">bind 127.0.0.1 ::1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">protected-mode yes</span><br><span class=\"line\"></span><br><span class=\"line\">#监听端口</span><br><span class=\"line\">port 6379</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">tcp-backlog 511</span><br><span class=\"line\"></span><br><span class=\"line\"># Unix socket.</span><br><span class=\"line\">#</span><br><span class=\"line\">#</span><br><span class=\"line\"># unixsocket &#x2F;tmp&#x2F;redis.sock</span><br><span class=\"line\"># unixsocketperm 700</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置客户端连接的超时时间，单位秒，如果客户端超过该时间没有发出任何指令，则关闭该连接，0表示不关闭</span><br><span class=\"line\">timeout 0</span><br><span class=\"line\"></span><br><span class=\"line\">tcp-keepalive 300</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"TLS-SSL模块\"><a href=\"#TLS-SSL模块\" class=\"headerlink\" title=\"TLS/SSL模块\"></a>TLS/SSL模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################# TLS&#x2F;SSL #####################################</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># port 0</span><br><span class=\"line\"># tls-port 6379</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-cert-file redis.crt </span><br><span class=\"line\"># tls-key-file redis.key</span><br><span class=\"line\"></span><br><span class=\"line\"># Configure a DH parameters file to enable Diffie-Hellman (DH) key exchange:</span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-dh-params-file redis.dh</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-ca-cert-file ca.crt</span><br><span class=\"line\"># tls-ca-cert-dir &#x2F;etc&#x2F;ssl&#x2F;certs</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-auth-clients no</span><br><span class=\"line\"># tls-auth-clients optional</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-replication yes</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-cluster yes</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-protocols &quot;TLSv1.2 TLSv1.3&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-ciphers DEFAULT:!MEDIUM</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-ciphersuites TLS_CHACHA20_POLY1305_SHA256</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-prefer-server-ciphers yes</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-session-caching no</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-session-cache-size 5000</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># tls-session-cache-timeout 60</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"SNAPSHOTTING模块\"><a href=\"#SNAPSHOTTING模块\" class=\"headerlink\" title=\"SNAPSHOTTING模块\"></a>SNAPSHOTTING模块</h3><p>快照模块主要是用来配置RDB持久化的</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################ SNAPSHOTTING  ################################</span><br><span class=\"line\"></span><br><span class=\"line\">#进行数据库快照存储的条件</span><br><span class=\"line\">#900秒内有一个key发生变化</span><br><span class=\"line\">save 900 1</span><br><span class=\"line\">#300秒内有10个key发生变化</span><br><span class=\"line\">save 300 10</span><br><span class=\"line\"># 60秒内有10000个key发生变化</span><br><span class=\"line\">save 60 10000</span><br><span class=\"line\"></span><br><span class=\"line\">stop-writes-on-bgsave-error yes</span><br><span class=\"line\"></span><br><span class=\"line\">#rdb快照是否进行压缩</span><br><span class=\"line\">rdbcompression yes</span><br><span class=\"line\"></span><br><span class=\"line\">rdbchecksum yes</span><br><span class=\"line\"></span><br><span class=\"line\"># rdb快照文件名</span><br><span class=\"line\">dbfilename dump_6379.rdb</span><br><span class=\"line\"></span><br><span class=\"line\">rdb-del-sync-files no</span><br><span class=\"line\">#存储位置</span><br><span class=\"line\">dir &#x2F;usr&#x2F;local&#x2F;var&#x2F;db&#x2F;redis&#x2F;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"REPLICATION模块\"><a href=\"#REPLICATION模块\" class=\"headerlink\" title=\"REPLICATION模块\"></a>REPLICATION模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################# REPLICATION #################################</span><br><span class=\"line\"></span><br><span class=\"line\"># replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 主数据库密码</span><br><span class=\"line\"># masterauth &lt;master-password&gt;</span><br><span class=\"line\">#</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># masteruser &lt;username&gt;</span><br><span class=\"line\">#</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\">replica-serve-stale-data yes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">replica-read-only yes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">repl-diskless-sync no</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">repl-diskless-sync-delay 5</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># &quot;disabled&quot;    - Don&#39;t use diskless load (store the rdb file to the disk first)</span><br><span class=\"line\"># &quot;on-empty-db&quot; - Use diskless load only when it is completely safe.</span><br><span class=\"line\"># &quot;swapdb&quot;      - Keep a copy of the current db contents in RAM while parsing</span><br><span class=\"line\">#                 the data directly from the socket. note that this requires</span><br><span class=\"line\">#                 sufficient memory, if you don&#39;t have it, you risk an OOM kill.</span><br><span class=\"line\">repl-diskless-load disabled</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># repl-ping-replica-period 10</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># repl-timeout 60</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">repl-disable-tcp-nodelay no</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># repl-backlog-size 1mb</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># repl-backlog-ttl 3600</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">replica-priority 100</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># min-replicas-to-write 3</span><br><span class=\"line\"># min-replicas-max-lag 10</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># replica-announce-ip 5.5.5.5</span><br><span class=\"line\"># replica-announce-port 1234</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"KEYS-TRACKING模块\"><a href=\"#KEYS-TRACKING模块\" class=\"headerlink\" title=\"KEYS TRACKING模块\"></a>KEYS TRACKING模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">############################### KEYS TRACKING #################################</span><br><span class=\"line\"></span><br><span class=\"line\"># Redis implements server assisted support for client side caching of values.</span><br><span class=\"line\"># This is implemented using an invalidation table that remembers, using</span><br><span class=\"line\"># 16 millions of slots, what clients may have certain subsets of keys. In turn</span><br><span class=\"line\"># this is used in order to send invalidation messages to clients. Please</span><br><span class=\"line\"># check this page to understand more about the feature:</span><br><span class=\"line\">#</span><br><span class=\"line\">#   https:&#x2F;&#x2F;redis.io&#x2F;topics&#x2F;client-side-caching</span><br><span class=\"line\">#</span><br><span class=\"line\"># When tracking is enabled for a client, all the read only queries are assumed</span><br><span class=\"line\"># to be cached: this will force Redis to store information in the invalidation</span><br><span class=\"line\"># table. When keys are modified, such information is flushed away, and</span><br><span class=\"line\"># invalidation messages are sent to the clients. However if the workload is</span><br><span class=\"line\"># heavily dominated by reads, Redis could use more and more memory in order</span><br><span class=\"line\"># to track the keys fetched by many clients.</span><br><span class=\"line\">#</span><br><span class=\"line\"># For this reason it is possible to configure a maximum fill value for the</span><br><span class=\"line\"># invalidation table. By default it is set to 1M of keys, and once this limit</span><br><span class=\"line\"># is reached, Redis will start to evict keys in the invalidation table</span><br><span class=\"line\"># even if they were not modified, just to reclaim memory: this will in turn</span><br><span class=\"line\"># force the clients to invalidate the cached values. Basically the table</span><br><span class=\"line\"># maximum size is a trade off between the memory you want to spend server</span><br><span class=\"line\"># side to track information about who cached what, and the ability of clients</span><br><span class=\"line\"># to retain cached objects in memory.</span><br><span class=\"line\">#</span><br><span class=\"line\"># If you set the value to 0, it means there are no limits, and Redis will</span><br><span class=\"line\"># retain as many keys as needed in the invalidation table.</span><br><span class=\"line\"># In the &quot;stats&quot; INFO section, you can find information about the number of</span><br><span class=\"line\"># keys in the invalidation table at every given moment.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Note: when key tracking is used in broadcasting mode, no memory is used</span><br><span class=\"line\"># in the server side so this setting is useless.</span><br><span class=\"line\">#</span><br><span class=\"line\"># tracking-table-max-keys 1000000</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"MEMORY-MANAGEMENT模块\"><a href=\"#MEMORY-MANAGEMENT模块\" class=\"headerlink\" title=\"MEMORY MANAGEMENT模块\"></a>MEMORY MANAGEMENT模块</h3><h4 id=\"redis的淘汰机制\"><a href=\"#redis的淘汰机制\" class=\"headerlink\" title=\"redis的淘汰机制\"></a>redis的淘汰机制</h4><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">############################## MEMORY MANAGEMENT ################################</span><br><span class=\"line\"></span><br><span class=\"line\"># redis能够使用的最大内存</span><br><span class=\"line\"># maxmemory &lt;bytes&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">#设置了过期时间的键，选取最近最少使用的键抛弃（Least Recently Used）</span><br><span class=\"line\"># volatile-lru -&gt; Evict using approximated LRU, only keys with an expire set.</span><br><span class=\"line\">#对于所有的键，选取最近最少使用的键抛弃（Least Recently Used）</span><br><span class=\"line\"># allkeys-lru -&gt; Evict any key using approximated LRU.</span><br><span class=\"line\">#设置了过期时间的键，选取最少频率使用的键抛弃（Least Frequently Used）</span><br><span class=\"line\"># volatile-lfu -&gt; Evict using approximated LFU, only keys with an expire set.</span><br><span class=\"line\">#对于所有的键，选取最少频率使用的键抛弃（Least Frequently Used）</span><br><span class=\"line\"># allkeys-lfu -&gt; Evict any key using approximated LFU.</span><br><span class=\"line\">#对于设置过期时间的键，随机选取键抛弃</span><br><span class=\"line\"># volatile-random -&gt; Remove a random key having an expire set.</span><br><span class=\"line\">#对于所有的键，随机选取键抛弃</span><br><span class=\"line\"># allkeys-random -&gt; Remove a random key, any key.</span><br><span class=\"line\">#抛弃最近要过期的键</span><br><span class=\"line\"># volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span><br><span class=\"line\">#默认策略，不淘汰，如果内存已满，写操作返回错误</span><br><span class=\"line\"># noeviction -&gt; Don&#39;t evict anything, just return an error on write operations.</span><br><span class=\"line\"># maxmemory-policy noeviction</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># maxmemory-samples 5</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># replica-ignore-maxmemory yes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># active-expire-effort 1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"CLIENTS模块\"><a href=\"#CLIENTS模块\" class=\"headerlink\" title=\"CLIENTS模块\"></a>CLIENTS模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################### CLIENTS ####################################</span><br><span class=\"line\"></span><br><span class=\"line\"># 限制同时连接的客户端数量，超过这个数量将不再接受其他连接请求</span><br><span class=\"line\"># maxclients 10000</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"LAZY-FREEING模块\"><a href=\"#LAZY-FREEING模块\" class=\"headerlink\" title=\"LAZY FREEING模块\"></a>LAZY FREEING模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">############################# LAZY FREEING ####################################</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">lazyfree-lazy-eviction no</span><br><span class=\"line\">lazyfree-lazy-expire no</span><br><span class=\"line\">lazyfree-lazy-server-del no</span><br><span class=\"line\">replica-lazy-flush no</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">lazyfree-lazy-user-del no</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"THREADED-I-O模块\"><a href=\"#THREADED-I-O模块\" class=\"headerlink\" title=\"THREADED I/O模块\"></a>THREADED I/O模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################ THREADED I&#x2F;O #################################</span><br><span class=\"line\"></span><br><span class=\"line\"># Redis is mostly single threaded, however there are certain threaded</span><br><span class=\"line\"># operations such as UNLINK, slow I&#x2F;O accesses and other things that are</span><br><span class=\"line\"># performed on side threads.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Now it is also possible to handle Redis clients socket reads and writes</span><br><span class=\"line\"># in different I&#x2F;O threads. Since especially writing is so slow, normally</span><br><span class=\"line\"># Redis users use pipelining in order to speed up the Redis performances per</span><br><span class=\"line\"># core, and spawn multiple instances in order to scale more. Using I&#x2F;O</span><br><span class=\"line\"># threads it is possible to easily speedup two times Redis without resorting</span><br><span class=\"line\"># to pipelining nor sharding of the instance.</span><br><span class=\"line\">#</span><br><span class=\"line\"># By default threading is disabled, we suggest enabling it only in machines</span><br><span class=\"line\"># that have at least 4 or more cores, leaving at least one spare core.</span><br><span class=\"line\"># Using more than 8 threads is unlikely to help much. We also recommend using</span><br><span class=\"line\"># threaded I&#x2F;O only if you actually have performance problems, with Redis</span><br><span class=\"line\"># instances being able to use a quite big percentage of CPU time, otherwise</span><br><span class=\"line\"># there is no point in using this feature.</span><br><span class=\"line\">#</span><br><span class=\"line\"># So for instance if you have a four cores boxes, try to use 2 or 3 I&#x2F;O</span><br><span class=\"line\"># threads, if you have a 8 cores, try to use 6 threads. In order to</span><br><span class=\"line\"># enable I&#x2F;O threads use the following configuration directive:</span><br><span class=\"line\">#</span><br><span class=\"line\"># io-threads 4</span><br><span class=\"line\">#</span><br><span class=\"line\"># Setting io-threads to 1 will just use the main thread as usual.</span><br><span class=\"line\"># When I&#x2F;O threads are enabled, we only use threads for writes, that is</span><br><span class=\"line\"># to thread the write(2) syscall and transfer the client buffers to the</span><br><span class=\"line\"># socket. However it is also possible to enable threading of reads and</span><br><span class=\"line\"># protocol parsing using the following configuration directive, by setting</span><br><span class=\"line\"># it to yes:</span><br><span class=\"line\">#</span><br><span class=\"line\"># io-threads-do-reads no</span><br><span class=\"line\">#</span><br><span class=\"line\"># Usually threading reads doesn&#39;t help much.</span><br><span class=\"line\">#</span><br><span class=\"line\"># NOTE 1: This configuration directive cannot be changed at runtime via</span><br><span class=\"line\"># CONFIG SET. Aso this feature currently does not work when SSL is</span><br><span class=\"line\"># enabled.</span><br><span class=\"line\">#</span><br><span class=\"line\"># NOTE 2: If you want to test the Redis speedup using redis-benchmark, make</span><br><span class=\"line\"># sure you also run the benchmark itself in threaded mode, using the</span><br><span class=\"line\"># --threads option to match the number of Redis threads, otherwise you&#39;ll not</span><br><span class=\"line\"># be able to notice the improvements.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"KERNEL-OOM-CONTROL模块\"><a href=\"#KERNEL-OOM-CONTROL模块\" class=\"headerlink\" title=\"KERNEL OOM CONTROL模块\"></a>KERNEL OOM CONTROL模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">############################ KERNEL OOM CONTROL ##############################</span><br><span class=\"line\"></span><br><span class=\"line\"># On Linux, it is possible to hint the kernel OOM killer on what processes</span><br><span class=\"line\"># should be killed first when out of memory.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Enabling this feature makes Redis actively control the oom_score_adj value</span><br><span class=\"line\"># for all its processes, depending on their role. The default scores will</span><br><span class=\"line\"># attempt to have background child processes killed before all others, and</span><br><span class=\"line\"># replicas killed before masters.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Redis supports three options:</span><br><span class=\"line\">#</span><br><span class=\"line\"># no:       Don&#39;t make changes to oom-score-adj (default).</span><br><span class=\"line\"># yes:      Alias to &quot;relative&quot; see below.</span><br><span class=\"line\"># absolute: Values in oom-score-adj-values are written as is to the kernel.</span><br><span class=\"line\"># relative: Values are used relative to the initial value of oom_score_adj when</span><br><span class=\"line\">#           the server starts and are then clamped to a range of -1000 to 1000.</span><br><span class=\"line\">#           Because typically the initial value is 0, they will often match the</span><br><span class=\"line\">#           absolute values.</span><br><span class=\"line\">oom-score-adj no</span><br><span class=\"line\"></span><br><span class=\"line\"># When oom-score-adj is used, this directive controls the specific values used</span><br><span class=\"line\"># for master, replica and background child processes. Values range -2000 to</span><br><span class=\"line\"># 2000 (higher means more likely to be killed).</span><br><span class=\"line\">#</span><br><span class=\"line\"># Unprivileged processes (not root, and without CAP_SYS_RESOURCE capabilities)</span><br><span class=\"line\"># can freely increase their value, but not decrease it below its initial</span><br><span class=\"line\"># settings. This means that setting oom-score-adj to &quot;relative&quot; and setting the</span><br><span class=\"line\"># oom-score-adj-values to positive values will always succeed.</span><br><span class=\"line\">oom-score-adj-values 0 200 800</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"APPEND-ONLY-MODE模块\"><a href=\"#APPEND-ONLY-MODE模块\" class=\"headerlink\" title=\"APPEND ONLY MODE模块\"></a>APPEND ONLY MODE模块</h3><p>AOF持久化配置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">############################## APPEND ONLY MODE ###############################</span><br><span class=\"line\">#开启aof持久化策略，将接收到的每次写操作请求都追加到aof文件中，在redis重启时，会加载aof文件，优先级比rdb高</span><br><span class=\"line\">appendonly no</span><br><span class=\"line\"></span><br><span class=\"line\"># aof文件名</span><br><span class=\"line\">appendfilename &quot;appendonly.aof&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置aof持久化频率</span><br><span class=\"line\"># 有三种选择 always    everysec    no</span><br><span class=\"line\"># appendfsync always</span><br><span class=\"line\">appendfsync everysec</span><br><span class=\"line\"># appendfsync no</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">no-appendfsync-on-rewrite no</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">auto-aof-rewrite-percentage 100</span><br><span class=\"line\">auto-aof-rewrite-min-size 64mb</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">aof-load-truncated yes</span><br><span class=\"line\"></span><br><span class=\"line\">aof-use-rdb-preamble yes</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"SECURITY模块\"><a href=\"#SECURITY模块\" class=\"headerlink\" title=\"SECURITY模块\"></a>SECURITY模块</h3><p>默认情况下使用redis不需要进行安全认证，因为在配置文件中requirepass是注释掉的</p>\n<p>可以使用redis命令来查看当前的密码</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">config get requirepass</span><br></pre></td></tr></table></figure>\n\n<p>当然也可以使用redis命令来设置密码</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">config set requirepass 123456</span><br></pre></td></tr></table></figure>\n\n<p>设置密码之后再次进入客户端就需要输入密码进行认证了</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">auth 123456</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################## SECURITY ###################################</span><br><span class=\"line\"></span><br><span class=\"line\">acllog-max-len 128</span><br><span class=\"line\"></span><br><span class=\"line\"># aclfile &#x2F;etc&#x2F;redis&#x2F;users.acl</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置客户端连接的密码</span><br><span class=\"line\"># requirepass foobared</span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># rename-command CONFIG &quot;&quot;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"LUA-SCRIPTING模块\"><a href=\"#LUA-SCRIPTING模块\" class=\"headerlink\" title=\"LUA SCRIPTING模块\"></a>LUA SCRIPTING模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################ LUA SCRIPTING  ###############################</span><br><span class=\"line\"></span><br><span class=\"line\"># Max execution time of a Lua script in milliseconds.</span><br><span class=\"line\">#</span><br><span class=\"line\"># If the maximum execution time is reached Redis will log that a script is</span><br><span class=\"line\"># still in execution after the maximum allowed time and will start to</span><br><span class=\"line\"># reply to queries with an error.</span><br><span class=\"line\">#</span><br><span class=\"line\"># When a long running script exceeds the maximum execution time only the</span><br><span class=\"line\"># SCRIPT KILL and SHUTDOWN NOSAVE commands are available. The first can be</span><br><span class=\"line\"># used to stop a script that did not yet call any write commands. The second</span><br><span class=\"line\"># is the only way to shut down the server in the case a write command was</span><br><span class=\"line\"># already issued by the script but the user doesn&#39;t want to wait for the natural</span><br><span class=\"line\"># termination of the script.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Set it to 0 or a negative value for unlimited execution without warnings.</span><br><span class=\"line\">lua-time-limit 5000</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"REDIS-CLUSTER模块\"><a href=\"#REDIS-CLUSTER模块\" class=\"headerlink\" title=\"REDIS CLUSTER模块\"></a>REDIS CLUSTER模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################ REDIS CLUSTER  ###############################</span><br><span class=\"line\"></span><br><span class=\"line\"># Normal Redis instances can&#39;t be part of a Redis Cluster; only nodes that are</span><br><span class=\"line\"># started as cluster nodes can. In order to start a Redis instance as a</span><br><span class=\"line\"># cluster node enable the cluster support uncommenting the following:</span><br><span class=\"line\">#</span><br><span class=\"line\"># cluster-enabled yes</span><br><span class=\"line\"></span><br><span class=\"line\"># Every cluster node has a cluster configuration file. This file is not</span><br><span class=\"line\"># intended to be edited by hand. It is created and updated by Redis nodes.</span><br><span class=\"line\"># Every Redis Cluster node requires a different cluster configuration file.</span><br><span class=\"line\"># Make sure that instances running in the same system do not have</span><br><span class=\"line\"># overlapping cluster configuration file names.</span><br><span class=\"line\">#</span><br><span class=\"line\"># cluster-config-file nodes-6379.conf</span><br><span class=\"line\"></span><br><span class=\"line\"># Cluster node timeout is the amount of milliseconds a node must be unreachable</span><br><span class=\"line\"># for it to be considered in failure state.</span><br><span class=\"line\"># Most other internal time limits are a multiple of the node timeout.</span><br><span class=\"line\">#</span><br><span class=\"line\"># cluster-node-timeout 15000</span><br><span class=\"line\"></span><br><span class=\"line\"># A replica of a failing master will avoid to start a failover if its data</span><br><span class=\"line\"># looks too old.</span><br><span class=\"line\">#</span><br><span class=\"line\"># There is no simple way for a replica to actually have an exact measure of</span><br><span class=\"line\"># its &quot;data age&quot;, so the following two checks are performed:</span><br><span class=\"line\">#</span><br><span class=\"line\"># 1) If there are multiple replicas able to failover, they exchange messages</span><br><span class=\"line\">#    in order to try to give an advantage to the replica with the best</span><br><span class=\"line\">#    replication offset (more data from the master processed).</span><br><span class=\"line\">#    Replicas will try to get their rank by offset, and apply to the start</span><br><span class=\"line\">#    of the failover a delay proportional to their rank.</span><br><span class=\"line\">#</span><br><span class=\"line\"># 2) Every single replica computes the time of the last interaction with</span><br><span class=\"line\">#    its master. This can be the last ping or command received (if the master</span><br><span class=\"line\">#    is still in the &quot;connected&quot; state), or the time that elapsed since the</span><br><span class=\"line\">#    disconnection with the master (if the replication link is currently down).</span><br><span class=\"line\">#    If the last interaction is too old, the replica will not try to failover</span><br><span class=\"line\">#    at all.</span><br><span class=\"line\">#</span><br><span class=\"line\"># The point &quot;2&quot; can be tuned by user. Specifically a replica will not perform</span><br><span class=\"line\"># the failover if, since the last interaction with the master, the time</span><br><span class=\"line\"># elapsed is greater than:</span><br><span class=\"line\">#</span><br><span class=\"line\">#   (node-timeout * cluster-replica-validity-factor) + repl-ping-replica-period</span><br><span class=\"line\">#</span><br><span class=\"line\"># So for example if node-timeout is 30 seconds, and the cluster-replica-validity-factor</span><br><span class=\"line\"># is 10, and assuming a default repl-ping-replica-period of 10 seconds, the</span><br><span class=\"line\"># replica will not try to failover if it was not able to talk with the master</span><br><span class=\"line\"># for longer than 310 seconds.</span><br><span class=\"line\">#</span><br><span class=\"line\"># A large cluster-replica-validity-factor may allow replicas with too old data to failover</span><br><span class=\"line\"># a master, while a too small value may prevent the cluster from being able to</span><br><span class=\"line\"># elect a replica at all.</span><br><span class=\"line\">#</span><br><span class=\"line\"># For maximum availability, it is possible to set the cluster-replica-validity-factor</span><br><span class=\"line\"># to a value of 0, which means, that replicas will always try to failover the</span><br><span class=\"line\"># master regardless of the last time they interacted with the master.</span><br><span class=\"line\"># (However they&#39;ll always try to apply a delay proportional to their</span><br><span class=\"line\"># offset rank).</span><br><span class=\"line\">#</span><br><span class=\"line\"># Zero is the only value able to guarantee that when all the partitions heal</span><br><span class=\"line\"># the cluster will always be able to continue.</span><br><span class=\"line\">#</span><br><span class=\"line\"># cluster-replica-validity-factor 10</span><br><span class=\"line\"></span><br><span class=\"line\"># Cluster replicas are able to migrate to orphaned masters, that are masters</span><br><span class=\"line\"># that are left without working replicas. This improves the cluster ability</span><br><span class=\"line\"># to resist to failures as otherwise an orphaned master can&#39;t be failed over</span><br><span class=\"line\"># in case of failure if it has no working replicas.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Replicas migrate to orphaned masters only if there are still at least a</span><br><span class=\"line\"># given number of other working replicas for their old master. This number</span><br><span class=\"line\"># is the &quot;migration barrier&quot;. A migration barrier of 1 means that a replica</span><br><span class=\"line\"># will migrate only if there is at least 1 other working replica for its master</span><br><span class=\"line\"># and so forth. It usually reflects the number of replicas you want for every</span><br><span class=\"line\"># master in your cluster.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Default is 1 (replicas migrate only if their masters remain with at least</span><br><span class=\"line\"># one replica). To disable migration just set it to a very large value.</span><br><span class=\"line\"># A value of 0 can be set but is useful only for debugging and dangerous</span><br><span class=\"line\"># in production.</span><br><span class=\"line\">#</span><br><span class=\"line\"># cluster-migration-barrier 1</span><br><span class=\"line\"></span><br><span class=\"line\"># By default Redis Cluster nodes stop accepting queries if they detect there</span><br><span class=\"line\"># is at least a hash slot uncovered (no available node is serving it).</span><br><span class=\"line\"># This way if the cluster is partially down (for example a range of hash slots</span><br><span class=\"line\"># are no longer covered) all the cluster becomes, eventually, unavailable.</span><br><span class=\"line\"># It automatically returns available as soon as all the slots are covered again.</span><br><span class=\"line\">#</span><br><span class=\"line\"># However sometimes you want the subset of the cluster which is working,</span><br><span class=\"line\"># to continue to accept queries for the part of the key space that is still</span><br><span class=\"line\"># covered. In order to do so, just set the cluster-require-full-coverage</span><br><span class=\"line\"># option to no.</span><br><span class=\"line\">#</span><br><span class=\"line\"># cluster-require-full-coverage yes</span><br><span class=\"line\"></span><br><span class=\"line\"># This option, when set to yes, prevents replicas from trying to failover its</span><br><span class=\"line\"># master during master failures. However the master can still perform a</span><br><span class=\"line\"># manual failover, if forced to do so.</span><br><span class=\"line\">#</span><br><span class=\"line\"># This is useful in different scenarios, especially in the case of multiple</span><br><span class=\"line\"># data center operations, where we want one side to never be promoted if not</span><br><span class=\"line\"># in the case of a total DC failure.</span><br><span class=\"line\">#</span><br><span class=\"line\"># cluster-replica-no-failover no</span><br><span class=\"line\"></span><br><span class=\"line\"># This option, when set to yes, allows nodes to serve read traffic while the</span><br><span class=\"line\"># the cluster is in a down state, as long as it believes it owns the slots. </span><br><span class=\"line\">#</span><br><span class=\"line\"># This is useful for two cases.  The first case is for when an application </span><br><span class=\"line\"># doesn&#39;t require consistency of data during node failures or network partitions.</span><br><span class=\"line\"># One example of this is a cache, where as long as the node has the data it</span><br><span class=\"line\"># should be able to serve it. </span><br><span class=\"line\">#</span><br><span class=\"line\"># The second use case is for configurations that don&#39;t meet the recommended  </span><br><span class=\"line\"># three shards but want to enable cluster mode and scale later. A </span><br><span class=\"line\"># master outage in a 1 or 2 shard configuration causes a read&#x2F;write outage to the</span><br><span class=\"line\"># entire cluster without this option set, with it set there is only a write outage.</span><br><span class=\"line\"># Without a quorum of masters, slot ownership will not change automatically. </span><br><span class=\"line\">#</span><br><span class=\"line\"># cluster-allow-reads-when-down no</span><br><span class=\"line\"></span><br><span class=\"line\"># In order to setup your cluster make sure to read the documentation</span><br><span class=\"line\"># available at http:&#x2F;&#x2F;redis.io web site.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"CLUSTER-DOCKER-NAT-support模块\"><a href=\"#CLUSTER-DOCKER-NAT-support模块\" class=\"headerlink\" title=\"CLUSTER DOCKER/NAT support模块\"></a>CLUSTER DOCKER/NAT support模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">########################## CLUSTER DOCKER&#x2F;NAT support  ########################</span><br><span class=\"line\"></span><br><span class=\"line\"># In certain deployments, Redis Cluster nodes address discovery fails, because</span><br><span class=\"line\"># addresses are NAT-ted or because ports are forwarded (the typical case is</span><br><span class=\"line\"># Docker and other containers).</span><br><span class=\"line\">#</span><br><span class=\"line\"># In order to make Redis Cluster working in such environments, a static</span><br><span class=\"line\"># configuration where each node knows its public address is needed. The</span><br><span class=\"line\"># following two options are used for this scope, and are:</span><br><span class=\"line\">#</span><br><span class=\"line\"># * cluster-announce-ip</span><br><span class=\"line\"># * cluster-announce-port</span><br><span class=\"line\"># * cluster-announce-bus-port</span><br><span class=\"line\">#</span><br><span class=\"line\"># Each instructs the node about its address, client port, and cluster message</span><br><span class=\"line\"># bus port. The information is then published in the header of the bus packets</span><br><span class=\"line\"># so that other nodes will be able to correctly map the address of the node</span><br><span class=\"line\"># publishing the information.</span><br><span class=\"line\">#</span><br><span class=\"line\"># If the above options are not used, the normal Redis Cluster auto-detection</span><br><span class=\"line\"># will be used instead.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Note that when remapped, the bus port may not be at the fixed offset of</span><br><span class=\"line\"># clients port + 10000, so you can specify any port and bus-port depending</span><br><span class=\"line\"># on how they get remapped. If the bus-port is not set, a fixed offset of</span><br><span class=\"line\"># 10000 will be used as usual.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Example:</span><br><span class=\"line\">#</span><br><span class=\"line\"># cluster-announce-ip 10.1.1.5</span><br><span class=\"line\"># cluster-announce-port 6379</span><br><span class=\"line\"># cluster-announce-bus-port 6380</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"SLOW-LOG模块\"><a href=\"#SLOW-LOG模块\" class=\"headerlink\" title=\"SLOW LOG模块\"></a>SLOW LOG模块</h3><p>慢日志配置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################## SLOW LOG ###################################</span><br><span class=\"line\"></span><br><span class=\"line\"># 指定指定时间超过多少微秒的命令会被记录到日志上(1s 为1000000微妙)</span><br><span class=\"line\">slowlog-log-slower-than 10000</span><br><span class=\"line\"></span><br><span class=\"line\"># 服务器最多保存多少条慢查询日志</span><br><span class=\"line\">slowlog-max-len 128</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"LATENCY-MONITOR模块\"><a href=\"#LATENCY-MONITOR模块\" class=\"headerlink\" title=\"LATENCY MONITOR模块\"></a>LATENCY MONITOR模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">################################ LATENCY MONITOR ##############################</span><br><span class=\"line\"></span><br><span class=\"line\"># The Redis latency monitoring subsystem samples different operations</span><br><span class=\"line\"># at runtime in order to collect data related to possible sources of</span><br><span class=\"line\"># latency of a Redis instance.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Via the LATENCY command this information is available to the user that can</span><br><span class=\"line\"># print graphs and obtain reports.</span><br><span class=\"line\">#</span><br><span class=\"line\"># The system only logs operations that were performed in a time equal or</span><br><span class=\"line\"># greater than the amount of milliseconds specified via the</span><br><span class=\"line\"># latency-monitor-threshold configuration directive. When its value is set</span><br><span class=\"line\"># to zero, the latency monitor is turned off.</span><br><span class=\"line\">#</span><br><span class=\"line\"># By default latency monitoring is disabled since it is mostly not needed</span><br><span class=\"line\"># if you don&#39;t have latency issues, and collecting data has a performance</span><br><span class=\"line\"># impact, that while very small, can be measured under big load. Latency</span><br><span class=\"line\"># monitoring can easily be enabled at runtime using the command</span><br><span class=\"line\"># &quot;CONFIG SET latency-monitor-threshold &lt;milliseconds&gt;&quot; if needed.</span><br><span class=\"line\">latency-monitor-threshold 0</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"EVENT-NOTIFICATION模块\"><a href=\"#EVENT-NOTIFICATION模块\" class=\"headerlink\" title=\"EVENT NOTIFICATION模块\"></a>EVENT NOTIFICATION模块</h3><p>事件通知模块</p>\n<p>如果某个键发生某种变化 可以通知 发布/订阅的客户端</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">############################# EVENT NOTIFICATION ##############################</span><br><span class=\"line\"># 事件通知的参数选项</span><br><span class=\"line\">#  K     Keyspace events, published with __keyspace@&lt;db&gt;__ prefix.</span><br><span class=\"line\">#  E     Keyevent events, published with __keyevent@&lt;db&gt;__ prefix.</span><br><span class=\"line\">#  g     Generic commands (non-type specific) like DEL, EXPIRE, RENAME, ...</span><br><span class=\"line\">#  $     String commands</span><br><span class=\"line\">#  l     List commands</span><br><span class=\"line\">#  s     Set commands</span><br><span class=\"line\">#  h     Hash commands</span><br><span class=\"line\">#  z     Sorted set commands</span><br><span class=\"line\">#  x     Expired events (events generated every time a key expires)</span><br><span class=\"line\">#  e     Evicted events (events generated when a key is evicted for maxmemory)</span><br><span class=\"line\">#  t     Stream commands</span><br><span class=\"line\">#  m     Key-miss events (Note: It is not included in the &#39;A&#39; class)</span><br><span class=\"line\">#  A     Alias for g$lshzxet, so that the &quot;AKE&quot; string means all the events</span><br><span class=\"line\">#        (Except key-miss events which are excluded from &#39;A&#39; due to their</span><br><span class=\"line\">#         unique nature).</span><br><span class=\"line\">notify-keyspace-events &quot;&quot;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"GOPHER-SERVER模块\"><a href=\"#GOPHER-SERVER模块\" class=\"headerlink\" title=\"GOPHER SERVER模块\"></a>GOPHER SERVER模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">############################### GOPHER SERVER #################################</span><br><span class=\"line\"></span><br><span class=\"line\"># Redis contains an implementation of the Gopher protocol, as specified in</span><br><span class=\"line\"># the RFC 1436 (https:&#x2F;&#x2F;www.ietf.org&#x2F;rfc&#x2F;rfc1436.txt).</span><br><span class=\"line\">#</span><br><span class=\"line\"># The Gopher protocol was very popular in the late &#39;90s. It is an alternative</span><br><span class=\"line\"># to the web, and the implementation both server and client side is so simple</span><br><span class=\"line\"># that the Redis server has just 100 lines of code in order to implement this</span><br><span class=\"line\"># support.</span><br><span class=\"line\">#</span><br><span class=\"line\"># What do you do with Gopher nowadays? Well Gopher never *really* died, and</span><br><span class=\"line\"># lately there is a movement in order for the Gopher more hierarchical content</span><br><span class=\"line\"># composed of just plain text documents to be resurrected. Some want a simpler</span><br><span class=\"line\"># internet, others believe that the mainstream internet became too much</span><br><span class=\"line\"># controlled, and it&#39;s cool to create an alternative space for people that</span><br><span class=\"line\"># want a bit of fresh air.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Anyway for the 10nth birthday of the Redis, we gave it the Gopher protocol</span><br><span class=\"line\"># as a gift.</span><br><span class=\"line\">#</span><br><span class=\"line\"># --- HOW IT WORKS? ---</span><br><span class=\"line\">#</span><br><span class=\"line\"># The Redis Gopher support uses the inline protocol of Redis, and specifically</span><br><span class=\"line\"># two kind of inline requests that were anyway illegal: an empty request</span><br><span class=\"line\"># or any request that starts with &quot;&#x2F;&quot; (there are no Redis commands starting</span><br><span class=\"line\"># with such a slash). Normal RESP2&#x2F;RESP3 requests are completely out of the</span><br><span class=\"line\"># path of the Gopher protocol implementation and are served as usual as well.</span><br><span class=\"line\">#</span><br><span class=\"line\"># If you open a connection to Redis when Gopher is enabled and send it</span><br><span class=\"line\"># a string like &quot;&#x2F;foo&quot;, if there is a key named &quot;&#x2F;foo&quot; it is served via the</span><br><span class=\"line\"># Gopher protocol.</span><br><span class=\"line\">#</span><br><span class=\"line\"># In order to create a real Gopher &quot;hole&quot; (the name of a Gopher site in Gopher</span><br><span class=\"line\"># talking), you likely need a script like the following:</span><br><span class=\"line\">#</span><br><span class=\"line\">#   https:&#x2F;&#x2F;github.com&#x2F;antirez&#x2F;gopher2redis</span><br><span class=\"line\">#</span><br><span class=\"line\"># --- SECURITY WARNING ---</span><br><span class=\"line\">#</span><br><span class=\"line\"># If you plan to put Redis on the internet in a publicly accessible address</span><br><span class=\"line\"># to server Gopher pages MAKE SURE TO SET A PASSWORD to the instance.</span><br><span class=\"line\"># Once a password is set:</span><br><span class=\"line\">#</span><br><span class=\"line\">#   1. The Gopher server (when enabled, not by default) will still serve</span><br><span class=\"line\">#      content via Gopher.</span><br><span class=\"line\">#   2. However other commands cannot be called before the client will</span><br><span class=\"line\">#      authenticate.</span><br><span class=\"line\">#</span><br><span class=\"line\"># So use the &#39;requirepass&#39; option to protect your instance.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Note that Gopher is not currently supported when &#39;io-threads-do-reads&#39;</span><br><span class=\"line\"># is enabled.</span><br><span class=\"line\">#</span><br><span class=\"line\"># To enable Gopher support, uncomment the following line and set the option</span><br><span class=\"line\"># from no (the default) to yes.</span><br><span class=\"line\">#</span><br><span class=\"line\"># gopher-enabled no</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ADVANCED-CONFIG模块\"><a href=\"#ADVANCED-CONFIG模块\" class=\"headerlink\" title=\"ADVANCED CONFIG模块\"></a>ADVANCED CONFIG模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">############################### ADVANCED CONFIG ###############################</span><br><span class=\"line\"></span><br><span class=\"line\"># hash数据结构使用ziplist的条件</span><br><span class=\"line\">hash-max-ziplist-entries 512</span><br><span class=\"line\">hash-max-ziplist-value 64</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># -5: max size: 64 Kb  &lt;-- not recommended for normal workloads</span><br><span class=\"line\"># -4: max size: 32 Kb  &lt;-- not recommended</span><br><span class=\"line\"># -3: max size: 16 Kb  &lt;-- probably not recommended</span><br><span class=\"line\"># -2: max size: 8 Kb   &lt;-- good</span><br><span class=\"line\"># -1: max size: 4 Kb   &lt;-- good</span><br><span class=\"line\">list-max-ziplist-size -2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 0: disable all list compression</span><br><span class=\"line\"># 1: depth 1 means &quot;don&#39;t start compressing until after 1 node into the list,</span><br><span class=\"line\">#    going from either the head or tail&quot;</span><br><span class=\"line\">#    So: [head]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[tail]</span><br><span class=\"line\">#    [head], [tail] will always be uncompressed; inner nodes will compress.</span><br><span class=\"line\"># 2: [head]-&gt;[next]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[prev]-&gt;[tail]</span><br><span class=\"line\">#    2 here means: don&#39;t compress head or head-&gt;next or tail-&gt;prev or tail,</span><br><span class=\"line\">#    but compress all nodes between them.</span><br><span class=\"line\"># 3: [head]-&gt;[next]-&gt;[next]-&gt;node-&gt;node-&gt;...-&gt;node-&gt;[prev]-&gt;[prev]-&gt;[tail]</span><br><span class=\"line\"># etc.</span><br><span class=\"line\">list-compress-depth 0</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">set-max-intset-entries 512</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">zset-max-ziplist-entries 128</span><br><span class=\"line\">zset-max-ziplist-value 64</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">hll-sparse-max-bytes 3000</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">stream-node-max-bytes 4096</span><br><span class=\"line\">stream-node-max-entries 100</span><br><span class=\"line\"></span><br><span class=\"line\"># 开启之后，redis每100毫秒时使用1毫秒来对redis的hash表进行重新hash，可以降低内存的使用</span><br><span class=\"line\"># 如果要求实时性特别高的话(低于2ms)，将该配置为no</span><br><span class=\"line\">activerehashing yes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">client-output-buffer-limit normal 0 0 0</span><br><span class=\"line\">client-output-buffer-limit replica 256mb 64mb 60</span><br><span class=\"line\">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># client-query-buffer-limit 1gb</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#</span><br><span class=\"line\"># proto-max-bulk-len 512mb</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">hz 10</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">dynamic-hz yes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">aof-rewrite-incremental-fsync yes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">rdb-save-incremental-fsync yes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># lfu-log-factor 10</span><br><span class=\"line\"># lfu-decay-time 1</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ACTIVE-DEFRAGMENTATION模块\"><a href=\"#ACTIVE-DEFRAGMENTATION模块\" class=\"headerlink\" title=\"ACTIVE DEFRAGMENTATION模块\"></a>ACTIVE DEFRAGMENTATION模块</h3><figure class=\"highlight plain\"><table><tr><td class=\"code\"><pre><span class=\"line\">########################### ACTIVE DEFRAGMENTATION #######################</span><br><span class=\"line\">#</span><br><span class=\"line\"># What is active defragmentation?</span><br><span class=\"line\"># -------------------------------</span><br><span class=\"line\">#</span><br><span class=\"line\"># Active (online) defragmentation allows a Redis server to compact the</span><br><span class=\"line\"># spaces left between small allocations and deallocations of data in memory,</span><br><span class=\"line\"># thus allowing to reclaim back memory.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Fragmentation is a natural process that happens with every allocator (but</span><br><span class=\"line\"># less so with Jemalloc, fortunately) and certain workloads. Normally a server</span><br><span class=\"line\"># restart is needed in order to lower the fragmentation, or at least to flush</span><br><span class=\"line\"># away all the data and create it again. However thanks to this feature</span><br><span class=\"line\"># implemented by Oran Agra for Redis 4.0 this process can happen at runtime</span><br><span class=\"line\"># in a &quot;hot&quot; way, while the server is running.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Basically when the fragmentation is over a certain level (see the</span><br><span class=\"line\"># configuration options below) Redis will start to create new copies of the</span><br><span class=\"line\"># values in contiguous memory regions by exploiting certain specific Jemalloc</span><br><span class=\"line\"># features (in order to understand if an allocation is causing fragmentation</span><br><span class=\"line\"># and to allocate it in a better place), and at the same time, will release the</span><br><span class=\"line\"># old copies of the data. This process, repeated incrementally for all the keys</span><br><span class=\"line\"># will cause the fragmentation to drop back to normal values.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Important things to understand:</span><br><span class=\"line\">#</span><br><span class=\"line\"># 1. This feature is disabled by default, and only works if you compiled Redis</span><br><span class=\"line\">#    to use the copy of Jemalloc we ship with the source code of Redis.</span><br><span class=\"line\">#    This is the default with Linux builds.</span><br><span class=\"line\">#</span><br><span class=\"line\"># 2. You never need to enable this feature if you don&#39;t have fragmentation</span><br><span class=\"line\">#    issues.</span><br><span class=\"line\">#</span><br><span class=\"line\"># 3. Once you experience fragmentation, you can enable this feature when</span><br><span class=\"line\">#    needed with the command &quot;CONFIG SET activedefrag yes&quot;.</span><br><span class=\"line\">#</span><br><span class=\"line\"># The configuration parameters are able to fine tune the behavior of the</span><br><span class=\"line\"># defragmentation process. If you are not sure about what they mean it is</span><br><span class=\"line\"># a good idea to leave the defaults untouched.</span><br><span class=\"line\"></span><br><span class=\"line\"># Enabled active defragmentation</span><br><span class=\"line\"># activedefrag no</span><br><span class=\"line\"></span><br><span class=\"line\"># Minimum amount of fragmentation waste to start active defrag</span><br><span class=\"line\"># active-defrag-ignore-bytes 100mb</span><br><span class=\"line\"></span><br><span class=\"line\"># Minimum percentage of fragmentation to start active defrag</span><br><span class=\"line\"># active-defrag-threshold-lower 10</span><br><span class=\"line\"></span><br><span class=\"line\"># Maximum percentage of fragmentation at which we use maximum effort</span><br><span class=\"line\"># active-defrag-threshold-upper 100</span><br><span class=\"line\"></span><br><span class=\"line\"># Minimal effort for defrag in CPU percentage, to be used when the lower</span><br><span class=\"line\"># threshold is reached</span><br><span class=\"line\"># active-defrag-cycle-min 1</span><br><span class=\"line\"></span><br><span class=\"line\"># Maximal effort for defrag in CPU percentage, to be used when the upper</span><br><span class=\"line\"># threshold is reached</span><br><span class=\"line\"># active-defrag-cycle-max 25</span><br><span class=\"line\"></span><br><span class=\"line\"># Maximum number of set&#x2F;hash&#x2F;zset&#x2F;list fields that will be processed from</span><br><span class=\"line\"># the main dictionary scan</span><br><span class=\"line\"># active-defrag-max-scan-fields 1000</span><br><span class=\"line\"></span><br><span class=\"line\"># Jemalloc background thread for purging will be enabled by default</span><br><span class=\"line\">jemalloc-bg-thread yes</span><br><span class=\"line\"></span><br><span class=\"line\"># It is possible to pin different threads and processes of Redis to specific</span><br><span class=\"line\"># CPUs in your system, in order to maximize the performances of the server.</span><br><span class=\"line\"># This is useful both in order to pin different Redis threads in different</span><br><span class=\"line\"># CPUs, but also in order to make sure that multiple Redis instances running</span><br><span class=\"line\"># in the same host will be pinned to different CPUs.</span><br><span class=\"line\">#</span><br><span class=\"line\"># Normally you can do this using the &quot;taskset&quot; command, however it is also</span><br><span class=\"line\"># possible to this via Redis configuration directly, both in Linux and FreeBSD.</span><br><span class=\"line\">#</span><br><span class=\"line\"># You can pin the server&#x2F;IO threads, bio threads, aof rewrite child process, and</span><br><span class=\"line\"># the bgsave child process. The syntax to specify the cpu list is the same as</span><br><span class=\"line\"># the taskset command:</span><br><span class=\"line\">#</span><br><span class=\"line\"># Set redis server&#x2F;io threads to cpu affinity 0,2,4,6:</span><br><span class=\"line\"># server_cpulist 0-7:2</span><br><span class=\"line\">#</span><br><span class=\"line\"># Set bio threads to cpu affinity 1,3:</span><br><span class=\"line\"># bio_cpulist 1,3</span><br><span class=\"line\">#</span><br><span class=\"line\"># Set aof rewrite child process to cpu affinity 8,9,10,11:</span><br><span class=\"line\"># aof_rewrite_cpulist 8-11</span><br><span class=\"line\">#</span><br><span class=\"line\"># Set bgsave child process to cpu affinity 1,10,11</span><br><span class=\"line\"># bgsave_cpulist 1,10-11</span><br><span class=\"line\"></span><br><span class=\"line\"># In some cases redis will emit warnings and even refuse to start if it detects</span><br><span class=\"line\"># that the system is in bad state, it is possible to suppress these warnings</span><br><span class=\"line\"># by setting the following config which takes a space delimited list of warnings</span><br><span class=\"line\"># to suppress</span><br><span class=\"line\">#</span><br><span class=\"line\"># ignore-warnings ARM64-COW-BUG</span><br></pre></td></tr></table></figure>\n\n","categories":["redis"],"tags":["redis"]},{"title":"mybatis之KeyGenerator生成主键","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B8%BB%E9%94%AE%E7%94%9F%E6%88%90/","content":"<p>默认情况下，mybatis的insert语句不会返回自动生成的主键，而是返回插入的条数，如果需要获取到产生的自增主键，可以使用KeyGenerator接口</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">KeyGenerator</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 执行insert之前执行，设置属性order=&quot;BEFORE&quot;</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">processBefore</span><span class=\"params\">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 执行insert之前执行，设置属性order=&quot;AFTER&quot;</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">processAfter</span><span class=\"params\">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>该接口有三个实现类，NoKeyGenerator,Jdbc3KeyGenerator,SelectKeyGenerator  </p>\n<h2 id=\"NoKeyGenerator\"><a href=\"#NoKeyGenerator\" class=\"headerlink\" title=\"NoKeyGenerator\"></a>NoKeyGenerator</h2><p>NoKeyGenerator该类中processBefore和processAfter方法都是空实现</p>\n<h2 id=\"Jdbc3KeyGenerator\"><a href=\"#Jdbc3KeyGenerator\" class=\"headerlink\" title=\"Jdbc3KeyGenerator\"></a>Jdbc3KeyGenerator</h2><p>Jdbc3KeyGenerator用于取回数据库生成的自增id，对应于mybatis-config.xml配置文件的useGenerateKeys全局配置以及映射配置文件中SQL节点中的useGenerateKeys属性。</p>\n<p>Jdbc3KeyGenerator只实现了processAfter，适用于由数据库层面自动生成id的情况<br>需要配置useGeneratedKeys属性<br>mapper.xml示例</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">insert</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;insertUser&quot;</span> <span class=\"attr\">useGeneratedKeys</span>=<span class=\"string\">&quot;true&quot;</span> <span class=\"attr\">keyProperty</span>=<span class=\"string\">&quot;id&quot;</span>&gt;</span></span><br><span class=\"line\">    insert into user (user_name,sex,age) values </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">foreach</span> <span class=\"attr\">item</span>=<span class=\"string\">&quot;item&quot;</span> <span class=\"attr\">collection</span>=<span class=\"string\">&quot;list&quot;</span> <span class=\"attr\">separator</span>=<span class=\"string\">&quot;,&quot;</span>&gt;</span></span><br><span class=\"line\">        (#&#123;item.userName&#125;,#&#123;item.sex&#125;,#&#123;item.age&#125;)</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">foreach</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Jdbc3KeyGenerator</span> <span class=\"keyword\">implements</span> <span class=\"title\">KeyGenerator</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String SECOND_GENERIC_PARAM_NAME = <span class=\"string\">&quot;param2&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Jdbc3KeyGenerator INSTANCE = <span class=\"keyword\">new</span> Jdbc3KeyGenerator();</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String MSG_TOO_MANY_KEYS = <span class=\"string\">&quot;Too many keys are generated. There are only %d target objects. You either specified a wrong &#x27;keyProperty&#x27; or encountered a driver bug like #1523.&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Jdbc3KeyGenerator</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">processBefore</span><span class=\"params\">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">processAfter</span><span class=\"params\">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.processBatch(ms, stmt, parameter);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">processBatch</span><span class=\"params\">(MappedStatement ms, Statement stmt, Object parameter)</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 获得keyProperties属性指定的属性名称，表示主键对应的属性名称</span></span><br><span class=\"line\">        String[] keyProperties = ms.getKeyProperties();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (keyProperties != <span class=\"keyword\">null</span> &amp;&amp; keyProperties.length != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 获取数据库自动生成的主键，如果没有生成主键，返回结果集为空</span></span><br><span class=\"line\">                ResultSet rs = stmt.getGeneratedKeys();</span><br><span class=\"line\">                Throwable var6 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                      <span class=\"comment\">// 获取ResultSet的元数据</span></span><br><span class=\"line\">                    ResultSetMetaData rsmd = rs.getMetaData();</span><br><span class=\"line\">                    Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">                      <span class=\"comment\">// 检测数据库生成的主键列数和keyProperties的列数是否匹配</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (rsmd.getColumnCount() &gt;= keyProperties.length) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">this</span>.assignKeys(configuration, rs, rsmd, keyProperties, parameter);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Throwable var17) &#123;</span><br><span class=\"line\">                    var6 = var17;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> var17;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (rs != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (var6 != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                                rs.close();</span><br><span class=\"line\">                            &#125; <span class=\"keyword\">catch</span> (Throwable var16) &#123;</span><br><span class=\"line\">                                var6.addSuppressed(var16);</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            rs.close();</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception var19) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Error getting generated key or setting result to parameter object. Cause: &quot;</span> + var19, var19);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">assignKeys</span><span class=\"params\">(Configuration configuration, ResultSet rs, ResultSetMetaData rsmd, String[] keyProperties, Object parameter)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!(parameter <span class=\"keyword\">instanceof</span> ParamMap) &amp;&amp; !(parameter <span class=\"keyword\">instanceof</span> StrictMap)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (parameter <span class=\"keyword\">instanceof</span> ArrayList &amp;&amp; !((ArrayList)parameter).isEmpty() &amp;&amp; ((ArrayList)parameter).get(<span class=\"number\">0</span>) <span class=\"keyword\">instanceof</span> ParamMap) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.assignKeysToParamMapList(configuration, rs, rsmd, keyProperties, (ArrayList)parameter);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.assignKeysToParam(configuration, rs, rsmd, keyProperties, parameter);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.assignKeysToParamMap(configuration, rs, rsmd, keyProperties, (Map)parameter);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">assignKeysToParam</span><span class=\"params\">(Configuration configuration, ResultSet rs, ResultSetMetaData rsmd, String[] keyProperties, Object parameter)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Collection&lt;?&gt; params = collectionize(parameter);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!params.isEmpty()) &#123;</span><br><span class=\"line\">            List&lt;Jdbc3KeyGenerator.KeyAssigner&gt; assignerList = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; keyProperties.length; ++i) &#123;</span><br><span class=\"line\">                assignerList.add(<span class=\"keyword\">new</span> Jdbc3KeyGenerator.KeyAssigner(configuration, rsmd, i + <span class=\"number\">1</span>, (String)<span class=\"keyword\">null</span>, keyProperties[i]));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            Iterator iterator = params.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(rs.next()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!iterator.hasNext()) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(String.format(<span class=\"string\">&quot;Too many keys are generated. There are only %d target objects. You either specified a wrong &#x27;keyProperty&#x27; or encountered a driver bug like #1523.&quot;</span>, params.size()));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                Object param = iterator.next();</span><br><span class=\"line\">                assignerList.forEach((x) -&gt; &#123;</span><br><span class=\"line\">                    x.assign(rs, param);</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">assignKeysToParamMapList</span><span class=\"params\">(Configuration configuration, ResultSet rs, ResultSetMetaData rsmd, String[] keyProperties, ArrayList&lt;ParamMap&lt;?&gt;&gt; paramMapList)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Iterator&lt;ParamMap&lt;?&gt;&gt; iterator = paramMapList.iterator();</span><br><span class=\"line\">        List&lt;Jdbc3KeyGenerator.KeyAssigner&gt; assignerList = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"keyword\">long</span> counter = <span class=\"number\">0L</span>; rs.next(); ++counter) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!iterator.hasNext()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(String.format(<span class=\"string\">&quot;Too many keys are generated. There are only %d target objects. You either specified a wrong &#x27;keyProperty&#x27; or encountered a driver bug like #1523.&quot;</span>, counter));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            ParamMap&lt;?&gt; paramMap = (ParamMap)iterator.next();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (assignerList.isEmpty()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; keyProperties.length; ++i) &#123;</span><br><span class=\"line\">                    assignerList.add(<span class=\"keyword\">this</span>.getAssignerForParamMap(configuration, rsmd, i + <span class=\"number\">1</span>, paramMap, keyProperties[i], keyProperties, <span class=\"keyword\">false</span>).getValue());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            assignerList.forEach((x) -&gt; &#123;</span><br><span class=\"line\">                x.assign(rs, paramMap);</span><br><span class=\"line\">            &#125;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">assignKeysToParamMap</span><span class=\"params\">(Configuration configuration, ResultSet rs, ResultSetMetaData rsmd, String[] keyProperties, Map&lt;String, ?&gt; paramMap)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!paramMap.isEmpty()) &#123;</span><br><span class=\"line\">            Map&lt;String, Entry&lt;Iterator&lt;?&gt;, List&lt;Jdbc3KeyGenerator.KeyAssigner&gt;&gt;&gt; assignerMap = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; keyProperties.length; ++i) &#123;</span><br><span class=\"line\">                Entry&lt;String, Jdbc3KeyGenerator.KeyAssigner&gt; entry = <span class=\"keyword\">this</span>.getAssignerForParamMap(configuration, rsmd, i + <span class=\"number\">1</span>, paramMap, keyProperties[i], keyProperties, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">                Entry&lt;Iterator&lt;?&gt;, List&lt;Jdbc3KeyGenerator.KeyAssigner&gt;&gt; iteratorPair = (Entry)assignerMap.computeIfAbsent(entry.getKey(), (k) -&gt; &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> entry(collectionize(paramMap.get(k)).iterator(), <span class=\"keyword\">new</span> ArrayList());</span><br><span class=\"line\">                &#125;);</span><br><span class=\"line\">                ((List)iteratorPair.getValue()).add(entry.getValue());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">long</span> counter = <span class=\"number\">0L</span>; rs.next(); ++counter) &#123;</span><br><span class=\"line\">                Iterator var13 = assignerMap.values().iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">while</span>(var13.hasNext()) &#123;</span><br><span class=\"line\">                    Entry&lt;Iterator&lt;?&gt;, List&lt;Jdbc3KeyGenerator.KeyAssigner&gt;&gt; pair = (Entry)var13.next();</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!((Iterator)pair.getKey()).hasNext()) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(String.format(<span class=\"string\">&quot;Too many keys are generated. There are only %d target objects. You either specified a wrong &#x27;keyProperty&#x27; or encountered a driver bug like #1523.&quot;</span>, counter));</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    Object param = ((Iterator)pair.getKey()).next();</span><br><span class=\"line\">                    ((List)pair.getValue()).forEach((x) -&gt; &#123;</span><br><span class=\"line\">                        x.assign(rs, param);</span><br><span class=\"line\">                    &#125;);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Entry&lt;String, Jdbc3KeyGenerator.KeyAssigner&gt; getAssignerForParamMap(Configuration config, ResultSetMetaData rsmd, <span class=\"keyword\">int</span> columnPosition, Map&lt;String, ?&gt; paramMap, String keyProperty, String[] keyProperties, <span class=\"keyword\">boolean</span> omitParamName) &#123;</span><br><span class=\"line\">        Set&lt;String&gt; keySet = paramMap.keySet();</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> singleParam = !keySet.contains(<span class=\"string\">&quot;param2&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">int</span> firstDot = keyProperty.indexOf(<span class=\"number\">46</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (firstDot == -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (singleParam) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.getAssignerForSingleParam(config, rsmd, columnPosition, paramMap, keyProperty, omitParamName);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Could not determine which parameter to assign generated keys to. Note that when there are multiple parameters, &#x27;keyProperty&#x27; must include the parameter name (e.g. &#x27;param.id&#x27;). Specified key properties are &quot;</span> + ArrayUtil.toString(keyProperties) + <span class=\"string\">&quot; and available parameters are &quot;</span> + keySet);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            String paramName = keyProperty.substring(<span class=\"number\">0</span>, firstDot);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (keySet.contains(paramName)) &#123;</span><br><span class=\"line\">                String argParamName = omitParamName ? <span class=\"keyword\">null</span> : paramName;</span><br><span class=\"line\">                String argKeyProperty = keyProperty.substring(firstDot + <span class=\"number\">1</span>);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> entry(paramName, <span class=\"keyword\">new</span> Jdbc3KeyGenerator.KeyAssigner(config, rsmd, columnPosition, argParamName, argKeyProperty));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (singleParam) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.getAssignerForSingleParam(config, rsmd, columnPosition, paramMap, keyProperty, omitParamName);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Could not find parameter &#x27;&quot;</span> + paramName + <span class=\"string\">&quot;&#x27;. Note that when there are multiple parameters, &#x27;keyProperty&#x27; must include the parameter name (e.g. &#x27;param.id&#x27;). Specified key properties are &quot;</span> + ArrayUtil.toString(keyProperties) + <span class=\"string\">&quot; and available parameters are &quot;</span> + keySet);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Entry&lt;String, Jdbc3KeyGenerator.KeyAssigner&gt; getAssignerForSingleParam(Configuration config, ResultSetMetaData rsmd, <span class=\"keyword\">int</span> columnPosition, Map&lt;String, ?&gt; paramMap, String keyProperty, <span class=\"keyword\">boolean</span> omitParamName) &#123;</span><br><span class=\"line\">        String singleParamName = nameOfSingleParam(paramMap);</span><br><span class=\"line\">        String argParamName = omitParamName ? <span class=\"keyword\">null</span> : singleParamName;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> entry(singleParamName, <span class=\"keyword\">new</span> Jdbc3KeyGenerator.KeyAssigner(config, rsmd, columnPosition, argParamName, keyProperty));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> String <span class=\"title\">nameOfSingleParam</span><span class=\"params\">(Map&lt;String, ?&gt; paramMap)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (String)paramMap.keySet().iterator().next();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> Collection&lt;?&gt; collectionize(Object param) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (param <span class=\"keyword\">instanceof</span> Collection) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> (Collection)param;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> param <span class=\"keyword\">instanceof</span> Object[] ? Arrays.asList((Object[])((Object[])param)) : Arrays.asList(param);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> &lt;K, V&gt; <span class=\"function\">Entry&lt;K, V&gt; <span class=\"title\">entry</span><span class=\"params\">(K key, V value)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> SimpleImmutableEntry(key, value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">KeyAssigner</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Configuration configuration;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ResultSetMetaData rsmd;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TypeHandlerRegistry typeHandlerRegistry;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> columnPosition;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String paramName;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String propertyName;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> TypeHandler&lt;?&gt; typeHandler;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"title\">KeyAssigner</span><span class=\"params\">(Configuration configuration, ResultSetMetaData rsmd, <span class=\"keyword\">int</span> columnPosition, String paramName, String propertyName)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.configuration = configuration;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.rsmd = rsmd;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.typeHandlerRegistry = configuration.getTypeHandlerRegistry();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.columnPosition = columnPosition;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.paramName = paramName;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.propertyName = propertyName;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">assign</span><span class=\"params\">(ResultSet rs, Object param)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.paramName != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                param = ((ParamMap)param).get(<span class=\"keyword\">this</span>.paramName);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">                        <span class=\"comment\">// 为用户传入的实参创建相应的MetaObject对象</span></span><br><span class=\"line\">            MetaObject metaParam = <span class=\"keyword\">this</span>.configuration.newMetaObject(param);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.typeHandler == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!metaParam.hasSetter(<span class=\"keyword\">this</span>.propertyName)) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;No setter found for the keyProperty &#x27;&quot;</span> + <span class=\"keyword\">this</span>.propertyName + <span class=\"string\">&quot;&#x27; in &#x27;&quot;</span> + metaParam.getOriginalObject().getClass().getName() + <span class=\"string\">&quot;&#x27;.&quot;</span>);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    Class&lt;?&gt; propertyType = metaParam.getSetterType(<span class=\"keyword\">this</span>.propertyName);</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.typeHandler = <span class=\"keyword\">this</span>.typeHandlerRegistry.getTypeHandler(propertyType, JdbcType.forCode(<span class=\"keyword\">this</span>.rsmd.getColumnType(<span class=\"keyword\">this</span>.columnPosition)));</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.typeHandler != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    Object value = <span class=\"keyword\">this</span>.typeHandler.getResult(rs, <span class=\"keyword\">this</span>.columnPosition);</span><br><span class=\"line\">                    metaParam.setValue(<span class=\"keyword\">this</span>.propertyName, value);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (SQLException var5) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Error getting generated key or setting result to parameter object. Cause: &quot;</span> + var5, var5);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"SelectKeyGenerator\"><a href=\"#SelectKeyGenerator\" class=\"headerlink\" title=\"SelectKeyGenerator\"></a>SelectKeyGenerator</h2><p>有些数据库不支持自动生成自增主键，可以使用SelectKeyGenerator来生成主键<br>执行selectKey节点的sql语句，获取insert语句所要主键</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">insert</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;insertUser&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">selectKey</span> <span class=\"attr\">keyProperty</span>=<span class=\"string\">&quot;id&quot;</span> <span class=\"attr\">resultType</span>=<span class=\"string\">&quot;int&quot;</span> <span class=\"attr\">order</span>=<span class=\"string\">&quot;BEFORE&quot;</span>&gt;</span></span><br><span class=\"line\">          select 10000</span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">selectKey</span>&gt;</span></span><br><span class=\"line\">      insert into user (id,user_name) values (#&#123;id&#125;,#&#123;userName&#125;)</span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>SelectKeyGenerator会执行映射配置文件中定义的<selectKey>节点的SQL语句，该语句会获取insert语句所需要的主键。</selectKey></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SelectKeyGenerator</span> <span class=\"keyword\">implements</span> <span class=\"title\">KeyGenerator</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String SELECT_KEY_SUFFIX = <span class=\"string\">&quot;!selectKey&quot;</span>;</span><br><span class=\"line\">      <span class=\"comment\">//标识是在insert语句之前执行还是之后执行</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> executeBefore;</span><br><span class=\"line\">      <span class=\"comment\">// &lt;selectKey&gt;节点中定义的SQL语句所对应的MappedStatement对象，解析&lt;selectKey&gt;节点时创建的，用于获取insert语句中使用的主键</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MappedStatement keyStatement;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SelectKeyGenerator</span><span class=\"params\">(MappedStatement keyStatement, <span class=\"keyword\">boolean</span> executeBefore)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.executeBefore = executeBefore;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.keyStatement = keyStatement;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">processBefore</span><span class=\"params\">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.executeBefore) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.processGeneratedKeys(executor, ms, parameter);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">processAfter</span><span class=\"params\">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.executeBefore) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.processGeneratedKeys(executor, ms, parameter);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">processGeneratedKeys</span><span class=\"params\">(Executor executor, MappedStatement ms, Object parameter)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (parameter != <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.keyStatement != <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.keyStatement.getKeyProperties() != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 获取selectKey中配置的属性名称，表示主键对应的属性</span></span><br><span class=\"line\">                String[] keyProperties = <span class=\"keyword\">this</span>.keyStatement.getKeyProperties();</span><br><span class=\"line\">                Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">                MetaObject metaParam = configuration.newMetaObject(parameter);</span><br><span class=\"line\">                  <span class=\"comment\">// 创建Executor对象，用于执行keyStatement中的sql,并得到主键对象</span></span><br><span class=\"line\">                Executor keyExecutor = configuration.newExecutor(executor.getTransaction(), ExecutorType.SIMPLE);</span><br><span class=\"line\">                List&lt;Object&gt; values = keyExecutor.query(<span class=\"keyword\">this</span>.keyStatement, parameter, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (values.size() == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;SelectKey returned no data.&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (values.size() &gt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;SelectKey returned more than one value.&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                MetaObject metaResult = configuration.newMetaObject(values.get(<span class=\"number\">0</span>));</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (keyProperties.length == <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (metaResult.hasGetter(keyProperties[<span class=\"number\">0</span>])) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">this</span>.setValue(metaParam, keyProperties[<span class=\"number\">0</span>], metaResult.getValue(keyProperties[<span class=\"number\">0</span>]));</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">this</span>.setValue(metaParam, keyProperties[<span class=\"number\">0</span>], values.get(<span class=\"number\">0</span>));</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                      <span class=\"comment\">// 联合主键的情况</span></span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.handleMultipleProperties(keyProperties, metaParam, metaResult);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ExecutorException var10) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> var10;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception var11) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Error selecting key or setting result to parameter object. Cause: &quot;</span> + var11, var11);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">handleMultipleProperties</span><span class=\"params\">(String[] keyProperties, MetaObject metaParam, MetaObject metaResult)</span> </span>&#123;</span><br><span class=\"line\">        String[] keyColumns = <span class=\"keyword\">this</span>.keyStatement.getKeyColumns();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (keyColumns != <span class=\"keyword\">null</span> &amp;&amp; keyColumns.length != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (keyColumns.length != keyProperties.length) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;If SelectKey has key columns, the number must match the number of key properties.&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; keyProperties.length; ++i) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.setValue(metaParam, keyProperties[i], metaResult.getValue(keyColumns[i]));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            String[] var5 = keyProperties;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> var6 = keyProperties.length;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> var7 = <span class=\"number\">0</span>; var7 &lt; var6; ++var7) &#123;</span><br><span class=\"line\">                String keyProperty = var5[var7];</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.setValue(metaParam, keyProperty, metaResult.getValue(keyProperty));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">setValue</span><span class=\"params\">(MetaObject metaParam, String property, Object value)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (metaParam.hasSetter(property)) &#123;</span><br><span class=\"line\">            metaParam.setValue(property, value);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;No setter found for the keyProperty &#x27;&quot;</span> + property + <span class=\"string\">&quot;&#x27; in &quot;</span> + metaParam.getOriginalObject().getClass().getName() + <span class=\"string\">&quot;.&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis之statementHandler","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B9%8BstatementHandler/","content":"<p>statementHandler接口是mybatis的核心接口之一，statementHandler接口中功能很多，例如创建Statement对象，为SQL语句绑定实参，执行select、insert、update、delete等多种类型的SQL语句，批量执行SQL语句，将结果集映射成结果对象。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">StatementHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// 从连接中获取一个Statement</span></span><br><span class=\"line\">  <span class=\"function\">Statement <span class=\"title\">prepare</span><span class=\"params\">(Connection connection, Integer transactionTimeout)</span></span></span><br><span class=\"line\"><span class=\"function\">      <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 绑定statement执行时所需的实参</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">parameterize</span><span class=\"params\">(Statement statement)</span></span></span><br><span class=\"line\"><span class=\"function\">      <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 批量执行SQL语句</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">batch</span><span class=\"params\">(Statement statement)</span></span></span><br><span class=\"line\"><span class=\"function\">      <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 执行update/insert/delete语句</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(Statement statement)</span></span></span><br><span class=\"line\"><span class=\"function\">      <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 执行select语句</span></span><br><span class=\"line\">  &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(Statement statement, ResultHandler resultHandler)</span></span></span><br><span class=\"line\"><span class=\"function\">      <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">queryCursor</span><span class=\"params\">(Statement statement)</span></span></span><br><span class=\"line\"><span class=\"function\">      <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"function\">BoundSql <span class=\"title\">getBoundSql</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">    <span class=\"comment\">// 获取其中封装的ParameterHandler</span></span><br><span class=\"line\">  <span class=\"function\">ParameterHandler <span class=\"title\">getParameterHandler</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>StatementHandler有两个实现类RoutingStatementHandler和BaseStatementHandler  </p>\n<h2 id=\"BaseStatementHandler\"><a href=\"#BaseStatementHandler\" class=\"headerlink\" title=\"BaseStatementHandler\"></a>BaseStatementHandler</h2><p>BaseStatementHandler是实现了一个StatementHandler接口的抽象类，只提供了参数绑定相关的方法，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BaseStatementHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">StatementHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> Configuration configuration;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> ObjectFactory objectFactory;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> TypeHandlerRegistry typeHandlerRegistry;</span><br><span class=\"line\">      <span class=\"comment\">// 将结果集映射为对象</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> ResultSetHandler resultSetHandler;</span><br><span class=\"line\">      <span class=\"comment\">// 主要是为SQL语句绑定实参，使用传入的实参替换SQL语句的中？占位符</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> ParameterHandler parameterHandler;</span><br><span class=\"line\">      <span class=\"comment\">// 记录执行SQL语句的Executor对象</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> Executor executor;</span><br><span class=\"line\">      <span class=\"comment\">// 记录SQL语句对应的MappedStatement</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> MappedStatement mappedStatement;</span><br><span class=\"line\">      <span class=\"comment\">// 记录用户设置的offset和limit，用于用在结果集中定位映射的起始位置和结束位置</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> RowBounds rowBounds;</span><br><span class=\"line\">      <span class=\"comment\">// 记录SQK语句对应的BoundSql</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> BoundSql boundSql;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"title\">BaseStatementHandler</span><span class=\"params\">(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.configuration = mappedStatement.getConfiguration();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.executor = executor;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.mappedStatement = mappedStatement;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.rowBounds = rowBounds;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.typeHandlerRegistry = <span class=\"keyword\">this</span>.configuration.getTypeHandlerRegistry();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.objectFactory = <span class=\"keyword\">this</span>.configuration.getObjectFactory();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (boundSql == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 调用keyGenerator的processBefore方法获取主键</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.generateKeys(parameterObject);</span><br><span class=\"line\">            boundSql = mappedStatement.getBoundSql(parameterObject);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.boundSql = boundSql;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.parameterHandler = <span class=\"keyword\">this</span>.configuration.newParameterHandler(mappedStatement, parameterObject, boundSql);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.resultSetHandler = <span class=\"keyword\">this</span>.configuration.newResultSetHandler(executor, mappedStatement, rowBounds, <span class=\"keyword\">this</span>.parameterHandler, resultHandler, boundSql);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> BoundSql <span class=\"title\">getBoundSql</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.boundSql;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ParameterHandler <span class=\"title\">getParameterHandler</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.parameterHandler;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 实现StatementHandler的prepare方法</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Statement <span class=\"title\">prepare</span><span class=\"params\">(Connection connection, Integer transactionTimeout)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        ErrorContext.instance().sql(<span class=\"keyword\">this</span>.boundSql.getSql());</span><br><span class=\"line\">        Statement statement = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 初始化Statement对象</span></span><br><span class=\"line\">            statement = <span class=\"keyword\">this</span>.instantiateStatement(connection);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.setStatementTimeout(statement, transactionTimeout);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.setFetchSize(statement);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> statement;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SQLException var5) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.closeStatement(statement);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> var5;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception var6) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.closeStatement(statement);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Error preparing statement.  Cause: &quot;</span> + var6, var6);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">abstract</span> Statement <span class=\"title\">instantiateStatement</span><span class=\"params\">(Connection var1)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">setStatementTimeout</span><span class=\"params\">(Statement stmt, Integer transactionTimeout)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Integer queryTimeout = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.mappedStatement.getTimeout() != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            queryTimeout = <span class=\"keyword\">this</span>.mappedStatement.getTimeout();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.configuration.getDefaultStatementTimeout() != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            queryTimeout = <span class=\"keyword\">this</span>.configuration.getDefaultStatementTimeout();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (queryTimeout != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            stmt.setQueryTimeout(queryTimeout);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        StatementUtil.applyTransactionTimeout(stmt, queryTimeout, transactionTimeout);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">setFetchSize</span><span class=\"params\">(Statement stmt)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Integer fetchSize = <span class=\"keyword\">this</span>.mappedStatement.getFetchSize();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (fetchSize != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            stmt.setFetchSize(fetchSize);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Integer defaultFetchSize = <span class=\"keyword\">this</span>.configuration.getDefaultFetchSize();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (defaultFetchSize != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                stmt.setFetchSize(defaultFetchSize);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">closeStatement</span><span class=\"params\">(Statement statement)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (statement != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                statement.close();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SQLException var3) &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">generateKeys</span><span class=\"params\">(Object parameter)</span> </span>&#123;</span><br><span class=\"line\">        KeyGenerator keyGenerator = <span class=\"keyword\">this</span>.mappedStatement.getKeyGenerator();</span><br><span class=\"line\">        ErrorContext.instance().store();</span><br><span class=\"line\">        keyGenerator.processBefore(<span class=\"keyword\">this</span>.executor, <span class=\"keyword\">this</span>.mappedStatement, (Statement)<span class=\"keyword\">null</span>, parameter);</span><br><span class=\"line\">        ErrorContext.instance().recall();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>在BoundSql中记录的SQL语句中可能包含”?”占位符，而每个”?”占位符都对应了BoundSql.parameterMappings集合中的一个元素，ParameterMapping对象中记录了对应参数的名称以及相关属性<br>在ParameterHandler中的setParameters方法负责为SQL语句绑定实参，该接口只有一个实现类DefaultParameterHandler，遍历BoundSql.parameterMappings集合，根据ParameterMapping对象中记录的参数名称查找相应的实参，通过TypeHandler转换为JdbcType</p>\n<h3 id=\"SimpleStatementHandler\"><a href=\"#SimpleStatementHandler\" class=\"headerlink\" title=\"SimpleStatementHandler\"></a>SimpleStatementHandler</h3><p>SimpleStatementHandler继承了BaseStatementHandler抽象类，底层直接使用java.sql.Statement对象来操作数据库，SQL中不能存在占位符，parameterize方法为空实现</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SimpleStatementHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseStatementHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SimpleStatementHandler</span><span class=\"params\">(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">      <span class=\"comment\">//增删改都会走update方法</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        String sql = <span class=\"keyword\">this</span>.boundSql.getSql();</span><br><span class=\"line\">        Object parameterObject = <span class=\"keyword\">this</span>.boundSql.getParameterObject();</span><br><span class=\"line\">        KeyGenerator keyGenerator = <span class=\"keyword\">this</span>.mappedStatement.getKeyGenerator();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> rows;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (keyGenerator <span class=\"keyword\">instanceof</span> Jdbc3KeyGenerator) &#123;</span><br><span class=\"line\">            statement.execute(sql, <span class=\"number\">1</span>);</span><br><span class=\"line\">              <span class=\"comment\">// 受影响的行数</span></span><br><span class=\"line\">            rows = statement.getUpdateCount();</span><br><span class=\"line\">              <span class=\"comment\">// 数据库生成的主键添加到parameterObject中</span></span><br><span class=\"line\">            keyGenerator.processAfter(<span class=\"keyword\">this</span>.executor, <span class=\"keyword\">this</span>.mappedStatement, statement, parameterObject);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (keyGenerator <span class=\"keyword\">instanceof</span> SelectKeyGenerator) &#123;</span><br><span class=\"line\">            statement.execute(sql);</span><br><span class=\"line\">            rows = statement.getUpdateCount();</span><br><span class=\"line\">            keyGenerator.processAfter(<span class=\"keyword\">this</span>.executor, <span class=\"keyword\">this</span>.mappedStatement, statement, parameterObject);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            statement.execute(sql);</span><br><span class=\"line\">            rows = statement.getUpdateCount();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> rows;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">batch</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        String sql = <span class=\"keyword\">this</span>.boundSql.getSql();</span><br><span class=\"line\">        statement.addBatch(sql);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(Statement statement, ResultHandler resultHandler)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        String sql = <span class=\"keyword\">this</span>.boundSql.getSql();</span><br><span class=\"line\">        statement.execute(sql);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.resultSetHandler.handleResultSets(statement);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">queryCursor</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        String sql = <span class=\"keyword\">this</span>.boundSql.getSql();</span><br><span class=\"line\">        statement.execute(sql);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.resultSetHandler.handleCursorResultSets(statement);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">      <span class=\"comment\">// 初始化Statement</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> Statement <span class=\"title\">instantiateStatement</span><span class=\"params\">(Connection connection)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 直接使用Connection对象创建Statement对象</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.mappedStatement.getResultSetType() == ResultSetType.DEFAULT ? connection.createStatement() : connection.createStatement(<span class=\"keyword\">this</span>.mappedStatement.getResultSetType().getValue(), <span class=\"number\">1007</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">parameterize</span><span class=\"params\">(Statement statement)</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"PreparedStatementHandler\"><a href=\"#PreparedStatementHandler\" class=\"headerlink\" title=\"PreparedStatementHandler\"></a>PreparedStatementHandler</h3><p>PreparedStatementHandler继承了BaseStatementHandler抽象类，底层使用java.sql.PreparedStatement对象来操作数据库，PreparedStatement是预编译的，可以在sql语句中存在”?”占位符，parameterize方法通过调用ParameterHandler.setParameters()方法完成SQL语句的参数绑定</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PreparedStatementHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseStatementHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PreparedStatementHandler</span><span class=\"params\">(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        PreparedStatement ps = (PreparedStatement)statement;</span><br><span class=\"line\">        ps.execute();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> rows = ps.getUpdateCount();</span><br><span class=\"line\">        Object parameterObject = <span class=\"keyword\">this</span>.boundSql.getParameterObject();</span><br><span class=\"line\">        KeyGenerator keyGenerator = <span class=\"keyword\">this</span>.mappedStatement.getKeyGenerator();</span><br><span class=\"line\">        keyGenerator.processAfter(<span class=\"keyword\">this</span>.executor, <span class=\"keyword\">this</span>.mappedStatement, ps, parameterObject);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> rows;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">batch</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        PreparedStatement ps = (PreparedStatement)statement;</span><br><span class=\"line\">        ps.addBatch();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(Statement statement, ResultHandler resultHandler)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        PreparedStatement ps = (PreparedStatement)statement;</span><br><span class=\"line\">        ps.execute();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.resultSetHandler.handleResultSets(ps);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">queryCursor</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        PreparedStatement ps = (PreparedStatement)statement;</span><br><span class=\"line\">        ps.execute();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.resultSetHandler.handleCursorResultSets(ps);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">      <span class=\"comment\">//初始化Statement</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> Statement <span class=\"title\">instantiateStatement</span><span class=\"params\">(Connection connection)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        String sql = <span class=\"keyword\">this</span>.boundSql.getSql();</span><br><span class=\"line\">          <span class=\"comment\">// 根据mappedStatement.getKeyGenerator()字段的值，创建PrepareStatement</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.mappedStatement.getKeyGenerator() <span class=\"keyword\">instanceof</span> Jdbc3KeyGenerator) &#123;</span><br><span class=\"line\">            String[] keyColumnNames = <span class=\"keyword\">this</span>.mappedStatement.getKeyColumns();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> keyColumnNames == <span class=\"keyword\">null</span> ? connection.prepareStatement(sql, <span class=\"number\">1</span>) : connection.prepareStatement(sql, keyColumnNames);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.mappedStatement.getResultSetType() == ResultSetType.DEFAULT ? connection.prepareStatement(sql) : connection.prepareStatement(sql, <span class=\"keyword\">this</span>.mappedStatement.getResultSetType().getValue(), <span class=\"number\">1007</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">parameterize</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.parameterHandler.setParameters((PreparedStatement)statement);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"CallableStatementHandler\"><a href=\"#CallableStatementHandler\" class=\"headerlink\" title=\"CallableStatementHandler\"></a>CallableStatementHandler</h3><p>CallableStatementHandler继承了BaseStatementHandler抽象类，底层使用java.sql.CallableStatement调用指定的存储过程，其parameterize方法通过调用ParameterHandler.setParameters()方法完成SQL语句的参数绑定，并指定输出参数的索引位置和JDBC类型。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CallableStatementHandler</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseStatementHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CallableStatementHandler</span><span class=\"params\">(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        CallableStatement cs = (CallableStatement)statement;</span><br><span class=\"line\">        cs.execute();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> rows = cs.getUpdateCount();</span><br><span class=\"line\">        Object parameterObject = <span class=\"keyword\">this</span>.boundSql.getParameterObject();</span><br><span class=\"line\">        KeyGenerator keyGenerator = <span class=\"keyword\">this</span>.mappedStatement.getKeyGenerator();</span><br><span class=\"line\">        keyGenerator.processAfter(<span class=\"keyword\">this</span>.executor, <span class=\"keyword\">this</span>.mappedStatement, cs, parameterObject);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.resultSetHandler.handleOutputParameters(cs);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> rows;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">batch</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        CallableStatement cs = (CallableStatement)statement;</span><br><span class=\"line\">        cs.addBatch();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(Statement statement, ResultHandler resultHandler)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        CallableStatement cs = (CallableStatement)statement;</span><br><span class=\"line\">        cs.execute();</span><br><span class=\"line\">        List&lt;E&gt; resultList = <span class=\"keyword\">this</span>.resultSetHandler.handleResultSets(cs);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.resultSetHandler.handleOutputParameters(cs);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> resultList;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">queryCursor</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        CallableStatement cs = (CallableStatement)statement;</span><br><span class=\"line\">        cs.execute();</span><br><span class=\"line\">        Cursor&lt;E&gt; resultList = <span class=\"keyword\">this</span>.resultSetHandler.handleCursorResultSets(cs);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.resultSetHandler.handleOutputParameters(cs);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> resultList;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> Statement <span class=\"title\">instantiateStatement</span><span class=\"params\">(Connection connection)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        String sql = <span class=\"keyword\">this</span>.boundSql.getSql();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.mappedStatement.getResultSetType() == ResultSetType.DEFAULT ? connection.prepareCall(sql) : connection.prepareCall(sql, <span class=\"keyword\">this</span>.mappedStatement.getResultSetType().getValue(), <span class=\"number\">1007</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">parameterize</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.registerOutputParameters((CallableStatement)statement);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.parameterHandler.setParameters((CallableStatement)statement);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">registerOutputParameters</span><span class=\"params\">(CallableStatement cs)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        List&lt;ParameterMapping&gt; parameterMappings = <span class=\"keyword\">this</span>.boundSql.getParameterMappings();</span><br><span class=\"line\">        <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> n = parameterMappings.size(); i &lt; n; ++i) &#123;</span><br><span class=\"line\">            ParameterMapping parameterMapping = (ParameterMapping)parameterMappings.get(i);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (parameterMapping.getMode() == ParameterMode.OUT || parameterMapping.getMode() == ParameterMode.INOUT) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"keyword\">null</span> == parameterMapping.getJdbcType()) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;The JDBC Type must be specified for output parameter.  Parameter: &quot;</span> + parameterMapping.getProperty());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (parameterMapping.getNumericScale() != <span class=\"keyword\">null</span> &amp;&amp; (parameterMapping.getJdbcType() == JdbcType.NUMERIC || parameterMapping.getJdbcType() == JdbcType.DECIMAL)) &#123;</span><br><span class=\"line\">                    cs.registerOutParameter(i + <span class=\"number\">1</span>, parameterMapping.getJdbcType().TYPE_CODE, parameterMapping.getNumericScale());</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (parameterMapping.getJdbcTypeName() == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    cs.registerOutParameter(i + <span class=\"number\">1</span>, parameterMapping.getJdbcType().TYPE_CODE);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    cs.registerOutParameter(i + <span class=\"number\">1</span>, parameterMapping.getJdbcType().TYPE_CODE, parameterMapping.getJdbcTypeName());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"RoutingStatementHandler\"><a href=\"#RoutingStatementHandler\" class=\"headerlink\" title=\"RoutingStatementHandler\"></a>RoutingStatementHandler</h2><p>RoutingStatementHandler是StatementHandler接口的另一个实现类，会根据MappedStatement中指定的statementType来创建对应的StatementHandler接口实现。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RoutingStatementHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">StatementHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> StatementHandler delegate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">RoutingStatementHandler</span><span class=\"params\">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 根据statementType来设置相应的接口实现</span></span><br><span class=\"line\">        <span class=\"keyword\">switch</span>(ms.getStatementType()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> STATEMENT:</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate = <span class=\"keyword\">new</span> SimpleStatementHandler(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> PREPARED:</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate = <span class=\"keyword\">new</span> PreparedStatementHandler(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> CALLABLE:</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate = <span class=\"keyword\">new</span> CallableStatementHandler(executor, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">default</span>:</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Unknown statement type: &quot;</span> + ms.getStatementType());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Statement <span class=\"title\">prepare</span><span class=\"params\">(Connection connection, Integer transactionTimeout)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.prepare(connection, transactionTimeout);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">parameterize</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.parameterize(statement);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">batch</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.batch(statement);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.update(statement);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(Statement statement, ResultHandler resultHandler)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.query(statement, resultHandler);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">queryCursor</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.queryCursor(statement);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> BoundSql <span class=\"title\">getBoundSql</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getBoundSql();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> ParameterHandler <span class=\"title\">getParameterHandler</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getParameterHandler();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis之缓存","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B9%8B%E7%BC%93%E5%AD%98/","content":"<h2 id=\"缓存\"><a href=\"#缓存\" class=\"headerlink\" title=\"缓存\"></a>缓存</h2><h3 id=\"Cache接口\"><a href=\"#Cache接口\" class=\"headerlink\" title=\"Cache接口\"></a>Cache接口</h3><p>mybatis中包含一级缓存和二级缓存，在本质上是一样的，使用的都是Cache接口的实现。</p>\n<a id=\"more\"></a>\n\n<p>Cache接口定义了所有缓存的基本行为。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 缓存对象的id</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">getId</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">        <span class=\"comment\">// 向缓存中添加数据,key一般为CacheKey</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object var1, Object var2)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">Object <span class=\"title\">getObject</span><span class=\"params\">(Object var1)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">Object <span class=\"title\">removeObject</span><span class=\"params\">(Object var1)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">default</span> ReadWriteLock <span class=\"title\">getReadWriteLock</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>下面介绍一下Cache接口的实现</p>\n<h4 id=\"PerpetualCache\"><a href=\"#PerpetualCache\" class=\"headerlink\" title=\"PerpetualCache\"></a>PerpetualCache</h4><p>使用HashMap进行存储</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">PerpetualCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String id;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;Object, Object&gt; cache = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">PerpetualCache</span><span class=\"params\">(String id)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.id = id;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.id;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.cache.size();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object value)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.cache.put(key, value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.cache.get(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.cache.remove(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.cache.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object o)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.getId() == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CacheException(<span class=\"string\">&quot;Cache instances require an ID.&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span> == o) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!(o <span class=\"keyword\">instanceof</span> Cache)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Cache otherCache = (Cache)o;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.getId().equals(otherCache.getId());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.getId() == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CacheException(<span class=\"string\">&quot;Cache instances require an ID.&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.getId().hashCode();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"BlockingCache\"><a href=\"#BlockingCache\" class=\"headerlink\" title=\"BlockingCache\"></a>BlockingCache</h4><p>BlockingCache是阻塞版本的缓存装饰器，保证只有一个线程到数据库中查找指定key对应的数据</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BlockingCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">//阻塞超时时长</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> timeout;</span><br><span class=\"line\">      <span class=\"comment\">// 被装饰的底层Cache对象</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Cache delegate;</span><br><span class=\"line\">      <span class=\"comment\">//每个key对应一个ReetrantLock</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ConcurrentHashMap&lt;Object, ReentrantLock&gt; locks;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">BlockingCache</span><span class=\"params\">(Cache delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.locks = <span class=\"keyword\">new</span> ConcurrentHashMap();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getSize();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object value)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate.putObject(key, value);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.releaseLock(key);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 获取该key对应的锁</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.acquireLock(key);</span><br><span class=\"line\">          <span class=\"comment\">//查询key</span></span><br><span class=\"line\">        Object value = <span class=\"keyword\">this</span>.delegate.getObject(key);</span><br><span class=\"line\">          <span class=\"comment\">//缓存中有key对应的缓存项才会释放锁，否则会一直持有锁</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (value != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.releaseLock(key);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.releaseLock(key);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> ReentrantLock <span class=\"title\">getLockForKey</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (ReentrantLock)<span class=\"keyword\">this</span>.locks.computeIfAbsent(key, (k) -&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ReentrantLock();</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">acquireLock</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        Lock lock = <span class=\"keyword\">this</span>.getLockForKey(key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.timeout &gt; <span class=\"number\">0L</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">boolean</span> acquired = lock.tryLock(<span class=\"keyword\">this</span>.timeout, TimeUnit.MILLISECONDS);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!acquired) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CacheException(<span class=\"string\">&quot;Couldn&#x27;t get a lock in &quot;</span> + <span class=\"keyword\">this</span>.timeout + <span class=\"string\">&quot; for the key &quot;</span> + key + <span class=\"string\">&quot; at the cache &quot;</span> + <span class=\"keyword\">this</span>.delegate.getId());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InterruptedException var4) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CacheException(<span class=\"string\">&quot;Got interrupted while trying to acquire lock for key &quot;</span> + key, var4);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            lock.lock();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">releaseLock</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        ReentrantLock lock = (ReentrantLock)<span class=\"keyword\">this</span>.locks.get(key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (lock.isHeldByCurrentThread()) &#123;</span><br><span class=\"line\">            lock.unlock();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">long</span> <span class=\"title\">getTimeout</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.timeout;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setTimeout</span><span class=\"params\">(<span class=\"keyword\">long</span> timeout)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.timeout = timeout;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"FifoCache\"><a href=\"#FifoCache\" class=\"headerlink\" title=\"FifoCache\"></a>FifoCache</h4><p>FifoCache是先进先出版本的装饰器如果缓存项的个数达到上限，会将缓存中最老的缓存项删除。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FifoCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Cache delegate;</span><br><span class=\"line\">      <span class=\"comment\">// 根据key进入缓存的先后顺序</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Deque&lt;Object&gt; keyList;</span><br><span class=\"line\">      <span class=\"comment\">// 记录缓存的上限</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> size;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">FifoCache</span><span class=\"params\">(Cache delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.keyList = <span class=\"keyword\">new</span> LinkedList();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.size = <span class=\"number\">1024</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getSize();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setSize</span><span class=\"params\">(<span class=\"keyword\">int</span> size)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.size = size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object value)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.cycleKeyList(key);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.putObject(key, value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.removeObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.clear();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.keyList.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">      <span class=\"comment\">//检测并清理缓存</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">cycleKeyList</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.keyList.addLast(key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.keyList.size() &gt; <span class=\"keyword\">this</span>.size) &#123;</span><br><span class=\"line\">            Object oldestKey = <span class=\"keyword\">this</span>.keyList.removeFirst();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate.removeObject(oldestKey);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"LruCache\"><a href=\"#LruCache\" class=\"headerlink\" title=\"LruCache\"></a>LruCache</h4><p>LruCache按照最近最少使用算法进行缓存清理的装饰器。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LruCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Cache delegate;</span><br><span class=\"line\">      <span class=\"comment\">//LinkedHashMap</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Map&lt;Object, Object&gt; keyMap;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Object eldestKey;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LruCache</span><span class=\"params\">(Cache delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.setSize(<span class=\"number\">1024</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getSize();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setSize</span><span class=\"params\">(<span class=\"keyword\">final</span> <span class=\"keyword\">int</span> size)</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">//LinkedHashMap的第三个参数true表示记录的顺序是access-order,get方法会改变顺序记录</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.keyMap = <span class=\"keyword\">new</span> LinkedHashMap&lt;Object, Object&gt;(size, <span class=\"number\">0.75F</span>, <span class=\"keyword\">true</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> serialVersionUID = <span class=\"number\">4267176411845948333L</span>;</span><br><span class=\"line\">                        <span class=\"comment\">// 调用put方法时会调用该方法</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">boolean</span> <span class=\"title\">removeEldestEntry</span><span class=\"params\">(Entry&lt;Object, Object&gt; eldest)</span> </span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">boolean</span> tooBig = <span class=\"keyword\">this</span>.size() &gt; size;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (tooBig) &#123;</span><br><span class=\"line\">                    LruCache.<span class=\"keyword\">this</span>.eldestKey = eldest.getKey();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> tooBig;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object value)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.putObject(key, value);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.cycleKeyList(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.keyMap.get(key);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.removeObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.clear();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.keyMap.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">cycleKeyList</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.keyMap.put(key, key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.eldestKey != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate.removeObject(<span class=\"keyword\">this</span>.eldestKey);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.eldestKey = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"SoftCache\"><a href=\"#SoftCache\" class=\"headerlink\" title=\"SoftCache\"></a>SoftCache</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SoftCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 最近使用的一部分缓存不会被GC掉，将值放到该队列中（强引用指向其value）</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Deque&lt;Object&gt; hardLinksToAvoidGarbageCollection;</span><br><span class=\"line\">      <span class=\"comment\">//引用队列，用于记录已经被GC回收的缓存项所对应的SoftEntry对象</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ReferenceQueue&lt;Object&gt; queueOfGarbageCollectedEntries;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Cache delegate;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> numberOfHardLinks;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SoftCache</span><span class=\"params\">(Cache delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.numberOfHardLinks = <span class=\"number\">256</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection = <span class=\"keyword\">new</span> LinkedList();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.queueOfGarbageCollectedEntries = <span class=\"keyword\">new</span> ReferenceQueue();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.removeGarbageCollectedItems();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getSize();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setSize</span><span class=\"params\">(<span class=\"keyword\">int</span> size)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.numberOfHardLinks = size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object value)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.removeGarbageCollectedItems();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.putObject(key, <span class=\"keyword\">new</span> SoftCache.SoftEntry(key, value, <span class=\"keyword\">this</span>.queueOfGarbageCollectedEntries));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        Object result = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        SoftReference&lt;Object&gt; softReference = (SoftReference)<span class=\"keyword\">this</span>.delegate.getObject(key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (softReference != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            result = softReference.get();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (result == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.delegate.removeObject(key);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">synchronized</span>(<span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection.addFirst(result);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection.size() &gt; <span class=\"keyword\">this</span>.numberOfHardLinks) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection.removeLast();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.removeGarbageCollectedItems();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.removeObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">synchronized</span>(<span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection.clear();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.removeGarbageCollectedItems();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">removeGarbageCollectedItems</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        SoftCache.SoftEntry sv;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>((sv = (SoftCache.SoftEntry)<span class=\"keyword\">this</span>.queueOfGarbageCollectedEntries.poll()) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate.removeObject(sv.key);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SoftEntry</span> <span class=\"keyword\">extends</span> <span class=\"title\">SoftReference</span>&lt;<span class=\"title\">Object</span>&gt; </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Object key;</span><br><span class=\"line\"></span><br><span class=\"line\">        SoftEntry(Object key, Object value, ReferenceQueue&lt;Object&gt; garbageCollectionQueue) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">super</span>(value, garbageCollectionQueue);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.key = key;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"WeakCache\"><a href=\"#WeakCache\" class=\"headerlink\" title=\"WeakCache\"></a>WeakCache</h4><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WeakCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Deque&lt;Object&gt; hardLinksToAvoidGarbageCollection;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ReferenceQueue&lt;Object&gt; queueOfGarbageCollectedEntries;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Cache delegate;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> numberOfHardLinks;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">WeakCache</span><span class=\"params\">(Cache delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.numberOfHardLinks = <span class=\"number\">256</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection = <span class=\"keyword\">new</span> LinkedList();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.queueOfGarbageCollectedEntries = <span class=\"keyword\">new</span> ReferenceQueue();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.removeGarbageCollectedItems();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getSize();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setSize</span><span class=\"params\">(<span class=\"keyword\">int</span> size)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.numberOfHardLinks = size;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object value)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.removeGarbageCollectedItems();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.putObject(key, <span class=\"keyword\">new</span> WeakCache.WeakEntry(key, value, <span class=\"keyword\">this</span>.queueOfGarbageCollectedEntries));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        Object result = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        WeakReference&lt;Object&gt; weakReference = (WeakReference)<span class=\"keyword\">this</span>.delegate.getObject(key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (weakReference != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            result = weakReference.get();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (result == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.delegate.removeObject(key);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection.addFirst(result);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection.size() &gt; <span class=\"keyword\">this</span>.numberOfHardLinks) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection.removeLast();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.removeGarbageCollectedItems();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.removeObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.hardLinksToAvoidGarbageCollection.clear();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.removeGarbageCollectedItems();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">removeGarbageCollectedItems</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        WeakCache.WeakEntry sv;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>((sv = (WeakCache.WeakEntry)<span class=\"keyword\">this</span>.queueOfGarbageCollectedEntries.poll()) != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate.removeObject(sv.key);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WeakEntry</span> <span class=\"keyword\">extends</span> <span class=\"title\">WeakReference</span>&lt;<span class=\"title\">Object</span>&gt; </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Object key;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">WeakEntry</span><span class=\"params\">(Object key, Object value, ReferenceQueue&lt;Object&gt; garbageCollectionQueue)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">super</span>(value, garbageCollectionQueue);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.key = key;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"LoggingCache\"><a href=\"#LoggingCache\" class=\"headerlink\" title=\"LoggingCache\"></a>LoggingCache</h4><p>LoggingCache在Cache的基础上提供了日志功能，通过hits和request字段记录了Cache的命中次数和访问次数。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LoggingCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Log log;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Cache delegate;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">int</span> requests = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">int</span> hits = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">LoggingCache</span><span class=\"params\">(Cache delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.log = LogFactory.getLog(<span class=\"keyword\">this</span>.getId());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getSize();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object object)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.putObject(key, object);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        ++<span class=\"keyword\">this</span>.requests;</span><br><span class=\"line\">        Object value = <span class=\"keyword\">this</span>.delegate.getObject(key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (value != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            ++<span class=\"keyword\">this</span>.hits;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.log.isDebugEnabled()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.log.debug(<span class=\"string\">&quot;Cache Hit Ratio [&quot;</span> + <span class=\"keyword\">this</span>.getId() + <span class=\"string\">&quot;]: &quot;</span> + <span class=\"keyword\">this</span>.getHitRatio());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> value;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.removeObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.hashCode();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object obj)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.equals(obj);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        <span class=\"comment\">//命中率</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">double</span> <span class=\"title\">getHitRatio</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (<span class=\"keyword\">double</span>)<span class=\"keyword\">this</span>.hits / (<span class=\"keyword\">double</span>)<span class=\"keyword\">this</span>.requests;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"ScheduledCache\"><a href=\"#ScheduledCache\" class=\"headerlink\" title=\"ScheduledCache\"></a>ScheduledCache</h4><p>ScheduledCache周期性清理缓存，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ScheduledCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Cache delegate;</span><br><span class=\"line\">      <span class=\"comment\">// 记录两次缓存清理的时间间隔，默认一小时</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> clearInterval;</span><br><span class=\"line\">      <span class=\"comment\">// 记录最后一次清理的时间戳</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">long</span> lastClear;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ScheduledCache</span><span class=\"params\">(Cache delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.clearInterval = TimeUnit.HOURS.toMillis(<span class=\"number\">1L</span>);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.lastClear = System.currentTimeMillis();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setClearInterval</span><span class=\"params\">(<span class=\"keyword\">long</span> clearInterval)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.clearInterval = clearInterval;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.clearWhenStale();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getSize();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object object)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.clearWhenStale();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.putObject(key, object);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.clearWhenStale() ? <span class=\"keyword\">null</span> : <span class=\"keyword\">this</span>.delegate.getObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.clearWhenStale();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.removeObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.lastClear = System.currentTimeMillis();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.hashCode();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object obj)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.equals(obj);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">clearWhenStale</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (System.currentTimeMillis() - <span class=\"keyword\">this</span>.lastClear &gt; <span class=\"keyword\">this</span>.clearInterval) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.clear();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"SerializedCache\"><a href=\"#SerializedCache\" class=\"headerlink\" title=\"SerializedCache\"></a>SerializedCache</h4><p>SerializedCache提供了将value进行序列化的功能</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SerializedCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Cache delegate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SerializedCache</span><span class=\"params\">(Cache delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getSize();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object object)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (object != <span class=\"keyword\">null</span> &amp;&amp; !(object <span class=\"keyword\">instanceof</span> Serializable)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CacheException(<span class=\"string\">&quot;SharedCache failed to make a copy of a non-serializable object: &quot;</span> + object);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate.putObject(key, <span class=\"keyword\">this</span>.serialize((Serializable)object));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        Object object = <span class=\"keyword\">this</span>.delegate.getObject(key);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> object == <span class=\"keyword\">null</span> ? <span class=\"keyword\">null</span> : <span class=\"keyword\">this</span>.deserialize((<span class=\"keyword\">byte</span>[])((<span class=\"keyword\">byte</span>[])object));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.removeObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.hashCode();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object obj)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.equals(obj);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">byte</span>[] serialize(Serializable value) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            ByteArrayOutputStream bos = <span class=\"keyword\">new</span> ByteArrayOutputStream();</span><br><span class=\"line\">            Throwable var3 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            Object var6;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                ObjectOutputStream oos = <span class=\"keyword\">new</span> ObjectOutputStream(bos);</span><br><span class=\"line\">                Throwable var5 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    oos.writeObject(value);</span><br><span class=\"line\">                    oos.flush();</span><br><span class=\"line\">                    var6 = bos.toByteArray();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Throwable var31) &#123;</span><br><span class=\"line\">                    var6 = var31;</span><br><span class=\"line\">                    var5 = var31;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> var31;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (oos != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (var5 != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                                oos.close();</span><br><span class=\"line\">                            &#125; <span class=\"keyword\">catch</span> (Throwable var30) &#123;</span><br><span class=\"line\">                                var5.addSuppressed(var30);</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            oos.close();</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable var33) &#123;</span><br><span class=\"line\">                var3 = var33;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> var33;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (bos != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (var3 != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                            bos.close();</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">catch</span> (Throwable var29) &#123;</span><br><span class=\"line\">                            var3.addSuppressed(var29);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        bos.close();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> (<span class=\"keyword\">byte</span>[])var6;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception var35) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CacheException(<span class=\"string\">&quot;Error serializing object.  Cause: &quot;</span> + var35, var35);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Serializable <span class=\"title\">deserialize</span><span class=\"params\">(<span class=\"keyword\">byte</span>[] value)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            ByteArrayInputStream bis = <span class=\"keyword\">new</span> ByteArrayInputStream(value);</span><br><span class=\"line\">            Throwable var4 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">            Serializable result;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                ObjectInputStream ois = <span class=\"keyword\">new</span> SerializedCache.CustomObjectInputStream(bis);</span><br><span class=\"line\">                Throwable var6 = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                    result = (Serializable)ois.readObject();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">catch</span> (Throwable var31) &#123;</span><br><span class=\"line\">                    var6 = var31;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> var31;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (ois != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (var6 != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                                ois.close();</span><br><span class=\"line\">                            &#125; <span class=\"keyword\">catch</span> (Throwable var30) &#123;</span><br><span class=\"line\">                                var6.addSuppressed(var30);</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            ois.close();</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable var33) &#123;</span><br><span class=\"line\">                var4 = var33;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> var33;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (bis != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (var4 != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                            bis.close();</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">catch</span> (Throwable var29) &#123;</span><br><span class=\"line\">                            var4.addSuppressed(var29);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        bis.close();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception var35) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CacheException(<span class=\"string\">&quot;Error deserializing object.  Cause: &quot;</span> + var35, var35);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CustomObjectInputStream</span> <span class=\"keyword\">extends</span> <span class=\"title\">ObjectInputStream</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CustomObjectInputStream</span><span class=\"params\">(InputStream in)</span> <span class=\"keyword\">throws</span> IOException </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">super</span>(in);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class=\"keyword\">throws</span> ClassNotFoundException &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> Resources.classForName(desc.getName());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"SynchronizedCache\"><a href=\"#SynchronizedCache\" class=\"headerlink\" title=\"SynchronizedCache\"></a>SynchronizedCache</h4><p>SynchronizedCache为每个方法添加synchronized，添加了同步功能</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SynchronizedCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Cache delegate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SynchronizedCache</span><span class=\"params\">(Cache delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getSize();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object object)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.putObject(key, object);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.removeObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">synchronized</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.hashCode();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object obj)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.equals(obj);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"CacheKey\"><a href=\"#CacheKey\" class=\"headerlink\" title=\"CacheKey\"></a>CacheKey</h3><p>在Cache中唯一确定一个缓存项使用的key为CacheKey</p>\n<p>CacheKey的组成部分</p>\n<ul>\n<li>MappedStatement的id</li>\n<li>指定查询结果集的范围，也就是RowBounds.offset和RowBounds.limit</li>\n<li>查询所使用的sql语句，boundSql.getSql()，包含?占位符</li>\n<li>用户传递的实际参数</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CacheKey</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cloneable</span>, <span class=\"title\">Serializable</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> serialVersionUID = <span class=\"number\">1146682552656046210L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> CacheKey NULL_CACHE_KEY = <span class=\"keyword\">new</span> CacheKey() &#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">update</span><span class=\"params\">(Object object)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CacheException(<span class=\"string\">&quot;Not allowed to update a null cache key instance.&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">updateAll</span><span class=\"params\">(Object[] objects)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> CacheException(<span class=\"string\">&quot;Not allowed to update a null cache key instance.&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> DEFAULT_MULTIPLIER = <span class=\"number\">37</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> DEFAULT_HASHCODE = <span class=\"number\">17</span>;</span><br><span class=\"line\">      <span class=\"comment\">// 参与计算hashcode，默认为37</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> multiplier;</span><br><span class=\"line\">      <span class=\"comment\">// CacheKey的hashcode，默认为17</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> hashcode;</span><br><span class=\"line\">      <span class=\"comment\">//检验和</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> checksum;</span><br><span class=\"line\">      <span class=\"comment\">// updateList集合的个数</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> count;</span><br><span class=\"line\">      <span class=\"comment\">// 由该集合中的所有对象共同决定两个CacheKey是否相同</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> List&lt;Object&gt; updateList;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CacheKey</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.hashcode = <span class=\"number\">17</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.multiplier = <span class=\"number\">37</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.count = <span class=\"number\">0</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.updateList = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CacheKey</span><span class=\"params\">(Object[] objects)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.updateAll(objects);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getUpdateCount</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.updateList.size();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 想updateList中添加对象时，使用的是update方法</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">update</span><span class=\"params\">(Object object)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> baseHashCode = object == <span class=\"keyword\">null</span> ? <span class=\"number\">1</span> : ArrayUtil.hashCode(object);</span><br><span class=\"line\">        ++<span class=\"keyword\">this</span>.count;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.checksum += (<span class=\"keyword\">long</span>)baseHashCode;</span><br><span class=\"line\">        baseHashCode *= <span class=\"keyword\">this</span>.count;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.hashcode = <span class=\"keyword\">this</span>.multiplier * <span class=\"keyword\">this</span>.hashcode + baseHashCode;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.updateList.add(object);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">updateAll</span><span class=\"params\">(Object[] objects)</span> </span>&#123;</span><br><span class=\"line\">        Object[] var2 = objects;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> var3 = objects.length;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> var4 = <span class=\"number\">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class=\"line\">            Object o = var2[var4];</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.update(o);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">equals</span><span class=\"params\">(Object object)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span> == object) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!(object <span class=\"keyword\">instanceof</span> CacheKey)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            CacheKey cacheKey = (CacheKey)object;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hashcode != cacheKey.hashcode) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.checksum != cacheKey.checksum) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.count != cacheKey.count) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span>; i &lt; <span class=\"keyword\">this</span>.updateList.size(); ++i) &#123;</span><br><span class=\"line\">                    Object thisObject = <span class=\"keyword\">this</span>.updateList.get(i);</span><br><span class=\"line\">                    Object thatObject = cacheKey.updateList.get(i);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (!ArrayUtil.equals(thisObject, thatObject)) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">hashCode</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.hashcode;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">toString</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        StringJoiner returnValue = <span class=\"keyword\">new</span> StringJoiner(<span class=\"string\">&quot;:&quot;</span>);</span><br><span class=\"line\">        returnValue.add(String.valueOf(<span class=\"keyword\">this</span>.hashcode));</span><br><span class=\"line\">        returnValue.add(String.valueOf(<span class=\"keyword\">this</span>.checksum));</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.updateList.stream().map(ArrayUtil::toString).forEach(returnValue::add);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> returnValue.toString();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> CacheKey <span class=\"title\">clone</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class=\"line\">        CacheKey clonedCacheKey = (CacheKey)<span class=\"keyword\">super</span>.clone();</span><br><span class=\"line\">        clonedCacheKey.updateList = <span class=\"keyword\">new</span> ArrayList(<span class=\"keyword\">this</span>.updateList);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> clonedCacheKey;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis之执行器Executor","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B9%8BExecutor%E6%89%A7%E8%A1%8C%E5%99%A8/","content":"<h2 id=\"执行器Executor\"><a href=\"#执行器Executor\" class=\"headerlink\" title=\"执行器Executor\"></a>执行器Executor</h2><p>Executor定义了数据库操作的基本方法，SqlSession接口中的功能都是基于Executor接口实现的。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">Executor</span> </span>&#123;</span><br><span class=\"line\">    ResultHandler NO_RESULT_HANDLER = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 执行insert、update、delete</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(MappedStatement var1, Object var2)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(MappedStatement var1, Object var2, RowBounds var3, ResultHandler var4, CacheKey var5, BoundSql var6)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(MappedStatement var1, Object var2, RowBounds var3, ResultHandler var4)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">queryCursor</span><span class=\"params\">(MappedStatement var1, Object var2, RowBounds var3)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">List&lt;BatchResult&gt; <span class=\"title\">flushStatements</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">commit</span><span class=\"params\">(<span class=\"keyword\">boolean</span> var1)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">rollback</span><span class=\"params\">(<span class=\"keyword\">boolean</span> var1)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 创建缓存中用到的CacheKey对象</span></span><br><span class=\"line\">    <span class=\"function\">CacheKey <span class=\"title\">createCacheKey</span><span class=\"params\">(MappedStatement var1, Object var2, RowBounds var3, BoundSql var4)</span></span>;</span><br><span class=\"line\">        <span class=\"comment\">// 根据CacheKey对象查找缓存</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isCached</span><span class=\"params\">(MappedStatement var1, CacheKey var2)</span></span>;</span><br><span class=\"line\">        <span class=\"comment\">// 清空一级缓存</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">clearLocalCache</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">        <span class=\"comment\">// 延迟加载一级缓存中的数据</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">deferLoad</span><span class=\"params\">(MappedStatement var1, MetaObject var2, String var3, CacheKey var4, Class&lt;?&gt; var5)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">Transaction <span class=\"title\">getTransaction</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">close</span><span class=\"params\">(<span class=\"keyword\">boolean</span> var1)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">isClosed</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">setExecutorWrapper</span><span class=\"params\">(Executor var1)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>Executor有两个实现类BaseExecutor和CachingExecutor</p>\n<h3 id=\"BaseExecutor\"><a href=\"#BaseExecutor\" class=\"headerlink\" title=\"BaseExecutor\"></a>BaseExecutor</h3><p>BaseExecutor是一个实现了Executor接口的抽象类，实现了Executor接口的大部分方法，主要提供了缓存管理和事务管理的基本功能，继承BaseExecutor需要实现四个基本方法来实现数据库的相关操作，doUpdate()、doQuery()、doQueryCursor()、doFlushStatement()方法。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BaseExecutor</span> <span class=\"keyword\">implements</span> <span class=\"title\">Executor</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Log log = LogFactory.getLog(BaseExecutor.class);</span><br><span class=\"line\">      <span class=\"comment\">// 事务</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Transaction transaction;</span><br><span class=\"line\">      <span class=\"comment\">// 封装Executor对象</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Executor wrapper;</span><br><span class=\"line\">      <span class=\"comment\">// 延迟加载队列</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> ConcurrentLinkedQueue&lt;BaseExecutor.DeferredLoad&gt; deferredLoads;</span><br><span class=\"line\">      <span class=\"comment\">// 一级缓存，用于缓存查询结果集映射得到的结果对象</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> PerpetualCache localCache;</span><br><span class=\"line\">      <span class=\"comment\">// 以及缓存，用于缓存输出类型参数</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> PerpetualCache localOutputParameterCache;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Configuration configuration;</span><br><span class=\"line\">      <span class=\"comment\">// 用来记录嵌套查询层数</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">int</span> queryStack;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> closed;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"title\">BaseExecutor</span><span class=\"params\">(Configuration configuration, Transaction transaction)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.transaction = transaction;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.deferredLoads = <span class=\"keyword\">new</span> ConcurrentLinkedQueue();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.localCache = <span class=\"keyword\">new</span> PerpetualCache(<span class=\"string\">&quot;LocalCache&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.localOutputParameterCache = <span class=\"keyword\">new</span> PerpetualCache(<span class=\"string\">&quot;LocalOutputParameterCache&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.closed = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.configuration = configuration;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.wrapper = <span class=\"keyword\">this</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(MappedStatement ms, Object parameter)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        ErrorContext.instance().resource(ms.getResource()).activity(<span class=\"string\">&quot;executing an update&quot;</span>).object(ms.getId());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.closed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Executor was closed.&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 先清除一级缓存</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.clearLocalCache();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.doUpdate(ms, parameter);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 获取BoundSql</span></span><br><span class=\"line\">        BoundSql boundSql = ms.getBoundSql(parameter);</span><br><span class=\"line\">          <span class=\"comment\">// 创建cacheKey</span></span><br><span class=\"line\">        CacheKey key = <span class=\"keyword\">this</span>.createCacheKey(ms, parameter, rowBounds, boundSql);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.query(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        ErrorContext.instance().resource(ms.getResource()).activity(<span class=\"string\">&quot;executing a query&quot;</span>).object(ms.getId());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.closed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Executor was closed.&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">//非嵌套查询且在&lt;select&gt;节点中配置flushCache属性时，清空一级缓存</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.queryStack == <span class=\"number\">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.clearLocalCache();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            List list;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 增加嵌套层数</span></span><br><span class=\"line\">                ++<span class=\"keyword\">this</span>.queryStack;</span><br><span class=\"line\">                  <span class=\"comment\">// 查询以及缓存</span></span><br><span class=\"line\">                list = resultHandler == <span class=\"keyword\">null</span> ? (List)<span class=\"keyword\">this</span>.localCache.getObject(key) : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (list != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                      <span class=\"comment\">// 针对于存储过程调用处理，在一级缓存命中时，获取缓存中保存的输出类型参数，并设置到用户传入的实参中</span></span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                      <span class=\"comment\">// 调用doQuery查询</span></span><br><span class=\"line\">                    list = <span class=\"keyword\">this</span>.queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 当前查询完成，查询层数减少</span></span><br><span class=\"line\">                --<span class=\"keyword\">this</span>.queryStack;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">                        </span><br><span class=\"line\">              <span class=\"comment\">// 延迟加载</span></span><br><span class=\"line\">              <span class=\"comment\">// 在外层查询结束时，所有嵌套查询已经完成，相关缓存项也已经完全加载，触发DeferredLoad加载一级缓存中记录的嵌套查询的结果对象</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.queryStack == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                Iterator var8 = <span class=\"keyword\">this</span>.deferredLoads.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">while</span>(var8.hasNext()) &#123;</span><br><span class=\"line\">                    BaseExecutor.DeferredLoad deferredLoad = (BaseExecutor.DeferredLoad)var8.next();</span><br><span class=\"line\">                    deferredLoad.load();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                                <span class=\"comment\">// 加载完成后，清空deferredLoads</span></span><br><span class=\"line\">                <span class=\"keyword\">this</span>.deferredLoads.clear();</span><br><span class=\"line\">                  <span class=\"comment\">// LocalCacheScope本地缓存的作用域</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.clearLocalCache();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> list;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">queryCursor</span><span class=\"params\">(MappedStatement ms, Object parameter, RowBounds rowBounds)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        BoundSql boundSql = ms.getBoundSql(parameter);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.doQueryCursor(ms, parameter, rowBounds, boundSql);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">deferLoad</span><span class=\"params\">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.closed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Executor was closed.&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 创建延迟加载对象</span></span><br><span class=\"line\">            BaseExecutor.DeferredLoad deferredLoad = <span class=\"keyword\">new</span> BaseExecutor.DeferredLoad(resultObject, property, key, <span class=\"keyword\">this</span>.localCache, <span class=\"keyword\">this</span>.configuration, targetType);</span><br><span class=\"line\">              <span class=\"comment\">// 以及缓存中已经记录了指定查询的结果对象，直接从缓存中加载对象，设置到外层对象中</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (deferredLoad.canLoad()) &#123;</span><br><span class=\"line\">                deferredLoad.load();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 将DeferredLoad对象添加到deferredLoads队列中，待整个外层查询结束后，在加载该结果对象</span></span><br><span class=\"line\">                <span class=\"keyword\">this</span>.deferredLoads.add(<span class=\"keyword\">new</span> BaseExecutor.DeferredLoad(resultObject, property, key, <span class=\"keyword\">this</span>.localCache, <span class=\"keyword\">this</span>.configuration, targetType));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        <span class=\"comment\">// cachekey由MappedStatement的id、offset、limit、SQL语句(包含？占位符)、用户传的实参以及Environment的id五部分组成</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> CacheKey <span class=\"title\">createCacheKey</span><span class=\"params\">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.closed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Executor was closed.&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 创建cacheKey</span></span><br><span class=\"line\">            CacheKey cacheKey = <span class=\"keyword\">new</span> CacheKey();</span><br><span class=\"line\">              <span class=\"comment\">// 将MappedStatement的id添加到CacheKey中</span></span><br><span class=\"line\">            cacheKey.update(ms.getId());</span><br><span class=\"line\">              <span class=\"comment\">// 将offset添加到cacheKey中</span></span><br><span class=\"line\">            cacheKey.update(rowBounds.getOffset());</span><br><span class=\"line\">              <span class=\"comment\">// 将limit添加到cacheKey中</span></span><br><span class=\"line\">            cacheKey.update(rowBounds.getLimit());</span><br><span class=\"line\">              <span class=\"comment\">// 将SQL语句添加到cacheKey中</span></span><br><span class=\"line\">            cacheKey.update(boundSql.getSql());</span><br><span class=\"line\">            List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class=\"line\">            TypeHandlerRegistry typeHandlerRegistry = ms.getConfiguration().getTypeHandlerRegistry();</span><br><span class=\"line\">            Iterator var8 = parameterMappings.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"comment\">// 获取用户传入的实参，添加到cacheKey中</span></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(var8.hasNext()) &#123;</span><br><span class=\"line\">                ParameterMapping parameterMapping = (ParameterMapping)var8.next();</span><br><span class=\"line\">                  <span class=\"comment\">// 过滤掉输出类型的参数</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;</span><br><span class=\"line\">                    String propertyName = parameterMapping.getProperty();</span><br><span class=\"line\">                    Object value;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class=\"line\">                        value = boundSql.getAdditionalParameter(propertyName);</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (parameterObject == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                        value = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class=\"line\">                        value = parameterObject;</span><br><span class=\"line\">                    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                        MetaObject metaObject = <span class=\"keyword\">this</span>.configuration.newMetaObject(parameterObject);</span><br><span class=\"line\">                        value = metaObject.getValue(propertyName);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    cacheKey.update(value);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">                        <span class=\"comment\">// 如果Environment不为空的话，把id添加到cachekey中</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.configuration.getEnvironment() != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                cacheKey.update(<span class=\"keyword\">this</span>.configuration.getEnvironment().getId());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> cacheKey;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isCached</span><span class=\"params\">(MappedStatement ms, CacheKey key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.localCache.getObject(key) != <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> List&lt;BatchResult&gt; <span class=\"title\">flushStatements</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 执行Executor中缓存的SQL语句</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.flushStatements(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;BatchResult&gt; <span class=\"title\">flushStatements</span><span class=\"params\">(<span class=\"keyword\">boolean</span> isRollBack)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.closed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Executor was closed.&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// true表示不执行  false表示执行</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.doFlushStatements(isRollBack);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">commit</span><span class=\"params\">(<span class=\"keyword\">boolean</span> required)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.closed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Cannot commit, transaction is already closed&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 清空一级缓存</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.clearLocalCache();</span><br><span class=\"line\">              <span class=\"comment\">// 执行缓存中的SQL语句</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.flushStatements();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (required) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 提交事务</span></span><br><span class=\"line\">                <span class=\"keyword\">this</span>.transaction.commit();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">rollback</span><span class=\"params\">(<span class=\"keyword\">boolean</span> required)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.closed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.clearLocalCache();</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.flushStatements(<span class=\"keyword\">true</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (required) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.transaction.rollback();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">   <span class=\"function\"><span class=\"keyword\">public</span> Transaction <span class=\"title\">getTransaction</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.closed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Executor was closed.&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.transaction;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">close</span><span class=\"params\">(<span class=\"keyword\">boolean</span> forceRollback)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.rollback(forceRollback);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.transaction != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.transaction.close();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SQLException var11) &#123;</span><br><span class=\"line\">            log.warn(<span class=\"string\">&quot;Unexpected exception on closing transaction.  Cause: &quot;</span> + var11);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.transaction = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.deferredLoads = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.localCache = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.localOutputParameterCache = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.closed = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isClosed</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.closed;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clearLocalCache</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.closed) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.localCache.clear();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.localOutputParameterCache.clear();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">abstract</span> <span class=\"keyword\">int</span> <span class=\"title\">doUpdate</span><span class=\"params\">(MappedStatement var1, Object var2)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">abstract</span> List&lt;BatchResult&gt; <span class=\"title\">doFlushStatements</span><span class=\"params\">(<span class=\"keyword\">boolean</span> var1)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">abstract</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">doQuery</span><span class=\"params\">(MappedStatement var1, Object var2, RowBounds var3, ResultHandler var4, BoundSql var5)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">abstract</span> &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">doQueryCursor</span><span class=\"params\">(MappedStatement var1, Object var2, RowBounds var3, BoundSql var4)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">closeStatement</span><span class=\"params\">(Statement statement)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (statement != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                statement.close();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (SQLException var3) &#123;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">applyTransactionTimeout</span><span class=\"params\">(Statement statement)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        StatementUtil.applyTransactionTimeout(statement, statement.getQueryTimeout(), <span class=\"keyword\">this</span>.transaction.getTimeout());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">handleLocallyCachedOutputParameters</span><span class=\"params\">(MappedStatement ms, CacheKey key, Object parameter, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class=\"line\">            Object cachedParameter = <span class=\"keyword\">this</span>.localOutputParameterCache.getObject(key);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cachedParameter != <span class=\"keyword\">null</span> &amp;&amp; parameter != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                MetaObject metaCachedParameter = <span class=\"keyword\">this</span>.configuration.newMetaObject(cachedParameter);</span><br><span class=\"line\">                MetaObject metaParameter = <span class=\"keyword\">this</span>.configuration.newMetaObject(parameter);</span><br><span class=\"line\">                Iterator var8 = boundSql.getParameterMappings().iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">while</span>(var8.hasNext()) &#123;</span><br><span class=\"line\">                    ParameterMapping parameterMapping = (ParameterMapping)var8.next();</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (parameterMapping.getMode() != ParameterMode.IN) &#123;</span><br><span class=\"line\">                        String parameterName = parameterMapping.getProperty();</span><br><span class=\"line\">                        Object cachedValue = metaCachedParameter.getValue(parameterName);</span><br><span class=\"line\">                        metaParameter.setValue(parameterName, cachedValue);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">queryFromDatabase</span><span class=\"params\">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// ExecutionPlaceholder.EXECUTION_PLACEHOLDER缓存的占位符</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.localCache.putObject(key, ExecutionPlaceholder.EXECUTION_PLACEHOLDER);</span><br><span class=\"line\"></span><br><span class=\"line\">        List list;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            list = <span class=\"keyword\">this</span>.doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 删除占位符</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.localCache.removeObject(key);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">                <span class=\"comment\">// 将真正的结果对象放入一级缓存中</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.localCache.putObject(key, list);</span><br><span class=\"line\">          <span class=\"comment\">// 是否为存储过程</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 缓存输出类型的参数</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.localOutputParameterCache.putObject(key, parameter);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> list;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> Connection <span class=\"title\">getConnection</span><span class=\"params\">(Log statementLog)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Connection connection = <span class=\"keyword\">this</span>.transaction.getConnection();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> statementLog.isDebugEnabled() ? ConnectionLogger.newInstance(connection, statementLog, <span class=\"keyword\">this</span>.queryStack) : connection;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setExecutorWrapper</span><span class=\"params\">(Executor wrapper)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.wrapper = wrapper;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DeferredLoad</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 外层对象对应的MetaObject</span></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> MetaObject resultObject;</span><br><span class=\"line\">          <span class=\"comment\">// 延迟加载的属性名称</span></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String property;</span><br><span class=\"line\">          <span class=\"comment\">// 延迟加载的属性的类型</span></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Class&lt;?&gt; targetType;</span><br><span class=\"line\">          <span class=\"comment\">// 延迟加载的结果对象在一级缓存中相应的CacheKey</span></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> CacheKey key;</span><br><span class=\"line\">          <span class=\"comment\">// 一级缓存，与BaseExecutor.localCache字段指向同一个对象</span></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> PerpetualCache localCache;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ObjectFactory objectFactory;</span><br><span class=\"line\">          <span class=\"comment\">// 负责结果对象的类型转换</span></span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ResultExtractor resultExtractor;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">DeferredLoad</span><span class=\"params\">(MetaObject resultObject, String property, CacheKey key, PerpetualCache localCache, Configuration configuration, Class&lt;?&gt; targetType)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.resultObject = resultObject;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.property = property;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.key = key;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.localCache = localCache;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.objectFactory = configuration.getObjectFactory();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.resultExtractor = <span class=\"keyword\">new</span> ResultExtractor(configuration, <span class=\"keyword\">this</span>.objectFactory);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.targetType = targetType;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">                <span class=\"comment\">// 检测缓存项是否已经完全加载到缓存中   ExecutionPlaceholder.EXECUTION_PLACEHOLDER为缓存的占位符</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">canLoad</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.localCache.getObject(<span class=\"keyword\">this</span>.key) != <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.localCache.getObject(<span class=\"keyword\">this</span>.key) != ExecutionPlaceholder.EXECUTION_PLACEHOLDER;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">load</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            List&lt;Object&gt; list = (List)<span class=\"keyword\">this</span>.localCache.getObject(<span class=\"keyword\">this</span>.key);</span><br><span class=\"line\">            Object value = <span class=\"keyword\">this</span>.resultExtractor.extractObjectFromList(list, <span class=\"keyword\">this</span>.targetType);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.resultObject.setValue(<span class=\"keyword\">this</span>.property, value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"一级缓存\"><a href=\"#一级缓存\" class=\"headerlink\" title=\"一级缓存\"></a>一级缓存</h4><p>一级缓存是会话级别的缓存，在mybatis中每创建一个SqlSession对象，就表示开启了一次数据库会话。在一次绘画中，应用程序可能会在短时间内，如一次事务内，反复执行完全相同的查询语句，如果不对数据进行缓存，那么每次查询都会执行一次数据库查询操作，而多次完全相同的、时间间隔较短的查询语句得到的结果集极有可能完全相同，会造成数据库资源的浪费。</p>\n<p>mybatis在Executor中会建立一个缓存，将每次查询的结果对象缓存起来。在执行查询操作时，会先查询一级缓存，如果其中存在完全一样的查询语句，则直接从一级缓存中取出相应的结果对象返给用户，减少数据库的压力。</p>\n<p>一级缓存的生命周期与SqlSession相同（其实是与SqlSession中封装的Executor对象的生命周期相同），当调用Executor.close方法时，Executor所对应的一级缓存就会不可用。在调用Executor.update方法时，会清空一级缓存。</p>\n<h3 id=\"SimpleExecutor\"><a href=\"#SimpleExecutor\" class=\"headerlink\" title=\"SimpleExecutor\"></a>SimpleExecutor</h3><p>SimpleExecutor继承了BaseExecutor抽象类。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SimpleExecutor</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseExecutor</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">SimpleExecutor</span><span class=\"params\">(Configuration configuration, Transaction transaction)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(configuration, transaction);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">doUpdate</span><span class=\"params\">(MappedStatement ms, Object parameter)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Statement stmt = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">int</span> var6;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">            StatementHandler handler = configuration.newStatementHandler(<span class=\"keyword\">this</span>, ms, parameter, RowBounds.DEFAULT, (ResultHandler)<span class=\"keyword\">null</span>, (BoundSql)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">            stmt = <span class=\"keyword\">this</span>.prepareStatement(handler, ms.getStatementLog());</span><br><span class=\"line\">            var6 = handler.update(stmt);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.closeStatement(stmt);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> var6;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">doQuery</span><span class=\"params\">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Statement stmt = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        List var9;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">              <span class=\"comment\">// 创建StatementHandler对象，返回的为RoutingStatementHandler对象</span></span><br><span class=\"line\">            StatementHandler handler = configuration.newStatementHandler(<span class=\"keyword\">this</span>.wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class=\"line\">              <span class=\"comment\">// 创建statement</span></span><br><span class=\"line\">            stmt = <span class=\"keyword\">this</span>.prepareStatement(handler, ms.getStatementLog());</span><br><span class=\"line\">              <span class=\"comment\">// 调用StatementHandler.query方法 执行sql语句  并使用resultHandler进行结果集的映射</span></span><br><span class=\"line\">            var9 = handler.query(stmt, resultHandler);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.closeStatement(stmt);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> var9;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">doQueryCursor</span><span class=\"params\">(MappedStatement ms, Object parameter, RowBounds rowBounds, BoundSql boundSql)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">        StatementHandler handler = configuration.newStatementHandler(<span class=\"keyword\">this</span>.wrapper, ms, parameter, rowBounds, (ResultHandler)<span class=\"keyword\">null</span>, boundSql);</span><br><span class=\"line\">        Statement stmt = <span class=\"keyword\">this</span>.prepareStatement(handler, ms.getStatementLog());</span><br><span class=\"line\">        Cursor&lt;E&gt; cursor = handler.queryCursor(stmt);</span><br><span class=\"line\">        stmt.closeOnCompletion();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> cursor;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;BatchResult&gt; <span class=\"title\">doFlushStatements</span><span class=\"params\">(<span class=\"keyword\">boolean</span> isRollback)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Collections.emptyList();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Statement <span class=\"title\">prepareStatement</span><span class=\"params\">(StatementHandler handler, Log statementLog)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Connection connection = <span class=\"keyword\">this</span>.getConnection(statementLog);</span><br><span class=\"line\">        Statement stmt = handler.prepare(connection, <span class=\"keyword\">this</span>.transaction.getTimeout());</span><br><span class=\"line\">        handler.parameterize(stmt);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> stmt;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ReuseExecutor\"><a href=\"#ReuseExecutor\" class=\"headerlink\" title=\"ReuseExecutor\"></a>ReuseExecutor</h3><p>重用statement对象是一种常用的优化手段，可以减少SQL预编译的开销以及创建和销毁Statement对象的开销，提高性能。</p>\n<p>ReuseExecutor提供了Statement对象重用的功能，通过statementMap字段缓存使用过的Statement对象，key是SQL语句，value是sql所对应的Statement对象。</p>\n<p>ReuseExecutor与SimpleExecutor的区别在于prepareStatement方法，SimpleExecutor每次都会通过connection创建新的Statement对象，而ReuseExecutor会先尝试从statementMap中获取。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ReuseExecutor</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseExecutor</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;String, Statement&gt; statementMap = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ReuseExecutor</span><span class=\"params\">(Configuration configuration, Transaction transaction)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(configuration, transaction);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">doUpdate</span><span class=\"params\">(MappedStatement ms, Object parameter)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">        StatementHandler handler = configuration.newStatementHandler(<span class=\"keyword\">this</span>, ms, parameter, RowBounds.DEFAULT, (ResultHandler)<span class=\"keyword\">null</span>, (BoundSql)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">        Statement stmt = <span class=\"keyword\">this</span>.prepareStatement(handler, ms.getStatementLog());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> handler.update(stmt);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">doQuery</span><span class=\"params\">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">        StatementHandler handler = configuration.newStatementHandler(<span class=\"keyword\">this</span>.wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class=\"line\">        Statement stmt = <span class=\"keyword\">this</span>.prepareStatement(handler, ms.getStatementLog());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> handler.query(stmt, resultHandler);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">doQueryCursor</span><span class=\"params\">(MappedStatement ms, Object parameter, RowBounds rowBounds, BoundSql boundSql)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">        StatementHandler handler = configuration.newStatementHandler(<span class=\"keyword\">this</span>.wrapper, ms, parameter, rowBounds, (ResultHandler)<span class=\"keyword\">null</span>, boundSql);</span><br><span class=\"line\">        Statement stmt = <span class=\"keyword\">this</span>.prepareStatement(handler, ms.getStatementLog());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> handler.queryCursor(stmt);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;BatchResult&gt; <span class=\"title\">doFlushStatements</span><span class=\"params\">(<span class=\"keyword\">boolean</span> isRollback)</span> </span>&#123;</span><br><span class=\"line\">        Iterator var2 = <span class=\"keyword\">this</span>.statementMap.values().iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(var2.hasNext()) &#123;</span><br><span class=\"line\">            Statement stmt = (Statement)var2.next();</span><br><span class=\"line\">              <span class=\"comment\">// 关闭statement</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.closeStatement(stmt);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">                <span class=\"comment\">// 清空缓存</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.statementMap.clear();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> Collections.emptyList();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Statement <span class=\"title\">prepareStatement</span><span class=\"params\">(StatementHandler handler, Log statementLog)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        BoundSql boundSql = handler.getBoundSql();</span><br><span class=\"line\">        String sql = boundSql.getSql();</span><br><span class=\"line\">        Statement stmt;</span><br><span class=\"line\">          <span class=\"comment\">// 检测是否存储了该SQL</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.hasStatementFor(sql)) &#123;</span><br><span class=\"line\">            stmt = <span class=\"keyword\">this</span>.getStatement(sql);</span><br><span class=\"line\">              <span class=\"comment\">// 修改超时时间</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.applyTransactionTimeout(stmt);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Connection connection = <span class=\"keyword\">this</span>.getConnection(statementLog);</span><br><span class=\"line\">              <span class=\"comment\">// 创建新的Statement对象</span></span><br><span class=\"line\">            stmt = handler.prepare(connection, <span class=\"keyword\">this</span>.transaction.getTimeout());</span><br><span class=\"line\">              <span class=\"comment\">// 缓存</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.putStatement(sql, stmt);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">                <span class=\"comment\">// 处理占位符</span></span><br><span class=\"line\">        handler.parameterize(stmt);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> stmt;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">hasStatementFor</span><span class=\"params\">(String sql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Statement statement = (Statement)<span class=\"keyword\">this</span>.statementMap.get(sql);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> statement != <span class=\"keyword\">null</span> &amp;&amp; !statement.getConnection().isClosed();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SQLException var3) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Statement <span class=\"title\">getStatement</span><span class=\"params\">(String s)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (Statement)<span class=\"keyword\">this</span>.statementMap.get(s);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">putStatement</span><span class=\"params\">(String sql, Statement stmt)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.statementMap.put(sql, stmt);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"BatchExecutor\"><a href=\"#BatchExecutor\" class=\"headerlink\" title=\"BatchExecutor\"></a>BatchExecutor</h3><p>在执行一条SQL语句，会将SQL语句以及相关参数通过网络发送到数据库系统。对于频繁操作数据库的应用来说，如果执行一条SQL就向数据库发送一次请求，就会在网络通信商浪费很多时间。使用批处理的优化方式可以在客户端缓存多条SQL语句，并将多条语句打包发送给数据库执行，从而减少网络开销，提高性能。</p>\n<p>在批量执行多条SQL语句时，每次向数据库发送的SQL语句条数是有上限的，如果超过上限，数据库会拒绝执行这些SQL语句并抛出异常。</p>\n<p>JDBC的批处理只支持insert、update和delete，不支持select</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">BatchExecutor</span> <span class=\"keyword\">extends</span> <span class=\"title\">BaseExecutor</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> BATCH_UPDATE_RETURN_VALUE = -<span class=\"number\">2147482646</span>;</span><br><span class=\"line\">      <span class=\"comment\">// 缓存多个statement，每个statement中都存储了多条SQL语句</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;Statement&gt; statementList = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\">      <span class=\"comment\">// 记录批处理结果，BatchResult中通过updateCounts字段来记录每个statement执行的结果</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;BatchResult&gt; batchResultList = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\">      <span class=\"comment\">// 记录当前执行的SQL</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> String currentSql;</span><br><span class=\"line\">      <span class=\"comment\">// 记录当前执行的MappedStatement</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> MappedStatement currentStatement;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">BatchExecutor</span><span class=\"params\">(Configuration configuration, Transaction transaction)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>(configuration, transaction);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">doUpdate</span><span class=\"params\">(MappedStatement ms, Object parameterObject)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">        StatementHandler handler = configuration.newStatementHandler(<span class=\"keyword\">this</span>, ms, parameterObject, RowBounds.DEFAULT, (ResultHandler)<span class=\"keyword\">null</span>, (BoundSql)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">        BoundSql boundSql = handler.getBoundSql();</span><br><span class=\"line\">        String sql = boundSql.getSql();</span><br><span class=\"line\">        Statement stmt;</span><br><span class=\"line\">          <span class=\"comment\">// 如果当前执行的SQL与上次执行的相同，且对应的MappedStatement也相同</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (sql.equals(<span class=\"keyword\">this</span>.currentSql) &amp;&amp; ms.equals(<span class=\"keyword\">this</span>.currentStatement)) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 获取集合中的最后一个</span></span><br><span class=\"line\">            <span class=\"keyword\">int</span> last = <span class=\"keyword\">this</span>.statementList.size() - <span class=\"number\">1</span>;</span><br><span class=\"line\">            stmt = (Statement)<span class=\"keyword\">this</span>.statementList.get(last);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.applyTransactionTimeout(stmt);</span><br><span class=\"line\">              <span class=\"comment\">// 绑定实参，处理？占位符</span></span><br><span class=\"line\">            handler.parameterize(stmt);</span><br><span class=\"line\">            BatchResult batchResult = (BatchResult)<span class=\"keyword\">this</span>.batchResultList.get(last);</span><br><span class=\"line\">            batchResult.addParameterObject(parameterObject);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Connection connection = <span class=\"keyword\">this</span>.getConnection(ms.getStatementLog());</span><br><span class=\"line\">            stmt = handler.prepare(connection, <span class=\"keyword\">this</span>.transaction.getTimeout());</span><br><span class=\"line\">            handler.parameterize(stmt);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.currentSql = sql;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.currentStatement = ms;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.statementList.add(stmt);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.batchResultList.add(<span class=\"keyword\">new</span> BatchResult(ms, sql, parameterObject));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">                <span class=\"comment\">// 通过Statement.addBatch方法添加SQL语句</span></span><br><span class=\"line\">        handler.batch(stmt);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> -<span class=\"number\">2147482646</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">doQuery</span><span class=\"params\">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Statement stmt = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        List var10;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.flushStatements();</span><br><span class=\"line\">            Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">            StatementHandler handler = configuration.newStatementHandler(<span class=\"keyword\">this</span>.wrapper, ms, parameterObject, rowBounds, resultHandler, boundSql);</span><br><span class=\"line\">            Connection connection = <span class=\"keyword\">this</span>.getConnection(ms.getStatementLog());</span><br><span class=\"line\">            stmt = handler.prepare(connection, <span class=\"keyword\">this</span>.transaction.getTimeout());</span><br><span class=\"line\">            handler.parameterize(stmt);</span><br><span class=\"line\">            var10 = handler.query(stmt, resultHandler);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.closeStatement(stmt);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> var10;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">doQueryCursor</span><span class=\"params\">(MappedStatement ms, Object parameter, RowBounds rowBounds, BoundSql boundSql)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.flushStatements();</span><br><span class=\"line\">        Configuration configuration = ms.getConfiguration();</span><br><span class=\"line\">        StatementHandler handler = configuration.newStatementHandler(<span class=\"keyword\">this</span>.wrapper, ms, parameter, rowBounds, (ResultHandler)<span class=\"keyword\">null</span>, boundSql);</span><br><span class=\"line\">        Connection connection = <span class=\"keyword\">this</span>.getConnection(ms.getStatementLog());</span><br><span class=\"line\">        Statement stmt = handler.prepare(connection, <span class=\"keyword\">this</span>.transaction.getTimeout());</span><br><span class=\"line\">        handler.parameterize(stmt);</span><br><span class=\"line\">        Cursor&lt;E&gt; cursor = handler.queryCursor(stmt);</span><br><span class=\"line\">        stmt.closeOnCompletion();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> cursor;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;BatchResult&gt; <span class=\"title\">doFlushStatements</span><span class=\"params\">(<span class=\"keyword\">boolean</span> isRollback)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">boolean</span> var17 = <span class=\"keyword\">false</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        Statement stmt;</span><br><span class=\"line\">        ArrayList var21;</span><br><span class=\"line\">        Iterator var22;</span><br><span class=\"line\">        label179: &#123;</span><br><span class=\"line\">            List var3;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                var17 = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">                ArrayList results = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!isRollback) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">int</span> i = <span class=\"number\">0</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> n = <span class=\"keyword\">this</span>.statementList.size(); i &lt; n; ++i) &#123;</span><br><span class=\"line\">                        stmt = (Statement)<span class=\"keyword\">this</span>.statementList.get(i);</span><br><span class=\"line\">                        <span class=\"keyword\">this</span>.applyTransactionTimeout(stmt);</span><br><span class=\"line\">                        BatchResult batchResult = (BatchResult)<span class=\"keyword\">this</span>.batchResultList.get(i);</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                              <span class=\"comment\">// 调用Statement.executeBatch来批量执行SQL 返回的int[] 来更新BatchResult的updateCounts字段</span></span><br><span class=\"line\">                            batchResult.setUpdateCounts(stmt.executeBatch());</span><br><span class=\"line\">                            MappedStatement ms = batchResult.getMappedStatement();</span><br><span class=\"line\">                            List&lt;Object&gt; parameterObjects = batchResult.getParameterObjects();</span><br><span class=\"line\">                            KeyGenerator keyGenerator = ms.getKeyGenerator();</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (Jdbc3KeyGenerator.class.equals(keyGenerator.getClass())) &#123;</span><br><span class=\"line\">                                Jdbc3KeyGenerator jdbc3KeyGenerator = (Jdbc3KeyGenerator)keyGenerator;</span><br><span class=\"line\">                                jdbc3KeyGenerator.processBatch(ms, stmt, parameterObjects);</span><br><span class=\"line\">                            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (!NoKeyGenerator.class.equals(keyGenerator.getClass())) &#123;</span><br><span class=\"line\">                                Iterator var10 = parameterObjects.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">                                <span class=\"keyword\">while</span>(var10.hasNext()) &#123;</span><br><span class=\"line\">                                    Object parameter = var10.next();</span><br><span class=\"line\">                                    keyGenerator.processAfter(<span class=\"keyword\">this</span>, ms, stmt, parameter);</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"keyword\">this</span>.closeStatement(stmt);</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">catch</span> (BatchUpdateException var18) &#123;</span><br><span class=\"line\">                            StringBuilder message = <span class=\"keyword\">new</span> StringBuilder();</span><br><span class=\"line\">                            message.append(batchResult.getMappedStatement().getId()).append(<span class=\"string\">&quot; (batch index #&quot;</span>).append(i + <span class=\"number\">1</span>).append(<span class=\"string\">&quot;)&quot;</span>).append(<span class=\"string\">&quot; failed.&quot;</span>);</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (i &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                                message.append(<span class=\"string\">&quot; &quot;</span>).append(i).append(<span class=\"string\">&quot; prior sub executor(s) completed successfully, but will be rolled back.&quot;</span>);</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> BatchExecutorException(message.toString(), var18, results, batchResult);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        results.add(batchResult);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    var21 = results;</span><br><span class=\"line\">                    var17 = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">break</span> label179;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                var3 = Collections.emptyList();</span><br><span class=\"line\">                var17 = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (var17) &#123;</span><br><span class=\"line\">                    Iterator var13 = <span class=\"keyword\">this</span>.statementList.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">while</span>(var13.hasNext()) &#123;</span><br><span class=\"line\">                        Statement stmt = (Statement)var13.next();</span><br><span class=\"line\">                        <span class=\"keyword\">this</span>.closeStatement(stmt);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.currentSql = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.statementList.clear();</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.batchResultList.clear();</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            var22 = <span class=\"keyword\">this</span>.statementList.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(var22.hasNext()) &#123;</span><br><span class=\"line\">                stmt = (Statement)var22.next();</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.closeStatement(stmt);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.currentSql = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.statementList.clear();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.batchResultList.clear();</span><br><span class=\"line\">            <span class=\"keyword\">return</span> var3;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        var22 = <span class=\"keyword\">this</span>.statementList.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(var22.hasNext()) &#123;</span><br><span class=\"line\">            stmt = (Statement)var22.next();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.closeStatement(stmt);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.currentSql = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.statementList.clear();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.batchResultList.clear();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> var21;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"CachingExecutor\"><a href=\"#CachingExecutor\" class=\"headerlink\" title=\"CachingExecutor\"></a>CachingExecutor</h3><p>CachingExecutor提供了二级缓存的功能。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CachingExecutor</span> <span class=\"keyword\">implements</span> <span class=\"title\">Executor</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Executor delegate;</span><br><span class=\"line\">      <span class=\"comment\">// 用于管理CachingExecutor使用的二级缓存对象  key为二级缓存对象  value为TransacionalCache对象</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TransactionalCacheManager tcm = <span class=\"keyword\">new</span> TransactionalCacheManager();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CachingExecutor</span><span class=\"params\">(Executor delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">        delegate.setExecutorWrapper(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Transaction <span class=\"title\">getTransaction</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getTransaction();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">close</span><span class=\"params\">(<span class=\"keyword\">boolean</span> forceRollback)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (forceRollback) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.tcm.rollback();</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.tcm.commit();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate.close(forceRollback);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isClosed</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.isClosed();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">update</span><span class=\"params\">(MappedStatement ms, Object parameterObject)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.flushCacheIfRequired(ms);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.update(ms, parameterObject);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">queryCursor</span><span class=\"params\">(MappedStatement ms, Object parameter, RowBounds rowBounds)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.flushCacheIfRequired(ms);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.queryCursor(ms, parameter, rowBounds);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 获取BoundSql对象</span></span><br><span class=\"line\">        BoundSql boundSql = ms.getBoundSql(parameterObject);</span><br><span class=\"line\">          <span class=\"comment\">// 创建cacheKey对象</span></span><br><span class=\"line\">        CacheKey key = <span class=\"keyword\">this</span>.createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">query</span><span class=\"params\">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 获取查询有所在命名空间对应的二级缓存</span></span><br><span class=\"line\">        Cache cache = ms.getCache();</span><br><span class=\"line\">          <span class=\"comment\">// 是否开启了二级缓存</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (cache != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 根据&lt;select&gt;节点的配置，决定是否需要清空二级缓存</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.flushCacheIfRequired(ms);</span><br><span class=\"line\">              <span class=\"comment\">// 检测SQL节点的useCache配置以及是否使用了resultHandler配置</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 二级缓存不能保存输出类型的参数，如果查询操作调用了包含输出类型的存储过程，则报错</span></span><br><span class=\"line\">                <span class=\"keyword\">this</span>.ensureNoOutParams(ms, boundSql);</span><br><span class=\"line\">                  <span class=\"comment\">// 查询二级缓存</span></span><br><span class=\"line\">                List&lt;E&gt; list = (List)<span class=\"keyword\">this</span>.tcm.getObject(cache, key);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (list == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                      <span class=\"comment\">// 二级缓存不存在，调用封装的executor对象的query方法</span></span><br><span class=\"line\">                    list = <span class=\"keyword\">this</span>.delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class=\"line\">                      <span class=\"comment\">// 将查询结果存储到TransactionalCache.entriesToAddOnCommit中</span></span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.tcm.putObject(cache, key, list);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> list;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">                <span class=\"comment\">// 如果没有启动二级缓存，则直接调用executor的query方法</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> List&lt;BatchResult&gt; <span class=\"title\">flushStatements</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.flushStatements();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">commit</span><span class=\"params\">(<span class=\"keyword\">boolean</span> required)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.commit(required);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.tcm.commit();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">rollback</span><span class=\"params\">(<span class=\"keyword\">boolean</span> required)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate.rollback(required);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (required) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.tcm.rollback();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">ensureNoOutParams</span><span class=\"params\">(MappedStatement ms, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class=\"line\">            Iterator var3 = boundSql.getParameterMappings().iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">while</span>(var3.hasNext()) &#123;</span><br><span class=\"line\">                ParameterMapping parameterMapping = (ParameterMapping)var3.next();</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (parameterMapping.getMode() != ParameterMode.IN) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Caching stored procedures with OUT params is not supported.  Please configure useCache=false in &quot;</span> + ms.getId() + <span class=\"string\">&quot; statement.&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> CacheKey <span class=\"title\">createCacheKey</span><span class=\"params\">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">isCached</span><span class=\"params\">(MappedStatement ms, CacheKey key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.isCached(ms, key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">deferLoad</span><span class=\"params\">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.deferLoad(ms, resultObject, property, key, targetType);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clearLocalCache</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate.clearLocalCache();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">flushCacheIfRequired</span><span class=\"params\">(MappedStatement ms)</span> </span>&#123;</span><br><span class=\"line\">        Cache cache = ms.getCache();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (cache != <span class=\"keyword\">null</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.tcm.clear(cache);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">setExecutorWrapper</span><span class=\"params\">(Executor executor)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> UnsupportedOperationException(<span class=\"string\">&quot;This method should not be called&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h5 id=\"TransactionalCacheManager\"><a href=\"#TransactionalCacheManager\" class=\"headerlink\" title=\"TransactionalCacheManager\"></a>TransactionalCacheManager</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TransactionalCacheManager</span> </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// key为二级缓存对象，value为TransactionalCache</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;Cache, TransactionalCache&gt; transactionalCaches = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TransactionalCacheManager</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">(Cache cache)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.getTransactionalCache(cache).clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Cache cache, CacheKey key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.getTransactionalCache(cache).getObject(key);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Cache cache, CacheKey key, Object value)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.getTransactionalCache(cache).putObject(key, value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">commit</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Iterator var1 = <span class=\"keyword\">this</span>.transactionalCaches.values().iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(var1.hasNext()) &#123;</span><br><span class=\"line\">            TransactionalCache txCache = (TransactionalCache)var1.next();</span><br><span class=\"line\">            txCache.commit();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">rollback</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Iterator var1 = <span class=\"keyword\">this</span>.transactionalCaches.values().iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(var1.hasNext()) &#123;</span><br><span class=\"line\">            TransactionalCache txCache = (TransactionalCache)var1.next();</span><br><span class=\"line\">            txCache.rollback();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> TransactionalCache <span class=\"title\">getTransactionalCache</span><span class=\"params\">(Cache cache)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> (TransactionalCache)<span class=\"keyword\">this</span>.transactionalCaches.computeIfAbsent(cache, TransactionalCache::<span class=\"keyword\">new</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h5 id=\"TransactionalCache\"><a href=\"#TransactionalCache\" class=\"headerlink\" title=\"TransactionalCache\"></a>TransactionalCache</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TransactionalCache</span> <span class=\"keyword\">implements</span> <span class=\"title\">Cache</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Log log = LogFactory.getLog(TransactionalCache.class);</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Cache delegate;</span><br><span class=\"line\">      <span class=\"comment\">// true表示当前TransactionalCache不可查询，且提交事务时会将底层Cache清空</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> clearOnCommit;</span><br><span class=\"line\">      <span class=\"comment\">// 暂时存储数据，提交事务后会存储到二级缓存</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;Object, Object&gt; entriesToAddOnCommit;</span><br><span class=\"line\">      <span class=\"comment\">// 记录缓存未命中的CacheKey对象</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Set&lt;Object&gt; entriesMissedInCache;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">TransactionalCache</span><span class=\"params\">(Cache delegate)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.delegate = delegate;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.clearOnCommit = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.entriesToAddOnCommit = <span class=\"keyword\">new</span> HashMap();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.entriesMissedInCache = <span class=\"keyword\">new</span> HashSet();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">getId</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">getSize</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.delegate.getSize();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 先查缓存中是否有</span></span><br><span class=\"line\">        Object object = <span class=\"keyword\">this</span>.delegate.getObject(key);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (object == <span class=\"keyword\">null</span>) &#123;    </span><br><span class=\"line\">              <span class=\"comment\">// 如果缓存中没有，将key存入到entriesMissedInCache中</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.entriesMissedInCache.add(key);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.clearOnCommit ? <span class=\"keyword\">null</span> : object;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        <span class=\"comment\">// putObject不会直接将结果对象记录到二级缓存中，而是暂时保存在entriesToAddOnCommit集合中，在事务提交时才会将结果对象添加到二级缓存中</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">putObject</span><span class=\"params\">(Object key, Object object)</span> </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 将缓存项暂存在entriesToAddOnCommit中</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.entriesToAddOnCommit.put(key, object);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">removeObject</span><span class=\"params\">(Object key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">clear</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.clearOnCommit = <span class=\"keyword\">true</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.entriesToAddOnCommit.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">commit</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.clearOnCommit) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate.clear();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">                <span class=\"comment\">// 放入二级缓存中</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.flushPendingEntries();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.reset();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">rollback</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.unlockMissedEntries();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.reset();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">reset</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.clearOnCommit = <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.entriesToAddOnCommit.clear();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.entriesMissedInCache.clear();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">flushPendingEntries</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Iterator var1 = <span class=\"keyword\">this</span>.entriesToAddOnCommit.entrySet().iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(var1.hasNext()) &#123;</span><br><span class=\"line\">            Entry&lt;Object, Object&gt; entry = (Entry)var1.next();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.delegate.putObject(entry.getKey(), entry.getValue());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        var1 = <span class=\"keyword\">this</span>.entriesMissedInCache.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(var1.hasNext()) &#123;</span><br><span class=\"line\">            Object entry = var1.next();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.entriesToAddOnCommit.containsKey(entry)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.delegate.putObject(entry, (Object)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">unlockMissedEntries</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Iterator var1 = <span class=\"keyword\">this</span>.entriesMissedInCache.iterator();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">while</span>(var1.hasNext()) &#123;</span><br><span class=\"line\">            Object entry = var1.next();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.delegate.removeObject(entry);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception var4) &#123;</span><br><span class=\"line\">                log.warn(<span class=\"string\">&quot;Unexpected exception while notifiying a rollback to the cache adapter. Consider upgrading your cache adapter to the latest version. Cause: &quot;</span> + var4);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"二级缓存\"><a href=\"#二级缓存\" class=\"headerlink\" title=\"二级缓存\"></a>二级缓存</h4><p>mybatis中的二级缓存是应用级别的缓存，生命周期与应用程序的生命周期相同。</p>\n<p>二级缓存相关配置</p>\n<ul>\n<li><p>Mybatis-config.xml配置文件中的cacheEnabled，是二级缓存的总开关  只有配置为true时，二级缓存的配置才会生效，默认为true</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">settings</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">setting</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;cacheEnabled&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;true&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">setting</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>mapper文件中配置cache节点或cache-ref节点 可以在命名空间粒度上管理二级缓存的开启和关闭 <br>配置了<cache>节点，在解析时会为该配置文件所对应的命名空间创建相应的Cache对象作为二级缓存，默认为PerpetualCache，可以使用type属性指定自定义的Cache对象。<br>配置<cache-ref>可以使得多个命名空间共享一个Cache对象</cache-ref></cache></p>\n</li>\n<li><p>&lt;select&gt;节点的useCache属性，表示查询产生的结果是否要保存到二级缓存中。默认为true</p>\n</li>\n</ul>\n","categories":["mybatis"],"tags":["mybatis"]},{"title":"mybatis之结果集处理","url":"/2020/%E6%A1%86%E6%9E%B6/mybatis/%E7%BB%84%E4%BB%B6%E5%88%86%E6%9E%90/mybatis%E4%B9%8B%E7%BB%93%E6%9E%9C%E9%9B%86%E5%A4%84%E7%90%86/","content":"<h2 id=\"ResultSetHandler\"><a href=\"#ResultSetHandler\" class=\"headerlink\" title=\"ResultSetHandler\"></a>ResultSetHandler</h2><p>在StatementHandler接口在执行完指定的select语句之后，会将查询得到的结果集交给ResultSetHandler完成映射处理。ResultSetHandler除了负责映射select语句查询得到的结果集，还会处理存储过程执行后的输出参数。</p>\n<a id=\"more\"></a>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ResultSetHandler</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 处理结果集，生成相应的结果对象集合</span></span><br><span class=\"line\">  &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">handleResultSets</span><span class=\"params\">(Statement stmt)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 处理结果集，返回相应的游标对象</span></span><br><span class=\"line\">  &lt;E&gt; <span class=\"function\">Cursor&lt;E&gt; <span class=\"title\">handleCursorResultSets</span><span class=\"params\">(Statement stmt)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// 处理存储过程的输出参数</span></span><br><span class=\"line\">  <span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">handleOutputParameters</span><span class=\"params\">(CallableStatement cs)</span> <span class=\"keyword\">throws</span> SQLException</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"DefaultResultSetHandler\"><a href=\"#DefaultResultSetHandler\" class=\"headerlink\" title=\"DefaultResultSetHandler\"></a>DefaultResultSetHandler</h3><p>DefaultResultSetHandler是mybatis提供的resultSetHandler接口的唯一实现.</p>\n<h4 id=\"handleResultSets方法\"><a href=\"#handleResultSets方法\" class=\"headerlink\" title=\"handleResultSets方法\"></a>handleResultSets方法</h4><p>处理select语句查询数据库得到的结果集.</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> List&lt;Object&gt; <span class=\"title\">handleResultSets</span><span class=\"params\">(Statement stmt)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    ErrorContext.instance().activity(<span class=\"string\">&quot;handling results&quot;</span>).object(<span class=\"keyword\">this</span>.mappedStatement.getId());</span><br><span class=\"line\">    <span class=\"comment\">// 用于保存映射结果集得到的结果对象</span></span><br><span class=\"line\">      List&lt;Object&gt; multipleResults = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\">    <span class=\"keyword\">int</span> resultSetCount = <span class=\"number\">0</span>;</span><br><span class=\"line\">      <span class=\"comment\">// 获取第一个ResultSet对象（可能存在多个ResultSet，只获取第一个）</span></span><br><span class=\"line\">    ResultSetWrapper rsw = <span class=\"keyword\">this</span>.getFirstResultSet(stmt);</span><br><span class=\"line\">      <span class=\"comment\">// 获取在配置文件中配置的resultMap</span></span><br><span class=\"line\">    List&lt;ResultMap&gt; resultMaps = <span class=\"keyword\">this</span>.mappedStatement.getResultMaps();</span><br><span class=\"line\">    <span class=\"keyword\">int</span> resultMapCount = resultMaps.size();</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.validateResultMapsCount(rsw, resultMapCount);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">while</span>(rsw != <span class=\"keyword\">null</span> &amp;&amp; resultMapCount &gt; resultSetCount) &#123;</span><br><span class=\"line\">        ResultMap resultMap = (ResultMap)resultMaps.get(resultSetCount);</span><br><span class=\"line\">          <span class=\"comment\">// 根据ResultMap中定义的映射规则对ResultSet进行映射，将映射的结果对象添加到multipleResults中</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.handleResultSet(rsw, resultMap, multipleResults, (ResultMapping)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">          <span class=\"comment\">// 获取下一个结果集</span></span><br><span class=\"line\">        rsw = <span class=\"keyword\">this</span>.getNextResultSet(stmt);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.cleanUpAfterHandlingResultSet();</span><br><span class=\"line\">        ++resultSetCount;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 获取MappedStatement.resultSets属性，该属性仅对于多结果集的情况适用，该属性将列出语句执行后返回的结果集，并给每个结果集一个名称，名称使用逗号分隔</span></span><br><span class=\"line\">    String[] resultSets = <span class=\"keyword\">this</span>.mappedStatement.getResultSets();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (resultSets != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">while</span>(rsw != <span class=\"keyword\">null</span> &amp;&amp; resultSetCount &lt; resultSets.length) &#123;</span><br><span class=\"line\">            ResultMapping parentMapping = (ResultMapping)<span class=\"keyword\">this</span>.nextResultMaps.get(resultSets[resultSetCount]);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (parentMapping != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                String nestedResultMapId = parentMapping.getNestedResultMapId();</span><br><span class=\"line\">                ResultMap resultMap = <span class=\"keyword\">this</span>.configuration.getResultMap(nestedResultMapId);</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.handleResultSet(rsw, resultMap, (List)<span class=\"keyword\">null</span>, parentMapping);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            rsw = <span class=\"keyword\">this</span>.getNextResultSet(stmt);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.cleanUpAfterHandlingResultSet();</span><br><span class=\"line\">            ++resultSetCount;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.collapseSingleResultList(multipleResults);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"handleResultSet方法\"><a href=\"#handleResultSet方法\" class=\"headerlink\" title=\"handleResultSet方法\"></a>handleResultSet方法</h4><p>handleResultSet该方法用来完成单个ResultSet的映射</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">handleResultSet</span><span class=\"params\">(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Object&gt; multipleResults, ResultMapping parentMapping)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (parentMapping != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 处理多结果集中的嵌套映射</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.handleRowValues(rsw, resultMap, (ResultHandler)<span class=\"keyword\">null</span>, RowBounds.DEFAULT, parentMapping);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.resultHandler == <span class=\"keyword\">null</span>) &#123; <span class=\"comment\">// 没有指定ResultHandler,适用默认的</span></span><br><span class=\"line\">            DefaultResultHandler defaultResultHandler = <span class=\"keyword\">new</span> DefaultResultHandler(<span class=\"keyword\">this</span>.objectFactory);</span><br><span class=\"line\">              <span class=\"comment\">// 对ResultSet进行映射,将结果对象放到defaultResultHandler中暂存</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.handleRowValues(rsw, resultMap, defaultResultHandler, <span class=\"keyword\">this</span>.rowBounds, (ResultMapping)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">            multipleResults.add(defaultResultHandler.getResultList());</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 适用用户指定的resultHandler</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.handleRowValues(rsw, resultMap, <span class=\"keyword\">this</span>.resultHandler, <span class=\"keyword\">this</span>.rowBounds, (ResultMapping)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.closeResultSet(rsw.getResultSet());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">handleRowValues</span><span class=\"params\">(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler&lt;?&gt; resultHandler, RowBounds rowBounds, ResultMapping parentMapping)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">      <span class=\"comment\">// 存在嵌套结果集的情况</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (resultMap.hasNestedResultMaps()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.ensureNoRowBounds();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.checkResultHandler();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.handleRowValuesForNestedResultMap(rsw, resultMap, resultHandler, rowBounds, parentMapping);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">          <span class=\"comment\">//不存在嵌套结果集的情况 </span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.handleRowValuesForSimpleResultMap(rsw, resultMap, resultHandler, rowBounds, parentMapping);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<h5 id=\"handleRowValuesForSimpleResultMap处理简单映射\"><a href=\"#handleRowValuesForSimpleResultMap处理简单映射\" class=\"headerlink\" title=\"handleRowValuesForSimpleResultMap处理简单映射\"></a>handleRowValuesForSimpleResultMap处理简单映射</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">handleRowValuesForSimpleResultMap</span><span class=\"params\">(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler&lt;?&gt; resultHandler, RowBounds rowBounds, ResultMapping parentMapping)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    DefaultResultContext&lt;Object&gt; resultContext = <span class=\"keyword\">new</span> DefaultResultContext();</span><br><span class=\"line\">    ResultSet resultSet = rsw.getResultSet();</span><br><span class=\"line\">      <span class=\"comment\">// 根据rowBounds中的offset值定位到指定的记录行</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.skipRows(resultSet, rowBounds);</span><br><span class=\"line\">        <span class=\"comment\">// 检测是否还有需要映射的记录</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"keyword\">this</span>.shouldProcessMoreRows(resultContext, rowBounds) &amp;&amp; !resultSet.isClosed() &amp;&amp; resultSet.next()) &#123;            <span class=\"comment\">// 确定映射使用的ResultMap对象</span></span><br><span class=\"line\">        ResultMap discriminatedResultMap = <span class=\"keyword\">this</span>.resolveDiscriminatedResultMap(resultSet, resultMap, (String)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">          <span class=\"comment\">// 对ResultSet中的一行记录进行映射</span></span><br><span class=\"line\">        Object rowValue = <span class=\"keyword\">this</span>.getRowValue(rsw, discriminatedResultMap, (String)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.storeObject(resultHandler, resultContext, rowValue, parentMapping, resultSet);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"handleRowValuesForNestedResultMap处理嵌套映射\"><a href=\"#handleRowValuesForNestedResultMap处理嵌套映射\" class=\"headerlink\" title=\"handleRowValuesForNestedResultMap处理嵌套映射\"></a>handleRowValuesForNestedResultMap处理嵌套映射</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">handleRowValuesForNestedResultMap</span><span class=\"params\">(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler&lt;?&gt; resultHandler, RowBounds rowBounds, ResultMapping parentMapping)</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">    DefaultResultContext&lt;Object&gt; resultContext = <span class=\"keyword\">new</span> DefaultResultContext();</span><br><span class=\"line\">    ResultSet resultSet = rsw.getResultSet();</span><br><span class=\"line\">      <span class=\"comment\">// 根据offset定位指定的记录行</span></span><br><span class=\"line\">    <span class=\"keyword\">this</span>.skipRows(resultSet, rowBounds);</span><br><span class=\"line\">    Object rowValue = <span class=\"keyword\">this</span>.previousRowValue;</span><br><span class=\"line\">        <span class=\"comment\">// 检测是否能继续映射结果集中剩余的记录行</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span>(<span class=\"keyword\">this</span>.shouldProcessMoreRows(resultContext, rowBounds) &amp;&amp; !resultSet.isClosed() &amp;&amp; resultSet.next()) &#123;</span><br><span class=\"line\">        ResultMap discriminatedResultMap = <span class=\"keyword\">this</span>.resolveDiscriminatedResultMap(resultSet, resultMap, (String)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">        CacheKey rowKey = <span class=\"keyword\">this</span>.createRowKey(discriminatedResultMap, rsw, (String)<span class=\"keyword\">null</span>);</span><br><span class=\"line\">        Object partialObject = <span class=\"keyword\">this</span>.nestedResultObjects.get(rowKey);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.mappedStatement.isResultOrdered()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (partialObject == <span class=\"keyword\">null</span> &amp;&amp; rowValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.nestedResultObjects.clear();</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.storeObject(resultHandler, resultContext, rowValue, parentMapping, resultSet);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            rowValue = <span class=\"keyword\">this</span>.getRowValue(rsw, discriminatedResultMap, rowKey, (String)<span class=\"keyword\">null</span>, partialObject);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            rowValue = <span class=\"keyword\">this</span>.getRowValue(rsw, discriminatedResultMap, rowKey, (String)<span class=\"keyword\">null</span>, partialObject);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (partialObject == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.storeObject(resultHandler, resultContext, rowValue, parentMapping, resultSet);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (rowValue != <span class=\"keyword\">null</span> &amp;&amp; <span class=\"keyword\">this</span>.mappedStatement.isResultOrdered() &amp;&amp; <span class=\"keyword\">this</span>.shouldProcessMoreRows(resultContext, rowBounds)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.storeObject(resultHandler, resultContext, rowValue, parentMapping, resultSet);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.previousRowValue = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (rowValue != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.previousRowValue = rowValue;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"延迟加载\"><a href=\"#延迟加载\" class=\"headerlink\" title=\"延迟加载\"></a>延迟加载</h4><p>延迟加载表示：暂时不用的对象不会真正载入到内存中，知道真正需要使用该对象时，才会去执行数据库查询操作，将该对象加载到内存中。在Mybatis中，如果一个对象的某个属性需要延迟加载，那么在影射该属性时，会将该属性创建相应的代理对象并返回；当真正要使用延迟加载的属性时，会通过代理对象执行数据库加载操作，得到真正的数据。</p>\n<h5 id=\"延迟加载配置\"><a href=\"#延迟加载配置\" class=\"headerlink\" title=\"延迟加载配置\"></a>延迟加载配置</h5><ul>\n<li><p>属性在<resultMap>中的相应节点配置了fetchType属性，则按照fetchType属性决定是否延迟加载</resultMap></p>\n</li>\n<li><p>未配置fetchType属性，则需要根据mybatis-config.xml配置文件中的lazyLoadingEnabled配置是否延时加载</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- 打开延时操作的开关 --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">settings</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;lazyLoadingEnabled&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;true&quot;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- 将积极加载改为按需加载  false为按需加载--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">settings</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;aggressiveLazyLoading&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;false&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h5 id=\"延迟加载原理\"><a href=\"#延迟加载原理\" class=\"headerlink\" title=\"延迟加载原理\"></a>延迟加载原理</h5><p>延迟加载使用动态代理实现的，由于映射的结果对象都为普通的类，没有使用接口，所以无法使用JDK代理</p>\n<p>mybatis提供了两种为普通类动态生成代理对象的方式，为CGLIB方式和JAVASSIST方式</p>\n<h6 id=\"CGLIB\"><a href=\"#CGLIB\" class=\"headerlink\" title=\"CGLIB\"></a>CGLIB</h6><p>CGLIB采用字节码技术实现动态代理功能，原理是通过字节码技术为目标类生成子类，并在子类中采用方法拦截的方式拦截所有父类方法的调用，从而实现代理的功能。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CglibProxy</span> <span class=\"keyword\">implements</span> <span class=\"title\">MethodInterceptor</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> Enhancer enhancer = <span class=\"keyword\">new</span> Enhancer();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getProxy</span><span class=\"params\">(Class clazz)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 指定代理类的父类</span></span><br><span class=\"line\">        enhancer.setSuperclass(clazz);</span><br><span class=\"line\">        <span class=\"comment\">// 设置Callback对象</span></span><br><span class=\"line\">        enhancer.setCallback(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 通过字节码技术动态创建子类实例</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> enhancer.create();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">intercept</span><span class=\"params\">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;前置处理&quot;</span>);</span><br><span class=\"line\">        Object result = methodProxy.invokeSuper(o,objects);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;后置处理&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">print</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;方法执行&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        CglibProxy proxy = <span class=\"keyword\">new</span> CglibProxy();</span><br><span class=\"line\">        Test proxyImp = (Test) proxy.getProxy(Test.class);</span><br><span class=\"line\">        proxyImp.print();</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"Javassist\"><a href=\"#Javassist\" class=\"headerlink\" title=\"Javassist\"></a>Javassist</h6><p>Javassist是一个开源的生成java字节码的类库，其主要优点在于简单、快速，直接使用Javassist提供的API就可以动态的修改类的结构，或是动态的生成类。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Test</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> CannotCompileException, NotFoundException, IOException, IllegalAccessException, InstantiationException, NoSuchMethodException, InvocationTargetException </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建ClassPool</span></span><br><span class=\"line\">        ClassPool classPool = ClassPool.getDefault();</span><br><span class=\"line\">        <span class=\"comment\">// 生成类com.zhanghe.study.Gen</span></span><br><span class=\"line\">        CtClass ctClass = classPool.makeClass(<span class=\"string\">&quot;com.zhanghe.study.Gen&quot;</span>);</span><br><span class=\"line\">        StringBuffer body = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 创建字段，指定字段类型、名称、所属类</span></span><br><span class=\"line\">        CtField ctField = <span class=\"keyword\">new</span> CtField(classPool.get(<span class=\"string\">&quot;java.lang.String&quot;</span>),<span class=\"string\">&quot;prop&quot;</span>,ctClass);</span><br><span class=\"line\">        <span class=\"comment\">// 设置为私有属性</span></span><br><span class=\"line\">        ctField.setModifiers(Modifier.PRIVATE);</span><br><span class=\"line\">        <span class=\"comment\">// 添加属性</span></span><br><span class=\"line\">        ctClass.addField(ctField);</span><br><span class=\"line\">        <span class=\"comment\">//getter/setter方法</span></span><br><span class=\"line\">        ctClass.addMethod(CtNewMethod.getter(<span class=\"string\">&quot;getProp&quot;</span>,ctField));</span><br><span class=\"line\">        ctClass.addMethod(CtNewMethod.setter(<span class=\"string\">&quot;setProp&quot;</span>,ctField));</span><br><span class=\"line\">        <span class=\"comment\">// 创建execute方法  方法返回值、方法名称、方法入参。方法所属类</span></span><br><span class=\"line\">        CtMethod ctMethod = <span class=\"keyword\">new</span> CtMethod(CtClass.voidType,<span class=\"string\">&quot;execute&quot;</span>,<span class=\"keyword\">new</span> CtClass[]&#123;&#125;,ctClass);</span><br><span class=\"line\">        ctMethod.setModifiers(Modifier.PUBLIC);</span><br><span class=\"line\"></span><br><span class=\"line\">        body = <span class=\"keyword\">new</span> StringBuffer();</span><br><span class=\"line\">        body.append(<span class=\"string\">&quot;\\n System.out.println(\\&quot;execute()方法执行\\&quot;);&quot;</span>);</span><br><span class=\"line\">        body.append(<span class=\"string\">&quot;\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 设置方法体</span></span><br><span class=\"line\">        ctMethod.setBody(body.toString());</span><br><span class=\"line\">        ctClass.addMethod(ctMethod);</span><br><span class=\"line\">        <span class=\"comment\">// 将类保存到文件中</span></span><br><span class=\"line\">        ctClass.writeFile(<span class=\"string\">&quot;./target/classes&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Class clazz = ctClass.toClass();</span><br><span class=\"line\">        Object obj = clazz.newInstance();</span><br><span class=\"line\">        Method method = obj.getClass().getMethod(<span class=\"string\">&quot;setProp&quot;</span>,String.class);</span><br><span class=\"line\">        method.invoke(obj,<span class=\"string\">&quot;测试&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Method getMethod = obj.getClass().getMethod(<span class=\"string\">&quot;getProp&quot;</span>);</span><br><span class=\"line\">        System.out.println(getMethod.invoke(obj));</span><br><span class=\"line\"></span><br><span class=\"line\">        Method exeMethod = obj.getClass().getMethod(<span class=\"string\">&quot;execute&quot;</span>);</span><br><span class=\"line\">        exeMethod.invoke(obj);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JavassistMain</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">test</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;执行&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JavassistTest</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> ProxyFactory <span class=\"title\">createProxy</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        ProxyFactory factory = <span class=\"keyword\">new</span> ProxyFactory();</span><br><span class=\"line\">        factory.setSuperclass(JavassistMain.class);</span><br><span class=\"line\">        <span class=\"comment\">// 设置拦截器</span></span><br><span class=\"line\">        factory.setFilter(method -&gt; &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(<span class=\"string\">&quot;test&quot;</span>.equals(method.getName()))&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> factory;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> IllegalAccessException, InstantiationException </span>&#123;</span><br><span class=\"line\">        ProxyFactory factory = createProxy();</span><br><span class=\"line\">        Class clazz = factory.createClass();</span><br><span class=\"line\"></span><br><span class=\"line\">        Object obj = clazz.newInstance();</span><br><span class=\"line\">        ((ProxyObject)obj).setHandler(<span class=\"keyword\">new</span> MyMethodHandler());</span><br><span class=\"line\">        ((JavassistMain)obj).test();</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyMethodHandler</span> <span class=\"keyword\">implements</span> <span class=\"title\">MethodHandler</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">     * self  生成的代理类</span></span><br><span class=\"line\"><span class=\"comment\">     * method  原始的方法</span></span><br><span class=\"line\"><span class=\"comment\">     * process  生成代理类的代理方法</span></span><br><span class=\"line\"><span class=\"comment\">     * objects 方法入参</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object self, Method method, Method process, Object[] objects)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;前置处理&quot;</span>);</span><br><span class=\"line\">        Object obj = process.invoke(self,objects);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;后置处理&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> obj;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"ResultLoader\"><a href=\"#ResultLoader\" class=\"headerlink\" title=\"ResultLoader\"></a>ResultLoader</h5><p>ResultLoader负责保存一次延迟加载操作所需的全部信息</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ResultLoader</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> Configuration configuration;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> Executor executor;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> MappedStatement mappedStatement;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> Object parameterObject;</span><br><span class=\"line\">      <span class=\"comment\">// 延迟加载得到的对象类型</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> Class&lt;?&gt; targetType;</span><br><span class=\"line\">      <span class=\"comment\">// 通过反射创建延迟加载对象</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> ObjectFactory objectFactory;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> CacheKey cacheKey;</span><br><span class=\"line\">      <span class=\"comment\">// 记录延迟执行的SQL语句以及相关配置信息</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> BoundSql boundSql;</span><br><span class=\"line\">      <span class=\"comment\">// 负责将延迟加载得到的结果对象转换为targetType类型的对象</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> ResultExtractor resultExtractor;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> creatorThreadId;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">boolean</span> loaded;</span><br><span class=\"line\">      <span class=\"comment\">// 延迟加载得到的结果对象</span></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Object resultObject;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ResultLoader</span><span class=\"params\">(Configuration config, Executor executor, MappedStatement mappedStatement, Object parameterObject, Class&lt;?&gt; targetType, CacheKey cacheKey, BoundSql boundSql)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.configuration = config;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.executor = executor;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.mappedStatement = mappedStatement;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.parameterObject = parameterObject;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.targetType = targetType;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.objectFactory = <span class=\"keyword\">this</span>.configuration.getObjectFactory();</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.cacheKey = cacheKey;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.boundSql = boundSql;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.resultExtractor = <span class=\"keyword\">new</span> ResultExtractor(<span class=\"keyword\">this</span>.configuration, <span class=\"keyword\">this</span>.objectFactory);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.creatorThreadId = Thread.currentThread().getId();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">loadResult</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">          <span class=\"comment\">// 执行延迟加载，得到结果对象</span></span><br><span class=\"line\">        List&lt;Object&gt; list = <span class=\"keyword\">this</span>.selectList();</span><br><span class=\"line\">          <span class=\"comment\">// 将list集合转换为targetType指定类型的对象</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.resultObject = <span class=\"keyword\">this</span>.resultExtractor.extractObjectFromList(list, <span class=\"keyword\">this</span>.targetType);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.resultObject;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> &lt;E&gt; <span class=\"function\">List&lt;E&gt; <span class=\"title\">selectList</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> SQLException </span>&#123;</span><br><span class=\"line\">        Executor localExecutor = <span class=\"keyword\">this</span>.executor;</span><br><span class=\"line\">          <span class=\"comment\">// 检测调用该方法的线程是否为创建ResultLoader对象的线程、检测localExecutor是否关闭</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (Thread.currentThread().getId() != <span class=\"keyword\">this</span>.creatorThreadId || localExecutor.isClosed()) &#123;</span><br><span class=\"line\">            localExecutor = <span class=\"keyword\">this</span>.newExecutor();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        List var2;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 执行查询操作，得到延迟加载的对象。</span></span><br><span class=\"line\">            var2 = localExecutor.query(<span class=\"keyword\">this</span>.mappedStatement, <span class=\"keyword\">this</span>.parameterObject, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER, <span class=\"keyword\">this</span>.cacheKey, <span class=\"keyword\">this</span>.boundSql);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (localExecutor != <span class=\"keyword\">this</span>.executor) &#123;</span><br><span class=\"line\">                localExecutor.close(<span class=\"keyword\">false</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> var2;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Executor <span class=\"title\">newExecutor</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Environment environment = <span class=\"keyword\">this</span>.configuration.getEnvironment();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (environment == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;ResultLoader could not load lazily.  Environment was not configured.&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            DataSource ds = environment.getDataSource();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (ds == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;ResultLoader could not load lazily.  DataSource was not configured.&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                TransactionFactory transactionFactory = environment.getTransactionFactory();</span><br><span class=\"line\">                Transaction tx = transactionFactory.newTransaction(ds, (TransactionIsolationLevel)<span class=\"keyword\">null</span>, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.configuration.newExecutor(tx, ExecutorType.SIMPLE);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">boolean</span> <span class=\"title\">wasNull</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.resultObject == <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"ProxyFactory\"><a href=\"#ProxyFactory\" class=\"headerlink\" title=\"ProxyFactory\"></a>ProxyFactory</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">interface</span> <span class=\"title\">ProxyFactory</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">default</span> <span class=\"keyword\">void</span> <span class=\"title\">setProperties</span><span class=\"params\">(Properties properties)</span> </span>&#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 创建代理对象</span></span><br><span class=\"line\">    <span class=\"function\">Object <span class=\"title\">createProxy</span><span class=\"params\">(Object var1, ResultLoaderMap var2, Configuration var3, ObjectFactory var4, List&lt;Class&lt;?&gt;&gt; var5, List&lt;Object&gt; var6)</span></span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>有两个子类，CglibProxyFactory和JavassistProxyFactory</p>\n<h6 id=\"CglibProxyFactory\"><a href=\"#CglibProxyFactory\" class=\"headerlink\" title=\"CglibProxyFactory\"></a>CglibProxyFactory</h6><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">CglibProxyFactory</span> <span class=\"keyword\">implements</span> <span class=\"title\">ProxyFactory</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String FINALIZE_METHOD = <span class=\"string\">&quot;finalize&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String WRITE_REPLACE_METHOD = <span class=\"string\">&quot;writeReplace&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">CglibProxyFactory</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Resources.classForName(<span class=\"string\">&quot;net.sf.cglib.proxy.Enhancer&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Throwable var2) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">&quot;Cannot enable lazy loading because CGLIB is not available. Add CGLIB to your classpath.&quot;</span>, var2);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">createProxy</span><span class=\"params\">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> CglibProxyFactory.EnhancedResultObjectProxyImpl.createProxy(target, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">createDeserializationProxy</span><span class=\"params\">(Object target, Map&lt;String, LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> CglibProxyFactory.EnhancedDeserializationProxyImpl.createProxy(target, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">static</span> Object <span class=\"title\">crateProxy</span><span class=\"params\">(Class&lt;?&gt; type, Callback callback, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">        Enhancer enhancer = <span class=\"keyword\">new</span> Enhancer();</span><br><span class=\"line\">        enhancer.setCallback(callback);</span><br><span class=\"line\">        enhancer.setSuperclass(type);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            type.getDeclaredMethod(<span class=\"string\">&quot;writeReplace&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (CglibProxyFactory.LogHolder.log.isDebugEnabled()) &#123;</span><br><span class=\"line\">                CglibProxyFactory.LogHolder.log.debug(<span class=\"string\">&quot;writeReplace method was found on bean &quot;</span> + type + <span class=\"string\">&quot;, make sure it returns this&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException var8) &#123;</span><br><span class=\"line\">            enhancer.setInterfaces(<span class=\"keyword\">new</span> Class[]&#123;WriteReplaceInterface.class&#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SecurityException var9) &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Object enhanced;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (constructorArgTypes.isEmpty()) &#123;</span><br><span class=\"line\">            enhanced = enhancer.create();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            Class&lt;?&gt;[] typesArray = (Class[])constructorArgTypes.toArray(<span class=\"keyword\">new</span> Class[constructorArgTypes.size()]);</span><br><span class=\"line\">            Object[] valuesArray = constructorArgs.toArray(<span class=\"keyword\">new</span> Object[constructorArgs.size()]);</span><br><span class=\"line\">            enhanced = enhancer.create(typesArray, valuesArray);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> enhanced;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LogHolder</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Log log = LogFactory.getLog(CglibProxyFactory.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">LogHolder</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EnhancedDeserializationProxyImpl</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractEnhancedDeserializationProxy</span> <span class=\"keyword\">implements</span> <span class=\"title\">MethodInterceptor</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">EnhancedDeserializationProxyImpl</span><span class=\"params\">(Class&lt;?&gt; type, Map&lt;String, LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">super</span>(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Object <span class=\"title\">createProxy</span><span class=\"params\">(Object target, Map&lt;String, LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">            Class&lt;?&gt; type = target.getClass();</span><br><span class=\"line\">            CglibProxyFactory.EnhancedDeserializationProxyImpl callback = <span class=\"keyword\">new</span> CglibProxyFactory.EnhancedDeserializationProxyImpl(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">            Object enhanced = CglibProxyFactory.crateProxy(type, callback, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">            PropertyCopier.copyBeanProperties(type, target, enhanced);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> enhanced;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">intercept</span><span class=\"params\">(Object enhanced, Method method, Object[] args, MethodProxy methodProxy)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">            Object o = <span class=\"keyword\">super</span>.invoke(enhanced, method, args);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> o <span class=\"keyword\">instanceof</span> AbstractSerialStateHolder ? o : methodProxy.invokeSuper(o, args);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> AbstractSerialStateHolder <span class=\"title\">newSerialStateHolder</span><span class=\"params\">(Object userBean, Map&lt;String, LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CglibSerialStateHolder(userBean, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EnhancedResultObjectProxyImpl</span> <span class=\"keyword\">implements</span> <span class=\"title\">MethodInterceptor</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Class&lt;?&gt; type;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ResultLoaderMap lazyLoader;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> aggressive;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Set&lt;String&gt; lazyLoadTriggerMethods;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ObjectFactory objectFactory;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;Object&gt; constructorArgs;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">EnhancedResultObjectProxyImpl</span><span class=\"params\">(Class&lt;?&gt; type, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.type = type;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.lazyLoader = lazyLoader;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.aggressive = configuration.isAggressiveLazyLoading();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.lazyLoadTriggerMethods = configuration.getLazyLoadTriggerMethods();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.objectFactory = objectFactory;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.constructorArgTypes = constructorArgTypes;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.constructorArgs = constructorArgs;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Object <span class=\"title\">createProxy</span><span class=\"params\">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">            Class&lt;?&gt; type = target.getClass();</span><br><span class=\"line\">            CglibProxyFactory.EnhancedResultObjectProxyImpl callback = <span class=\"keyword\">new</span> CglibProxyFactory.EnhancedResultObjectProxyImpl(type, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">            Object enhanced = CglibProxyFactory.crateProxy(type, callback, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">            PropertyCopier.copyBeanProperties(type, target, enhanced);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> enhanced;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">intercept</span><span class=\"params\">(Object enhanced, Method method, Object[] args, MethodProxy methodProxy)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">            String methodName = method.getName();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">synchronized</span>(<span class=\"keyword\">this</span>.lazyLoader) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (<span class=\"string\">&quot;writeReplace&quot;</span>.equals(methodName)) &#123;</span><br><span class=\"line\">                        Object original;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.constructorArgTypes.isEmpty()) &#123;</span><br><span class=\"line\">                            original = <span class=\"keyword\">this</span>.objectFactory.create(<span class=\"keyword\">this</span>.type);</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            original = <span class=\"keyword\">this</span>.objectFactory.create(<span class=\"keyword\">this</span>.type, <span class=\"keyword\">this</span>.constructorArgTypes, <span class=\"keyword\">this</span>.constructorArgs);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        PropertyCopier.copyBeanProperties(<span class=\"keyword\">this</span>.type, enhanced, original);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lazyLoader.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> CglibSerialStateHolder(original, <span class=\"keyword\">this</span>.lazyLoader.getProperties(), <span class=\"keyword\">this</span>.objectFactory, <span class=\"keyword\">this</span>.constructorArgTypes, <span class=\"keyword\">this</span>.constructorArgs);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">return</span> original;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                                        <span class=\"comment\">// 是否有延迟加载属性</span></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lazyLoader.size() &gt; <span class=\"number\">0</span> &amp;&amp; !<span class=\"string\">&quot;finalize&quot;</span>.equals(methodName)) &#123;</span><br><span class=\"line\">                          <span class=\"comment\">// aggressiveLazyLoading配置为true，或者调用的方法在lazyLoadTriggerMethods中，将全部属性加载完</span></span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.aggressive &amp;&amp; !<span class=\"keyword\">this</span>.lazyLoadTriggerMethods.contains(methodName)) &#123;</span><br><span class=\"line\">                            String property;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (PropertyNamer.isSetter(methodName)) &#123;</span><br><span class=\"line\">                                property = PropertyNamer.methodToProperty(methodName);</span><br><span class=\"line\">                                <span class=\"keyword\">this</span>.lazyLoader.remove(property);</span><br><span class=\"line\">                            &#125; </span><br><span class=\"line\">                          <span class=\"comment\">// 调用了某属性的getter方法，现获取该属性的名称</span></span><br><span class=\"line\">                          <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (PropertyNamer.isGetter(methodName)) &#123;</span><br><span class=\"line\">                                property = PropertyNamer.methodToProperty(methodName);</span><br><span class=\"line\">                                    <span class=\"comment\">// 该属性是否为延迟加载属性</span></span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lazyLoader.hasLoader(property)) &#123;</span><br><span class=\"line\">                                      <span class=\"comment\">// 触发该属性的延迟加载操作</span></span><br><span class=\"line\">                                    <span class=\"keyword\">this</span>.lazyLoader.load(property);</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">this</span>.lazyLoader.loadAll();</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> methodProxy.invokeSuper(enhanced, args);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable var10) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> ExceptionUtil.unwrapThrowable(var10);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"JavassistProxyFactory\"><a href=\"#JavassistProxyFactory\" class=\"headerlink\" title=\"JavassistProxyFactory\"></a>JavassistProxyFactory</h6><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JavassistProxyFactory</span> <span class=\"keyword\">implements</span> <span class=\"title\">ProxyFactory</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String FINALIZE_METHOD = <span class=\"string\">&quot;finalize&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String WRITE_REPLACE_METHOD = <span class=\"string\">&quot;writeReplace&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">JavassistProxyFactory</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Resources.classForName(<span class=\"string\">&quot;org.apache.ibatis.javassist.util.proxy.ProxyFactory&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Throwable var2) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> IllegalStateException(<span class=\"string\">&quot;Cannot enable lazy loading because Javassist is not available. Add Javassist to your classpath.&quot;</span>, var2);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">createProxy</span><span class=\"params\">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JavassistProxyFactory.EnhancedResultObjectProxyImpl.createProxy(target, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">createDeserializationProxy</span><span class=\"params\">(Object target, Map&lt;String, LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JavassistProxyFactory.EnhancedDeserializationProxyImpl.createProxy(target, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">static</span> Object <span class=\"title\">crateProxy</span><span class=\"params\">(Class&lt;?&gt; type, MethodHandler callback, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">        org.apache.ibatis.javassist.util.proxy.ProxyFactory enhancer = <span class=\"keyword\">new</span> org.apache.ibatis.javassist.util.proxy.ProxyFactory();</span><br><span class=\"line\">        enhancer.setSuperclass(type);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            type.getDeclaredMethod(<span class=\"string\">&quot;writeReplace&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (JavassistProxyFactory.LogHolder.log.isDebugEnabled()) &#123;</span><br><span class=\"line\">                JavassistProxyFactory.LogHolder.log.debug(<span class=\"string\">&quot;writeReplace method was found on bean &quot;</span> + type + <span class=\"string\">&quot;, make sure it returns this&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException var10) &#123;</span><br><span class=\"line\">            enhancer.setInterfaces(<span class=\"keyword\">new</span> Class[]&#123;WriteReplaceInterface.class&#125;);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (SecurityException var11) &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        Class&lt;?&gt;[] typesArray = (Class[])constructorArgTypes.toArray(<span class=\"keyword\">new</span> Class[constructorArgTypes.size()]);</span><br><span class=\"line\">        Object[] valuesArray = constructorArgs.toArray(<span class=\"keyword\">new</span> Object[constructorArgs.size()]);</span><br><span class=\"line\"></span><br><span class=\"line\">        Object enhanced;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            enhanced = enhancer.create(typesArray, valuesArray);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception var9) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ExecutorException(<span class=\"string\">&quot;Error creating lazy proxy.  Cause: &quot;</span> + var9, var9);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        ((Proxy)enhanced).setHandler(callback);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> enhanced;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">LogHolder</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Log log = LogFactory.getLog(JavassistProxyFactory.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">LogHolder</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EnhancedDeserializationProxyImpl</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractEnhancedDeserializationProxy</span> <span class=\"keyword\">implements</span> <span class=\"title\">MethodHandler</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">EnhancedDeserializationProxyImpl</span><span class=\"params\">(Class&lt;?&gt; type, Map&lt;String, LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">super</span>(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Object <span class=\"title\">createProxy</span><span class=\"params\">(Object target, Map&lt;String, LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">            Class&lt;?&gt; type = target.getClass();</span><br><span class=\"line\">            JavassistProxyFactory.EnhancedDeserializationProxyImpl callback = <span class=\"keyword\">new</span> JavassistProxyFactory.EnhancedDeserializationProxyImpl(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">            Object enhanced = JavassistProxyFactory.crateProxy(type, callback, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">            PropertyCopier.copyBeanProperties(type, target, enhanced);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> enhanced;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object enhanced, Method method, Method methodProxy, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">            Object o = <span class=\"keyword\">super</span>.invoke(enhanced, method, args);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> o <span class=\"keyword\">instanceof</span> AbstractSerialStateHolder ? o : methodProxy.invoke(o, args);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">protected</span> AbstractSerialStateHolder <span class=\"title\">newSerialStateHolder</span><span class=\"params\">(Object userBean, Map&lt;String, LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> JavassistSerialStateHolder(userBean, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">EnhancedResultObjectProxyImpl</span> <span class=\"keyword\">implements</span> <span class=\"title\">MethodHandler</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Class&lt;?&gt; type;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ResultLoaderMap lazyLoader;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">boolean</span> aggressive;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Set&lt;String&gt; lazyLoadTriggerMethods;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ObjectFactory objectFactory;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> List&lt;Object&gt; constructorArgs;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"title\">EnhancedResultObjectProxyImpl</span><span class=\"params\">(Class&lt;?&gt; type, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.type = type;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.lazyLoader = lazyLoader;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.aggressive = configuration.isAggressiveLazyLoading();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.lazyLoadTriggerMethods = configuration.getLazyLoadTriggerMethods();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.objectFactory = objectFactory;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.constructorArgTypes = constructorArgTypes;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.constructorArgs = constructorArgs;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Object <span class=\"title\">createProxy</span><span class=\"params\">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> </span>&#123;</span><br><span class=\"line\">            Class&lt;?&gt; type = target.getClass();</span><br><span class=\"line\">            JavassistProxyFactory.EnhancedResultObjectProxyImpl callback = <span class=\"keyword\">new</span> JavassistProxyFactory.EnhancedResultObjectProxyImpl(type, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">            Object enhanced = JavassistProxyFactory.crateProxy(type, callback, constructorArgTypes, constructorArgs);</span><br><span class=\"line\">            PropertyCopier.copyBeanProperties(type, target, enhanced);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> enhanced;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">invoke</span><span class=\"params\">(Object enhanced, Method method, Method methodProxy, Object[] args)</span> <span class=\"keyword\">throws</span> Throwable </span>&#123;</span><br><span class=\"line\">            String methodName = method.getName();</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">synchronized</span>(<span class=\"keyword\">this</span>.lazyLoader) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (<span class=\"string\">&quot;writeReplace&quot;</span>.equals(methodName)) &#123;</span><br><span class=\"line\">                        Object original;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.constructorArgTypes.isEmpty()) &#123;</span><br><span class=\"line\">                            original = <span class=\"keyword\">this</span>.objectFactory.create(<span class=\"keyword\">this</span>.type);</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            original = <span class=\"keyword\">this</span>.objectFactory.create(<span class=\"keyword\">this</span>.type, <span class=\"keyword\">this</span>.constructorArgTypes, <span class=\"keyword\">this</span>.constructorArgs);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        PropertyCopier.copyBeanProperties(<span class=\"keyword\">this</span>.type, enhanced, original);</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lazyLoader.size() &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> JavassistSerialStateHolder(original, <span class=\"keyword\">this</span>.lazyLoader.getProperties(), <span class=\"keyword\">this</span>.objectFactory, <span class=\"keyword\">this</span>.constructorArgTypes, <span class=\"keyword\">this</span>.constructorArgs);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                        <span class=\"keyword\">return</span> original;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lazyLoader.size() &gt; <span class=\"number\">0</span> &amp;&amp; !<span class=\"string\">&quot;finalize&quot;</span>.equals(methodName)) &#123;</span><br><span class=\"line\">                        <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.aggressive &amp;&amp; !<span class=\"keyword\">this</span>.lazyLoadTriggerMethods.contains(methodName)) &#123;</span><br><span class=\"line\">                            String property;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span> (PropertyNamer.isSetter(methodName)) &#123;</span><br><span class=\"line\">                                property = PropertyNamer.methodToProperty(methodName);</span><br><span class=\"line\">                                <span class=\"keyword\">this</span>.lazyLoader.remove(property);</span><br><span class=\"line\">                            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (PropertyNamer.isGetter(methodName)) &#123;</span><br><span class=\"line\">                                property = PropertyNamer.methodToProperty(methodName);</span><br><span class=\"line\">                                <span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.lazyLoader.hasLoader(property)) &#123;</span><br><span class=\"line\">                                    <span class=\"keyword\">this</span>.lazyLoader.load(property);</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                            <span class=\"keyword\">this</span>.lazyLoader.loadAll();</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">return</span> methodProxy.invoke(enhanced, args);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Throwable var10) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> ExceptionUtil.unwrapThrowable(var10);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","categories":["mybatis"],"tags":["mybatis"]},{"title":"kafka生产者","url":"/2020/%E5%A4%A7%E6%95%B0%E6%8D%AE/kafka/kafka%E6%93%8D%E4%BD%9C/kafka%E7%94%9F%E4%BA%A7%E8%80%85/","content":"<h2 id=\"kafka生产者\"><a href=\"#kafka生产者\" class=\"headerlink\" title=\"kafka生产者\"></a>kafka生产者</h2><p>kafka使用脚本kafka-console-producer.sh命令发送消息</p>\n<a id=\"more\"></a>\n\n<h3 id=\"脚本\"><a href=\"#脚本\" class=\"headerlink\" title=\"脚本\"></a>脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">    export KAFKA_HEAP_OPTS=&quot;-Xmx512M&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh kafka.tools.ConsoleProducer &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<p>该脚本调用的是ConsoleProducer类</p>\n<h3 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h3><figure class=\"highlight scala\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">main</span></span>(args: <span class=\"type\">Array</span>[<span class=\"type\">String</span>]): <span class=\"type\">Unit</span> = &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">val</span> config = <span class=\"keyword\">new</span> <span class=\"type\">ProducerConfig</span>(args)</span><br><span class=\"line\">      <span class=\"keyword\">val</span> reader = <span class=\"type\">Class</span>.forName(config.readerClass).getDeclaredConstructor().newInstance().asInstanceOf[<span class=\"type\">MessageReader</span>]</span><br><span class=\"line\">      reader.init(<span class=\"type\">System</span>.in, getReaderProps(config))</span><br><span class=\"line\">            <span class=\"comment\">// kafkaProducer是一个用java语言实现的kafka客户端，实现了producer接口，用于将消息(ProducerRecord)发送至代理</span></span><br><span class=\"line\">      <span class=\"keyword\">val</span> producer = <span class=\"keyword\">new</span> <span class=\"type\">KafkaProducer</span>[<span class=\"type\">Array</span>[<span class=\"type\">Byte</span>], <span class=\"type\">Array</span>[<span class=\"type\">Byte</span>]](producerProps(config))</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"type\">Runtime</span>.getRuntime.addShutdownHook(<span class=\"keyword\">new</span> <span class=\"type\">Thread</span>() &#123;</span><br><span class=\"line\">        <span class=\"keyword\">override</span> <span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">run</span></span>() &#123;</span><br><span class=\"line\">          producer.close()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">var</span> record: <span class=\"type\">ProducerRecord</span>[<span class=\"type\">Array</span>[<span class=\"type\">Byte</span>], <span class=\"type\">Array</span>[<span class=\"type\">Byte</span>]] = <span class=\"literal\">null</span></span><br><span class=\"line\">      do &#123;</span><br><span class=\"line\">        record = reader.readMessage()</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (record != <span class=\"literal\">null</span>)</span><br><span class=\"line\">          send(producer, record, config.sync)</span><br><span class=\"line\">      &#125; <span class=\"keyword\">while</span> (record != <span class=\"literal\">null</span>)</span><br><span class=\"line\">  &#125; <span class=\"keyword\">catch</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> e: joptsimple.<span class=\"type\">OptionException</span> =&gt;</span><br><span class=\"line\">      <span class=\"type\">System</span>.err.println(e.getMessage)</span><br><span class=\"line\">      <span class=\"type\">Exit</span>.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"keyword\">case</span> e: <span class=\"type\">Exception</span> =&gt;</span><br><span class=\"line\">      e.printStackTrace</span><br><span class=\"line\">      <span class=\"type\">Exit</span>.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"type\">Exit</span>.exit(<span class=\"number\">0</span>)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置说明\"><a href=\"#配置说明\" class=\"headerlink\" title=\"配置说明\"></a>配置说明</h3><p>在server.properties中配置kafka的各个属性</p>\n<ul>\n<li><p>acks确认机制，用于配置代理接收到消息后向生产者发送确认信号，以便生产者根据acks进行相应的处理，该机制通过属性request.required.acks设置，0、-1、1三种，默认1</p>\n<ul>\n<li><p>acks=0时，生产者不需要等待代理返回确认消息，而连续发送消息。消息投递速度加快，但是无法保证消息是否已经被代理接收，可能丢失数据</p>\n</li>\n<li><p>acks=1时，生产者需要等待leader副本已成功将消息写入日志文件。降低了数据丢失的可能性，但还是存在，如果在leader成功存储数据后，follower没有来得及同步，此时leader挂掉了，此时数据虽然已经存储了，但是原来的leader已经从集群中下线了，同时存活的代理再也不会有原来的leader副本存储的数据，数据就会丢失</p>\n</li>\n<li><p>acks=-1时，leader副本和所有ISR列表中的副本都完成数据存储之后才会向生产者发送确认消息，这种策略保证只要leader副本和follower副本中至少有一个节点存货，数据就不会丢失</p>\n</li>\n</ul>\n</li>\n<li><p>batch.num.messages配置，kafka批量向代理发送消息，该配置表示每次批量发送消息的最大消息数，当生产者使用同步模式发送时该配置失效</p>\n</li>\n<li><p>message.send.max.retries  默认3  重试次数</p>\n</li>\n<li><p>retry.backoff.ms   默认值100   在生产者每次重试前，生产者会更新主题的MetaData信息，以此来检测新的Leader是否已经选举出来。因为Leader选举需要一定时间，所以此选项指定更新主题的MetaData之前生产者需要等待的时间，单位ms</p>\n</li>\n<li><p>queue.buffering.max.ms   默认1000  在异步模式下，表示消息被缓存的最长时间，单位ms，当到达该时间后消息将开始批量发送；若在异步模式下同时配置了缓存数据的最大值batch.num.messages，则达到这两个阈值之一都将开始批量发送消息</p>\n</li>\n<li><p>queue.buffering.max.messages  默认值10000  在异步模式下，在生产者必须被阻塞或者数据必须丢失之前，可以缓存到队列中的未发送的最大消息条数，即初始化消息队列的长度</p>\n</li>\n<li><p>batch.num.messages   默认值200   在异步模式每次批量发送消息的最大消息数</p>\n</li>\n<li><p>request.timeout.ms   默认值1500   在需要acks时，生产者等待代理应答超时时间，单位ms  若在该时间范围内还没有收到应答，则会发送错误到客户端</p>\n</li>\n<li><p>send.buffer.bytes  默认100k   Socket发送缓冲区大小</p>\n</li>\n<li><p>topic.metadata.refresh.interval.ms   默认5min  生产者定时请求更新主题元数据的时间间隔。若设置为0，则在每个消息发送至后都会去请求数据</p>\n</li>\n<li><p>client.id  默认为console-producer  生产者指定的一个标识字段，在每次请求中包含该字段，用于追踪调用，根据该字段在逻辑上可以确认是哪个应用发出的请求</p>\n</li>\n<li><p>queue.enqueue.timeout.ms  默认2147483647   该值为0表示当队列没满时直接入队，满了则立即丢弃，负数表示无条件阻塞且不丢弃，正数表示阻塞达到该值时长后抛出QueueFullException异常</p>\n</li>\n</ul>\n<h3 id=\"生产者命令\"><a href=\"#生产者命令\" class=\"headerlink\" title=\"生产者命令\"></a>生产者命令</h3><p>kafka-console-producer脚本提供了生产者发布消息调用kafka.tools.ConsoleProducer类</p>\n<h4 id=\"生产者发送消息\"><a href=\"#生产者发送消息\" class=\"headerlink\" title=\"生产者发送消息\"></a>生产者发送消息</h4><figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 无key消息</span><br><span class=\"line\">&gt;kafka-console-producer --broker-list localhost:<span class=\"number\">9092</span> --topic kafka-test</span><br><span class=\"line\"></span><br><span class=\"line\"># 有key消息 key和value之间用&quot;Tab键&quot;分隔</span><br><span class=\"line\">&gt;kafka-console-producer --broker-list localhost:<span class=\"number\">9092</span> --topic kafka-test --property parse.key=true</span><br></pre></td></tr></table></figure>\n\n<p>参数说明</p>\n<ul>\n<li><p><strong>broker-list</strong>    要连接的服务器(必传，kafka_2.12-2.50版本之前使用该参数)</p>\n</li>\n<li><p><strong>bootstrap-server</strong>   要连接的服务器(必传，kafka_2.12-2.50版本之后使用该参数)</p>\n</li>\n<li><p><strong>topic</strong>   接收消息的主题名称(必传)</p>\n</li>\n<li><p>batch-size  单个批处理中发送的消息数  200(默认值)</p>\n</li>\n<li><p>compression-codec  压缩编解码器   none、gzip(默认值) snappy、lz4、zstd</p>\n</li>\n<li><p>max-block-ms   在发送请求期间，生产者将阻止的最长时间  60000(默认值)</p>\n</li>\n<li><p>max-memory-ytes  生产者用来缓冲等待发送到服务器的总内存  33554432(默认值)</p>\n</li>\n<li><p>max-partition-memory-bytes  为分区分配的缓冲区大小  16384</p>\n</li>\n<li><p>message-send-max-retries  最大重试发送次数  3</p>\n</li>\n<li><p>metadata-expiry-ms    强制更新元数据的时间阈值(ms)  300000</p>\n</li>\n<li><p>producer-property   将自定义属性传递给生成器的机制   key=value   会覆盖配置文件中的配置</p>\n</li>\n<li><p>producer.config   生产者配置属性文件(producer-property优先于此配置)</p>\n</li>\n<li><p>property  自定义消息读取器     key.separator= 分隔符     ignore.error=true|false</p>\n</li>\n<li><p>request-required-acks   生产者请求的确认方式     0/1(默认)/all</p>\n</li>\n<li><p>request-timeout-ms   生产者请求的确认超时时间   1500(默认) </p>\n</li>\n<li><p>retry-backoff-ms   生产者重试前，刷新元数据的等待时间阈值  100(默认)</p>\n</li>\n<li><p>socket-buffer-size   TCP接收缓冲大小     102400(默认)</p>\n</li>\n<li><p>timeout   消息排队异步等待处理的时间阈值   1000(默认)</p>\n</li>\n<li><p>sync   同步发送消息</p>\n</li>\n<li><p>version    显示kafka版本   不需要配合其他参数，显示本地版本 </p>\n</li>\n</ul>\n<p>查看消息是否发送使用kafka-run-class脚本，该命令有一个time参数，支持-1(lastest)、-2(esrliest)，默认-1</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-run-class kafka.tools.GetOffsetShell --broker-list localhost:<span class=\"number\">9092</span> --topic kafka-test</span><br><span class=\"line\">//每个分区的偏移量</span><br><span class=\"line\">kafka-test:<span class=\"number\">0</span>:<span class=\"number\">1</span></span><br><span class=\"line\">kafka-test:<span class=\"number\">1</span>:<span class=\"number\">1</span></span><br><span class=\"line\">kafka-test:<span class=\"number\">2</span>:<span class=\"number\">1</span></span><br><span class=\"line\">kafka-test:<span class=\"number\">3</span>:<span class=\"number\">1</span></span><br><span class=\"line\">kafka-test:<span class=\"number\">4</span>:<span class=\"number\">2</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"查看信息\"><a href=\"#查看信息\" class=\"headerlink\" title=\"查看信息\"></a>查看信息</h4><p>kafka生产的消息以二进制的形式存在文件中，kafka提供了查看日志文件的kafka.tools.DumpLogSegments，files是必传参数，可传多个文件，逗号分隔</p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-run-class kafka.tools.DumpLogSegments --files ../../logs/kafka-test-<span class=\"number\">1</span>/<span class=\"number\">00000000000000000000</span>.log</span><br><span class=\"line\"></span><br><span class=\"line\">Dumping ..\\..\\logs\\kafka-test-<span class=\"number\">1</span>\\<span class=\"number\">00000000000000000000</span>.log</span><br><span class=\"line\">Starting offset: <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"function\">baseOffset: 0 <span class=\"title\">lastOffset</span>: 0 <span class=\"title\">count</span>: 1 <span class=\"title\">baseSequence</span>: -1 <span class=\"title\">lastSequence</span>: -1 <span class=\"title\">producerId</span>: -1 <span class=\"title\">producerEpoch</span>: -1 <span class=\"title\">partitionLeaderEpoch</span>: 0 <span class=\"title\">isTransactional</span>: <span class=\"title\">false</span> <span class=\"title\">isControl</span>: <span class=\"title\">false</span> <span class=\"title\">position</span>: 0 <span class=\"title\">CreateTime</span>: 1589276743099 <span class=\"title\">size</span>: 74 <span class=\"title\">magic</span>: 2 <span class=\"title\">compresscodec</span>: <span class=\"title\">NONE</span> <span class=\"title\">crc</span>: 2451158880 <span class=\"title\">isvalid</span>: <span class=\"title\">true</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">baseOffset</span>: 1 <span class=\"title\">lastOffset</span>: 1 <span class=\"title\">count</span>: 1 <span class=\"title\">baseSequence</span>: -1 <span class=\"title\">lastSequence</span>: -1 <span class=\"title\">producerId</span>: -1 <span class=\"title\">producerEpoch</span>: -1 <span class=\"title\">partitionLeaderEpoch</span>: 0 <span class=\"title\">isTransactional</span>: <span class=\"title\">false</span> <span class=\"title\">isControl</span>: <span class=\"title\">false</span> <span class=\"title\">position</span>: 74 <span class=\"title\">CreateTime</span>: 1589277087794 <span class=\"title\">size</span>: 72 <span class=\"title\">magic</span>: 2 <span class=\"title\">compresscodec</span>: <span class=\"title\">NONE</span> <span class=\"title\">crc</span>: 3428219219 <span class=\"title\">isvalid</span>: <span class=\"title\">true</span></span></span><br><span class=\"line\"><span class=\"function\"></span></span><br><span class=\"line\"><span class=\"function\">## 查看消息内容</span></span><br><span class=\"line\"><span class=\"function\">&gt;<span class=\"title\">kafka</span>-<span class=\"title\">run</span>-<span class=\"title\">class</span> <span class=\"title\">kafka.tools.DumpLogSegments</span> --<span class=\"title\">files</span> ../../<span class=\"title\">logs</span>/<span class=\"title\">kafka</span>-<span class=\"title\">test</span>-1/00000000000000000000.<span class=\"title\">log</span> --<span class=\"title\">print</span>-<span class=\"title\">data</span>-<span class=\"title\">log</span></span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"生产者性能工具\"><a href=\"#生产者性能工具\" class=\"headerlink\" title=\"生产者性能工具\"></a>生产者性能工具</h3><p>kafka提供了一个生产者性能测试脚本kafka-producer-perf-test，可以对生产者进行调优。</p>\n<h4 id=\"脚本-1\"><a href=\"#脚本-1\" class=\"headerlink\" title=\"脚本\"></a>脚本</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">    export KAFKA_HEAP_OPTS=&quot;-Xmx512M&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh org.apache.kafka.tools.ProducerPerformance &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"命令\"><a href=\"#命令\" class=\"headerlink\" title=\"命令\"></a>命令</h4><p>脚本调优调用的是org.apache.kafka.tools.ProducerPerformance类</p>\n<ul>\n<li><p>topic参数   指定生产者发送消息的目标主题</p>\n</li>\n<li><p>num-records  测试时发送消息的总条数</p>\n</li>\n<li><p>record-size  每条消息的字节数</p>\n</li>\n<li><p>throughput  限流控制(小于0时不进行限流；参数大于0，当已发送的消息总字节数与当前已执行的时间取整大于该字段时生产者线程会阻塞一段时间，生产者线程被阻塞时，在控制台可以看到输出一行吞吐量统计信息；参数等于0，生产者在发送一次消息之后检测满足阻塞条件时将会一直被阻塞)</p>\n</li>\n<li><p>producer-props  以键值对的形式指定配置，可同时指定多组配置，多组配置之间以空格隔开</p>\n</li>\n<li><p>producer.config  加载生产者级别的配置文件</p>\n</li>\n</ul>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;kafka-producer-perf-test --num-records <span class=\"number\">1000000</span> --record-size <span class=\"number\">1000</span> --topic kafka-test --throughput <span class=\"number\">1000000</span> --producer-props bootstrap.servers=localhost:<span class=\"number\">9092</span> acks=all</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">147041</span> records sent, <span class=\"number\">29396</span>.<span class=\"number\">4</span> records/sec (<span class=\"number\">28</span>.<span class=\"number\">03</span> MB/sec), <span class=\"number\">833</span>.<span class=\"number\">0</span> ms avg latency, <span class=\"number\">1111</span>.<span class=\"number\">0</span> ms max latency.</span><br><span class=\"line\"><span class=\"number\">262480</span> records sent, <span class=\"number\">52485</span>.<span class=\"number\">5</span> records/sec (<span class=\"number\">50</span>.<span class=\"number\">05</span> MB/sec), <span class=\"number\">651</span>.<span class=\"number\">0</span> ms avg latency, <span class=\"number\">1074</span>.<span class=\"number\">0</span> ms max latency.</span><br><span class=\"line\"><span class=\"number\">338240</span> records sent, <span class=\"number\">67648</span>.<span class=\"number\">0</span> records/sec (<span class=\"number\">64</span>.<span class=\"number\">51</span> MB/sec), <span class=\"number\">485</span>.<span class=\"number\">6</span> ms avg latency, <span class=\"number\">681</span>.<span class=\"number\">0</span> ms max latency.</span><br><span class=\"line\"><span class=\"number\">1000000</span> records sent, <span class=\"number\">54188</span>.<span class=\"number\">793757</span> records/sec (<span class=\"number\">51</span>.<span class=\"number\">68</span> MB/sec), <span class=\"number\">570</span>.<span class=\"number\">38</span> ms avg latency, <span class=\"number\">1111</span>.<span class=\"number\">00</span> ms max latency, <span class=\"number\">482</span> ms <span class=\"number\">50</span>th, <span class=\"number\">974</span> ms <span class=\"number\">95</span>th, <span class=\"number\">1039</span> ms <span class=\"number\">99</span>th, <span class=\"number\">1101</span> ms <span class=\"number\">99</span>.<span class=\"number\">9</span>th.</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>records sent  测试时发送的消息总数</p>\n</li>\n<li><p>records/sec  每秒发送的消息数来统计吞吐量</p>\n</li>\n<li><p>MB/sec  每秒发送的消息大小来统计吞吐量</p>\n</li>\n<li><p>avg latency  消息处理的平均耗时</p>\n</li>\n<li><p>max latency  消息处理最大耗时</p>\n</li>\n<li><p>50th/95th/99th/99.9th  百分比的消息处理耗时</p>\n</li>\n</ul>\n<h3 id=\"测试数据工具\"><a href=\"#测试数据工具\" class=\"headerlink\" title=\"测试数据工具\"></a>测试数据工具</h3><p>kafka提供了一个用于生成测试数据的脚本kafka-verifiable-producer.sh，用于向指定主题发送自增整型数字消息</p>\n<h4 id=\"脚本-2\"><a href=\"#脚本-2\" class=\"headerlink\" title=\"脚本\"></a>脚本</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class=\"line\">    export KAFKA_HEAP_OPTS=&quot;-Xmx512M&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\">exec $(dirname $0)/kafka-run-class.sh org.apache.kafka.tools.VerifiableProducer &quot;$@&quot;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"命令-1\"><a href=\"#命令-1\" class=\"headerlink\" title=\"命令\"></a>命令</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> max-message参数用于指定要发送的消息总数</span></span><br><span class=\"line\">kafka-verifiable-producer --broker-list localhost:9092 --topic test-verifiable --max-message 1000</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"kafkaProducer\"><a href=\"#kafkaProducer\" class=\"headerlink\" title=\"kafkaProducer\"></a>kafkaProducer</h3><p>kafkaProducer是一个用Java语言实现的kafka客户端，实现了Producer接口，用于将消息(ProducerRecord)发送到代理。kafkaProducer是线程安全的，在一个kafka集群中多线程之间共享同一个kafkaProducer实例比创建多个性能好。</p>\n<p>kafkaProducer有一个缓存池，用于存储尚未向代理发送的消息，同时一个后台IO线程负责从缓存池读取消息构造请求，将消息发送至代理</p>\n<h4 id=\"源码解析\"><a href=\"#源码解析\" class=\"headerlink\" title=\"源码解析\"></a>源码解析</h4><h5 id=\"实例化\"><a href=\"#实例化\" class=\"headerlink\" title=\"实例化\"></a>实例化</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//默认情况下的配置，为了防止篇幅过大，将后面的注释去掉了</span></span><br><span class=\"line\"><span class=\"comment\">// 该默认配置在ProducerConfig类中</span></span><br><span class=\"line\">CONFIG = (<span class=\"keyword\">new</span> ConfigDef()).</span><br><span class=\"line\">  define(<span class=\"string\">&quot;bootstrap.servers&quot;</span>, Type.LIST, Collections.emptyList(), <span class=\"keyword\">new</span> NonNullValidator(), Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  <span class=\"comment\">// RecordAccumulator中BufferPool的大小，默认32M</span></span><br><span class=\"line\">  .define(<span class=\"string\">&quot;buffer.memory&quot;</span>, Type.LONG, <span class=\"number\">33554432L</span>, Range.atLeast(<span class=\"number\">0L</span>), Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  <span class=\"comment\">// 发送失败的重试次数</span></span><br><span class=\"line\">  .define(<span class=\"string\">&quot;retries&quot;</span>, Type.INT, <span class=\"number\">0</span>, Range.between(<span class=\"number\">0</span>, <span class=\"number\">2147483647</span>), Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;acks&quot;</span>, Type.STRING, <span class=\"string\">&quot;1&quot;</span>, ValidString.in(<span class=\"keyword\">new</span> String[]&#123;<span class=\"string\">&quot;all&quot;</span>, <span class=\"string\">&quot;-1&quot;</span>, <span class=\"string\">&quot;0&quot;</span>, <span class=\"string\">&quot;1&quot;</span>&#125;), Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;compression.type&quot;</span>, Type.STRING, <span class=\"string\">&quot;none&quot;</span>, Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  <span class=\"comment\">//RecordBatch的大小，默认16K</span></span><br><span class=\"line\">  .define(<span class=\"string\">&quot;batch.size&quot;</span>, Type.INT, <span class=\"number\">16384</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  <span class=\"comment\">// 生产者默认会将两次发送时间间隔内收集到的所有发送消息的请求聚合然后进行发送，该间隔默认1000ms</span></span><br><span class=\"line\">  .define(<span class=\"string\">&quot;linger.ms&quot;</span>, Type.LONG, <span class=\"number\">0</span>, Range.atLeast(<span class=\"number\">0L</span>), Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;client.id&quot;</span>, Type.STRING, <span class=\"string\">&quot;&quot;</span>, Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;send.buffer.bytes&quot;</span>, Type.INT, <span class=\"number\">131072</span>, Range.atLeast(-<span class=\"number\">1</span>), Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;receive.buffer.bytes&quot;</span>, Type.INT, <span class=\"number\">32768</span>, Range.atLeast(-<span class=\"number\">1</span>), Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  <span class=\"comment\">// 生产者每次请求的最大字节数，默认1M</span></span><br><span class=\"line\">  .define(<span class=\"string\">&quot;max.request.size&quot;</span>, Type.INT, <span class=\"number\">1048576</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;reconnect.backoff.ms&quot;</span>, Type.LONG, <span class=\"number\">50L</span>, Range.atLeast(<span class=\"number\">0L</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;reconnect.backoff.max.ms&quot;</span>, Type.LONG, <span class=\"number\">1000L</span>, Range.atLeast(<span class=\"number\">0L</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;retry.backoff.ms&quot;</span>, Type.LONG, <span class=\"number\">100L</span>, Range.atLeast(<span class=\"number\">0L</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  <span class=\"comment\">// 消息发送或获取分区元数据信息时最大等待时间，默认60s</span></span><br><span class=\"line\">  .define(<span class=\"string\">&quot;max.block.ms&quot;</span>, Type.LONG, <span class=\"number\">60000</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;request.timeout.ms&quot;</span>, Type.INT, <span class=\"number\">30000</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  <span class=\"comment\">// 强制更新metadata的时间间隔，默认5min</span></span><br><span class=\"line\">  .define(<span class=\"string\">&quot;metadata.max.age.ms&quot;</span>, Type.LONG, <span class=\"number\">300000</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;metrics.sample.window.ms&quot;</span>, Type.LONG, <span class=\"number\">30000</span>, Range.atLeast(<span class=\"number\">0</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;metrics.num.samples&quot;</span>, Type.INT, <span class=\"number\">2</span>, Range.atLeast(<span class=\"number\">1</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;metrics.recording.level&quot;</span>, Type.STRING, RecordingLevel.INFO.toString(), ValidString.in(<span class=\"keyword\">new</span> String[]&#123;RecordingLevel.INFO.toString(), RecordingLevel.DEBUG.toString()&#125;), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;metric.reporters&quot;</span>, Type.LIST, Collections.emptyList(), <span class=\"keyword\">new</span> NonNullValidator(), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  <span class=\"comment\">// 设置每个连接的最大请求个数，默认5</span></span><br><span class=\"line\">  .define(<span class=\"string\">&quot;max.in.flight.requests.per.connection&quot;</span>, Type.INT, <span class=\"number\">5</span>, Range.atLeast(<span class=\"number\">1</span>), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;key.serializer&quot;</span>, Type.CLASS, Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;value.serializer&quot;</span>, Type.CLASS, Importance.HIGH, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;connections.max.idle.ms&quot;</span>, Type.LONG, <span class=\"number\">540000</span>, Importance.MEDIUM, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;partitioner.class&quot;</span>, Type.CLASS, DefaultPartitioner.class, Importance.MEDIUM, &quot;&quot;)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;interceptor.classes&quot;</span>, Type.LIST, Collections.emptyList(), <span class=\"keyword\">new</span> NonNullValidator(), Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;security.protocol&quot;</span>, Type.STRING, <span class=\"string\">&quot;PLAINTEXT&quot;</span>, Importance.MEDIUM, CommonClientConfigs.SECURITY_PROTOCOL_DOC).withClientSslSupport().withClientSaslSupport()</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;enable.idempotence&quot;</span>, Type.BOOLEAN, <span class=\"keyword\">false</span>, Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;transaction.timeout.ms&quot;</span>, Type.INT, <span class=\"number\">60000</span>, Importance.LOW, <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">  .define(<span class=\"string\">&quot;transactional.id&quot;</span>, Type.STRING, (Object)<span class=\"keyword\">null</span>, <span class=\"keyword\">new</span> NonEmptyString(), Importance.LOW, <span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\">KafkaProducer(ProducerConfig config, Serializer&lt;K&gt; keySerializer, Serializer&lt;V&gt; valueSerializer, Metadata metadata, KafkaClient kafkaClient) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            Map&lt;String, Object&gt; userProvidedConfigs = config.originals();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.producerConfig = config;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.time = Time.SYSTEM;</span><br><span class=\"line\">              <span class=\"comment\">//1、从配置项中解析出clientId，客户端指定该配置项的值来追踪程序运行情况</span></span><br><span class=\"line\">            String clientId = config.getString(<span class=\"string\">&quot;client.id&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (clientId.length() &lt;= <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 如果不存在clientId</span></span><br><span class=\"line\">                clientId = <span class=\"string\">&quot;producer-&quot;</span> + PRODUCER_CLIENT_ID_SEQUENCE.getAndIncrement();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.clientId = clientId;</span><br><span class=\"line\">            String transactionalId = userProvidedConfigs.containsKey(<span class=\"string\">&quot;transactional.id&quot;</span>) ? (String)userProvidedConfigs.get(<span class=\"string\">&quot;transactional.id&quot;</span>) : <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            LogContext logContext;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (transactionalId == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                logContext = <span class=\"keyword\">new</span> LogContext(String.format(<span class=\"string\">&quot;[Producer clientId=%s] &quot;</span>, clientId));</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                logContext = <span class=\"keyword\">new</span> LogContext(String.format(<span class=\"string\">&quot;[Producer clientId=%s, transactionalId=%s] &quot;</span>, clientId, transactionalId));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.log = logContext.logger(KafkaProducer.class);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.log.trace(<span class=\"string\">&quot;Starting the Kafka producer&quot;</span>);</span><br><span class=\"line\">              <span class=\"comment\">//2、创建和注册监控的相关对象</span></span><br><span class=\"line\">            Map&lt;String, String&gt; metricTags = Collections.singletonMap(<span class=\"string\">&quot;client-id&quot;</span>, clientId);</span><br><span class=\"line\">            MetricConfig metricConfig = (<span class=\"keyword\">new</span> MetricConfig()).samples(config.getInt(<span class=\"string\">&quot;metrics.num.samples&quot;</span>)).timeWindow(config.getLong(<span class=\"string\">&quot;metrics.sample.window.ms&quot;</span>), TimeUnit.MILLISECONDS).recordLevel(RecordingLevel.forName(config.getString(<span class=\"string\">&quot;metrics.recording.level&quot;</span>))).tags(metricTags);</span><br><span class=\"line\">            List&lt;MetricsReporter&gt; reporters = config.getConfiguredInstances(<span class=\"string\">&quot;metric.reporters&quot;</span>, MetricsReporter.class);</span><br><span class=\"line\">            reporters.add(<span class=\"keyword\">new</span> JmxReporter(<span class=\"string\">&quot;kafka.producer&quot;</span>));</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.metrics = <span class=\"keyword\">new</span> Metrics(metricConfig, reporters, <span class=\"keyword\">this</span>.time);</span><br><span class=\"line\">            ProducerMetrics metricsRegistry = <span class=\"keyword\">new</span> ProducerMetrics(<span class=\"keyword\">this</span>.metrics);</span><br><span class=\"line\">              <span class=\"comment\">// 实例化分区器。分区器是用于为消息指定分区，客户端可以通过实现Partitioner接口自定义消息分配分区的规则。若用户没有自定义分区器，使用默认的DefaultPartitioner，该分区器的分配规则为：若消息指定了key，则对key取hash值，然后与可用分区数取模；若没有指定key，则通过一个随机数与可用分区数取模</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.partitioner = (Partitioner)config.getConfiguredInstance(<span class=\"string\">&quot;partitioner.class&quot;</span>, Partitioner.class);</span><br><span class=\"line\">            <span class=\"keyword\">long</span> retryBackoffMs = config.getLong(<span class=\"string\">&quot;retry.backoff.ms&quot;</span>);</span><br><span class=\"line\">              <span class=\"comment\">// 实例化消息Key和Value进行序列化操作的Serializer</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (keySerializer == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.keySerializer = Wrapper.ensureExtended((Serializer)config.getConfiguredInstance(<span class=\"string\">&quot;key.serializer&quot;</span>, Serializer.class));</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.keySerializer.configure(config.originals(), <span class=\"keyword\">true</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                config.ignore(<span class=\"string\">&quot;key.serializer&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.keySerializer = Wrapper.ensureExtended(keySerializer);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (valueSerializer == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.valueSerializer = Wrapper.ensureExtended((Serializer)config.getConfiguredInstance(<span class=\"string\">&quot;value.serializer&quot;</span>, Serializer.class));</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.valueSerializer.configure(config.originals(), <span class=\"keyword\">false</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                config.ignore(<span class=\"string\">&quot;value.serializer&quot;</span>);</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.valueSerializer = Wrapper.ensureExtended(valueSerializer);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            userProvidedConfigs.put(<span class=\"string\">&quot;client.id&quot;</span>, clientId);</span><br><span class=\"line\">              <span class=\"comment\">// 根据配置实例化一组拦截器，可以指定多个拦截器</span></span><br><span class=\"line\">            List&lt;ProducerInterceptor&lt;K, V&gt;&gt; interceptorList = (<span class=\"keyword\">new</span> ProducerConfig(userProvidedConfigs, <span class=\"keyword\">false</span>)).getConfiguredInstances(<span class=\"string\">&quot;interceptor.classes&quot;</span>, ProducerInterceptor.class);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.interceptors = <span class=\"keyword\">new</span> ProducerInterceptors(interceptorList);</span><br><span class=\"line\">            ClusterResourceListeners clusterResourceListeners = <span class=\"keyword\">this</span>.configureClusterResourceListeners(keySerializer, valueSerializer, interceptorList, reporters);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.maxRequestSize = config.getInt(<span class=\"string\">&quot;max.request.size&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.totalMemorySize = config.getLong(<span class=\"string\">&quot;buffer.memory&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.compressionType = CompressionType.forName(config.getString(<span class=\"string\">&quot;compression.type&quot;</span>));</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.maxBlockTimeMs = config.getLong(<span class=\"string\">&quot;max.block.ms&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.requestTimeoutMs = config.getInt(<span class=\"string\">&quot;request.timeout.ms&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.transactionManager = configureTransactionState(config, logContext, <span class=\"keyword\">this</span>.log);</span><br><span class=\"line\">            <span class=\"keyword\">int</span> retries = configureRetries(config, <span class=\"keyword\">this</span>.transactionManager != <span class=\"keyword\">null</span>, <span class=\"keyword\">this</span>.log);</span><br><span class=\"line\">            <span class=\"keyword\">int</span> maxInflightRequests = configureInflightRequests(config, <span class=\"keyword\">this</span>.transactionManager != <span class=\"keyword\">null</span>);</span><br><span class=\"line\">            <span class=\"keyword\">short</span> acks = configureAcks(config, <span class=\"keyword\">this</span>.transactionManager != <span class=\"keyword\">null</span>, <span class=\"keyword\">this</span>.log);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.apiVersions = <span class=\"keyword\">new</span> ApiVersions();</span><br><span class=\"line\">              <span class=\"comment\">// 实例化用于存储消息的RecordAccumulator,消息累加器(类似于队列)，发送的消息都会先被追加到消息累加器的一个双端队列Deque中，在消息累加器内部每一个主题的每一个分区TopicPartition对应一个双端队列，队列的元素是ProducerBatch ，而RProducerBatch 是由同一个主题发往同一个分区的多条消息组成，并将结果TopicPartition作为key，该TopicPartition所对应的双端队列作为value保存到一个ConcurrentMap类型的batches中。目的是为了当消息发送失败需要重试时，将消息优先插入到队列的头部，而最新的消息总是插入到队列的尾部，只有需要重试发送时才在队列头部插入，发送消息是从头部获取ProducerBatch ，实现了对发送失败的消息进行重试发送。消息累加器中存在一个BufferPool缓存数据结构，用于存储消息。</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.accumulator = <span class=\"keyword\">new</span> RecordAccumulator(logContext, config.getInt(<span class=\"string\">&quot;batch.size&quot;</span>), <span class=\"keyword\">this</span>.totalMemorySize, <span class=\"keyword\">this</span>.compressionType, config.getLong(<span class=\"string\">&quot;linger.ms&quot;</span>), retryBackoffMs, <span class=\"keyword\">this</span>.metrics, <span class=\"keyword\">this</span>.time, <span class=\"keyword\">this</span>.apiVersions, <span class=\"keyword\">this</span>.transactionManager);</span><br><span class=\"line\">            List&lt;InetSocketAddress&gt; addresses = ClientUtils.parseAndValidateAddresses(config.getList(<span class=\"string\">&quot;bootstrap.servers&quot;</span>));</span><br><span class=\"line\">              <span class=\"comment\">// 实例化用于消息发送相关的元数据信息。metadata的主要数据结构由两部分组成，一类是用于控制MetaData进行更新操作的相关配置信息，另一类是集群信息Cluster。</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (metadata != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.metadata = metadata;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.metadata = <span class=\"keyword\">new</span> Metadata(retryBackoffMs, config.getLong(<span class=\"string\">&quot;metadata.max.age.ms&quot;</span>), <span class=\"keyword\">true</span>, <span class=\"keyword\">true</span>, clusterResourceListeners);</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.metadata.update(Cluster.bootstrap(addresses), Collections.emptySet(), <span class=\"keyword\">this</span>.time.milliseconds());</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">                        <span class=\"comment\">// 根据指定的安全协议$&#123;security.protocol&#125;创建ChannelBuilder</span></span><br><span class=\"line\">            ChannelBuilder channelBuilder = ClientUtils.createChannelBuilder(config);</span><br><span class=\"line\">            Sensor throttleTimeSensor = Sender.throttleTimeSensor(metricsRegistry.senderMetrics);</span><br><span class=\"line\">              <span class=\"comment\">//创建NetworkClient实例，底层是通过维持一个Socket连接来进行TCP通信的，用于生产者与各个代理进行Socket通信</span></span><br><span class=\"line\">            KafkaClient client = kafkaClient != <span class=\"keyword\">null</span> ? kafkaClient : <span class=\"keyword\">new</span> NetworkClient(<span class=\"keyword\">new</span> Selector(config.getLong(<span class=\"string\">&quot;connections.max.idle.ms&quot;</span>), <span class=\"keyword\">this</span>.metrics, <span class=\"keyword\">this</span>.time, <span class=\"string\">&quot;producer&quot;</span>, channelBuilder, logContext), <span class=\"keyword\">this</span>.metadata, clientId, maxInflightRequests, config.getLong(<span class=\"string\">&quot;reconnect.backoff.ms&quot;</span>), config.getLong(<span class=\"string\">&quot;reconnect.backoff.max.ms&quot;</span>), config.getInt(<span class=\"string\">&quot;send.buffer.bytes&quot;</span>), config.getInt(<span class=\"string\">&quot;receive.buffer.bytes&quot;</span>), <span class=\"keyword\">this</span>.requestTimeoutMs, <span class=\"keyword\">this</span>.time, <span class=\"keyword\">true</span>, <span class=\"keyword\">this</span>.apiVersions, throttleTimeSensor, logContext);</span><br><span class=\"line\">              <span class=\"comment\">// 用于数据发送的Sender</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.sender = <span class=\"keyword\">new</span> Sender(logContext, (KafkaClient)client, <span class=\"keyword\">this</span>.metadata, <span class=\"keyword\">this</span>.accumulator, maxInflightRequests == <span class=\"number\">1</span>, config.getInt(<span class=\"string\">&quot;max.request.size&quot;</span>), acks, retries, metricsRegistry.senderMetrics, Time.SYSTEM, <span class=\"keyword\">this</span>.requestTimeoutMs, config.getLong(<span class=\"string\">&quot;retry.backoff.ms&quot;</span>), <span class=\"keyword\">this</span>.transactionManager, <span class=\"keyword\">this</span>.apiVersions);</span><br><span class=\"line\">            String ioThreadName = <span class=\"string\">&quot;kafka-producer-network-thread | &quot;</span> + clientId;</span><br><span class=\"line\">              <span class=\"comment\">// 守护线程，在后台不断轮询，发送消息给代理</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.ioThread = <span class=\"keyword\">new</span> KafkaThread(ioThreadName, <span class=\"keyword\">this</span>.sender, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.ioThread.start();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.errors = <span class=\"keyword\">this</span>.metrics.sensor(<span class=\"string\">&quot;errors&quot;</span>);</span><br><span class=\"line\">            config.logUnused();</span><br><span class=\"line\">            AppInfoParser.registerAppInfo(<span class=\"string\">&quot;kafka.producer&quot;</span>, clientId, <span class=\"keyword\">this</span>.metrics);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.log.debug(<span class=\"string\">&quot;Kafka producer started&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Throwable var26) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.close(<span class=\"number\">0L</span>, TimeUnit.MILLISECONDS, <span class=\"keyword\">true</span>);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> KafkaException(<span class=\"string\">&quot;Failed to construct kafka producer&quot;</span>, var26);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"send方法分析\"><a href=\"#send方法分析\" class=\"headerlink\" title=\"send方法分析\"></a>send方法分析</h5><figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> Future&lt;RecordMetadata&gt; <span class=\"title\">send</span><span class=\"params\">(ProducerRecord&lt;K, V&gt; record, Callback callback)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// intercept the record, which can be potentially modified; this method does not throw exceptions</span></span><br><span class=\"line\">              <span class=\"comment\">// 如果配置了拦截器，会调用onSend方法</span></span><br><span class=\"line\">        ProducerRecord&lt;K, V&gt; interceptedRecord = <span class=\"keyword\">this</span>.interceptors.onSend(record);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> doSend(interceptedRecord, callback);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>doSend方法</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> Future&lt;RecordMetadata&gt; <span class=\"title\">doSend</span><span class=\"params\">(ProducerRecord&lt;K, V&gt; record, Callback callback)</span> </span>&#123;</span><br><span class=\"line\">        TopicPartition tp = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            throwIfProducerClosed();</span><br><span class=\"line\">            <span class=\"comment\">// first make sure the metadata for the topic is available</span></span><br><span class=\"line\">            ClusterAndWaitTime clusterAndWaitTime;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 获取metaData，只有获取到MetaData元数据信息才能真正进行消息的投递，该方法会一直被阻塞尝试去获取MetaData信息，超过maxBlockTimeMs依然没有获取到的话会抛异常</span></span><br><span class=\"line\">                clusterAndWaitTime = waitOnMetadata(record.topic(), record.partition(), maxBlockTimeMs);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (KafkaException e) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (metadata.isClosed())</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> KafkaException(<span class=\"string\">&quot;Producer closed while send in progress&quot;</span>, e);</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">long</span> remainingWaitMs = Math.max(<span class=\"number\">0</span>, maxBlockTimeMs - clusterAndWaitTime.waitedOnMetadataMs);</span><br><span class=\"line\">            Cluster cluster = clusterAndWaitTime.cluster;</span><br><span class=\"line\">            <span class=\"keyword\">byte</span>[] serializedKey;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                  <span class=\"comment\">//序列化</span></span><br><span class=\"line\">                serializedKey = keySerializer.serialize(record.topic(), record.headers(), record.key());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (ClassCastException cce) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> SerializationException(<span class=\"string\">&quot;Can&#x27;t convert key of class &quot;</span> + record.key().getClass().getName() +</span><br><span class=\"line\">                        <span class=\"string\">&quot; to class &quot;</span> + producerConfig.getClass(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG).getName() +</span><br><span class=\"line\">                        <span class=\"string\">&quot; specified in key.serializer&quot;</span>, cce);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">byte</span>[] serializedValue;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                serializedValue = valueSerializer.serialize(record.topic(), record.headers(), record.value());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (ClassCastException cce) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> SerializationException(<span class=\"string\">&quot;Can&#x27;t convert value of class &quot;</span> + record.value().getClass().getName() +</span><br><span class=\"line\">                        <span class=\"string\">&quot; to class &quot;</span> + producerConfig.getClass(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG).getName() +</span><br><span class=\"line\">                        <span class=\"string\">&quot; specified in value.serializer&quot;</span>, cce);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">              <span class=\"comment\">// 获取分区，如果客户端指定了分区则直接使用该分区，否则根据分区器分区策略计算</span></span><br><span class=\"line\">            <span class=\"keyword\">int</span> partition = partition(record, serializedKey, serializedValue, cluster);</span><br><span class=\"line\">              <span class=\"comment\">// 创建TopicPartition</span></span><br><span class=\"line\">            tp = <span class=\"keyword\">new</span> TopicPartition(record.topic(), partition);</span><br><span class=\"line\"></span><br><span class=\"line\">            setReadOnly(record.headers());</span><br><span class=\"line\">            Header[] headers = record.headers().toArray();</span><br><span class=\"line\">                        <span class=\"comment\">// 检测消息长度</span></span><br><span class=\"line\">            <span class=\"keyword\">int</span> serializedSize = AbstractRecords.estimateSizeInBytesUpperBound(apiVersions.maxUsableProduceMagic(),</span><br><span class=\"line\">                    compressionType, serializedKey, serializedValue, headers);</span><br><span class=\"line\">            ensureValidRecordSize(serializedSize);</span><br><span class=\"line\">            <span class=\"keyword\">long</span> timestamp = record.timestamp() == <span class=\"keyword\">null</span> ? time.milliseconds() : record.timestamp();</span><br><span class=\"line\">            log.trace(<span class=\"string\">&quot;Sending record &#123;&#125; with callback &#123;&#125; to topic &#123;&#125; partition &#123;&#125;&quot;</span>, record, callback, record.topic(), partition);</span><br><span class=\"line\">            <span class=\"comment\">// producer callback will make sure to call both &#x27;callback&#x27; and interceptor callback</span></span><br><span class=\"line\">              <span class=\"comment\">// 创建Callback对象</span></span><br><span class=\"line\">            Callback interceptCallback = <span class=\"keyword\">new</span> InterceptorCallback&lt;&gt;(callback, <span class=\"keyword\">this</span>.interceptors, tp);</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (transactionManager != <span class=\"keyword\">null</span> &amp;&amp; transactionManager.isTransactional())</span><br><span class=\"line\">                transactionManager.maybeAddPartitionToTransaction(tp);</span><br><span class=\"line\">                        <span class=\"comment\">// 写BufferPool，将消息写入到RecordAccumulator的BufferPool中</span></span><br><span class=\"line\">            RecordAccumulator.RecordAppendResult result = accumulator.append(tp, timestamp, serializedKey,</span><br><span class=\"line\">                    serializedValue, headers, interceptCallback, remainingWaitMs);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (result.batchIsFull || result.newBatchCreated) &#123;</span><br><span class=\"line\">                log.trace(<span class=\"string\">&quot;Waking up the sender since topic &#123;&#125; partition &#123;&#125; is either full or getting a new batch&quot;</span>, record.topic(), partition);</span><br><span class=\"line\">                  <span class=\"comment\">// 唤醒sender线程</span></span><br><span class=\"line\">                <span class=\"keyword\">this</span>.sender.wakeup();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> result.future;</span><br><span class=\"line\">            <span class=\"comment\">// handling exceptions and record the errors;</span></span><br><span class=\"line\">            <span class=\"comment\">// for API exceptions return them in the future,</span></span><br><span class=\"line\">            <span class=\"comment\">// for other exceptions throw directly</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (ApiException e) &#123;</span><br><span class=\"line\">            log.debug(<span class=\"string\">&quot;Exception occurred during message send:&quot;</span>, e);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (callback != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                callback.onCompletion(<span class=\"keyword\">null</span>, e);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.errors.record();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.interceptors.onSendError(record, tp, e);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> FutureFailure(e);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (InterruptedException e) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.errors.record();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.interceptors.onSendError(record, tp, e);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InterruptException(e);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (BufferExhaustedException e) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.errors.record();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.metrics.sensor(<span class=\"string\">&quot;buffer-exhausted-records&quot;</span>).record();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.interceptors.onSendError(record, tp, e);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (KafkaException e) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.errors.record();</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.interceptors.onSendError(record, tp, e);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// we notify interceptor about all exceptions, since onSend is called before anything else in this method</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.interceptors.onSendError(record, tp, e);</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>waitOnMetadata方法</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> ClusterAndWaitTime <span class=\"title\">waitOnMetadata</span><span class=\"params\">(String topic, Integer partition, <span class=\"keyword\">long</span> maxWaitMs)</span> <span class=\"keyword\">throws</span> InterruptedException </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// add topic to metadata topic list if it is not there already and reset expiry</span></span><br><span class=\"line\">        Cluster cluster = metadata.fetch();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (cluster.invalidTopics().contains(topic))</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidTopicException(topic);</span><br><span class=\"line\"></span><br><span class=\"line\">        metadata.add(topic);</span><br><span class=\"line\"></span><br><span class=\"line\">        Integer partitionsCount = cluster.partitionCountForTopic(topic);</span><br><span class=\"line\">        <span class=\"comment\">// Return cached metadata if we have it, and if the record&#x27;s partition is either undefined</span></span><br><span class=\"line\">        <span class=\"comment\">// or within the known partition range</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (partitionsCount != <span class=\"keyword\">null</span> &amp;&amp; (partition == <span class=\"keyword\">null</span> || partition &lt; partitionsCount))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ClusterAndWaitTime(cluster, <span class=\"number\">0</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">long</span> begin = time.milliseconds();</span><br><span class=\"line\">        <span class=\"keyword\">long</span> remainingWaitMs = maxWaitMs;</span><br><span class=\"line\">        <span class=\"keyword\">long</span> elapsed;</span><br><span class=\"line\">        <span class=\"comment\">// Issue metadata requests until we have metadata for the topic and the requested partition,</span></span><br><span class=\"line\">        <span class=\"comment\">// or until maxWaitTimeMs is exceeded. This is necessary in case the metadata</span></span><br><span class=\"line\">        <span class=\"comment\">// is stale and the number of partitions for this topic has increased in the meantime.</span></span><br><span class=\"line\">        <span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (partition != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                log.trace(<span class=\"string\">&quot;Requesting metadata update for partition &#123;&#125; of topic &#123;&#125;.&quot;</span>, partition, topic);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                log.trace(<span class=\"string\">&quot;Requesting metadata update for topic &#123;&#125;.&quot;</span>, topic);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            metadata.add(topic);</span><br><span class=\"line\">            <span class=\"keyword\">int</span> version = metadata.requestUpdate();</span><br><span class=\"line\">            sender.wakeup();</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                metadata.awaitUpdate(version, remainingWaitMs);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (TimeoutException ex) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Rethrow with original maxWaitMs to prevent logging exception with remainingWaitMs</span></span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> TimeoutException(</span><br><span class=\"line\">                        String.format(<span class=\"string\">&quot;Topic %s not present in metadata after %d ms.&quot;</span>,</span><br><span class=\"line\">                                topic, maxWaitMs));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            cluster = metadata.fetch();</span><br><span class=\"line\">            elapsed = time.milliseconds() - begin;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (elapsed &gt;= maxWaitMs) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> TimeoutException(partitionsCount == <span class=\"keyword\">null</span> ?</span><br><span class=\"line\">                        String.format(<span class=\"string\">&quot;Topic %s not present in metadata after %d ms.&quot;</span>,</span><br><span class=\"line\">                                topic, maxWaitMs) :</span><br><span class=\"line\">                        String.format(<span class=\"string\">&quot;Partition %d of topic %s with partition count %d is not present in metadata after %d ms.&quot;</span>,</span><br><span class=\"line\">                                partition, topic, partitionsCount, maxWaitMs));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cluster.unauthorizedTopics().contains(topic))</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> TopicAuthorizationException(topic);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (cluster.invalidTopics().contains(topic))</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> InvalidTopicException(topic);</span><br><span class=\"line\">            remainingWaitMs = maxWaitMs - elapsed;</span><br><span class=\"line\">            partitionsCount = cluster.partitionCountForTopic(topic);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">while</span> (partitionsCount == <span class=\"keyword\">null</span> || (partition != <span class=\"keyword\">null</span> &amp;&amp; partition &gt;= partitionsCount));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> ClusterAndWaitTime(cluster, elapsed);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>RecordAccumulator的append方法</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 变量        </span></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Logger log;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">volatile</span> <span class=\"keyword\">boolean</span> closed;</span><br><span class=\"line\"><span class=\"comment\">// 用于flush操作控制计数器</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AtomicInteger flushesInProgress;</span><br><span class=\"line\"><span class=\"comment\">// 用于append操作控制计数器  为了追踪正在进行追加操作的线程数，以便在生产者close方法时，sender线程调用RecordAccumulator的abortIncompleteBatches方法时，放弃未处理完的请求，释放资源</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AtomicInteger appendsInProgress;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">int</span> batchSize;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> CompressionType compression;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> lingerMs;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> retryBackoffMs;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> <span class=\"keyword\">long</span> deliveryTimeoutMs;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> BufferPool free;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Time time;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ApiVersions apiVersions;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> ConcurrentMap&lt;TopicPartition, Deque&lt;ProducerBatch&gt;&gt; batches;</span><br><span class=\"line\"><span class=\"comment\">// 用于保存已写入内存而未被Sender处理的ProducerBatch</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> IncompleteBatches incomplete;</span><br><span class=\"line\">  <span class=\"comment\">// The following variables are only accessed by the sender thread, so we don&#x27;t need to protect them.</span></span><br><span class=\"line\"><span class=\"comment\">// 用于保存消息已发送但还未收到ack的TopicPartition</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Map&lt;TopicPartition, Long&gt; muted;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> drainIndex;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> TransactionManager transactionManager;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> nextBatchExpiryTimeMs = Long.MAX_VALUE;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> RecordAppendResult <span class=\"title\">append</span><span class=\"params\">(TopicPartition tp,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                     <span class=\"keyword\">long</span> timestamp,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                     <span class=\"keyword\">byte</span>[] key,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                     <span class=\"keyword\">byte</span>[] value,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                     Header[] headers,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                     Callback callback,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                     <span class=\"keyword\">long</span> maxTimeToBlock)</span> <span class=\"keyword\">throws</span> InterruptedException </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// We keep track of the number of appending thread to make sure we do not miss batches in</span></span><br><span class=\"line\">        <span class=\"comment\">// abortIncompleteBatches().</span></span><br><span class=\"line\">              <span class=\"comment\">//append计数器+1</span></span><br><span class=\"line\">        appendsInProgress.incrementAndGet();</span><br><span class=\"line\">        ByteBuffer buffer = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (headers == <span class=\"keyword\">null</span>) headers = Record.EMPTY_HEADERS;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// check if we have an in-progress batch</span></span><br><span class=\"line\">              <span class=\"comment\">// 获取TopicPartition中的双端队列</span></span><br><span class=\"line\">            Deque&lt;ProducerBatch&gt; dq = getOrCreateDeque(tp);</span><br><span class=\"line\">              <span class=\"comment\">// 锁住dp，保证了只有一个TopicPartition可以进行append操作，保证同一分区数据是有序的</span></span><br><span class=\"line\">            <span class=\"keyword\">synchronized</span> (dq) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (closed)</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> KafkaException(<span class=\"string\">&quot;Producer closed while send in progress&quot;</span>);</span><br><span class=\"line\">                  <span class=\"comment\">// 尝试进行消息写入</span></span><br><span class=\"line\">                RecordAppendResult appendResult = tryAppend(timestamp, key, value, headers, callback, dq);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (appendResult != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> appendResult;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"comment\">// we don&#x27;t have an in-progress record batch try to allocate a new batch</span></span><br><span class=\"line\">            <span class=\"keyword\">byte</span> maxUsableMagic = apiVersions.maxUsableProduceMagic();</span><br><span class=\"line\">            <span class=\"keyword\">int</span> size = Math.max(<span class=\"keyword\">this</span>.batchSize, AbstractRecords.estimateSizeInBytesUpperBound(maxUsableMagic, compression, key, value, headers));</span><br><span class=\"line\">            log.trace(<span class=\"string\">&quot;Allocating a new &#123;&#125; byte message buffer for topic &#123;&#125; partition &#123;&#125;&quot;</span>, size, tp.topic(), tp.partition());</span><br><span class=\"line\">              <span class=\"comment\">// 向BufferPool申请内存</span></span><br><span class=\"line\">            buffer = free.allocate(size, maxTimeToBlock);</span><br><span class=\"line\">              <span class=\"comment\">// 检查一下是否有相同TopicPartition的其他线程创建了ProducerBatch或者部分消息已经被sender处理释放掉了</span></span><br><span class=\"line\">            <span class=\"keyword\">synchronized</span> (dq) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// Need to check if producer is closed again after grabbing the dequeue lock.</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (closed)</span><br><span class=\"line\">                    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> KafkaException(<span class=\"string\">&quot;Producer closed while send in progress&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                RecordAppendResult appendResult = tryAppend(timestamp, key, value, headers, callback, dq);</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (appendResult != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// Somebody else found us a batch, return the one we waited for! Hopefully this doesn&#x27;t happen often...</span></span><br><span class=\"line\">                    <span class=\"keyword\">return</span> appendResult;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                MemoryRecordsBuilder recordsBuilder = recordsBuilder(buffer, maxUsableMagic);</span><br><span class=\"line\">                ProducerBatch batch = <span class=\"keyword\">new</span> ProducerBatch(tp, recordsBuilder, time.milliseconds());</span><br><span class=\"line\">                FutureRecordMetadata future = Utils.notNull(batch.tryAppend(timestamp, key, value, headers, callback, time.milliseconds()));</span><br><span class=\"line\"></span><br><span class=\"line\">                dq.addLast(batch);</span><br><span class=\"line\">                incomplete.add(batch);</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// Don&#x27;t deallocate this buffer in the finally block as it&#x27;s being used in the record batch</span></span><br><span class=\"line\">                buffer = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> RecordAppendResult(future, dq.size() &gt; <span class=\"number\">1</span> || batch.isFull(), <span class=\"keyword\">true</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">finally</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (buffer != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                  <span class=\"comment\">// 释放内存</span></span><br><span class=\"line\">                free.deallocate(buffer);</span><br><span class=\"line\">              <span class=\"comment\">// append计数器减一</span></span><br><span class=\"line\">            appendsInProgress.decrementAndGet();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>tryAppend方法</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> RecordAppendResult <span class=\"title\">tryAppend</span><span class=\"params\">(<span class=\"keyword\">long</span> timestamp, <span class=\"keyword\">byte</span>[] key, <span class=\"keyword\">byte</span>[] value, Header[] headers,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                                         Callback callback, Deque&lt;ProducerBatch&gt; deque)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 先从队列中取出队尾ProducerBatch      </span></span><br><span class=\"line\">  ProducerBatch last = deque.peekLast();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (last != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            FutureRecordMetadata future = last.tryAppend(timestamp, key, value, headers, callback, time.milliseconds());</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (future == <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                last.closeForRecordAppends();</span><br><span class=\"line\">            <span class=\"keyword\">else</span></span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> RecordAppendResult(future, deque.size() &gt; <span class=\"number\">1</span> || last.isFull(), <span class=\"keyword\">false</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>ProducerBatch的tryAppend方法</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> FutureRecordMetadata <span class=\"title\">tryAppend</span><span class=\"params\">(<span class=\"keyword\">long</span> timestamp, <span class=\"keyword\">byte</span>[] key, <span class=\"keyword\">byte</span>[] value, Header[] headers, Callback callback, <span class=\"keyword\">long</span> now)</span> </span>&#123;</span><br><span class=\"line\">              <span class=\"comment\">// 是否有足够的空间</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!recordsBuilder.hasRoomFor(timestamp, key, value, headers)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">              <span class=\"comment\">// 写入ByteBuffer</span></span><br><span class=\"line\">            Long checksum = <span class=\"keyword\">this</span>.recordsBuilder.append(timestamp, key, value, headers);</span><br><span class=\"line\">              <span class=\"comment\">// 取当前的maxRecordSize与写入的消息总长度相比更新当前ProducerBatch的maxRecordSize</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.maxRecordSize = Math.max(<span class=\"keyword\">this</span>.maxRecordSize, AbstractRecords.estimateSizeInBytesUpperBound(magic(),</span><br><span class=\"line\">                    recordsBuilder.compressionType(), key, value, headers));</span><br><span class=\"line\">              <span class=\"comment\">// 更新lastAppendTime，记录最后追加时间</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.lastAppendTime = now;</span><br><span class=\"line\">              </span><br><span class=\"line\">            FutureRecordMetadata future = <span class=\"keyword\">new</span> FutureRecordMetadata(<span class=\"keyword\">this</span>.produceFuture, <span class=\"keyword\">this</span>.recordCount,</span><br><span class=\"line\">                                                                   timestamp, checksum,</span><br><span class=\"line\">                                                                   key == <span class=\"keyword\">null</span> ? -<span class=\"number\">1</span> : key.length,</span><br><span class=\"line\">                                                                   value == <span class=\"keyword\">null</span> ? -<span class=\"number\">1</span> : value.length,</span><br><span class=\"line\">                                                                   Time.SYSTEM);</span><br><span class=\"line\">            <span class=\"comment\">// we have to keep every future returned to the users in case the batch needs to be</span></span><br><span class=\"line\">            <span class=\"comment\">// split to several new batches and resent.</span></span><br><span class=\"line\">            thunks.add(<span class=\"keyword\">new</span> Thunk(callback, future));</span><br><span class=\"line\">              <span class=\"comment\">// ProducerBatch中的消息数+1</span></span><br><span class=\"line\">            <span class=\"keyword\">this</span>.recordCount++;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> future;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"sender线程\"><a href=\"#sender线程\" class=\"headerlink\" title=\"sender线程\"></a>sender线程</h5><p>sender是在KafkaProducer实例化的时候启动的，</p>\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;Starting Kafka producer I/O thread.&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// main loop, runs until close is called</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (running) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                run(time.milliseconds());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                log.error(<span class=\"string\">&quot;Uncaught error in kafka producer I/O thread: &quot;</span>, e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;Beginning shutdown of Kafka producer I/O thread, sending remaining records.&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// okay we stopped accepting requests but there may still be</span></span><br><span class=\"line\">        <span class=\"comment\">// requests in the accumulator or waiting for acknowledgment,</span></span><br><span class=\"line\">        <span class=\"comment\">// wait until these are completed.</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> (!forceClose &amp;&amp; (<span class=\"keyword\">this</span>.accumulator.hasUndrained() || <span class=\"keyword\">this</span>.client.inFlightRequestCount() &gt; <span class=\"number\">0</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                run(time.milliseconds());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">                log.error(<span class=\"string\">&quot;Uncaught error in kafka producer I/O thread: &quot;</span>, e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (forceClose) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// We need to fail all the incomplete batches and wake up the threads waiting on</span></span><br><span class=\"line\">            <span class=\"comment\">// the futures.</span></span><br><span class=\"line\">            log.debug(<span class=\"string\">&quot;Aborting incomplete batches due to forced shutdown&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.accumulator.abortIncompleteBatches();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.client.close();</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            log.error(<span class=\"string\">&quot;Failed to close network client&quot;</span>, e);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        log.debug(<span class=\"string\">&quot;Shutdown of Kafka producer I/O thread has completed.&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">(<span class=\"keyword\">long</span> now)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (transactionManager != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (transactionManager.shouldResetProducerStateAfterResolvingSequences())</span><br><span class=\"line\">                    <span class=\"comment\">// Check if the previous run expired batches which requires a reset of the producer state.</span></span><br><span class=\"line\">                    transactionManager.resetProducerId();</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (!transactionManager.isTransactional()) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// this is an idempotent producer, so make sure we have a producer id</span></span><br><span class=\"line\">                    maybeWaitForProducerId();</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (transactionManager.hasUnresolvedSequences() &amp;&amp; !transactionManager.hasFatalError()) &#123;</span><br><span class=\"line\">                    transactionManager.transitionToFatalError(</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> KafkaException(<span class=\"string\">&quot;The client hasn&#x27;t received acknowledgment for &quot;</span> +</span><br><span class=\"line\">                            <span class=\"string\">&quot;some previously sent messages and can no longer retry them. It isn&#x27;t safe to continue.&quot;</span>));</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (transactionManager.hasInFlightTransactionalRequest() || maybeSendTransactionalRequest(now)) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">// as long as there are outstanding transactional requests, we simply wait for them to return</span></span><br><span class=\"line\">                    client.poll(retryBackoffMs, now);</span><br><span class=\"line\">                    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"comment\">// do not continue sending if the transaction manager is in a failed state or if there</span></span><br><span class=\"line\">                <span class=\"comment\">// is no producer id (for the idempotent case).</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> (transactionManager.hasFatalError() || !transactionManager.hasProducerId()) &#123;</span><br><span class=\"line\">                    RuntimeException lastError = transactionManager.lastError();</span><br><span class=\"line\">                    <span class=\"keyword\">if</span> (lastError != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">                        maybeAbortBatches(lastError);</span><br><span class=\"line\">                    client.poll(retryBackoffMs, now);</span><br><span class=\"line\">                    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (transactionManager.hasAbortableError()) &#123;</span><br><span class=\"line\">                    accumulator.abortUndrainedBatches(transactionManager.lastError());</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (AuthenticationException e) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// This is already logged as error, but propagated here to perform any clean ups.</span></span><br><span class=\"line\">                log.trace(<span class=\"string\">&quot;Authentication exception while processing transactional request: &#123;&#125;&quot;</span>, e);</span><br><span class=\"line\">                transactionManager.authenticationFailed(e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">long</span> pollTimeout = sendProducerData(now);</span><br><span class=\"line\">              <span class=\"comment\">// 真正的发送方法</span></span><br><span class=\"line\">        client.poll(pollTimeout, now);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">long</span> <span class=\"title\">sendProducerData</span><span class=\"params\">(<span class=\"keyword\">long</span> now)</span> </span>&#123;</span><br><span class=\"line\">              <span class=\"comment\">// 获取Cluster信息</span></span><br><span class=\"line\">        Cluster cluster = metadata.fetch();</span><br><span class=\"line\">        <span class=\"comment\">// get the list of partitions with data ready to send</span></span><br><span class=\"line\">        RecordAccumulator.ReadyCheckResult result = <span class=\"keyword\">this</span>.accumulator.ready(cluster, now);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// if there are any partitions whose leaders are not known yet, force metadata update</span></span><br><span class=\"line\">              <span class=\"comment\">// 存在没有找到分区Leader的主题</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!result.unknownLeaderTopics.isEmpty()) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// The set of topics with unknown leader contains topics with leader election pending as well as</span></span><br><span class=\"line\">            <span class=\"comment\">// topics which may have expired. Add the topic again to metadata to ensure it is included</span></span><br><span class=\"line\">            <span class=\"comment\">// and request metadata update, since there are messages to send to the topic.</span></span><br><span class=\"line\">              <span class=\"comment\">// 将这些主题信息加入到metadata中，强制更新metadata信息</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (String topic : result.unknownLeaderTopics)</span><br><span class=\"line\">                <span class=\"keyword\">this</span>.metadata.add(topic);</span><br><span class=\"line\"></span><br><span class=\"line\">            log.debug(<span class=\"string\">&quot;Requesting metadata update due to unknown leader topics from the batched records: &#123;&#125;&quot;</span>,</span><br><span class=\"line\">                result.unknownLeaderTopics);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.metadata.requestUpdate();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// remove any nodes we aren&#x27;t ready to send to</span></span><br><span class=\"line\">              <span class=\"comment\">// 检测readyNodes中各节点的连接状态</span></span><br><span class=\"line\">        Iterator&lt;Node&gt; iter = result.readyNodes.iterator();</span><br><span class=\"line\">        <span class=\"keyword\">long</span> notReadyTimeout = Long.MAX_VALUE;</span><br><span class=\"line\">        <span class=\"keyword\">while</span> (iter.hasNext()) &#123;</span><br><span class=\"line\">            Node node = iter.next();</span><br><span class=\"line\">              <span class=\"comment\">// 检测状态，并根据一定条件决定是否为还未建立连接的节点创建连接</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.client.ready(node, now)) &#123;</span><br><span class=\"line\">                  <span class=\"comment\">// 如果与某个节点的连接还未就绪，则将该节点移除</span></span><br><span class=\"line\">                iter.remove();</span><br><span class=\"line\">                notReadyTimeout = Math.min(notReadyTimeout, <span class=\"keyword\">this</span>.client.pollDelayMs(node, now));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// create produce requests</span></span><br><span class=\"line\">              <span class=\"comment\">// 根据nodeId进行分组</span></span><br><span class=\"line\">        Map&lt;Integer, List&lt;ProducerBatch&gt;&gt; batches = <span class=\"keyword\">this</span>.accumulator.drain(cluster, result.readyNodes, <span class=\"keyword\">this</span>.maxRequestSize, now);</span><br><span class=\"line\">        addToInflightBatches(batches);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (guaranteeMessageOrder) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Mute all the partitions drained</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> (List&lt;ProducerBatch&gt; batchList : batches.values()) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (ProducerBatch batch : batchList)</span><br><span class=\"line\">                    <span class=\"keyword\">this</span>.accumulator.mutePartition(batch.topicPartition);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">              <span class=\"comment\">// 过滤掉超时的ProducerBatch</span></span><br><span class=\"line\">        accumulator.resetNextBatchExpiryTime();</span><br><span class=\"line\">        List&lt;ProducerBatch&gt; expiredInflightBatches = getExpiredInflightBatches(now);</span><br><span class=\"line\">        List&lt;ProducerBatch&gt; expiredBatches = <span class=\"keyword\">this</span>.accumulator.expiredBatches(now);</span><br><span class=\"line\">        expiredBatches.addAll(expiredInflightBatches);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// Reset the producer id if an expired batch has previously been sent to the broker. Also update the metrics</span></span><br><span class=\"line\">        <span class=\"comment\">// for expired batches. see the documentation of @TransactionState.resetProducerId to understand why</span></span><br><span class=\"line\">        <span class=\"comment\">// we need to reset the producer id here.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!expiredBatches.isEmpty())</span><br><span class=\"line\">            log.trace(<span class=\"string\">&quot;Expired &#123;&#125; batches in accumulator&quot;</span>, expiredBatches.size());</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (ProducerBatch expiredBatch : expiredBatches) &#123;</span><br><span class=\"line\">            String errorMessage = <span class=\"string\">&quot;Expiring &quot;</span> + expiredBatch.recordCount + <span class=\"string\">&quot; record(s) for &quot;</span> + expiredBatch.topicPartition</span><br><span class=\"line\">                + <span class=\"string\">&quot;:&quot;</span> + (now - expiredBatch.createdMs) + <span class=\"string\">&quot; ms has passed since batch creation&quot;</span>;</span><br><span class=\"line\">            failBatch(expiredBatch, -<span class=\"number\">1</span>, NO_TIMESTAMP, <span class=\"keyword\">new</span> TimeoutException(errorMessage), <span class=\"keyword\">false</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (transactionManager != <span class=\"keyword\">null</span> &amp;&amp; expiredBatch.inRetry()) &#123;</span><br><span class=\"line\">                <span class=\"comment\">// This ensures that no new batches are drained until the current in flight batches are fully resolved.</span></span><br><span class=\"line\">                transactionManager.markSequenceUnresolved(expiredBatch.topicPartition);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        sensors.updateProduceRequestMetrics(batches);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// If we have any nodes that are ready to send + have sendable data, poll with 0 timeout so this can immediately</span></span><br><span class=\"line\">        <span class=\"comment\">// loop and try sending more data. Otherwise, the timeout will be the smaller value between next batch expiry</span></span><br><span class=\"line\">        <span class=\"comment\">// time, and the delay time for checking data availability. Note that the nodes may have data that isn&#x27;t yet</span></span><br><span class=\"line\">        <span class=\"comment\">// sendable due to lingering, backing off, etc. This specifically does not include nodes with sendable data</span></span><br><span class=\"line\">        <span class=\"comment\">// that aren&#x27;t ready to send since they would cause busy looping.</span></span><br><span class=\"line\">        <span class=\"keyword\">long</span> pollTimeout = Math.min(result.nextReadyCheckDelayMs, notReadyTimeout);</span><br><span class=\"line\">        pollTimeout = Math.min(pollTimeout, <span class=\"keyword\">this</span>.accumulator.nextExpiryTimeMs() - now);</span><br><span class=\"line\">        pollTimeout = Math.max(pollTimeout, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!result.readyNodes.isEmpty()) &#123;</span><br><span class=\"line\">            log.trace(<span class=\"string\">&quot;Nodes with data ready to send: &#123;&#125;&quot;</span>, result.readyNodes);</span><br><span class=\"line\">            <span class=\"comment\">// if some partitions are already ready to be sent, the select time would be 0;</span></span><br><span class=\"line\">            <span class=\"comment\">// otherwise if some partition already has some data accumulated but not ready yet,</span></span><br><span class=\"line\">            <span class=\"comment\">// the select time will be the time difference between now and its linger expiry time;</span></span><br><span class=\"line\">            <span class=\"comment\">// otherwise the select time will be the time difference between now and the metadata expiry time;</span></span><br><span class=\"line\">            pollTimeout = <span class=\"number\">0</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">              <span class=\"comment\">// 将Node转换为ClientRequest对象</span></span><br><span class=\"line\">        sendProduceRequests(batches, now);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> pollTimeout;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight java\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">doSend</span><span class=\"params\">(ClientRequest clientRequest, <span class=\"keyword\">boolean</span> isInternalRequest, <span class=\"keyword\">long</span> now, AbstractRequest request)</span> </span>&#123;</span><br><span class=\"line\">        String destination = clientRequest.destination();</span><br><span class=\"line\">        RequestHeader header = clientRequest.makeHeader(request.version());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (log.isDebugEnabled()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">int</span> latestClientVersion = clientRequest.apiKey().latestVersion();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (header.apiVersion() == latestClientVersion) &#123;</span><br><span class=\"line\">                log.trace(<span class=\"string\">&quot;Sending &#123;&#125; &#123;&#125; with correlation id &#123;&#125; to node &#123;&#125;&quot;</span>, clientRequest.apiKey(), request,</span><br><span class=\"line\">                        clientRequest.correlationId(), destination);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                log.debug(<span class=\"string\">&quot;Using older server API v&#123;&#125; to send &#123;&#125; &#123;&#125; with correlation id &#123;&#125; to node &#123;&#125;&quot;</span>,</span><br><span class=\"line\">                        header.apiVersion(), clientRequest.apiKey(), request, clientRequest.correlationId(), destination);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        Send send = request.toSend(destination, header);</span><br><span class=\"line\">        InFlightRequest inFlightRequest = <span class=\"keyword\">new</span> InFlightRequest(</span><br><span class=\"line\">                clientRequest,</span><br><span class=\"line\">                header,</span><br><span class=\"line\">                isInternalRequest,</span><br><span class=\"line\">                request,</span><br><span class=\"line\">                send,</span><br><span class=\"line\">                now);</span><br><span class=\"line\">              </span><br><span class=\"line\">        <span class=\"keyword\">this</span>.inFlightRequests.add(inFlightRequest);</span><br><span class=\"line\">              <span class=\"comment\">// 暂存在selector内部的kafkaChannel，没有真正的发送</span></span><br><span class=\"line\">        selector.send(send);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n","categories":["kafka"],"tags":["kafka"]}]